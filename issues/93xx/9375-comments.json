[
   {
      "body" : "could we have some benchmarks do demonstrate the gains from this? though I don't doubt them, this is a fair amount of code...  and benchmarks would be important for regression testing this important behavior.",
      "created_at" : "2016-12-19T07:40:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267900573",
      "id" : 267900573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-19T07:40:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267900573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Which part, specifically, would you like to see benchmarks on?\n\nOn December 18, 2016 11:40:22 PM PST, Gregory Maxwell <notifications@github.com> wrote:\n>could we have some benchmarks do demonstrate the gains from this?\n>though I don't doubt them, this is a fair amount of code...  and\n>benchmarks would be important for regression testing this important\n>behavior.\n>\n>-- \n>You are receiving this because you authored the thread.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267900573\n",
      "created_at" : "2016-12-19T07:58:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267903170",
      "id" : 267903170,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-19T07:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267903170",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "latency to relay a block across many connections would be the obvious thing?",
      "created_at" : "2016-12-19T08:41:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267910206",
      "id" : 267910206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-19T08:41:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267910206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Is there ever a case where we would accept a block ourselves but we wouldn't want to immediately announce it?  I looked through all the places we call AcceptBlock/ProcessNewBlock and couldn't immediately see a problem, but want to make sure we think about it carefully.  I noticed this because I found it odd you had to change the preciousblock.py test.   BTW, a better change there may just be to allow duplicate-inconclusive in the list of results..\r\n\r\n",
      "created_at" : "2016-12-21T16:50:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268573271",
      "id" : 268573271,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-21T16:50:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268573271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93482270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93482270"
         }
      },
      "body" : "this chunk of code is duplicated elsewhere?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-21T17:26:27Z",
      "diff_hunk" : "@@ -1492,6 +1525,26 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactionsRequest req;\n         vRecv >> req;\n \n+        {\n+            LOCK(cs_most_recent_block);\n+            if (most_recent_block_hash == req.blockhash) {\n+                const CBlock& block = *most_recent_block;\n+                BlockTransactions resp(req);\n+                for (size_t i = 0; i < req.indexes.size(); i++) {\n+                    if (req.indexes[i] >= block.vtx.size()) {\n+                        Misbehaving(pfrom->GetId(), 100);\n+                        LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93482270",
      "id" : 93482270,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 152,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14011243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93482270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93500386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93500386"
         }
      },
      "body" : "maybe add ` LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d..`",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-21T19:10:57Z",
      "diff_hunk" : "@@ -752,6 +752,29 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());\n+\n+    connman->ForEachNode([this, &cmpctblock, pindex, &msgMaker, fWitnessEnabled](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION)\n+            return;\n+        ProcessBlockAvailability(pnode->GetId());\n+        CNodeState &state = *State(pnode->GetId());\n+        // If the peer has, or we announced to them the previous block already,\n+        // but we don't think they have this one, go ahead and announce it\n+        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\n+                !PeerHasHeader(&state, pindex) && PeerHasHeader(&state, pindex->pprev)) {\n+            connman->PushMessage(pnode, msgMaker.Make(NetMsgType::CMPCTBLOCK, cmpctblock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93500386",
      "id" : 93500386,
      "original_commit_id" : "1fcf0cc93bd5069da37820644f020b5a7599f9b6",
      "original_position" : 21,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14029655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93500386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93504865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93504865"
         }
      },
      "body" : "shouldn't this be pindex->pprev?  I don't suppose it matters much, but I think you'll be thinking segwit activated 1 block early",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-21T19:35:35Z",
      "diff_hunk" : "@@ -752,6 +752,39 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93504865",
      "id" : 93504865,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14034251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93504865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "This seems like its going to be super awesome.\r\ncode review ACK modulo nits, doing some testing...",
      "created_at" : "2016-12-21T19:54:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268622816",
      "id" : 268622816,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-21T19:54:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268622816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580220"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-22T08:07:21Z",
      "diff_hunk" : "@@ -752,6 +752,29 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());\n+\n+    connman->ForEachNode([this, &cmpctblock, pindex, &msgMaker, fWitnessEnabled](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION)\n+            return;\n+        ProcessBlockAvailability(pnode->GetId());\n+        CNodeState &state = *State(pnode->GetId());\n+        // If the peer has, or we announced to them the previous block already,\n+        // but we don't think they have this one, go ahead and announce it\n+        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\n+                !PeerHasHeader(&state, pindex) && PeerHasHeader(&state, pindex->pprev)) {\n+            connman->PushMessage(pnode, msgMaker.Make(NetMsgType::CMPCTBLOCK, cmpctblock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580220",
      "id" : 93580220,
      "original_commit_id" : "1fcf0cc93bd5069da37820644f020b5a7599f9b6",
      "original_position" : 21,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14110031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580228"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-22T08:07:25Z",
      "diff_hunk" : "@@ -752,6 +752,39 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580228",
      "id" : 93580228,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14110037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580239"
         }
      },
      "body" : "OK, DRY'd.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-22T08:07:31Z",
      "diff_hunk" : "@@ -1492,6 +1525,26 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactionsRequest req;\n         vRecv >> req;\n \n+        {\n+            LOCK(cs_most_recent_block);\n+            if (most_recent_block_hash == req.blockhash) {\n+                const CBlock& block = *most_recent_block;\n+                BlockTransactions resp(req);\n+                for (size_t i = 0; i < req.indexes.size(); i++) {\n+                    if (req.indexes[i] >= block.vtx.size()) {\n+                        Misbehaving(pfrom->GetId(), 100);\n+                        LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580239",
      "id" : 93580239,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 152,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14110044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Fixed comments, note that the SendBlockTransactions function seems a bit odd now, but the goal longer-term is to move messages into their own processing groups, where such functions will be really sane.",
      "created_at" : "2016-12-22T08:08:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268742659",
      "id" : 268742659,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-22T08:08:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268742659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Perhaps Newpowvalidblock should be gated on there actually being any peers that request a compact block from us?  Otherwise we'll go through the work of constructing a compact block there only to send it to no one. :)\r\n\r\nThoughts on caching the compact block like you cache the block?  You would want it for non-pref peers that request it after you announce the header... and it's reasonably small.",
      "created_at" : "2016-12-22T12:36:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268791150",
      "id" : 268791150,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-22T12:36:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268791150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "utACK 5bc61fa",
      "created_at" : "2016-12-22T15:25:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268822139",
      "id" : 268822139,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-22T15:25:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268822139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "@gmaxwell, well those requests are somewhat contradictory, so I picked the cache-compact-representation option :p.",
      "created_at" : "2016-12-22T23:31:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268913893",
      "id" : 268913893,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-22T23:31:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268913893",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt not so! as it could skip processing when there are no peers requesting, and update caches any time it processes!\r\n\r\nI don't think it matters except in one case:\r\n\r\nIsolated mining node with no HB requesting peers, constructing the short block earlier will delay block validation which delays updating the create new block.  I'm guessing the delay is <10ms, so probably inconsequential. But thought I'd bring it to your attention.",
      "created_at" : "2016-12-23T18:08:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269026347",
      "id" : 269026347,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-23T18:08:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269026347",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Yea, I'm not worried about the processing time for calling that once. Long term I'd like to run most of the CValidationInterface callbacks into background threads, but that's probably an 0.15-targeted thing.\n\nOn December 23, 2016 1:08:51 PM EST, Gregory Maxwell <notifications@github.com> wrote:\n>@TheBlueMatt not so! as it could skip processing when there are no\n>peers requesting, and update caches any time it processes!\n>\n>I don't think it matters except in one case:\n>\n>Isolated mining node with no HB requesting peers, constructing the\n>short block earlier will delay block validation which delays updating\n>the create new block.  I'm guessing the delay is <10ms, so probably\n>inconsequential. But thought I'd bring it to your attention.\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269026347\n",
      "created_at" : "2016-12-23T18:18:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269027470",
      "id" : 269027470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-23T18:18:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269027470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93805927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93805927"
         }
      },
      "body" : "I believe this needs a fDisconnect check.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-23T22:27:38Z",
      "diff_hunk" : "@@ -752,6 +752,29 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());\n+\n+    connman->ForEachNode([this, &cmpctblock, pindex, &msgMaker, fWitnessEnabled](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93805927",
      "id" : 93805927,
      "original_commit_id" : "1fcf0cc93bd5069da37820644f020b5a7599f9b6",
      "original_position" : 13,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14342842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93805927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93811196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93811196"
         }
      },
      "body" : "Fixed",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-24T02:05:31Z",
      "diff_hunk" : "@@ -752,6 +752,29 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());\n+\n+    connman->ForEachNode([this, &cmpctblock, pindex, &msgMaker, fWitnessEnabled](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93811196",
      "id" : 93811196,
      "original_commit_id" : "1fcf0cc93bd5069da37820644f020b5a7599f9b6",
      "original_position" : 13,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14347930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93811196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Squashed with no diff-tree.",
      "created_at" : "2016-12-24T16:18:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269090520",
      "id" : 269090520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-24T16:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269090520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93887479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93887479"
         }
      },
      "body" : "@morcos don't you mean one block late?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-27T00:06:01Z",
      "diff_hunk" : "@@ -752,6 +752,39 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93887479",
      "id" : 93887479,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14419640,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93887479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94175781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94175781"
         }
      },
      "body" : "Hmm, this is non-obvious to a caller. And it's especially bad that one of them relies on the const not actually being const :(\r\n\r\nMaybe return an updated index, or null in the case of failure? Or return a pair?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T20:15:24Z",
      "diff_hunk" : "@@ -3029,12 +3029,14 @@ static bool AcceptBlockHeader(const CBlockHeader& block, CValidationState& state\n }\n \n // Exposed wrapper for AcceptBlockHeader\n-bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, CBlockIndex** ppindex)\n+bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, const CBlockIndex** ppindex)\n {\n     {\n         LOCK(cs_main);\n         for (const CBlockHeader& header : headers) {\n-            if (!AcceptBlockHeader(header, state, chainparams, ppindex)) {\n+            // cast away the ppindex-returns-const CBlockIndex - we're just assigning it to a CBlockIndex*",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94175781",
      "id" : 94175781,
      "original_commit_id" : "c3084dd684e9ecc1e0171159cfe36f580d87ba25",
      "original_position" : 11,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 14706977,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94175781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94177486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94177486"
         }
      },
      "body" : "Maybe teach ReadBlockFromDisk to read to a shared_ptr reference to avoid the temptation?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T20:34:44Z",
      "diff_hunk" : "@@ -3799,16 +3802,19 @@ bool LoadExternalBlockFile(const CChainParams& chainparams, FILE* fileIn, CDiskB\n                     std::pair<std::multimap<uint256, CDiskBlockPos>::iterator, std::multimap<uint256, CDiskBlockPos>::iterator> range = mapBlocksUnknownParent.equal_range(head);\n                     while (range.first != range.second) {\n                         std::multimap<uint256, CDiskBlockPos>::iterator it = range.first;\n-                        if (ReadBlockFromDisk(block, it->second, chainparams.GetConsensus()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94177486",
      "id" : 94177486,
      "original_commit_id" : "1af5e30d2ca2c65fd217b1fbcbcc0b4dec4d4f39",
      "original_position" : 44,
      "path" : "src/validation.cpp",
      "position" : 89,
      "pull_request_review_id" : 14708654,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94177486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94177684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94177684"
         }
      },
      "body" : "Or just use a new precursiveblock here with limited scope",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T20:37:18Z",
      "diff_hunk" : "@@ -3799,16 +3802,19 @@ bool LoadExternalBlockFile(const CChainParams& chainparams, FILE* fileIn, CDiskB\n                     std::pair<std::multimap<uint256, CDiskBlockPos>::iterator, std::multimap<uint256, CDiskBlockPos>::iterator> range = mapBlocksUnknownParent.equal_range(head);\n                     while (range.first != range.second) {\n                         std::multimap<uint256, CDiskBlockPos>::iterator it = range.first;\n-                        if (ReadBlockFromDisk(block, it->second, chainparams.GetConsensus()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94177684",
      "id" : 94177684,
      "original_commit_id" : "1af5e30d2ca2c65fd217b1fbcbcc0b4dec4d4f39",
      "original_position" : 44,
      "path" : "src/validation.cpp",
      "position" : 89,
      "pull_request_review_id" : 14708846,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94177684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94178076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94178076"
         }
      },
      "body" : "Really? I dont see anything non-obvious here? The caller passes in a reference to a const CBlockIndex*, and the function sets that element to the new CBlockIndex*, ie it is returning a const CBlockIndex*, not editing a CBlockIndex which was passed in.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T20:41:37Z",
      "diff_hunk" : "@@ -3029,12 +3029,14 @@ static bool AcceptBlockHeader(const CBlockHeader& block, CValidationState& state\n }\n \n // Exposed wrapper for AcceptBlockHeader\n-bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, CBlockIndex** ppindex)\n+bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, const CBlockIndex** ppindex)\n {\n     {\n         LOCK(cs_main);\n         for (const CBlockHeader& header : headers) {\n-            if (!AcceptBlockHeader(header, state, chainparams, ppindex)) {\n+            // cast away the ppindex-returns-const CBlockIndex - we're just assigning it to a CBlockIndex*",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94178076",
      "id" : 94178076,
      "original_commit_id" : "c3084dd684e9ecc1e0171159cfe36f580d87ba25",
      "original_position" : 11,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 14709248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94178076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94179029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94179029"
         }
      },
      "body" : "How about generating a set of to-be-sent nodes here, with cs_main scope-locked. Then pass the set into ForEachNode and send only to the matches?\r\n\r\nThat saves cs_main (or whatever lock) from being held for the duration, and opens the door to deduped sending.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T20:53:25Z",
      "diff_hunk" : "@@ -752,6 +752,33 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94179029",
      "id" : 94179029,
      "original_commit_id" : "a14126ad3ba91afeb5c8fb4b0748588d0ee1b6fc",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14710167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94179029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94179883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94179883"
         }
      },
      "body" : "Make this a member of PeerLogicValidation, then you can use a weak_ptr for the global, and I think no locks are needed",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T21:04:09Z",
      "diff_hunk" : "@@ -760,6 +764,12 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n     uint256 hashBlock(pblock->GetHash());\n \n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94179883",
      "id" : 94179883,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14711047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94179883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94180406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94180406"
         }
      },
      "body" : "AFICT the only difference is that we can skip calling connman->PushMessage....is connman->PushMessage slow enough to care?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T21:11:05Z",
      "diff_hunk" : "@@ -752,6 +752,33 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94180406",
      "id" : 94180406,
      "original_commit_id" : "a14126ad3ba91afeb5c8fb4b0748588d0ee1b6fc",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14711559,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94180406",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94180477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94180477"
         }
      },
      "body" : "No need to stay locked for PushMessage",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T21:11:56Z",
      "diff_hunk" : "@@ -1082,6 +1092,23 @@ uint32_t GetFetchFlags(CNode* pfrom, const CBlockIndex* pprev, const Consensus::\n     return nFetchFlags;\n }\n \n+inline void static SendBlockTransactions(const CBlock& block, const BlockTransactionsRequest& req, CNode* pfrom, CConnman& connman) {\n+    BlockTransactions resp(req);\n+    for (size_t i = 0; i < req.indexes.size(); i++) {\n+        if (req.indexes[i] >= block.vtx.size()) {\n+            LOCK(cs_main);\n+            Misbehaving(pfrom->GetId(), 100);\n+            LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);\n+            return;\n+        }\n+        resp.txn[i] = block.vtx[req.indexes[i]];\n+    }\n+    LOCK(cs_main);\n+    CNetMsgMaker msgMaker(pfrom->GetSendVersion());\n+    int nSendFlags = State(pfrom->GetId())->fWantsCmpctWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94180477",
      "id" : 94180477,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 41,
      "path" : "src/net_processing.cpp",
      "position" : 182,
      "pull_request_review_id" : 14711623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94180477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181018"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181018"
         }
      },
      "body" : "You can avoid calling it for each node by iterating mapNodeState for the set up front.\r\n\r\nOne PushMessage is no concern, but avoiding it for the entire ForEachNode would be nice.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T21:18:12Z",
      "diff_hunk" : "@@ -752,6 +752,33 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181018",
      "id" : 94181018,
      "original_commit_id" : "a14126ad3ba91afeb5c8fb4b0748588d0ee1b6fc",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14712144,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181018",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181609"
         }
      },
      "body" : "Actually, nevermind. We can improve CConnman's interface for this kind of thing later.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T21:25:18Z",
      "diff_hunk" : "@@ -752,6 +752,33 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181609",
      "id" : 94181609,
      "original_commit_id" : "a14126ad3ba91afeb5c8fb4b0748588d0ee1b6fc",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14712700,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181763"
         }
      },
      "body" : "Yup, that was my (too heavily implied) point :).",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T21:27:14Z",
      "diff_hunk" : "@@ -752,6 +752,33 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181763",
      "id" : 94181763,
      "original_commit_id" : "a14126ad3ba91afeb5c8fb4b0748588d0ee1b6fc",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14712844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181763",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94184557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94184557"
         }
      },
      "body" : "I'm confused as to exactly what you're suggesting here. I don't particularly want a weak_ptr because I do want to hold the latest block for responses for a while after the block is connected/broadcast.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T21:57:41Z",
      "diff_hunk" : "@@ -760,6 +764,12 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n     uint256 hashBlock(pblock->GetHash());\n \n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94184557",
      "id" : 94184557,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14715534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94184557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94184711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94184711"
         }
      },
      "body" : "Is it slow enough to matter? After #9414 (and some std::atomic usage) we need to remove the cs_main lock completely here to make getblocktxn for the current head cs_main-free.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T21:59:42Z",
      "diff_hunk" : "@@ -1082,6 +1092,23 @@ uint32_t GetFetchFlags(CNode* pfrom, const CBlockIndex* pprev, const Consensus::\n     return nFetchFlags;\n }\n \n+inline void static SendBlockTransactions(const CBlock& block, const BlockTransactionsRequest& req, CNode* pfrom, CConnman& connman) {\n+    BlockTransactions resp(req);\n+    for (size_t i = 0; i < req.indexes.size(); i++) {\n+        if (req.indexes[i] >= block.vtx.size()) {\n+            LOCK(cs_main);\n+            Misbehaving(pfrom->GetId(), 100);\n+            LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);\n+            return;\n+        }\n+        resp.txn[i] = block.vtx[req.indexes[i]];\n+    }\n+    LOCK(cs_main);\n+    CNetMsgMaker msgMaker(pfrom->GetSendVersion());\n+    int nSendFlags = State(pfrom->GetId())->fWantsCmpctWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94184711",
      "id" : 94184711,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 41,
      "path" : "src/net_processing.cpp",
      "position" : 182,
      "pull_request_review_id" : 14715673,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94184711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94186100"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94186100"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-29T22:16:44Z",
      "diff_hunk" : "@@ -3799,16 +3802,19 @@ bool LoadExternalBlockFile(const CChainParams& chainparams, FILE* fileIn, CDiskB\n                     std::pair<std::multimap<uint256, CDiskBlockPos>::iterator, std::multimap<uint256, CDiskBlockPos>::iterator> range = mapBlocksUnknownParent.equal_range(head);\n                     while (range.first != range.second) {\n                         std::multimap<uint256, CDiskBlockPos>::iterator it = range.first;\n-                        if (ReadBlockFromDisk(block, it->second, chainparams.GetConsensus()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94186100",
      "id" : 94186100,
      "original_commit_id" : "1af5e30d2ca2c65fd217b1fbcbcc0b4dec4d4f39",
      "original_position" : 44,
      "path" : "src/validation.cpp",
      "position" : 89,
      "pull_request_review_id" : 14717032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94186100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Fixed one of @theuni's comments and rebased. Diff is https://0bin.net/paste/lZfeK4vg0ZdebkqX#AJKsFyZ3Ai1oiaRiUt-1S0tjFK9wrZ70aP74IepwbsY",
      "created_at" : "2016-12-29T22:18:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269702309",
      "id" : 269702309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-29T22:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269702309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94196147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94196147"
         }
      },
      "body" : "These are the types of changes that make me nervous about shared_ptrs, because it gets easy to start stashing things that have no obvious lifetime constraint.\r\n\r\nI was suggesting that you hold the shared_ptr in the PeerLogicValidation class. You then use a global weak_ptr which is overwritten by each new block. Then at any random time you can use std::shared_ptr\\<const CBlock\\> bestblock = shared_ptrglobal_last_block.lock().\r\n\r\nThat way you can extend the lifetime of the whatever block is current, but it's also obvious when it will be destroyed (with the PeerLogicValidation destruction).",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2016-12-30T01:17:25Z",
      "diff_hunk" : "@@ -760,6 +764,12 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n     uint256 hashBlock(pblock->GetHash());\n \n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94196147",
      "id" : 94196147,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14727146,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94196147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "One behavior that should be mentioned is that caching means that if I am connected to a since node via multiple channels, it will identify itself as the same node by using the same salt across them.  The salt sharing is something the protocol was carefully designed to enable, and there are _many_ other ways that a node identifies itself as equal on different links: so I don't consider it a concern. But since we do sometimes fix 'fingerprinting' it might surprise someone.\r\n\r\n(My view is that we fix fingerprinting that happens at different times-- that the host that was at 1.2.3.4 is now at 2.3.4.5--, but verifying that two peers you are currently connected to are really the same peer, is too hard to avoid.)\r\n",
      "created_at" : "2016-12-30T02:48:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269725290",
      "id" : 269725290,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-30T02:48:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269725290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "re-ACK 8022035\r\n\r\nhuge improvement to cache the cmpctblock, reduces time to relay cmpctblock to each additional peer from 30ms to 1ms.\r\n\r\n\r\n",
      "created_at" : "2016-12-30T17:40:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269799728",
      "id" : 269799728,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-30T17:40:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269799728",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "Mentioned on IRC, combining this with #9400 can lead to intermittent failures of `sendheaders.py`\r\n\r\n#9400 causes the node announcing the reorg in that test to be a HB peer, and block requests generated by FindNextBlocksToDownload in response to cmpctblocks relayed by NewPoWValidBlock are in a race condition against the tip being updated in the announcing peer.",
      "created_at" : "2016-12-31T00:29:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269838990",
      "id" : 269838990,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-31T00:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269838990",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "As @morcos points out, this needs a bit more thought - currently you might announce a compact block in HB mode, the receiving peer might then, for various reasons, request a response in the form of a full block instead of as a getblocktxn (eg #8800). At this point, you unlock cs_main prior to ActivateBestChain in ProcessNewBlock, allowing the other peer's block request the be processed, but you will not respond because you \"dont have the block\". A simple fix might be calling ActivateBestChain prior to block requests (since we cannot simply respond with the block without having validated it - this would be a protocol violation).",
      "created_at" : "2016-12-31T16:16:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269871618",
      "id" : 269871618,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-31T16:16:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269871618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Pushed a new commit which appears to fix @morcos' test failures in #9447. See the BIP clarifications at https://github.com/bitcoin/bips/pull/486 for associated info.",
      "created_at" : "2017-01-01T03:32:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269891019",
      "id" : 269891019,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-01T03:32:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269891019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94279801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94279801"
         }
      },
      "body" : "Hmm...does this make it that much more obvious? We still have a shared_ptr which is overwritten in NewPoWValidBlock and other sites which take references to it to extend its lifetime. I can add a comment noting that users MUST NOT extend the lifetime significantly, would that be sufficient to address your concern?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-01T03:37:36Z",
      "diff_hunk" : "@@ -760,6 +764,12 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n     uint256 hashBlock(pblock->GetHash());\n \n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94279801",
      "id" : 94279801,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14809836,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94279801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94282320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94282320"
         }
      },
      "body" : "`__func__` can be used here?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-01T10:27:27Z",
      "diff_hunk" : "@@ -752,6 +752,45 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static std::shared_ptr<CBlockHeaderAndShortTxIDs> most_recent_compact_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    std::shared_ptr<CBlockHeaderAndShortTxIDs> pcmpctblock = std::make_shared<CBlockHeaderAndShortTxIDs> (*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());\n+\n+    {\n+        LOCK(cs_most_recent_block);\n+        most_recent_block_hash = hashBlock;\n+        most_recent_block = pblock;\n+        most_recent_compact_block = pcmpctblock;\n+    }\n+\n+    connman->ForEachNode([this, &pcmpctblock, pindex, &msgMaker, fWitnessEnabled, &hashBlock](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION || pnode->fDisconnect)\n+            return;\n+        ProcessBlockAvailability(pnode->GetId());\n+        CNodeState &state = *State(pnode->GetId());\n+        // If the peer has, or we announced to them the previous block already,\n+        // but we don't think they have this one, go ahead and announce it\n+        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\n+                !PeerHasHeader(&state, pindex) && PeerHasHeader(&state, pindex->pprev)) {\n+\n+            LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d\\n\", \"PeerLogicValidation::NewPoWValidBlock\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94282320",
      "id" : 94282320,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 117,
      "path" : "src/net_processing.cpp",
      "position" : 123,
      "pull_request_review_id" : 14811940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94282320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94285460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94285460"
         }
      },
      "body" : "I'm not sure that it can due to the use of the inline function - do you care to test what `__FUNC__` means on different compilers in this case?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-01T15:35:17Z",
      "diff_hunk" : "@@ -752,6 +752,45 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static std::shared_ptr<CBlockHeaderAndShortTxIDs> most_recent_compact_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    std::shared_ptr<CBlockHeaderAndShortTxIDs> pcmpctblock = std::make_shared<CBlockHeaderAndShortTxIDs> (*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());\n+\n+    {\n+        LOCK(cs_most_recent_block);\n+        most_recent_block_hash = hashBlock;\n+        most_recent_block = pblock;\n+        most_recent_compact_block = pcmpctblock;\n+    }\n+\n+    connman->ForEachNode([this, &pcmpctblock, pindex, &msgMaker, fWitnessEnabled, &hashBlock](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION || pnode->fDisconnect)\n+            return;\n+        ProcessBlockAvailability(pnode->GetId());\n+        CNodeState &state = *State(pnode->GetId());\n+        // If the peer has, or we announced to them the previous block already,\n+        // but we don't think they have this one, go ahead and announce it\n+        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\n+                !PeerHasHeader(&state, pindex) && PeerHasHeader(&state, pindex->pprev)) {\n+\n+            LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d\\n\", \"PeerLogicValidation::NewPoWValidBlock\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94285460",
      "id" : 94285460,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 117,
      "path" : "src/net_processing.cpp",
      "position" : 123,
      "pull_request_review_id" : 14814660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94285460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94286900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94286900"
         }
      },
      "body" : "I tried that in my first patch to print this.  it printed \"operator ()\"\r\n",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-01T17:44:16Z",
      "diff_hunk" : "@@ -752,6 +752,45 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static std::shared_ptr<CBlockHeaderAndShortTxIDs> most_recent_compact_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    std::shared_ptr<CBlockHeaderAndShortTxIDs> pcmpctblock = std::make_shared<CBlockHeaderAndShortTxIDs> (*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());\n+\n+    {\n+        LOCK(cs_most_recent_block);\n+        most_recent_block_hash = hashBlock;\n+        most_recent_block = pblock;\n+        most_recent_compact_block = pcmpctblock;\n+    }\n+\n+    connman->ForEachNode([this, &pcmpctblock, pindex, &msgMaker, fWitnessEnabled, &hashBlock](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION || pnode->fDisconnect)\n+            return;\n+        ProcessBlockAvailability(pnode->GetId());\n+        CNodeState &state = *State(pnode->GetId());\n+        // If the peer has, or we announced to them the previous block already,\n+        // but we don't think they have this one, go ahead and announce it\n+        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\n+                !PeerHasHeader(&state, pindex) && PeerHasHeader(&state, pindex->pprev)) {\n+\n+            LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d\\n\", \"PeerLogicValidation::NewPoWValidBlock\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94286900",
      "id" : 94286900,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 117,
      "path" : "src/net_processing.cpp",
      "position" : 123,
      "pull_request_review_id" : 14815870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94286900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94287013"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94287013"
         }
      },
      "body" : "Just a note that we'll be calling this for every GETBLOCKS request.  But I suppose ActivateBestChain isn't too expensive in the common case.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-01T17:53:03Z",
      "diff_hunk" : "@@ -1507,6 +1517,18 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         LOCK(cs_main);\n \n+        // We might have announced the currently-being-connected tip using a\n+        // compact block, which resulted in the peer sending a getblocks\n+        // request, which we would otherwise respond to without the new block.\n+        // To avoid this situation we simply verify that we are on our best\n+        // known chain now. This is super overkill, but we handle it better\n+        // for getheaders requests, and there are no known nodes which support\n+        // compact blocks but still use getblocks to request blocks.\n+        {\n+            CValidationState dummy;\n+            ActivateBestChain(dummy, Params());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94287013",
      "id" : 94287013,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 30,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14815965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94287013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "I wish that we had a way to announce that we accept blocks that are not\nfully validated (as long as they satisfy PoW and size limits). Then compact\nblocks could be orthogonal to the choice of relay before/after validation.\n",
      "created_at" : "2017-01-01T17:59:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269912703",
      "id" : 269912703,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-01T17:59:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269912703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94290555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94290555"
         }
      },
      "body" : "Yea, its lightweight-enough that we cant really consider it a DoS issue (please review, but I'm pretty sure here), and its not like we care much about the performance of GETBLOCKS anymore...",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-01T23:54:57Z",
      "diff_hunk" : "@@ -1507,6 +1517,18 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         LOCK(cs_main);\n \n+        // We might have announced the currently-being-connected tip using a\n+        // compact block, which resulted in the peer sending a getblocks\n+        // request, which we would otherwise respond to without the new block.\n+        // To avoid this situation we simply verify that we are on our best\n+        // known chain now. This is super overkill, but we handle it better\n+        // for getheaders requests, and there are no known nodes which support\n+        // compact blocks but still use getblocks to request blocks.\n+        {\n+            CValidationState dummy;\n+            ActivateBestChain(dummy, Params());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94290555",
      "id" : 94290555,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 30,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14818907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94290555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "ACK 73817e2\r\n\r\nEDIT (ACK contingent on @sdaftuar's 3 proposed changes)",
      "created_at" : "2017-01-02T03:30:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269931960",
      "id" : 269931960,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-03T21:49:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269931960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "utACK https://github.com/bitcoin/bitcoin/commit/73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2017-01-03T16:45:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-270160258",
      "id" : 270160258,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-03T16:45:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270160258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94446613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94446613"
         }
      },
      "body" : "To avoid the const cast, you could do something like:\r\n\r\n```\r\n            CBlockIndex* pindex = nullptr;\r\n            if (!AcceptBlockHeader(header, state, chainparams, &pindex)) {\r\n                return false;\r\n            }\r\n            *ppindex = pindex;\r\n```",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-03T17:31:47Z",
      "diff_hunk" : "@@ -3029,12 +3029,14 @@ static bool AcceptBlockHeader(const CBlockHeader& block, CValidationState& state\n }\n \n // Exposed wrapper for AcceptBlockHeader\n-bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, CBlockIndex** ppindex)\n+bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, const CBlockIndex** ppindex)\n {\n     {\n         LOCK(cs_main);\n         for (const CBlockHeader& header : headers) {\n-            if (!AcceptBlockHeader(header, state, chainparams, ppindex)) {\n+            // cast away the ppindex-returns-const CBlockIndex - we're just assigning it to a CBlockIndex*",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94446613",
      "id" : 94446613,
      "original_commit_id" : "c3084dd684e9ecc1e0171159cfe36f580d87ba25",
      "original_position" : 11,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 14974170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94446613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94454479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94454479"
         }
      },
      "body" : "The cached compact block was built using wtxid's rather than txid's, so we have to check to see if the peer wants compact witness ids before we can use the cached version, no?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-03T18:21:06Z",
      "diff_hunk" : "@@ -2785,13 +2787,19 @@ bool SendMessages(CNode* pto, CConnman& connman)\n                     // probably means we're doing an initial-ish-sync or they're slow\n                     LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d\\n\", __func__,\n                             vHeaders.front().GetHash().ToString(), pto->id);\n-                    //TODO: Shouldn't need to reload block from disk, but requires refactor\n-                    CBlock block;\n-                    bool ret = ReadBlockFromDisk(block, pBestIndex, consensusParams);\n-                    assert(ret);\n-                    CBlockHeaderAndShortTxIDs cmpctblock(block, state.fWantsCmpctWitness);\n+\n                     int nSendFlags = state.fWantsCmpctWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;\n-                    connman.PushMessage(pto, msgMaker.Make(nSendFlags, NetMsgType::CMPCTBLOCK, cmpctblock));\n+\n+                    LOCK(cs_most_recent_block);\n+                    if (most_recent_block_hash == pBestIndex->GetBlockHash()) {\n+                        connman.PushMessage(pto, msgMaker.Make(nSendFlags, NetMsgType::CMPCTBLOCK, *most_recent_compact_block));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94454479",
      "id" : 94454479,
      "original_commit_id" : "802203579d764bf24fbd3b0a5addc916ba4195e3",
      "original_position" : 49,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14982194,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94454479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "> Is there ever a case where we would accept a block ourselves but we wouldn't want to immediately announce it?\r\n\r\n@morcos @TheBlueMatt One area worth some thought is how to handle block relay while processing a reorg.  Before this PR, we wouldn't relay any block with less work than our tip unless we had completed a reorg to a new tip.  After this PR, I believe we would relay blocks with work less than or equal to our tip (as compact blocks, even) before we know that the reorg would succeed.\r\n\r\nAnd in fact, upon receipt of a compact block with <= work than our tip, we don't bother trying to process.  So I'm not sure there's any benefit to relaying before validation for blocks that aren't just building on our tip?",
      "created_at" : "2017-01-03T18:54:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-270192336",
      "id" : 270192336,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-03T18:54:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270192336",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Actually I think there are some problems with relaying blocks that have work equal to our tip.  Conceptually, we shouldn't be helping our peers end up on a tip that is competing with ours, so even though we download blocks at the same work as our tip, I think it's important that we not relay such blocks.\r\n\r\nMore practically, in the CMPCTBLOCK handling code, we call `UpdateBlockAvailability()` after processing the header, which will overwrite the value of `pindexBestKnownBlock` for our peer.  I believe this means that if we relay a block that has the same work as our tip, then our peers will \"forget\" that they can even download our actual tip from us(!).\r\n\r\nMy suggestion: only call `NewPoWValidBlock()` in `AcceptBlock()` for blocks that build on our tip.",
      "created_at" : "2017-01-03T21:03:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-270223870",
      "id" : 270223870,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-03T21:03:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270223870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94483881"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94483881"
         }
      },
      "body" : "I should think this through a bit more, but I believe the requirement that the block be VALID_SCRIPTS is stronger than is needed -- in particular, if two blocks arrive simultaneously, we might relay both before picking which of the two is our tip, and then gating ProcessGetData() on VALID_SCRIPTS will cause us to stall a peer who picked the other.\r\n\r\nPerhaps we should change VALID_SCRIPTS to VALID_TRANSACTIONS below, and then actually I'm not sure if we would still need this code path?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-03T21:06:49Z",
      "diff_hunk" : "@@ -949,6 +949,16 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                 BlockMap::iterator mi = mapBlockIndex.find(inv.hash);\n                 if (mi != mapBlockIndex.end())\n                 {\n+                    if (mi->second->nChainTx && !mi->second->IsValid(BLOCK_VALID_SCRIPTS) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94483881",
      "id" : 94483881,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 15011971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94483881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94490873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94490873"
         }
      },
      "body" : "@gmaxwell see this comment.  I think this would cover the case of needing to cache more than one block..\r\n",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-03T21:48:53Z",
      "diff_hunk" : "@@ -949,6 +949,16 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                 BlockMap::iterator mi = mapBlockIndex.find(inv.hash);\n                 if (mi != mapBlockIndex.end())\n                 {\n+                    if (mi->second->nChainTx && !mi->second->IsValid(BLOCK_VALID_SCRIPTS) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94490873",
      "id" : 94490873,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 15018914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94490873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94519686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94519686"
         }
      },
      "body" : "This seems like a rather large change (that I dont particularly want to do in this PR). Is it sufficient to not do the pre-forward unless the new block builds on our tip?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-04T01:54:34Z",
      "diff_hunk" : "@@ -949,6 +949,16 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                 BlockMap::iterator mi = mapBlockIndex.find(inv.hash);\n                 if (mi != mapBlockIndex.end())\n                 {\n+                    if (mi->second->nChainTx && !mi->second->IsValid(BLOCK_VALID_SCRIPTS) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94519686",
      "id" : 94519686,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 15047291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94519686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Pushed fixes for @sdaftuar's comments, note that travis should fail the second-to-last-one as I added a test for the bug identified.",
      "created_at" : "2017-01-04T01:59:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-270277250",
      "id" : 270277250,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-04T01:59:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270277250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94524054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94524054"
         }
      },
      "body" : "commented on IRC, but no i think we need a fix here.\r\n\r\nOtherwise we can be in a situation where we stall a peer who asks for a block we just announced to them.\r\n\r\ni.e. We try and connect A and A' near simultaneously as new tips.  We announce both, but whichever gets connected first, the other we will stall requests for.  This can happen even without multi-threaded ProcessMessages via a race with submitblock.  ",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-04T03:02:23Z",
      "diff_hunk" : "@@ -949,6 +949,16 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                 BlockMap::iterator mi = mapBlockIndex.find(inv.hash);\n                 if (mi != mapBlockIndex.end())\n                 {\n+                    if (mi->second->nChainTx && !mi->second->IsValid(BLOCK_VALID_SCRIPTS) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94524054",
      "id" : 94524054,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 15051509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94524054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94624247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94624247"
         }
      },
      "body" : "I think it is safe to drop the VALID_SCRIPTS check altogether (ie no need to replace with any other validity check such as VALID_TRANSACTIONS as I suggested above) when we are setting the `send` variable below, and we don't need to call `ActivateBestChain()` here at all.  We are still adequately protected against fingerprinting attacks with the `GetBlockProofEquivalentTime()` check.\r\n\r\nWhen we added the fingerprinting protection, it was the case that we only relayed things that were on our chain (at some point), so the VALID_SCRIPTS check was fine as a belt-and-suspenders test, but now that this PR relaxes that requirement, I think it makes sense to remove.\r\n\r\n\r\n",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-04T17:15:15Z",
      "diff_hunk" : "@@ -949,6 +949,16 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                 BlockMap::iterator mi = mapBlockIndex.find(inv.hash);\n                 if (mi != mapBlockIndex.end())\n                 {\n+                    if (mi->second->nChainTx && !mi->second->IsValid(BLOCK_VALID_SCRIPTS) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94624247",
      "id" : 94624247,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 15154818,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94624247",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94624470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94624470"
         }
      },
      "body" : "ping @sipa, please see above...",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-04T17:16:48Z",
      "diff_hunk" : "@@ -949,6 +949,16 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                 BlockMap::iterator mi = mapBlockIndex.find(inv.hash);\n                 if (mi != mapBlockIndex.end())\n                 {\n+                    if (mi->second->nChainTx && !mi->second->IsValid(BLOCK_VALID_SCRIPTS) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94624470",
      "id" : 94624470,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 15155083,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94624470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Rebased to clean up merge conflict, squashing the fixup commits. No changes to code.",
      "created_at" : "2017-01-04T20:57:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-270484511",
      "id" : 270484511,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-04T20:57:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270484511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Added a check that we only ever fast-announce once per block height, see https://0bin.net/paste/f1-cJq66rGul-VBY#vUW-L7QZR4+e8u/vx1ZNk1x3+5qn50ysFOghGC1gyLy\r\nI dont think this is strictly required, but it simplifies review significantly and is likely a better behavior anyway, since you can never reconstruct two compact blocks at the same height reasonable right now anyway.\r\n\r\nAlso fixed a rebase issue where a diff chunk ended up in the wrong commit.",
      "created_at" : "2017-01-05T15:35:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-270672747",
      "id" : 270672747,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-05T15:35:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270672747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94816083"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94816083"
         }
      },
      "body" : "Might be good to release cs_most_recent_block in the else case during ReadBlockFromDisk.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-05T17:50:30Z",
      "diff_hunk" : "@@ -2859,13 +2861,24 @@ bool SendMessages(CNode* pto, CConnman& connman, std::atomic<bool>& interruptMsg\n                     // probably means we're doing an initial-ish-sync or they're slow\n                     LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d\\n\", __func__,\n                             vHeaders.front().GetHash().ToString(), pto->id);\n-                    //TODO: Shouldn't need to reload block from disk, but requires refactor\n-                    CBlock block;\n-                    bool ret = ReadBlockFromDisk(block, pBestIndex, consensusParams);\n-                    assert(ret);\n-                    CBlockHeaderAndShortTxIDs cmpctblock(block, state.fWantsCmpctWitness);\n+\n                     int nSendFlags = state.fWantsCmpctWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;\n-                    connman.PushMessage(pto, msgMaker.Make(nSendFlags, NetMsgType::CMPCTBLOCK, cmpctblock));\n+\n+                    LOCK(cs_most_recent_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94816083",
      "id" : 94816083,
      "original_commit_id" : "5749a853b9f46cc58d51aae8b5d4dcbd110a20ca",
      "original_position" : 47,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 15354969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94816083",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "body" : "I'm the boy who cried ACK (4 times already) on this PR, so I'll refrain from repeating it again, but your last changes look good to me and I feel like all open concerns are addressed.\r\n\r\nI'm going to put it into action combined with #9441 on a few nodes.\r\n",
      "created_at" : "2017-01-06T18:19:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-270967777",
      "id" : 270967777,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-06T18:19:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270967777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95003832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95003832"
         }
      },
      "body" : "Ok after further thought and offline discussion, I retract my objection to leaving the VALID_SCRIPTS check in.\r\n\r\nMy original concern was that there were some race conditions where we might announce a block pre-validation, and then never test the block's validity, resulting in stalling block download to a peer for a valid block.  After the change to only do pre-validation announcements for a single block at a given height and only for blocks that build on our tip, I think this is no longer an issue.\r\n\r\nA secondary concern was generally figuring out how to handle block requests for invalid blocks.  In the typical case of a cmpctblock announcement being followed by a getblocktxn request, I believe everything works as intended (a node would provide the blocktxn, and the peer would not punish if the block turned out to be invalid).  However if a peer somehow fell back to a getdata request for that block, then this code would cause us to stall the peer's block download, likely resulting in them disconnecting us.\r\n\r\nThe alternative, however, of delivering the block when we know it is invalid is potentially even worse -- they would ban us, absent more code changes to handle this situation (which #9026 overlooked), which is a lot more code complexity.\r\n\r\nI haven't been able to come up with realistic scenarios where someone could provoke these conditions (ie, produce an invalid block in such a way as to also cause nodes to fall back to getdata responses to the cmpctblock announcement), so I think this is an acceptable behavior to introduce for now.  In the future, though it would be nice to add a protocol extension so that we could have the option of telling our peer that a block request is being ignored, so that the peer could do something smarter than just disconnect us for stalling download.\r\n\r\nTo remind us, I think it'd be nice to add a comment in `ProcessGetData()` that mentions this issue, something like:\r\n\r\n```\r\n// TODO: extend the protocol to allow us to tell our peer that we're not going to deliver a block that we've previously announced, eg because we don't think the block is valid.\r\n// This would give allow our peer to be make a better decision than just wait indefinitely or disconnect us for stalling block download.\r\n```",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-06T19:25:43Z",
      "diff_hunk" : "@@ -949,6 +949,16 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                 BlockMap::iterator mi = mapBlockIndex.find(inv.hash);\n                 if (mi != mapBlockIndex.end())\n                 {\n+                    if (mi->second->nChainTx && !mi->second->IsValid(BLOCK_VALID_SCRIPTS) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95003832",
      "id" : 95003832,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 15549674,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95003832",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "@TheBlueMatt What do you think about making the LogPrints say:\r\n`sending header-and-ids 0000myluckyhash to peer=8888`\r\ninstead of\r\n`sending header-and-ids 0000myluckyhash to peer 8888`\r\n\r\nYou only add one of those in this PR, the other LogPrint for header-and-ids does the same thing, but its a bit annoying that they are formatted differently than other net debug messages.",
      "created_at" : "2017-01-07T03:26:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-271059566",
      "id" : 271059566,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-07T03:26:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271059566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "@morcos did it separately in #9486.",
      "created_at" : "2017-01-07T16:49:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-271094864",
      "id" : 271094864,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-07T16:49:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271094864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95356716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95356716"
         }
      },
      "body" : "This include is unnecessary",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-10T12:47:51Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n \n #include <boost/signals2/signal.hpp>\n #include <boost/shared_ptr.hpp>\n+#include <memory>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95356716",
      "id" : 95356716,
      "original_commit_id" : "c1ae4fcf7d5d85c182e36ff6f7a529f8a84aa372",
      "original_position" : 4,
      "path" : "src/validationinterface.h",
      "position" : 4,
      "pull_request_review_id" : 15907842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95356716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "The <memory> include is only unnecessary because I'm sure boost/shared_ptr includes it. It is appropriate to add because we're now using shared_ptrs in one of the functions.\n\nOn January 10, 2017 4:47:55 AM PST, \"Wladimir J. van der Laan\" <notifications@github.com> wrote:\n>laanwj commented on this pull request.\n>\n>\n>\n>> @@ -8,6 +8,7 @@\n> \n> #include <boost/signals2/signal.hpp>\n> #include <boost/shared_ptr.hpp>\n>+#include <memory>\n>\n>This include is unnecessary\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9375#pullrequestreview-15907842\n",
      "created_at" : "2017-01-10T16:31:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-271624299",
      "id" : 271624299,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-10T16:31:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271624299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Ok, fair enough.",
      "created_at" : "2017-01-11T12:55:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-271861291",
      "id" : 271861291,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-11T12:55:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271861291",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "utACK c1ae4fc",
      "created_at" : "2017-01-11T12:59:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-271862206",
      "id" : 271862206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-11T12:59:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271862206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95639720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95639720"
         }
      },
      "body" : "I prefer @ryanofsky's code.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-11T18:25:21Z",
      "diff_hunk" : "@@ -3029,12 +3029,14 @@ static bool AcceptBlockHeader(const CBlockHeader& block, CValidationState& state\n }\n \n // Exposed wrapper for AcceptBlockHeader\n-bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, CBlockIndex** ppindex)\n+bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, const CBlockIndex** ppindex)\n {\n     {\n         LOCK(cs_main);\n         for (const CBlockHeader& header : headers) {\n-            if (!AcceptBlockHeader(header, state, chainparams, ppindex)) {\n+            // cast away the ppindex-returns-const CBlockIndex - we're just assigning it to a CBlockIndex*",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95639720",
      "id" : 95639720,
      "original_commit_id" : "c3084dd684e9ecc1e0171159cfe36f580d87ba25",
      "original_position" : 11,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 16202270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95639720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95659683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95659683"
         }
      },
      "body" : "Should we unlock cs_main before this call?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-11T20:03:31Z",
      "diff_hunk" : "@@ -1558,17 +1597,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         bool ret = ReadBlockFromDisk(block, it->second, chainparams.GetConsensus());\n         assert(ret);\n \n-        BlockTransactions resp(req);\n-        for (size_t i = 0; i < req.indexes.size(); i++) {\n-            if (req.indexes[i] >= block.vtx.size()) {\n-                Misbehaving(pfrom->GetId(), 100);\n-                LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);\n-                return true;\n-            }\n-            resp.txn[i] = block.vtx[req.indexes[i]];\n-        }\n-        int nSendFlags = State(pfrom->GetId())->fWantsCmpctWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;\n-        connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCKTXN, resp));\n+        SendBlockTransactions(block, req, pfrom, connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95659683",
      "id" : 95659683,
      "original_commit_id" : "9eaec08dd236a9e73c7993d25274ec913c999c63",
      "original_position" : 82,
      "path" : "src/net_processing.cpp",
      "position" : 252,
      "pull_request_review_id" : 16202270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95659683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95659903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95659903"
         }
      },
      "body" : "I don't think we should be relying on indirect includes, and this file does directly use shared_ptr.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-11T20:04:37Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n \n #include <boost/signals2/signal.hpp>\n #include <boost/shared_ptr.hpp>\n+#include <memory>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95659903",
      "id" : 95659903,
      "original_commit_id" : "c1ae4fcf7d5d85c182e36ff6f7a529f8a84aa372",
      "original_position" : 4,
      "path" : "src/validationinterface.h",
      "position" : 4,
      "pull_request_review_id" : 16202270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95659903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95664298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95664298"
         }
      },
      "body" : "All it does is a FindMostWorkChain, which should be very cheap if we're already synced (return the end from setBlockIndexCandidates, and comparing it to chainActive).",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-11T20:25:47Z",
      "diff_hunk" : "@@ -1507,6 +1517,18 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         LOCK(cs_main);\n \n+        // We might have announced the currently-being-connected tip using a\n+        // compact block, which resulted in the peer sending a getblocks\n+        // request, which we would otherwise respond to without the new block.\n+        // To avoid this situation we simply verify that we are on our best\n+        // known chain now. This is super overkill, but we handle it better\n+        // for getheaders requests, and there are no known nodes which support\n+        // compact blocks but still use getblocks to request blocks.\n+        {\n+            CValidationState dummy;\n+            ActivateBestChain(dummy, Params());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95664298",
      "id" : 95664298,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 30,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 16202270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95664298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95664608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95664608"
         }
      },
      "body" : "ActivateBestChain is usually called without holding cs_main (as it tries to release the lock in between activations if there are multiple). Is it necessary to call it within cs_main here?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-11T20:27:29Z",
      "diff_hunk" : "@@ -1507,6 +1517,18 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         LOCK(cs_main);\n \n+        // We might have announced the currently-being-connected tip using a\n+        // compact block, which resulted in the peer sending a getblocks\n+        // request, which we would otherwise respond to without the new block.\n+        // To avoid this situation we simply verify that we are on our best\n+        // known chain now. This is super overkill, but we handle it better\n+        // for getheaders requests, and there are no known nodes which support\n+        // compact blocks but still use getblocks to request blocks.\n+        {\n+            CValidationState dummy;\n+            ActivateBestChain(dummy, Params());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95664608",
      "id" : 95664608,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 30,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 16202270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95664608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95670603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95670603"
         }
      },
      "body" : "Mentioned on IRC as well:\r\n\r\nAn example of an unintended side-effect of this:\r\n- miner mines a block, hands it to ProcessNewBlock()\r\n- ProcessMessages thread simultaneously receives a GETBLOCKS\r\n- ProcessMessages calls ActivateBestChain _just_ after miner finishes AcceptBlock() and releases cs_main.\r\n- ConnectTip ends up getting called with a null block, activating the chain with the miner's new block, but forcing it to be read from disk\r\n- Miner's ActivateBestChain is a no-op\r\n\r\nThe above is unlikely and harmless (minus the msec it takes to read/de-serialize from disk), but it's an example of how someone hammering a miner with GETBLOCKS would be capable of affecting validation.\r\nPresumably with multi-threaded message processing, a node hammering with GETBLOCKS might be able to force all block reads to disk this way.\r\n\r\nIf the intention is simply to ensure that we've fully validated all known blocks at this moment, I'd be much more comfortable with some function that simply blocks until any current ActivateBestChain() completes. That would also protect us from oopses in the future when processing becomes multi-threaded.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-11T20:59:35Z",
      "diff_hunk" : "@@ -1507,6 +1517,18 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         LOCK(cs_main);\n \n+        // We might have announced the currently-being-connected tip using a\n+        // compact block, which resulted in the peer sending a getblocks\n+        // request, which we would otherwise respond to without the new block.\n+        // To avoid this situation we simply verify that we are on our best\n+        // known chain now. This is super overkill, but we handle it better\n+        // for getheaders requests, and there are no known nodes which support\n+        // compact blocks but still use getblocks to request blocks.\n+        {\n+            CValidationState dummy;\n+            ActivateBestChain(dummy, Params());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95670603",
      "id" : 95670603,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 30,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 16234174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95670603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "utACK all except https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95670603. (see IMO we need a more general-purpose solution for fencing here, otherwise we're asking for future bugs.",
      "created_at" : "2017-01-11T21:17:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-271997310",
      "id" : 271997310,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-11T21:17:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271997310",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95690606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95690606"
         }
      },
      "body" : "We take cs_main again inside SendBlockTransactions, so I dont think its worth unlocking here.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-11T22:49:44Z",
      "diff_hunk" : "@@ -1558,17 +1597,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         bool ret = ReadBlockFromDisk(block, it->second, chainparams.GetConsensus());\n         assert(ret);\n \n-        BlockTransactions resp(req);\n-        for (size_t i = 0; i < req.indexes.size(); i++) {\n-            if (req.indexes[i] >= block.vtx.size()) {\n-                Misbehaving(pfrom->GetId(), 100);\n-                LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);\n-                return true;\n-            }\n-            resp.txn[i] = block.vtx[req.indexes[i]];\n-        }\n-        int nSendFlags = State(pfrom->GetId())->fWantsCmpctWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;\n-        connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCKTXN, resp));\n+        SendBlockTransactions(block, req, pfrom, connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95690606",
      "id" : 95690606,
      "original_commit_id" : "9eaec08dd236a9e73c7993d25274ec913c999c63",
      "original_position" : 82,
      "path" : "src/net_processing.cpp",
      "position" : 252,
      "pull_request_review_id" : 16255152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95690606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95691455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95691455"
         }
      },
      "body" : "It probably doesn't matter too much here, but it's easier to reason about function that are only called with certain locks held or not held, and not both depending on the circumstances.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-11T22:54:46Z",
      "diff_hunk" : "@@ -1558,17 +1597,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         bool ret = ReadBlockFromDisk(block, it->second, chainparams.GetConsensus());\n         assert(ret);\n \n-        BlockTransactions resp(req);\n-        for (size_t i = 0; i < req.indexes.size(); i++) {\n-            if (req.indexes[i] >= block.vtx.size()) {\n-                Misbehaving(pfrom->GetId(), 100);\n-                LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);\n-                return true;\n-            }\n-            resp.txn[i] = block.vtx[req.indexes[i]];\n-        }\n-        int nSendFlags = State(pfrom->GetId())->fWantsCmpctWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;\n-        connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCKTXN, resp));\n+        SendBlockTransactions(block, req, pfrom, connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95691455",
      "id" : 95691455,
      "original_commit_id" : "9eaec08dd236a9e73c7993d25274ec913c999c63",
      "original_position" : 82,
      "path" : "src/net_processing.cpp",
      "position" : 252,
      "pull_request_review_id" : 16256003,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95691455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95691982"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95691982"
         }
      },
      "body" : "OK, changed.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-11T22:57:49Z",
      "diff_hunk" : "@@ -3029,12 +3029,14 @@ static bool AcceptBlockHeader(const CBlockHeader& block, CValidationState& state\n }\n \n // Exposed wrapper for AcceptBlockHeader\n-bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, CBlockIndex** ppindex)\n+bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, const CBlockIndex** ppindex)\n {\n     {\n         LOCK(cs_main);\n         for (const CBlockHeader& header : headers) {\n-            if (!AcceptBlockHeader(header, state, chainparams, ppindex)) {\n+            // cast away the ppindex-returns-const CBlockIndex - we're just assigning it to a CBlockIndex*",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95691982",
      "id" : 95691982,
      "original_commit_id" : "c3084dd684e9ecc1e0171159cfe36f580d87ba25",
      "original_position" : 11,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 16256502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95691982",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95692294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95692294"
         }
      },
      "body" : "I hope to remove the cs_main in the function (and then not call it with cs_main) after #9419 + a few more changes.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-11T22:59:45Z",
      "diff_hunk" : "@@ -1558,17 +1597,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         bool ret = ReadBlockFromDisk(block, it->second, chainparams.GetConsensus());\n         assert(ret);\n \n-        BlockTransactions resp(req);\n-        for (size_t i = 0; i < req.indexes.size(); i++) {\n-            if (req.indexes[i] >= block.vtx.size()) {\n-                Misbehaving(pfrom->GetId(), 100);\n-                LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);\n-                return true;\n-            }\n-            resp.txn[i] = block.vtx[req.indexes[i]];\n-        }\n-        int nSendFlags = State(pfrom->GetId())->fWantsCmpctWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;\n-        connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCKTXN, resp));\n+        SendBlockTransactions(block, req, pfrom, connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95692294",
      "id" : 95692294,
      "original_commit_id" : "9eaec08dd236a9e73c7993d25274ec913c999c63",
      "original_position" : 82,
      "path" : "src/net_processing.cpp",
      "position" : 252,
      "pull_request_review_id" : 16256805,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95692294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95859670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95859670"
         }
      },
      "body" : "@sipa Yes, moved this one out of the cs_main, but the other one is much harder to move out of cs_main (luckily the one that handles getdatas is much less likely to have long-runtime because its specifically gated already).\r\n\r\n@theuni Will follow up on IRC, though I fixed the particular issue you mentioned (not that its a response to your general concern).",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-12T18:57:35Z",
      "diff_hunk" : "@@ -1507,6 +1517,18 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         LOCK(cs_main);\n \n+        // We might have announced the currently-being-connected tip using a\n+        // compact block, which resulted in the peer sending a getblocks\n+        // request, which we would otherwise respond to without the new block.\n+        // To avoid this situation we simply verify that we are on our best\n+        // known chain now. This is super overkill, but we handle it better\n+        // for getheaders requests, and there are no known nodes which support\n+        // compact blocks but still use getblocks to request blocks.\n+        {\n+            CValidationState dummy;\n+            ActivateBestChain(dummy, Params());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r95859670",
      "id" : 95859670,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 30,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 16428953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95859670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Address all of @sipa's comments, and added a comment to (hopefully) appease @theuni.",
      "created_at" : "2017-01-12T20:17:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-272271470",
      "id" : 272271470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-12T20:17:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272271470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "OK, I'm going for number 5!\r\n\r\ntested ACK c1ae4fc\r\nutACK 73666ad\r\n\r\nTo reemphasize, the caching in this PR provides a huge performance win.",
      "created_at" : "2017-01-12T21:38:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-272291945",
      "id" : 272291945,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-12T21:38:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272291945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "@TheBlueMatt Thanks for adding the comment.  utACK 73666ad05932429c860efe74eb388d212c152fc4.",
      "created_at" : "2017-01-13T03:08:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-272349737",
      "id" : 272349737,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-13T03:08:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272349737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "utACK 73666ad",
      "created_at" : "2017-01-13T15:58:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-272477759",
      "id" : 272477759,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-13T15:58:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272477759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96049683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96049683"
         }
      },
      "body" : "Can this be a `std::make_shared<const CBlockHeaderAndShortTxIDS>` (slightly easier to reason about thread safety when shared_ptr objects are const).",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-13T18:48:42Z",
      "diff_hunk" : "@@ -754,10 +754,11 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n \n static CCriticalSection cs_most_recent_block;\n static std::shared_ptr<const CBlock> most_recent_block;\n+static std::shared_ptr<CBlockHeaderAndShortTxIDs> most_recent_compact_block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96049683",
      "id" : 96049683,
      "original_commit_id" : "5749a853b9f46cc58d51aae8b5d4dcbd110a20ca",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 16626070,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96049683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96069027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96069027"
         }
      },
      "body" : "Idea for follow-up PR: cache the `CSerializedNetMsg` instead of the `CBlockHeaderAndShortTxIDs` (smaller and faster to process)?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-13T20:34:21Z",
      "diff_hunk" : "@@ -2859,13 +2861,24 @@ bool SendMessages(CNode* pto, CConnman& connman, std::atomic<bool>& interruptMsg\n                     // probably means we're doing an initial-ish-sync or they're slow\n                     LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d\\n\", __func__,\n                             vHeaders.front().GetHash().ToString(), pto->id);\n-                    //TODO: Shouldn't need to reload block from disk, but requires refactor\n-                    CBlock block;\n-                    bool ret = ReadBlockFromDisk(block, pBestIndex, consensusParams);\n-                    assert(ret);\n-                    CBlockHeaderAndShortTxIDs cmpctblock(block, state.fWantsCmpctWitness);\n+\n                     int nSendFlags = state.fWantsCmpctWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;\n-                    connman.PushMessage(pto, msgMaker.Make(nSendFlags, NetMsgType::CMPCTBLOCK, cmpctblock));\n+\n+                    LOCK(cs_most_recent_block);\n+                    if (most_recent_block_hash == pBestIndex->GetBlockHash()) {\n+                        if (state.fWantsCmpctWitness)\n+                            connman.PushMessage(pto, msgMaker.Make(nSendFlags, NetMsgType::CMPCTBLOCK, *most_recent_compact_block));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96069027",
      "id" : 96069027,
      "original_commit_id" : "5749a853b9f46cc58d51aae8b5d4dcbd110a20ca",
      "original_position" : 50,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 16626070,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96069027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "utACK 73666ad05932429c860efe74eb388d212c152fc4",
      "created_at" : "2017-01-13T20:41:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-272542551",
      "id" : 272542551,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-13T20:41:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272542551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96071482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96071482"
         }
      },
      "body" : "Ok, done.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-13T20:50:26Z",
      "diff_hunk" : "@@ -754,10 +754,11 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n \n static CCriticalSection cs_most_recent_block;\n static std::shared_ptr<const CBlock> most_recent_block;\n+static std::shared_ptr<CBlockHeaderAndShortTxIDs> most_recent_compact_block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96071482",
      "id" : 96071482,
      "original_commit_id" : "5749a853b9f46cc58d51aae8b5d4dcbd110a20ca",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 16649244,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96071482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Pushed one (hopefully last) commit which only adds two const's to net_processing at @sipa's request.",
      "created_at" : "2017-01-13T20:50:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-272544681",
      "id" : 272544681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-13T20:50:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272544681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96075171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96075171"
         }
      },
      "body" : "Also add const to the make_shared parameter?",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-13T21:14:41Z",
      "diff_hunk" : "@@ -754,11 +754,11 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n \n static CCriticalSection cs_most_recent_block;\n static std::shared_ptr<const CBlock> most_recent_block;\n-static std::shared_ptr<CBlockHeaderAndShortTxIDs> most_recent_compact_block;\n+static std::shared_ptr<const CBlockHeaderAndShortTxIDs> most_recent_compact_block;\n static uint256 most_recent_block_hash;\n \n void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n-    std::shared_ptr<CBlockHeaderAndShortTxIDs> pcmpctblock = std::make_shared<CBlockHeaderAndShortTxIDs> (*pblock, true);\n+    std::shared_ptr<const CBlockHeaderAndShortTxIDs> pcmpctblock = std::make_shared<CBlockHeaderAndShortTxIDs> (*pblock, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96075171",
      "id" : 96075171,
      "original_commit_id" : "38bcdf72fd88a974a2acdaf7089c95ecd6bb41bd",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 16653257,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96075171",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96077427"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96077427"
         }
      },
      "body" : "Ok, did so and squashed it into the previous commit.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-13T21:28:26Z",
      "diff_hunk" : "@@ -754,11 +754,11 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n \n static CCriticalSection cs_most_recent_block;\n static std::shared_ptr<const CBlock> most_recent_block;\n-static std::shared_ptr<CBlockHeaderAndShortTxIDs> most_recent_compact_block;\n+static std::shared_ptr<const CBlockHeaderAndShortTxIDs> most_recent_compact_block;\n static uint256 most_recent_block_hash;\n \n void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n-    std::shared_ptr<CBlockHeaderAndShortTxIDs> pcmpctblock = std::make_shared<CBlockHeaderAndShortTxIDs> (*pblock, true);\n+    std::shared_ptr<const CBlockHeaderAndShortTxIDs> pcmpctblock = std::make_shared<CBlockHeaderAndShortTxIDs> (*pblock, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96077427",
      "id" : 96077427,
      "original_commit_id" : "38bcdf72fd88a974a2acdaf7089c95ecd6bb41bd",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 16655682,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-13T21:28:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96077427",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96420463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96420463"
         }
      },
      "body" : "I'm struggling to understand why this is really needed, unless it is here to cater for a re-org that goes back more than 30 days as the logic below allows blocks to be sent that are not in the main chain but are less than 30 days old.",
      "commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "created_at" : "2017-01-17T14:21:45Z",
      "diff_hunk" : "@@ -912,6 +957,21 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                 BlockMap::iterator mi = mapBlockIndex.find(inv.hash);\n                 if (mi != mapBlockIndex.end())\n                 {\n+                    if (mi->second->nChainTx && !mi->second->IsValid(BLOCK_VALID_SCRIPTS) &&\n+                            mi->second->IsValid(BLOCK_VALID_TREE)) {\n+                        // If we have the block and all of its parents, but have not yet validated it,\n+                        // we might be in the middle of connecting it (ie in the unlock of cs_main\n+                        // before ActivateBestChain but after AcceptBlock).\n+                        // In this case, we need to run ActivateBestChain prior to checking the relay\n+                        // conditions below.\n+                        std::shared_ptr<const CBlock> a_recent_block;\n+                        {\n+                            LOCK(cs_most_recent_block);\n+                            a_recent_block = most_recent_block;\n+                        }\n+                        CValidationState dummy;\n+                        ActivateBestChain(dummy, Params(), a_recent_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r96420463",
      "id" : 96420463,
      "original_commit_id" : "02ee4eb2637db9077aefa1f5e59864218e016b93",
      "original_position" : 151,
      "path" : "src/net_processing.cpp",
      "position" : 151,
      "pull_request_review_id" : 17000362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-17T14:21:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96420463",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   }
]
