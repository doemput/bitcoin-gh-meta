[
   {
      "body" : "Alternative solutions would be:\r\n* Always reserve the change output key when calling `fundrawtransaction`\r\n* Add an option to the RPC call to reserve the change output key (probably true by default)\r\n* Add a new RPC call `reserveaddress` or `reservechangeaddressfromtransaction` (or similar).",
      "created_at" : "2016-12-16T17:06:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-267643066",
      "id" : 267643066,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2016-12-16T17:06:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267643066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "So we should make a separate PR that removes any key from the keypool that shows up in a transaction. That is a generally good thing to do-- and its important for HD key rescan (in fact, It should remove all keys up to the key it found).\r\n\r\nBut I don't believe that it is a correct solution here. We should reserve the key on use, having an argument (default to true) to do so would be okay but I'm not sure if it would be very useful.  Otherwise this is going to cause continual reuse with in flight transactions. ",
      "created_at" : "2016-12-16T18:44:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-267666335",
      "id" : 267666335,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2016-12-16T18:44:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267666335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "> But I don't believe that it is a correct solution here. We should reserve the key on use, having an argument (default to true) to do so would be okay but I'm not sure if it would be very useful. Otherwise this is going to cause continual reuse with in flight transactions.\r\n\r\nThe reason why I think the key-reserve could be optional are..\r\n* the original design was that one *can* call `fundrawtransaction` without changing the wallet state\r\n* Inputs are also not getting locked\r\n\r\nAn optional `reservekey` flag with default=`true` makes sense IMO.\r\nAlso, keypool keys should not be a sacred resource.",
      "created_at" : "2016-12-18T12:17:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-267818020",
      "id" : 267818020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2016-12-18T12:17:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267818020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "I agree `fundrawtransaction` should reserve the key. However we don't have a method to give back reserved keys. Is that a problem? We don't have a way to \"commit\" a transaction except for \"sendrawtransaction\", which also sends it. \r\n\r\nAt least it should be documented very well. Otherwise people may be running `fundrawtransaction` in a loop with slightly different parameters, throwing away the transactions and wondering why they race through the mempool so quickly.\r\n\r\nI think the change in this pull is a good idea in any case. Keys that have been seen should not be in the mempool anymore. It's also logic that is necessary for automatically rolling forward HD wallets created with an old seed.",
      "created_at" : "2016-12-19T07:36:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-267900092",
      "id" : 267900092,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2016-12-19T07:40:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267900092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "> [...] It's also logic that is necessary for automatically rolling forward HD wallets created with an old seed.\r\n\r\nThe problem here is, that we should extend the keypool (top-up the pool) whenever the gap limit was not exceeded. Lets say, if the key no. 95 of a keypool with 100 keys was used, we should extend the keypool with another ~100 keys.\r\nBut doing this in the `SyncTransaction()` logic would probably be really bad (also assume wallet is encrypted).",
      "created_at" : "2016-12-19T07:47:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-267901580",
      "id" : 267901580,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2016-12-19T07:47:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267901580",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "> But doing this in the SyncTransaction() logic would probably be really bad (also assume wallet is encrypted).\r\n\r\nWhy would it be bad?  generating 100 keys should take <13 milliseconds.",
      "created_at" : "2016-12-20T04:58:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-268155109",
      "id" : 268155109,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2016-12-20T04:58:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268155109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "But how would this work with encrypted wallets?",
      "created_at" : "2016-12-20T06:18:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-268164716",
      "id" : 268164716,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2016-12-20T06:18:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268164716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "@jonasschnelli If the wallet is not unlocked-- you can't. But just because something good can't be done all the time that doesn't mean we shouldn't do it when we can, unless there is some downsie.  Failing to do it doesn't make anything actually work better and it means that even unlock+rescan won't just work when otherwise it would.\r\n\r\nIf key number 95 is used we should mark it and all keys before it as used. If that ends up leaving us with an empty keypool-- ok! thats better than silently reusing addresses. If the keypool is made larger like 1000 or 10000 addresses this is less of an issue and we could also periodically prompt the user to unlock when it gets low.",
      "created_at" : "2016-12-23T18:15:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-269027076",
      "id" : 269027076,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2016-12-23T18:15:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269027076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "I really don't like the unreliable behaviour that would follow from this. People may test their software with unencrypted wallet, and then in production a recovery is attempted and keys are missed - forcing the operator to do a full rescan (or if they were pruning, a full resync).\r\n\r\nI think I prefer just increasing the keypool size. If that's enough to make this a non-issue, we don't need to introduce best attempts.",
      "created_at" : "2016-12-23T22:02:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-269050343",
      "id" : 269050343,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2016-12-23T22:02:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269050343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "IMO the TXOs and reserve-key should be locked at the same time in the same manner; is there a use case for doing them inconsistently? Either `fundrawtransaction` should lock both, or neither (and `sendrawtransaction` required to commit to the result). A flag to choose which behaviour sounds reasonable to me.",
      "created_at" : "2016-12-24T04:12:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-269068109",
      "id" : 269068109,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2016-12-24T04:12:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269068109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "I may be missing something, but after reviewing #9377, specially the comment in https://github.com/bitcoin/bitcoin/pull/9377/files#diff-ef76fd6674f07db88c3422fdbf0bcf9fR103 and also reading this whole thread, specially in the op \"The only possible solution for now is to call getrawchangeaddress and pass the change address to the fundrawtransaction options.\"...it definitely feels like I'm missing something for proposing the following:\r\n\r\nLet's just make 'changeAddress' mandatory instead of optional and suggest users to use getrawchangeaddress() in changeAddress' documentation.\r\n\r\nUnrelated: I assume this is planned to be rebased on top of rebased #9377.",
      "created_at" : "2017-01-13T00:41:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-272328980",
      "id" : 272328980,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2017-01-13T00:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272328980",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Closing in favour of merged https://github.com/bitcoin/bitcoin/pull/9377",
      "created_at" : "2017-01-26T19:27:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9370#issuecomment-275486806",
      "id" : 275486806,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9370",
      "updated_at" : "2017-01-26T19:27:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/275486806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   }
]
