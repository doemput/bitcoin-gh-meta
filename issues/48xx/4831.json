{
   "assignee" : null,
   "body" : "- Instead of naively planning requests every two minutes into (potentially) the far future w/ mapAlreadyAskedFor, actively keep track of requests, and which nodes offer the requested items\r\n- Better handles the case where nodes announce an inv and go away, or stop responding\r\n- Maintains state separate from CNode, which makes it easier to review and understand separately from the rest, as well as localizes changes if extension of the logic is necessary\r\n\r\nI also think it can serve as an example of how to 'peel off' a single concern from net/main.\r\n\r\nUses CTimeoutCondition from @ashleyholman (#4230).\r\n\r\nCases to test:\r\n\r\n- Announce and don't reply to getdata, make sure retry chooses different node after `REQUEST_TIMEOUT`\r\n- Node disconnects and was the current node requested from - should immediately try to get from different node\r\n- Last node that had announced a certain transaction goes away - request should be discarded \r\nI've tested these cases using custom pynode clients, as well as by running this with full debugging on my node to see how it behaves,\r\n- Premature flushing if more than 1000 getdatas queued to a node (this is a very unlikely path but it needs to be tested)\r\n\r\nTODO:\r\n\r\n- Slim down debug logging (this is initially useful for testing and checking, but too much in production)\r\n- Make sure `FlushGetdata`'s handling of CNode locking is correct\r\n- Don't request from nodes whose sendbuffer is full\r\n\r\nKnown issues:\r\n\r\n- ~~Doesn't currently group getdata requests (sends a getdata request per item instead of one getdata for many invs) - wouldn't be too difficult to fit in but I'm not sure it is worth the complexity, as usually only one inv is sent at a time~~ (done now)\r\n\r\nSupercedes: #4828 #4547 #4827",
   "closed_at" : "2015-09-26T09:22:56Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 22,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4831/comments",
   "created_at" : "2014-09-03T09:38:45Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4831/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/4831",
   "id" : 41798137,
   "labels" : [
      {
         "color" : "006b75",
         "name" : "P2P",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4831/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : null,
      "closed_issues" : 74,
      "created_at" : "2015-05-01T12:31:35Z",
      "creator" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      },
      "description" : "",
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestones/0.12.0",
      "id" : 1092458,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/19/labels",
      "number" : 19,
      "open_issues" : 0,
      "state" : "open",
      "title" : "0.12.0",
      "updated_at" : "2016-06-09T08:23:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/19"
   },
   "number" : 4831,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/4831.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4831",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/4831.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4831"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "net: Better askfor request management",
   "updated_at" : "2016-03-08T10:43:15Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4831",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   }
}
