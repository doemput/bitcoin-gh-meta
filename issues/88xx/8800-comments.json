[
   {
      "body" : "Concept ACK",
      "created_at" : "2016-10-15T07:46:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8800#issuecomment-253969103",
      "id" : 253969103,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8800",
      "updated_at" : "2016-10-15T07:46:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/253969103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Concept ACK, needs rebase.",
      "created_at" : "2016-10-17T06:40:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8800#issuecomment-254124422",
      "id" : 254124422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8800",
      "updated_at" : "2016-10-17T06:40:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/254124422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Concept ACK, needs rebase.",
      "created_at" : "2016-10-31T07:57:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8800#issuecomment-257233119",
      "id" : 257233119,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8800",
      "updated_at" : "2016-10-31T07:57:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/257233119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Rebased, I still need to fix the tests.",
      "created_at" : "2016-11-03T00:14:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8800#issuecomment-258037605",
      "id" : 258037605,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8800",
      "updated_at" : "2016-11-03T00:14:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/258037605",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8800#discussion_r86304286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86304286"
         }
      },
      "body" : "is 1 sufficient?\n",
      "commit_id" : "3bd962d27161545541a3a6330399807d588dc7ea",
      "created_at" : "2016-11-03T09:08:12Z",
      "diff_hunk" : "@@ -5341,7 +5341,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                         nodestate->nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER &&\n                         (!IsWitnessEnabled(chainActive.Tip(), chainparams.GetConsensus()) || State(pfrom->GetId())->fHaveWitness)) {\n                         inv.type |= nFetchFlags;\n-                        if (nodestate->fSupportsDesiredCmpctVersion)\n+                        if (nodestate->fSupportsDesiredCmpctVersion && mempool.size() > 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8800#discussion_r86304286",
      "id" : 86304286,
      "original_commit_id" : "49a45658eaba47bbf9de79ca70c33291123b31ee",
      "original_position" : 5,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 6967503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8800",
      "updated_at" : "2016-12-05T08:01:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86304286",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8800#discussion_r86304497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86304497"
         }
      },
      "body" : "Why use two different tests? I'd have though the mempool size test for both, or the blockonly test for both would bring more consistency.\n",
      "commit_id" : "3bd962d27161545541a3a6330399807d588dc7ea",
      "created_at" : "2016-11-03T09:09:43Z",
      "diff_hunk" : "@@ -6008,10 +6008,13 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                             pindexLast->GetBlockHash().ToString(), pindexLast->nHeight);\n                 }\n                 if (vGetData.size() > 0) {\n-                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\n+                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN) && mempool.size() > 1) {\n                         // We seem to be rather well-synced, so it appears pfrom was the first to provide us\n-                        // with this block! Let's get them to announce using compact blocks in the future.\n-                        MaybeSetPeerAsAnnouncingHeaderAndIDs(nodestate, pfrom, connman);\n+                        // with this block! Let's get them to announce using compact blocks in the future, unless\n+                        // either of us are blocks-only and would prefer to save bandwidth.\n+                        if (pfrom->fRelayTxes && !GetBoolArg(\"-blocksonly\", DEFAULT_BLOCKSONLY)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8800#discussion_r86304497",
      "id" : 86304497,
      "original_commit_id" : "49a45658eaba47bbf9de79ca70c33291123b31ee",
      "original_position" : 20,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 6967685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8800",
      "updated_at" : "2016-12-05T08:01:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86304497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8800#discussion_r88788632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/88788632"
         }
      },
      "body" : "I'm not sure why we wouldn't ask this peer for compact blocks just because they are not relaying transactions.  Our mempool might be perfectly good for block reconstruction, even if the peer who is relaying blocks to us fastest is blocksonly, no? \n\nI know that in the future we're likely to want to optimize the prefilled transactions based eg on what was missing from our own mempools, but I think at the time we do that we might as well start scoring our peers based on, say, how often a roundtrip is required or something.  And if a blocksonly peer happens to be really fast to deliver us blocks then great...\n",
      "commit_id" : "3bd962d27161545541a3a6330399807d588dc7ea",
      "created_at" : "2016-11-19T21:47:23Z",
      "diff_hunk" : "@@ -6008,10 +6008,13 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                             pindexLast->GetBlockHash().ToString(), pindexLast->nHeight);\n                 }\n                 if (vGetData.size() > 0) {\n-                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\n+                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN) && mempool.size() > 1) {\n                         // We seem to be rather well-synced, so it appears pfrom was the first to provide us\n-                        // with this block! Let's get them to announce using compact blocks in the future.\n-                        MaybeSetPeerAsAnnouncingHeaderAndIDs(nodestate, pfrom, connman);\n+                        // with this block! Let's get them to announce using compact blocks in the future, unless\n+                        // either of us are blocks-only and would prefer to save bandwidth.\n+                        if (pfrom->fRelayTxes && !GetBoolArg(\"-blocksonly\", DEFAULT_BLOCKSONLY)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8800#discussion_r88788632",
      "id" : 88788632,
      "original_commit_id" : "49a45658eaba47bbf9de79ca70c33291123b31ee",
      "original_position" : 20,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 9353475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8800",
      "updated_at" : "2016-12-05T08:01:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/88788632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8800#discussion_r90520605"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/90520605"
         }
      },
      "body" : "The thinking there was that if the peer is trying to economize bandwidth, we shouldn't ask them to send the unsolicited compact blocks (HB mode). We'll still request compact blocks from them when advertised.  I don't fee super strongly, if they're trying to economize on bandwidth they should probably delay their relays artificially.  We don't have a NAK for HB mode requests though.",
      "commit_id" : "3bd962d27161545541a3a6330399807d588dc7ea",
      "created_at" : "2016-12-01T19:37:04Z",
      "diff_hunk" : "@@ -6008,10 +6008,13 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                             pindexLast->GetBlockHash().ToString(), pindexLast->nHeight);\n                 }\n                 if (vGetData.size() > 0) {\n-                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\n+                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN) && mempool.size() > 1) {\n                         // We seem to be rather well-synced, so it appears pfrom was the first to provide us\n-                        // with this block! Let's get them to announce using compact blocks in the future.\n-                        MaybeSetPeerAsAnnouncingHeaderAndIDs(nodestate, pfrom, connman);\n+                        // with this block! Let's get them to announce using compact blocks in the future, unless\n+                        // either of us are blocks-only and would prefer to save bandwidth.\n+                        if (pfrom->fRelayTxes && !GetBoolArg(\"-blocksonly\", DEFAULT_BLOCKSONLY)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8800#discussion_r90520605",
      "id" : 90520605,
      "original_commit_id" : "49a45658eaba47bbf9de79ca70c33291123b31ee",
      "original_position" : 20,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 11039964,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8800",
      "updated_at" : "2016-12-05T08:01:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/90520605",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8800#discussion_r93832197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93832197"
         }
      },
      "body" : "Why not put this check within MaybeSetPeerAsAnnouncingHeaderAndIDs() ?",
      "commit_id" : "3bd962d27161545541a3a6330399807d588dc7ea",
      "created_at" : "2016-12-25T17:40:09Z",
      "diff_hunk" : "@@ -2095,10 +2095,13 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                             pindexLast->GetBlockHash().ToString(), pindexLast->nHeight);\n                 }\n                 if (vGetData.size() > 0) {\n-                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\n+                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN) && mempool.size() > 1) {\n                         // We seem to be rather well-synced, so it appears pfrom was the first to provide us\n-                        // with this block! Let's get them to announce using compact blocks in the future.\n-                        MaybeSetPeerAsAnnouncingHeaderAndIDs(nodestate, pfrom, connman);\n+                        // with this block! Let's get them to announce using compact blocks in the future, unless\n+                        // either of us are blocks-only and would prefer to save bandwidth.\n+                        if (pfrom->fRelayTxes && !GetBoolArg(\"-blocksonly\", DEFAULT_BLOCKSONLY)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8800#discussion_r93832197",
      "id" : 93832197,
      "original_commit_id" : "3bd962d27161545541a3a6330399807d588dc7ea",
      "original_position" : 11,
      "path" : "src/net_processing.cpp",
      "position" : 11,
      "pull_request_review_id" : 14366797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8800",
      "updated_at" : "2016-12-25T17:40:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93832197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   }
]
