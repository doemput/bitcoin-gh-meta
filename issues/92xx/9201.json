{
   "assignee" : null,
   "assignees" : [],
   "body" : "### Describe the setup\r\n```\r\n            +------+   +---------+   +------+\r\n            |proxy |   |node with|   | RPC  |\r\nInternet ---|node P|---|wallet W |---|client|\r\n            |0.13.1|   |0.13.1   |   |  R   |\r\n            +------+   +---------+   +------+\r\n            \\------------ LAN --------------/\r\n```\r\n\r\nbitcoin.conf from node W:\r\n```\r\nconnect=<IP from P>:8333\r\n[..]\r\n```\r\n\r\n### Describe the issue\r\n\r\n`W` is connected to `P` all the time. When `R` calls `importprivkey` on `W`, some time later while still rescanning, `W` will drop the connection to `P` with `socket sending timeout` (15:28:03).\r\n\r\n`W` then tries to reconnect to `P`. Between establishing the TCP connection (15:28:07) and sending the version message from `W` to `P` (15:51:5) there is a delay of more than 20 minutes, resulting in the connection being dropped after trying to send the version message 20 minutes late (15:51:58).\r\n\r\nIn our case right after importing the private key a TX is generated on `W` but not being relayed to `P` (15:51:58) because of the 2nd disconnect. The TX is then only rebroadcasted another 20 minutes later (16:10:25).\r\n\r\n### Can you reliably reproduce the issue?\r\n1. Call `importprivkey`\r\n2. When finished, call `sendfrom`\r\n\r\n### Expected behaviour\r\nConnection from `W` to `P` should not be disconnected, the created TX being relayed from `W` to `P` immediately.\r\n\r\n### Actual behaviour\r\nConnection from `W` to `P` gets disconnected. Relaying of created TX from `W` to `P` is delayed for ~20 minutes.\r\n\r\n### What version of bitcoin-core are you using?\r\nv0.13.1.0-g03422e5\r\n\r\n### debug.log of `W`\r\n\r\n```\r\n(privkey is being imported)\r\n\r\n2016-11-21 15:28:01 AddToWallet 4b..............................................................  \r\n2016-11-21 15:28:01 AddToWallet 7b..............................................................  \r\n2016-11-21 15:28:02 Still rescanning. At block 365458. Progress=0.613375\r\n2016-11-21 15:28:03 socket sending timeout: 1201s\r\n2016-11-21 15:28:03 disconnecting peer=1\r\n2016-11-21 15:28:07 trying connection PROXYIP:8333 lastseen=0.0hrs\r\n2016-11-21 15:28:07 Added connection to PROXYIP:8333 peer=2\r\n2016-11-21 15:28:09 AddToWallet 5d..............................................................  \r\n2016-11-21 15:28:09 AddToWallet 30..............................................................  \r\n[..]\r\n2016-11-21 15:51:57 AddToWallet 9e..............................................................  \r\n2016-11-21 15:51:58 AddToWallet 83..............................................................  \r\n2016-11-21 15:51:58 got inv: tx 0f0213b886bdd03ae131184d8edaeb1f75216cc25df00f4f1798f1cbcad69b5c  new peer=1\r\n2016-11-21 15:51:58 askfor witness-tx 0f0213b886bdd03ae131184d8edaeb1f75216cc25df00f4f1798f1cbcad69b5c  0 (00:00:00) peer=1\r\n2016-11-21 15:51:58 send version message: version 70014, blocks=439941, us=[::]:0, them=0.0.0.0:0, peer=2\r\n2016-11-21 15:51:58 sending: version (102 bytes) peer=2\r\n2016-11-21 15:51:58 Erased 100 orphan tx from peer 1\r\n2016-11-21 15:51:58 socket closed\r\n2016-11-21 15:51:58 disconnecting peer=2\r\n2016-11-21 15:51:58 keypool added key 7949, size=301\r\n2016-11-21 15:51:58 keypool reserve 7649\r\n2016-11-21 15:51:58 keypool keep 7649\r\n[..]\r\n2016-11-21 15:51:58 CommitTransaction\r\nCTransaction(hash=ec6eXXXXXX, ver=1, vin.size=5, vout.size=2, nLockTime=439941)\r\n[..]\r\n2016-11-21 15:51:58 AddToWallet ec6eXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX  new\r\n2016-11-21 15:51:58 Blockpolicy mempool tx ec6eXXXXXX not adding\r\n[..]\r\n2016-11-21 15:52:01 Flushing wallet.dat\r\n2016-11-21 15:52:01 Flushed wallet.dat 248ms\r\n2016-11-21 15:52:03 trying connection PROXYIP:8333 lastseen=0.0hrs\r\n2016-11-21 15:52:03 Added connection to PROXYIP:8333 peer=3\r\n2016-11-21 15:52:03 send version message: version 70014, blocks=439941, us=[::]:0, them=0.0.0.0:0, peer=3\r\n[..]\r\n2016-11-21 16:10:25 Relaying wtx ec6eXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX\r\n2016-11-21 16:10:25 ResendWalletTransactions: rebroadcast 1 unconfirmed transactions\r\n```",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9201/comments",
   "created_at" : "2016-11-22T11:09:01Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9201/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/9201",
   "id" : 190970394,
   "labels" : [
      {
         "color" : "006b75",
         "default" : false,
         "id" : 98298007,
         "name" : "P2P",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9201/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 9201,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Importing privkey blocks p2p network traffic, results in connection resets and delayed TX relay",
   "updated_at" : "2016-11-22T11:15:31Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9201",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/20477825?v=3",
      "events_url" : "https://api.github.com/users/adminblogger/events{/privacy}",
      "followers_url" : "https://api.github.com/users/adminblogger/followers",
      "following_url" : "https://api.github.com/users/adminblogger/following{/other_user}",
      "gists_url" : "https://api.github.com/users/adminblogger/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/adminblogger",
      "id" : 20477825,
      "login" : "adminblogger",
      "organizations_url" : "https://api.github.com/users/adminblogger/orgs",
      "received_events_url" : "https://api.github.com/users/adminblogger/received_events",
      "repos_url" : "https://api.github.com/users/adminblogger/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/adminblogger/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/adminblogger/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/adminblogger"
   }
}
