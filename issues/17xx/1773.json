{
   "assignee" : null,
   "body" : "Investigating the listtransactions crash, I ran across this unrelated bad-use-of-memory-on-shutdown issue.\n\nLooks like the new multithreaded RPC code has a bug.\n\n```\n==61723== Memcheck, a memory error detector\n==61723== Copyright (C) 2002-2010, and GNU GPL'd, by Julian Seward et al.\n==61723== Using Valgrind-3.6.1 and LibVEX; rerun with -h for copyright info\n==61723== Command: bitcoind -datadir=/Users/gavin/ccut/1\n==61723== \n--61723-- run: /usr/bin/dsymutil \"./bitcoind\"\n==61723== Thread 3:\n==61723== Invalid read of size 4\n==61723==    at 0x14757E: boost::asio::detail::reactive_socket_service_base::destroy(boost::asio::detail::reactive_socket_service_base::base_implementation_type&) (reactive_socket_service_base.ipp:87)\n==61723==    by 0x1475F8: boost::asio::stream_socket_service<boost::asio::ip::tcp>::destroy(boost::asio::detail::reactive_socket_service<boost::asio::ip::tcp>::implementation_type&) (stream_socket_service.hpp:119)\n==61723==    by 0x147620: boost::asio::basic_io_object<boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_io_object() (basic_io_object.hpp:124)\n==61723==    by 0x14763C: boost::asio::basic_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_socket() (basic_socket.hpp:1455)\n==61723==    by 0x147658: boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_stream_socket() (basic_stream_socket.hpp:47)\n==61723==    by 0x1477D9: boost::asio::ssl::stream<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> > >::~stream() (stream.hpp:114)\n==61723==    by 0x147882: AcceptedConnectionImpl<boost::asio::ip::tcp>::~AcceptedConnectionImpl() (bitcoinrpc.cpp:2539)\n==61723==    by 0x93F3B: ThreadRPCServer3(void*) (bitcoinrpc.cpp:2879)\n==61723==    by 0x93DE3: ThreadRPCServer3(void*) (bitcoinrpc.cpp:2863)\n==61723==    by 0x93DE3: ThreadRPCServer3(void*) (bitcoinrpc.cpp:2863)\n==61723==    by 0x93DE3: ThreadRPCServer3(void*) (bitcoinrpc.cpp:2863)\n==61723==    by 0x93DE3: ThreadRPCServer3(void*) (bitcoinrpc.cpp:2863)\n==61723==  Address 0x4c38c44 is 20 bytes inside a block of size 24 free'd\n==61723==    at 0x120C477: operator delete(void*) (vg_replace_malloc.c:387)\n==61723==    by 0xE2B4A: boost::asio::stream_socket_service<boost::asio::ip::tcp>::~stream_socket_service() (stream_socket_service.hpp:42)\n==61723==    by 0xA4EA5: boost::asio::detail::service_registry::destroy(boost::asio::io_service::service*) (service_registry.ipp:101)\n==61723==    by 0x119819: boost::asio::detail::service_registry::~service_registry() (service_registry.ipp:45)\n==61723==    by 0x1198CC: boost::asio::io_service::~io_service() (io_service.ipp:53)\n==61723==    by 0x8C83E: ThreadRPCServer2(void*) (bitcoinrpc.cpp:2782)\n==61723==    by 0x8D5BB: ThreadRPCServer(void*) (bitcoinrpc.cpp:2584)\n==61723==    by 0x8D571: ThreadRPCServer(void*) (bitcoinrpc.cpp:2576)\n==61723==    by 0x8D571: ThreadRPCServer(void*) (bitcoinrpc.cpp:2576)\n==61723==    by 0x8D571: ThreadRPCServer(void*) (bitcoinrpc.cpp:2576)\n==61723==    by 0x8D571: ThreadRPCServer(void*) (bitcoinrpc.cpp:2576)\n==61723==    by 0x1261258: _pthread_start (in /usr/lib/libSystem.B.dylib)\n==61723== \n==61723== Invalid read of size 4\n==61723==    at 0x1239474: pthread_mutex_lock (in /usr/lib/libSystem.B.dylib)\n==61723==    by 0x11AE34: boost::asio::detail::posix_mutex::lock() (posix_mutex.hpp:52)\n==61723==    by 0x11AE6C: boost::asio::detail::scoped_lock<boost::asio::detail::posix_mutex>::scoped_lock(boost::asio::detail::posix_mutex&) (scoped_lock.hpp:36)\n==61723==    by 0x140A8C: boost::asio::detail::kqueue_reactor::deregister_descriptor(int, boost::asio::detail::kqueue_reactor::descriptor_state*&, bool) (kqueue_reactor.ipp:280)\n==61723==    by 0x147596: boost::asio::detail::reactive_socket_service_base::destroy(boost::asio::detail::reactive_socket_service_base::base_implementation_type&) (reactive_socket_service_base.ipp:87)\n==61723==    by 0x1475F8: boost::asio::stream_socket_service<boost::asio::ip::tcp>::destroy(boost::asio::detail::reactive_socket_service<boost::asio::ip::tcp>::implementation_type&) (stream_socket_service.hpp:119)\n==61723==    by 0x147620: boost::asio::basic_io_object<boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_io_object() (basic_io_object.hpp:124)\n==61723==    by 0x14763C: boost::asio::basic_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_socket() (basic_socket.hpp:1455)\n==61723==    by 0x147658: boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_stream_socket() (basic_stream_socket.hpp:47)\n==61723==    by 0x1477D9: boost::asio::ssl::stream<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> > >::~stream() (stream.hpp:114)\n==61723==    by 0x147882: AcceptedConnectionImpl<boost::asio::ip::tcp>::~AcceptedConnectionImpl() (bitcoinrpc.cpp:2539)\n==61723==    by 0x93F3B: ThreadRPCServer3(void*) (bitcoinrpc.cpp:2879)\n==61723==  Address 0x4a88428 is 8 bytes inside a block of size 84 free'd\n==61723==    at 0x120C477: operator delete(void*) (vg_replace_malloc.c:387)\n==61723==    by 0x11973F: void boost::asio::detail::object_pool_access::destroy<boost::asio::detail::kqueue_reactor::descriptor_state>(boost::asio::detail::kqueue_reactor::descriptor_state*) (object_pool.hpp:41)\n==61723==    by 0x11977A: boost::asio::detail::object_pool<boost::asio::detail::kqueue_reactor::descriptor_state>::destroy_list(boost::asio::detail::kqueue_reactor::descriptor_state*) (object_pool.hpp:131)\n==61723==    by 0x1197BC: boost::asio::detail::object_pool<boost::asio::detail::kqueue_reactor::descriptor_state>::~object_pool() (object_pool.hpp:73)\n==61723==    by 0x13F2E1: boost::asio::detail::kqueue_reactor::~kqueue_reactor() (kqueue_reactor.ipp:59)\n==61723==    by 0xA4EA5: boost::asio::detail::service_registry::destroy(boost::asio::io_service::service*) (service_registry.ipp:101)\n==61723==    by 0x119819: boost::asio::detail::service_registry::~service_registry() (service_registry.ipp:45)\n==61723==    by 0x1198CC: boost::asio::io_service::~io_service() (io_service.ipp:53)\n==61723==    by 0x8C83E: ThreadRPCServer2(void*) (bitcoinrpc.cpp:2782)\n==61723==    by 0x8D5BB: ThreadRPCServer(void*) (bitcoinrpc.cpp:2584)\n==61723==    by 0x8D571: ThreadRPCServer(void*) (bitcoinrpc.cpp:2576)\n==61723==    by 0x8D571: ThreadRPCServer(void*) (bitcoinrpc.cpp:2576)\n==61723== \n==61723== Invalid read of size 1\n==61723==    at 0x140A92: boost::asio::detail::kqueue_reactor::deregister_descriptor(int, boost::asio::detail::kqueue_reactor::descriptor_state*&, bool) (kqueue_reactor.ipp:282)\n==61723==    by 0x147596: boost::asio::detail::reactive_socket_service_base::destroy(boost::asio::detail::reactive_socket_service_base::base_implementation_type&) (reactive_socket_service_base.ipp:87)\n==61723==    by 0x1475F8: boost::asio::stream_socket_service<boost::asio::ip::tcp>::destroy(boost::asio::detail::reactive_socket_service<boost::asio::ip::tcp>::implementation_type&) (stream_socket_service.hpp:119)\n==61723==    by 0x147620: boost::asio::basic_io_object<boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_io_object() (basic_io_object.hpp:124)\n==61723==    by 0x14763C: boost::asio::basic_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_socket() (basic_socket.hpp:1455)\n==61723==    by 0x147658: boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_stream_socket() (basic_stream_socket.hpp:47)\n==61723==    by 0x1477D9: boost::asio::ssl::stream<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> > >::~stream() (stream.hpp:114)\n==61723==    by 0x147882: AcceptedConnectionImpl<boost::asio::ip::tcp>::~AcceptedConnectionImpl() (bitcoinrpc.cpp:2539)\n==61723==    by 0x93F3B: ThreadRPCServer3(void*) (bitcoinrpc.cpp:2879)\n==61723==    by 0x93DE3: ThreadRPCServer3(void*) (bitcoinrpc.cpp:2863)\n==61723==    by 0x93DE3: ThreadRPCServer3(void*) (bitcoinrpc.cpp:2863)\n==61723==    by 0x93DE3: ThreadRPCServer3(void*) (bitcoinrpc.cpp:2863)\n==61723==  Address 0x4a88470 is 80 bytes inside a block of size 84 free'd\n==61723==    at 0x120C477: operator delete(void*) (vg_replace_malloc.c:387)\n==61723==    by 0x11973F: void boost::asio::detail::object_pool_access::destroy<boost::asio::detail::kqueue_reactor::descriptor_state>(boost::asio::detail::kqueue_reactor::descriptor_state*) (object_pool.hpp:41)\n==61723==    by 0x11977A: boost::asio::detail::object_pool<boost::asio::detail::kqueue_reactor::descriptor_state>::destroy_list(boost::asio::detail::kqueue_reactor::descriptor_state*) (object_pool.hpp:131)\n==61723==    by 0x1197BC: boost::asio::detail::object_pool<boost::asio::detail::kqueue_reactor::descriptor_state>::~object_pool() (object_pool.hpp:73)\n==61723==    by 0x13F2E1: boost::asio::detail::kqueue_reactor::~kqueue_reactor() (kqueue_reactor.ipp:59)\n==61723==    by 0xA4EA5: boost::asio::detail::service_registry::destroy(boost::asio::io_service::service*) (service_registry.ipp:101)\n==61723==    by 0x119819: boost::asio::detail::service_registry::~service_registry() (service_registry.ipp:45)\n==61723==    by 0x1198CC: boost::asio::io_service::~io_service() (io_service.ipp:53)\n==61723==    by 0x8C83E: ThreadRPCServer2(void*) (bitcoinrpc.cpp:2782)\n==61723==    by 0x8D5BB: ThreadRPCServer(void*) (bitcoinrpc.cpp:2584)\n==61723==    by 0x8D571: ThreadRPCServer(void*) (bitcoinrpc.cpp:2576)\n==61723==    by 0x8D571: ThreadRPCServer(void*) (bitcoinrpc.cpp:2576)\n==61723== \n==61723== Invalid read of size 4\n==61723==    at 0x1239775: pthread_mutex_unlock (in /usr/lib/libSystem.B.dylib)\n==61723==    by 0x11B124: boost::asio::detail::posix_mutex::unlock() (posix_mutex.hpp:58)\n==61723==    by 0x11B17C: boost::asio::detail::scoped_lock<boost::asio::detail::posix_mutex>::~scoped_lock() (scoped_lock.hpp:44)\n==61723==    by 0x140C99: boost::asio::detail::kqueue_reactor::deregister_descriptor(int, boost::asio::detail::kqueue_reactor::descriptor_state*&, bool) (kqueue_reactor.ipp:319)\n==61723==    by 0x147596: boost::asio::detail::reactive_socket_service_base::destroy(boost::asio::detail::reactive_socket_service_base::base_implementation_type&) (reactive_socket_service_base.ipp:87)\n==61723==    by 0x1475F8: boost::asio::stream_socket_service<boost::asio::ip::tcp>::destroy(boost::asio::detail::reactive_socket_service<boost::asio::ip::tcp>::implementation_type&) (stream_socket_service.hpp:119)\n==61723==    by 0x147620: boost::asio::basic_io_object<boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_io_object() (basic_io_object.hpp:124)\n==61723==    by 0x14763C: boost::asio::basic_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_socket() (basic_socket.hpp:1455)\n==61723==    by 0x147658: boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> >::~basic_stream_socket() (basic_stream_socket.hpp:47)\n==61723==    by 0x1477D9: boost::asio::ssl::stream<boost::asio::basic_stream_socket<boost::asio::ip::tcp, boost::asio::stream_socket_service<boost::asio::ip::tcp> > >::~stream() (stream.hpp:114)\n==61723==    by 0x147882: AcceptedConnectionImpl<boost::asio::ip::tcp>::~AcceptedConnectionImpl() (bitcoinrpc.cpp:2539)\n==61723==    by 0x93F3B: ThreadRPCServer3(void*) (bitcoinrpc.cpp:2879)\n==61723==  Address 0x4a88428 is 8 bytes inside a block of size 84 free'd\n==61723==    at 0x120C477: operator delete(void*) (vg_replace_malloc.c:387)\n==61723==    by 0x11973F: void boost::asio::detail::object_pool_access::destroy<boost::asio::detail::kqueue_reactor::descriptor_state>(boost::asio::detail::kqueue_reactor::descriptor_state*) (object_pool.hpp:41)\n==61723==    by 0x11977A: boost::asio::detail::object_pool<boost::asio::detail::kqueue_reactor::descriptor_state>::destroy_list(boost::asio::detail::kqueue_reactor::descriptor_state*) (object_pool.hpp:131)\n==61723==    by 0x1197BC: boost::asio::detail::object_pool<boost::asio::detail::kqueue_reactor::descriptor_state>::~object_pool() (object_pool.hpp:73)\n==61723==    by 0x13F2E1: boost::asio::detail::kqueue_reactor::~kqueue_reactor() (kqueue_reactor.ipp:59)\n==61723==    by 0xA4EA5: boost::asio::detail::service_registry::destroy(boost::asio::io_service::service*) (service_registry.ipp:101)\n==61723==    by 0x119819: boost::asio::detail::service_registry::~service_registry() (service_registry.ipp:45)\n==61723==    by 0x1198CC: boost::asio::io_service::~io_service() (io_service.ipp:53)\n==61723==    by 0x8C83E: ThreadRPCServer2(void*) (bitcoinrpc.cpp:2782)\n==61723==    by 0x8D5BB: ThreadRPCServer(void*) (bitcoinrpc.cpp:2584)\n==61723==    by 0x8D571: ThreadRPCServer(void*) (bitcoinrpc.cpp:2576)\n==61723==    by 0x8D571: ThreadRPCServer(void*) (bitcoinrpc.cpp:2576)\n```",
   "closed_at" : "2013-05-07T20:14:16Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
      "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
      "followers_url" : "https://api.github.com/users/gavinandresen/followers",
      "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/gavinandresen",
      "id" : 331997,
      "login" : "gavinandresen",
      "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
      "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
      "repos_url" : "https://api.github.com/users/gavinandresen/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/gavinandresen"
   },
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1773/comments",
   "created_at" : "2012-09-01T20:48:50Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1773/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/1773",
   "id" : 6598186,
   "labels" : [
      {
         "color" : "FBBAAB",
         "name" : "Bug",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      },
      {
         "color" : "e10c02",
         "name" : "Priority High",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Priority%20High"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1773/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 1773,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "valgrind errors at shutdown",
   "updated_at" : "2013-05-07T20:14:16Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1773",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
      "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
      "followers_url" : "https://api.github.com/users/gavinandresen/followers",
      "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/gavinandresen",
      "id" : 331997,
      "login" : "gavinandresen",
      "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
      "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
      "repos_url" : "https://api.github.com/users/gavinandresen/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/gavinandresen"
   }
}
