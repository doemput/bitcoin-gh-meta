[
   {
      "body" : "I see that @TheBlueMatt and I managed to make almost the exact same change:\r\n2a278cdaf6ea46dc85a61a37a12a8acd7acd5670 vs a5032b5b0c55c90a8e4df658d85d99824cf4699d. I'm happy to rebase and drop mine if his goes in first.\r\n\r\nEdit: I should also mention that this and #9715 are complementary.",
      "created_at" : "2017-02-08T07:03:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#issuecomment-278245944",
      "id" : 278245944,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9720",
      "updated_at" : "2017-02-08T07:05:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/278245944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "What is the risk by not merging this?",
      "created_at" : "2017-02-08T10:39:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#issuecomment-278292537",
      "id" : 278292537,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9720",
      "updated_at" : "2017-02-08T10:39:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/278292537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "Concept ACK, will give this a more full review after breakfast.\n\nOn February 8, 2017 1:46:00 AM EST, Cory Fields <notifications@github.com> wrote:\n>This is the last of my net issues for 0.14. As discussed with\n>@TheBlueMatt and @gmaxwell.\n>\n>Fixes for a few problems discovered while running a network\n>stress/fuzzer:\n>- Remote nodes weren't always banned when they hadn't yet sent a\n>verack. Regression from 7a8c2519015650acd51eaf42719f04e53f839bbe.\n>- Require a verack before sending any non-handshake messages. This is\n>much more straightforward behavior, and allows for tests to be easily\n>written\n>- Now that there's a sane model for testing, add checks for leaky\n>messages sent out before the handshake is complete, as well as for\n>banning in those cases.\n>You can view, comment on, or merge this pull request online at:\n>\n>  https://github.com/bitcoin/bitcoin/pull/9720\n>\n>-- Commit Summary --\n>\n>  * net: correctly ban before the handshake is complete\n>  * net: parse reject earlier\n>  * net: require a verack before responding to anything else\n>  * qa: allow for a node that does not send an initial version message\n>  * qa: add a test to detect leaky p2p messages\n>\n>-- File Changes --\n>\n>    M qa/pull-tester/rpc-tests.py (1)\n>    A qa/rpc-tests/p2p-leaktests.py (135)\n>    M qa/rpc-tests/test_framework/mininode.py (21)\n>    M src/net_processing.cpp (115)\n>\n>-- Patch Links --\n>\n>https://github.com/bitcoin/bitcoin/pull/9720.patch\n>https://github.com/bitcoin/bitcoin/pull/9720.diff\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9720\n",
      "created_at" : "2017-02-08T14:02:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#issuecomment-278336444",
      "id" : 278336444,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9720",
      "updated_at" : "2017-02-08T14:02:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/278336444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100094218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100094218"
         }
      },
      "body" : "mind putting braces around this?",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-08T15:40:50Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)\n+{\n+    AssertLockHeld(cs_main);\n+    CNodeState &state = *State(pnode->GetId());\n+\n+    BOOST_FOREACH(const CBlockReject& reject, state.rejects)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100094218",
      "id" : 100094218,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 20789251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100094218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100097401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100097401"
         }
      },
      "body" : "nit: The name makes me think `true` means `fShouldBan` was set to true. Invert the boolean?",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-08T15:52:03Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100097401",
      "id" : 100097401,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 20789251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100097401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "I got a few questions about these changes, so I've updated the commit messages to provide (I hope) better back-story/context.",
      "created_at" : "2017-02-08T16:32:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#issuecomment-278380156",
      "id" : 278380156,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9720",
      "updated_at" : "2017-02-08T16:32:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/278380156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100110045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100110045"
         }
      },
      "body" : "Heh, i waffled back and forth on this. Sure.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-08T16:37:52Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100110045",
      "id" : 100110045,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 20805665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100110045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100110096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100110096"
         }
      },
      "body" : "Will do.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-08T16:38:03Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)\n+{\n+    AssertLockHeld(cs_main);\n+    CNodeState &state = *State(pnode->GetId());\n+\n+    BOOST_FOREACH(const CBlockReject& reject, state.rejects)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100110096",
      "id" : 100110096,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 20805720,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100110096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100111274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100111274"
         }
      },
      "body" : "The usual fix for waffling is comment and clarify name :p",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-08T16:42:54Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100111274",
      "id" : 100111274,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 20806985,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100111274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100255289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100255289"
         }
      },
      "body" : "Nit: avoid `BOOST_FOREACH` if possible (though this was moved code, so perhaps not applicable, but..).\r\n```C++\r\nfor (const CBlockReject& reject : state.rejects) [...]\r\n```",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-09T08:51:19Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)\n+{\n+    AssertLockHeld(cs_main);\n+    CNodeState &state = *State(pnode->GetId());\n+\n+    BOOST_FOREACH(const CBlockReject& reject, state.rejects)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100255289",
      "id" : 100255289,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 20954540,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100255289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/250224?v=3",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100273335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100273335"
         }
      },
      "body" : "No, for moved code this is not applicable. To avoid confusion, let's keep code style changes, moves and bugfixes separate where possible.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-09T10:17:43Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)\n+{\n+    AssertLockHeld(cs_main);\n+    CNodeState &state = *State(pnode->GetId());\n+\n+    BOOST_FOREACH(const CBlockReject& reject, state.rejects)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100273335",
      "id" : 100273335,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 20973291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100273335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100352357"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100352357"
         }
      },
      "body" : "There are a few cases it looks like we return true after setting misbehaving, so this probably needs to be checked either way (or those cases need updating - but that might result in double-logging).",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-09T16:49:18Z",
      "diff_hunk" : "@@ -2706,8 +2735,11 @@ bool ProcessMessages(CNode* pfrom, CConnman& connman, const std::atomic<bool>& i\n             PrintExceptionContinue(NULL, \"ProcessMessages()\");\n         }\n \n-        if (!fRet)\n+        if (!fRet) {\n             LogPrintf(\"%s(%s, %u bytes) FAILED peer=%d\\n\", __func__, SanitizeString(strCommand), nMessageSize, pfrom->id);\n+            LOCK(cs_main);\n+            SendRejectsAndCheckBan(pfrom, connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100352357",
      "id" : 100352357,
      "original_commit_id" : "f9829821a2ac4cacd939d39607dbfd419d8e449a",
      "original_position" : 44,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 21058137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100352357",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100362538"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100362538"
         }
      },
      "body" : "I was trying to avoid the cs_main lock for each message received, but you're right that it means that we rely on a return value that's not very well-defined.\r\n\r\nI'll just make it unconditional. Until we have parallel processing, there's not much harm in that.\r\n\r\n",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-09T17:30:01Z",
      "diff_hunk" : "@@ -2706,8 +2735,11 @@ bool ProcessMessages(CNode* pfrom, CConnman& connman, const std::atomic<bool>& i\n             PrintExceptionContinue(NULL, \"ProcessMessages()\");\n         }\n \n-        if (!fRet)\n+        if (!fRet) {\n             LogPrintf(\"%s(%s, %u bytes) FAILED peer=%d\\n\", __func__, SanitizeString(strCommand), nMessageSize, pfrom->id);\n+            LOCK(cs_main);\n+            SendRejectsAndCheckBan(pfrom, connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100362538",
      "id" : 100362538,
      "original_commit_id" : "f9829821a2ac4cacd939d39607dbfd419d8e449a",
      "original_position" : 44,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 21068804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100362538",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100363468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100363468"
         }
      },
      "body" : "Sounds good.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-09T17:34:00Z",
      "diff_hunk" : "@@ -2706,8 +2735,11 @@ bool ProcessMessages(CNode* pfrom, CConnman& connman, const std::atomic<bool>& i\n             PrintExceptionContinue(NULL, \"ProcessMessages()\");\n         }\n \n-        if (!fRet)\n+        if (!fRet) {\n             LogPrintf(\"%s(%s, %u bytes) FAILED peer=%d\\n\", __func__, SanitizeString(strCommand), nMessageSize, pfrom->id);\n+            LOCK(cs_main);\n+            SendRejectsAndCheckBan(pfrom, connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100363468",
      "id" : 100363468,
      "original_commit_id" : "f9829821a2ac4cacd939d39607dbfd419d8e449a",
      "original_position" : 44,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 21069797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100363468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "utACK df1a32392933a4f716c53d62703a56e8d8bda9da, did not review tests.",
      "created_at" : "2017-02-10T16:29:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#issuecomment-278991391",
      "id" : 278991391,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9720",
      "updated_at" : "2017-02-10T16:29:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/278991391",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100650705"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100650705"
         }
      },
      "body" : "You can remove this. logging isn't being used.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:27:56Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100650705",
      "id" : 100650705,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 9,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100650705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100650721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100650721"
         }
      },
      "body" : "Please add a docstring describing what this test case is doing.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:28:13Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100650721",
      "id" : 100650721,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 4,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : 4,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100650721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100650771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100650771"
         }
      },
      "body" : "I'm not entirely sure what this is achieving. I think you can remove `check()` and `self.done` entirely.\r\n\r\nYou can check directly that no unexpected messages have been received at the end of the test (see my comment below).",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:28:59Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100650771",
      "id" : 100650771,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 24,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100650771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100650829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100650829"
         }
      },
      "body" : "Is `unexpected_message` a better name than `unrequested_message`?",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:29:45Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100650829",
      "id" : 100650829,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 30,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100650829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100650892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100650892"
         }
      },
      "body" : "I don't think you should be raising an exception in the network thread. Just set `unexpected_message` to True (and optionally print some debug info)",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:30:42Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100650892",
      "id" : 100650892,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 31,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100650892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651222"
         }
      },
      "body" : "Sigh. This is verbose and will be incomplete every time new p2p message types are added.\r\n\r\nI was tempted to say just override the `deliver()` message from `NodeConnCB` but that just feels ugly (`deliver()` should really be a private method and the testcases just override use the on_ callbacks).\r\n\r\nI can't think of anything better here.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:34:29Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651222",
      "id" : 100651222,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 54,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : 63,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651262"
         }
      },
      "body" : "s/replay/reply",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:34:58Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651262",
      "id" : 100651262,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 83,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651298"
         }
      },
      "body" : "I don't think this parser.add_option line is required.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:35:30Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651298",
      "id" : 100651298,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 95,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651327"
         }
      },
      "body" : "Since banscore isn't changing I'd prefer to make it a global constant.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:35:54Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651327",
      "id" : 100651327,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 100,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651535"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651535"
         }
      },
      "body" : "There's only one node here. You can replace the above three lines with:\r\n\r\n```python\r\nself.nodes = [start_node(0, self.options.tmpdir, ['-debug', '-banscore='+str(self.banscore)])]\r\n```\r\n",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:38:10Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10\n+    def setup_network(self):\n+        extra_args = [['-debug', '-banscore='+str(self.banscore)]\n+                      for i in range(self.num_nodes)]\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, extra_args)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651535",
      "id" : 100651535,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 104,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651535",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651563"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651563"
         }
      },
      "body" : "not needed?",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:38:26Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10\n+    def setup_network(self):\n+        extra_args = [['-debug', '-banscore='+str(self.banscore)]\n+                      for i in range(self.num_nodes)]\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, extra_args)\n+\n+    def run_test(self):\n+        no_version_bannode = CNodeNoVersionBan()\n+        no_version_idlenode = CNodeNoVersionIdle()\n+        no_verack_idlenode = CNodeNoVerackIdle()\n+\n+        connections = []\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_bannode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_idlenode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_verack_idlenode))\n+        no_version_bannode.add_connection(connections[0])\n+        no_version_idlenode.add_connection(connections[1])\n+        no_verack_idlenode.add_connection(connections[2])\n+\n+        NetworkThread().start()  # Start up network handling in another thread\n+        self.nodes[0].generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651563",
      "id" : 100651563,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 120,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651563",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651676"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651676"
         }
      },
      "body" : "Might as well just check the variable directly:\r\n\r\n```python\r\n        assert(not no_version_bannode.unexpected_message)\r\n        assert(not no_version_idlenode.unexpected_message)\r\n        assert(not no_verack_idlenode.unexpected_message)\r\n```",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:39:51Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10\n+    def setup_network(self):\n+        extra_args = [['-debug', '-banscore='+str(self.banscore)]\n+                      for i in range(self.num_nodes)]\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, extra_args)\n+\n+    def run_test(self):\n+        no_version_bannode = CNodeNoVersionBan()\n+        no_version_idlenode = CNodeNoVersionIdle()\n+        no_verack_idlenode = CNodeNoVerackIdle()\n+\n+        connections = []\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_bannode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_idlenode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_verack_idlenode))\n+        no_version_bannode.add_connection(connections[0])\n+        no_version_idlenode.add_connection(connections[1])\n+        no_verack_idlenode.add_connection(connections[2])\n+\n+        NetworkThread().start()  # Start up network handling in another thread\n+        self.nodes[0].generate(1)\n+\n+        # send a bunch of veracks without sending a message. This should get us disconnected.\n+        # NOTE: implementation-specific check here. Remove if bitcoind ban behavior changes\n+        for i in range(self.banscore):\n+            no_version_bannode.send_message(msg_verack())\n+\n+        #Give the node enough time to possibly leak out a message\n+        time.sleep(5)\n+\n+        assert(no_version_bannode.check())\n+        assert(no_version_idlenode.check())\n+        assert(no_verack_idlenode.check())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651676",
      "id" : 100651676,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 132,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651676",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651750"
         }
      },
      "body" : "I recommend you disconnect all the connections to the node at the end of the test:\r\n\r\n```python\r\n        # Disconnect all peers\r\n        [conn.disconnect_node() for conn in connections]\r\n```",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T00:40:38Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10\n+    def setup_network(self):\n+        extra_args = [['-debug', '-banscore='+str(self.banscore)]\n+                      for i in range(self.num_nodes)]\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, extra_args)\n+\n+    def run_test(self):\n+        no_version_bannode = CNodeNoVersionBan()\n+        no_version_idlenode = CNodeNoVersionIdle()\n+        no_verack_idlenode = CNodeNoVerackIdle()\n+\n+        connections = []\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_bannode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_idlenode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_verack_idlenode))\n+        no_version_bannode.add_connection(connections[0])\n+        no_version_idlenode.add_connection(connections[1])\n+        no_verack_idlenode.add_connection(connections[2])\n+\n+        NetworkThread().start()  # Start up network handling in another thread\n+        self.nodes[0].generate(1)\n+\n+        # send a bunch of veracks without sending a message. This should get us disconnected.\n+        # NOTE: implementation-specific check here. Remove if bitcoind ban behavior changes\n+        for i in range(self.banscore):\n+            no_version_bannode.send_message(msg_verack())\n+\n+        #Give the node enough time to possibly leak out a message\n+        time.sleep(5)\n+\n+        assert(no_version_bannode.check())\n+        assert(no_version_idlenode.check())\n+        assert(no_verack_idlenode.check())\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100651750",
      "id" : 100651750,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 133,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21369796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100651750",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100657808"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100657808"
         }
      },
      "body" : "ok",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:39:45Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100657808",
      "id" : 100657808,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 4,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : 4,
      "pull_request_review_id" : 21376798,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100657808",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100657810"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100657810"
         }
      },
      "body" : "ok",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:39:50Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100657810",
      "id" : 100657810,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 9,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21376799,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100657810",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100657827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100657827"
         }
      },
      "body" : "seems about the same to me, but sure",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:40:36Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100657827",
      "id" : 100657827,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 30,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21376814,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100657827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100657832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100657832"
         }
      },
      "body" : "ok",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:40:50Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100657832",
      "id" : 100657832,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 31,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21376819,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100657832",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658037"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658037"
         }
      },
      "body" : "yes, i hate this too.\r\n\r\nToo much to do here but for the future: how about a base class for messages. Then there's an overridable dispatcher that forwards to the individual callbacks. So here, I would just override the dispatcher and check the message type.\r\n\r\nBasically just another thin layer under deliver()",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:49:33Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658037",
      "id" : 100658037,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 54,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : 63,
      "pull_request_review_id" : 21377009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658037",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658042"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658042"
         }
      },
      "body" : "ok",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:49:38Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658042",
      "id" : 100658042,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 83,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21377015,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658052"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658052"
         }
      },
      "body" : "ok. Definitely the c/p from the wrong test isn't needed :)",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:50:06Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658052",
      "id" : 100658052,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 95,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21377030,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658067"
         }
      },
      "body" : "I think i'd rather keep this local so that we can use different scores for different tests.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:50:49Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658067",
      "id" : 100658067,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 100,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21377045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658069"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658069"
         }
      },
      "body" : "ok",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:50:55Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10\n+    def setup_network(self):\n+        extra_args = [['-debug', '-banscore='+str(self.banscore)]\n+                      for i in range(self.num_nodes)]\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, extra_args)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658069",
      "id" : 100658069,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 104,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21377047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658069",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658088"
         }
      },
      "body" : "Very needed, but needs a comment. We generate a block, and wait a few secs to make sure that it's not relayed to the nodes who haven't versioned/veracked yet.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:51:36Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10\n+    def setup_network(self):\n+        extra_args = [['-debug', '-banscore='+str(self.banscore)]\n+                      for i in range(self.num_nodes)]\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, extra_args)\n+\n+    def run_test(self):\n+        no_version_bannode = CNodeNoVersionBan()\n+        no_version_idlenode = CNodeNoVersionIdle()\n+        no_verack_idlenode = CNodeNoVerackIdle()\n+\n+        connections = []\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_bannode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_idlenode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_verack_idlenode))\n+        no_version_bannode.add_connection(connections[0])\n+        no_version_idlenode.add_connection(connections[1])\n+        no_verack_idlenode.add_connection(connections[2])\n+\n+        NetworkThread().start()  # Start up network handling in another thread\n+        self.nodes[0].generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658088",
      "id" : 100658088,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 120,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21377066,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658096"
         }
      },
      "body" : "ok",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:52:04Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10\n+    def setup_network(self):\n+        extra_args = [['-debug', '-banscore='+str(self.banscore)]\n+                      for i in range(self.num_nodes)]\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, extra_args)\n+\n+    def run_test(self):\n+        no_version_bannode = CNodeNoVersionBan()\n+        no_version_idlenode = CNodeNoVersionIdle()\n+        no_verack_idlenode = CNodeNoVerackIdle()\n+\n+        connections = []\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_bannode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_idlenode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_verack_idlenode))\n+        no_version_bannode.add_connection(connections[0])\n+        no_version_idlenode.add_connection(connections[1])\n+        no_verack_idlenode.add_connection(connections[2])\n+\n+        NetworkThread().start()  # Start up network handling in another thread\n+        self.nodes[0].generate(1)\n+\n+        # send a bunch of veracks without sending a message. This should get us disconnected.\n+        # NOTE: implementation-specific check here. Remove if bitcoind ban behavior changes\n+        for i in range(self.banscore):\n+            no_version_bannode.send_message(msg_verack())\n+\n+        #Give the node enough time to possibly leak out a message\n+        time.sleep(5)\n+\n+        assert(no_version_bannode.check())\n+        assert(no_version_idlenode.check())\n+        assert(no_verack_idlenode.check())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658096",
      "id" : 100658096,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 132,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21377074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658103"
         }
      },
      "body" : "ok",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-11T02:52:20Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10\n+    def setup_network(self):\n+        extra_args = [['-debug', '-banscore='+str(self.banscore)]\n+                      for i in range(self.num_nodes)]\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, extra_args)\n+\n+    def run_test(self):\n+        no_version_bannode = CNodeNoVersionBan()\n+        no_version_idlenode = CNodeNoVersionIdle()\n+        no_verack_idlenode = CNodeNoVerackIdle()\n+\n+        connections = []\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_bannode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_version_idlenode, send_version=False))\n+        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], no_verack_idlenode))\n+        no_version_bannode.add_connection(connections[0])\n+        no_version_idlenode.add_connection(connections[1])\n+        no_verack_idlenode.add_connection(connections[2])\n+\n+        NetworkThread().start()  # Start up network handling in another thread\n+        self.nodes[0].generate(1)\n+\n+        # send a bunch of veracks without sending a message. This should get us disconnected.\n+        # NOTE: implementation-specific check here. Remove if bitcoind ban behavior changes\n+        for i in range(self.banscore):\n+            no_version_bannode.send_message(msg_verack())\n+\n+        #Give the node enough time to possibly leak out a message\n+        time.sleep(5)\n+\n+        assert(no_version_bannode.check())\n+        assert(no_version_idlenode.check())\n+        assert(no_verack_idlenode.check())\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100658103",
      "id" : 100658103,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 133,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21377081,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100658103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@jnewbery Thanks for the great test review. I'm not sure I'll have time to get to this before Sunday, so let's not let it hold back merge if a few more ACKs come in. I'll for sure fix up the tests post-merge if that's the case.",
      "created_at" : "2017-02-11T02:54:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#issuecomment-279115917",
      "id" : 279115917,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9720",
      "updated_at" : "2017-02-11T02:54:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/279115917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100804852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100804852"
         }
      },
      "body" : "Please leave it as is for now. My goal was to generalize this logic and get rid of most `setup_network` methods in test as the only thing they commonly do is fire up the requested number of nodes and nothing else. So there would be no need to overwrite this function if you want a simple network set up.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-13T14:31:58Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10\n+    def setup_network(self):\n+        extra_args = [['-debug', '-banscore='+str(self.banscore)]\n+                      for i in range(self.num_nodes)]\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, extra_args)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100804852",
      "id" : 100804852,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 104,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21519641,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100804852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100805420"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100805420"
         }
      },
      "body" : "Also, it would be easier to adapt if the number of nodes changes.",
      "commit_id" : "d9434918d277bba534933ebc8c63ba81e613f603",
      "created_at" : "2017-02-13T14:34:29Z",
      "diff_hunk" : "@@ -0,0 +1,135 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.mininode import *\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import logging\n+\n+class CLazyNode(NodeConnCB):\n+    def __init__(self):\n+        NodeConnCB.__init__(self)\n+        self.connection = None\n+        self.done = False\n+        self.unrequested_msg = False\n+\n+    def add_connection(self, conn):\n+        self.connection = conn\n+\n+    def check(self):\n+        def done():\n+            return self.done\n+        return wait_until(done, timeout=10) and not self.unrequested_msg\n+\n+    def send_message(self, message):\n+        self.connection.send_message(message)\n+\n+    def bad_message(self, message):\n+        self.unrequested_msg = True\n+        raise Exception(\"should not have received message: %s\" % message.command)\n+\n+    def on_version(self, conn, message): self.bad_message(message)\n+    def on_verack(self, conn, message): self.bad_message(message)\n+    def on_reject(self, conn, message): self.bad_message(message)\n+    def on_inv(self, conn, message): self.bad_message(message)\n+    def on_addr(self, conn, message): self.bad_message(message)\n+    def on_alert(self, conn, message): self.bad_message(message)\n+    def on_getdata(self, conn, message): self.bad_message(message)\n+    def on_getblocks(self, conn, message): self.bad_message(message)\n+    def on_tx(self, conn, message): self.bad_message(message)\n+    def on_block(self, conn, message): self.bad_message(message)\n+    def on_getaddr(self, conn, message): self.bad_message(message)\n+    def on_headers(self, conn, message): self.bad_message(message)\n+    def on_getheaders(self, conn, message): self.bad_message(message)\n+    def on_ping(self, conn, message): self.bad_message(message)\n+    def on_mempool(self, conn): self.bad_message(message)\n+    def on_pong(self, conn, message): self.bad_message(message)\n+    def on_feefilter(self, conn, message): self.bad_message(message)\n+    def on_sendheaders(self, conn, message): self.bad_message(message)\n+    def on_sendcmpct(self, conn, message): self.bad_message(message)\n+    def on_cmpctblock(self, conn, message): self.bad_message(message)\n+    def on_getblocktxn(self, conn, message): self.bad_message(message)\n+    def on_blocktxn(self, conn, message): self.bad_message(message)\n+\n+\n+# Node that never sends a version. We'll use this to send a bunch of messages\n+# anyway, and eventually get disconnected.\n+class CNodeNoVersionBan(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_close(self, conn):\n+        self.done = True\n+    def on_reject(self, conn, message): pass\n+\n+\n+# Node that never sends a version. This one just sits idle and hopes to receive\n+# any message (it shouldn't!)\n+class CNodeNoVersionIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+        self.done = True\n+\n+# Node that sends a version but not a verack.\n+class CNodeNoVerackIdle(CLazyNode):\n+    def __init__(self):\n+        CLazyNode.__init__(self)\n+\n+    def on_reject(self, conn, message): pass\n+    def on_verack(self, conn, message): pass\n+\n+    # When version is received, don't replay with a verack. Instead, see if the\n+    # node will give us a message that it shouldn't. This is not an exhaustive\n+    # list!\n+    def on_version(self, conn, message):\n+        self.done = True\n+        conn.send_message(msg_ping())\n+        conn.send_message(msg_getaddr())\n+\n+class P2PLeakTest(BitcoinTestFramework):\n+    def add_options(self, parser):\n+        parser.add_option(\"--testbinary\", dest=\"testbinary\",\n+                          default=os.getenv(\"BITCOIND\", \"bitcoind\"),\n+                          help=\"Binary to test max block requests behavior\")\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.num_nodes = 1\n+        self.banscore = 10\n+    def setup_network(self):\n+        extra_args = [['-debug', '-banscore='+str(self.banscore)]\n+                      for i in range(self.num_nodes)]\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, extra_args)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100805420",
      "id" : 100805420,
      "original_commit_id" : "df1a32392933a4f716c53d62703a56e8d8bda9da",
      "original_position" : 104,
      "path" : "qa/rpc-tests/p2p-leaktests.py",
      "position" : null,
      "pull_request_review_id" : 21520213,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-14T00:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100805420",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "body" : "Fixed up the tests and squashed. Only the tests changed, the bitcoin code is exactly the same as before squash. I've archived the old branch here: https://github.com/theuni/bitcoin/commits/fix-ban2 in case anyone wants to compare.\r\n\r\nI replaced my mininode changes with @TheBlueMatt's commits from #9715, so that these won't conflict with eachother.",
      "created_at" : "2017-02-14T00:40:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#issuecomment-279570639",
      "id" : 279570639,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9720",
      "updated_at" : "2017-02-14T00:40:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/279570639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
