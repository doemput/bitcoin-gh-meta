[
   {
      "body" : "Thanks for trying to address this issue; I agree it is suboptimal that we could be in a situation where we're requesting the same headers from the same peer, multiple times.\r\n\r\nHowever, I believe that sending a getheaders when a new block is announced is currently the only protection a node has against having chosen a bad peer for its initial headers sync.  That is, if the peer a node chooses for initial headers sync never responds to the getheaders message, or never sends headers to get it caught up enough to start sending getheaders messages to other peers, the node will never sync up with the network.\r\n\r\nSo my initial reaction is that this is perhaps not the best approach.  I'd be inclined to solve this by trying to keep better per-node state (like time of last getheaders message to try avoiding multiple getheaders messages in flight to the same peer, and if a headers message comes back that doesn't include some announced block and isn't full then we could send another getheaders message, etc).  Definitely some edge cases here that need thought...",
      "created_at" : "2015-10-13T20:09:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6821#issuecomment-147837945",
      "id" : 147837945,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6821",
      "updated_at" : "2015-10-13T20:09:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/147837945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "I thought about doing something like this per-node as well; but in that case, couldn't the peer still start one redundant \"getheaders request chain\" per peer when it receives inv messages?  This still seems like a lot of waste.\r\n\r\nI understand your point about selecting a bad peer, though.  My impression, however, is that this is only a related but otherwise independent issue; no?  In that case, wouldn't it make more sense to introduce a \"timeout\" after which the node chooses a different peer for requesting headers?  This would solve the issue at the root (and is somehow similar to the current protection with inv messages, except that it would be more predictable and less hackish).",
      "created_at" : "2015-10-14T05:18:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6821#issuecomment-147937469",
      "id" : 147937469,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6821",
      "updated_at" : "2015-10-14T05:18:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/147937469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4943644?v=3",
         "events_url" : "https://api.github.com/users/domob1812/events{/privacy}",
         "followers_url" : "https://api.github.com/users/domob1812/followers",
         "following_url" : "https://api.github.com/users/domob1812/following{/other_user}",
         "gists_url" : "https://api.github.com/users/domob1812/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/domob1812",
         "id" : 4943644,
         "login" : "domob1812",
         "organizations_url" : "https://api.github.com/users/domob1812/orgs",
         "received_events_url" : "https://api.github.com/users/domob1812/received_events",
         "repos_url" : "https://api.github.com/users/domob1812/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/domob1812/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/domob1812/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/domob1812"
      }
   },
   {
      "body" : "I don't think there's agreement on this, and development seems to be stuck. @sdaftuar @domob1812 how to proceed here?",
      "created_at" : "2016-04-19T08:46:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6821#issuecomment-211804009",
      "id" : 211804009,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6821",
      "updated_at" : "2016-04-19T08:46:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/211804009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I think that this issue should be resolved - while it usually is not a big problem for Bitcoin, it is simply wrong (and could lead to instability) to send duplicate getheaders requests.  I think (obviously) that my patch improves the situation, but if there is a better solution, I'm all in favour of it as well.",
      "created_at" : "2016-04-19T17:18:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6821#issuecomment-212024169",
      "id" : 212024169,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6821",
      "updated_at" : "2016-04-19T17:18:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/212024169",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4943644?v=3",
         "events_url" : "https://api.github.com/users/domob1812/events{/privacy}",
         "followers_url" : "https://api.github.com/users/domob1812/followers",
         "following_url" : "https://api.github.com/users/domob1812/following{/other_user}",
         "gists_url" : "https://api.github.com/users/domob1812/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/domob1812",
         "id" : 4943644,
         "login" : "domob1812",
         "organizations_url" : "https://api.github.com/users/domob1812/orgs",
         "received_events_url" : "https://api.github.com/users/domob1812/received_events",
         "repos_url" : "https://api.github.com/users/domob1812/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/domob1812/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/domob1812/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/domob1812"
      }
   },
   {
      "body" : "No objection to solving the underlying issue, but I don't think we should adopt the approach taken in this PR.  This is a relatively minor problem (triggered only when your sync peer announces a new block during initial headers synchronization), and I don't think it makes sense to patch up a minor problem in a way that could create new problems.  In addition to opening up a node to never syncing up with the network if a bad initial sync peer is chosen as I mentioned above, I think this PR has other issues as well, such as this:  \r\n\r\nImagine you have a `getheaders` message in flight to your sync peer (so `fInitialHeadersSync` is true) and a new block is announced.  At the time you receive the inv, you don't know whether your peer will process your earlier `getheaders` message before or after updating its own tip to include the new block; thus you have no way of knowing whether you need to issue another `getheaders` request when processing the inv to get the header for the newly announced block.\r\n\r\nThe existing behavior would just send the `getheaders` message anyway, which ensures we eventually receive it, at the risk of receiving duplicate data.  This PR would not send that `getheaders` message, so it is entirely possible -- if the subsequent headers response is not full -- that we would then never end up receiving the headers for the newly inv'ed block, and thus not request it (until a subsequent block is announced that builds on top of it).\r\n\r\nI think any attempt to solve the issue here needs to be done more carefully, in a way that doesn't introduce new bugs (perhaps by trying an approach along the lines of what I wrote before about keeping more per-peer state).",
      "created_at" : "2016-04-19T23:57:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6821#issuecomment-212177582",
      "id" : 212177582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6821",
      "updated_at" : "2016-04-19T23:57:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/212177582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Closing this PR, then. I agree it would be nice if this is fixed, but seems too minor an issue to need a quick fix that potentially breaks syncing.",
      "created_at" : "2016-04-25T09:47:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6821#issuecomment-214238262",
      "id" : 214238262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6821",
      "updated_at" : "2016-04-25T09:47:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/214238262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
