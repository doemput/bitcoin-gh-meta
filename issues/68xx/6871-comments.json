[
   {
      "body" : "Feedback I heard from wallet vendors previously was that FSS was burdensome (needed extra txins, and so less useful).",
      "created_at" : "2015-10-22T22:13:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-150370804",
      "id" : 150370804,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-22T22:13:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150370804",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell Same feedback I've heard too.",
      "created_at" : "2015-10-22T22:16:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-150371262",
      "id" : 150371262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-22T22:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150371262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Concept ACK. ",
      "created_at" : "2015-10-22T22:48:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-150377435",
      "id" : 150377435,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-22T22:48:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150377435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "body" : "concept ACK",
      "created_at" : "2015-10-22T22:50:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-150377726",
      "id" : 150377726,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-22T22:50:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150377726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "How does this work with CPFP, and descendent transactions (e.g a chained transaction that could have its based replaced?)",
      "created_at" : "2015-10-22T22:50:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-150377871",
      "id" : 150377871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-22T22:51:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150377871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "@dcousens What do you mean \"how does this work\" with CPFP? CPFP isn't implemented in Bitcoin Core, so there's nothing to affect.\r\n\r\nNow, when replacing a tx with children, the fees and size of all children are taken into account before deciding to replace or not.",
      "created_at" : "2015-10-22T22:59:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-150379108",
      "id" : 150379108,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-22T22:59:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150379108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "> @dcousens What do you mean \"how does this work\" with CPFP? CPFP isn't implemented in Bitcoin Core, so there's nothing to affect.\r\n\r\nI meant conceptually, sorry.  CPFP is something that was on the roadmap AFAIK?\r\n\r\n> all children are taken into account before deciding to replace or not.\r\n\r\nBy taken into account, do you mean that you have to have a higher fee than all subsequent children to replace?",
      "created_at" : "2015-10-22T23:02:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-150379560",
      "id" : 150379560,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-22T23:04:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150379560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "> By taken into account, do you mean that you have to have a higher fee than all subsequent children?\r\n\r\nYes.\r\n\r\nOnly extremely sophisticated CPFP that does relaying of whole packages of transactions based on fees paid by children is affected by RBF, and no-one has any plans to actually implement that yet.",
      "created_at" : "2015-10-22T23:05:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-150379993",
      "id" : 150379993,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-22T23:05:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150379993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Concept ACK",
      "created_at" : "2015-10-23T06:51:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-150491410",
      "id" : 150491410,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-23T06:51:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150491410",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5269298?v=3",
         "events_url" : "https://api.github.com/users/greenaddress/events{/privacy}",
         "followers_url" : "https://api.github.com/users/greenaddress/followers",
         "following_url" : "https://api.github.com/users/greenaddress/following{/other_user}",
         "gists_url" : "https://api.github.com/users/greenaddress/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/greenaddress",
         "id" : 5269298,
         "login" : "greenaddress",
         "organizations_url" : "https://api.github.com/users/greenaddress/orgs",
         "received_events_url" : "https://api.github.com/users/greenaddress/received_events",
         "repos_url" : "https://api.github.com/users/greenaddress/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/greenaddress/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/greenaddress/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/greenaddress"
      }
   },
   {
      "body" : "concept ACK",
      "created_at" : "2015-10-23T09:24:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-150526220",
      "id" : 150526220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-23T09:24:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150526220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649160?v=3",
         "events_url" : "https://api.github.com/users/rubensayshi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rubensayshi/followers",
         "following_url" : "https://api.github.com/users/rubensayshi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rubensayshi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rubensayshi",
         "id" : 649160,
         "login" : "rubensayshi",
         "organizations_url" : "https://api.github.com/users/rubensayshi/orgs",
         "received_events_url" : "https://api.github.com/users/rubensayshi/received_events",
         "repos_url" : "https://api.github.com/users/rubensayshi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rubensayshi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rubensayshi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rubensayshi"
      }
   },
   {
      "body" : "Concept ACK",
      "created_at" : "2015-10-23T11:28:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-150548182",
      "id" : 150548182,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-23T11:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150548182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r42913338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42913338"
         }
      },
      "body" : "I'm not sure this comparison makes sense. The existence of a low-fee-rate descendant doesn't make a transaction worse for miners, but it would cause the feerate to look worse in this comparison.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-23T20:55:39Z",
      "diff_hunk" : "@@ -932,6 +959,85 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather\n+        // than the ones it replaces.\n+        CAmount nConflictingFees = 0;\n+        size_t nConflictingSize = 0;\n+        if (setConflicts.size())\n+        {\n+            LOCK(pool.cs);\n+\n+            // Check if it's economically rational to mine this transaction\n+            // rather than the ones it replaces. For efficiency we simply sum\n+            // up the pre-calculated fees/size-with-descendants values from the\n+            // mempool package tracking; this does mean the pathological case\n+            // of diamond tx graphs will be overcounted.\n+            BOOST_FOREACH(const uint256 hashConflicting, setConflicts)\n+            {\n+                CTxMemPool::txiter mi = pool.mapTx.find(hashConflicting);\n+                if (mi == pool.mapTx.end())\n+                    continue;\n+                nConflictingFees += mi->GetFeesWithDescendants();\n+                nConflictingSize += mi->GetSizeWithDescendants();\n+            }\n+\n+            // Replace?\n+            //\n+            // First of all we can't allow a replacement unless it pays greater\n+            // fees than the transactions it conflicts with - if we did the\n+            // bandwidth used by those conflicting transactions would not be\n+            // paid for\n+            if (nFees < nConflictingFees)\n+            {\n+                return state.DoS(0, error(\"AcceptToMemoryPool: rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n+                                          hash.ToString(), FormatMoney(nFees), FormatMoney(nConflictingFees)),\n+                                 REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+\n+            // Secondly in addition to paying more fees than the conflicts the\n+            // new transaction must additionally pay for its own bandwidth.\n+            CAmount nDeltaFees = nFees - nConflictingFees;\n+            if (nDeltaFees < ::minRelayTxFee.GetFee(nSize))\n+            {\n+                return state.DoS(0,\n+                        error(\"AcceptToMemoryPool: rejecting replacement %s, not enough additional fees to relay; %s < %s\",\n+                              hash.ToString(),\n+                              FormatMoney(nDeltaFees),\n+                              FormatMoney(::minRelayTxFee.GetFee(nSize))),\n+                        REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+\n+            // Finally replace only if we end up with a larger fees-per-kb than\n+            // the replacements.\n+            CFeeRate oldFeeRate(nConflictingFees, nConflictingSize);\n+            CFeeRate newFeeRate(nFees, nSize);\n+            if (newFeeRate <= oldFeeRate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r42913338",
      "id" : 42913338,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 120,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42913338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r42923364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42923364"
         }
      },
      "body" : "So, you mean the scenario where we have a high fee-rate transaction that is spent by one or more low fee-rate transactions? For instance suppose we have two transactions in our mempool: tx1a, 1KB w/ 1mBTC fee, which is spent by tx2, 10KB w/ 1mBTC fee. We get tx1b, 10KB w/ 2.1mBTC fee. Since the overall feerate of tx1b is higher than tx1a+tx2, it'll be accepted, even though a miner might have rather mined tx1a instead, ignoring tx2 (for now).\r\n\r\nI agree that's less than optimal. If we make the assumption that there's always more demand for blockchain space than supply, it might be reasonable for the replacement logic criteria to be whether or not we're increasing the fee-rate of any subset of the mempool. (while still paying more fees than the replaced transactions)\r\n\r\nWithout taking CPFP into account, you could simply use the same kind of priority heap logic as in CreateNewBlock() on the list of transactions that would be replaced by the new transaction. You'd iterate through the heap from highest priority to lowest, stopping once you had found as many bytes worth of transactions as the candidate replacement. If the fee-rate of the replacement is higher than the fee-rate of those transactions, accept the replacement into the mempool.\r\n\r\nTo take CPFP into account... Thinking about it more the mempool package tracking is probably backwards from what we want. Right now it tracks descendants, when really what we want to know is \"what's the total fee-rate if I mine this transaction, and all ancestors?\" If we kept track of \"packages\" that way, we'd be able to do the comparison by determining if the total fee-rate of the new package created by the replacement is higher than the fee-rates of all the packages invalidated by it. I actually did some work on something along these lines a few years ago, though didn't finish it - the implementation is a lot simpler now that we have strict ancestor limits. (when limiting, just throw away the tx associated with the lowest fee-rate package, which is guaranteed to have no descendants)\r\n\r\nFor now though I'd be inclined to merge this PR as-is, as all the above options are pretty complex. I also don't see any way this code could be used in an DoS attack.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-23T23:03:07Z",
      "diff_hunk" : "@@ -932,6 +959,85 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather\n+        // than the ones it replaces.\n+        CAmount nConflictingFees = 0;\n+        size_t nConflictingSize = 0;\n+        if (setConflicts.size())\n+        {\n+            LOCK(pool.cs);\n+\n+            // Check if it's economically rational to mine this transaction\n+            // rather than the ones it replaces. For efficiency we simply sum\n+            // up the pre-calculated fees/size-with-descendants values from the\n+            // mempool package tracking; this does mean the pathological case\n+            // of diamond tx graphs will be overcounted.\n+            BOOST_FOREACH(const uint256 hashConflicting, setConflicts)\n+            {\n+                CTxMemPool::txiter mi = pool.mapTx.find(hashConflicting);\n+                if (mi == pool.mapTx.end())\n+                    continue;\n+                nConflictingFees += mi->GetFeesWithDescendants();\n+                nConflictingSize += mi->GetSizeWithDescendants();\n+            }\n+\n+            // Replace?\n+            //\n+            // First of all we can't allow a replacement unless it pays greater\n+            // fees than the transactions it conflicts with - if we did the\n+            // bandwidth used by those conflicting transactions would not be\n+            // paid for\n+            if (nFees < nConflictingFees)\n+            {\n+                return state.DoS(0, error(\"AcceptToMemoryPool: rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n+                                          hash.ToString(), FormatMoney(nFees), FormatMoney(nConflictingFees)),\n+                                 REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+\n+            // Secondly in addition to paying more fees than the conflicts the\n+            // new transaction must additionally pay for its own bandwidth.\n+            CAmount nDeltaFees = nFees - nConflictingFees;\n+            if (nDeltaFees < ::minRelayTxFee.GetFee(nSize))\n+            {\n+                return state.DoS(0,\n+                        error(\"AcceptToMemoryPool: rejecting replacement %s, not enough additional fees to relay; %s < %s\",\n+                              hash.ToString(),\n+                              FormatMoney(nDeltaFees),\n+                              FormatMoney(::minRelayTxFee.GetFee(nSize))),\n+                        REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+\n+            // Finally replace only if we end up with a larger fees-per-kb than\n+            // the replacements.\n+            CFeeRate oldFeeRate(nConflictingFees, nConflictingSize);\n+            CFeeRate newFeeRate(nFees, nSize);\n+            if (newFeeRate <= oldFeeRate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r42923364",
      "id" : 42923364,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 120,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42923364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Concept ACK. FSS is a pain.",
      "created_at" : "2015-10-26T13:17:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-151130336",
      "id" : 151130336,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-10-26T13:17:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151130336",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43024249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43024249"
         }
      },
      "body" : "When I check out the commit referenced in the README and run the test, I get an error:\r\n`AttributeError: 'Proxy' object has no attribute 'generate'`\r\n\r\nI think this function is not defined in the Proxy class?  Adding it in the appropriate place in python-bitcoinlib seems to fix it.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-26T17:25:03Z",
      "diff_hunk" : "@@ -0,0 +1,280 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2015 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#\n+# Test replace-by-fee\n+#\n+\n+import os\n+import sys\n+\n+# Add python-bitcoinlib to module search path:\n+sys.path.append(os.path.join(os.path.dirname(os.path.abspath(__file__)), \"python-bitcoinlib\"))\n+\n+import unittest\n+\n+import bitcoin\n+bitcoin.SelectParams('regtest')\n+\n+import bitcoin.rpc\n+\n+from bitcoin.core import *\n+from bitcoin.core.script import *\n+from bitcoin.wallet import *\n+\n+MAX_REPLACEMENT_LIMIT = 100\n+\n+class Test_ReplaceByFee(unittest.TestCase):\n+    proxy = None\n+\n+    @classmethod\n+    def setUpClass(cls):\n+        if cls.proxy is None:\n+            cls.proxy = bitcoin.rpc.Proxy()\n+\n+    @classmethod\n+    def tearDownClass(cls):\n+        # Make sure mining works\n+        mempool_size = 1\n+        while mempool_size:\n+            cls.proxy.generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43024249",
      "id" : 43024249,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 42,
      "path" : "qa/replace-by-fee/rbf-tests.py",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43024249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43024293"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43024293"
         }
      },
      "body" : "Any reason not to make this `const CTxIn &txin`, here and at line 832 below? ",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-26T17:25:13Z",
      "diff_hunk" : "@@ -806,15 +806,42 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n         return state.Invalid(false, REJECT_ALREADY_KNOWN, \"txn-already-in-mempool\");\n \n     // Check for conflicts with in-memory transactions\n+    set<uint256> setConflicts;\n     {\n     LOCK(pool.cs); // protect pool.mapNextTx\n-    for (unsigned int i = 0; i < tx.vin.size(); i++)\n+    BOOST_FOREACH(const CTxIn txin, tx.vin)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43024293",
      "id" : 43024293,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 8,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43024293",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43024496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43024496"
         }
      },
      "body" : "This could also be `const uint256 &hashAncestor`.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-26T17:26:24Z",
      "diff_hunk" : "@@ -932,6 +959,85 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 hashAncestor = ancestorIt->GetTx().GetHash();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43024496",
      "id" : 43024496,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 58,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43024496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43025108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43025108"
         }
      },
      "body" : "It's not included, no. You can just do a \"call\" instead. \r\n\r\n>proxy.call(\"generate\", 1)\r\n",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-26T17:30:34Z",
      "diff_hunk" : "@@ -0,0 +1,280 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2015 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#\n+# Test replace-by-fee\n+#\n+\n+import os\n+import sys\n+\n+# Add python-bitcoinlib to module search path:\n+sys.path.append(os.path.join(os.path.dirname(os.path.abspath(__file__)), \"python-bitcoinlib\"))\n+\n+import unittest\n+\n+import bitcoin\n+bitcoin.SelectParams('regtest')\n+\n+import bitcoin.rpc\n+\n+from bitcoin.core import *\n+from bitcoin.core.script import *\n+from bitcoin.wallet import *\n+\n+MAX_REPLACEMENT_LIMIT = 100\n+\n+class Test_ReplaceByFee(unittest.TestCase):\n+    proxy = None\n+\n+    @classmethod\n+    def setUpClass(cls):\n+        if cls.proxy is None:\n+            cls.proxy = bitcoin.rpc.Proxy()\n+\n+    @classmethod\n+    def tearDownClass(cls):\n+        # Make sure mining works\n+        mempool_size = 1\n+        while mempool_size:\n+            cls.proxy.generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43025108",
      "id" : 43025108,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 42,
      "path" : "qa/replace-by-fee/rbf-tests.py",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43025108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43025671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43025671"
         }
      },
      "body" : "I think this logic needlessly overcounts the descendants.  Why not just call CalculateDescendants on the entries in setConflicts, and then loop over all of them?\r\n\r\nAssuming the replacing transaction is successful, you don't end up wasting any time, because you can pass the descendant set directly into RemoveStaged later.\r\n\r\nIf the replacing transaction were to fail, and we're worried about the amount of work an attacker might try to make us do, then we could just put a work bound here where we fail to replace if there are too many things to look at.\r\n\r\nI think it's a good idea to address though because a simple pattern where you have two parent transactions that are spent by a single child of both couldn't be consolidated down to a single transaction without paying for that child twice, if we went with this algorithm; that seems like a needless overhead.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-26T17:34:32Z",
      "diff_hunk" : "@@ -932,6 +959,85 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather\n+        // than the ones it replaces.\n+        CAmount nConflictingFees = 0;\n+        size_t nConflictingSize = 0;\n+        if (setConflicts.size())\n+        {\n+            LOCK(pool.cs);\n+\n+            // Check if it's economically rational to mine this transaction\n+            // rather than the ones it replaces. For efficiency we simply sum\n+            // up the pre-calculated fees/size-with-descendants values from the\n+            // mempool package tracking; this does mean the pathological case\n+            // of diamond tx graphs will be overcounted.\n+            BOOST_FOREACH(const uint256 hashConflicting, setConflicts)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43025671",
      "id" : 43025671,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 81,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43025671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43026591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43026591"
         }
      },
      "body" : "nit: \"descendants\"",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-26T17:40:39Z",
      "diff_hunk" : "@@ -806,15 +806,42 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n         return state.Invalid(false, REJECT_ALREADY_KNOWN, \"txn-already-in-mempool\");\n \n     // Check for conflicts with in-memory transactions\n+    set<uint256> setConflicts;\n     {\n     LOCK(pool.cs); // protect pool.mapNextTx\n-    for (unsigned int i = 0; i < tx.vin.size(); i++)\n+    BOOST_FOREACH(const CTxIn txin, tx.vin)\n     {\n-        COutPoint outpoint = tx.vin[i].prevout;\n-        if (pool.mapNextTx.count(outpoint))\n+        if (pool.mapNextTx.count(txin.prevout))\n         {\n-            // Disable replacement feature for now\n-            return state.Invalid(false, REJECT_CONFLICT, \"txn-mempool-conflict\");\n+            const CTransaction *ptxConflicting = pool.mapNextTx[txin.prevout].ptx;\n+            if (!setConflicts.count(ptxConflicting->GetHash()))\n+            {\n+                // Allow opt-out of transaction replacement by setting\n+                // nSequence >= maxint-1 on all inputs.\n+                //\n+                // maxint-1 is picked to still allow use of nLockTime by\n+                // non-replacable transactions. All inputs rather than just one\n+                // is for the sake of multi-party protocols, where we don't\n+                // want a single party to be able to disable replacement.\n+                //\n+                // The opt-out ignores decendents as anyone relying on",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43026591",
      "id" : 43026591,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 27,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43026591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43031583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43031583"
         }
      },
      "body" : "Right, the distinction between ancestor and descendant package is what I was getting at.\r\n\r\nDescendant packages are I think the right thing to use for mempool limiting.  I don't follow what you're saying about a limiting algorithm that uses fee with ancestors -- it's entirely possible that the worst thing under that sort would have descendants in the mempool.\r\n\r\n(FYI I have a branch that implements [ancestor packages] (https://github.com/sdaftuar/bitcoin/tree/ancestor-tracking).  I might propose merging it at some point if it looks like we can take advantage of it in the mining code, but I'm not ready to advocate that now.)\r\n\r\nAnyway in this code, we are comparing the feerate of the replacing transaction (with uncalculated/unknown fee rate including its ancestors) to an estimate of the feerate of the descendants of all the conflicting transactions.  This strikes me as incorrect on both fronts; by not putting any bounds on the ancestor fee rate, we might be accepting a replacement transaction that is unlikely to confirm anytime soon.  On the other hand, by looking at feerate with children (and overcounting those children, at least in the current implementation), we might be making it so that miners would prefer the original transactions to the replacing one.\r\n\r\nI don't know that either of these issues constitutes an attack, but I do think it's useful to try to help users avoid shooting themselves in the foot, say by accidentally adding an input that is part of a long unconfirmed chain (causing the replacing transaction to be worse), and to give miners code that doesn't require further optimization to do the economically rational thing.\r\n\r\nSo with that in mind, how about this:\r\n * Require that any new inputs that show up in the replacing transaction be already confirmed.  In the future, if we do merge something like ancestor package tracking and better mining code, we could update this test appropriately.\r\n * Require that for each entry E in setConflicts, \r\n ```feerate(replacing transaction) > max(feerate of E, feerate of E with descendants)```.  That doesn't completely eliminate the possibility that it could be somehow worse for a miner to accept the new transaction, but it eliminates some degenerate cases (where a high fee rate transaction is dragged down by lower fee rate transactions) and is easy to calculate.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-26T18:18:30Z",
      "diff_hunk" : "@@ -932,6 +959,85 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather\n+        // than the ones it replaces.\n+        CAmount nConflictingFees = 0;\n+        size_t nConflictingSize = 0;\n+        if (setConflicts.size())\n+        {\n+            LOCK(pool.cs);\n+\n+            // Check if it's economically rational to mine this transaction\n+            // rather than the ones it replaces. For efficiency we simply sum\n+            // up the pre-calculated fees/size-with-descendants values from the\n+            // mempool package tracking; this does mean the pathological case\n+            // of diamond tx graphs will be overcounted.\n+            BOOST_FOREACH(const uint256 hashConflicting, setConflicts)\n+            {\n+                CTxMemPool::txiter mi = pool.mapTx.find(hashConflicting);\n+                if (mi == pool.mapTx.end())\n+                    continue;\n+                nConflictingFees += mi->GetFeesWithDescendants();\n+                nConflictingSize += mi->GetSizeWithDescendants();\n+            }\n+\n+            // Replace?\n+            //\n+            // First of all we can't allow a replacement unless it pays greater\n+            // fees than the transactions it conflicts with - if we did the\n+            // bandwidth used by those conflicting transactions would not be\n+            // paid for\n+            if (nFees < nConflictingFees)\n+            {\n+                return state.DoS(0, error(\"AcceptToMemoryPool: rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n+                                          hash.ToString(), FormatMoney(nFees), FormatMoney(nConflictingFees)),\n+                                 REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+\n+            // Secondly in addition to paying more fees than the conflicts the\n+            // new transaction must additionally pay for its own bandwidth.\n+            CAmount nDeltaFees = nFees - nConflictingFees;\n+            if (nDeltaFees < ::minRelayTxFee.GetFee(nSize))\n+            {\n+                return state.DoS(0,\n+                        error(\"AcceptToMemoryPool: rejecting replacement %s, not enough additional fees to relay; %s < %s\",\n+                              hash.ToString(),\n+                              FormatMoney(nDeltaFees),\n+                              FormatMoney(::minRelayTxFee.GetFee(nSize))),\n+                        REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+\n+            // Finally replace only if we end up with a larger fees-per-kb than\n+            // the replacements.\n+            CFeeRate oldFeeRate(nConflictingFees, nConflictingSize);\n+            CFeeRate newFeeRate(nFees, nSize);\n+            if (newFeeRate <= oldFeeRate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43031583",
      "id" : 43031583,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 120,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43031583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43032924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43032924"
         }
      },
      "body" : "Just to add on to my comment above -- if you call `CalculateDescendants` above and use `RemoveStaged` here, then we don't have to copy all these transactions...",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-26T18:28:13Z",
      "diff_hunk" : "@@ -952,6 +1058,19 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n                 __func__, hash.ToString(), FormatStateMessage(state));\n         }\n \n+        // Remove conflicting transactions from the mempool\n+        list<CTransaction> ltxConflicted;\n+        pool.removeConflicts(tx, ltxConflicted);\n+\n+        BOOST_FOREACH(const CTransaction &txConflicted, ltxConflicted)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43032924",
      "id" : 43032924,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 142,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43032924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465297"
         }
      },
      "body" : "Fixed.\r\n\r\nI forgot to add generate() when python-bitcoinlib dropped support for calling RPC commands implicitly; replaced with .call() so as to continue to use the official v0.5.0 release rather than git master.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-30T01:51:05Z",
      "diff_hunk" : "@@ -0,0 +1,280 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2015 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#\n+# Test replace-by-fee\n+#\n+\n+import os\n+import sys\n+\n+# Add python-bitcoinlib to module search path:\n+sys.path.append(os.path.join(os.path.dirname(os.path.abspath(__file__)), \"python-bitcoinlib\"))\n+\n+import unittest\n+\n+import bitcoin\n+bitcoin.SelectParams('regtest')\n+\n+import bitcoin.rpc\n+\n+from bitcoin.core import *\n+from bitcoin.core.script import *\n+from bitcoin.wallet import *\n+\n+MAX_REPLACEMENT_LIMIT = 100\n+\n+class Test_ReplaceByFee(unittest.TestCase):\n+    proxy = None\n+\n+    @classmethod\n+    def setUpClass(cls):\n+        if cls.proxy is None:\n+            cls.proxy = bitcoin.rpc.Proxy()\n+\n+    @classmethod\n+    def tearDownClass(cls):\n+        # Make sure mining works\n+        mempool_size = 1\n+        while mempool_size:\n+            cls.proxy.generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465297",
      "id" : 43465297,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 42,
      "path" : "qa/replace-by-fee/rbf-tests.py",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465297",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465406"
         }
      },
      "body" : "Good point! Fixed.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-30T01:53:55Z",
      "diff_hunk" : "@@ -806,15 +806,42 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n         return state.Invalid(false, REJECT_ALREADY_KNOWN, \"txn-already-in-mempool\");\n \n     // Check for conflicts with in-memory transactions\n+    set<uint256> setConflicts;\n     {\n     LOCK(pool.cs); // protect pool.mapNextTx\n-    for (unsigned int i = 0; i < tx.vin.size(); i++)\n+    BOOST_FOREACH(const CTxIn txin, tx.vin)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465406",
      "id" : 43465406,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 8,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465406",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465409"
         }
      },
      "body" : "Also fixed.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-30T01:54:00Z",
      "diff_hunk" : "@@ -932,6 +959,85 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 hashAncestor = ancestorIt->GetTx().GetHash();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465409",
      "id" : 43465409,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 58,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465634"
         }
      },
      "body" : "Well, I'm trying to keep this pull as simple as possible, while writing it in a way that isn't likely to lead to any DoS attacks; a previous version of this patch did do exactly what you suggest, but given that descendant tracking exists I figured I'd use it. (after all, I'm writing this patch pro bono)\r\n\r\nAs for your example where it would matter, that'd require wallets that attempted to both get txs to non-RBF miners and RBF miners simultaneously by broadcasting one then the other. It's a good idea, but doing that doesn't yet save you any money due to the rule that replacements must pay >= the fees of the transactions being replaced.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-30T02:00:08Z",
      "diff_hunk" : "@@ -932,6 +959,85 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather\n+        // than the ones it replaces.\n+        CAmount nConflictingFees = 0;\n+        size_t nConflictingSize = 0;\n+        if (setConflicts.size())\n+        {\n+            LOCK(pool.cs);\n+\n+            // Check if it's economically rational to mine this transaction\n+            // rather than the ones it replaces. For efficiency we simply sum\n+            // up the pre-calculated fees/size-with-descendants values from the\n+            // mempool package tracking; this does mean the pathological case\n+            // of diamond tx graphs will be overcounted.\n+            BOOST_FOREACH(const uint256 hashConflicting, setConflicts)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465634",
      "id" : 43465634,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 81,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465684"
         }
      },
      "body" : "Fixed",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-30T02:01:19Z",
      "diff_hunk" : "@@ -806,15 +806,42 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n         return state.Invalid(false, REJECT_ALREADY_KNOWN, \"txn-already-in-mempool\");\n \n     // Check for conflicts with in-memory transactions\n+    set<uint256> setConflicts;\n     {\n     LOCK(pool.cs); // protect pool.mapNextTx\n-    for (unsigned int i = 0; i < tx.vin.size(); i++)\n+    BOOST_FOREACH(const CTxIn txin, tx.vin)\n     {\n-        COutPoint outpoint = tx.vin[i].prevout;\n-        if (pool.mapNextTx.count(outpoint))\n+        if (pool.mapNextTx.count(txin.prevout))\n         {\n-            // Disable replacement feature for now\n-            return state.Invalid(false, REJECT_CONFLICT, \"txn-mempool-conflict\");\n+            const CTransaction *ptxConflicting = pool.mapNextTx[txin.prevout].ptx;\n+            if (!setConflicts.count(ptxConflicting->GetHash()))\n+            {\n+                // Allow opt-out of transaction replacement by setting\n+                // nSequence >= maxint-1 on all inputs.\n+                //\n+                // maxint-1 is picked to still allow use of nLockTime by\n+                // non-replacable transactions. All inputs rather than just one\n+                // is for the sake of multi-party protocols, where we don't\n+                // want a single party to be able to disable replacement.\n+                //\n+                // The opt-out ignores decendents as anyone relying on",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465684",
      "id" : 43465684,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 27,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465707"
         }
      },
      "body" : "Agreed. Although again, I'm not worried about the case where the transactions do end up replaced; I'm worried about the possible DoS attack case where they aren't.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-30T02:02:05Z",
      "diff_hunk" : "@@ -952,6 +1058,19 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n                 __func__, hash.ToString(), FormatStateMessage(state));\n         }\n \n+        // Remove conflicting transactions from the mempool\n+        list<CTransaction> ltxConflicted;\n+        pool.removeConflicts(tx, ltxConflicted);\n+\n+        BOOST_FOREACH(const CTransaction &txConflicted, ltxConflicted)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43465707",
      "id" : 43465707,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 142,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43465707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43470275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43470275"
         }
      },
      "body" : "Fixed both these issues.\r\n\r\nI decided not to do the max() version of this, as I think the requirement that the new fees > total-replaced-fees is sufficient; might help to get txs unstuck in some cases, and non-CPFP miners aren't evaluating that anyway.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-10-30T04:07:53Z",
      "diff_hunk" : "@@ -932,6 +959,85 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather\n+        // than the ones it replaces.\n+        CAmount nConflictingFees = 0;\n+        size_t nConflictingSize = 0;\n+        if (setConflicts.size())\n+        {\n+            LOCK(pool.cs);\n+\n+            // Check if it's economically rational to mine this transaction\n+            // rather than the ones it replaces. For efficiency we simply sum\n+            // up the pre-calculated fees/size-with-descendants values from the\n+            // mempool package tracking; this does mean the pathological case\n+            // of diamond tx graphs will be overcounted.\n+            BOOST_FOREACH(const uint256 hashConflicting, setConflicts)\n+            {\n+                CTxMemPool::txiter mi = pool.mapTx.find(hashConflicting);\n+                if (mi == pool.mapTx.end())\n+                    continue;\n+                nConflictingFees += mi->GetFeesWithDescendants();\n+                nConflictingSize += mi->GetSizeWithDescendants();\n+            }\n+\n+            // Replace?\n+            //\n+            // First of all we can't allow a replacement unless it pays greater\n+            // fees than the transactions it conflicts with - if we did the\n+            // bandwidth used by those conflicting transactions would not be\n+            // paid for\n+            if (nFees < nConflictingFees)\n+            {\n+                return state.DoS(0, error(\"AcceptToMemoryPool: rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n+                                          hash.ToString(), FormatMoney(nFees), FormatMoney(nConflictingFees)),\n+                                 REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+\n+            // Secondly in addition to paying more fees than the conflicts the\n+            // new transaction must additionally pay for its own bandwidth.\n+            CAmount nDeltaFees = nFees - nConflictingFees;\n+            if (nDeltaFees < ::minRelayTxFee.GetFee(nSize))\n+            {\n+                return state.DoS(0,\n+                        error(\"AcceptToMemoryPool: rejecting replacement %s, not enough additional fees to relay; %s < %s\",\n+                              hash.ToString(),\n+                              FormatMoney(nDeltaFees),\n+                              FormatMoney(::minRelayTxFee.GetFee(nSize))),\n+                        REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+\n+            // Finally replace only if we end up with a larger fees-per-kb than\n+            // the replacements.\n+            CFeeRate oldFeeRate(nConflictingFees, nConflictingSize);\n+            CFeeRate newFeeRate(nFees, nSize);\n+            if (newFeeRate <= oldFeeRate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r43470275",
      "id" : 43470275,
      "original_commit_id" : "b233451b00f5e58ea5cb380aebe0297d436bd1f5",
      "original_position" : 120,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/43470275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Added @sdaftuar's changes from https://github.com/petertodd/bitcoin/pull/4#issuecomment-152636458",
      "created_at" : "2015-11-04T18:52:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-153828785",
      "id" : 153828785,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-04T18:52:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/153828785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Great work @sdaftuar on the added tests, once-over ACK",
      "created_at" : "2015-11-05T00:36:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-153916023",
      "id" : 153916023,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-05T00:37:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/153916023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "needs rebase",
      "created_at" : "2015-11-05T17:19:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-154127386",
      "id" : 154127386,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-05T17:19:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/154127386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "body" : "Concept ACK",
      "created_at" : "2015-11-10T16:50:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-155483936",
      "id" : 155483936,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-10T16:50:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155483936",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "concept ACK\r\n",
      "created_at" : "2015-11-10T16:56:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-155485328",
      "id" : 155485328,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-10T16:56:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155485328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Rebased",
      "created_at" : "2015-11-10T19:15:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-155535756",
      "id" : 155535756,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-10T19:15:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155535756",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Main question I have right now, is do we want to go with @sdaftuar's somewhat more complex, but more correct, code? (https://github.com/petertodd/bitcoin/commit/20367d831fe0fdb92678d03552866c266aabbd83) Or keep it simple?\r\n\r\nI'm happy with either way, and the code is written and looks good to me. Just a matter of risk tolerance.",
      "created_at" : "2015-11-10T19:18:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-155536453",
      "id" : 155536453,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-10T19:18:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155536453",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Also, regarding the duplicated tests, I'm inclined to leave my ones in git history for historical reference in case questions come up later, but delete them from from the codebase soon in favor of @sdaftuar's. (possibly even in this pull-req) They're relatively \"battle-tested\" tests. :)",
      "created_at" : "2015-11-10T19:46:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-155545632",
      "id" : 155545632,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-10T19:46:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155545632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Fixed test failure due to not having pool.cs lock held.",
      "created_at" : "2015-11-10T23:01:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-155595438",
      "id" : 155595438,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-10T23:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155595438",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "This will enable replacement for BIP68 transactions?",
      "created_at" : "2015-11-11T07:32:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-155693011",
      "id" : 155693011,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-11T07:32:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155693011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa Yup!",
      "created_at" : "2015-11-11T10:39:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-155730787",
      "id" : 155730787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-11T10:39:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155730787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Incremental sendmany demo: https://github.com/petertodd/replace-by-fee-tools#incremental-send-many",
      "created_at" : "2015-11-11T22:10:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-155925679",
      "id" : 155925679,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-11T22:10:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155925679",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r44660476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44660476"
         }
      },
      "body" : "I don't like hard-coding a commit ID here. It will go out of date very soon. If this requires v0.5.x, Can we do something like:\r\n\r\n    git clone --branch 0.5 https://github.com/petertodd/python-bitcoinlib\r\n",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-12T14:13:16Z",
      "diff_hunk" : "@@ -0,0 +1,13 @@\n+Replace-by-fee regression tests\n+===============================\n+\n+First get version v0.5.0 of the python-bitcoinlib library. In this directory\n+run:\n+\n+    git clone -n https://github.com/petertodd/python-bitcoinlib",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r44660476",
      "id" : 44660476,
      "original_commit_id" : "16a2f93629f75d182871f288f0396afe6cdc8504",
      "original_position" : 7,
      "path" : "qa/replace-by-fee/README.md",
      "position" : 7,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44660476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Code review ACK",
      "created_at" : "2015-11-12T15:34:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-156139953",
      "id" : 156139953,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-12T15:34:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156139953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r44699335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44699335"
         }
      },
      "body" : "My thinking re: hard-coding is reproducability; if we're out of date, we should explicitly update it rather than implicitly.\r\n\r\nAlso, this set of tests will likely get removed fairly soon, and kept just for historical reference now that they've been mostly rewritten.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-12T19:03:54Z",
      "diff_hunk" : "@@ -0,0 +1,13 @@\n+Replace-by-fee regression tests\n+===============================\n+\n+First get version v0.5.0 of the python-bitcoinlib library. In this directory\n+run:\n+\n+    git clone -n https://github.com/petertodd/python-bitcoinlib",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r44699335",
      "id" : 44699335,
      "original_commit_id" : "16a2f93629f75d182871f288f0396afe6cdc8504",
      "original_position" : 7,
      "path" : "qa/replace-by-fee/README.md",
      "position" : 7,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44699335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "After further thought I think we can hold the mempool lock for a bit less time.  I don't think it's possible for transactions to be added or removed from the mempool without holding `cs_main`, and ATMP holds `cs_main` the whole time.  So I think all we need to do so that the mempool shows a consistent view to any RPC calls that only grab the mempool lock is acquire the lock before calling `RemoveStaged()`, and release the lock after calling `addUnchecked()`.  (Hopefully someone can verify my reasoning...)\r\n\r\nAnyway I think that's pretty minor either way.\r\n\r\nACK.\r\n",
      "created_at" : "2015-11-13T16:25:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-156479123",
      "id" : 156479123,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-13T16:25:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156479123",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "@sdaftuar That's a good point, though I think changing that should be done in a separate pull-req after this is merged.",
      "created_at" : "2015-11-13T18:57:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-156523788",
      "id" : 156523788,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-13T18:57:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156523788",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Upgraded to utACK.",
      "created_at" : "2015-11-13T19:38:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-156537226",
      "id" : 156537226,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-13T19:38:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156537226",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "body" : "Concept ACK, so far is this goes.  It can only help to allow spenders to declare their intention not to double-spend, or to keep the option open.\r\n\r\nIt will be unfortunate if wallets *silently* make \"replaceable\" the default for new transactions.  This setting should be exposed and visible, although there are different ways it could be labeled.\r\n\r\ncc @jonasschnelli\r\n",
      "created_at" : "2015-11-17T20:10:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-157491460",
      "id" : 157491460,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-17T20:10:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/157491460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4284124?v=3",
         "events_url" : "https://api.github.com/users/dgenr8/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgenr8/followers",
         "following_url" : "https://api.github.com/users/dgenr8/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgenr8/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgenr8",
         "id" : 4284124,
         "login" : "dgenr8",
         "organizations_url" : "https://api.github.com/users/dgenr8/orgs",
         "received_events_url" : "https://api.github.com/users/dgenr8/received_events",
         "repos_url" : "https://api.github.com/users/dgenr8/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgenr8/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgenr8/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgenr8"
      }
   },
   {
      "body" : "In response to @dgenr8 's comment, I do think we need to make it very clear that there is still no such thing as technically \"declaring an intention not to double-spend\". Strongly prefer adding a full RBF option, even if unwise for miners to deploy today.",
      "created_at" : "2015-11-17T20:20:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-157495164",
      "id" : 157495164,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-17T20:20:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/157495164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "@dgenr8 The nSequence for opt-in is one that no wallets today use by default.\r\n\r\nIn any case, indicating an intention not to double-spend isn't something wallets should really be doing today, given their poor track record of not double-spending; there are many failure modes where wallets today will double-spend a transaction inadvertently, something you can easily see if you watch double-spend logs. This is why any type of doublespend punishment scheme needs to be carefully engineered, and definitely not used with standard wallets.",
      "created_at" : "2015-11-17T21:30:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-157513575",
      "id" : 157513575,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-17T21:30:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/157513575",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "I think I can phrase my point better.  Allowing spenders to declare their intention to double-spend, if they should later so desire, is helpful to 0-conf-accepting receivers because they can be sure not to rely on the transaction before confirmation.\r\n\r\nThe 72-hour expiration that will soon be policy is also helpful because it gives a better option to those who have stuck transactions (even those without opt-in RBF set): \"wait 72 hours and try again.\"  This is a lot better than \"download @petertodd's tools,\" \"use rawtxes,\" etc.\r\n",
      "created_at" : "2015-11-17T22:04:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-157523647",
      "id" : 157523647,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-17T22:06:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/157523647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4284124?v=3",
         "events_url" : "https://api.github.com/users/dgenr8/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgenr8/followers",
         "following_url" : "https://api.github.com/users/dgenr8/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgenr8/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgenr8",
         "id" : 4284124,
         "login" : "dgenr8",
         "organizations_url" : "https://api.github.com/users/dgenr8/orgs",
         "received_events_url" : "https://api.github.com/users/dgenr8/received_events",
         "repos_url" : "https://api.github.com/users/dgenr8/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgenr8/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgenr8/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgenr8"
      }
   },
   {
      "body" : "Well, with this you don't have to wait anything. You can pay more fees at any point to \"try again\", that's kind of the whole point of RBF.",
      "created_at" : "2015-11-17T22:14:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-157526464",
      "id" : 157526464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-17T22:14:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/157526464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "@dgenr8 Does the advice \"wait 72 hours and try again\" even work right now in Bitcoin Core? IIRC we don't delete transactions from the wallet itself on that timeout.\r\n\r\nAnyway, while this pull-req doesn't change any wallet behavior, subsequent pull-reqs of course can of course add the required wallet code to unstick stuck transactions.",
      "created_at" : "2015-11-18T01:47:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-157570808",
      "id" : 157570808,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-18T01:47:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/157570808",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "@petertodd Opt-in and expiration both suggest new wallet functions:\r\n\r\nOn new tx:\r\n - [ ] Mark transaction as replaceable (receiver must wait for confirmation)\r\n\r\nOn replaceable or expired unconfirmed tx:\r\n - Send new version with higher fees\r\n - Send new version that pays myself instead  (permanently cancels original)\r\n - Forget [release inputs]\r\n\r\nOn forgotten transactions with inputs still unspent:\r\n - Unforget\r\n",
      "created_at" : "2015-11-18T14:58:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-157740068",
      "id" : 157740068,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-19T20:07:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/157740068",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4284124?v=3",
         "events_url" : "https://api.github.com/users/dgenr8/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgenr8/followers",
         "following_url" : "https://api.github.com/users/dgenr8/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgenr8/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgenr8",
         "id" : 4284124,
         "login" : "dgenr8",
         "organizations_url" : "https://api.github.com/users/dgenr8/orgs",
         "received_events_url" : "https://api.github.com/users/dgenr8/received_events",
         "repos_url" : "https://api.github.com/users/dgenr8/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgenr8/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgenr8/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgenr8"
      }
   },
   {
      "body" : "@dgenr8 That analysis seems about right. I would personally prefer that the replaceable option was always true (on non-raw transactions, obviously) for Bitcoin Core. But those are changes to the wallet that as explained by @petertodd are out of the scope of this PR. ",
      "created_at" : "2015-11-18T15:59:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-157758745",
      "id" : 157758745,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-18T16:01:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/157758745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45219187"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45219187"
         }
      },
      "body" : "Can't all this new code (1003 to 1140) be a new function?\r\nEDIT: since it uses the mempool, it's probably better that this doesn't move to policy.cpp yet. In main.cpp is fine, just apart from AcceptToMemoryPool().",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-18T16:08:38Z",
      "diff_hunk" : "@@ -957,6 +984,160 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45219187",
      "id" : 45219187,
      "original_commit_id" : "16a2f93629f75d182871f288f0396afe6cdc8504",
      "original_position" : 68,
      "path" : "src/main.cpp",
      "position" : 68,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45219187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "concept ACK, haven't had time for code review",
      "created_at" : "2015-11-19T02:48:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-157932605",
      "id" : 157932605,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-19T02:48:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/157932605",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/894059?v=3",
         "events_url" : "https://api.github.com/users/CodeShark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/CodeShark/followers",
         "following_url" : "https://api.github.com/users/CodeShark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/CodeShark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/CodeShark",
         "id" : 894059,
         "login" : "CodeShark",
         "organizations_url" : "https://api.github.com/users/CodeShark/orgs",
         "received_events_url" : "https://api.github.com/users/CodeShark/received_events",
         "repos_url" : "https://api.github.com/users/CodeShark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/CodeShark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/CodeShark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/CodeShark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45396057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45396057"
         }
      },
      "body" : "(maybe out of scope for this PR)\r\n\r\nDo we need a new signal here? How can the wallet detect removed (or replaced) transactions? Maybe the signal needs to be emitted from `void CTxMemPool::RemoveStaged(setEntries &stage)` (or nearby) to also include the mempool limiting behavior.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-19T20:30:43Z",
      "diff_hunk" : "@@ -977,6 +1158,17 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n                 __func__, hash.ToString(), FormatStateMessage(state));\n         }\n \n+        // Remove conflicting transactions from the mempool\n+        BOOST_FOREACH(const CTxMemPool::txiter it, allConflicting)\n+        {\n+            LogPrint(\"mempool\", \"replacing tx %s with %s for %s BTC additional fees, %d delta bytes\\n\",\n+                    it->GetTx().GetHash().ToString(),\n+                    hash.ToString(),\n+                    FormatMoney(nFees - nConflictingFees),\n+                    (int)nSize - (int)nConflictingSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45396057",
      "id" : 45396057,
      "original_commit_id" : "16a2f93629f75d182871f288f0396afe6cdc8504",
      "original_position" : 220,
      "path" : "src/main.cpp",
      "position" : 220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45396057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "CodeReview ACK.\r\n(sidenote: it's always nice to review well documented PRs!)",
      "created_at" : "2015-11-19T20:32:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-158189462",
      "id" : 158189462,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-19T20:32:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/158189462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45473643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45473643"
         }
      },
      "body" : "Agree with @jtimon . It's hard to read a function spanning over 400 lines not knowing which parts belong together.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-20T14:29:56Z",
      "diff_hunk" : "@@ -957,6 +984,160 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45473643",
      "id" : 45473643,
      "original_commit_id" : "16a2f93629f75d182871f288f0396afe6cdc8504",
      "original_position" : 68,
      "path" : "src/main.cpp",
      "position" : 68,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45473643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45510187"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45510187"
         }
      },
      "body" : "We probably do. But yeah, I think adding that can wait for another pull-req; belongs as a wallet code change IMO, so might as well let whomever ends up writing that decide what they need.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-20T19:49:10Z",
      "diff_hunk" : "@@ -977,6 +1158,17 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n                 __func__, hash.ToString(), FormatStateMessage(state));\n         }\n \n+        // Remove conflicting transactions from the mempool\n+        BOOST_FOREACH(const CTxMemPool::txiter it, allConflicting)\n+        {\n+            LogPrint(\"mempool\", \"replacing tx %s with %s for %s BTC additional fees, %d delta bytes\\n\",\n+                    it->GetTx().GetHash().ToString(),\n+                    hash.ToString(),\n+                    FormatMoney(nFees - nConflictingFees),\n+                    (int)nSize - (int)nConflictingSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45510187",
      "id" : 45510187,
      "original_commit_id" : "16a2f93629f75d182871f288f0396afe6cdc8504",
      "original_position" : 220,
      "path" : "src/main.cpp",
      "position" : 220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45510187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45512199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45512199"
         }
      },
      "body" : "@jtimon Yeah, it's tricky though, because we reuse allConflicting later in the removal code for performance, and that in turn requires us to hold a lock; the way the code works isn't really modularized yet. That said compared to my previous patch we do at least take advantage of other mempool-related code, CalculateDescendants(), so we're a bit ahead.\r\n\r\nI'd be inclined to leave it as-is right now, and do the refactor later when we add RBF-related code to the wallet and/or RPC - that's when we'll have a better idea of what the refactor should look like and how the refactored code should interact with both uses. For instance, the ability to calculate on demand how expensive it would be to replace a specific transaction would be useful.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-20T20:05:16Z",
      "diff_hunk" : "@@ -957,6 +984,160 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45512199",
      "id" : 45512199,
      "original_commit_id" : "16a2f93629f75d182871f288f0396afe6cdc8504",
      "original_position" : 68,
      "path" : "src/main.cpp",
      "position" : 68,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-20T21:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45512199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "@jonasschnelli Thanks! Yeah, apparently my life long dream was actually to become a technical writer, not a programmer. :)",
      "created_at" : "2015-11-20T20:06:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-158511352",
      "id" : 158511352,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-20T20:06:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/158511352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45586305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45586305"
         }
      },
      "body" : "I don't see how is tricky, if you need something inside the new function and in the caller, just pass it as reference. If you were holding the lock, well keep holding it, etc...It should be basically cut the code I said and paste it out as a (for now static) function, and adapt the parameters until it compiles, I think.\r\nOf course we can always leave refactors for later, but they often become harder with time (because the code keeps evolving from its current form, not from \"what we plan to do with it in a later refactor\".\r\nI'm fine with not doing it within this PR (although it would be less disruptive to squash that with the commit that introduces the new code), but I highly dislike when people insist to \"postpone refactor X until after feature Y\". If X is ready 6months before Y starts being coded...should we wait there too?\r\nThat kind of thinking is what has led us to, for example, wait more than 1 year to introduce a CPolicy class (and I'm still waiting because apparently #6068 would be too disruptive for this and other mempool-related changes [I disagree but was tired of rebasing]).\r\nIf we leave this PR as it is, fine. But please don't postpone or restrict any kind of development unnecessarily. Complain in the PRs when they exist, but don't plan how to serialize refactors between features or I predict: new important features will be proposed and the refactors will never happen (and encapsulations will become increasingly hard).\r\n",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-23T10:02:19Z",
      "diff_hunk" : "@@ -957,6 +984,160 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45586305",
      "id" : 45586305,
      "original_commit_id" : "16a2f93629f75d182871f288f0396afe6cdc8504",
      "original_position" : 68,
      "path" : "src/main.cpp",
      "position" : 68,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-23T10:02:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45586305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45597053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45597053"
         }
      },
      "body" : "Wouldn't it be better to put the new code (from L987) after this check instead of before?\r\nIt would avoid doing further mempool validations for transactions that are going to be rejected by this check anyway.\r\nI know there can be transactions that would pass this check but be rejected as a replacement, but this check already has the inputs of the transaction cached, so it seems cheaper than the RBF logic and it makes sense to me to do it first.\r\nNote that this minor nit wouldn't change the total diff (although it can be done later with other changes too [for example, a rebased #6445 ]).",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-23T12:16:49Z",
      "diff_hunk" : "@@ -957,6 +984,160 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather\n+        // than the ones it replaces.\n+        CAmount nConflictingFees = 0;\n+        size_t nConflictingSize = 0;\n+        uint64_t nConflictingCount = 0;\n+        CTxMemPool::setEntries allConflicting;\n+\n+        // If we don't hold the lock allConflicting might be incomplete; the\n+        // subsequent RemoveStaged() and addUnchecked() calls don't guarantee\n+        // mempool consistency for us.\n+        LOCK(pool.cs);\n+        if (setConflicts.size())\n+        {\n+            CFeeRate newFeeRate(nFees, nSize);\n+            set<uint256> setConflictsParents;\n+            const int maxDescendantsToVisit = 100;\n+            CTxMemPool::setEntries setIterConflicting;\n+            BOOST_FOREACH(const uint256 &hashConflicting, setConflicts)\n+            {\n+                CTxMemPool::txiter mi = pool.mapTx.find(hashConflicting);\n+                if (mi == pool.mapTx.end())\n+                    continue;\n+\n+                // Save these to avoid repeated lookups\n+                setIterConflicting.insert(mi);\n+\n+                // If this entry is \"dirty\", then we don't have descendant\n+                // state for this transaction, which means we probably have\n+                // lots of in-mempool descendants.\n+                // Don't allow replacements of dirty transactions, to ensure\n+                // that we don't spend too much time walking descendants.\n+                // This should be rare.\n+                if (mi->IsDirty()) {\n+                    return state.DoS(0,\n+                            error(\"AcceptToMemoryPool: rejecting replacement %s; cannot replace tx %s with untracked descendants\",\n+                                hash.ToString(),\n+                                mi->GetTx().GetHash().ToString()),\n+                            REJECT_NONSTANDARD, \"too many potential replacements\");\n+                }\n+\n+                // Don't allow the replacement to reduce the feerate of the\n+                // mempool.\n+                //\n+                // We usually don't want to accept replacements with lower\n+                // feerates than what they replaced as that would lower the\n+                // feerate of the next block. Requiring that the feerate always\n+                // be increased is also an easy-to-reason about way to prevent\n+                // DoS attacks via replacements.\n+                //\n+                // The mining code doesn't (currently) take children into\n+                // account (CPFP) so we only consider the feerates of\n+                // transactions being directly replaced, not their indirect\n+                // descendants. While that does mean high feerate children are\n+                // ignored when deciding whether or not to replace, we do\n+                // require the replacement to pay more overall fees too,\n+                // mitigating most cases.\n+                CFeeRate oldFeeRate(mi->GetFee(), mi->GetTxSize());\n+                if (newFeeRate <= oldFeeRate)\n+                {\n+                    return state.DoS(0,\n+                            error(\"AcceptToMemoryPool: rejecting replacement %s; new feerate %s <= old feerate %s\",\n+                                  hash.ToString(),\n+                                  newFeeRate.ToString(),\n+                                  oldFeeRate.ToString()),\n+                            REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+                }\n+\n+                BOOST_FOREACH(const CTxIn &txin, mi->GetTx().vin)\n+                {\n+                    setConflictsParents.insert(txin.prevout.hash);\n+                }\n+\n+                nConflictingCount += mi->GetCountWithDescendants();\n+            }\n+            // This potentially overestimates the number of actual descendants\n+            // but we just want to be conservative to avoid doing too much\n+            // work.\n+            if (nConflictingCount <= maxDescendantsToVisit) {\n+                // If not too many to replace, then calculate the set of\n+                // transactions that would have to be evicted\n+                BOOST_FOREACH(CTxMemPool::txiter it, setIterConflicting) {\n+                    pool.CalculateDescendants(it, allConflicting);\n+                }\n+                BOOST_FOREACH(CTxMemPool::txiter it, allConflicting) {\n+                    nConflictingFees += it->GetFee();\n+                    nConflictingSize += it->GetTxSize();\n+                }\n+            } else {\n+                return state.DoS(0,\n+                        error(\"AcceptToMemoryPool: rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                            hash.ToString(),\n+                            nConflictingCount,\n+                            maxDescendantsToVisit),\n+                        REJECT_NONSTANDARD, \"too many potential replacements\");\n+            }\n+\n+            for (unsigned int j = 0; j < tx.vin.size(); j++)\n+            {\n+                // We don't want to accept replacements that require low\n+                // feerate junk to be mined first. Ideally we'd keep track of\n+                // the ancestor feerates and make the decision based on that,\n+                // but for now requiring all new inputs to be confirmed works.\n+                if (!setConflictsParents.count(tx.vin[j].prevout.hash))\n+                {\n+                    // Rather than check the UTXO set - potentially expensive -\n+                    // it's cheaper to just check if the new input refers to a\n+                    // tx that's in the mempool.\n+                    if (pool.mapTx.find(tx.vin[j].prevout.hash) != pool.mapTx.end())\n+                        return state.DoS(0, error(\"AcceptToMemoryPool: replacement %s adds unconfirmed input, idx %d\",\n+                                                  hash.ToString(), j),\n+                                         REJECT_NONSTANDARD, \"replacement-adds-unconfirmed\");\n+                }\n+            }\n+\n+            // The replacement must pay greater fees than the transactions it\n+            // replaces - if we did the bandwidth used by those conflicting\n+            // transactions would not be paid for.\n+            if (nFees < nConflictingFees)\n+            {\n+                return state.DoS(0, error(\"AcceptToMemoryPool: rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n+                                          hash.ToString(), FormatMoney(nFees), FormatMoney(nConflictingFees)),\n+                                 REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+\n+            // Finally in addition to paying more fees than the conflicts the\n+            // new transaction must pay for its own bandwidth.\n+            CAmount nDeltaFees = nFees - nConflictingFees;\n+            if (nDeltaFees < ::minRelayTxFee.GetFee(nSize))\n+            {\n+                return state.DoS(0,\n+                        error(\"AcceptToMemoryPool: rejecting replacement %s, not enough additional fees to relay; %s < %s\",\n+                              hash.ToString(),\n+                              FormatMoney(nDeltaFees),\n+                              FormatMoney(::minRelayTxFee.GetFee(nSize))),\n+                        REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+        }\n+\n         // Check against previous transactions\n         // This is done last to help prevent CPU exhaustion denial-of-service attacks.\n         if (!CheckInputs(tx, state, view, true, STANDARD_SCRIPT_VERIFY_FLAGS, true))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45597053",
      "id" : 45597053,
      "original_commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "original_position" : 208,
      "path" : "src/main.cpp",
      "position" : 208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-23T12:19:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45597053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45599341"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45599341"
         }
      },
      "body" : "I was talking about something like this: https://github.com/jtimon/bitcoin/commit/f10b5317d21eea21375bb0da718dc98ee4e37452 but as said  I'm completely fine with not creating the new function yet (although now it would be almost free diff-wise).",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-23T12:48:24Z",
      "diff_hunk" : "@@ -957,6 +984,160 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45599341",
      "id" : 45599341,
      "original_commit_id" : "16a2f93629f75d182871f288f0396afe6cdc8504",
      "original_position" : 68,
      "path" : "src/main.cpp",
      "position" : 68,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-23T12:52:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45599341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45898813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45898813"
         }
      },
      "body" : "You mean after the CheckInputs() line? The RBF code is just a bunch of pointer following of in-memory data, with limited depth and breadth, so it shouldn't be expensive code to run - remember that the mempool has tx fee and size data in the CTxMemPool structs.",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-25T17:58:03Z",
      "diff_hunk" : "@@ -957,6 +984,160 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather\n+        // than the ones it replaces.\n+        CAmount nConflictingFees = 0;\n+        size_t nConflictingSize = 0;\n+        uint64_t nConflictingCount = 0;\n+        CTxMemPool::setEntries allConflicting;\n+\n+        // If we don't hold the lock allConflicting might be incomplete; the\n+        // subsequent RemoveStaged() and addUnchecked() calls don't guarantee\n+        // mempool consistency for us.\n+        LOCK(pool.cs);\n+        if (setConflicts.size())\n+        {\n+            CFeeRate newFeeRate(nFees, nSize);\n+            set<uint256> setConflictsParents;\n+            const int maxDescendantsToVisit = 100;\n+            CTxMemPool::setEntries setIterConflicting;\n+            BOOST_FOREACH(const uint256 &hashConflicting, setConflicts)\n+            {\n+                CTxMemPool::txiter mi = pool.mapTx.find(hashConflicting);\n+                if (mi == pool.mapTx.end())\n+                    continue;\n+\n+                // Save these to avoid repeated lookups\n+                setIterConflicting.insert(mi);\n+\n+                // If this entry is \"dirty\", then we don't have descendant\n+                // state for this transaction, which means we probably have\n+                // lots of in-mempool descendants.\n+                // Don't allow replacements of dirty transactions, to ensure\n+                // that we don't spend too much time walking descendants.\n+                // This should be rare.\n+                if (mi->IsDirty()) {\n+                    return state.DoS(0,\n+                            error(\"AcceptToMemoryPool: rejecting replacement %s; cannot replace tx %s with untracked descendants\",\n+                                hash.ToString(),\n+                                mi->GetTx().GetHash().ToString()),\n+                            REJECT_NONSTANDARD, \"too many potential replacements\");\n+                }\n+\n+                // Don't allow the replacement to reduce the feerate of the\n+                // mempool.\n+                //\n+                // We usually don't want to accept replacements with lower\n+                // feerates than what they replaced as that would lower the\n+                // feerate of the next block. Requiring that the feerate always\n+                // be increased is also an easy-to-reason about way to prevent\n+                // DoS attacks via replacements.\n+                //\n+                // The mining code doesn't (currently) take children into\n+                // account (CPFP) so we only consider the feerates of\n+                // transactions being directly replaced, not their indirect\n+                // descendants. While that does mean high feerate children are\n+                // ignored when deciding whether or not to replace, we do\n+                // require the replacement to pay more overall fees too,\n+                // mitigating most cases.\n+                CFeeRate oldFeeRate(mi->GetFee(), mi->GetTxSize());\n+                if (newFeeRate <= oldFeeRate)\n+                {\n+                    return state.DoS(0,\n+                            error(\"AcceptToMemoryPool: rejecting replacement %s; new feerate %s <= old feerate %s\",\n+                                  hash.ToString(),\n+                                  newFeeRate.ToString(),\n+                                  oldFeeRate.ToString()),\n+                            REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+                }\n+\n+                BOOST_FOREACH(const CTxIn &txin, mi->GetTx().vin)\n+                {\n+                    setConflictsParents.insert(txin.prevout.hash);\n+                }\n+\n+                nConflictingCount += mi->GetCountWithDescendants();\n+            }\n+            // This potentially overestimates the number of actual descendants\n+            // but we just want to be conservative to avoid doing too much\n+            // work.\n+            if (nConflictingCount <= maxDescendantsToVisit) {\n+                // If not too many to replace, then calculate the set of\n+                // transactions that would have to be evicted\n+                BOOST_FOREACH(CTxMemPool::txiter it, setIterConflicting) {\n+                    pool.CalculateDescendants(it, allConflicting);\n+                }\n+                BOOST_FOREACH(CTxMemPool::txiter it, allConflicting) {\n+                    nConflictingFees += it->GetFee();\n+                    nConflictingSize += it->GetTxSize();\n+                }\n+            } else {\n+                return state.DoS(0,\n+                        error(\"AcceptToMemoryPool: rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                            hash.ToString(),\n+                            nConflictingCount,\n+                            maxDescendantsToVisit),\n+                        REJECT_NONSTANDARD, \"too many potential replacements\");\n+            }\n+\n+            for (unsigned int j = 0; j < tx.vin.size(); j++)\n+            {\n+                // We don't want to accept replacements that require low\n+                // feerate junk to be mined first. Ideally we'd keep track of\n+                // the ancestor feerates and make the decision based on that,\n+                // but for now requiring all new inputs to be confirmed works.\n+                if (!setConflictsParents.count(tx.vin[j].prevout.hash))\n+                {\n+                    // Rather than check the UTXO set - potentially expensive -\n+                    // it's cheaper to just check if the new input refers to a\n+                    // tx that's in the mempool.\n+                    if (pool.mapTx.find(tx.vin[j].prevout.hash) != pool.mapTx.end())\n+                        return state.DoS(0, error(\"AcceptToMemoryPool: replacement %s adds unconfirmed input, idx %d\",\n+                                                  hash.ToString(), j),\n+                                         REJECT_NONSTANDARD, \"replacement-adds-unconfirmed\");\n+                }\n+            }\n+\n+            // The replacement must pay greater fees than the transactions it\n+            // replaces - if we did the bandwidth used by those conflicting\n+            // transactions would not be paid for.\n+            if (nFees < nConflictingFees)\n+            {\n+                return state.DoS(0, error(\"AcceptToMemoryPool: rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n+                                          hash.ToString(), FormatMoney(nFees), FormatMoney(nConflictingFees)),\n+                                 REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+\n+            // Finally in addition to paying more fees than the conflicts the\n+            // new transaction must pay for its own bandwidth.\n+            CAmount nDeltaFees = nFees - nConflictingFees;\n+            if (nDeltaFees < ::minRelayTxFee.GetFee(nSize))\n+            {\n+                return state.DoS(0,\n+                        error(\"AcceptToMemoryPool: rejecting replacement %s, not enough additional fees to relay; %s < %s\",\n+                              hash.ToString(),\n+                              FormatMoney(nDeltaFees),\n+                              FormatMoney(::minRelayTxFee.GetFee(nSize))),\n+                        REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+        }\n+\n         // Check against previous transactions\n         // This is done last to help prevent CPU exhaustion denial-of-service attacks.\n         if (!CheckInputs(tx, state, view, true, STANDARD_SCRIPT_VERIFY_FLAGS, true))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45898813",
      "id" : 45898813,
      "original_commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "original_position" : 208,
      "path" : "src/main.cpp",
      "position" : 208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-25T17:58:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45898813",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45899404"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45899404"
         }
      },
      "body" : "Never mind, I misread this line for AreInputsStandard().",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2015-11-25T18:03:39Z",
      "diff_hunk" : "@@ -957,6 +984,160 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather\n+        // than the ones it replaces.\n+        CAmount nConflictingFees = 0;\n+        size_t nConflictingSize = 0;\n+        uint64_t nConflictingCount = 0;\n+        CTxMemPool::setEntries allConflicting;\n+\n+        // If we don't hold the lock allConflicting might be incomplete; the\n+        // subsequent RemoveStaged() and addUnchecked() calls don't guarantee\n+        // mempool consistency for us.\n+        LOCK(pool.cs);\n+        if (setConflicts.size())\n+        {\n+            CFeeRate newFeeRate(nFees, nSize);\n+            set<uint256> setConflictsParents;\n+            const int maxDescendantsToVisit = 100;\n+            CTxMemPool::setEntries setIterConflicting;\n+            BOOST_FOREACH(const uint256 &hashConflicting, setConflicts)\n+            {\n+                CTxMemPool::txiter mi = pool.mapTx.find(hashConflicting);\n+                if (mi == pool.mapTx.end())\n+                    continue;\n+\n+                // Save these to avoid repeated lookups\n+                setIterConflicting.insert(mi);\n+\n+                // If this entry is \"dirty\", then we don't have descendant\n+                // state for this transaction, which means we probably have\n+                // lots of in-mempool descendants.\n+                // Don't allow replacements of dirty transactions, to ensure\n+                // that we don't spend too much time walking descendants.\n+                // This should be rare.\n+                if (mi->IsDirty()) {\n+                    return state.DoS(0,\n+                            error(\"AcceptToMemoryPool: rejecting replacement %s; cannot replace tx %s with untracked descendants\",\n+                                hash.ToString(),\n+                                mi->GetTx().GetHash().ToString()),\n+                            REJECT_NONSTANDARD, \"too many potential replacements\");\n+                }\n+\n+                // Don't allow the replacement to reduce the feerate of the\n+                // mempool.\n+                //\n+                // We usually don't want to accept replacements with lower\n+                // feerates than what they replaced as that would lower the\n+                // feerate of the next block. Requiring that the feerate always\n+                // be increased is also an easy-to-reason about way to prevent\n+                // DoS attacks via replacements.\n+                //\n+                // The mining code doesn't (currently) take children into\n+                // account (CPFP) so we only consider the feerates of\n+                // transactions being directly replaced, not their indirect\n+                // descendants. While that does mean high feerate children are\n+                // ignored when deciding whether or not to replace, we do\n+                // require the replacement to pay more overall fees too,\n+                // mitigating most cases.\n+                CFeeRate oldFeeRate(mi->GetFee(), mi->GetTxSize());\n+                if (newFeeRate <= oldFeeRate)\n+                {\n+                    return state.DoS(0,\n+                            error(\"AcceptToMemoryPool: rejecting replacement %s; new feerate %s <= old feerate %s\",\n+                                  hash.ToString(),\n+                                  newFeeRate.ToString(),\n+                                  oldFeeRate.ToString()),\n+                            REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+                }\n+\n+                BOOST_FOREACH(const CTxIn &txin, mi->GetTx().vin)\n+                {\n+                    setConflictsParents.insert(txin.prevout.hash);\n+                }\n+\n+                nConflictingCount += mi->GetCountWithDescendants();\n+            }\n+            // This potentially overestimates the number of actual descendants\n+            // but we just want to be conservative to avoid doing too much\n+            // work.\n+            if (nConflictingCount <= maxDescendantsToVisit) {\n+                // If not too many to replace, then calculate the set of\n+                // transactions that would have to be evicted\n+                BOOST_FOREACH(CTxMemPool::txiter it, setIterConflicting) {\n+                    pool.CalculateDescendants(it, allConflicting);\n+                }\n+                BOOST_FOREACH(CTxMemPool::txiter it, allConflicting) {\n+                    nConflictingFees += it->GetFee();\n+                    nConflictingSize += it->GetTxSize();\n+                }\n+            } else {\n+                return state.DoS(0,\n+                        error(\"AcceptToMemoryPool: rejecting replacement %s; too many potential replacements (%d > %d)\\n\",\n+                            hash.ToString(),\n+                            nConflictingCount,\n+                            maxDescendantsToVisit),\n+                        REJECT_NONSTANDARD, \"too many potential replacements\");\n+            }\n+\n+            for (unsigned int j = 0; j < tx.vin.size(); j++)\n+            {\n+                // We don't want to accept replacements that require low\n+                // feerate junk to be mined first. Ideally we'd keep track of\n+                // the ancestor feerates and make the decision based on that,\n+                // but for now requiring all new inputs to be confirmed works.\n+                if (!setConflictsParents.count(tx.vin[j].prevout.hash))\n+                {\n+                    // Rather than check the UTXO set - potentially expensive -\n+                    // it's cheaper to just check if the new input refers to a\n+                    // tx that's in the mempool.\n+                    if (pool.mapTx.find(tx.vin[j].prevout.hash) != pool.mapTx.end())\n+                        return state.DoS(0, error(\"AcceptToMemoryPool: replacement %s adds unconfirmed input, idx %d\",\n+                                                  hash.ToString(), j),\n+                                         REJECT_NONSTANDARD, \"replacement-adds-unconfirmed\");\n+                }\n+            }\n+\n+            // The replacement must pay greater fees than the transactions it\n+            // replaces - if we did the bandwidth used by those conflicting\n+            // transactions would not be paid for.\n+            if (nFees < nConflictingFees)\n+            {\n+                return state.DoS(0, error(\"AcceptToMemoryPool: rejecting replacement %s, less fees than conflicting txs; %s < %s\",\n+                                          hash.ToString(), FormatMoney(nFees), FormatMoney(nConflictingFees)),\n+                                 REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+\n+            // Finally in addition to paying more fees than the conflicts the\n+            // new transaction must pay for its own bandwidth.\n+            CAmount nDeltaFees = nFees - nConflictingFees;\n+            if (nDeltaFees < ::minRelayTxFee.GetFee(nSize))\n+            {\n+                return state.DoS(0,\n+                        error(\"AcceptToMemoryPool: rejecting replacement %s, not enough additional fees to relay; %s < %s\",\n+                              hash.ToString(),\n+                              FormatMoney(nDeltaFees),\n+                              FormatMoney(::minRelayTxFee.GetFee(nSize))),\n+                        REJECT_INSUFFICIENTFEE, \"insufficient fee\");\n+            }\n+        }\n+\n         // Check against previous transactions\n         // This is done last to help prevent CPU exhaustion denial-of-service attacks.\n         if (!CheckInputs(tx, state, view, true, STANDARD_SCRIPT_VERIFY_FLAGS, true))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r45899404",
      "id" : 45899404,
      "original_commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "original_position" : 208,
      "path" : "src/main.cpp",
      "position" : 208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2015-11-25T18:03:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/45899404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Is a higher sequence number still preferred?\r\nIn the case of a fee tie?\r\n\r\n> specifically both a higher fee per KB and a higher absolute fee\r\n\r\nOr only the higher fee?\r\n\r\nWhat is the behaviour if a transaction is broadcast with the sequence number `0xffffffff` after a transaction was already found that was 'opt-in'?",
      "created_at" : "2015-11-26T01:13:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-159772336",
      "id" : 159772336,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-26T01:14:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/159772336",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "@dcousens Just higher fee. Ties get rejected to avoid them being used as a way to waste bandwidth.\r\n\r\nIf a nSequence > maxint-2 transaction is broadcast it is subject to the same rules as any other replacement; it won't get accepted without paying a (sufficiently) higher fee. That said, if it is accepted further replacements will be rejected. The replacement behavior is stateless, acting only on what is in the mempool right now.",
      "created_at" : "2015-11-26T01:16:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-159772689",
      "id" : 159772689,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-26T01:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/159772689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Thanks for clarifying that @petertodd :+1: \r\n\r\n@kristovatlas I wonder if the 'default' sequence number when opting into RBF should just be `0` then? \r\nJust thinking of the privacy implications.",
      "created_at" : "2015-11-26T01:54:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-159778915",
      "id" : 159778915,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-26T01:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/159778915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "@dcousens nSequence=0 makes sense from the perspective of https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki too.",
      "created_at" : "2015-11-26T02:00:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-159780063",
      "id" : 159780063,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-26T02:00:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/159780063",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "@dcousens defaulting to nSequence=0 for the purpose of reducing wallet client fingerprintability makes sense to me.\r\n",
      "created_at" : "2015-11-27T22:31:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#issuecomment-160222244",
      "id" : 160222244,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6871",
      "updated_at" : "2015-11-27T22:31:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/160222244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7227529?v=3",
         "events_url" : "https://api.github.com/users/kristovatlas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristovatlas/followers",
         "following_url" : "https://api.github.com/users/kristovatlas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristovatlas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristovatlas",
         "id" : 7227529,
         "login" : "kristovatlas",
         "organizations_url" : "https://api.github.com/users/kristovatlas/orgs",
         "received_events_url" : "https://api.github.com/users/kristovatlas/received_events",
         "repos_url" : "https://api.github.com/users/kristovatlas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristovatlas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristovatlas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristovatlas"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r76198016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/76198016"
         }
      },
      "body" : "The following was later removed by #7594",
      "commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "created_at" : "2016-08-25T08:08:57Z",
      "diff_hunk" : "@@ -957,6 +984,160 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"too-long-mempool-chain\", false, errString);\n         }\n \n+        // A transaction that spends outputs that would be replaced by it is invalid. Now\n+        // that we have the set of all ancestors we can detect this\n+        // pathological case by making sure setConflicts and setAncestors don't\n+        // intersect.\n+        BOOST_FOREACH(CTxMemPool::txiter ancestorIt, setAncestors)\n+        {\n+            const uint256 &hashAncestor = ancestorIt->GetTx().GetHash();\n+            if (setConflicts.count(hashAncestor))\n+            {\n+                return state.DoS(10, error(\"AcceptToMemoryPool: %s spends conflicting transaction %s\",\n+                                           hash.ToString(),\n+                                           hashAncestor.ToString()),\n+                                 REJECT_INVALID, \"bad-txns-spends-conflicting-tx\");\n+            }\n+        }\n+\n+        // Check if it's economically rational to mine this transaction rather\n+        // than the ones it replaces.\n+        CAmount nConflictingFees = 0;\n+        size_t nConflictingSize = 0;\n+        uint64_t nConflictingCount = 0;\n+        CTxMemPool::setEntries allConflicting;\n+\n+        // If we don't hold the lock allConflicting might be incomplete; the\n+        // subsequent RemoveStaged() and addUnchecked() calls don't guarantee\n+        // mempool consistency for us.\n+        LOCK(pool.cs);\n+        if (setConflicts.size())\n+        {\n+            CFeeRate newFeeRate(nFees, nSize);\n+            set<uint256> setConflictsParents;\n+            const int maxDescendantsToVisit = 100;\n+            CTxMemPool::setEntries setIterConflicting;\n+            BOOST_FOREACH(const uint256 &hashConflicting, setConflicts)\n+            {\n+                CTxMemPool::txiter mi = pool.mapTx.find(hashConflicting);\n+                if (mi == pool.mapTx.end())\n+                    continue;\n+\n+                // Save these to avoid repeated lookups\n+                setIterConflicting.insert(mi);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6871#discussion_r76198016",
      "id" : 76198016,
      "original_commit_id" : "63b5840257a0b892228dfa9cce943b5a2bb94e1a",
      "original_position" : 93,
      "path" : "src/main.cpp",
      "position" : 93,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6871",
      "updated_at" : "2016-08-25T08:08:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/76198016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   }
]
