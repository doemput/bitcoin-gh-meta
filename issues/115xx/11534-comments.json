[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146064942"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146064942"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this only meant for tests?\r\n\r\nOtherwise replace the following code with a call to this function?\r\nhttps://github.com/bitcoin/bitcoin/blob/ff92fbf24739a022eb677daab03c87c5e6971094/src/net.cpp#L1140-L1143",
      "commit_id" : "c071f62e2138140c34be097bebec5f0debe9b269",
      "created_at" : "2017-10-20T20:56:22Z",
      "diff_hunk" : "@@ -2862,3 +2878,15 @@ uint64_t CConnman::CalculateKeyedNetGroup(const CAddress& ad) const\n \n     return GetDeterministicRandomizer(RANDOMIZER_ID_NETGROUP).Write(vchNetGroup.data(), vchNetGroup.size()).Finalize();\n }\n+\n+void CConnman::AddToVNodes(CNode &node)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146064942",
      "id" : 146064942,
      "original_commit_id" : "2ea6f2cf077e02d0ee1c7f34bfdb7c890ea78aee",
      "original_position" : 35,
      "path" : "src/net.cpp",
      "position" : 42,
      "pull_request_review_id" : 70963913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534",
      "updated_at" : "2017-10-23T12:48:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146064942",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146101422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146101422"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah this is only for the unit test; I'm hoping someone is able to suggest a better way of doing this than what I did here to get the test working.",
      "commit_id" : "c071f62e2138140c34be097bebec5f0debe9b269",
      "created_at" : "2017-10-21T09:27:41Z",
      "diff_hunk" : "@@ -2862,3 +2878,15 @@ uint64_t CConnman::CalculateKeyedNetGroup(const CAddress& ad) const\n \n     return GetDeterministicRandomizer(RANDOMIZER_ID_NETGROUP).Write(vchNetGroup.data(), vchNetGroup.size()).Finalize();\n }\n+\n+void CConnman::AddToVNodes(CNode &node)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146101422",
      "id" : 146101422,
      "in_reply_to_id" : 146064942,
      "original_commit_id" : "2ea6f2cf077e02d0ee1c7f34bfdb7c890ea78aee",
      "original_position" : 35,
      "path" : "src/net.cpp",
      "position" : 42,
      "pull_request_review_id" : 71003479,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534",
      "updated_at" : "2017-10-23T12:48:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146101422",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146486372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146486372"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@sdaftuar see 6f6e7e0 for an alternative that doesn't change the *production* interface.",
      "commit_id" : "c071f62e2138140c34be097bebec5f0debe9b269",
      "created_at" : "2017-10-24T08:27:44Z",
      "diff_hunk" : "@@ -2862,3 +2878,15 @@ uint64_t CConnman::CalculateKeyedNetGroup(const CAddress& ad) const\n \n     return GetDeterministicRandomizer(RANDOMIZER_ID_NETGROUP).Write(vchNetGroup.data(), vchNetGroup.size()).Finalize();\n }\n+\n+void CConnman::AddToVNodes(CNode &node)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146486372",
      "id" : 146486372,
      "in_reply_to_id" : 146064942,
      "original_commit_id" : "2ea6f2cf077e02d0ee1c7f34bfdb7c890ea78aee",
      "original_position" : 35,
      "path" : "src/net.cpp",
      "position" : 42,
      "pull_request_review_id" : 71433030,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534",
      "updated_at" : "2017-10-24T08:27:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146486372",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146630355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146630355"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm ok with leaving the hacks for now, though please make them private and a friend to the boost test functions.\r\n\r\nAfter we merge #11457 (and the follow-up for addrman: https://github.com/theuni/bitcoin/tree/move-addrdb), I believe we'll have enough broken out to create 2 CConnman instances and run them against each-other for these tests. At that point, we can remove the test hacks.",
      "commit_id" : "c071f62e2138140c34be097bebec5f0debe9b269",
      "created_at" : "2017-10-24T17:14:54Z",
      "diff_hunk" : "@@ -2862,3 +2878,15 @@ uint64_t CConnman::CalculateKeyedNetGroup(const CAddress& ad) const\n \n     return GetDeterministicRandomizer(RANDOMIZER_ID_NETGROUP).Write(vchNetGroup.data(), vchNetGroup.size()).Finalize();\n }\n+\n+void CConnman::AddToVNodes(CNode &node)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146630355",
      "id" : 146630355,
      "in_reply_to_id" : 146064942,
      "original_commit_id" : "2ea6f2cf077e02d0ee1c7f34bfdb7c890ea78aee",
      "original_position" : 35,
      "path" : "src/net.cpp",
      "position" : 42,
      "pull_request_review_id" : 71600215,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534",
      "updated_at" : "2017-10-24T17:14:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146630355",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146675367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146675367"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder if we might turn this logic around: rather than marking for disconnection, mark for protection from disconnection. For example, each time we get a new header that extends our tip, we could do:\r\n```\r\nconnman->ResetOutboundEvictionTimer(id, current_time + new_timeout);\r\n```\r\nThen when we need a connection slot, if any timer has expred, whichever has been expired the longest gets dropped.\r\nThat saves us from having to care about what type of node (inbound/outbound/oneshot/manual/etc.) this is, and just lets outbound eviction do its thing if the criteria are met.",
      "commit_id" : "c071f62e2138140c34be097bebec5f0debe9b269",
      "created_at" : "2017-10-24T19:59:52Z",
      "diff_hunk" : "@@ -3334,6 +3388,58 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // TODO: This logic is not peer-specific, so it doesn't really make\n+        // sense in SendMessages; move this somewhere more fitting.\n+        // Our goal here is to avoid being connected to a set of outbound peers\n+        // which are all refusing to relay valid blocks to us.\n+        // Strategy: if too much time has passed since we last updated our tip,\n+        // mark the outbound peer with the least recent block announcement as\n+        // evictable by our net.cpp code (which will only evict if we are at\n+        // our outbound peer limit).\n+        // If multiple peers are tied for least recently announcing a\n+        // block to us, prefer to evict the newest peer -- this prevents us\n+        // from cycling through all our peers in the event that blocks are just\n+        // slow to be found on our chain.\n+        if (time_in_seconds > g_tip_stale_check_time) {\n+            if (TipMayBeStale(consensusParams)) {\n+                // Mark our \"worst\" outbound peer for potential eviction, in\n+                // the hopes of finding an outbound peer who has a new block.\n+                NodeId worst_peer = -1;\n+                int64_t oldest_block_announcement = GetTime();\n+                int64_t worst_peer_connect_time = 0;\n+                for (auto it = mapNodeState.begin(); it != mapNodeState.end(); ++it) {\n+                    int64_t connect_time = 0;\n+                    if (connman->ForNode(it->first, [&](CNode *pnode){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146675367",
      "id" : 146675367,
      "original_commit_id" : "c071f62e2138140c34be097bebec5f0debe9b269",
      "original_position" : 149,
      "path" : "src/net_processing.cpp",
      "position" : 257,
      "pull_request_review_id" : 71652540,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534",
      "updated_at" : "2017-10-24T19:59:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146675367",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146676213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146676213"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Move these into PeerLogicValidation ?",
      "commit_id" : "c071f62e2138140c34be097bebec5f0debe9b269",
      "created_at" : "2017-10-24T20:03:17Z",
      "diff_hunk" : "@@ -127,6 +127,12 @@ namespace {\n     /** Number of outbound peers with m_protect_from_disconnect. */\n     int g_outbound_peers_with_protect_from_disconnect = 0;\n \n+    /** When to next check whether our tip is stale. */\n+    int64_t g_tip_stale_check_time = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11534#discussion_r146676213",
      "id" : 146676213,
      "original_commit_id" : "c071f62e2138140c34be097bebec5f0debe9b269",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71653535,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11534",
      "updated_at" : "2017-10-24T20:03:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146676213",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
