{
   "assignee" : null,
   "body" : "The big idea: if a peer is sending you obviously wrong information, punish it by maybe dropping your connection to it, and ban it's IP address so it cannot immediately re-connect.\r\n\r\nThe probability of dropping the connection, and the length of the ban, depend on how wrong, and how potentially wasteful/damaging, the peer is.  So sending an extra 'version' message is a minor transgression that is usually tolerated, sending an more than MAX_BLOCK_SIZE block is a major transgression.\r\n\r\nDetailed how-it-works, using \"I got a version message I wasn't expecting\" as the specific example:\r\n\r\nGetting a version message from a peer increases that peer's 'misbehaving' score by 10, and (assuming that is the peer's first bad behavior) gives it a 10% of being disconnected.  If it is disconnected, then that peer's IP address is banned from connecting for a couple of hours.  If it is not disconnected, then nothing happens unless the peer misbehaves again; if it does, then its chances of being disconnected go up, and the length of time it will be banned increases.\r\n\r\nMisbehavior/ban information is stored only in memory, and information about misbehaving peers is never broadcast. Also, peers that are disconnected/banned are just dropped, there is no warning or reason sent.\r\n\r\nI think this will eliminate a lot of potential denial-of-service attacks, and could be a good framework for responding to other potential attacks. \"We\" should still look through the code and limit the potential size of any data structures that an attacker might target (transaction pool, orphan block pool); the DoSprevention changes are meant to make it harder for an attacker to stay connected long enough to pull off an attack.\r\n\r\nThe danger is that I got something wrong; what if an attacker can leverage the DoSprevention code to split or shatter the network? Here's my thinking on that, please help check my work:\r\n\r\n+ I'm relying on TCP to prevent IP address spoofing (otherwise an attacker could force you to disconnect from your peers by pretending to be them and sending you a bad block).\r\n\r\n+ Peers are only penalized for sending messages that won't, and shouldn't, get relayed. So an attacker shouldn't be able to poison the network with a bad message that is propogated and then causes everybody to disconnect from everybody else.\r\n\r\n+ I specifically do not punish peers for relaying what look like double-spend transactions. If I did, then an attacker could try to segment the network into two pieces by broadcasting a series of double-spends from two halves of the network, and waiting until the nodes \"in the middle\" disconnected/banned across the 'seam'.\r\n\r\nSo: please let me know if or how I'm being an idiot.\r\n\r\nI'm still thinking about the best way of testing this; at the very least, running a node for several days with this patch applied should result in a minimal number of \"disconnected %s for misbheavior\" messages in debug.log.\r\n\r\n",
   "closed_at" : "2011-09-26T13:06:17Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
      "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
      "followers_url" : "https://api.github.com/users/gavinandresen/followers",
      "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/gavinandresen",
      "id" : 331997,
      "login" : "gavinandresen",
      "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
      "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
      "repos_url" : "https://api.github.com/users/gavinandresen/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/gavinandresen"
   },
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/517/comments",
   "created_at" : "2011-09-14T19:54:32Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/517/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/517",
   "id" : 1646885,
   "labels" : [
      {
         "color" : "e10c02",
         "name" : "Priority High",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Priority%20High"
      },
      {
         "color" : "E6F6D6",
         "name" : "Refactoring",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/517/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 517,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/517.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/517",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/517.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/517"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Denial-of-service prevention",
   "updated_at" : "2014-07-05T22:36:13Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/517",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
      "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
      "followers_url" : "https://api.github.com/users/gavinandresen/followers",
      "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/gavinandresen",
      "id" : 331997,
      "login" : "gavinandresen",
      "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
      "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
      "repos_url" : "https://api.github.com/users/gavinandresen/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/gavinandresen"
   }
}
