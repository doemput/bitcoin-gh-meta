[
   {
      "body" : "This mixed locking for mapNodeState is not particularly easy to reason about.\r\n\r\nWhat about creating a separate map (alongside mapNodeState) for storing misbehaviour information? Longer term, we'll want to see mapNodeState (and the processing-related data in CNode itself) split up into multiple modules (each with their own state) anyway.",
      "created_at" : "2016-06-05T15:42:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-223820229",
      "id" : 223820229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-05T15:42:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/223820229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "That does sound better. I didn't like protecting the struct with different locks but I was trying to avoid the overhead of a new map. Reimplemented with a CMisbehaviorTracker that encapsulates its lock. TODO before mergeable: add unit tests for the new class.",
      "created_at" : "2016-06-05T21:19:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-223838347",
      "id" : 223838347,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-05T21:19:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/223838347",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65904015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65904015"
         }
      },
      "body" : "Is the std::move necessary here, if nameIn is already an rvalue reference?",
      "commit_id" : "ae3c24040cfef500daf5c4b890d1cabe2e191d9a",
      "created_at" : "2016-06-06T14:52:13Z",
      "diff_hunk" : "@@ -300,6 +296,97 @@ CNodeState *State(NodeId pnode) {\n     return &it->second;\n }\n \n+class CMisbehaviorTracker {\n+    typedef std::lock_guard<std::mutex> lock_guard;\n+    struct Info {\n+        const std::string name;\n+        int badness;\n+        bool ban;\n+        Info(std::string&& nameIn, int badnessIn, bool banIn) : name(std::move(nameIn)), badness(badnessIn), ban(banIn) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65904015",
      "id" : 65904015,
      "original_commit_id" : "291644ef7b3b9ede12572b9d03580ab82e8d4252",
      "original_position" : 40,
      "path" : "src/main.cpp",
      "position" : 40,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147",
      "updated_at" : "2016-06-06T16:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65904015",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65908907"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65908907"
         }
      },
      "body" : "Indentation?",
      "commit_id" : "ae3c24040cfef500daf5c4b890d1cabe2e191d9a",
      "created_at" : "2016-06-06T15:15:57Z",
      "diff_hunk" : "@@ -300,6 +296,97 @@ CNodeState *State(NodeId pnode) {\n     return &it->second;\n }\n \n+class CMisbehaviorTracker {\n+    typedef std::lock_guard<std::mutex> lock_guard;\n+    struct Info {\n+        const std::string name;\n+        int badness;\n+        bool ban;\n+        Info(std::string&& nameIn, int badnessIn, bool banIn) : name(std::move(nameIn)), badness(badnessIn), ban(banIn) {}\n+    };\n+public:\n+    CMisbehaviorTracker()\n+        : cs()\n+        , map()\n+        , banscore()\n+    {}\n+\n+    // node must not already be registered\n+    void Register(NodeId node, std::string name) {\n+        lock_guard guard{cs};\n+        auto ret = map.emplace(std::piecewise_construct,\n+            std::forward_as_tuple(node),\n+            std::forward_as_tuple(std::move(name), 0, false));\n+        assert(ret.second);\n+    }\n+\n+    // node must be registered\n+    // returns the misbehavior score of the removed node\n+    int Unregister(NodeId node) {\n+        lock_guard guard{cs};\n+        auto it = map.find(node);\n+        assert(it != map.end());\n+        auto nMis = it->second.badness;\n+        map.erase(it);\n+        return nMis;\n+    }\n+\n+    // returns false if node is not registered\n+    bool Get(NodeId node, int& nMisbehaviorOut) const {\n+        lock_guard guard{cs};\n+        auto it = map.find(node);\n+        if (it == map.end())\n+            return false;\n+        nMisbehaviorOut = it->second.badness;\n+        return true;\n+    }\n+\n+    // returns false if node is not registered\n+    bool Increase(NodeId node, int delta)\n+    {\n+        std::string logentry;\n+        {\n+        lock_guard guard{cs};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65908907",
      "id" : 65908907,
      "original_commit_id" : "291644ef7b3b9ede12572b9d03580ab82e8d4252",
      "original_position" : 84,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147",
      "updated_at" : "2016-06-06T16:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65908907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Nice, utACK with 2 nits, but needs rebase.",
      "created_at" : "2016-06-06T15:26:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-223993572",
      "id" : 223993572,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-06T15:26:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/223993572",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65916528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65916528"
         }
      },
      "body" : "The `Info` ctor accepts an rvalue reference and binds it to `nameIn`, making it an lvalue.",
      "commit_id" : "ae3c24040cfef500daf5c4b890d1cabe2e191d9a",
      "created_at" : "2016-06-06T15:54:27Z",
      "diff_hunk" : "@@ -300,6 +296,97 @@ CNodeState *State(NodeId pnode) {\n     return &it->second;\n }\n \n+class CMisbehaviorTracker {\n+    typedef std::lock_guard<std::mutex> lock_guard;\n+    struct Info {\n+        const std::string name;\n+        int badness;\n+        bool ban;\n+        Info(std::string&& nameIn, int badnessIn, bool banIn) : name(std::move(nameIn)), badness(badnessIn), ban(banIn) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65916528",
      "id" : 65916528,
      "original_commit_id" : "291644ef7b3b9ede12572b9d03580ab82e8d4252",
      "original_position" : 40,
      "path" : "src/main.cpp",
      "position" : 40,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147",
      "updated_at" : "2016-06-06T16:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65916528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "body" : "Rebased and fixed indentation.",
      "created_at" : "2016-06-06T16:01:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-224004335",
      "id" : 224004335,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-06T16:01:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/224004335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65920308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65920308"
         }
      },
      "body" : "Thanks for clearing that up, I'm still learning all the details related to rvalue reference semantics. I'm starting to understand the necessity of all the logic related to forwarding arguments...",
      "commit_id" : "ae3c24040cfef500daf5c4b890d1cabe2e191d9a",
      "created_at" : "2016-06-06T16:15:38Z",
      "diff_hunk" : "@@ -300,6 +296,97 @@ CNodeState *State(NodeId pnode) {\n     return &it->second;\n }\n \n+class CMisbehaviorTracker {\n+    typedef std::lock_guard<std::mutex> lock_guard;\n+    struct Info {\n+        const std::string name;\n+        int badness;\n+        bool ban;\n+        Info(std::string&& nameIn, int badnessIn, bool banIn) : name(std::move(nameIn)), badness(badnessIn), ban(banIn) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65920308",
      "id" : 65920308,
      "original_commit_id" : "291644ef7b3b9ede12572b9d03580ab82e8d4252",
      "original_position" : 40,
      "path" : "src/main.cpp",
      "position" : 40,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147",
      "updated_at" : "2016-06-06T16:15:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65920308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "utACK ae3c24040cfef500daf5c4b890d1cabe2e191d9a",
      "created_at" : "2016-06-06T16:21:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-224009866",
      "id" : 224009866,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-06T16:21:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/224009866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Some things about this design bug me, but I think I found a solution to my API nits that could fit well with future main state encapsulation improvements too.\r\n\r\n(TLDR; minor reimplementation coming soon)\r\n\r\nThis interface is inconsistent about what happens when an unregistered NodeId is referenced; for some functions it's an internal error, for others it's an expected possibility. It works, because some callers know their NodeId is in a registered state -- they have access to the CNode. I'm thinking of putting a `NodeInfo*` into CNode, that would be an opaque handle as far as net or main code is concerned. A single-domain node info manager like the misbehavior tracker would store its per-node data in a private object within the `NodeInfo`. This would clear up not-found handling: all node info functions require a handle (which implies that the CNode is live); access through a NodeId requires first trying to obtain a handle (using a global map with its own lock). It also eliminates the need for map lookups in some common cases and the need for a new map for each encapsulated domain.\r\n\r\nIt's similar to the existing `mapNodeState`, but has some important differences: the node info is accessible from a `CNode` with the assurance that the info object exists; access that doesn't require a lookup from a NodeId doesn't require any synchronization outside what the domain-info manager requires (which could be very little for something like the misbehavior tracker); and of course, the encapsulation.",
      "created_at" : "2016-06-10T14:56:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225205324",
      "id" : 225205324,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-10T14:56:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/225205324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "body" : "Long term, I think having the CNodeState pointed to by CNode is wrong: the\nnetwork layer should not depend on the message handlers that are\nimplemented elsewhere (and especially not on main, where they are now).\n\nIdeally, CNode becomes private inside net, and is never exposed. Message\nhandlers get called with the NodeId passed to them, and sending messages in\ndone through a function exposed from net that takes a NodeId.\n",
      "created_at" : "2016-06-10T15:01:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225206764",
      "id" : 225206764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-10T15:01:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/225206764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Codifying expectations about lifetime with the NodeInfo handle can be done orthogonally to CNode encapsulation: If InitializeNode assigns the NodeIds, they could be the NodeInfo handles (`typedef shared_ptr<NodeInfo> NodeId`). Getting the NodeInfo handle in the message handler would be the same as getting the NodeId in the message handler (currently with CNode::GetId, eventually as a parameter to the message handler). My previous distinction between having a NodeInfo handle and having a NodeId becomes the distinction between having a shared_ptr<NodeInfo> and a weak_ptr<NodeInfo>.",
      "created_at" : "2016-06-10T17:10:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225240666",
      "id" : 225240666,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-10T17:10:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/225240666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "body" : "Many of those problems are already solved by #8085, so I'd like to very much request that we get that in before messing with CNode/CNodeState refactors.\r\n\r\n@sipa that PR works towards exactly what you describe. CNodes are no longer generally accessible except by proxy through CConnman, which also takes care of messages to keep CNodeState in sync without CNode having to know anything about it. In fact, CConnman doesn't know anything about CNodeState, it simply fires off signals when interesting things happen.",
      "created_at" : "2016-06-10T17:49:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225249760",
      "id" : 225249760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-10T17:49:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/225249760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@theuni I'm excited to see that p2p refactor land, it's much needed work. I think I can make these changes for more encapsulated, cs_main-less CNodeState data without any nontrivial conflict with that PR. NodeIds are mostly opaque to the net layer and the net layer doesn't know anything about CNodeStates. There are a couple lines of changes for this that would overlap (moving NodeId assignment out of net), so I'll write my changes to be applied after your PR.",
      "created_at" : "2016-06-10T18:25:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225259029",
      "id" : 225259029,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-10T18:25:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/225259029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "body" : "@kazcw That sounds great, thanks! Also, maybe I could convince you to review that PR when you've got some time, since some of this is fresh in your mind :)",
      "created_at" : "2016-06-10T18:33:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225261239",
      "id" : 225261239,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-10T18:33:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/225261239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "I'm going to break much smaller independent changes out of this for separate merging (with the eventual actual modularization being pure code movement). It seems like separating misbehavior from cs_main properly depends on the first steps of modularization. This PR is superseded by the coming incremental changes.",
      "created_at" : "2016-06-17T07:19:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-226698377",
      "id" : 226698377,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-17T07:19:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/226698377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   }
]
