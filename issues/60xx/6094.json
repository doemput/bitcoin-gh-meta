{
   "assignee" : null,
   "body" : "This builds off of #6089, with more fixes for the python p2p testing framework (see #5981).\r\n\r\nPreviously, each ```NodeConnCB``` had its own lock to synchronize data structures used by the testing thread and the networking thread, and ```NodeConn``` provided a separate additional lock for synchronizing access to each send buffer.  However, there was no existing lock to protect other data structures that are not specific to a single ```NodeConnCB```, such as ```BlockStore``` or ```TxStore```, which are created in ```comptool.py``` and shared by all the ```NodeConnCB``` instances.\r\n\r\nMoreover ```comptool.py``` had a race condition because it wasn't synchronizing access to the ```BlockStore```, nor using the existing ```NodeConnCB``` locks before accessing the ```block_request_map``` inside the ```comptool.py``` ```TestNode``` objects.  I believe this type of race condition triggered a test failure reported in #5981.\r\n\r\nThis pull tries to simplify the synchronization and make the code more robust to race conditions by replacing all the individual locks one single global lock that we now use to synchronize the two threads.  The networking thread acquires this lock before delivering every message; ```NodeConn.send_message()``` uses this lock to synchronize access to the ```sendbuf```; and the thread running the test logic will now acquire this lock before accessing any data shared with one or more ```NodeConnCB``` or ```NodeConn``` objects.",
   "closed_at" : "2015-05-04T05:53:15Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6094/comments",
   "created_at" : "2015-05-01T19:55:07Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6094/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/6094",
   "id" : 72508991,
   "labels" : [
      {
         "color" : "d4c5f9",
         "name" : "Tests",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6094/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 6094,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/6094.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6094",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/6094.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6094"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Python P2P testing bugfixes: rework locking to eliminate race conditions and fix comptool.py",
   "updated_at" : "2015-05-04T05:53:15Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6094",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
      "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sdaftuar/followers",
      "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sdaftuar",
      "id" : 7463573,
      "login" : "sdaftuar",
      "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
      "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
      "repos_url" : "https://api.github.com/users/sdaftuar/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sdaftuar"
   }
}
