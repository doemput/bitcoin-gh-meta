[
   {
      "body" : "I'm not super enthusiastic of using work as a float here, but it seems correct and harmless.\r\n\r\nutACK. (I don't currently have something setup to test this specific behavior.)",
      "created_at" : "2015-03-20T22:06:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-84166533",
      "id" : 84166533,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-03-20T22:06:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/84166533",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Updated to use uint256 arithmetic.",
      "created_at" : "2015-03-23T13:30:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-84997635",
      "id" : 84997635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-03-23T13:30:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/84997635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "utACK",
      "created_at" : "2015-03-24T09:52:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-85427094",
      "id" : 85427094,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-03-24T09:52:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/85427094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "This patch is running on bitcoin.sipa.be, if someone wants to test whether syncing works. ",
      "created_at" : "2015-03-24T11:58:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-85467095",
      "id" : 85467095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-03-24T11:58:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/85467095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "ACK",
      "created_at" : "2015-04-01T18:17:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-88583029",
      "id" : 88583029,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-04-01T18:17:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/88583029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@sergiodemianlerner Feel like commenting?",
      "created_at" : "2015-04-08T17:02:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-90975548",
      "id" : 90975548,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-04-08T17:02:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/90975548",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "When *mi->second has greater nChainWork than *pindexBestHeader, then subtraction in GetBlockProofEquivalentTime() will overflow the uint256 and zero wrap. Multiplication by TargetSpacing() can also overflow the uint256. This will prevent the block from being served.\r\nOf course, mi->second should never have more chain work than the tip (if it does it would become the new tip).\r\nNevertheless, as a protective layer against other bugs, I would add a condition that if mi->second has greater nChainWork than the tip, the block is always served.\r\n",
      "created_at" : "2015-04-17T20:44:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-94071219",
      "id" : 94071219,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-04-17T20:44:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/94071219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "body" : "@SergioDemianLerner how about an assert?  (if that case ever becomes possible, then something is horribly wrong; I think.)",
      "created_at" : "2015-04-17T21:24:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-94078311",
      "id" : 94078311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-04-17T21:24:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/94078311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@SergioDemianLerner how about an assert?  (if that case ever becomes possible, then something is horribly wrong; I think.)",
      "created_at" : "2015-04-17T22:28:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-94088531",
      "id" : 94088531,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-04-17T22:28:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/94088531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell  I'm not sure an assert makes sense here; the way the code seems to be structured now is that we don't generally hold a lock on cs_main in between updating mapBlockIndex (after receiving a block) and calling ActivateBestChain, so accessing chainActive.Tip() in between could result in an assertion failure.\r\n\r\nI can't think of how this could occur outside of an interaction with the invalidateblock rpc call, but for example if you look at the implementation for invalidateblock, it calls InvalidateBlock while holding cs_main, then releases the lock and calls ActivateBestChain (which will lock cs_main itself where it needs to).  In between, it could be the case that some other VALID_SCRIPTS block has more work than chainActive.Tip().\r\n\r\nPerhaps we should clarify precisely what the semantics ought to be for chainActive.Tip(): should it only be accessible if it reflects all known information about what the best chain should be?",
      "created_at" : "2015-04-20T15:46:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-94489095",
      "id" : 94489095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-04-20T15:46:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/94489095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Let's just fix the code to deal with negatives.\n",
      "created_at" : "2015-04-20T16:00:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-94493355",
      "id" : 94493355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-04-20T16:00:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/94493355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Updated.",
      "created_at" : "2015-04-21T15:32:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-94839987",
      "id" : 94839987,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-04-21T15:32:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/94839987",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5918#discussion_r28794953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5918"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28794953"
         }
      },
      "body" : "Is this supposed to be < nOneMonth?\n",
      "commit_id" : "f7303f97933be33e34d482cf8348d180c8da2a26",
      "created_at" : "2015-04-21T16:18:10Z",
      "diff_hunk" : "@@ -3487,11 +3486,13 @@ void static ProcessGetData(CNode* pfrom)\n                     if (chainActive.Contains(mi->second)) {\n                         send = true;\n                     } else {\n+                        static const int nOneMonth = 30 * 24 * 60 * 60;\n                         // To prevent fingerprinting attacks, only send blocks outside of the active\n-                        // chain if they are valid, and no more than a month older than the best header\n-                        // chain we know about.\n+                        // chain if they are valid, and no more than a month older (both in time, and in\n+                        // best equivalent proof of work) than the best header chain we know about.\n                         send = mi->second->IsValid(BLOCK_VALID_SCRIPTS) && (pindexBestHeader != NULL) &&\n-                            (mi->second->GetBlockTime() > pindexBestHeader->GetBlockTime() - 30 * 24 * 60 * 60);\n+                            (mi->second->GetBlockTime() > pindexBestHeader->GetBlockTime() - nOneMonth) &&\n+                            (GetBlockProofEquivalentTime(*mi->second, *pindexBestHeader, *pindexBestHeader) > nOneMonth);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#discussion_r28794953",
      "id" : 28794953,
      "original_commit_id" : "ae84ff31e44fae587b5311b19fe9ac5f391d0844",
      "original_position" : 21,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5918",
      "updated_at" : "2015-04-22T10:55:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28794953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5918#discussion_r28799035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5918"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28799035"
         }
      },
      "body" : "Ugh, yes. This is why code like this needs tests...\n",
      "commit_id" : "f7303f97933be33e34d482cf8348d180c8da2a26",
      "created_at" : "2015-04-21T17:01:56Z",
      "diff_hunk" : "@@ -3487,11 +3486,13 @@ void static ProcessGetData(CNode* pfrom)\n                     if (chainActive.Contains(mi->second)) {\n                         send = true;\n                     } else {\n+                        static const int nOneMonth = 30 * 24 * 60 * 60;\n                         // To prevent fingerprinting attacks, only send blocks outside of the active\n-                        // chain if they are valid, and no more than a month older than the best header\n-                        // chain we know about.\n+                        // chain if they are valid, and no more than a month older (both in time, and in\n+                        // best equivalent proof of work) than the best header chain we know about.\n                         send = mi->second->IsValid(BLOCK_VALID_SCRIPTS) && (pindexBestHeader != NULL) &&\n-                            (mi->second->GetBlockTime() > pindexBestHeader->GetBlockTime() - 30 * 24 * 60 * 60);\n+                            (mi->second->GetBlockTime() > pindexBestHeader->GetBlockTime() - nOneMonth) &&\n+                            (GetBlockProofEquivalentTime(*mi->second, *pindexBestHeader, *pindexBestHeader) > nOneMonth);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#discussion_r28799035",
      "id" : 28799035,
      "original_commit_id" : "ae84ff31e44fae587b5311b19fe9ac5f391d0844",
      "original_position" : 21,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5918",
      "updated_at" : "2015-04-22T10:55:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28799035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "* Rebased\r\n* Changed the argument order of GetBlockProofEquivalentTime(a, b, c, d) to be identical to a->GetBlockTime () - b->GetBlockTime().\r\n* Changed the order of calls in the fingerprinting test to be consistent with this.\r\n* Passed Consensus::Params as an argument (make @jtimon happy).\r\n* Added a simple unit test.\r\n",
      "created_at" : "2015-04-22T11:01:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-95137964",
      "id" : 95137964,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-04-22T11:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/95137964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "ACK",
      "created_at" : "2015-04-27T14:43:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#issuecomment-96681187",
      "id" : 96681187,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5918",
      "updated_at" : "2015-04-27T14:43:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/96681187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5918#discussion_r93781353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5918"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93781353"
         }
      },
      "body" : "nPowTargetSpacing, which always equals 600 regardless.... why can't this just be a global variable? It would save having to pass around the params everywhere.",
      "commit_id" : "f7303f97933be33e34d482cf8348d180c8da2a26",
      "created_at" : "2016-12-23T16:19:12Z",
      "diff_hunk" : "@@ -114,3 +114,20 @@ arith_uint256 GetBlockProof(const CBlockIndex& block)\n     // or ~bnTarget / (nTarget+1) + 1.\n     return (~bnTarget / (bnTarget + 1)) + 1;\n }\n+\n+int64_t GetBlockProofEquivalentTime(const CBlockIndex& to, const CBlockIndex& from, const CBlockIndex& tip, const Consensus::Params& params)\n+{\n+    arith_uint256 r;\n+    int sign = 1;\n+    if (to.nChainWork > from.nChainWork) {\n+        r = to.nChainWork - from.nChainWork;\n+    } else {\n+        r = from.nChainWork - to.nChainWork;\n+        sign = -1;\n+    }\n+    r = r * arith_uint256(params.nPowTargetSpacing) / GetBlockProof(tip);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5918#discussion_r93781353",
      "id" : 93781353,
      "original_commit_id" : "f7303f97933be33e34d482cf8348d180c8da2a26",
      "original_position" : 15,
      "path" : "src/pow.cpp",
      "position" : 15,
      "pull_request_review_id" : 14317490,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5918",
      "updated_at" : "2016-12-23T16:19:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93781353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   }
]
