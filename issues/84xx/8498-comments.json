[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r74368316"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/74368316"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: weird spacing here?\n",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2016-08-11T04:48:27Z",
      "diff_hunk" : "@@ -1923,16 +1923,14 @@ int GetSpendHeight(const CCoinsViewCache& inputs)\n     return pindexPrev->nHeight + 1;\n }\n \n-namespace Consensus {\n-bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& nFees)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx))\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r74368316",
      "id" : 74368316,
      "original_commit_id" : "03d0f762f2de9d01750e96893555ac500e3c9a37",
      "original_position" : 57,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/74368316",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/413395?v=4",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r74481846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/74481846"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, that's how the editor indented by default. That's actually what we have in some other places, but having a glance searching for strprintf in main.cpp I see we're not being consistent with indentation of function calls broken into several lines\n\nExample from the opening parenthesis position:\nhttps://github.com/bitcoin/bitcoin/blob/master/src/main.cpp#L1354\nExample 4 spaces from the beginning:\nhttps://github.com/bitcoin/bitcoin/blob/master/src/main.cpp#L1110\nExample freestyle: \nhttps://github.com/bitcoin/bitcoin/blob/master/src/main.cpp#L1436\n\nI'm happy to change it for something else, this maybe?\n\n```\n        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n            strprintf(\"%s: inputs missing/spent\", __func__));\n```\n\nEDIT: Actually the indentation is the same as from the place it's taken from: https://github.com/bitcoin/bitcoin/pull/8498/files#diff-7ec3c68a81efff79b6ca22ac1f1eabbaL2417\n",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2016-08-11T18:55:25Z",
      "diff_hunk" : "@@ -1923,16 +1923,14 @@ int GetSpendHeight(const CCoinsViewCache& inputs)\n     return pindexPrev->nHeight + 1;\n }\n \n-namespace Consensus {\n-bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& nFees)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx))\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r74481846",
      "id" : 74481846,
      "original_commit_id" : "03d0f762f2de9d01750e96893555ac500e3c9a37",
      "original_position" : 57,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/74481846",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Needed rebase. Besides, the previous version contained a bug.",
      "created_at" : "2016-09-01T16:47:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-244140141",
      "id" : 244140141,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2016-09-01T16:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244140141",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Needed rebase after renaming main.o, see #9260 (although needed, the rebase was clean in this case)",
      "created_at" : "2016-12-03T06:26:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-264620779",
      "id" : 264620779,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2016-12-03T06:26:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/264620779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r110544416"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110544416"
         }
      },
      "author_association" : "OWNER",
      "body" : "I think you can change the `view.HaveInputs(tx)` below into a `Consensus::CheckTxInputs` call, doing some of the checks slightly earlier.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-04-09T15:07:38Z",
      "diff_hunk" : "@@ -646,18 +646,20 @@ bool AcceptToMemoryPoolWorker(CTxMemPool& pool, CValidationState& state, const C\n             }\n         }\n \n-        // are the actual inputs available?\n+        // This redundant check doesn't trigger the DoS code on purpose; if it did, it would make it easier\n+        // for an attacker to attempt to split the network (Consensus::CheckTxInputs also checks this).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r110544416",
      "id" : 110544416,
      "original_commit_id" : "c93d1cf269212c493de56276370049f7b9a1d2bb",
      "original_position" : 15,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 31726387,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110544416",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r110555687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110555687"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Rather than forcing a bogus `nFees` (or unused) everywhere,  just wrap this function with an overload containing an unused `nFees` stack variable.\r\n\r\nSimpler.  Less diff.\r\n\r\nAlso means anyone reviewing at some later date won't get confused as to whether `nFees` is _actually_ used or not.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-04-09T23:12:57Z",
      "diff_hunk" : "@@ -1318,16 +1318,14 @@ int GetSpendHeight(const CCoinsViewCache& inputs)\n     return pindexPrev->nHeight + 1;\n }\n \n-namespace Consensus {\n-bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& nFees)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r110555687",
      "id" : 110555687,
      "original_commit_id" : "c93d1cf269212c493de56276370049f7b9a1d2bb",
      "original_position" : 48,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 31737099,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110555687",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/413395?v=4",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r112045794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112045794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps the ~~new~~ comment could be clearer, but the ```view.HaveInputs(tx)``` check below sets ```state.DoS(0, ...)``` instead of ```state.DoS(100, ...)``` like ```Consensus::CheckTxInputs```  would do.\r\nFeel more than free to rephrase it in a way that would have been more clear to you.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-04-18T19:43:22Z",
      "diff_hunk" : "@@ -646,18 +646,20 @@ bool AcceptToMemoryPoolWorker(CTxMemPool& pool, CValidationState& state, const C\n             }\n         }\n \n-        // are the actual inputs available?\n+        // This redundant check doesn't trigger the DoS code on purpose; if it did, it would make it easier\n+        // for an attacker to attempt to split the network (Consensus::CheckTxInputs also checks this).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r112045794",
      "id" : 112045794,
      "in_reply_to_id" : 110544416,
      "original_commit_id" : "c93d1cf269212c493de56276370049f7b9a1d2bb",
      "original_position" : 15,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 33331312,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112045794",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r112049225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112049225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The only place where this makes sense is in txmempool.cpp. There you can do a much nicer wrapper there. The diff won't be smaller in total but there will be more lines in red (which people tend to like). I considered this before and I rembember @sipa said it would be fine to just remove the check in txmempool.cpp but I can't find the comment and he changed his mind about it. I will rewrite this for you to see and I'm happy to squash it.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-04-18T20:00:35Z",
      "diff_hunk" : "@@ -1318,16 +1318,14 @@ int GetSpendHeight(const CCoinsViewCache& inputs)\n     return pindexPrev->nHeight + 1;\n }\n \n-namespace Consensus {\n-bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& nFees)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r112049225",
      "id" : 112049225,
      "in_reply_to_id" : 110555687,
      "original_commit_id" : "c93d1cf269212c493de56276370049f7b9a1d2bb",
      "original_position" : 48,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 33335259,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112049225",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Added a commit that may make @dcousens happier or not, thanks for making me remember.\r\n\r\nEDIT: I would be also be happy to take the function out of the consensus namespace \"for free\" here. That was a mistake on my part.",
      "created_at" : "2017-04-18T20:51:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-294978323",
      "id" : 294978323,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-04-19T15:58:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/294978323",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r115339497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115339497"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Optimization: Minimize the number of times it is checked\"\r\n\r\nWould be good to declare nFees below close to where it is actually used.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-05-08T20:03:16Z",
      "diff_hunk" : "@@ -624,7 +624,7 @@ bool AcceptToMemoryPoolWorker(CTxMemPool& pool, CValidationState& state, const C\n         CCoinsView dummy;\n         CCoinsViewCache view(&dummy);\n \n-        CAmount nValueIn = 0;\n+        CAmount nFees = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r115339497",
      "id" : 115339497,
      "original_commit_id" : "dd733d06d81032e95a22ef5b634e2c0bf4248bd5",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 36870482,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115339497",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r115353716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115353716"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Optimization: Minimize the number of times it is checked\"\r\n\r\nCan you add a comment explaining this line? Why do transactions in a block with vtx.size() of >= 2 have a different spend height than transactions in a block with vtx.size() == 1? Is nSpendHeight even used in a block with vtx.size() == 1?",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-05-08T21:08:40Z",
      "diff_hunk" : "@@ -1820,6 +1814,8 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n     blockundo.vtxundo.reserve(block.vtx.size() - 1);\n     std::vector<PrecomputedTransactionData> txdata;\n     txdata.reserve(block.vtx.size()); // Required so that pointers to individual PrecomputedTransactionData don't get invalidated\n+    const int nHeight = pindex->pprev == NULL ? 0 : pindex->pprev->nHeight + 1;\n+    const int64_t nSpendHeight = block.vtx.size() > 1 ? GetSpendHeight(view) : nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r115353716",
      "id" : 115353716,
      "original_commit_id" : "dd733d06d81032e95a22ef5b634e2c0bf4248bd5",
      "original_position" : 85,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 36870482,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115353716",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r117328308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/117328308"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If the block only has the coinbase tx before GetSpendHeight(view)  would have not been called at all and starting doing so seems unnecessarily costly, see https://github.com/bitcoin/bitcoin/blob/master/src/validation.cpp#L1306\r\nI was actually hoping that someone suggested to just remove this local variable directly and just use nHeight directly for the coinbase maturity check, assuming that is safe. I think so but would like others to confirm before trying it.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-05-18T19:04:21Z",
      "diff_hunk" : "@@ -1820,6 +1814,8 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n     blockundo.vtxundo.reserve(block.vtx.size() - 1);\n     std::vector<PrecomputedTransactionData> txdata;\n     txdata.reserve(block.vtx.size()); // Required so that pointers to individual PrecomputedTransactionData don't get invalidated\n+    const int nHeight = pindex->pprev == NULL ? 0 : pindex->pprev->nHeight + 1;\n+    const int64_t nSpendHeight = block.vtx.size() > 1 ? GetSpendHeight(view) : nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r117328308",
      "id" : 117328308,
      "in_reply_to_id" : 115353716,
      "original_commit_id" : "dd733d06d81032e95a22ef5b634e2c0bf4248bd5",
      "original_position" : 85,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 39028185,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/117328308",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Needed rebase, hopefully fixed all nits.",
      "created_at" : "2017-05-19T04:36:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-302606393",
      "id" : 302606393,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-05-19T04:36:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/302606393",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Tests for this PR seem to be failing currently, maybe due to the SpendHeight change?\r\n\r\nOnly changes since my previous review were rebasing post-#8329 and the nFees and nSpendHeight changes commented on above.",
      "created_at" : "2017-05-23T19:24:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-303505331",
      "id" : 303505331,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-05-23T19:24:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/303505331",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "body" : "Yes, the problem was in that change but not on stop using GetSpendHeight, just added +1 to the height by mistake. Updated.\r\n",
      "created_at" : "2017-05-30T18:11:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-304961989",
      "id" : 304961989,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-05-30T18:11:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/304961989",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Needed rebase after #10195, it also needs more review now (AcceptToMemoryPoolWorker may return different DoS pnctuation [100 instead of 0] now, happy to fix if that's a problem).",
      "created_at" : "2017-06-02T01:06:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-305661391",
      "id" : 305661391,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-06-02T01:06:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/305661391",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Some discussion of this in IRC https://botbot.me/freenode/bitcoin-core-dev/msg/87002756/",
      "created_at" : "2017-06-08T21:20:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-307230847",
      "id" : 307230847,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-06-08T21:20:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/307230847",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r122035311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/122035311"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Optimization: Minimize the number of times\"\r\n\r\nIf I understand correctly, it would be more correct to pass `SpendHeight(view)` instead of `pindex->nHeight` as the nSpendHeight argument, but in this case it doesn't matter because the value is only used for coinbase transactions, and this isn't a coinbase transaction? Or maybe there are other reasons why `pindex->nHeight` is ok to pass?\r\n\r\nEither way, I think this is confusing, and that there should be a comment here explaining the `pindex->nHeight` value. Or maybe you could delete the `nSpendHeight` argument and have `CheckTxInputs` call `GetSpendHeight(inputs)` when needed. This seems like it would be a simplification and I don't think there should be a performance cost because `CheckTxInputs` seems to be skipped for coinbase transactions in all cases except for one call that invokes `GetSpendHeight` anyway.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-14T18:54:58Z",
      "diff_hunk" : "@@ -1622,9 +1619,8 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n \n         if (!tx.IsCoinBase())\n         {\n-            if (!view.HaveInputs(tx))\n-                return state.DoS(100, error(\"ConnectBlock(): inputs missing/spent\"),\n-                                 REJECT_INVALID, \"bad-txns-inputs-missingorspent\");\n+            if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, nFees))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r122035311",
      "id" : 122035311,
      "original_commit_id" : "48e308d208995839d3119b40d189bf328a5b6445",
      "original_position" : 57,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 44115137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/122035311",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r122574593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/122574593"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it would be more correct (but I'm glad to be corrected) and performance would sufffer.\r\nI think pindex->nHeight because that's actually what we want to validate here. In acceptToMemPool and CTxMemPool::check you don't know the height. Here, nSpendHeight should always be lower or equal to pindex->nHeight.\r\n\r\nI'm happy to add a comment but not sure what it should be. Peharps the comment should be in GetSpendHeight instead of ConnectBlock().\r\n",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-17T18:50:51Z",
      "diff_hunk" : "@@ -1622,9 +1619,8 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n \n         if (!tx.IsCoinBase())\n         {\n-            if (!view.HaveInputs(tx))\n-                return state.DoS(100, error(\"ConnectBlock(): inputs missing/spent\"),\n-                                 REJECT_INVALID, \"bad-txns-inputs-missingorspent\");\n+            if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, nFees))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r122574593",
      "id" : 122574593,
      "in_reply_to_id" : 122035311,
      "original_commit_id" : "48e308d208995839d3119b40d189bf328a5b6445",
      "original_position" : 57,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 44705889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/122574593",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123325914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123325914"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I'm happy to add a comment but not sure what it should be.\r\n\r\nComment could just say why it is better to pass pindex->nHeight as nSpendHeight here instead of GetSpendHeight(view). If the two values are always equal, or have some other relation, comment could just say what that relationship is. If this is too in the weeds, definitely feel free to skip this. I'm just suggesting what I think would make the code clearer for me.\r\n\r\nAlternately, I don't know what you think of my suggestion to eliminate the `nSpendHeight` argument and just call `GetSpendHeight` in `CheckTxInputs`. It does look to me like this would be logically equivalent and not effect performance, though maybe there's another reason not to do it.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-21T18:14:10Z",
      "diff_hunk" : "@@ -1622,9 +1619,8 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n \n         if (!tx.IsCoinBase())\n         {\n-            if (!view.HaveInputs(tx))\n-                return state.DoS(100, error(\"ConnectBlock(): inputs missing/spent\"),\n-                                 REJECT_INVALID, \"bad-txns-inputs-missingorspent\");\n+            if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, nFees))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123325914",
      "id" : 123325914,
      "in_reply_to_id" : 122035311,
      "original_commit_id" : "48e308d208995839d3119b40d189bf328a5b6445",
      "original_position" : 57,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 45518114,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123325914",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123405843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123405843"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Part of the optimization here is not calling GetSpendHeight for every tx in the block, and your suggestion would eliminate that part of the optimization.\r\nFor the comment, what about \"We know the height, so we don't need to GetSpendHeight\"?\r\nit if more people agree.\r\nI'm really not sure that comment would add that much value, but I don't mind adding ",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-22T01:54:53Z",
      "diff_hunk" : "@@ -1622,9 +1619,8 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n \n         if (!tx.IsCoinBase())\n         {\n-            if (!view.HaveInputs(tx))\n-                return state.DoS(100, error(\"ConnectBlock(): inputs missing/spent\"),\n-                                 REJECT_INVALID, \"bad-txns-inputs-missingorspent\");\n+            if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, nFees))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123405843",
      "id" : 123405843,
      "in_reply_to_id" : 122035311,
      "original_commit_id" : "48e308d208995839d3119b40d189bf328a5b6445",
      "original_position" : 57,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 45605121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123405843",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123744310"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123744310"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's somewhat confusing that `CheckTxInputs()` will be doing calculations on accumulated fee values, and not just the particular transaction passed in.\r\n\r\nCan we just have `CheckTxInputs` return the fee of the transaction passed in, and then the caller can decide what additional checks should happen?  It would make more sense to me that the `MoneyRange()` check on total block fees happen in `ConnectBlock()`, rather than here (though I do think conceptually that is a reasonable check for us to add).\r\n\r\nAlternatively, if we decide to go with the accumulated fees being checked here, I'd strongly prefer to rename this variable to something like \"accumulated_fees\" to make it clear what this is, and update the documentation to explain it.  But I'd prefer to move the accumulation to the caller, and leave this function as operating on a single transaction.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-23T13:14:00Z",
      "diff_hunk" : "@@ -24,7 +26,7 @@ namespace Consensus {\n  * This does not modify the UTXO set. This does not check scripts and sigs.\n  * Preconditions: tx.IsCoinBase() is false.\n  */\n-bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight);\n+bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& nFees);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123744310",
      "id" : 123744310,
      "original_commit_id" : "4d9e9a5b7cb3e65bcf96ea5090ab6abaeba27640",
      "original_position" : 14,
      "path" : "src/consensus/tx_verify.h",
      "position" : null,
      "pull_request_review_id" : 45978893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123744310",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123744780"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123744780"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style nit: braces for one-line `if`",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-23T13:16:25Z",
      "diff_hunk" : "@@ -526,7 +523,12 @@ bool AcceptToMemoryPoolWorker(CTxMemPool& pool, CValidationState& state, const C\n         // CoinsViewCache instead of create its own\n         if (!CheckSequenceLocks(tx, STANDARD_LOCKTIME_VERIFY_FLAGS, &lp))\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"non-BIP68-final\");\n-        }\n+\n+        } // end LOCK(pool.cs)\n+\n+        CAmount nFees = 0;\n+        if (!Consensus::CheckTxInputs(tx, state, view, GetSpendHeight(view), nFees))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123744780",
      "id" : 123744780,
      "original_commit_id" : "4d9e9a5b7cb3e65bcf96ea5090ab6abaeba27640",
      "original_position" : 26,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 45978893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123744780",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123775376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123775376"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style nit: braces for one-line if",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-23T15:26:16Z",
      "diff_hunk" : "@@ -201,15 +201,14 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& nFees)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123775376",
      "id" : 123775376,
      "original_commit_id" : "4d9e9a5b7cb3e65bcf96ea5090ab6abaeba27640",
      "original_position" : 12,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 45978893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123775376",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123777207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123777207"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with @jtimon that it makes more sense for ConnectBlock to pass in pindex->nHeight, rather than get the spend height from the view, even though those are the same.  We could add an assert that the view's best block has the same hash as pindex->pprev if that makes the code clearer -- but we have bigger problems than just coinbase maturity if the view is out of sync with our chain!",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-23T15:34:20Z",
      "diff_hunk" : "@@ -1622,9 +1619,8 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n \n         if (!tx.IsCoinBase())\n         {\n-            if (!view.HaveInputs(tx))\n-                return state.DoS(100, error(\"ConnectBlock(): inputs missing/spent\"),\n-                                 REJECT_INVALID, \"bad-txns-inputs-missingorspent\");\n+            if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, nFees))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123777207",
      "id" : 123777207,
      "in_reply_to_id" : 122035311,
      "original_commit_id" : "48e308d208995839d3119b40d189bf328a5b6445",
      "original_position" : 57,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 45978893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123777207",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123777278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123777278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style nit: curly braces for one-line if",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-23T15:34:40Z",
      "diff_hunk" : "@@ -1622,9 +1619,8 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n \n         if (!tx.IsCoinBase())\n         {\n-            if (!view.HaveInputs(tx))\n-                return state.DoS(100, error(\"ConnectBlock(): inputs missing/spent\"),\n-                                 REJECT_INVALID, \"bad-txns-inputs-missingorspent\");\n+            if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, nFees))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123777278",
      "id" : 123777278,
      "original_commit_id" : "4d9e9a5b7cb3e65bcf96ea5090ab6abaeba27640",
      "original_position" : 57,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 45978893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123777278",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123887895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123887895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If the fee is returned, then we can't also return a bool, and we would need to duplicate the check in ConnectBlock, AcceptToMemeoryPool and CTxMemPool::check. And at that point the additional complexity wouldn't be worth it IMO.\r\n\r\nWe could also pass a fees input/output parameter that doesn't accumulate (although you can already enjoy that functionality by simply passing 0 to the variable). In that case, the duplication would only need to duplicateMoneyrange check in ConnectBlock, but I don't really see it as an improvement over this.\r\n \r\nAgreed, accumulated_fees would be more readable with only 2 more lines needing to change",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-25T00:23:05Z",
      "diff_hunk" : "@@ -24,7 +26,7 @@ namespace Consensus {\n  * This does not modify the UTXO set. This does not check scripts and sigs.\n  * Preconditions: tx.IsCoinBase() is false.\n  */\n-bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight);\n+bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& nFees);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r123887895",
      "id" : 123887895,
      "in_reply_to_id" : 123744310,
      "original_commit_id" : "4d9e9a5b7cb3e65bcf96ea5090ab6abaeba27640",
      "original_position" : 14,
      "path" : "src/consensus/tx_verify.h",
      "position" : null,
      "pull_request_review_id" : 46135995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123887895",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Hopefully fixed @sdaftuar 's nits.\r\nAlso add a third commit to properly indent CheckTxInputs and other minor style fixes like braces for one line ifs while at it.\r\n",
      "created_at" : "2017-06-25T02:19:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-310877612",
      "id" : 310877612,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-06-25T02:19:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/310877612",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124069710"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124069710"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: extra space at EOL here.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-26T17:26:51Z",
      "diff_hunk" : "@@ -22,9 +24,12 @@ namespace Consensus {\n /**\n  * Check whether all inputs of this transaction are valid (no double spends and amounts)\n  * This does not modify the UTXO set. This does not check scripts and sigs.\n+ * @param[in,out] accumulated_fees this serves to get the fees of the tx as output. ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124069710",
      "id" : 124069710,
      "original_commit_id" : "47316266a663a3f18347d625cff9f57deb45fb6c",
      "original_position" : 13,
      "path" : "src/consensus/tx_verify.h",
      "position" : null,
      "pull_request_review_id" : 46327834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124069710",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124160827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124160827"
         }
      },
      "author_association" : "OWNER",
      "body" : "@jtimon You can 'return' the fee in a tuple, or as a pass-by-reference value. So for example `CheckTxInputs` would have `CAmount& return_fee` field, and `return_fee` would just be *assigned* that transaction's fee. The caller can then do the `accumulated_fee += return_fee` logic. This involves no duplication, and still makes `CheckTxInputs` purely operate on data for a single transaction.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-27T01:39:41Z",
      "diff_hunk" : "@@ -24,7 +26,7 @@ namespace Consensus {\n  * This does not modify the UTXO set. This does not check scripts and sigs.\n  * Preconditions: tx.IsCoinBase() is false.\n  */\n-bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight);\n+bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& nFees);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124160827",
      "id" : 124160827,
      "in_reply_to_id" : 123744310,
      "original_commit_id" : "4d9e9a5b7cb3e65bcf96ea5090ab6abaeba27640",
      "original_position" : 14,
      "path" : "src/consensus/tx_verify.h",
      "position" : null,
      "pull_request_review_id" : 46425951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124160827",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124178299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124178299"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If the concern is that the addition with other fees is not done within the function, as documented the caller can set the in/out argument to zero before calling. I could also always return only the value for the single transaction without accumulating anything (although I don't see the gain, it's just more code), at that point the argument would be out only, not in/out.\r\n\r\nFrom there, to return the output argument as a tuple or pair I think it's just making things uglier and unnecessarily complicated.\r\n\r\ninstead of:\r\n```\r\nCAmount tx_fee = 0; // You will initialize the variable even if the function starts setting it to zero\r\nif (!CheckTxInputs(..., tx_fee))\r\n   return false;\r\naccumulated_fee += tx_fee;\r\n```\r\n\r\nYou would have something like:\r\n\r\n```\r\nstruct CheckTxInputsReturn\r\n{\r\n   bool fValid;\r\n   CAmount tx_fee;\r\n}\r\n\r\nCheckTxInputsReturn ret = CheckTxInputs(...);\r\nif (!ret.fValid)\r\n   return false;\r\naccumulated_fee += ret.tx_fee;\r\n```\r\n\r\nI think that's incredibly ugly. Specially since I don't see the problem with how it is currently used when you don't want to accumulate any fees:\r\n\r\n```\r\nCAmount tx_fee = 0;\r\nif (!CheckTxInputs(..., tx_fee))\r\n   return false;\r\n```\r\n\r\nPlease, I invite you to write your suggestions on top of this and see for yourselves that they are not an improvement but actually the contrary.\r\nIf people agree that those IMO much uglier solutions are better, I will squash your suggestions, no problem.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-27T04:56:57Z",
      "diff_hunk" : "@@ -24,7 +26,7 @@ namespace Consensus {\n  * This does not modify the UTXO set. This does not check scripts and sigs.\n  * Preconditions: tx.IsCoinBase() is false.\n  */\n-bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight);\n+bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& nFees);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124178299",
      "id" : 124178299,
      "in_reply_to_id" : 123744310,
      "original_commit_id" : "4d9e9a5b7cb3e65bcf96ea5090ab6abaeba27640",
      "original_position" : 14,
      "path" : "src/consensus/tx_verify.h",
      "position" : null,
      "pull_request_review_id" : 46443942,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124178299",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124178585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124178585"
         }
      },
      "author_association" : "OWNER",
      "body" : "I was just clarifying that @sdaftuar's suggestion does not imply duplication of logic. I personally think that it's a bit cleaner to do the summing of fees outside of the validation of a single function, but it's an unimportant nit for sure.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-27T05:00:37Z",
      "diff_hunk" : "@@ -24,7 +26,7 @@ namespace Consensus {\n  * This does not modify the UTXO set. This does not check scripts and sigs.\n  * Preconditions: tx.IsCoinBase() is false.\n  */\n-bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight);\n+bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& nFees);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124178585",
      "id" : 124178585,
      "in_reply_to_id" : 123744310,
      "original_commit_id" : "4d9e9a5b7cb3e65bcf96ea5090ab6abaeba27640",
      "original_position" : 14,
      "path" : "src/consensus/tx_verify.h",
      "position" : null,
      "pull_request_review_id" : 46444246,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124178585",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124179812"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124179812"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, sorry, the duplication comment was a mistake. Before I was checking the moneyRange for the accumulated fees and not just for the single tx fees, and I thought that check would need to be duplicated outside, but that was a change in functionality that I shouldn't be doing (and btw was missed in review).\r\nPedantically adding that check would be a softfork, but it should be impossible that the MoneyRange check on the accumulated fees fails anyway.\r\n\r\nI can not accumulate anything if you guys prefer that, that's a simple change (even though I still can't understand why would you prefer that), reading your previous comment again better, you were also considering the pass by reference (what is done now), not necessarily the tuple (which is what I would be against in principle because of its ugliness).",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-27T05:17:06Z",
      "diff_hunk" : "@@ -24,7 +26,7 @@ namespace Consensus {\n  * This does not modify the UTXO set. This does not check scripts and sigs.\n  * Preconditions: tx.IsCoinBase() is false.\n  */\n-bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight);\n+bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& nFees);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124179812",
      "id" : 124179812,
      "in_reply_to_id" : 123744310,
      "original_commit_id" : "4d9e9a5b7cb3e65bcf96ea5090ab6abaeba27640",
      "original_position" : 14,
      "path" : "src/consensus/tx_verify.h",
      "position" : null,
      "pull_request_review_id" : 46445574,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124179812",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Added a couple of commits to be squashed. I wouldn't personally squash the latter but it seems @sdaftuar and @sipa would like it more this way and I don't care. Before squashing I will also move the indentation commit to the first thing.\r\n\r\nEDIT: already squashed one, updated OP.",
      "created_at" : "2017-06-27T06:05:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-311261974",
      "id" : 311261974,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-06-27T06:47:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/311261974",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124332429"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124332429"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Need to change var name here, too.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-27T16:51:21Z",
      "diff_hunk" : "@@ -22,9 +24,10 @@ namespace Consensus {\n /**\n  * Check whether all inputs of this transaction are valid (no double spends and amounts)\n  * This does not modify the UTXO set. This does not check scripts and sigs.\n+ * @param[out] nTxFee this serves to get the fees of the tx as output. \n  * Preconditions: tx.IsCoinBase() is false.\n  */\n-bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight);\n+bool CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& accumulated_fees);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124332429",
      "id" : 124332429,
      "original_commit_id" : "7b78d8b7e0191d8fa54747c5e77a9791a7247838",
      "original_position" : 17,
      "path" : "src/consensus/tx_verify.h",
      "position" : null,
      "pull_request_review_id" : 46327834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124332429",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124346132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124346132"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "While you're at it, can you please re-add the MoneyRange checks here that Gavin removed years ago (and maybe update the PR title to indicate that you're fixing Gavin's near-bug while also decreasing the number of CCoinsView map lookups).",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-27T17:44:14Z",
      "diff_hunk" : "@@ -1635,9 +1633,11 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n \n         if (!tx.IsCoinBase())\n         {\n-            if (!view.HaveInputs(tx))\n-                return state.DoS(100, error(\"ConnectBlock(): inputs missing/spent\"),\n-                                 REJECT_INVALID, \"bad-txns-inputs-missingorspent\");\n+            CAmount tx_fees = 0;\n+            if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, tx_fees)) {\n+                return error(\"%s: Consensus::CheckTxInputs: %s, %s\", __func__, tx.GetHash().ToString(), FormatStateMessage(state));\n+            }\n+            nFees += tx_fees;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124346132",
      "id" : 124346132,
      "original_commit_id" : "7b78d8b7e0191d8fa54747c5e77a9791a7247838",
      "original_position" : 60,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 46327834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124346132",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124364449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124364449"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Specifically, commit 8d7849b6db5f54dc32fe4f8c6c7283068473cd21 broke the check at https://github.com/bitcoin/bitcoin/commit/8d7849b6db#diff-7ec3c68a81efff79b6ca22ac1f1eabbaR1110 and made it useless, which very narrowly didn't cause a major consensus failure and re-introduction of the original bitcoin-printing overflow bug.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-06-27T18:53:37Z",
      "diff_hunk" : "@@ -1635,9 +1633,11 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n \n         if (!tx.IsCoinBase())\n         {\n-            if (!view.HaveInputs(tx))\n-                return state.DoS(100, error(\"ConnectBlock(): inputs missing/spent\"),\n-                                 REJECT_INVALID, \"bad-txns-inputs-missingorspent\");\n+            CAmount tx_fees = 0;\n+            if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, tx_fees)) {\n+                return error(\"%s: Consensus::CheckTxInputs: %s, %s\", __func__, tx.GetHash().ToString(), FormatStateMessage(state));\n+            }\n+            nFees += tx_fees;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r124364449",
      "id" : 124364449,
      "in_reply_to_id" : 124346132,
      "original_commit_id" : "7b78d8b7e0191d8fa54747c5e77a9791a7247838",
      "original_position" : 60,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 46646220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124364449",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Squashed the non-accumulator commit.\r\nHopefully fixed all @TheBlueMatt 's nits, good catch.\r\nAlso s/nTxFee/tx_fees/ to comply with the new style.\r\n",
      "created_at" : "2017-07-04T16:05:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-312911862",
      "id" : 312911862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-07-04T16:05:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/312911862",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r126784667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126784667"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why not use the normal formatting here of return state.DoS(100, error(), ...)?",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-07-11T19:25:52Z",
      "diff_hunk" : "@@ -1635,9 +1633,15 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n \n         if (!tx.IsCoinBase())\n         {\n-            if (!view.HaveInputs(tx))\n-                return state.DoS(100, error(\"ConnectBlock(): inputs missing/spent\"),\n-                                 REJECT_INVALID, \"bad-txns-inputs-missingorspent\");\n+            CAmount tx_fees = 0;\n+            if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, tx_fees)) {\n+                return error(\"%s: Consensus::CheckTxInputs: %s, %s\", __func__, tx.GetHash().ToString(), FormatStateMessage(state));\n+            }\n+            nFees += tx_fees;\n+            if (!MoneyRange(nFees)) {\n+                 state.DoS(100, false, REJECT_INVALID, \"bad-txns-accumulated-fee-outofrange\");\n+                 return error(\"%s: %s, %s\", __func__, tx.GetHash().ToString(), FormatStateMessage(state));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r126784667",
      "id" : 126784667,
      "original_commit_id" : "3161a7c9ef6e19696a79776b38e3e5e4b6a67940",
      "original_position" : 63,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 49303160,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126784667",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r127103970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127103970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No reason, will change",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-07-13T00:23:10Z",
      "diff_hunk" : "@@ -1635,9 +1633,15 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n \n         if (!tx.IsCoinBase())\n         {\n-            if (!view.HaveInputs(tx))\n-                return state.DoS(100, error(\"ConnectBlock(): inputs missing/spent\"),\n-                                 REJECT_INVALID, \"bad-txns-inputs-missingorspent\");\n+            CAmount tx_fees = 0;\n+            if (!Consensus::CheckTxInputs(tx, state, view, pindex->nHeight, tx_fees)) {\n+                return error(\"%s: Consensus::CheckTxInputs: %s, %s\", __func__, tx.GetHash().ToString(), FormatStateMessage(state));\n+            }\n+            nFees += tx_fees;\n+            if (!MoneyRange(nFees)) {\n+                 state.DoS(100, false, REJECT_INVALID, \"bad-txns-accumulated-fee-outofrange\");\n+                 return error(\"%s: %s, %s\", __func__, tx.GetHash().ToString(), FormatStateMessage(state));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r127103970",
      "id" : 127103970,
      "in_reply_to_id" : 126784667,
      "original_commit_id" : "3161a7c9ef6e19696a79776b38e3e5e4b6a67940",
      "original_position" : 63,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 49653638,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127103970",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Fixed latest nit.",
      "created_at" : "2017-07-13T00:29:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-314935270",
      "id" : 314935270,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-07-13T00:29:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/314935270",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r133807917"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/133807917"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Isn't this redundant given the check on line 239?",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-08-17T19:33:18Z",
      "diff_hunk" : "@@ -205,46 +205,49 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& tx_fees)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    tx_fees = 0; // Initialize output value\n+\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);\n+        assert(!coin.IsSpent());\n+\n+        // If prev is coinbase, check that it's matured\n+        if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\n+            return state.Invalid(false,\n+                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n+                strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n+        }\n \n+        // Check for negative or overflow input values\n+        nValueIn += coin.out.nValue;\n+        if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn)) {\n+            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n         }\n+    }\n+\n+    const CAmount value_out = tx.GetValueOut();\n+    if (nValueIn < value_out) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-in-belowout\", false,\n+            strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(value_out)));\n+    }\n \n-        if (nValueIn < tx.GetValueOut())\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-in-belowout\", false,\n-                strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(tx.GetValueOut())));\n-\n-        // Tally transaction fees\n-        CAmount nTxFee = nValueIn - tx.GetValueOut();\n-        if (nTxFee < 0)\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-fee-negative\");\n-        nFees += nTxFee;\n-        if (!MoneyRange(nFees))\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-fee-outofrange\");\n+    // Tally transaction fees\n+    tx_fees = nValueIn - value_out;\n+    if (tx_fees < 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r133807917",
      "id" : 133807917,
      "original_commit_id" : "736cf73ab3144915a3427bb7d23bd31386abe8c0",
      "original_position" : 79,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 57031463,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/133807917",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r133897830"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/133897830"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, I think so, unless I'm missing something about some weird overflow. Besides it is also included in MoneyRange, so actually both checks are redundant, but at some point IIRC someone asked to not unify in  bad-txns-fee-outofrange. But I think we can choose to ditch either bad-txns-in-belowout or bad-txns-fee-negative. I don't have a strong preference.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-08-18T07:42:20Z",
      "diff_hunk" : "@@ -205,46 +205,49 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& tx_fees)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    tx_fees = 0; // Initialize output value\n+\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);\n+        assert(!coin.IsSpent());\n+\n+        // If prev is coinbase, check that it's matured\n+        if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\n+            return state.Invalid(false,\n+                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n+                strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n+        }\n \n+        // Check for negative or overflow input values\n+        nValueIn += coin.out.nValue;\n+        if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn)) {\n+            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n         }\n+    }\n+\n+    const CAmount value_out = tx.GetValueOut();\n+    if (nValueIn < value_out) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-in-belowout\", false,\n+            strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(value_out)));\n+    }\n \n-        if (nValueIn < tx.GetValueOut())\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-in-belowout\", false,\n-                strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(tx.GetValueOut())));\n-\n-        // Tally transaction fees\n-        CAmount nTxFee = nValueIn - tx.GetValueOut();\n-        if (nTxFee < 0)\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-fee-negative\");\n-        nFees += nTxFee;\n-        if (!MoneyRange(nFees))\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-fee-outofrange\");\n+    // Tally transaction fees\n+    tx_fees = nValueIn - value_out;\n+    if (tx_fees < 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r133897830",
      "id" : 133897830,
      "in_reply_to_id" : 133807917,
      "original_commit_id" : "736cf73ab3144915a3427bb7d23bd31386abe8c0",
      "original_position" : 79,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 57130901,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/133897830",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Hopefully fixed @jimpo 's nit. Didn't squashed yet just in case, but it seems pretty obviously correct in removing a redundancy that cannot be tested and thus is not being tested.",
      "created_at" : "2017-08-24T21:19:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-324760765",
      "id" : 324760765,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-08-24T21:19:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/324760765",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r136680000"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/136680000"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "` * @params[out] tx_fees  Set to the transaction fee if successful`.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-01T23:16:28Z",
      "diff_hunk" : "@@ -22,9 +24,10 @@ namespace Consensus {\n /**\n  * Check whether all inputs of this transaction are valid (no double spends and amounts)\n  * This does not modify the UTXO set. This does not check scripts and sigs.\n+ * @param[out] tx_fees this serves to get the fees of the tx as output. ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r136680000",
      "id" : 136680000,
      "original_commit_id" : "434f86b0bbbb793ec91deeb94013421b29445e7a",
      "original_position" : 13,
      "path" : "src/consensus/tx_verify.h",
      "position" : null,
      "pull_request_review_id" : 60258677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/136680000",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r136680606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/136680606"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why was/is plural?",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-01T23:24:06Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& tx_fees)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    tx_fees = 0; // Initialize output value\n+\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n \n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);\n+        assert(!coin.IsSpent());\n+\n+        // If prev is coinbase, check that it's matured\n+        if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\n+            return state.Invalid(false,\n+                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n+                strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n         }\n \n-        if (nValueIn < tx.GetValueOut())\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-in-belowout\", false,\n-                strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(tx.GetValueOut())));\n-\n-        // Tally transaction fees\n-        CAmount nTxFee = nValueIn - tx.GetValueOut();\n-        if (nTxFee < 0)\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-fee-negative\");\n-        nFees += nTxFee;\n-        if (!MoneyRange(nFees))\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-fee-outofrange\");\n+        // Check for negative or overflow input values\n+        nValueIn += coin.out.nValue;\n+        if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn)) {\n+            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+        }\n+    }\n+\n+    const CAmount value_out = tx.GetValueOut();\n+    if (nValueIn < value_out) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-in-belowout\", false,\n+            strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(value_out)));\n+    }\n+\n+    // Tally transaction fees\n+    tx_fees = nValueIn - value_out;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r136680606",
      "id" : 136680606,
      "original_commit_id" : "434f86b0bbbb793ec91deeb94013421b29445e7a",
      "original_position" : 78,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 60258677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/136680606",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r136680632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/136680632"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Use snake_case on new code.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-01T23:24:42Z",
      "diff_hunk" : "@@ -611,6 +611,15 @@ void CTxMemPool::clear()\n     _clear();\n }\n \n+static void CheckInputsAndUpdateCoins(const CTransaction& tx, CCoinsViewCache& mempoolDuplicate, const int64_t nSpendHeight)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r136680632",
      "id" : 136680632,
      "original_commit_id" : "434f86b0bbbb793ec91deeb94013421b29445e7a",
      "original_position" : 4,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 60258677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/136680632",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r136681168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/136681168"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`tx_fees` or just `fees`?",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-01T23:31:44Z",
      "diff_hunk" : "@@ -531,6 +528,12 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n         // CoinsViewCache instead of create its own\n         if (!CheckSequenceLocks(tx, STANDARD_LOCKTIME_VERIFY_FLAGS, &lp))\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"non-BIP68-final\");\n+\n+        } // end LOCK(pool.cs)\n+\n+        CAmount nFees = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r136681168",
      "id" : 136681168,
      "original_commit_id" : "434f86b0bbbb793ec91deeb94013421b29445e7a",
      "original_position" : 24,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 60258677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/136681168",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jtimon The \"More motivation\" link https://github.com/bitcoin/bitcoin/blob/master/src/main.cpp#L1493 is broken",
      "created_at" : "2017-09-04T18:29:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-327012549",
      "id" : 327012549,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-09-04T18:29:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/327012549",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137134137"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137134137"
         }
      },
      "author_association" : "MEMBER",
      "body" : "no good reason, let's make it singular",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-05T22:48:18Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& tx_fees)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    tx_fees = 0; // Initialize output value\n+\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n \n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);\n+        assert(!coin.IsSpent());\n+\n+        // If prev is coinbase, check that it's matured\n+        if (coin.IsCoinBase() && nSpendHeight - coin.nHeight < COINBASE_MATURITY) {\n+            return state.Invalid(false,\n+                REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n+                strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n         }\n \n-        if (nValueIn < tx.GetValueOut())\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-in-belowout\", false,\n-                strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(tx.GetValueOut())));\n-\n-        // Tally transaction fees\n-        CAmount nTxFee = nValueIn - tx.GetValueOut();\n-        if (nTxFee < 0)\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-fee-negative\");\n-        nFees += nTxFee;\n-        if (!MoneyRange(nFees))\n-            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-fee-outofrange\");\n+        // Check for negative or overflow input values\n+        nValueIn += coin.out.nValue;\n+        if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn)) {\n+            return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+        }\n+    }\n+\n+    const CAmount value_out = tx.GetValueOut();\n+    if (nValueIn < value_out) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-in-belowout\", false,\n+            strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(value_out)));\n+    }\n+\n+    // Tally transaction fees\n+    tx_fees = nValueIn - value_out;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137134137",
      "id" : 137134137,
      "in_reply_to_id" : 136680606,
      "original_commit_id" : "434f86b0bbbb793ec91deeb94013421b29445e7a",
      "original_position" : 78,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 60762512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137134137",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137135132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137135132"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That would be more extra disruption only for style. We can do that at any time. Including potentially more rebase work fixing conflicts with other things touching AcceptToMemoryPoolWorker. Can we leave that for later? Note we're not creating a new variable but just moving its declaration here.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-05T22:54:54Z",
      "diff_hunk" : "@@ -531,6 +528,12 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n         // CoinsViewCache instead of create its own\n         if (!CheckSequenceLocks(tx, STANDARD_LOCKTIME_VERIFY_FLAGS, &lp))\n             return state.DoS(0, false, REJECT_NONSTANDARD, \"non-BIP68-final\");\n+\n+        } // end LOCK(pool.cs)\n+\n+        CAmount nFees = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137135132",
      "id" : 137135132,
      "in_reply_to_id" : 136681168,
      "original_commit_id" : "434f86b0bbbb793ec91deeb94013421b29445e7a",
      "original_position" : 24,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 60763532,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137135132",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Fixed @promag 's nits (except one to avoid further disruption, in this case only for style).\r\nFixed @danra 's nit by crossing the broken list in the OP (too lazy to look after some concept and ut acks, sorry. I believe there's enough motivation without the broken link, which I don't remember what was about right now).\r\n\r\n",
      "created_at" : "2017-09-05T23:47:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-327334229",
      "id" : 327334229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-09-05T23:47:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/327334229",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137153110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137153110"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`++i`.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-06T01:26:32Z",
      "diff_hunk" : "@@ -207,44 +207,45 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n \n bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n+    // for an attacker to attempt to split the network.\n+    if (!inputs.HaveInputs(tx))\n+        return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n+\n+    CAmount nValueIn = 0;\n+    CAmount nFees = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137153110",
      "id" : 137153110,
      "original_commit_id" : "cac4df7ca3daabf12cd19baf5cfb7dcde40e2f47",
      "original_position" : 36,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 60783228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137153110",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137153520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137153520"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why? Update only if successfully?",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-06T01:30:45Z",
      "diff_hunk" : "@@ -205,15 +205,17 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-    // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-    // for an attacker to attempt to split the network.\n-    if (!inputs.HaveInputs(tx))\n-        return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n+    txfee = 0; // Initialize output value",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137153520",
      "id" : 137153520,
      "original_commit_id" : "a97f07af78b14281644e03285ab7a1cd3844a223",
      "original_position" : 11,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 60783228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137153520",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137153615"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137153615"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Update before `return true;`.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-06T01:31:48Z",
      "diff_hunk" : "@@ -233,18 +235,15 @@ bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, c\n         }\n     }\n \n-    if (nValueIn < tx.GetValueOut()) {\n+    const CAmount value_out = tx.GetValueOut();\n+    if (nValueIn < value_out) {\n         return state.DoS(100, false, REJECT_INVALID, \"bad-txns-in-belowout\", false,\n-            strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(tx.GetValueOut())));\n+            strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(value_out)));\n     }\n \n     // Tally transaction fees\n-    CAmount nTxFee = nValueIn - tx.GetValueOut();\n-    if (nTxFee < 0) {\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-fee-negative\");\n-    }\n-    nFees += nTxFee;\n-    if (!MoneyRange(nFees)) {\n+    txfee = nValueIn - value_out;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137153615",
      "id" : 137153615,
      "original_commit_id" : "a97f07af78b14281644e03285ab7a1cd3844a223",
      "original_position" : 43,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 60783228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137153615",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137153659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137153659"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```cpp\r\nif (!MoneyRange(nValueIn - value_out)) {\r\n```",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-06T01:32:14Z",
      "diff_hunk" : "@@ -233,18 +235,15 @@ bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, c\n         }\n     }\n \n-    if (nValueIn < tx.GetValueOut()) {\n+    const CAmount value_out = tx.GetValueOut();\n+    if (nValueIn < value_out) {\n         return state.DoS(100, false, REJECT_INVALID, \"bad-txns-in-belowout\", false,\n-            strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(tx.GetValueOut())));\n+            strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(value_out)));\n     }\n \n     // Tally transaction fees\n-    CAmount nTxFee = nValueIn - tx.GetValueOut();\n-    if (nTxFee < 0) {\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-fee-negative\");\n-    }\n-    nFees += nTxFee;\n-    if (!MoneyRange(nFees)) {\n+    txfee = nValueIn - value_out;\n+    if (!MoneyRange(txfee)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137153659",
      "id" : 137153659,
      "original_commit_id" : "a97f07af78b14281644e03285ab7a1cd3844a223",
      "original_position" : 44,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 60783228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137153659",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137320049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137320049"
         }
      },
      "author_association" : "MEMBER",
      "body" : "And if not set to to 0? I think this was discussed already...",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-06T16:28:45Z",
      "diff_hunk" : "@@ -205,15 +205,17 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-    // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-    // for an attacker to attempt to split the network.\n-    if (!inputs.HaveInputs(tx))\n-        return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n+    txfee = 0; // Initialize output value",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137320049",
      "id" : 137320049,
      "in_reply_to_id" : 137153520,
      "original_commit_id" : "a97f07af78b14281644e03285ab7a1cd3844a223",
      "original_position" : 11,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 60971392,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137320049",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137320780"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137320780"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Mhmm, right, that's what we're saying in the doxygen docs now...ok, I guess.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-06T16:31:27Z",
      "diff_hunk" : "@@ -233,18 +235,15 @@ bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, c\n         }\n     }\n \n-    if (nValueIn < tx.GetValueOut()) {\n+    const CAmount value_out = tx.GetValueOut();\n+    if (nValueIn < value_out) {\n         return state.DoS(100, false, REJECT_INVALID, \"bad-txns-in-belowout\", false,\n-            strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(tx.GetValueOut())));\n+            strprintf(\"value in (%s) < value out (%s)\", FormatMoney(nValueIn), FormatMoney(value_out)));\n     }\n \n     // Tally transaction fees\n-    CAmount nTxFee = nValueIn - tx.GetValueOut();\n-    if (nTxFee < 0) {\n-        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-fee-negative\");\n-    }\n-    nFees += nTxFee;\n-    if (!MoneyRange(nFees)) {\n+    txfee = nValueIn - value_out;\n+    if (!MoneyRange(txfee)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r137320780",
      "id" : 137320780,
      "in_reply_to_id" : 137153659,
      "original_commit_id" : "a97f07af78b14281644e03285ab7a1cd3844a223",
      "original_position" : 44,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : null,
      "pull_request_review_id" : 60972230,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137320780",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Fixed @promag 's last round of nits, thanks again.",
      "created_at" : "2017-09-07T00:48:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-327650854",
      "id" : 327650854,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-09-07T00:48:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/327650854",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138863585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138863585"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Suggest using const auto& to iterate over tx.vin. (This is already the case in other functions in this file)",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-14T11:15:17Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); ++i) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138863585",
      "id" : 138863585,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 48,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 48,
      "pull_request_review_id" : 62715591,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138863585",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138863773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138863773"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Suggest using const auto& for these",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-14T11:16:24Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); ++i) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138863773",
      "id" : 138863773,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 50,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 50,
      "pull_request_review_id" : 62715591,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138863773",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138864183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138864183"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The current code has an explicit comment about not triggering the DoS code on purpose, did you remove it (and invoke the DoS code) intentionally?",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-14T11:18:38Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138864183",
      "id" : 138864183,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 43,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 43,
      "pull_request_review_id" : 62715591,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138864183",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138864880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138864880"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Local includes should come before system includes",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-14T11:22:19Z",
      "diff_hunk" : "@@ -8,6 +8,8 @@\n #include <stdint.h>\n #include <vector>\n \n+#include \"amount.h\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138864880",
      "id" : 138864880,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 4,
      "path" : "src/consensus/tx_verify.h",
      "position" : null,
      "pull_request_review_id" : 62715591,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138864880",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138878958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138878958"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The comment was moved to the separated HaveInputs call in AcceptToMemoryPoolWorker.\r\nPerhaps lost in rebase, I'll look at it.\r\nPerhaps it's fine since we now have: https://github.com/bitcoin/bitcoin/pull/8498/commits/c93ceb2dbde1c2474ee04946fb4594b668613dbe#diff-24efdb00bfbe56b140fb006b562cc70bR514",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-14T12:32:17Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138878958",
      "id" : 138878958,
      "in_reply_to_id" : 138864183,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 43,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 43,
      "pull_request_review_id" : 62732790,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138878958",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138879230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138879230"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This line wasn't touched besides indentation until @promag asked s/i++/++i/\r\nNot sure it's worth it to make that change here, to be honest...",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-14T12:33:30Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); ++i) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138879230",
      "id" : 138879230,
      "in_reply_to_id" : 138863585,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 48,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 48,
      "pull_request_review_id" : 62733098,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138879230",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138912377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138912377"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's not just the comment, as you can see in the diff previously the code used `state.Invalid` (and stated it does so on purpose), and now both the comment is gone and the code uses `state.DoS`\r\n\r\nI don't know to say on my own whether that change is valid, but it definitely requires explanation due to the fact that previously there was a specific comment suggesting using `state.DoS` there is bad.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-14T14:36:17Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r138912377",
      "id" : 138912377,
      "in_reply_to_id" : 138864183,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 43,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 43,
      "pull_request_review_id" : 62771828,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/138912377",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r139014770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/139014770"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Please dont add needless auto& unless you have to. If you're saving 5 chars of typing it just makes things less readable.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-14T21:22:45Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); ++i) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r139014770",
      "id" : 139014770,
      "in_reply_to_id" : 138863773,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 50,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 50,
      "pull_request_review_id" : 62891068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/139014770",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r139015520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/139015520"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It should be OK, the DoS from ConnectBlock is important, but the DoS shouldn't be trigger'able in ATMP - we should have already returned false int he pfMissingInputs branch further up.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-14T21:26:21Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r139015520",
      "id" : 139015520,
      "in_reply_to_id" : 138864183,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 43,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 43,
      "pull_request_review_id" : 62891932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/139015520",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r139019344"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/139019344"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@TheBlueMatt I disagree, and AFAIK so do most of the C++ gurus. The (character) typing isn't the issue here, rather code flexibility. See https://softwareengineering.stackexchange.com/questions/180216/does-auto-make-c-code-harder-to-understand for an example of a discussion on the topic.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-14T21:46:09Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); ++i) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r139019344",
      "id" : 139019344,
      "in_reply_to_id" : 138863773,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 50,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 50,
      "pull_request_review_id" : 62896418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/139019344",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r139225809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/139225809"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "auto, here, AFAIU, is going to be slightly more likely to force you to change the line if you change AccessCoin's return type (at least because its a const-ref type, so conversion should only be an inheritance thing). In consensus code, making sure you're forced to change all the places something is used if you change a type strikes me as a very, very good idea. If you want to take Herb's stance on it, I'd also be ok with his recommended auto coin = const Coin&{inputs.AccessCoin(prevout)}; to force it, though I find that somewhat unreadable (which is bias towards what I'm used to, I admit).",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-15T18:57:38Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); ++i) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r139225809",
      "id" : 139225809,
      "in_reply_to_id" : 138863773,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 50,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 50,
      "pull_request_review_id" : 63133757,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/139225809",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r139251146"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/139251146"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Consensus code seems hard enough to change as it is without adding extra hurdles.\r\n\r\n> In consensus code, making sure you're forced to change all the places something is used if\r\n> you change a type strikes me as a very, very good idea.\r\n\r\nBy that logic, instead of\r\n`const COutPoint &prevout = tx.vin[i].prevout;`\r\n\r\nit would be better to write\r\n```\r\nconst CTxIn& txin = tx.vin[i];\r\nconst COutPoint &prevout = txin.prevout;\r\n```\r\nSince in the first version, `tx.vin[i]` is used without specifying its type :)",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-15T21:10:55Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); ++i) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r139251146",
      "id" : 139251146,
      "in_reply_to_id" : 138863773,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 50,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 50,
      "pull_request_review_id" : 63164111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/139251146",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140095511"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140095511"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Let's please leave this for another PR",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-20T21:17:48Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); ++i) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140095511",
      "id" : 140095511,
      "in_reply_to_id" : 138863773,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 50,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 50,
      "pull_request_review_id" : 64119679,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-20T21:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140095511",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Fixed 1 commit by @danra ",
      "created_at" : "2017-09-20T21:28:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-330986316",
      "id" : 330986316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-09-20T21:28:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/330986316",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140352837"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140352837"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@TheBlueMatt \r\n> It should be OK, the DoS from ConnectBlock is important\r\n\r\nWhich DoS? The one previously returned from `CheckTxInputs` in case of missing inputs? If so, IIUC it wouldn't trigger after this change, there would just be an error returned, since it replaced the previous DoS in `ConnectBlock` https://github.com/bitcoin/bitcoin/commit/c93ceb2dbde1c2474ee04946fb4594b668613dbe#diff-24efdb00bfbe56b140fb006b562cc70bR1638",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-21T20:38:42Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140352837",
      "id" : 140352837,
      "in_reply_to_id" : 138864183,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 43,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 43,
      "pull_request_review_id" : 64415438,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-21T20:38:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140352837",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140353044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140353044"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@jtimon IMHO it would fit nicely in the minor changes commit",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-21T20:39:41Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); ++i) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140353044",
      "id" : 140353044,
      "in_reply_to_id" : 138863585,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 48,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 48,
      "pull_request_review_id" : 64415698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-21T20:39:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140353044",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140353143"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140353143"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "OK, deleting this comment.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-21T20:40:08Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); ++i) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140353143",
      "id" : 140353143,
      "in_reply_to_id" : 139014770,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 50,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 50,
      "pull_request_review_id" : 64415809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-21T20:40:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140353143",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140356187"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140356187"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "DoS values persist through the state object (and should only be set once through the entire call tree). Thus, when ConnectBlock calls CheckTxInputs, which sets DoS, ConnectBlock *should* return only error() and not call DoS again, but the DoS points will still be returned through the state object.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-21T20:53:05Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140356187",
      "id" : 140356187,
      "in_reply_to_id" : 138864183,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 43,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 43,
      "pull_request_review_id" : 64419200,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-21T20:53:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140356187",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140356672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140356672"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@TheBlueMatt Ah, I see. Thanks!",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-21T20:55:17Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140356672",
      "id" : 140356672,
      "in_reply_to_id" : 138864183,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 43,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 43,
      "pull_request_review_id" : 64419776,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-21T20:55:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140356672",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140356686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140356686"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Please dont delete comments. Just because a PR author decided against taking a suggestion doesnt mean review content should be deleted. Others may wish to agree with the suggestion or otherwise just view the history of what was discussed. Unless a comment is updated immediately afterwards, generally I'd prefer they not be edited.",
      "commit_id" : "4e955c58e13cfe089208f6b23b195d395ad99baa",
      "created_at" : "2017-09-21T20:55:19Z",
      "diff_hunk" : "@@ -205,46 +205,46 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state, bool fChe\n     return true;\n }\n \n-bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight)\n+bool Consensus::CheckTxInputs(const CTransaction& tx, CValidationState& state, const CCoinsViewCache& inputs, int nSpendHeight, CAmount& txfee)\n {\n-        // This doesn't trigger the DoS code on purpose; if it did, it would make it easier\n-        // for an attacker to attempt to split the network.\n-        if (!inputs.HaveInputs(tx))\n-            return state.Invalid(false, 0, \"\", \"Inputs unavailable\");\n-\n-        CAmount nValueIn = 0;\n-        CAmount nFees = 0;\n-        for (unsigned int i = 0; i < tx.vin.size(); i++)\n-        {\n-            const COutPoint &prevout = tx.vin[i].prevout;\n-            const Coin& coin = inputs.AccessCoin(prevout);\n-            assert(!coin.IsSpent());\n-\n-            // If prev is coinbase, check that it's matured\n-            if (coin.IsCoinBase()) {\n-                if (nSpendHeight - coin.nHeight < COINBASE_MATURITY)\n-                    return state.Invalid(false,\n-                        REJECT_INVALID, \"bad-txns-premature-spend-of-coinbase\",\n-                        strprintf(\"tried to spend coinbase at depth %d\", nSpendHeight - coin.nHeight));\n-            }\n-\n-            // Check for negative or overflow input values\n-            nValueIn += coin.out.nValue;\n-            if (!MoneyRange(coin.out.nValue) || !MoneyRange(nValueIn))\n-                return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputvalues-outofrange\");\n+    // are the actual inputs available?\n+    if (!inputs.HaveInputs(tx)) {\n+        return state.DoS(100, false, REJECT_INVALID, \"bad-txns-inputs-missingorspent\", false,\n+                         strprintf(\"%s: inputs missing/spent\", __func__));\n+    }\n+\n+    CAmount nValueIn = 0;\n+    for (unsigned int i = 0; i < tx.vin.size(); ++i) {\n+        const COutPoint &prevout = tx.vin[i].prevout;\n+        const Coin& coin = inputs.AccessCoin(prevout);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#discussion_r140356686",
      "id" : 140356686,
      "in_reply_to_id" : 139014770,
      "original_commit_id" : "b989b704d4618387fff644b8918834810c0565ee",
      "original_position" : 50,
      "path" : "src/consensus/tx_verify.cpp",
      "position" : 50,
      "pull_request_review_id" : 64419789,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8498",
      "updated_at" : "2017-09-21T20:55:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140356686",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK",
      "created_at" : "2017-09-21T20:56:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8498#issuecomment-331279617",
      "id" : 331279617,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8498",
      "updated_at" : "2017-09-21T20:56:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/331279617",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/84245?v=4",
         "events_url" : "https://api.github.com/users/danra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danra/followers",
         "following_url" : "https://api.github.com/users/danra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danra",
         "id" : 84245,
         "login" : "danra",
         "organizations_url" : "https://api.github.com/users/danra/orgs",
         "received_events_url" : "https://api.github.com/users/danra/received_events",
         "repos_url" : "https://api.github.com/users/danra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danra"
      }
   }
]
