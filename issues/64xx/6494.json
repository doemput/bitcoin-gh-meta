{
   "assignee" : null,
   "body" : "This is an implementation of #5982 (and based off @sipa's commit in #5307, which has been squashed into this commit).\r\n\r\nCurrently new blocks are announced via ```inv``` messages.  Since headers-first download was introduced in 0.10, blocks are not processed unless the headers for the block connect to known, valid headers, so peers receiving ```inv``` messages respond with a ```getheaders``` and a ```getdata```: the expectation is that the announcing peer will send the headers for the block and any parents unknown to the peer before delivering the new block.\r\n\r\nIn the case of a reorg, nodes currently announce only the new tip, and not the blocks that lead to the tip.  This means that an extra round-trip is required to relay a reorg, because the peer receiving the ```inv``` for the tip must wait for the response to the ```getheaders``` message before being able to request the missing blocks.  (For additional reasons discussed in https://github.com/bitcoin/bitcoin/pull/5307#issuecomment-93785348, it's not optimal to ```inv``` all the blocks added in the reorg to a headers-first peer, because this results in needless traffic due to the way ```getheaders``` requests are generated when direct-fetching ```inv```'ed blocks.)\r\n\r\nThis pull implements a new ```sendheaders``` p2p message, which a node sends to its peers to indicate that the node prefers to receive new block announcements via a ```headers``` message rather than an inv.  This implementation does a few things:\r\n\r\n* When announcing a new block to a peer that prefers headers, try to announce all the blocks that are being added, back to the last fork point, by sending headers for each.\r\n* Avoid sending headers for blocks that are already known to the peer (determined by checking ```pindexBestKnownBlock``` and ```pindexBestHeaderSent``` and their ancestors).\r\n  * pindexBestKnownBlock is updated based on ```inv``` messages, ```headers``` sent from that peer, and ```getheaders``` messages sent from the peer.\r\n  * ```pindexBestHeaderSent``` is a new variable that tracks the best header we have sent to the peer\r\n* Avoid sending more than 8 headers to the peer.  This code is designed to be optimized for relaying at the tip, so a large reorg is some kind of error condition; in that case avoid spamming the peer with a lot of headers and instead fall back to the old ```inv``` mechanism.\r\n* If the headers to be announced aren't known to connect to headers that the peer has, then revert to sending an ```inv``` at the tip instead.  This is designed to avoid DoS points from sending headers that don't connect.  Since every new block should generally be announced by one peer in any pair of peers, it's expected that once headers-announcement begins on a link (ie once two nodes are known to be synced), it should be able to continue.\r\n* After #6148 is merged, this would allow pruning nodes to generally be able to relay reorgs to peers via headers announcements.  The code that implements direct fetching upon receipt of a headers message will send ```getdata``` requests to any peer that announces a block via a headers message.\r\n\r\nThis pull includes a new python p2p test exercising the new functionality.\r\n\r\nBIP 130 describes the proposed new ```sendheaders``` p2p message here:\r\nhttps://github.com/bitcoin/bips/blob/master/bip-0130.mediawiki ",
   "closed_at" : "2015-11-29T12:06:49Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
      "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sipa/followers",
      "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sipa",
      "id" : 548488,
      "login" : "sipa",
      "organizations_url" : "https://api.github.com/users/sipa/orgs",
      "received_events_url" : "https://api.github.com/users/sipa/received_events",
      "repos_url" : "https://api.github.com/users/sipa/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sipa"
   },
   "comments" : 30,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494/comments",
   "created_at" : "2015-07-30T20:03:49Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494",
   "id" : 98251734,
   "labels" : [
      {
         "color" : "006b75",
         "name" : "P2P",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : null,
      "closed_issues" : 74,
      "created_at" : "2015-05-01T12:31:35Z",
      "creator" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      },
      "description" : "",
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestones/0.12.0",
      "id" : 1092458,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/19/labels",
      "number" : 19,
      "open_issues" : 0,
      "state" : "open",
      "title" : "0.12.0",
      "updated_at" : "2016-06-09T08:23:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/19"
   },
   "number" : 6494,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/6494.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/6494.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Allow block announcements with headers",
   "updated_at" : "2015-11-29T12:06:49Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
      "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sdaftuar/followers",
      "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sdaftuar",
      "id" : 7463573,
      "login" : "sdaftuar",
      "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
      "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
      "repos_url" : "https://api.github.com/users/sdaftuar/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sdaftuar"
   }
}
