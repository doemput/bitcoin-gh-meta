[
   {
      "body" : "One thing I've wondered about this is if its possible to avoid an expiration replacement race.\r\n\r\nSay 2 days minus one second after your tx is originally broadcast, you rebroadcast: your peers still have it so it goes nowhere and your broadcast has no effect.  Say it's 2 days plus one second: some nodes still have it and so the broadcast is not very effective... and your transaction still falls out of memory pools.\r\n\r\nThis all creates a window where an aggressively broadcasting double-spender could replace the transaction in memory pools.  \r\n\r\nObviously double-spend exclusion can't be counted on, and perhaps will someday be mooted by a more greedy miner policy,   but I think it would be unfortunate to weaken the exclusion as a side effect of this if it can be avoided.\r\n\r\n",
      "created_at" : "2014-02-21T17:06:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3722#issuecomment-35750667",
      "id" : 35750667,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3722",
      "updated_at" : "2014-02-21T17:06:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35750667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "> This all creates a window where an aggressively broadcasting double-spender could replace the transaction in memory pools.\r\n\r\nSo the idea here is:\r\n\r\n- Attacker creates a deliberately low fee transaction (t1) paying himself, broadcasts it to merchant node (they in turn relay to the entire network).\r\n- Original transaction (t1) falls out of merchant's mempool.\r\n- Attacker double-spends that original transaction (t1), but this time with a transaction (t2) paying the merchant, and sends it to the merchant node.\r\n- Broadcast of t2 mostly fails, because the rest of the network still has t1 in their mempools.\r\n- Attacker waits a few more seconds (or more, time isn't critical for this step if the previous steps failed), t1 is dropped from most nodes.\r\n- Attacker broadcasts t3, which pays him (double-spend of both t1 and t2).\r\n\r\nThe simplest countermeasure I can think of is to have a longer expiration time for transactions if you're running a merchant node (so you never accept a tx before your peers would relay it), but I think the attacker can still juggle broadcasts to merchant/rest of network to get their mempools out of sync (just requires more steps), unless the merchant mempool's expiration time is effectively infinite.\r\n\r\nI don't think there's a reject-doublespend peer message in https://github.com/bitcoin/bitcoin/pull/3185, but if there were (or if the first doublespend relaying code was deployed), wouldn't that let the merchant node know there's a problem?\r\n\r\nThat way it can try broadcasting t2 and very quickly spot the double spend conflict between t1 and t2.",
      "created_at" : "2014-02-21T18:04:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3722#issuecomment-35756220",
      "id" : 35756220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3722",
      "updated_at" : "2014-02-24T21:51:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35756220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/566354?v=3",
         "events_url" : "https://api.github.com/users/christophebiocca/events{/privacy}",
         "followers_url" : "https://api.github.com/users/christophebiocca/followers",
         "following_url" : "https://api.github.com/users/christophebiocca/following{/other_user}",
         "gists_url" : "https://api.github.com/users/christophebiocca/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/christophebiocca",
         "id" : 566354,
         "login" : "christophebiocca",
         "organizations_url" : "https://api.github.com/users/christophebiocca/orgs",
         "received_events_url" : "https://api.github.com/users/christophebiocca/received_events",
         "repos_url" : "https://api.github.com/users/christophebiocca/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/christophebiocca/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/christophebiocca/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/christophebiocca"
      }
   },
   {
      "body" : "Mempool janitor (#3753) expires transactions.\r\n",
      "created_at" : "2014-02-27T01:47:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3722#issuecomment-36201446",
      "id" : 36201446,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3722",
      "updated_at" : "2014-02-27T01:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/36201446",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Agree that TX mempool expiration weakens not-in-blockchain, zero-conf double-spend exclusion ever so slightly.  That seems lost in the noise.  Merchants who accept zero-conf transactions are already aware of the risks of operating outside of consensus, and expiration should not measurably change their business costs or calculus.  Nobody is going to bother with an expensive, complicated attack on a 3-day-old transaction when a simple network race can more easily execute a partitioning double-spend attack.\r\n\r\nIt seems worth it, to give bitcoin users for the first time a mostly-predictable way to handle stuck transactions.\r\n",
      "created_at" : "2014-02-27T02:15:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3722#issuecomment-36203017",
      "id" : 36203017,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3722",
      "updated_at" : "2014-02-27T02:15:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/36203017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "I think you can get the best of both worlds by making the expiry logic have some randomness.\r\n\r\nFor example, the mempool janitor running exactly every 24 hrs means that an attacker can know when you'll expire a transaction (by doing some probing) and use it for new attacks, but even making that interval have a ÃÂ±1 hour variation completely removes that risk (without losing the roughly predictable expiration of transactions on the network overall).",
      "created_at" : "2014-02-27T15:28:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3722#issuecomment-36253262",
      "id" : 36253262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3722",
      "updated_at" : "2014-02-27T15:28:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/36253262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/566354?v=3",
         "events_url" : "https://api.github.com/users/christophebiocca/events{/privacy}",
         "followers_url" : "https://api.github.com/users/christophebiocca/followers",
         "following_url" : "https://api.github.com/users/christophebiocca/following{/other_user}",
         "gists_url" : "https://api.github.com/users/christophebiocca/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/christophebiocca",
         "id" : 566354,
         "login" : "christophebiocca",
         "organizations_url" : "https://api.github.com/users/christophebiocca/orgs",
         "received_events_url" : "https://api.github.com/users/christophebiocca/received_events",
         "repos_url" : "https://api.github.com/users/christophebiocca/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/christophebiocca/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/christophebiocca/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/christophebiocca"
      }
   },
   {
      "body" : "I don't think the attacker needs to know. I think he can just try constantly to relay the replacement and nodes will take it when they take it, it just gives him an excuse to also flood the network.\r\n\r\nUnreliability in expiration will mean that you really ought to wait even longer in re-announcing. \r\n\r\nConsider:\r\n\r\nsend -> [has] -> [has] -> [has]\r\n           [has] - [has] - [!has]\r\n           [!has] - [has] - [!has]\r\nresend-> [has] -> [has] - [!has]\r\n            [has] - [!has] - [!has]\r\n\r\nBecause the resend was before everyone dropped the transaction, the middle node in that example rejected it on resend and didn't forward to the further node that had already dropped it.\r\n\r\n\r\n",
      "created_at" : "2014-02-27T17:12:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3722#issuecomment-36265715",
      "id" : 36265715,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3722",
      "updated_at" : "2014-02-27T17:12:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/36265715",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "The alternative to mempool expiration, tx permanently locking up its inputs until some day far in the future when it is confirmed, can't be right.\r\n\r\nSo the question is: until when should double-spends be guarded against with whatever tools are available?  A reasonable answer would be somewhere between \"until next block\" through \"until sender being able to un-stick it is more important than protecting receiver from a malicious double-spend\".\r\n\r\nThe latter time is much sooner than the time when slow-confirming transactions should be expired.  So by the time expiration (72 hours, 432 blocks, or whatever) rolls around, sender is way past the time when he should have realized he no longer had any double-spend protection.\r\n",
      "created_at" : "2014-08-02T00:13:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3722#issuecomment-50947789",
      "id" : 50947789,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3722",
      "updated_at" : "2014-08-02T00:14:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/50947789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4284124?v=3",
         "events_url" : "https://api.github.com/users/dgenr8/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgenr8/followers",
         "following_url" : "https://api.github.com/users/dgenr8/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgenr8/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgenr8",
         "id" : 4284124,
         "login" : "dgenr8",
         "organizations_url" : "https://api.github.com/users/dgenr8/orgs",
         "received_events_url" : "https://api.github.com/users/dgenr8/received_events",
         "repos_url" : "https://api.github.com/users/dgenr8/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgenr8/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgenr8/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgenr8"
      }
   },
   {
      "body" : "This seems to be implemented by the current mempool limiting logic.",
      "created_at" : "2016-09-27T19:52:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3722#issuecomment-249978413",
      "id" : 249978413,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3722",
      "updated_at" : "2016-09-27T19:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/249978413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
