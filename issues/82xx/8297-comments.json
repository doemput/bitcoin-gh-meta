[
   {
      "body" : "```\r\n2016-07-01 01:36:18 POTENTIAL DEADLOCK DETECTED\r\n2016-07-01 01:36:18 Previous lock order was:\r\n2016-07-01 01:36:18  (1) pnode->cs_vSend  net.cpp:1847 (TRY)\r\n2016-07-01 01:36:18  (2) cs_main  main.cpp:6372 (TRY)\r\n2016-07-01 01:36:18  (2) cs_main  main.cpp:3501\r\n2016-07-01 01:36:18 Current lock order is:\r\n2016-07-01 01:36:18  pnode->cs_vRecvMsg  net.cpp:1828 (TRY)\r\n2016-07-01 01:36:18  (2) cs_main  main.cpp:5437\r\n2016-07-01 01:36:18  (1) cs_vSend  net.cpp:2537\r\n```\r\n\r\nI'm running 6a87eb0",
      "created_at" : "2016-07-01T01:57:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8297#issuecomment-229835810",
      "id" : 229835810,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8297",
      "updated_at" : "2016-07-01T01:57:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/229835810",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16611026?v=3",
         "events_url" : "https://api.github.com/users/throckmortonsign/events{/privacy}",
         "followers_url" : "https://api.github.com/users/throckmortonsign/followers",
         "following_url" : "https://api.github.com/users/throckmortonsign/following{/other_user}",
         "gists_url" : "https://api.github.com/users/throckmortonsign/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/throckmortonsign",
         "id" : 16611026,
         "login" : "throckmortonsign",
         "organizations_url" : "https://api.github.com/users/throckmortonsign/orgs",
         "received_events_url" : "https://api.github.com/users/throckmortonsign/received_events",
         "repos_url" : "https://api.github.com/users/throckmortonsign/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/throckmortonsign/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/throckmortonsign/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/throckmortonsign"
      }
   },
   {
      "body" : "Can you verify that this is actually deadlocking?\n\nI believe this is a false positive.\nOn Jun 30, 2016 12:55 PM, \"Jonas Schnelli\" <notifications@github.com> wrote:\n\n> I'm running into this deadlock all the time:\n>\n> 2016-06-29 15:41:50 POTENTIAL DEADLOCK DETECTED\n> 2016-06-29 15:41:50 Previous lock order was:\n> 2016-06-29 15:41:50  pnode->cs_vRecvMsg  net.cpp:1828 (TRY)\n> 2016-06-29 15:41:50  cs_main  main.cpp:4798\n> 2016-06-29 15:41:50  (1) pfrom->cs_filter  main.cpp:4856\n> 2016-06-29 15:41:50  (2) cs_vSend  net.cpp:2537\n> 2016-06-29 15:41:50 Current lock order is:\n> 2016-06-29 15:41:50  (2) pnode->cs_vSend  net.cpp:1847 (TRY)\n> 2016-06-29 15:41:50  cs_main  main.cpp:6373 (TRY)\n> 2016-06-29 15:41:50  pto->cs_inventory  main.cpp:6593\n> 2016-06-29 15:41:50  (1) pto->cs_filter  main.cpp:6616\n>\n> I'm running 63fbdbc\n> <https://github.com/bitcoin/bitcoin/commit/63fbdbc94d76e586b2fb0754a9a69acfc4b622d3>\n> .\n>\n> It's the machine with 1GB/s SSD and 32GB RAM Xeon CPU E3-1275 v5 @ 3.60GHz\n>\n> Ã¢ÂÂ\n> You are receiving this because you are subscribed to this thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/issues/8297>, or mute the thread\n> <https://github.com/notifications/unsubscribe/AAl4Q7wqDEvSwyh5ntHH5Y32hK5WNe5dks5qRB8tgaJpZM4JCiHn>\n> .\n>\n",
      "created_at" : "2016-07-01T03:14:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8297#issuecomment-229844291",
      "id" : 229844291,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8297",
      "updated_at" : "2016-07-01T03:14:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/229844291",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=3",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "body" : "In my case it seemed like a true deadlock. I only built with -DDEBUG_LOCKORDER after my node seemed to not sync newer blocks after a reindex on testnet.",
      "created_at" : "2016-07-01T03:52:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8297#issuecomment-229848036",
      "id" : 229848036,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8297",
      "updated_at" : "2016-07-01T03:56:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/229848036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16611026?v=3",
         "events_url" : "https://api.github.com/users/throckmortonsign/events{/privacy}",
         "followers_url" : "https://api.github.com/users/throckmortonsign/followers",
         "following_url" : "https://api.github.com/users/throckmortonsign/following{/other_user}",
         "gists_url" : "https://api.github.com/users/throckmortonsign/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/throckmortonsign",
         "id" : 16611026,
         "login" : "throckmortonsign",
         "organizations_url" : "https://api.github.com/users/throckmortonsign/orgs",
         "received_events_url" : "https://api.github.com/users/throckmortonsign/received_events",
         "repos_url" : "https://api.github.com/users/throckmortonsign/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/throckmortonsign/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/throckmortonsign/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/throckmortonsign"
      }
   },
   {
      "body" : "Neither of them looks like a false positive to me, they concern the same locks in different orders at the same time.\r\n",
      "created_at" : "2016-07-01T07:40:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8297#issuecomment-229878791",
      "id" : 229878791,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8297",
      "updated_at" : "2016-07-01T07:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/229878791",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "My nodes is now running a couple of days in `-disable-debug` mode and there where no signs of deadlocks... maybe this is a false positive?",
      "created_at" : "2016-07-09T12:14:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8297#issuecomment-231531565",
      "id" : 231531565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8297",
      "updated_at" : "2016-07-09T12:14:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/231531565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "I haven't had any for a few days now (with debug). The whole reason I turned on debug in the first place was a suspected deadlock and it occurred under a similar set of circumstances. Seemed to occur just after reindexing and/or disconnecting peers. It doesn't seem to happen to me during normal operation and I haven't tried to replicate again.",
      "created_at" : "2016-07-09T13:51:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8297#issuecomment-231535355",
      "id" : 231535355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8297",
      "updated_at" : "2016-07-09T13:51:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/231535355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16611026?v=3",
         "events_url" : "https://api.github.com/users/throckmortonsign/events{/privacy}",
         "followers_url" : "https://api.github.com/users/throckmortonsign/followers",
         "following_url" : "https://api.github.com/users/throckmortonsign/following{/other_user}",
         "gists_url" : "https://api.github.com/users/throckmortonsign/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/throckmortonsign",
         "id" : 16611026,
         "login" : "throckmortonsign",
         "organizations_url" : "https://api.github.com/users/throckmortonsign/orgs",
         "received_events_url" : "https://api.github.com/users/throckmortonsign/received_events",
         "repos_url" : "https://api.github.com/users/throckmortonsign/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/throckmortonsign/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/throckmortonsign/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/throckmortonsign"
      }
   },
   {
      "body" : "I see these in my log too. While they're scary, after tracing through for a while, I don't think they're dangerous. (I do think we should fix up to avoid them, though).\r\n\r\ncs_vSend is held for the duration of SendMessages(), which, after b5599147533103efea896a1fc4ff51f2d3ad5808, sometimes locks cs_filter. Additionally, cs_filter is sometimes held while calling PushMessage, which locks cs_vSend.\r\n\r\nHowever, all of that happens on the message handling thread. The net thread locks cs_vSend, but never cs_filter.\r\n\r\nAll of that could be worked around by making sure not to hold cs_filter while sending.\r\n\r\nAs for the other potential deadlock, it's a similar story. When processing incoming messages, cs_main is sometimes held while calling PushMessage (which locks cs_vSend). When processing outgoing messages though, cs_vSend is always held, followed sometimes by locking cs_main in SendMessages. But the net thread that contends for cs_vSend never locks cs_main.\r\n\r\nThe one exception is the optimistic send on new outgoing connections, which _does_ lock cs_main and cs_vSend on the net thread, but not simultaneously.\r\n\r\ntl;dr: Both lock order reversals are happening on the message handling thread, and other threads don't attempt to lock both mutexes. I don't think either one presents an obvious deadlock risk. We should still strive to fix by minimizing overlapping locks though.",
      "created_at" : "2016-07-11T21:57:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8297#issuecomment-231878258",
      "id" : 231878258,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8297",
      "updated_at" : "2016-07-11T21:57:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/231878258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
