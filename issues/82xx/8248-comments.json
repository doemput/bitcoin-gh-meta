[
   {
      "body" : "Apparently to enable high-entropy ASLR [the image-base also needs to be set above 4GB](https://code.videolan.org/solaris/x264/commit/c01bf42117b811a0469f9f6c374f4a0daa98716d). \r\n```\r\n                 LDFLAGSCLI=\"$LDFLAGSCLI -Wl,--image-base,0x140000000\"\r\n                 SOFLAGS=\"$SOFLAGS -Wl,--image-base,0x180000000\"\r\n```",
      "created_at" : "2016-06-23T15:15:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8248#issuecomment-228082972",
      "id" : 228082972,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8248",
      "updated_at" : "2016-06-23T15:15:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/228082972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I've checked using Process Explorer and VMMap on Windows 10, and it looks like the windows executable is always loaded at the same offset:\r\n\r\n- `0xb00000` for the 32-bit version\r\n- `0xbf0000` for the 64-bit version\r\n\r\nThis is not the base address specified in the .exe (0x400000), but it doesn't seem randomized either.",
      "created_at" : "2016-06-23T16:36:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8248#issuecomment-228107858",
      "id" : 228107858,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8248",
      "updated_at" : "2016-06-23T16:36:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/228107858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "You can easily check whether an executable has ASLR enabled by doing `dumpbin /headers foo.exe` where dumpbin is a program that comes with MSVC. Ideally you should see something like the following in the output:\n\n```\n            8160 DLL characteristics\n                   High Entropy Virtual Addresses\n                   Dynamic base\n                   NX compatible\n                   Terminal Server Aware\n```\n\nIf only you could use msvc to compile the code, then you'd have all that by default.\n",
      "created_at" : "2016-06-26T23:58:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8248#issuecomment-228631063",
      "id" : 228631063,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8248",
      "updated_at" : "2016-06-26T23:58:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/228631063",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/666308?v=4",
         "events_url" : "https://api.github.com/users/retep998/events{/privacy}",
         "followers_url" : "https://api.github.com/users/retep998/followers",
         "following_url" : "https://api.github.com/users/retep998/following{/other_user}",
         "gists_url" : "https://api.github.com/users/retep998/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/retep998",
         "id" : 666308,
         "login" : "retep998",
         "organizations_url" : "https://api.github.com/users/retep998/orgs",
         "received_events_url" : "https://api.github.com/users/retep998/received_events",
         "repos_url" : "https://api.github.com/users/retep998/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/retep998/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/retep998/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/retep998"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "> You can easily check whether an executable has ASLR enabled by doing dumpbin /headers foo.exe where dumpbin is a program that comes with MSVC. Ideally you should see something like the following in the output:\n\nThat just checks the header bits (the same as our security check script already does using `objdump`). It does not actually check whether the address space is randomized in practice, which I did by checking the memory maps at runtime.\n\n> If only you could use msvc to compile the code, then you'd have all that by default.\n\nYou can use MSVC to compile the code. There's nothing about the code that should be gcc+clang specific (and if it is, that should be fixed).\n\nHowever that doesn't help for releases as they need to be able to be built from source deterministically (with gitian). Using a closed source, not freely redistributable compiler is out of the question for that.\n",
      "created_at" : "2016-06-27T10:03:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8248#issuecomment-228704372",
      "id" : 228704372,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8248",
      "updated_at" : "2016-06-27T14:33:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/228704372",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I can confirm that on Windows x64 a bitcoin-qt.exe process built from source on WSL is benefiting from ASLR.\r\n\r\nMethod used to confirm (note that two separate tools are used VMMap and WinDbg to provide additional confidence):\r\n\r\n1. Start bitcoin-qt.exe,\r\n2. Open VMMap and select the bitcoin-qt process,\r\n3. Click on the Image Type and note virtual addresses of certain modules, e.g.\r\n    0x190000 f:\\temp\\bitcoin-qt.exe\r\n    0x7FFA06190000 c:\\windows\\system32\\kernel32.dll\r\n    0x7FFA038F0000 c:\\windows\\system32\\ws2_32.dll\r\n4. Capture a memory dump of the process using Task Manager->Right Click Process->Create Dump File,\r\n5. Open dump file in windbg,\r\n6. Use lm to list loaded modules and confirm addresses are the same as VMMap,\r\n   00000000`00190000 00000000`01fd4000   bitcoin_qt   (deferred)  \r\n   00007ffa`06190000 00007ffa`0623e000   kernel32   (deferred)    \r\n  00007ffa`038f0000 00007ffa`0395c000   ws2_32     (deferred)    \r\n\r\nNow reboot Windows, since ASLR will only reset the module addresses for a process after each OS restart, and repeat the above steps:\r\n\r\nVMMap results:\r\n 0x820000 f:\\temp\\bitcoin-qt.exe\r\n 0x7FF9D1B00000 c:\\windows\\system32\\kernel32.dll\r\n 0x7FF9D18D0000 c:\\windows\\system32\\ws2_32.dll\r\n\r\nWinDbg results:\r\n 00000000`00820000 00000000`02664000   bitcoin_qt   (deferred) \r\n 00007ff9`d1b00000 00007ff9`d1bae000   kernel32   (deferred)   \r\n 00007ff9`d18d0000 00007ff9`d193c000   ws2_32     (deferred)",
      "created_at" : "2017-10-02T01:51:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8248#issuecomment-333424244",
      "id" : 333424244,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8248",
      "updated_at" : "2017-10-02T01:51:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/333424244",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   }
]
