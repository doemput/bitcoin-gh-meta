[
   {
      "body" : "Concept ACK",
      "created_at" : "2016-09-20T13:40:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-248304125",
      "id" : 248304125,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-09-20T13:40:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/248304125",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Needs rebase",
      "created_at" : "2016-09-25T11:40:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-249416903",
      "id" : 249416903,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-09-25T11:40:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/249416903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Concept ACK",
      "created_at" : "2016-09-30T16:58:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-250796973",
      "id" : 250796973,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-09-30T16:58:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/250796973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r82234052"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/82234052"
         }
      },
      "body" : "Any idea why we use a different time for inbound vs outbound peers? If anything I'd think we'd announce our real time to inbound peers and our adjusted time to outbound ones, but we do the opposite.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-06T16:54:55Z",
      "diff_hunk" : "@@ -5038,7 +5038,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         // Be shy and don't send version until we hear\n         if (pfrom->fInbound)\n-            pfrom->PushVersion();\n+            connman.PushVersion(pfrom, GetAdjustedTime());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r82234052",
      "id" : 82234052,
      "original_commit_id" : "c295afaf9ebba0c58b227d4c4917e47f2ee2869f",
      "original_position" : 128,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 3155834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/82234052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r82235142"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/82235142"
         }
      },
      "body" : "Can we go ahead and move the PushVersion logic into InitializeNode? I think thats the right place since it will move into net_processing.cpp with the rest of the \"node-message-processing\" stuff.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-06T17:00:39Z",
      "diff_hunk" : "@@ -389,6 +389,9 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n \n         // Add node\n         CNode* pnode = new CNode(GetNewNodeId(), nLocalServices, GetBestHeight(), hSocket, addrConnect, CalculateKeyedNetGroup(addrConnect), pszDest ? pszDest : \"\", false);\n+\n+        PushVersion(pnode, GetTime());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r82235142",
      "id" : 82235142,
      "original_commit_id" : "c295afaf9ebba0c58b227d4c4917e47f2ee2869f",
      "original_position" : 5,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 3155834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/82235142",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "On Oct 6, 2016 1:06 PM, \"Matt Corallo\" <notifications@github.com> wrote:\n>\n> @TheBlueMatt commented on this pull request.\n>\n> Got halfway through a review and realized I just dont know how I feel\nabout this...CNode moving towards a \"I speak to the CConnman and serialize\nmessages for the wire\" seems like a sane design (and seems to be what\nyou're going for here), but it means there is just no good place to put\nserialization-version logic that isnt a complete layer violation.\n>\n> ________________________________\n\nYea, I agree. I started creating a CSendMessage that would hold the\nserialized result, which could go directly to CConnman, but decided for the\nmore straightforward change here. I'm happy to make that change, either as\na part of this pr or after.\n\nThat has the benefit of testing the serialized result for p2p without\nactually requiring the send.\n\n>\n> In src/main.cpp:\n>\n> > @@ -5038,7 +5038,7 @@ bool static ProcessMessage(CNode* pfrom, string\nstrCommand, CDataStream& vRecv, // Be shy and don't send version until we\nhear if (pfrom->fInbound) - pfrom->PushVersion(); +\nconnman.PushVersion(pfrom, GetAdjustedTime());\n>\n> Any idea why we use a different time for inbound vs outbound peers? If\nanything I'd think we'd announce our real time to inbound peers and our\nadjusted time to outbound ones, but we do the opposite.\n>\n\nUnsure of the reason there.\n\n> ________________________________\n>\n> In src/net.cpp:\n>\n> > @@ -389,6 +389,9 @@ CNode* CConnman::ConnectNode(CAddress addrConnect,\nconst char *pszDest, bool fCo // Add node CNode* pnode = new\nCNode(GetNewNodeId(), nLocalServices, GetBestHeight(), hSocket,\naddrConnect, CalculateKeyedNetGroup(addrConnect), pszDest ? pszDest : \"\",\nfalse); + + PushVersion(pnode, GetTime());\n>\n> Can we go ahead and move the PushVersion logic into InitializeNode? I\nthink thats the right place since it will move into net_processing.cpp with\nthe rest of the \"node-message-processing\" stuff.\n>\n\nI had planned on doing exactly that as a next step, but it looked kinda out\nof place by itself. With your changes, it makes perfect sense. Happy to\nchange it to whatever makes it easier for you to move.\n\nGlad to see we're in sync :)\n\n> Ã¢ÂÂ\n> You are receiving this because you authored the thread.\n> Reply to this email directly, view it on GitHub, or mute the thread.\n",
      "created_at" : "2016-10-06T19:25:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-252063620",
      "id" : 252063620,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-10-06T19:25:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/252063620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Yea, seems like we're mostly on the same page here... Probably reasonable to give the serialization to net_processing, though I am concerned with how to merge type with P2P encryption, given that it also changes the message hashing, but only after messages are exchanged (I believe? Maybe @jonasschnelli wants to comment). Even more unsure of how to handle that.\n\nAs for this PR, I'm fine with it as it is now, noting that we want to tweak things further as we split code, though I'd prefer we go ahead and move the version message handling to Initialize so we don't end up moving the same block three times.\n\nOn October 6, 2016 3:25:54 PM EDT, Cory Fields <notifications@github.com> wrote:\n>On Oct 6, 2016 1:06 PM, \"Matt Corallo\" <notifications@github.com>\n>wrote:\n>>\n>> @TheBlueMatt commented on this pull request.\n>>\n>> Got halfway through a review and realized I just dont know how I feel\n>about this...CNode moving towards a \"I speak to the CConnman and\n>serialize\n>messages for the wire\" seems like a sane design (and seems to be what\n>you're going for here), but it means there is just no good place to put\n>serialization-version logic that isnt a complete layer violation.\n>>\n>> ________________________________\n>\n>Yea, I agree. I started creating a CSendMessage that would hold the\n>serialized result, which could go directly to CConnman, but decided for\n>the\n>more straightforward change here. I'm happy to make that change, either\n>as\n>a part of this pr or after.\n>\n>That has the benefit of testing the serialized result for p2p without\n>actually requiring the send.\n>\n>>\n>> In src/main.cpp:\n>>\n>> > @@ -5038,7 +5038,7 @@ bool static ProcessMessage(CNode* pfrom,\n>string\n>strCommand, CDataStream& vRecv, // Be shy and don't send version until\n>we\n>hear if (pfrom->fInbound) - pfrom->PushVersion(); +\n>connman.PushVersion(pfrom, GetAdjustedTime());\n>>\n>> Any idea why we use a different time for inbound vs outbound peers?\n>If\n>anything I'd think we'd announce our real time to inbound peers and our\n>adjusted time to outbound ones, but we do the opposite.\n>>\n>\n>Unsure of the reason there.\n>\n>> ________________________________\n>>\n>> In src/net.cpp:\n>>\n>> > @@ -389,6 +389,9 @@ CNode* CConnman::ConnectNode(CAddress\n>addrConnect,\n>const char *pszDest, bool fCo // Add node CNode* pnode = new\n>CNode(GetNewNodeId(), nLocalServices, GetBestHeight(), hSocket,\n>addrConnect, CalculateKeyedNetGroup(addrConnect), pszDest ? pszDest :\n>\"\",\n>false); + + PushVersion(pnode, GetTime());\n>>\n>> Can we go ahead and move the PushVersion logic into InitializeNode? I\n>think thats the right place since it will move into net_processing.cpp\n>with\n>the rest of the \"node-message-processing\" stuff.\n>>\n>\n>I had planned on doing exactly that as a next step, but it looked kinda\n>out\n>of place by itself. With your changes, it makes perfect sense. Happy to\n>change it to whatever makes it easier for you to move.\n>\n>Glad to see we're in sync :)\n>\n>> Ã¢ÂÂ\n>> You are receiving this because you authored the thread.\n>> Reply to this email directly, view it on GitHub, or mute the thread.\n>\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-252063620\n",
      "created_at" : "2016-10-06T19:47:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-252068880",
      "id" : 252068880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-10-06T19:47:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/252068880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Needs rebase",
      "created_at" : "2016-10-25T10:44:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-256001031",
      "id" : 256001031,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-10-25T10:44:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/256001031",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "rebased.\r\n\r\n@TheBlueMatt I added some commits to handle the version push in InitializeNode. I left the serialization happening in CConnman for now. Agreed that it's a layer violation and have plans for separating it, but I'd prefer not to change the scope here too much unless you hugely object.",
      "created_at" : "2016-10-27T18:47:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-256734266",
      "id" : 256734266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-10-27T18:47:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/256734266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85550766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85550766"
         }
      },
      "body" : "GetSendVersion needs a lock (or make it atomic with release/aquire).",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T15:14:38Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85550766",
      "id" : 85550766,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 168,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 6260993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85550766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85551047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85551047"
         }
      },
      "body" : "Can you move this up to cover the MESSAGE_SIZE_OFFSET write two lines up?",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T15:16:05Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n }\n \n-void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::EndMessage(CDataStream& strm)\n {\n-    ssSend.clear();\n-\n-    LEAVE_CRITICAL_SECTION(cs_vSend);\n+    // Set the size\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    assert(strm.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85551047",
      "id" : 85551047,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 182,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 6260993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85551047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85552065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85552065"
         }
      },
      "body" : "strm can be const, I believe? Would be nice to go ahead and do that since I'd like to use this to create a cmpctblock fully-encoded message once and then just call this on each node that wants it.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T15:20:52Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n }\n \n-void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::EndMessage(CDataStream& strm)\n {\n-    ssSend.clear();\n-\n-    LEAVE_CRITICAL_SECTION(cs_vSend);\n+    // Set the size\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    assert(strm.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);\n+    memcpy((char*)&strm[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n-    LogPrint(\"net\", \"(aborted)\\n\");\n }\n \n-void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::PushMessage(CNode* pnode, CDataStream& strm, const std::string& sCommand)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85552065",
      "id" : 85552065,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 189,
      "path" : "src/net.cpp",
      "position" : 194,
      "pull_request_review_id" : 6260993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85552065",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85557182"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85557182"
         }
      },
      "body" : "nit: I'd kinda prefer we not move PushVersion twice.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T15:46:11Z",
      "diff_hunk" : "@@ -411,6 +414,24 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n     return NULL;\n }\n \n+void CConnman::PushVersion(CNode* pnode, int64_t nTime)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85557182",
      "id" : 85557182,
      "original_commit_id" : "22d4b518ae0488db6a5a05597bc7a51b0c4c54bf",
      "original_position" : 14,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 6260993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85557182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85561634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85561634"
         }
      },
      "body" : "This is a slight change in behavior - we are now pushing our non-adjusted time to all peers, instead of just outbound peers. Not actually sure if it matters, but taking note here.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T16:10:11Z",
      "diff_hunk" : "@@ -354,11 +355,36 @@ void UpdatePreferredDownload(CNode* node, CNodeState* state)\n     nPreferredDownload += state->fPreferredDownload;\n }\n \n-void InitializeNode(NodeId nodeid, const CNode *pnode) {\n-    LOCK(cs_main);\n-    CNodeState &state = mapNodeState.insert(std::make_pair(nodeid, CNodeState())).first->second;\n-    state.name = pnode->addrName;\n-    state.address = pnode->addr;\n+void PushNodeVersion(CNode *pnode, CConnman& connman)\n+{\n+    ServiceFlags nLocalNodeServices = pnode->GetLocalServices();\n+    uint64_t nonce = pnode->GetLocalNonce();\n+    int nNodeStartingHeight = pnode->GetMyStartingHeight();\n+    NodeId nodeid = pnode->GetId();\n+    CAddress addr = pnode->addr;\n+\n+    CAddress addrYou = (addr.IsRoutable() && !IsProxy(addr) ? addr : CAddress(CService(), addr.nServices));\n+    CAddress addrMe = CAddress(CService(), nLocalNodeServices);\n+\n+    connman.PushMessageWithVersion(pnode, INIT_PROTO_VERSION, NetMsgType::VERSION, PROTOCOL_VERSION, (uint64_t)nLocalNodeServices, GetTime(), addrYou, addrMe,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85561634",
      "id" : 85561634,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 55,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 6260993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85561634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85562449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85562449"
         }
      },
      "body" : "I think half the functions here need locks or to become atomics to be correct. (unless I'm missing a required lock to call this function, in which case please AssertLockHeld to make it obvious).\r\n\r\nMay be easiest to just make half the ints in CNode atomic.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T16:15:12Z",
      "diff_hunk" : "@@ -354,11 +355,36 @@ void UpdatePreferredDownload(CNode* node, CNodeState* state)\n     nPreferredDownload += state->fPreferredDownload;\n }\n \n-void InitializeNode(NodeId nodeid, const CNode *pnode) {\n-    LOCK(cs_main);\n-    CNodeState &state = mapNodeState.insert(std::make_pair(nodeid, CNodeState())).first->second;\n-    state.name = pnode->addrName;\n-    state.address = pnode->addr;\n+void PushNodeVersion(CNode *pnode, CConnman& connman)\n+{\n+    ServiceFlags nLocalNodeServices = pnode->GetLocalServices();\n+    uint64_t nonce = pnode->GetLocalNonce();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85562449",
      "id" : 85562449,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 47,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 6260993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85562449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85563508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85563508"
         }
      },
      "body" : "See https://github.com/bitcoin/bitcoin/pull/8708/files#diff-1a8b9d1ad0a6fda5e751286c73102fc2R755",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T16:21:06Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85563508",
      "id" : 85563508,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 168,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 6274660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85563508",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85563670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85563670"
         }
      },
      "body" : "ok",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T16:21:55Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n }\n \n-void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::EndMessage(CDataStream& strm)\n {\n-    ssSend.clear();\n-\n-    LEAVE_CRITICAL_SECTION(cs_vSend);\n+    // Set the size\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    assert(strm.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);\n+    memcpy((char*)&strm[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n-    LogPrint(\"net\", \"(aborted)\\n\");\n }\n \n-void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::PushMessage(CNode* pnode, CDataStream& strm, const std::string& sCommand)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85563670",
      "id" : 85563670,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 189,
      "path" : "src/net.cpp",
      "position" : 194,
      "pull_request_review_id" : 6274808,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85563670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85563886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85563886"
         }
      },
      "body" : "This value doesn't change. I have a branch with additional commits that turns a bunch of stuff into const to make it clear that it's threadsafe. I could add those here if you'd like?",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T16:23:01Z",
      "diff_hunk" : "@@ -354,11 +355,36 @@ void UpdatePreferredDownload(CNode* node, CNodeState* state)\n     nPreferredDownload += state->fPreferredDownload;\n }\n \n-void InitializeNode(NodeId nodeid, const CNode *pnode) {\n-    LOCK(cs_main);\n-    CNodeState &state = mapNodeState.insert(std::make_pair(nodeid, CNodeState())).first->second;\n-    state.name = pnode->addrName;\n-    state.address = pnode->addr;\n+void PushNodeVersion(CNode *pnode, CConnman& connman)\n+{\n+    ServiceFlags nLocalNodeServices = pnode->GetLocalServices();\n+    uint64_t nonce = pnode->GetLocalNonce();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85563886",
      "id" : 85563886,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 47,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 6274996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85563886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85563968"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85563968"
         }
      },
      "body" : "Whoops, good catch. That was not intentional. Will fix.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T16:23:26Z",
      "diff_hunk" : "@@ -354,11 +355,36 @@ void UpdatePreferredDownload(CNode* node, CNodeState* state)\n     nPreferredDownload += state->fPreferredDownload;\n }\n \n-void InitializeNode(NodeId nodeid, const CNode *pnode) {\n-    LOCK(cs_main);\n-    CNodeState &state = mapNodeState.insert(std::make_pair(nodeid, CNodeState())).first->second;\n-    state.name = pnode->addrName;\n-    state.address = pnode->addr;\n+void PushNodeVersion(CNode *pnode, CConnman& connman)\n+{\n+    ServiceFlags nLocalNodeServices = pnode->GetLocalServices();\n+    uint64_t nonce = pnode->GetLocalNonce();\n+    int nNodeStartingHeight = pnode->GetMyStartingHeight();\n+    NodeId nodeid = pnode->GetId();\n+    CAddress addr = pnode->addr;\n+\n+    CAddress addrYou = (addr.IsRoutable() && !IsProxy(addr) ? addr : CAddress(CService(), addr.nServices));\n+    CAddress addrMe = CAddress(CService(), nLocalNodeServices);\n+\n+    connman.PushMessageWithVersion(pnode, INIT_PROTO_VERSION, NetMsgType::VERSION, PROTOCOL_VERSION, (uint64_t)nLocalNodeServices, GetTime(), addrYou, addrMe,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85563968",
      "id" : 85563968,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 55,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 6275075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85563968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85565594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85565594"
         }
      },
      "body" : "This violates C++ spec - nSendVersion must exist non-const somewhere for const_cast to be permitted (I believe).",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T16:33:40Z",
      "diff_hunk" : "@@ -716,6 +752,25 @@ class CNode\n         BOOST_FOREACH(CNetMessage &msg, vRecvMsg)\n             msg.SetVersion(nVersionIn);\n     }\n+    void SetSendVersion(int nVersionIn)\n+    {\n+        // Send version may only be changed in the version message, and\n+        // only one version message is allowed per session. We can therefore\n+        // treat this value as const and even atomic as long as it's only used\n+        // once the handshake is complete. Any attempt to set this twice is an\n+        // error.\n+        assert(nSendVersion == 0);\n+        *const_cast<int*>(&nSendVersion) = nVersionIn;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85565594",
      "id" : 85565594,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 116,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 6276668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85565594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85575157"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85575157"
         }
      },
      "body" : "Ok, I'll just change this back to non-const. The const was only to prove that it's not racy, since it can only be set once.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T17:31:35Z",
      "diff_hunk" : "@@ -716,6 +752,25 @@ class CNode\n         BOOST_FOREACH(CNetMessage &msg, vRecvMsg)\n             msg.SetVersion(nVersionIn);\n     }\n+    void SetSendVersion(int nVersionIn)\n+    {\n+        // Send version may only be changed in the version message, and\n+        // only one version message is allowed per session. We can therefore\n+        // treat this value as const and even atomic as long as it's only used\n+        // once the handshake is complete. Any attempt to set this twice is an\n+        // error.\n+        assert(nSendVersion == 0);\n+        *const_cast<int*>(&nSendVersion) = nVersionIn;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85575157",
      "id" : 85575157,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 116,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 6285694,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85575157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85576672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85576672"
         }
      },
      "body" : "ok",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T17:40:39Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n }\n \n-void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::EndMessage(CDataStream& strm)\n {\n-    ssSend.clear();\n-\n-    LEAVE_CRITICAL_SECTION(cs_vSend);\n+    // Set the size\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    assert(strm.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85576672",
      "id" : 85576672,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 182,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 6287108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85576672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85599665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85599665"
         }
      },
      "body" : "Er, this isn't intended to be used that way. This is internal and should be private.\r\n\r\nThe next set of changes will introduce a CSendMessage which is fully serialized. PushMessage will take that instead. That fixes the current layer violation here, and your issue at the same time I think?",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T19:55:34Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n }\n \n-void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::EndMessage(CDataStream& strm)\n {\n-    ssSend.clear();\n-\n-    LEAVE_CRITICAL_SECTION(cs_vSend);\n+    // Set the size\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    assert(strm.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);\n+    memcpy((char*)&strm[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n-    LogPrint(\"net\", \"(aborted)\\n\");\n }\n \n-void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::PushMessage(CNode* pnode, CDataStream& strm, const std::string& sCommand)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85599665",
      "id" : 85599665,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 189,
      "path" : "src/net.cpp",
      "position" : 194,
      "pull_request_review_id" : 6309143,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85599665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85611924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85611924"
         }
      },
      "body" : "OK, sounds good.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T21:17:54Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n }\n \n-void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::EndMessage(CDataStream& strm)\n {\n-    ssSend.clear();\n-\n-    LEAVE_CRITICAL_SECTION(cs_vSend);\n+    // Set the size\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    assert(strm.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);\n+    memcpy((char*)&strm[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n-    LogPrint(\"net\", \"(aborted)\\n\");\n }\n \n-void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::PushMessage(CNode* pnode, CDataStream& strm, const std::string& sCommand)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85611924",
      "id" : 85611924,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 189,
      "path" : "src/net.cpp",
      "position" : 194,
      "pull_request_review_id" : 6321072,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85611924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85612275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85612275"
         }
      },
      "body" : "I'm ok with this happening in a separate PR, as AFAICT there are already dragons here, but should definitely happen before 0.14.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-28T21:20:17Z",
      "diff_hunk" : "@@ -354,11 +355,36 @@ void UpdatePreferredDownload(CNode* node, CNodeState* state)\n     nPreferredDownload += state->fPreferredDownload;\n }\n \n-void InitializeNode(NodeId nodeid, const CNode *pnode) {\n-    LOCK(cs_main);\n-    CNodeState &state = mapNodeState.insert(std::make_pair(nodeid, CNodeState())).first->second;\n-    state.name = pnode->addrName;\n-    state.address = pnode->addr;\n+void PushNodeVersion(CNode *pnode, CConnman& connman)\n+{\n+    ServiceFlags nLocalNodeServices = pnode->GetLocalServices();\n+    uint64_t nonce = pnode->GetLocalNonce();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85612275",
      "id" : 85612275,
      "original_commit_id" : "f14fc2e48aa4b4bcd5efe27fa168126f118067cb",
      "original_position" : 47,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 6321420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85612275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Updated for @TheBlueMatt's nits. Since the changes were very small, I went ahead and squashed.\r\n\r\nPRs are coming up to address the const issues, as well as fixing the serialization layer violation.",
      "created_at" : "2016-10-29T20:38:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-257114685",
      "id" : 257114685,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-10-29T20:38:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/257114685",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85853183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85853183"
         }
      },
      "body" : "This assert needs to move up a line.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-31T23:22:22Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n }\n \n-void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::EndMessage(CDataStream& strm)\n {\n-    ssSend.clear();\n-\n-    LEAVE_CRITICAL_SECTION(cs_vSend);\n+    // Set the size\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    assert(strm.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85853183",
      "id" : 85853183,
      "original_commit_id" : "2df814b2ecfcfe67f5a7419b662df1ec1efd9d2d",
      "original_position" : 180,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 6544142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85853183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85853325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85853325"
         }
      },
      "body" : "nit: any reason you changed the text here? It used to read \"sending: %s (%d bytes) peer=%d\\n\", SanitizeString(pszCommand, nSize, id) (split across two lines).",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-10-31T23:23:37Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n }\n \n-void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::EndMessage(CDataStream& strm)\n {\n-    ssSend.clear();\n-\n-    LEAVE_CRITICAL_SECTION(cs_vSend);\n+    // Set the size\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    assert(strm.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    memcpy((char*)&strm[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n-    LogPrint(\"net\", \"(aborted)\\n\");\n }\n \n-void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::PushMessage(CNode* pnode, CDataStream& strm, const std::string& sCommand)\n {\n-    // The -*messagestest options are intentionally not documented in the help message,\n-    // since they are only used during development to debug the networking code and are\n-    // not intended for end-users.\n-    if (mapArgs.count(\"-dropmessagestest\") && GetRand(GetArg(\"-dropmessagestest\", 2)) == 0)\n-    {\n-        LogPrint(\"net\", \"dropmessages DROPPING SEND MESSAGE\\n\");\n-        AbortMessage();\n-        return;\n-    }\n-    if (mapArgs.count(\"-fuzzmessagestest\"))\n-        Fuzz(GetArg(\"-fuzzmessagestest\", 10));\n-\n-    if (ssSend.size() == 0)\n-    {\n-        LEAVE_CRITICAL_SECTION(cs_vSend);\n+    if(strm.empty())\n         return;\n-    }\n-    // Set the size\n-    unsigned int nSize = ssSend.size() - CMessageHeader::HEADER_SIZE;\n-    WriteLE32((uint8_t*)&ssSend[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n-\n-    //log total amount of bytes per command\n-    mapSendBytesPerMsgCmd[std::string(pszCommand)] += nSize + CMessageHeader::HEADER_SIZE;\n \n-    // Set the checksum\n-    uint256 hash = Hash(ssSend.begin() + CMessageHeader::HEADER_SIZE, ssSend.end());\n-    assert(ssSend.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);\n-    memcpy((char*)&ssSend[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    LogPrint(\"net\", \"%s (%d bytes) peer=%d\\n\", sCommand.c_str(), nSize, pnode->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85853325",
      "id" : 85853325,
      "original_commit_id" : "2df814b2ecfcfe67f5a7419b662df1ec1efd9d2d",
      "original_position" : 221,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 6544142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85853325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85857968"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85857968"
         }
      },
      "body" : "I cant see anything wrong with this, but it seems obviously equivalent...what was the reason for nOptimisticBytesSent previously?",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-01T00:07:26Z",
      "diff_hunk" : "@@ -1156,10 +1137,6 @@ void CConnman::ThreadSocketHandler()\n                 {\n                     TRY_LOCK(pnode->cs_vSend, lockSend);\n                     if (lockSend) {\n-                        if (pnode->nOptimisticBytesWritten) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r85857968",
      "id" : 85857968,
      "original_commit_id" : "2df814b2ecfcfe67f5a7419b662df1ec1efd9d2d",
      "original_position" : 69,
      "path" : "src/net.cpp",
      "position" : 70,
      "pull_request_review_id" : 6544142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85857968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86025323"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86025323"
         }
      },
      "body" : "No, they just ended up combined since the actual data push is all done in one place now.\r\n\r\nIs there a reason to prefer having them split? How about adding back the \"sending\" for easy grepping, and the sanitizestring for extra paranoia, but leaving it as a combined message?",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-01T21:08:04Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n }\n \n-void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::EndMessage(CDataStream& strm)\n {\n-    ssSend.clear();\n-\n-    LEAVE_CRITICAL_SECTION(cs_vSend);\n+    // Set the size\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    assert(strm.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    memcpy((char*)&strm[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n-    LogPrint(\"net\", \"(aborted)\\n\");\n }\n \n-void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::PushMessage(CNode* pnode, CDataStream& strm, const std::string& sCommand)\n {\n-    // The -*messagestest options are intentionally not documented in the help message,\n-    // since they are only used during development to debug the networking code and are\n-    // not intended for end-users.\n-    if (mapArgs.count(\"-dropmessagestest\") && GetRand(GetArg(\"-dropmessagestest\", 2)) == 0)\n-    {\n-        LogPrint(\"net\", \"dropmessages DROPPING SEND MESSAGE\\n\");\n-        AbortMessage();\n-        return;\n-    }\n-    if (mapArgs.count(\"-fuzzmessagestest\"))\n-        Fuzz(GetArg(\"-fuzzmessagestest\", 10));\n-\n-    if (ssSend.size() == 0)\n-    {\n-        LEAVE_CRITICAL_SECTION(cs_vSend);\n+    if(strm.empty())\n         return;\n-    }\n-    // Set the size\n-    unsigned int nSize = ssSend.size() - CMessageHeader::HEADER_SIZE;\n-    WriteLE32((uint8_t*)&ssSend[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n-\n-    //log total amount of bytes per command\n-    mapSendBytesPerMsgCmd[std::string(pszCommand)] += nSize + CMessageHeader::HEADER_SIZE;\n \n-    // Set the checksum\n-    uint256 hash = Hash(ssSend.begin() + CMessageHeader::HEADER_SIZE, ssSend.end());\n-    assert(ssSend.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);\n-    memcpy((char*)&ssSend[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    LogPrint(\"net\", \"%s (%d bytes) peer=%d\\n\", sCommand.c_str(), nSize, pnode->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86025323",
      "id" : 86025323,
      "original_commit_id" : "2df814b2ecfcfe67f5a7419b662df1ec1efd9d2d",
      "original_position" : 221,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 6705324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86025323",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86026899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86026899"
         }
      },
      "body" : "It was a hack. In fact, this PR was originally created to fix this.\r\n\r\nIf the node is in charge of pushing data, Connman has no way of knowing if optimistic writes have succeeded. The hackish solution was to cache the periodically check for optimistic written bytes (stored by CNode) and add them to the node's total, but that fails miserably if the optimistic writes succeed most of the time.\r\n\r\nNow that CConnman is in charge of the writes, it knows immediately how much was written, and doesn't have to try to catch up with it later.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-01T21:15:39Z",
      "diff_hunk" : "@@ -1156,10 +1137,6 @@ void CConnman::ThreadSocketHandler()\n                 {\n                     TRY_LOCK(pnode->cs_vSend, lockSend);\n                     if (lockSend) {\n-                        if (pnode->nOptimisticBytesWritten) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86026899",
      "id" : 86026899,
      "original_commit_id" : "2df814b2ecfcfe67f5a7419b662df1ec1efd9d2d",
      "original_position" : 69,
      "path" : "src/net.cpp",
      "position" : 70,
      "pull_request_review_id" : 6706787,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86026899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Oh totally, didn't mean to imply the sending message should be two prints, just that you changed the text spuriously.\n\nOn November 1, 2016 5:08:13 PM EDT, Cory Fields <notifications@github.com> wrote:\n>theuni commented on this pull request.\n>\n>\n>\n>>  \n>-    // Set the checksum\n>-    uint256 hash = Hash(ssSend.begin() + CMessageHeader::HEADER_SIZE,\n>ssSend.end());\n>-    assert(ssSend.size () >= CMessageHeader::CHECKSUM_OFFSET +\n>CMessageHeader::CHECKSUM_SIZE);\n>-    memcpy((char*)&ssSend[CMessageHeader::CHECKSUM_OFFSET],\n>hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n>+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n>+    LogPrint(\"net\", \"%s (%d bytes) peer=%d\\n\", sCommand.c_str(),\n>nSize, pnode->id);\n>\n>No, they just ended up combined since the actual data push is all done\n>in one place now.\n>\n>Is there a reason to prefer having them split? How about adding back\n>the \"sending\" for easy grepping, and the sanitizestring for extra\n>paranoia, but leaving it as a combined message?\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/8708\n",
      "created_at" : "2016-11-01T21:44:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-257708109",
      "id" : 257708109,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-11-01T21:44:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/257708109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86237688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86237688"
         }
      },
      "body" : "Good to get rid of this repetition.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-02T20:42:43Z",
      "diff_hunk" : "@@ -778,193 +829,6 @@ class CNode\n \n     void AskFor(const CInv& inv);\n \n-    // TODO: Document the postcondition of this function.  Is cs_vSend locked?\n-    void BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend);\n-\n-    // TODO: Document the precondition of this function.  Is cs_vSend locked?\n-    void AbortMessage() UNLOCK_FUNCTION(cs_vSend);\n-\n-    // TODO: Document the precondition of this function.  Is cs_vSend locked?\n-    void EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend);\n-\n-    void PushVersion();\n-\n-\n-    void PushMessage(const char* pszCommand)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86237688",
      "id" : 86237688,
      "original_commit_id" : "19d3daef936905743ef108aee1ccfe46fd77b283",
      "original_position" : 142,
      "path" : "src/net.h",
      "position" : 142,
      "pull_request_review_id" : 6905681,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86237688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86238256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86238256"
         }
      },
      "body" : "Yeah, I don't think anyone is using these, or has been using these for years.\r\nWould be nice to get #7940 in at some point, it provides a better fuzzing framework which is not dependent on the network code.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-02T20:45:30Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n }\n \n-void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::EndMessage(CDataStream& strm)\n {\n-    ssSend.clear();\n-\n-    LEAVE_CRITICAL_SECTION(cs_vSend);\n+    // Set the size\n+    assert(strm.size () >= CMessageHeader::HEADER_SIZE);\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    memcpy((char*)&strm[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n-    LogPrint(\"net\", \"(aborted)\\n\");\n }\n \n-void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::PushMessage(CNode* pnode, CDataStream& strm, const std::string& sCommand)\n {\n-    // The -*messagestest options are intentionally not documented in the help message,\n-    // since they are only used during development to debug the networking code and are\n-    // not intended for end-users.\n-    if (mapArgs.count(\"-dropmessagestest\") && GetRand(GetArg(\"-dropmessagestest\", 2)) == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86238256",
      "id" : 86238256,
      "original_commit_id" : "19d3daef936905743ef108aee1ccfe46fd77b283",
      "original_position" : 194,
      "path" : "src/net.cpp",
      "position" : 199,
      "pull_request_review_id" : 6906233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86238256",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86239425"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86239425"
         }
      },
      "body" : "These are not used?",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-02T20:51:19Z",
      "diff_hunk" : "@@ -136,6 +136,33 @@ class CConnman\n \n     bool ForNode(NodeId id, std::function<bool(CNode* pnode)> func);\n \n+    template <typename... Args>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86239425",
      "id" : 86239425,
      "original_commit_id" : "19d3daef936905743ef108aee1ccfe46fd77b283",
      "original_position" : 4,
      "path" : "src/net.h",
      "position" : 4,
      "pull_request_review_id" : 6907380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86239425",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "How does this overlap with #9039? That pull changes the serialization framework to get rid of nVersion and nType in many places, does that mean some things can be simpllified here?",
      "created_at" : "2016-11-02T20:51:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-257995143",
      "id" : 257995143,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-11-02T20:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/257995143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86251045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86251045"
         }
      },
      "body" : "@laanwj looks like I missed #7940. Agree with doing it at a lower level.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-02T21:52:34Z",
      "diff_hunk" : "@@ -2625,65 +2562,50 @@ void CNode::AskFor(const CInv& inv)\n     mapAskFor.insert(std::make_pair(nRequestTime, inv));\n }\n \n-void CNode::BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n {\n-    ENTER_CRITICAL_SECTION(cs_vSend);\n-    assert(ssSend.size() == 0);\n-    ssSend << CMessageHeader(Params().MessageStart(), pszCommand, 0);\n-    LogPrint(\"net\", \"sending: %s \", SanitizeString(pszCommand));\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n }\n \n-void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::EndMessage(CDataStream& strm)\n {\n-    ssSend.clear();\n-\n-    LEAVE_CRITICAL_SECTION(cs_vSend);\n+    // Set the size\n+    assert(strm.size () >= CMessageHeader::HEADER_SIZE);\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    memcpy((char*)&strm[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n-    LogPrint(\"net\", \"(aborted)\\n\");\n }\n \n-void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n+void CConnman::PushMessage(CNode* pnode, CDataStream& strm, const std::string& sCommand)\n {\n-    // The -*messagestest options are intentionally not documented in the help message,\n-    // since they are only used during development to debug the networking code and are\n-    // not intended for end-users.\n-    if (mapArgs.count(\"-dropmessagestest\") && GetRand(GetArg(\"-dropmessagestest\", 2)) == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86251045",
      "id" : 86251045,
      "original_commit_id" : "19d3daef936905743ef108aee1ccfe46fd77b283",
      "original_position" : 194,
      "path" : "src/net.cpp",
      "position" : 199,
      "pull_request_review_id" : 6918508,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86251045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "I believe the removal of CNode::Fuzz maybe remove the need for CDataStream::insert or CDataStream::erase.",
      "created_at" : "2016-11-02T21:56:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-258011822",
      "id" : 258011822,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-11-02T21:56:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/258011822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "As for overlap with #9039, I expect it to be trivial: just dropping the nVersion and nType everywhere. I'm happy to rebase #9039 on top of this if it gets merged first.",
      "created_at" : "2016-11-02T21:57:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-258012097",
      "id" : 258012097,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-11-02T21:57:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/258012097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86252941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86252941"
         }
      },
      "body" : "PushMessageWithVersionAndFlag could be private I suppose. It's only used by the others.\r\n\r\nPushMessageWithFlag is the same as before.\r\n\r\nPushMessageWithVersion is used explicitly before the handshake is complete, before we know what upgraded version to use.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-02T22:03:34Z",
      "diff_hunk" : "@@ -136,6 +136,33 @@ class CConnman\n \n     bool ForNode(NodeId id, std::function<bool(CNode* pnode)> func);\n \n+    template <typename... Args>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86252941",
      "id" : 86252941,
      "original_commit_id" : "19d3daef936905743ef108aee1ccfe46fd77b283",
      "original_position" : 4,
      "path" : "src/net.h",
      "position" : 4,
      "pull_request_review_id" : 6920232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86252941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86254156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86254156"
         }
      },
      "body" : "Note that as next steps, an intermediary and fully serialized \"CSendMessage\" (or so) class will be added, which CConnman accepts rather than bare arguments, and forwards to the network. This makes CConnman mostly oblivious as to what it's pushing (other than the type of message), which further improves encapsulation.\r\n\r\nAlso, The sendversion logic will move to CNodeState once the locking situation there is improved.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-02T22:10:23Z",
      "diff_hunk" : "@@ -136,6 +136,33 @@ class CConnman\n \n     bool ForNode(NodeId id, std::function<bool(CNode* pnode)> func);\n \n+    template <typename... Args>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86254156",
      "id" : 86254156,
      "original_commit_id" : "19d3daef936905743ef108aee1ccfe46fd77b283",
      "original_position" : 4,
      "path" : "src/net.h",
      "position" : 4,
      "pull_request_review_id" : 6921403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86254156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Agree with @sipa. Either order is fine by me.",
      "created_at" : "2016-11-02T23:07:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-258026499",
      "id" : 258026499,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-11-02T23:07:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/258026499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86274670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86274670"
         }
      },
      "body" : "@TheBlueMatt I'm not sure I see the reasoning for either. I'd expect us to use our best guess of time everywhere.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-03T01:16:58Z",
      "diff_hunk" : "@@ -5038,7 +5038,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         // Be shy and don't send version until we hear\n         if (pfrom->fInbound)\n-            pfrom->PushVersion();\n+            connman.PushVersion(pfrom, GetAdjustedTime());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86274670",
      "id" : 86274670,
      "original_commit_id" : "c295afaf9ebba0c58b227d4c4917e47f2ee2869f",
      "original_position" : 128,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 6940362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86274670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86291466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86291466"
         }
      },
      "body" : "That's pretty hard to read. Can you factor the version logic out, or at least combine as `(nVersion ? nVersion : pnode->GetSendVersion()) | flags`?",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-03T06:41:20Z",
      "diff_hunk" : "@@ -2686,6 +2687,52 @@ void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n     LEAVE_CRITICAL_SECTION(cs_vSend);\n }\n \n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n+{\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86291466",
      "id" : 86291466,
      "original_commit_id" : "01fec5473e6c9e8a7d9df449c29b8bc741b79ca2",
      "original_position" : 86,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 6955622,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86291466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86291785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86291785"
         }
      },
      "body" : "Not for this PR, but we should try to make a CSerializeData move-constructable from a CDataStream, and make PushMessage take a CDataStream&& perhaps. Or is this going away anyway?",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-03T06:47:55Z",
      "diff_hunk" : "@@ -2686,6 +2687,52 @@ void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n     LEAVE_CRITICAL_SECTION(cs_vSend);\n }\n \n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n+{\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n+}\n+\n+void CConnman::EndMessage(CDataStream& strm)\n+{\n+    // Set the size\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    assert(strm.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    memcpy((char*)&strm[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n+\n+}\n+\n+void CConnman::PushMessage(CNode* pnode, CDataStream& strm, const std::string& sCommand)\n+{\n+    if(strm.empty())\n+        return;\n+\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    LogPrint(\"net\", \"%s (%d bytes) peer=%d\\n\", sCommand.c_str(), nSize, pnode->id);\n+\n+    size_t nBytesSent = 0;\n+    {\n+        LOCK(pnode->cs_vSend);\n+        if(pnode->hSocket == INVALID_SOCKET) {\n+            return;\n+        }\n+        bool optimisticSend(pnode->vSendMsg.empty());\n+        pnode->vSendMsg.emplace_back(strm.begin(), strm.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86291785",
      "id" : 86291785,
      "original_commit_id" : "01fec5473e6c9e8a7d9df449c29b8bc741b79ca2",
      "original_position" : 116,
      "path" : "src/net.cpp",
      "position" : 240,
      "pull_request_review_id" : 6955622,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86291785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86292209"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86292209"
         }
      },
      "body" : "Why copy pnode->addr twice?",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-03T06:54:27Z",
      "diff_hunk" : "@@ -355,10 +355,10 @@ void UpdatePreferredDownload(CNode* node, CNodeState* state)\n }\n \n void InitializeNode(NodeId nodeid, const CNode *pnode) {\n+    CAddress addr = pnode->addr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86292209",
      "id" : 86292209,
      "original_commit_id" : "6366b1054ee70839aec41ac8af49bc8d57879526",
      "original_position" : 31,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 6955622,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86292209",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86347321"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86347321"
         }
      },
      "body" : "Will do.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-03T13:57:25Z",
      "diff_hunk" : "@@ -2686,6 +2687,52 @@ void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n     LEAVE_CRITICAL_SECTION(cs_vSend);\n }\n \n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n+{\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86347321",
      "id" : 86347321,
      "original_commit_id" : "01fec5473e6c9e8a7d9df449c29b8bc741b79ca2",
      "original_position" : 86,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 7009645,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86347321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86348466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86348466"
         }
      },
      "body" : "Yea, going away. Instead we'll have a new (very simple) stream type that serializes args for the network, which CConnman will use directly. As it'll construct in-place and be movable, it should eliminate at least 2 copies, I think.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-03T14:02:51Z",
      "diff_hunk" : "@@ -2686,6 +2687,52 @@ void CNode::EndMessage(const char* pszCommand) UNLOCK_FUNCTION(cs_vSend)\n     LEAVE_CRITICAL_SECTION(cs_vSend);\n }\n \n+CDataStream CConnman::BeginMessage(CNode* pnode, int nVersion, int flags, const std::string& sCommand)\n+{\n+    return {SER_NETWORK, nVersion ? nVersion | flags : pnode->GetSendVersion() | flags, CMessageHeader(Params().MessageStart(), sCommand.c_str(), 0) };\n+}\n+\n+void CConnman::EndMessage(CDataStream& strm)\n+{\n+    // Set the size\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&strm[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+    assert(strm.size () >= CMessageHeader::CHECKSUM_OFFSET + CMessageHeader::CHECKSUM_SIZE);\n+    // Set the checksum\n+    uint256 hash = Hash(strm.begin() + CMessageHeader::HEADER_SIZE, strm.end());\n+    memcpy((char*)&strm[CMessageHeader::CHECKSUM_OFFSET], hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n+\n+}\n+\n+void CConnman::PushMessage(CNode* pnode, CDataStream& strm, const std::string& sCommand)\n+{\n+    if(strm.empty())\n+        return;\n+\n+    unsigned int nSize = strm.size() - CMessageHeader::HEADER_SIZE;\n+    LogPrint(\"net\", \"%s (%d bytes) peer=%d\\n\", sCommand.c_str(), nSize, pnode->id);\n+\n+    size_t nBytesSent = 0;\n+    {\n+        LOCK(pnode->cs_vSend);\n+        if(pnode->hSocket == INVALID_SOCKET) {\n+            return;\n+        }\n+        bool optimisticSend(pnode->vSendMsg.empty());\n+        pnode->vSendMsg.emplace_back(strm.begin(), strm.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r86348466",
      "id" : 86348466,
      "original_commit_id" : "01fec5473e6c9e8a7d9df449c29b8bc741b79ca2",
      "original_position" : 116,
      "path" : "src/net.cpp",
      "position" : 240,
      "pull_request_review_id" : 7010793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-03T14:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86348466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Rebased after #9050. The net.cpp diff before/after the rebase:\r\n\r\n```\r\ngit diff 19d3daef936905743ef108aee1ccfe46fd77b283..c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2 -- net.cpp\r\n```\r\n can be seen here: https://gist.github.com/theuni/cc4eb87f0196ddadb637d1a41c5c5b2e.\r\n\r\nIt's just #9050 plus @sipa's simplification suggestion.",
      "created_at" : "2016-11-03T14:15:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-258154174",
      "id" : 258154174,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-11-03T14:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/258154174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Looks like it needs rebased again, sorry :/.",
      "created_at" : "2016-11-03T20:17:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-258261454",
      "id" : 258261454,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-11-03T20:18:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/258261454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "The rebase is trivial: https://github.com/sipa/bitcoin/commits/pr_8708",
      "created_at" : "2016-11-03T21:05:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-258273697",
      "id" : 258273697,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-11-03T21:05:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/258273697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Was merged via c8c572f8f1ea0a98ee3e7b3343c766ad52848bef (from sipa's rebased branch https://github.com/sipa/bitcoin/commits/pr_8708)",
      "created_at" : "2016-11-07T09:37:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-258787898",
      "id" : 258787898,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-11-07T09:37:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/258787898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Thanks!",
      "created_at" : "2016-11-07T18:58:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#issuecomment-258928221",
      "id" : 258928221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8708",
      "updated_at" : "2016-11-07T18:58:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/258928221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r87583613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/87583613"
         }
      },
      "body" : "what does it use in netbase.h?",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-11T12:52:39Z",
      "diff_hunk" : "@@ -18,6 +18,7 @@\n #include \"init.h\"\n #include \"merkleblock.h\"\n #include \"net.h\"\n+#include \"netbase.h\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r87583613",
      "id" : 87583613,
      "original_commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "original_position" : 4,
      "path" : "src/main.cpp",
      "position" : 4,
      "pull_request_review_id" : 8191772,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-11T12:52:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/87583613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r87592031"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/87592031"
         }
      },
      "body" : "@rebroad An easy way to find out is to remove the line and compile. The compiler will tell you what is used but missing.",
      "commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "created_at" : "2016-11-11T14:04:07Z",
      "diff_hunk" : "@@ -18,6 +18,7 @@\n #include \"init.h\"\n #include \"merkleblock.h\"\n #include \"net.h\"\n+#include \"netbase.h\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8708#discussion_r87592031",
      "id" : 87592031,
      "original_commit_id" : "c7b8effb96726ba5367a7b1c9c7374c4d2cc10e2",
      "original_position" : 4,
      "path" : "src/main.cpp",
      "position" : 4,
      "pull_request_review_id" : 8200406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8708",
      "updated_at" : "2016-11-11T14:04:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/87592031",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
