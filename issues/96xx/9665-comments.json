[
   {
      "body" : "Pushed a second commit which better handles compact block caching when witnesses are not present in the given block.",
      "created_at" : "2017-02-02T19:56:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9665#issuecomment-277064989",
      "id" : 277064989,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9665",
      "updated_at" : "2017-02-02T19:56:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/277064989",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r99866518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/99866518"
         }
      },
      "body" : "nit: A comment above saying that all these fields are protected by cs_most_recent_block would be nice since it's a growing list.",
      "commit_id" : "b49ad44efeaff66806d2c142273f70e2a4ddfb9d",
      "created_at" : "2017-02-07T16:39:02Z",
      "diff_hunk" : "@@ -775,6 +775,7 @@ static CCriticalSection cs_most_recent_block;\n static std::shared_ptr<const CBlock> most_recent_block;\n static std::shared_ptr<const CBlockHeaderAndShortTxIDs> most_recent_compact_block;\n static uint256 most_recent_block_hash;\n+static bool fWitnessesPresentInMostRecentCompactBlock;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r99866518",
      "id" : 99866518,
      "original_commit_id" : "9059eccf854b9bcc3c03fca7c7b6fdf38ccd48a1",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 9,
      "pull_request_review_id" : 20554811,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665",
      "updated_at" : "2017-02-23T20:41:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/99866518",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r99869460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/99869460"
         }
      },
      "body" : "Done.",
      "commit_id" : "b49ad44efeaff66806d2c142273f70e2a4ddfb9d",
      "created_at" : "2017-02-07T16:49:34Z",
      "diff_hunk" : "@@ -775,6 +775,7 @@ static CCriticalSection cs_most_recent_block;\n static std::shared_ptr<const CBlock> most_recent_block;\n static std::shared_ptr<const CBlockHeaderAndShortTxIDs> most_recent_compact_block;\n static uint256 most_recent_block_hash;\n+static bool fWitnessesPresentInMostRecentCompactBlock;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r99869460",
      "id" : 99869460,
      "original_commit_id" : "9059eccf854b9bcc3c03fca7c7b6fdf38ccd48a1",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 9,
      "pull_request_review_id" : 20557908,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665",
      "updated_at" : "2017-02-23T20:41:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/99869460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r102803292"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102803292"
         }
      },
      "body" : "I think the comment at line 1031 above should be moved down into the `else`, or deleted.",
      "commit_id" : "b49ad44efeaff66806d2c142273f70e2a4ddfb9d",
      "created_at" : "2017-02-23T19:56:33Z",
      "diff_hunk" : "@@ -1027,13 +1029,19 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                 if (send && (mi->second->nStatus & BLOCK_HAVE_DATA))\n                 {\n                     // Send block from disk\n-                    CBlock block;\n-                    if (!ReadBlockFromDisk(block, (*mi).second, consensusParams))\n-                        assert(!\"cannot load block from disk\");\n+                    std::shared_ptr<const CBlock> pblock;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r102803292",
      "id" : 102803292,
      "original_commit_id" : "4a2e1940bbd388cc42af9709bc45dab056cf981d",
      "original_position" : 33,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 23571565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665",
      "updated_at" : "2017-02-23T20:41:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102803292",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r102810877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102810877"
         }
      },
      "body" : "style nit: i think this is supposed to have curly braces around it now?",
      "commit_id" : "b49ad44efeaff66806d2c142273f70e2a4ddfb9d",
      "created_at" : "2017-02-23T20:31:45Z",
      "diff_hunk" : "@@ -1069,10 +1077,14 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                         bool fPeerWantsWitness = State(pfrom->GetId())->fWantsCmpctWitness;\n                         int nSendFlags = fPeerWantsWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;\n                         if (CanDirectFetch(consensusParams) && mi->second->nHeight >= chainActive.Height() - MAX_CMPCTBLOCK_DEPTH) {\n-                            CBlockHeaderAndShortTxIDs cmpctblock(block, fPeerWantsWitness);\n-                            connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::CMPCTBLOCK, cmpctblock));\n+                            if (fPeerWantsWitness && a_recent_compact_block && a_recent_compact_block->header.GetHash() == mi->second->GetBlockHash()) {\n+                                connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::CMPCTBLOCK, *a_recent_compact_block));\n+                            } else {\n+                                CBlockHeaderAndShortTxIDs cmpctblock(*pblock, fPeerWantsWitness);\n+                                connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::CMPCTBLOCK, cmpctblock));\n+                            }\n                         } else\n-                            connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCK, block));\n+                            connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCK, *pblock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r102810877",
      "id" : 102810877,
      "original_commit_id" : "4a2e1940bbd388cc42af9709bc45dab056cf981d",
      "original_position" : 83,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 23571565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665",
      "updated_at" : "2017-02-23T20:41:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102810877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r102812842"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102812842"
         }
      },
      "body" : "Done.",
      "commit_id" : "b49ad44efeaff66806d2c142273f70e2a4ddfb9d",
      "created_at" : "2017-02-23T20:41:59Z",
      "diff_hunk" : "@@ -1027,13 +1029,19 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                 if (send && (mi->second->nStatus & BLOCK_HAVE_DATA))\n                 {\n                     // Send block from disk\n-                    CBlock block;\n-                    if (!ReadBlockFromDisk(block, (*mi).second, consensusParams))\n-                        assert(!\"cannot load block from disk\");\n+                    std::shared_ptr<const CBlock> pblock;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r102812842",
      "id" : 102812842,
      "original_commit_id" : "4a2e1940bbd388cc42af9709bc45dab056cf981d",
      "original_position" : 33,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 23581344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665",
      "updated_at" : "2017-02-23T20:41:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102812842",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r102812852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102812852"
         }
      },
      "body" : "Done.",
      "commit_id" : "b49ad44efeaff66806d2c142273f70e2a4ddfb9d",
      "created_at" : "2017-02-23T20:42:03Z",
      "diff_hunk" : "@@ -1069,10 +1077,14 @@ void static ProcessGetData(CNode* pfrom, const Consensus::Params& consensusParam\n                         bool fPeerWantsWitness = State(pfrom->GetId())->fWantsCmpctWitness;\n                         int nSendFlags = fPeerWantsWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;\n                         if (CanDirectFetch(consensusParams) && mi->second->nHeight >= chainActive.Height() - MAX_CMPCTBLOCK_DEPTH) {\n-                            CBlockHeaderAndShortTxIDs cmpctblock(block, fPeerWantsWitness);\n-                            connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::CMPCTBLOCK, cmpctblock));\n+                            if (fPeerWantsWitness && a_recent_compact_block && a_recent_compact_block->header.GetHash() == mi->second->GetBlockHash()) {\n+                                connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::CMPCTBLOCK, *a_recent_compact_block));\n+                            } else {\n+                                CBlockHeaderAndShortTxIDs cmpctblock(*pblock, fPeerWantsWitness);\n+                                connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::CMPCTBLOCK, cmpctblock));\n+                            }\n                         } else\n-                            connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCK, block));\n+                            connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCK, *pblock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9665#discussion_r102812852",
      "id" : 102812852,
      "original_commit_id" : "4a2e1940bbd388cc42af9709bc45dab056cf981d",
      "original_position" : 83,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 23581358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9665",
      "updated_at" : "2017-02-23T20:42:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102812852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "ACK b49ad44",
      "created_at" : "2017-02-23T20:56:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9665#issuecomment-282118437",
      "id" : 282118437,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9665",
      "updated_at" : "2017-02-23T20:56:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/282118437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "utACK b49ad44efeaff66806d2c142273f70e2a4ddfb9d",
      "created_at" : "2017-02-24T04:11:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9665#issuecomment-282199294",
      "id" : 282199294,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9665",
      "updated_at" : "2017-02-24T04:11:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/282199294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
