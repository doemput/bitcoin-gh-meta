[
   {
      "body" : "No, the necessary services are determined before connecting. The code you\nare removing also does not disconnect whenever the services just differ -\nthey must differ in one of the bits set in nServicesExpected.\n\nNODE_NETWORK right now encompasses both the ability to serve historical\nblocks and the ability to relay new blocks. We should never make an\noutbound connection to nodes that do not have NODE_NETWORK, so if we notice\nthat an IP we are connecting to actually does not offer it, we should\ndisconnect and try another peer that can give us what we want.\n\nIn the future, there may indeed be a separation i  flags between the\nability to relay and the ability to serve old blocks, and we may choose to\nnot demand the old blocks capability in nExpectedServices anymore after\nIBD, but that is still something that can be determined before connecting.\n",
      "created_at" : "2016-08-24T07:03:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8571#issuecomment-241975149",
      "id" : 241975149,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8571",
      "updated_at" : "2016-08-24T07:03:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/241975149",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Sipa beat me to it here, I was going to point out the same thing.  (And if you look up conversations about pruning it was quite clear that other nodes wouldn't make connections to those nodes-- just that they'd relay blocks to those they connected out to)\r\n\r\nWithout first having a definition of what we're actually connecting to, we'd risk wasting our precious outbound slots on peers that aren't even claiming to do anything useful at all for us, not a good call. W",
      "created_at" : "2016-08-24T07:21:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8571#issuecomment-241978480",
      "id" : 241978480,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8571",
      "updated_at" : "2016-08-24T07:21:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/241978480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell I see what you are saying, and currently, there don't seem to be a shortage of NODE_NETWORK nodes that are contactable - my node was easily able to connect to 16 of them within only a few minutes of starting, so yes, we don't need to scrape the barrel by connecting to non-NODE_NETWORK nodes yet. Perhaps this discussion is premature - I do foresee a future where we might want to make better use of pruned nodes though. Can I go ahead and develop a pull request that allows pruned nodes to be entered into the address database but marks them as pruned?",
      "created_at" : "2016-08-24T09:58:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8571#issuecomment-242013919",
      "id" : 242013919,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8571",
      "updated_at" : "2016-08-26T09:11:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242013919",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "To do so, you'll need a way to advertize on the network that you're a\nvalidating and relaying node that does not serve historical blocks. That\nneeds a protocol change, and discussion on the mailing list.\n",
      "created_at" : "2016-08-24T10:09:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8571#issuecomment-242016306",
      "id" : 242016306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8571",
      "updated_at" : "2016-08-24T10:09:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242016306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I was hoping that further experience with pruning would help establish what the relevant service flags were.  I was also hoping that we'd come up with some good schemes for communications bandwidth efficient fractional chain storage.",
      "created_at" : "2016-08-24T20:47:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8571#issuecomment-242202994",
      "id" : 242202994,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8571",
      "updated_at" : "2016-08-24T20:47:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242202994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell Regarding bandwidth efficient fractional chain storage - can you elaborate on what this is? It's not clear to me from the term itself.",
      "created_at" : "2016-08-26T09:14:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8571#issuecomment-242675645",
      "id" : 242675645,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8571",
      "updated_at" : "2016-08-26T09:14:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242675645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@rebroad See here for example https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2015-May/008110.html ",
      "created_at" : "2016-08-26T12:52:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8571#issuecomment-242726958",
      "id" : 242726958,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8571",
      "updated_at" : "2016-08-26T12:52:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242726958",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa @gmaxwell Ok, I have changed this pull to address the issues. It is now two commits as I felt this was appropriate given it achieves two things. Firstly, it displays the version message prior to any disconnection logic. Secondly, it disconnects when an outgoing connection discovered irrelevant (rather than unexpected) services, as I believe was the intention, using the nRelevantServices variable as this is designed for. It also logs when a node provides unexpected services, but as long as those unexpected services are still relevant, it does not disconnect - as I can't imagine we would want this - for example, just because you get a cherry on top of your cake doesn't mean you will want to throw away the cake.\r\n\r\nI hope the logic behind this is clear, but if not, please ask/comment/etc.",
      "created_at" : "2016-08-28T07:51:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8571#issuecomment-242961602",
      "id" : 242961602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8571",
      "updated_at" : "2016-08-28T07:51:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242961602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "NACK. This will prevent segwit nodes from ever connecting to non-segwit nodes, making a petitioning more likely.\n\nnRelevantServices is called that way because they're relevant. It is not called nRequiredServices.\n\nThe reasoning is as follows: when selecting a peer to connect to, we pick based on their assumed services. Then we set the CNode::nServicesExpected based on that knowledge intersected with nRelevantServices. When the node later does not turn out to have all the flags in nServicesExpected, we disconnect, because apparently we did not connect to the node with the properties they claimed to have. This lets us move the decision criteria to the selection loop, rather than decide ad-hoc after connecting.",
      "created_at" : "2016-08-28T08:12:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8571#issuecomment-242962346",
      "id" : 242962346,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8571",
      "updated_at" : "2016-08-28T08:12:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242962346",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "ok, I'm misunderstanding the code as it is. apologies for this... ",
      "created_at" : "2016-08-29T06:03:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8571#issuecomment-243039010",
      "id" : 243039010,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8571",
      "updated_at" : "2016-08-29T06:03:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/243039010",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   }
]
