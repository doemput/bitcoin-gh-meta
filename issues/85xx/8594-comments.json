[
   {
      "body" : "@gmaxwell how does this impact on the connectivity of those [non-incoming] nodes? (that is, does it hinder them at all?)",
      "created_at" : "2016-08-25T23:55:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242582502",
      "id" : 242582502,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-25T23:57:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242582502",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "utACK 53f8f226bd1d627c4a6dec5862a1d4ea5a933e45\r\n\r\ntravis is borked",
      "created_at" : "2016-08-26T01:03:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242591646",
      "id" : 242591646,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T01:03:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242591646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=3",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "body" : "utACK",
      "created_at" : "2016-08-26T04:06:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242625387",
      "id" : 242625387,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T04:06:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242625387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@EthanHeilman any comments here?\n",
      "created_at" : "2016-08-26T07:12:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242648082",
      "id" : 242648082,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T07:12:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242648082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "utACK, this has bothered me before",
      "created_at" : "2016-08-26T09:19:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242676784",
      "id" : 242676784,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T09:19:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242676784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "utACK",
      "created_at" : "2016-08-26T13:01:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242729060",
      "id" : 242729060,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T13:01:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242729060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Can we backport this to 0.13?",
      "created_at" : "2016-08-26T13:06:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242730040",
      "id" : 242730040,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T13:06:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242730040",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa @gmaxwell Reading [main.cpp:5033](https://github.com/bitcoin/bitcoin/blob/master/src/main.cpp#L5033), my understanding is that incoming connections are only added to the tried table if the source IP address of the TCP connection is the same as the IP address supplied in the version message. [The assumption here is that if the peer's IP in the version message is the same as the IP in TCP connect, the peer can accept incoming connections](https://github.com/bitcoin/bitcoin/blob/master/src/addrman.h#L127). This assumption can be violated under two conditions:\r\n\r\n1. Nothing prevents a malicious peer behind a NAT from altering the IP address in the version message to make it look like it is not behind a NAT. While this is less than ideal an attacker can only do this once per IP address they control. This is certainly better than the protections provided by address messages where a malicious peer controlling a single IP address can inject up to ~2048 IP addresses into the new table via address messages (this is an approximate back of the envelope calculation).\r\n\r\n2. A peer might not accept incoming connections but still may not be behind a NAT. It is unclear how common this is, but my expectation from reading bitcoind log files over the years would be that it would be that it is uncommon. We can answer this question with data.\r\n\r\nFrom a security standpoint IP addresses from address messages are more vulnerable to manipulation than IP addresses from incoming connections.\r\n\r\n>The vast majority of nodes on the network do not accept incoming connections, adding them will only slow down the process of making a successful connection in the future.\r\n\r\nI am operating under the assumption that most nodes that do not accept incoming connections do so because they are behind NATs and therefore would not be added to the tried table.\r\n\r\nFor this and other reasons I would be against this change. If we want to improve the quality of the tried table perhaps confirming that an incoming connection can be connected to via a feeler connection might be a solution. Test-before-evict which I'm currently working on (proof of concept can be found at #6355) does provide some functionality like this and my recently accepted pull request #8282 did, [in tests, boost the reachable nodes in the tried table from 55 IPs to 590 IPs](https://github.com/bitcoin/bitcoin/pull/8282#issuecomment-237255215). I suspect the real problem with reachable IPs in the tried table is nodes switching IP addresses.",
      "created_at" : "2016-08-26T15:20:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242765325",
      "id" : 242765325,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T15:32:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242765325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "body" : "> Reading main.cpp:5033, my understanding is that incoming connections are only added to the tried table if the source IP address of the TCP connection is the same as the IP address supplied in the version message.\r\n\r\nDo we leak internal LAN IPs here, or is that prevented some way? Nodes should probably not advertise their address at all on outgoing connections, certainly not if they don't want / can't be connected to.",
      "created_at" : "2016-08-26T15:29:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242767752",
      "id" : 242767752,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T15:31:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242767752",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : ">Do we leak internal LAN IPs here.\r\n\r\nWhen sending a version message you include your local IP address (see [net.cpp:503](https://github.com/bitcoin/bitcoin/blob/53f8f226bd1d627c4a6dec5862a1d4ea5a933e45/src/net.cpp#L503)) but the logic which determines this is fairly complicated (see [net.cpp:13](https://github.com/bitcoin/bitcoin/blob/026c6edac947eccb6d6e544468080af9c53593a8/src/net.cpp#L132)). \r\n\r\nI've checked a bunch of older bitcoind logs and it appears that when the host is behind a NAT it sets the IP address in the version message to either 0.0.0.0 or 127.0.0.1. Not sure if that is always true. Can someone who is behind a NAT confirm this behavior in more recent code?\r\n\r\n>Nodes should probably not advertise their address at all on outgoing connections, certainly not if they don't want / can't be connected to.\r\n\r\nIf a node sets its IP address in the version message to 0.0.0.0 or 127.0.0.1 when making an outgoing connection they will not be connected to.",
      "created_at" : "2016-08-26T16:18:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242781076",
      "id" : 242781076,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T16:34:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242781076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "body" : "@EthanHeilman It seems dangerous to me to let an attacker directly enter their IP addresses into our tried table. By murmuring addresses they're certainly able to get into the known table, but the tried table should be reserved for IPs which we selected ourselves. Feel free to contradict my intuition here if you have numbers that show otherwise, though.",
      "created_at" : "2016-08-26T16:47:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242788078",
      "id" : 242788078,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T16:48:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242788078",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa Its an interesting question and I'm not sure what the right answer is.\r\n\r\n>It seems dangerous to me to let an attacker basically enter their IP addresses into our tried table [..] the tried table should be reserved for IPs which we selected ourselves.\r\n\r\nIf tried addresses are only added when we select them I agree it would make it harder for an attacker to control tried but it would also have two downsides:\r\n\r\n1. An attacker who eclipsed a node would not need to worry about incoming connections telling the eclipsed node about non-attacker IP addresses except via address messages. An attacker could flush the new table regularly. I'm not sure how this composes with the new connection exhaustion countermeasures.\r\n\r\n2. The tried table will be smaller. It is hard to judge exactly how small since feeler connections will increase the number of short lived incoming connections boosting the tried table, but feeler connections will also increase the number of selected outgoing connections so adding incoming connections to the tried table might not be as valuable. \r\n\r\nDetermining how the pros balance against the cons would require more research and experiments which I plan on doing but not in the next few months. That said, doing this for security reasons seems more justifiable than doing it to decrease the time it takes to make an outgoing connection.\r\n\r\n@gmaxwell What do you think about putting incoming nodes into the new table?\r\n```c++\r\n            if (((CNetAddr)pfrom->addr) == (CNetAddr)addrFrom)\t\t\r\n             {\t\t\r\n                 addrman.Add(addrFrom, addrFrom);\t\t\r\n             }\r\n```",
      "created_at" : "2016-08-26T17:28:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242798577",
      "id" : 242798577,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T17:28:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242798577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "body" : "I would be fine with adding them to the new table... that is identical to what would happen (and likely happens anyway) when they send us an addr message after connecting.",
      "created_at" : "2016-08-26T17:30:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242798932",
      "id" : 242798932,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T17:30:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242798932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@EthanHeilman  hosts already send an addr message on connect (see the above stanza), which will add it to new.  So I think also doing it there doesn't add anything new except making it more likely that they'll advertise themselves accidentally. \r\n\r\nThe fact that it was ever added to tried at all was a mistake that violated the design of the system, tried table was supposed to be protected against self-selection by actual trying :) --  I think there could be some legitimate concern that actual useful hosts will be promoted to tried somewhat slower, but I believe that is addressed by the feeler connections. \r\n\r\nI would not be surprised if, after this change is widespread, if tried has _more_ reachable hosts in it-- because nodes will pollute their tried table with hosts that aren't reachable less often. \r\n\r\n> I've checked a bunch of older bitcoind logs and it appears that when the host is behind a NAT it sets the IP address in the version message to either 0.0.0.0 or 127.0.0.1. Not sure if that is always true.\r\n\r\nNo, it sets it to its current discovered address.  If you are behind NAT and don't have discovery (e.g. via UPNP or configuration) then you won't have a discovered address, and so you'll get 0.0.0.0.  Because of security concerns with the upnp library we were using we've currently got it off by default, but I hope to have discovery come back in the future.\r\n\r\n> I am operating under the assumption that most nodes that do not accept incoming connections do so because they are behind NATs and therefore would not be added to the tried table\r\n\r\nEliminating inbound connections is a good way to mitigate a number of DOS vulnerabilities. A standard recommended commercial configuration is to have production nodes which you care about connect _only_ to other somewhat trusted nodes.\r\n\r\n > From a security standpoint IP addresses from address messages are more vulnerable to manipulation than IP addresses from incoming connections.\r\n\r\nIf we want to privilege address announcements that also happen to come from the host telling us about them (e.g. using a lower last seen time for them), I think that would be completely reasonable. But there is no need to infer an addr announcement from the version message.\r\n\r\nIn the future we'll likely want to carry additional metadata with announcements, which might not be possible to just infer from version handshakes in any case. (Already we can't get port numbers that way).\r\n",
      "created_at" : "2016-08-26T20:12:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242839289",
      "id" : 242839289,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-26T20:12:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242839289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "> I've checked a bunch of older bitcoind logs and it appears that when the host is behind a NAT it sets the IP address in the version message to either 0.0.0.0 or 127.0.0.1. Not sure if that is always true. Can someone who is behind a NAT confirm this behavior in more recent code?\r\n\r\nWireshark tells me I am sending my *local-scope* IPv6 address, when connecting over IPv4 (behind NAT)... :/",
      "created_at" : "2016-08-27T03:26:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242892770",
      "id" : 242892770,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-27T03:26:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242892770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "@luke-jr Can you open a separate issue for that? We should never send local addresses out.",
      "created_at" : "2016-08-27T17:51:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-242931105",
      "id" : 242931105,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-08-27T17:51:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/242931105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Where are we on this?",
      "created_at" : "2016-09-01T07:28:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-243998285",
      "id" : 243998285,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-09-01T07:28:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/243998285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@EthanHeilman Since we are announcing our own address as soon as we're past IBD anyway, and there is nothing to prevent other nodes from doing the same, what value does this suggested call to `addrMan.Add(addr, addr)` have?",
      "created_at" : "2016-09-01T10:41:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-244042189",
      "id" : 244042189,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-09-01T10:41:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244042189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "> Where are we on this?\r\n\r\nI still think we should continue with this change. I think it would be good eventually to deprecate \"addrFrom\" in `version` messages completely: to just send a dummy value and ignore what is sent there. It's a nest of potential privacy and spoofing issues (akin to the `X-Forwarded-For` header the for HTTP proxies). Also from a protocol point of view advertisement should be separate from `version`.\r\n\r\nThat said, @EthanHeilman does have a point that the ` if (((CNetAddr)pfrom->addr) == (CNetAddr)addrFrom)` check at least makes sure that the advertiser can use the IP address advertised, so is a little bit more trustworthy than just a random `addr`.\r\n\r\nOn the other hand this same heuristic (if desired) could be used for an address advertised in `addr` messages. There's no need to couple this to version messages.\r\n",
      "created_at" : "2016-09-01T13:08:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-244073014",
      "id" : 244073014,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-09-01T13:08:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244073014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj  Yes, I agree, I think we should do something when we receive address advertisements to up-weight self ones-- probably by giving the source a time penalty of zero for it's own address in CAddrMan::Add.  But I think that makes sense as a separate PR. (I'll go do that now).",
      "created_at" : "2016-09-03T09:31:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-244536894",
      "id" : 244536894,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-09-06T00:48:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244536894",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Wrong @wumpus.",
      "created_at" : "2016-09-03T17:00:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-244557674",
      "id" : 244557674,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-09-03T17:00:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244557674",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2142266?v=3",
         "events_url" : "https://api.github.com/users/wumpus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/wumpus/followers",
         "following_url" : "https://api.github.com/users/wumpus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/wumpus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/wumpus",
         "id" : 2142266,
         "login" : "wumpus",
         "organizations_url" : "https://api.github.com/users/wumpus/orgs",
         "received_events_url" : "https://api.github.com/users/wumpus/received_events",
         "repos_url" : "https://api.github.com/users/wumpus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/wumpus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/wumpus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/wumpus"
      }
   },
   {
      "body" : "@laanwj  PR #8661 now applies that heuristic for self announcements in addr messages. ",
      "created_at" : "2016-09-06T00:52:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-244826501",
      "id" : 244826501,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-09-06T00:52:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/244826501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell After thinking about this PR more and performing some back of the envelope calculations I am no longer opposed to this change. To understand the trade-offs I performed a short analysis.\r\n\r\nEclipse attackers have two resources: \r\n1. time the attack requires,\r\n2. and attacker controlled IPs in different IP groups (\\16 prefixes). \r\n\r\nThis PR helps attackers by reducing the number of IP addresses an attacker needs to eclipse a node by shrinking the tried table (by how much I don't know) but, as shown below, increases by months the time an attacker needs to spend murmur the attacker addresses into tried. \r\n\r\n**Disclaimer:** I didn't model a more effective hybrid strategy where an attacker strategically places attacker controlled IP addresses in both new and tried as I don't know what the optimal hybrid new and tried strategy should be. The success probability shown below measures only attacker IPs in tried.\r\n\r\nA Murmur Model:\r\n=============\r\nI built a very simple model of the tried and new table to determine the length of time it would take feelers to move via a feeler connection running at a 2 minute interval the attacker controlled IP addresses from the new table into the tried table. \r\n* The honest IPs are the number of honest IPs in the tried table at the start of an attack.\r\n* The attacker IPs are the attacker control IP addresses in different \"groups\" (\\16 prefixes). Some of these will never make it into the new or tried table due to collisions.\r\n* The success probability is the probability that the node makes all 8 outgoing connections to the attacker IP addresses.\r\n* For simplicity sake we only measure addresses selected from tried. As noted in the disclaimer this is a not a fair assumption in an actual attack but allows us to look at murmured addresses without having to worry about the new table.\r\n\r\n![murmerattack](https://cloud.githubusercontent.com/assets/274814/18290754/bcc13868-7452-11e6-9d55-09aa9f304064.png)",
      "created_at" : "2016-09-06T21:09:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-245092554",
      "id" : 245092554,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-09-06T21:09:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245092554",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "body" : "@EthanHeilman Thanks a lot for the analysis.",
      "created_at" : "2016-09-07T11:15:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8594#issuecomment-245249914",
      "id" : 245249914,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8594",
      "updated_at" : "2016-09-07T11:15:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245249914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
