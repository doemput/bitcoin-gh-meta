[
   {
      "body" : "I have also encountered issues when running on a windows VM and abruptly closing the VM.\r\nIMO we should address these corruption issues with something like https://github.com/bitcoin/bitcoin/issues/8037.",
      "created_at" : "2016-08-17T07:50:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8522#issuecomment-240339046",
      "id" : 240339046,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8522",
      "updated_at" : "2016-08-17T07:50:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/240339046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "@jonasschnelli why is there *any* inconsistency caused by crashes at all? Crash consistency is a 101 feature of most databases. Is it misconfigured? Or should Bitcoin Core use transactions to make related actions atomic? Crashes normally are totally harmless (and that's true in the real world, not just on paper).",
      "created_at" : "2016-08-17T11:24:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8522#issuecomment-240384245",
      "id" : 240384245,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8522",
      "updated_at" : "2016-08-17T11:24:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/240384245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/12032350?v=3",
         "events_url" : "https://api.github.com/users/GSPP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/GSPP/followers",
         "following_url" : "https://api.github.com/users/GSPP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/GSPP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/GSPP",
         "id" : 12032350,
         "login" : "GSPP",
         "organizations_url" : "https://api.github.com/users/GSPP/orgs",
         "received_events_url" : "https://api.github.com/users/GSPP/received_events",
         "repos_url" : "https://api.github.com/users/GSPP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/GSPP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/GSPP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/GSPP"
      }
   },
   {
      "body" : "@GSPP I can't tell for sure, as I have never seen a database inconsistency on my own hardware at all, but you are not taking into account that Bitcoin Core does not use a single database.\r\n\r\nStoring all block, transaction and UTXO data in a single database has abysmal performance, so instead data with different access patterns are stored separately. The block data (~80 GB) goes into blk* files (append-only raw disk files), the block index (63 MB) goes into a write-only leveldb database (which is loaded into memory entirely at startup), and the UTXO set (1.6 GB) goes into a leveldb database with an application caching layer on top. LevelDB internally is designed to be crash-consistent, and we enable the features that are needed for this (batch writes, which are atomic, and rollback of incomplete transactions on crash recovery).\r\n\r\nThe problem occurs across the three datasets and caches. Bitcoin Core is designed to keep them perfectly consistent with eachother: we never write to the block index without flushing writes to the blk* files, and we never write UTXO entries to the chainstate database before the block index entries are flushed to their database.\r\n\r\nPresumably, there is a bug in the handling of fatal errors (low disk is one of those), which causes an inconsistency to occur. That's bad, and should be fixed, but it's not nearly as easy as enabling a feature on a database.\r\n\r\nAs @jonasschnelli mentions, some of the code dealing with this was changed significantly in the 0.13 codebase (which is likely to be released within a few days). It would be helpful if you can see if the problem persists.",
      "created_at" : "2016-08-17T11:46:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8522#issuecomment-240388282",
      "id" : 240388282,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8522",
      "updated_at" : "2016-08-17T11:50:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/240388282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@GSPP I just realized you are experiencing an OOM, not a low disk, which aborts the application immediately. In that case, I have no answer, as that's purely an issue within LevelDB. Perhaps the Windows backend for LevelDB we're using has bugs, or there is a bug in how the VM deals with ordering of disk writes and flushing them.",
      "created_at" : "2016-08-17T11:52:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8522#issuecomment-240389382",
      "id" : 240389382,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8522",
      "updated_at" : "2016-08-17T11:52:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/240389382",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "OK. It sounds like each database itself should be crash consistent and by always writing in the correct order there never should be any inconsistency even in the face of power loss. Is that understanding correct (modulo bugs)?\r\n\r\nDid you have a chance to try to reproduce https://github.com/bitcoin/bitcoin/issues/7233? For me the repro is really easy and it might surface the same underlying bug.",
      "created_at" : "2016-08-17T12:36:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8522#issuecomment-240397893",
      "id" : 240397893,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8522",
      "updated_at" : "2016-08-17T12:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/240397893",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/12032350?v=3",
         "events_url" : "https://api.github.com/users/GSPP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/GSPP/followers",
         "following_url" : "https://api.github.com/users/GSPP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/GSPP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/GSPP",
         "id" : 12032350,
         "login" : "GSPP",
         "organizations_url" : "https://api.github.com/users/GSPP/orgs",
         "received_events_url" : "https://api.github.com/users/GSPP/received_events",
         "repos_url" : "https://api.github.com/users/GSPP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/GSPP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/GSPP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/GSPP"
      }
   }
]
