{
   "assignee" : null,
   "body" : "Bitcoin amounts are stored as uint64 in the protobuf messages. Amounts over 0x7FFFFFFFFFFFFFFF will be considered negative when this line is\r\nexecuted:\r\n    QList<std::pair<CScript, CAmount> > sendingTos =\r\nrequest.getPayTo();   (in  PaymentServer::processPaymentRequest() in\r\nqt\\paymentserver.cpp)\r\n\r\nNegative values should be discarded by the dust check : if (txOut.IsDust(::minRelayTxFee))\r\nNevertheless recipient.amount will still accumulate all positive values and may overflow, since the payment protocol allows the merchant to specify many output addresses and each one has a separate amount. So it is still possible to create a small positive total amount by overflowing the\r\nint64 range with several large positive amounts. For example:\r\nmax_uint64 /3 + max_uint64 /3 + max_uint64 /3 +2 == 1\r\nThe user will be presented with a dialog asking to pay a total of 1 BTC, but internally the operation will fail, because the independent constituent payment amounts will not be able to be fulfilled.\r\n\r\nThis has the nasty effect that the user may think he may have been robbed, because even if the user has 100 BTC, the software will tell the user \"The amount exceeds your balance.\" when paying to an overflowed 1 BTC.\r\n\r\nThere may be other possibilities, since there are several places where conversions between uint64 and int64 take place. \r\n\r\nSuggested correction:\r\n\r\nbool PaymentServer::processPaymentRequest(PaymentRequestPlus& request,\r\nSendCoinsRecipient& recipient) {\r\n    ....\r\n   CTxOut txOut(sendingTo.second, sendingTo.first);\r\n    // BEGIN ADD\r\n     if (!MoneyRange(sendingTo.second)) {\r\n        emit message(tr(\"Payment request rejected\"),\r\n                tr(\"Invalid money range.\"),\r\n                CClientUIInterface::MSG_ERROR);\r\n            return false;\r\n    }\r\n   // END ADD\r\n  ....\r\n    recipient.amount += sendingTo.second;\r\n  ...\r\n    // BEGIN ADD\r\n     if (!MoneyRange(recipient.amount)) {\r\n        emit message(tr(\"Payment request rejected\"),\r\n                tr(\"Invalid  accumulated money range.\"),\r\n                CClientUIInterface::MSG_ERROR);\r\n            return false;\r\n    }\r\n   // END ADD",
   "closed_at" : "2015-10-27T11:33:58Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 2,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5622/comments",
   "created_at" : "2015-01-08T17:12:28Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5622/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/5622",
   "id" : 53775215,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5622/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 5622,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Unchecked bounds on btc amounts in BIP70 implementation",
   "updated_at" : "2015-10-27T11:33:58Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5622",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
      "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
      "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
      "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
      "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/SergioDemianLerner",
      "id" : 1752347,
      "login" : "SergioDemianLerner",
      "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
      "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
      "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/SergioDemianLerner"
   }
}
