{
   "assignee" : null,
   "body" : "**(as reported by Sergio Damien Lerner)**\r\n\r\nBitcoin amounts are stored as uint64 in the protobuf messages. Amounts over 0x7FFFFFFFFFFFFFFF will be considered negative when this line is executed:\r\n\r\n    QList<std::pair<CScript, CAmount> > sendingTos = request.getPayTo();   \r\n\r\n(in  PaymentServer::processPaymentRequest() in qt\\paymentserver.cpp)\r\n\r\nThis does not pose a problem, since negative values should be discardedby the dust check : if (txOut.IsDust(::minRelayTxFee))\r\n\r\nNevertheless recipient.amount will still accumulate all positive values and may overflow, since the payment protocol allows the merchant to specify many output addresses and each one has a separate amount. So it is still possible to create a negative total amount by overflowing the\r\nint64 range with several positive amounts. For example, (uint64) -1 + (uint64) -1 + 3 == 1. The user will be presented with a dialog asking to pay a total of 1 BTC, but internally the operation will fail, because the independent constituent payment amounts will not be able to be fulfilled.\r\n\r\nThis has the nasty effect that the user may think he may have been robbed, because even if the user has 100 BTC, the software will tell the user \"The amount exceeds your balance.\".\r\n\r\nCorrection:\r\n```\r\nbool PaymentServer::processPaymentRequest(PaymentRequestPlus& request,\r\nSendCoinsRecipient& recipient) {\r\n    ....\r\n   CTxOut txOut(sendingTo.second, sendingTo.first);\r\n    // BEGIN ADD\r\n     if (!MoneyRange(sendingTo.second)) {\r\n        emit message(tr(\"Payment request rejected\"),\r\n                tr(\"Invalid money range.\"),\r\n                CClientUIInterface::MSG_ERROR);\r\n            return false;\r\n    }\r\n   // END ADD\r\n  ....\r\n    recipient.amount += sendingTo.second;\r\n  ...\r\n    // BEGIN ADD\r\n     if (!MoneyRange(recipient.amount)) {\r\n        emit message(tr(\"Payment request rejected\"),\r\n                tr(\"Invalid  accumulated money range.\"),\r\n                CClientUIInterface::MSG_ERROR);\r\n            return false;\r\n    }\r\n   // END ADD\r\n```\r\n\r\nThe payment request unit test should be extended to test negative and very large amounts in requests....\r\n",
   "closed_at" : "2015-02-09T12:51:08Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 2,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5624/comments",
   "created_at" : "2015-01-09T09:25:21Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5624/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/5624",
   "id" : 53848337,
   "labels" : [
      {
         "color" : "02d7e1",
         "name" : "GUI",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/GUI"
      },
      {
         "color" : "E5993F",
         "name" : "Priority Medium",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Priority%20Medium"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5624/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 5624,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Possible MINOR vulnerability in BIP70 implementation",
   "updated_at" : "2015-02-09T12:51:08Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5624",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   }
}
