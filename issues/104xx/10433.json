{
   "assignee" : null,
   "assignees" : [],
   "body" : "tl;dr:\r\n\r\n- temp directories now include the name of the test when run through the test_runner\r\n- passing a `--tmpdirprefix` to the test_runner allows test_runner to be called by cron/build jobs without risk of directory name collision\r\n\r\n==================\r\n\r\nBy default, the functional tests create their temp directories in the $TMPDIR as follows:\r\n\r\n```\r\n$TMPDIR\r\n   |\r\n   -- test<rand_chars>\r\n        |\r\n        -- <port seed>\r\n            |\r\n            -- temp files\r\n            -- ...\r\n```\r\n\r\na `--tmpdir` argument can be passed into the individual test case, which causes the temp directory to be written to:\r\n\r\n```\r\n<specified --tmpdir>\r\n   |\r\n   -- <port seed>\r\n        |\r\n        -- temp files\r\n        -- ...\r\n```\r\n\r\nIf `--tmpdir` is passed to the test_runner, then it gets passed down to the indivdual tests and the directory structure is:\r\n\r\n```\r\n<specified --tmpdir>\r\n   |\r\n   -- <port seed 1>\r\n        |\r\n        -- temp files\r\n        -- ...\r\n   -- <port seed 2>\r\n        |\r\n        -- temp files\r\n        -- ...\r\n   -- ...\r\n\r\n```\r\n\r\nThere are a few problems:\r\n\r\n- the directory names give no indication of which test was being run, so it's difficult to quickly find the temp directory for an indvidual test if using the test_runner\r\n- if a `--tmpdir` directory is passed to the test_runner and there are already directories in that tmpdir with names that clash with the port seed, then tests will fail when they try to use that subdirectory. This can be a problem when running test_runner as a cron job or build job with a specified tmpdir. Test failures in one build will cause subsequent runs to fail because the subdirectories are not cleaned up\r\n- even if a tmpdir is specified, test_framework will still create an empty temp directory `$TMPDIR/test<rand_chars>` (this is because `tempfile.mkdtemp(prefix=\"test\")` is called even when `--tmpdir`  is used).\r\n\r\nThis PR changes the temp dir structure so that:\r\n\r\n- if running the test directly:\r\n    - if no `--tmpdir` is specified\r\n        - temp directory is `$TMPDIR/test<rand_chars>` (as now, except without the `<port seed>` subdirectory)\r\n    - if a `--tmpdir` is specified\r\n        - temp directory is the specified tmpdir (as now, except without the `<port seed>` subdirectory)\r\n- if running through the test_runner\r\n    - if no `--tmpdirprefix` is specified\r\n        - temp directory is `$TMPDIR/bitcoin_test_runner_<date>_<time>/<test_name>_portseed`.\r\n    - if a `--tmpdirprefix` is specified\r\n        - temp directory is `<tmpdirprefix>/bitcoin_test_runner_<date>_<time>/<test_name>_portseed`.\r\n\r\n`<tmpdirprefix>` will be cleaned up by the test_runner if it is empty at the end of all tests (ie if all tests have cleaned up their own temp directories).",
   "closed_at" : "2017-05-22T07:02:45Z",
   "closed_by" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/6399679?v=3",
      "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
      "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/MarcoFalke",
      "id" : 6399679,
      "login" : "MarcoFalke",
      "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
      "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
      "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/MarcoFalke"
   },
   "comments" : 4,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10433/comments",
   "created_at" : "2017-05-19T15:22:30Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10433/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/10433",
   "id" : 230008063,
   "labels" : [
      {
         "color" : "d4c5f9",
         "default" : false,
         "id" : 62963516,
         "name" : "Tests",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10433/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 10433,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/10433.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10433",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/10433.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10433"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "[tests] improve tmpdir structure",
   "updated_at" : "2017-05-22T07:02:45Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10433",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
      "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jnewbery/followers",
      "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jnewbery",
      "id" : 1063656,
      "login" : "jnewbery",
      "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
      "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
      "repos_url" : "https://api.github.com/users/jnewbery/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jnewbery"
   }
}
