{
   "assignee" : null,
   "body" : "I could really use some more eyes on this. I discussed it briefly with @sipa on IRC a few days ago.\r\n\r\nI noticed this while looking into https://github.com/bitcoin/bitcoin/issues/5668 . This is one possible explanation I can come up with for overlapping block data. Whether it has anything to do with that issue or not, I think this still needs to be addressed.\r\n\r\nWhen re-indexing, there are a few cases where garbage data may be skipped in the block files. In these cases, the indices are correctly written to the index db, however the pointer to the next position for writing in the current block file is calculated by adding the sizes of the valid blocks found.\r\n\r\nAs a result, when the re-index is finished, the index db is correct for all existing blocks, but the next block will be written to an incorrect offset, likely overwriting existing blocks.\r\n\r\nRather than using the sum of all valid blocks to determine the next write position, use the end of the last block written to the file. Don't assume that the current block is the last one in the file, since they may be read out-of-order.\r\n\r\nI was able to trigger this problem by inserting some garbage data between two valid blocks on disk in the last .dat file, then reindexing. After that, run normally for a few min in order to write a few new blocks to disk, then run with -checkblocks=0.\r\n\r\nBefore this change, I would get different errors (de-serialization, eof, etc) depending on what garbage i add and where. After the change, it appears to survive the re-index without issue regardless of the garbage.",
   "closed_at" : "2015-03-11T07:34:05Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 5,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5864/comments",
   "created_at" : "2015-03-07T01:48:08Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5864/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/5864",
   "id" : 60184046,
   "labels" : [
      {
         "color" : "fbca04",
         "name" : "UTXO Db and Indexes",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5864/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : "2015-12-03T11:08:31Z",
      "closed_issues" : 134,
      "created_at" : "2013-12-05T10:34:42Z",
      "creator" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      },
      "description" : "",
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestones/0.10.0",
      "id" : 505738,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/14/labels",
      "number" : 14,
      "open_issues" : 0,
      "state" : "closed",
      "title" : "0.10.0",
      "updated_at" : "2015-12-03T11:08:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/14"
   },
   "number" : 5864,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/5864.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5864",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/5864.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5864"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "fix possible block db breakage during re-index",
   "updated_at" : "2015-03-11T07:48:09Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5864",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
      "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
      "followers_url" : "https://api.github.com/users/theuni/followers",
      "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/theuni",
      "id" : 417043,
      "login" : "theuni",
      "organizations_url" : "https://api.github.com/users/theuni/orgs",
      "received_events_url" : "https://api.github.com/users/theuni/received_events",
      "repos_url" : "https://api.github.com/users/theuni/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/theuni"
   }
}
