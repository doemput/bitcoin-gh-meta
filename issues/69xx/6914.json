{
   "assignee" : null,
   "body" : "This is likely a controversial change, and will need very careful review and testing.\r\n\r\nIt adds a new basic data type (`prevector<N, T>`) which is a fully API compatible drop-in replacement for `std::vector<T>` (except it does not support custom allocators, does not have `at()`, and misses a few comparison operators). It will allocate up to N elements inside the parent container directly, only switching over to heap-allocated storage if more is needed. The data structures for the N elements and the pointer/size metadata for the heap-allocated storage are shared, making it very efficient for small N.\r\n\r\nCScript is switched to use this new type, reducing the memory consumption of mempool and chainstate.\r\n\r\nA benchmark (reindex with script validation disabled):\r\n```\r\n2015-10-30 01:10:49   - Load block from disk: 0.00ms [0.07s]\r\n2015-10-30 01:10:49       - Connect 595 transactions: 2.76ms (0.005ms/tx, 0.003ms/txin) [82.40s]\r\n2015-10-30 01:10:49     - Verify 1096 txins: 2.80ms (0.003ms/txin) [88.73s]\r\n2015-10-30 01:10:49     - Index writing: 1.29ms [61.31s]\r\n2015-10-30 01:10:49     - Callbacks: 0.04ms [6.78s]\r\n2015-10-30 01:10:49   - Connect total: 4.78ms [182.16s]\r\n2015-10-30 01:10:49   - Flush: 0.77ms [38.90s]\r\n2015-10-30 01:10:49   - Writing chainstate: 0.03ms [5.57s]\r\n2015-10-30 01:10:49 UpdateTip: new best=000000000000046b1fdf00440a86e34886b2b0bd56472b22edb2805c92bbe4ca  height=223133  log2_work=69.460921  tx=13407260  date=2013-02-25 23:16:10 progress=0\r\n.064773  cache=666.5MiB(1658277tx)\r\n2015-10-30 01:10:49   - Connect postprocess: 1.46ms [46.22s]\r\n2015-10-30 01:10:49 - Connect block: 7.03ms [272.92s]\r\n\r\n2015-10-30 01:22:03       - Connect 595 transactions: 2.86ms (0.005ms/tx, 0.003ms/txin) [69.53s]\r\n2015-10-30 01:22:03     - Verify 1096 txins: 2.90ms (0.003ms/txin) [75.80s]\r\n2015-10-30 01:22:03     - Index writing: 1.26ms [56.37s]\r\n2015-10-30 01:22:03     - Callbacks: 0.04ms [6.77s]\r\n2015-10-30 01:22:03   - Connect total: 4.87ms [164.33s]\r\n2015-10-30 01:22:03   - Flush: 1.14ms [24.95s]\r\n2015-10-30 01:22:03   - Writing chainstate: 0.03ms [5.12s]\r\n2015-10-30 01:22:03 UpdateTip: new best=000000000000046b1fdf00440a86e34886b2b0bd56472b22edb2805c92bbe4ca  height=223133  log2_work=69.460921  tx=13407260  date=2013-02-25 23:16:10 progress=0\r\n.064773  cache=508.6MiB(1658277tx)\r\n2015-10-30 01:22:03   - Connect postprocess: 1.36ms [43.18s]\r\n2015-10-30 01:22:03 - Connect block: 7.41ms [237.66s]\r\n```\r\n\r\nSo for this reindex up to 223133, the chainstate needs 23% less memory, and is 13% faster.\r\n\r\nThere are likely several other places where this datatype can be used.",
   "closed_at" : "2015-12-01T09:22:29Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 26,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6914/comments",
   "created_at" : "2015-10-30T01:29:08Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6914/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/6914",
   "id" : 114179871,
   "labels" : [
      {
         "color" : "6060aa",
         "name" : "Validation",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6914/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : null,
      "closed_issues" : 74,
      "created_at" : "2015-05-01T12:31:35Z",
      "creator" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      },
      "description" : "",
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestones/0.12.0",
      "id" : 1092458,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/19/labels",
      "number" : 19,
      "open_issues" : 0,
      "state" : "open",
      "title" : "0.12.0",
      "updated_at" : "2016-06-09T08:23:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/19"
   },
   "number" : 6914,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/6914.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6914",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/6914.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6914"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Add pre-allocated vector type and use it for CScript",
   "updated_at" : "2015-12-01T09:22:29Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6914",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
      "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sipa/followers",
      "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sipa",
      "id" : 548488,
      "login" : "sipa",
      "organizations_url" : "https://api.github.com/users/sipa/orgs",
      "received_events_url" : "https://api.github.com/users/sipa/received_events",
      "repos_url" : "https://api.github.com/users/sipa/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sipa"
   }
}
