[
   {
      "body" : "According to @gmaxwell in #6917:\r\n```\r\nDifference in VM flushing behavior, I guess. We appear to be missing a FileCommit in UndoWriteToDisk-- I think we need to have synced the blocks and undo before calling the insert.\r\n\r\nIt would probably be better for performance if it wrote the block then undo, then did the syncs on both however.\r\n```",
      "created_at" : "2015-11-04T16:50:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6923#issuecomment-153789537",
      "id" : 153789537,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6923",
      "updated_at" : "2015-11-04T16:50:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/153789537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Will have a look.\n",
      "created_at" : "2015-11-04T17:00:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6923#issuecomment-153792028",
      "id" : 153792028,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6923",
      "updated_at" : "2015-11-04T17:00:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/153792028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "We don't need a FileCommit in UndoWriteToDisk, because we always call it via FlushBlockFile 1) before writing the block index data that refers to it (in FlushStateToDisk) and 2) when transitioning to a new disk block file (in FindBlockPos).\r\n\r\nHowever, when reindexing, fKnown is set to true in FindBlockPos, so this flush is not called. That is the correct behaviour for the block files (which aren't being changed in a reindex), but incorrect for undo files (which are being rewritten).\r\n\r\nI'm writing a fix.",
      "created_at" : "2015-11-04T23:17:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6923#issuecomment-153901094",
      "id" : 153901094,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6923",
      "updated_at" : "2015-11-04T23:17:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/153901094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Looking at the debug.log I saved here I noticed something peculiar:\r\n```\r\n0001b070  65 3d 33 2e 39 4d 69 42  28 39 37 37 74 78 29 0d  |e=3.9MiB(977tx).|\r\n0001b080  0a 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\r\n0001b090  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|\r\n*\r\n00030d40  32 30 31 35 2d 31 30 2d  33 31 20 31 33 3a 35 31  |2015-10-31 13:51|\r\n```\r\nThe crash also left a whole block of \\x00 bytes at the end of the log. I suppose the space was allocated but the data wasn't actually written yet. It is to be expected as we don't ever sync the debug log to disk (just flush it, which flushes only application-side buffers), but this may give further insight into the kind of corruption.\r\n",
      "created_at" : "2015-11-05T10:04:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6923#issuecomment-154014030",
      "id" : 154014030,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6923",
      "updated_at" : "2015-11-05T10:04:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/154014030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
