[
   {
      "body" : "Oh, I've just realised that SendMessages() does a TRY_LOCK() on cs_main first, and if it can't get the lock it returns early before calling IsInitialBlockDownload().  So does that mean its not a deadlock risk in actuality?  Although the LOCK() calls are in the opposite order, there may be no chance of deadlock?",
      "created_at" : "2014-07-09T11:18:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4493#issuecomment-48457526",
      "id" : 48457526,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4493",
      "updated_at" : "2014-07-09T11:18:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48457526",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/549484?v=3",
         "events_url" : "https://api.github.com/users/ashleyholman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ashleyholman/followers",
         "following_url" : "https://api.github.com/users/ashleyholman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ashleyholman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ashleyholman",
         "id" : 549484,
         "login" : "ashleyholman",
         "organizations_url" : "https://api.github.com/users/ashleyholman/orgs",
         "received_events_url" : "https://api.github.com/users/ashleyholman/received_events",
         "repos_url" : "https://api.github.com/users/ashleyholman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ashleyholman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ashleyholman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ashleyholman"
      }
   },
   {
      "body" : "Well as long as there is one place where both locks are acquired (in any order) that's not a TRY_LOCK, there could be a deadlock there. If they are all TRY_LOCKS then indeed a deadlock cannot happen, but maybe livelock or thread starvation could (if both threads refuse to give up the other lock after getting the other one fails).\r\n\r\nAs for IsInitialBlockDownload: one idea would be to change it to return a global flag that is cleared only after the initial block download (+ check at initialization time). This would be more efficient than executing the checks every time as well.\r\n\r\n",
      "created_at" : "2014-07-09T13:12:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4493#issuecomment-48467411",
      "id" : 48467411,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4493",
      "updated_at" : "2014-07-09T13:13:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/48467411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I'm going to close this, assuming that it was fixed by #7846 or other locking changes in recent time. Feel free to reopen if other problems are found.",
      "created_at" : "2017-01-23T17:56:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4493#issuecomment-274565444",
      "id" : 274565444,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4493",
      "updated_at" : "2017-01-23T17:56:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/274565444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Seen today on 0.13.2:\r\n```\r\n2017-01-30 18:03:10 receive version message: /Satoshi:0.13.1/: version 70014, blocks=1087141, us=38.121.165.30:32483, peer=8\r\n2017-01-30 18:03:10 AdvertiseLocal: advertising address 38.121.165.30:18333\r\n2017-01-30 18:03:10 connect() to [2001:0:9d38:90d7:2cfe:1245:ac28:731a]:18333 failed: Network is unreachable (101)\r\n2017-01-30 18:03:37 POTENTIAL DEADLOCK DETECTED\r\n2017-01-30 18:03:37 Previous lock order was:\r\n2017-01-30 18:03:37  pnode->cs_vRecvMsg  net.cpp:1877 (TRY)\r\n2017-01-30 18:03:37  (1) cs_main  main.cpp:5911\r\n2017-01-30 18:03:37  (2) cs_vSend  net.cpp:2585\r\n2017-01-30 18:03:37 Current lock order is:\r\n2017-01-30 18:03:37  (2) pnode->cs_vSend  net.cpp:1896 (TRY)\r\n2017-01-30 18:03:37  (1) cs_main  main.cpp:6483 (TRY)\r\n2017-01-30 18:03:37  (1) cs_main  main.cpp:1745\r\n2017-01-30 18:03:37 UpdateTip: new best=000000000000093a78ec61c44009ff74a44de94fd6e6b0fff2422804d180c082 height=1087142 version=0x20000000 log2_work=68.931904 tx=13040484 date='2017-01-30 18:03:19' progress=1.000000 cache=2.1MiB(9691tx) warning='1 of last 100 blocks have unexpected version'\r\n2017-01-30 18:03:51 UpdateTip: new best=00000000000005f96e01b15ac4cfb95859e3eecf7f4885274e1f24b3d7e3fde9 height=1087143 version=0x20000000 log2_work=68.931923 tx=13040485 date='2017-01-30 18:03:37' progress=1.000000 cache=2.1MiB(9692tx) warning='1 of last 100 blocks have unexpected version'\r\n2017-01-30 18:04:11 UpdateTip: new best=00000000000008bf5f8409d19de20f248f5b61e391071afd69bc9119efa3c0a4 height=1087144 version=0x20000000 log2_work=68.931941 tx=13040487 date='2017-01-30 18:03:51' progress=1.000000 cache=2.1MiB(9694tx) warning='1 of last 100 blocks have unexpected version'\r\n2017-01-30 18:04:35 connect() to [2001:0:9d38:6ab8:248d:2e3a:983b:b04a]:18333 failed: Network is unreachable (101)\r\n2017-01-30 18:05:58 POTENTIAL DEADLOCK DETECTED\r\n2017-01-30 18:06:00 Previous lock order was:\r\n2017-01-30 18:06:05  pnode->cs_vRecvMsg  net.cpp:1877 (TRY)\r\n2017-01-30 18:06:07  (1) cs_main  main.cpp:5911\r\n2017-01-30 18:06:13  (2) cs_vSend  net.cpp:2585\r\n2017-01-30 18:06:16 Current lock order is:\r\n2017-01-30 18:06:28  (2) pnode->cs_vSend  net.cpp:1896 (TRY)\r\n2017-01-30 18:06:31  (1) cs_main  main.cpp:6483 (TRY)\r\n2017-01-30 18:06:32  (1) cs_main  main.cpp:1745\r\n2017-01-30 18:08:58 UpdateTip: new best=000000000000095216f28d2cd715abee070cd83079411a93463ec61fa2a782eb height=1087145 version=0x20000000 log2_work=68.931959 tx=13040491 date='2017-01-30 18:05:29' progress=1.000000 cache=2.1MiB(9701tx) warning='1 of last 100 blocks have unexpected version'\r\n2017-01-30 18:08:58 POTENTIAL DEADLOCK DETECTED\r\n2017-01-30 18:08:58 Previous lock order was:\r\n2017-01-30 18:08:58  pnode->cs_vRecvMsg  net.cpp:1877 (TRY)\r\n2017-01-30 18:08:58  (1) cs_main  main.cpp:5911\r\n2017-01-30 18:08:58  (2) cs_vSend  net.cpp:2585\r\n2017-01-30 18:08:58 Current lock order is:\r\n2017-01-30 18:08:58  (2) pnode->cs_vSend  net.cpp:1896 (TRY)\r\n2017-01-30 18:08:58  (1) cs_main  main.cpp:6483 (TRY)\r\n2017-01-30 18:08:58  (1) cs_main  main.cpp:1745\r\n2017-01-30 18:08:58 UpdateTip: new best=000000000000024c5841a34b630828a27114c895ac7de8f1cb3376ec7d7a35a1 height=1087146 version=0x20000000 log2_work=68.931977 tx=13040493 date='2017-01-30 18:08:04' progress=1.000000 cache=2.1MiB(9703tx) warning='1 of last 100 blocks have unexpected version'\r\n```\r\n\r\nBitcoin did seem to sync successfully on testnet, and I'm not entirely sure if these message indicated a real problem?",
      "created_at" : "2017-01-30T18:17:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4493#issuecomment-276144478",
      "id" : 276144478,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4493",
      "updated_at" : "2017-01-30T18:18:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/276144478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1746780?v=3",
         "events_url" : "https://api.github.com/users/mcelrath/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mcelrath/followers",
         "following_url" : "https://api.github.com/users/mcelrath/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mcelrath/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mcelrath",
         "id" : 1746780,
         "login" : "mcelrath",
         "organizations_url" : "https://api.github.com/users/mcelrath/orgs",
         "received_events_url" : "https://api.github.com/users/mcelrath/received_events",
         "repos_url" : "https://api.github.com/users/mcelrath/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mcelrath/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mcelrath/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mcelrath"
      }
   },
   {
      "body" : "Yes, this is a spurious warning on many recent versions of Bitcoin Core, however, it is believed to have been \"fixed\" in master/will be fixed in 0.14.",
      "created_at" : "2017-01-30T18:43:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4493#issuecomment-276151595",
      "id" : 276151595,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4493",
      "updated_at" : "2017-01-30T18:43:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/276151595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
