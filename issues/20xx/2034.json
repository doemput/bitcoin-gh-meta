{
   "assignee" : null,
   "body" : "After reading #1271 and #1382, which don't fix the core problem in my opinion, here is an own proposal.\n\nThe problem is that the block download mechanism may be active multiple times, in particular when during a normal initial block download a new block is announced by a different peer. We don't keep track of which block has already been downloaded from which peer, so a new (dulicate) getblocks/inv/getdata/block/getblocks cycle may be started for the newly announced block.\n\nThis is what I would do:\n * There is one designated \"sync node\", from which the synchronization is supposed to happen.\n * getblocks messages are never sent to any but the sync node\n * A map is kept that remembers which getdata is sent to which node\n * block invs (for unknown blocks) coming from any node cause a getdata to that node, unless a getdata was already sent for that block.\n * When a node is disconnected, its outstanding entries are removed from the getdata map, and if it was the sync node, a new sync node is chosen.\n * When a (potentially valid) block arrives that has the highest timestamp ever seen, its sender becomes the sync node.\n\nThis can later be extended to include a property that measures performance when sending blocks, and chooses a new sync node if deemed to low.\n\nI think this is about the best we can do without heavily reorganising the code, and if we do that, headers-first should get priority, as it allows for much better block download management (it means the best chain is known in advance, blocks can be requested from multiple peers, ...)\n\nAny comments/suggestions?",
   "closed_at" : "2014-12-05T17:43:15Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
      "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sipa/followers",
      "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sipa",
      "id" : 548488,
      "login" : "sipa",
      "organizations_url" : "https://api.github.com/users/sipa/orgs",
      "received_events_url" : "https://api.github.com/users/sipa/received_events",
      "repos_url" : "https://api.github.com/users/sipa/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sipa"
   },
   "comments" : 10,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2034/comments",
   "created_at" : "2012-11-25T14:08:00Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2034/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/2034",
   "id" : 8650083,
   "labels" : [
      {
         "color" : "ebd775",
         "name" : "Brainstorming",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming"
      },
      {
         "color" : "006b75",
         "name" : "P2P",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2034/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 2034,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Block download management",
   "updated_at" : "2014-12-05T17:43:15Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2034",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
      "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sipa/followers",
      "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sipa",
      "id" : 548488,
      "login" : "sipa",
      "organizations_url" : "https://api.github.com/users/sipa/orgs",
      "received_events_url" : "https://api.github.com/users/sipa/received_events",
      "repos_url" : "https://api.github.com/users/sipa/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sipa"
   }
}
