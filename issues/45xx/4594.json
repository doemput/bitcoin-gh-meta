{
   "assignee" : null,
   "body" : "# Block and Transaction Broadcasting With ZeroMQ\r\n\r\n[ZeroMQ](http://zeromq.org/) is a lightweight wrapper around TCP\r\nconnections, inter-process communications, and shared-memory,\r\nproviding various message-oriented semantics such as publish/subcribe,\r\nrequest/reply, and push/pull.\r\n\r\nThe Bitcoin Core daemon can be configured to act as a trusted \"border\r\nrouter\", implementing the bitcoin wire protocol and relay, making\r\nconsensus decisions, maintaining the local blockchain database,\r\nbroadcasting locally generated transactions into the network, and\r\nproviding a queryable RPC interface to interact on a polled basis for\r\nrequesting blockchain related data.  However, there exists only a\r\nlimited service to notify external software of events like the arrival\r\nof new blocks or transactions.\r\n\r\nThe ZeroMQ facility binds a \"publish\" port that broadcasts all newly\r\narrived *and validated* blocks and transactions to one or more\r\nconnected subscribers.  This read-only facility requires only the\r\nconnection of a corresponding ZeroMQ subscriber port in receiving\r\nsoftware; it is not authenticated nor is there any two-way protocol\r\ninvolvement.\r\n\r\nIn this fashion, external software can use a trusted Bitcoin Core\r\ndaemon to do the heavy lifting of communicating with the P2P network,\r\nwhile still receiving network information asynchronously in real\r\ntime. As transactions and blocks arrive via the P2P network, Bitcoin\r\nCore will apply all the validation and standardization rules to this\r\ndata, only passing along through ZeroMQ those items that pass.\r\n\r\nZeroMQ sockets are self-connecting and self-healing; that is, connects\r\nmade between two endpoints will be automatically restored after an\r\noutage, and either end may be freely started or stopped in any order.\r\n\r\nBecause ZeroMQ is message oriented, subscribers receive transactions\r\nand blocks all-at-once and do not need to implement any sort of\r\nbuffering or reassembly.\r\n\r\n## Prerequisites\r\n\r\nThe ZeroMQ feature in Bitcoin Core uses only a very small part of the\r\nZeroMQ C API, and is thus compatible with any version of ZeroMQ\r\nfrom 2.1 onward, including all versions in the 3.x and 4.x release\r\nseries.  Typically, it is packaged by distributions as something like\r\n*libzmq-dev*.\r\n\r\nThe C++ wrapper for ZeroMQ is *not* needed.\r\n\r\n## Enabling\r\n\r\nBy default, the ZeroMQ port functionality is disabled.  Two steps are\r\nrequired to enable--compiling in the ZeroMQ code, and configuring\r\nruntime operation on the command-line or configuration file.\r\n\r\n    $ ./configure --enable-zmq (other options)\r\n\r\nThis will produce a binary that is capable of providing the ZeroMQ\r\nfacility, but will not do so until also configured properly.\r\n\r\n## Configuration\r\n\r\nCurrently, the ZeroMQ facility only needs to have the ZeroMQ endpoint\r\nspecified:\r\n\r\n    $ bitcoind -zmqpub=tcp://127.0.0.1/28332\r\n\r\nThis will cause bitcoind to establish a PUB listening socket at the\r\nspecified host address and port number.  The endpoint specifier may\r\nalso be provided as the equivalent line item in bitcoin.conf.\r\n\r\nZeroMQ endpoint specifiers for TCP (and others) are documented in the\r\n[ZeroMQ API](http://api.zeromq.org).\r\n\r\n## Operation\r\n\r\nZeroMQ publish sockets prepend each data item with an arbitrary topic\r\nprefix that allows subscriber clients to request only those items with\r\na matching prefix.  When publishing, bitcoind will prepend the topic\r\n\"TXN\" (no quotes, no null terminator) to the binary, serialized form\r\nof a published transaction, and \"BLK\" to the binary, serialized form\r\nof a published block.\r\n\r\nClient side, then, the ZeroMQ subscriber socket must have the ZMQ_SUBSCRIBE option set to one or either of these prefixes; without doing so will result in no messages arriving.\r\n\r\nHere is a small example, in the Python language, using the *python-zmq* wrapper:\r\n\r\n    import zmq\r\n    import binascii\r\n   \r\n    port = 28332\r\n    topic1 = \"BLK\"\r\n    topic2 = \"TXN\"\r\n    topic_len = len(topic1)\r\n\r\n    zmqContext = zmq.Context()\r\n    zmqSubSocket = zmqContext.socket(zmq.SUB)\r\n    zmqSubSocket.setsockopt(zmq.SUBSCRIBE, topic1)\r\n    zmqSubSocket.setsockopt(zmq.SUBSCRIBE, topic2)\r\n    zmqSubSocket.connect(\"tcp://127.0.0.1:%i\" % port)\r\n\r\n    def handleBLK(blk):\r\n        print \"-BLKHDR-\"\r\n        print binascii.hexlify(blk[:80])\r\n\r\n    def handleTX(tx):\r\n        print \"-TX-\"\r\n        print binascii.hexlify(tx)\r\n\r\n    try:\r\n        while True:\r\n            msg = zmqSubSocket.recv()\r\n            msg_topic = msg[:topic_len]\r\n            msg_data  = msg[topic_len:]\r\n\r\n            if msg_topic == \"TXN\":\r\n                handleTX(msg_data)\r\n            elif msg_topic == \"BLK\":\r\n                handleBLK(msg_data)\r\n\r\n    except KeyboardInterrupt:\r\n        zmqContext.destroy()\r\n\r\n\r\nThis example is provided in the contrib/zmq directory of the source code.\r\n\r\n## Security Considerations\r\n\r\nFrom the perspective of bitcoind, the ZeroMQ socket is write-only; PUB sockets don't even have a read function.  Thus, there is no state introduced into bitcoind directly.  Furthermore, no information is broadcast that wasn't already received from the public P2P network.\r\n\r\nNo authentication or authorization is done on connecting clients; it is assumed that the ZeroMQ port is exposed only to trusted entities, using other means such as firewalling.\r\n\r\nTransactions and blocks are broadcast in their serialized form directly as received and validated by bitcoind.  External software may assume that these have passed all validity/consensus/standard checks, but of course is free to perform these functions again in part or in whole.\r\n",
   "closed_at" : "2015-01-08T13:32:34Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 29,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4594/comments",
   "created_at" : "2014-07-27T21:05:59Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4594/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/4594",
   "id" : 38850605,
   "labels" : [
      {
         "color" : "0052cc",
         "name" : "RPC/REST/ZMQ",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4594/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 4594,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/4594.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4594",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/4594.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4594"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Adds publishing blocks and transactions over ZMQ",
   "updated_at" : "2015-09-19T06:10:10Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4594",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/1492956?v=3",
      "events_url" : "https://api.github.com/users/jmcorgan/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jmcorgan/followers",
      "following_url" : "https://api.github.com/users/jmcorgan/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jmcorgan/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jmcorgan",
      "id" : 1492956,
      "login" : "jmcorgan",
      "organizations_url" : "https://api.github.com/users/jmcorgan/orgs",
      "received_events_url" : "https://api.github.com/users/jmcorgan/received_events",
      "repos_url" : "https://api.github.com/users/jmcorgan/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jmcorgan/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jmcorgan/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jmcorgan"
   }
}
