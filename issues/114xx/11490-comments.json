[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144443566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144443566"
         }
      },
      "author_association" : "OWNER",
      "body" : "Unused variable",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-13T00:40:18Z",
      "diff_hunk" : "@@ -502,7 +517,7 @@ void PeerLogicValidation::InitializeNode(CNode *pnode) {\n     NodeId nodeid = pnode->GetId();\n     {\n         LOCK(cs_main);\n-        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, std::move(addrName)));\n+        auto it = mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, std::move(addrName)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144443566",
      "id" : 144443566,
      "original_commit_id" : "d5b4bf323f743f521c93d18b20eaa6355a9e54d7",
      "original_position" : 41,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69102056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144443566",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144444476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144444476"
         }
      },
      "author_association" : "OWNER",
      "body" : "Nit: same line",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-13T00:48:50Z",
      "diff_hunk" : "@@ -3244,6 +3272,56 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        if (!(state.fProtectFromDisconnect || pto->fInbound || pto->fAddnode || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,\n+            // we should sync to it, unless it's invalid, in which case we\n+            // should find that out and disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork)\n+            {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144444476",
      "id" : 144444476,
      "original_commit_id" : "d5b4bf323f743f521c93d18b20eaa6355a9e54d7",
      "original_position" : 94,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69102056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144444476",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "I've spent some time verifying the logic, and it looks very good.\r\n\r\nI briefly misunderstood it to mean that if a peer makes _progress_ during the 20 minute window, it would be extended. That would have been a problem (an incompatible chain that has less work but does grow continuously), but it's not what happens (it requires reaching the same amount of work as we had at the beginning of the window).\r\n\r\nA test for the second commit would be great.",
      "created_at" : "2017-10-13T01:55:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-336328641",
      "id" : 336328641,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-13T01:55:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/336328641",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144503759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144503759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this needs to be backed off a bit:  Consider-- imagine we start and are fully synced up, but we are still in IsInitialBlockDownload because the network has been slow and so the tip's timestamp is a ways back.  Then we have a peer we get headers from who is a single block behind us.   This would disconnect them, and I think that is probably undesirable.\r\n\r\nIt's probably a good idea to review all code as if IsInitialBlockDownload() were just return true; and if there would be misbehavior in that case, then the usage is perhaps suboptimal.\r\nAn obvious conservative thing to do would be to just use the nMinimumChainWork ... though perhaps too conservative.  It might also be reasonable to use a GetBlockProofEquivalentTime like test, or just the work several blocks back from chainactive tip.   I think if it was conservative enough it could apply at all times, not just IsIninitialBlockDownload().  \r\n\r\nMaybe the existence of the second commit means that it would be okay for this one to be less aggressive?",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-13T09:17:39Z",
      "diff_hunk" : "@@ -2363,6 +2363,23 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {\n+            // When nCount < MAX_HEADERS_RESULTS, we know we have no more\n+            // headers to fetch from this peer.\n+            const arith_uint256 &peer_chainwork = nodestate->pindexBestKnownBlock->nChainWork;\n+            const arith_uint256 &our_chainwork = std::max(chainActive.Tip()->nChainWork, nMinimumChainWork);\n+            if (peer_chainwork < our_chainwork) {\n+                // This peer has too little work on their headers chain to help\n+                // us sync -- disconnect if using an outbound slot (unless\n+                // whitelisted).\n+                if (!(pfrom->fInbound || pfrom->fWhitelisted || pfrom->fAddnode)) {\n+                    pfrom->fDisconnect = true;\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144503759",
      "id" : 144503759,
      "original_commit_id" : "3203afcc7a42aa69b2d444e0322eb746e73fc361",
      "original_position" : 18,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69169105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144503759",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144549214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144549214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess with the second commit, we will eventually disconnect some peers if they stay on chains with less work than our tip.  So I think we could just leave this as nMinimumChainWork, to protect against the case that all our peers only have incomplete/bogus chains (which wouldn't be prevented by the second commit).",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-13T13:14:27Z",
      "diff_hunk" : "@@ -2363,6 +2363,23 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {\n+            // When nCount < MAX_HEADERS_RESULTS, we know we have no more\n+            // headers to fetch from this peer.\n+            const arith_uint256 &peer_chainwork = nodestate->pindexBestKnownBlock->nChainWork;\n+            const arith_uint256 &our_chainwork = std::max(chainActive.Tip()->nChainWork, nMinimumChainWork);\n+            if (peer_chainwork < our_chainwork) {\n+                // This peer has too little work on their headers chain to help\n+                // us sync -- disconnect if using an outbound slot (unless\n+                // whitelisted).\n+                if (!(pfrom->fInbound || pfrom->fWhitelisted || pfrom->fAddnode)) {\n+                    pfrom->fDisconnect = true;\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144549214",
      "id" : 144549214,
      "in_reply_to_id" : 144503759,
      "original_commit_id" : "3203afcc7a42aa69b2d444e0322eb746e73fc361",
      "original_position" : 18,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69222114,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144549214",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review.  I've pushed up a couple quick fixes for the nits.  Will work on a test, as well as trying to implement a suggestion @gmaxwell gave me offline for improving the behavior in the situation where none of our peers are giving us any block announcements.",
      "created_at" : "2017-10-13T13:16:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-336449305",
      "id" : 336449305,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-13T13:16:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/336449305",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145531028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145531028"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I believe this adds a new invariant (currently true), that we shall never send a GETHEADERS or do something which expects, as a result, a HEADERS message, which is not MAX_HEADERS_RESULT if it doesn't end with the peer's tip (ie no GETHEADERS with hashStop of not-their-tip, or at least not when in IBD/before we've finished syncing the state of another peer). I don't think this is bad, but it should be documented somewhere explicitly.\r\n\r\nEventually I really think we need to have peers in a \"mode\" which describes were we are 1. connect-handshake (version/verack/sendcmpct/sendheaders/feefilter/etc) 2. header-chain-sync (slightly complicated by the fact that we want to block all peers but one during ibd until we've finished one) 3. normal operation and then we can simplify and document strange things like this significantly instead of making everything yet more of a mess.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-18T20:23:32Z",
      "diff_hunk" : "@@ -2383,6 +2383,21 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145531028",
      "id" : 145531028,
      "original_commit_id" : "6e21a4a7935108aed6cb8b7528a5e30ae71f63eb",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70345107,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145531028",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145557409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145557409"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "new code should have the m_ prefix here (and other places), and probably drop the hungarian type prefix.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-18T22:13:07Z",
      "diff_hunk" : "@@ -200,6 +203,14 @@ struct CNodeState {\n      * otherwise: whether this peer sends non-witnesses in cmpctblocks/blocktxns.\n      */\n     bool fSupportsDesiredCmpctVersion;\n+    //! Whether this peer is protected from disconnection due to a bad/slow chain\n+    bool fProtectFromDisconnect;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145557409",
      "id" : 145557409,
      "original_commit_id" : "4b8a4bd29cd5550f808a04f5ad10bcafd495f877",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70345107,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145557409",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145568180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145568180"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ugh, just for a print?",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-18T23:21:17Z",
      "diff_hunk" : "@@ -3247,6 +3290,55 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        if (!(state.fProtectFromDisconnect || pto->fInbound || pto->m_manual_connection || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,\n+            // we should sync to it, unless it's invalid, in which case we\n+            // should find that out and disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {\n+                if (state.nHeadersChainTimeout != 0) {\n+                    state.nHeadersChainTimeout = 0;\n+                    state.header_with_required_work = nullptr;\n+                    state.fSentGetHeadersToCheckChainSync = false;\n+                }\n+            } else if (state.nHeadersChainTimeout == 0 || (state.header_with_required_work != nullptr && state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= state.header_with_required_work->nChainWork)) {\n+                // Our best block known by this peer is behind our tip, and we're either noticing\n+                // that for the first time, OR this peer was able to catch up to some earlier point\n+                // where we checked against our tip.\n+                // Either way, set a new timeout based on current tip.\n+                state.nHeadersChainTimeout = nNow + CHAIN_SYNC_TIMEOUT;\n+                state.header_with_required_work = chainActive.Tip();\n+                state.fSentGetHeadersToCheckChainSync = false;\n+            } else if (state.nHeadersChainTimeout > 0 && nNow > state.nHeadersChainTimeout) {\n+                // No evidence yet that our peer has synced to a chain with work equal to that\n+                // of our tip, when we first detected it was behind.  Send a single getheaders\n+                // message to give the peer a chance to update us.\n+                if (state.fSentGetHeadersToCheckChainSync) {\n+                    // They've run out of time to catch up!\n+                    LogPrintf(\"Disconnecting outbound peer %d for old chain, best known block = %s\\n\", pto->GetId(), state.pindexBestKnownBlock != nullptr ? state.pindexBestKnownBlock->GetBlockHash().ToString() : \"<none>\");\n+                    pto->fDisconnect = true;\n+                } else {\n+                    const CBlockIndex *pindexStart = state.header_with_required_work;\n+                    assert (pindexStart != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145568180",
      "id" : 145568180,
      "original_commit_id" : "b44013e9e71ad9f1aaa146edfece1cd84b2f4361",
      "original_position" : 119,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70345107,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145568180",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145744064"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145744064"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I believe this adds a new invariant (currently true), that we shall never send a GETHEADERS or do something which expects, as a result, a HEADERS message, which is not MAX_HEADERS_RESULT if it doesn't end with the peer's tip (ie no GETHEADERS with hashStop of not-their-tip, or at least not when in IBD/before we've finished syncing the state of another peer). I don't think this is bad, but it should be documented somewhere explicitly.\r\n\r\nI don't think this is precisely correct.  What we are assuming is the same thing we use for headers sync (eg on initial connection) -- if we receive fewer than MAX_HEADERS_RESULTS, then we have no reason to request more headers _in order to update pindexBestKnownBlock_.  Note that in the logic below, we are using pindexBestKnownBlock, not pindexLast.\r\n\r\nIn other words, if we did add a reason for requesting a single header to a random location in the chain, I think this logic would still be correct.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-19T15:54:48Z",
      "diff_hunk" : "@@ -2383,6 +2383,21 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145744064",
      "id" : 145744064,
      "in_reply_to_id" : 145531028,
      "original_commit_id" : "6e21a4a7935108aed6cb8b7528a5e30ae71f63eb",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70589798,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145744064",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145761027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145761027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agreed, chucking it",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-19T16:59:09Z",
      "diff_hunk" : "@@ -3247,6 +3290,55 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        if (!(state.fProtectFromDisconnect || pto->fInbound || pto->m_manual_connection || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,\n+            // we should sync to it, unless it's invalid, in which case we\n+            // should find that out and disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {\n+                if (state.nHeadersChainTimeout != 0) {\n+                    state.nHeadersChainTimeout = 0;\n+                    state.header_with_required_work = nullptr;\n+                    state.fSentGetHeadersToCheckChainSync = false;\n+                }\n+            } else if (state.nHeadersChainTimeout == 0 || (state.header_with_required_work != nullptr && state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= state.header_with_required_work->nChainWork)) {\n+                // Our best block known by this peer is behind our tip, and we're either noticing\n+                // that for the first time, OR this peer was able to catch up to some earlier point\n+                // where we checked against our tip.\n+                // Either way, set a new timeout based on current tip.\n+                state.nHeadersChainTimeout = nNow + CHAIN_SYNC_TIMEOUT;\n+                state.header_with_required_work = chainActive.Tip();\n+                state.fSentGetHeadersToCheckChainSync = false;\n+            } else if (state.nHeadersChainTimeout > 0 && nNow > state.nHeadersChainTimeout) {\n+                // No evidence yet that our peer has synced to a chain with work equal to that\n+                // of our tip, when we first detected it was behind.  Send a single getheaders\n+                // message to give the peer a chance to update us.\n+                if (state.fSentGetHeadersToCheckChainSync) {\n+                    // They've run out of time to catch up!\n+                    LogPrintf(\"Disconnecting outbound peer %d for old chain, best known block = %s\\n\", pto->GetId(), state.pindexBestKnownBlock != nullptr ? state.pindexBestKnownBlock->GetBlockHash().ToString() : \"<none>\");\n+                    pto->fDisconnect = true;\n+                } else {\n+                    const CBlockIndex *pindexStart = state.header_with_required_work;\n+                    assert (pindexStart != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145761027",
      "id" : 145761027,
      "in_reply_to_id" : 145568180,
      "original_commit_id" : "b44013e9e71ad9f1aaa146edfece1cd84b2f4361",
      "original_position" : 119,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70589798,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145761027",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Squashed (https://github.com/sdaftuar/bitcoin/commits/11490.1 -> 032dc531b911a0c0ea570aa74531508f54a36073)",
      "created_at" : "2017-10-19T17:23:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-337978038",
      "id" : 337978038,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-19T17:23:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/337978038",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Travis found:\r\n```\r\ntest/DoS_tests.cpp(80): error in \"outbound_slow_chain_eviction\": check dummyNode1.fDisconnect == true failed\r\n```",
      "created_at" : "2017-10-19T19:03:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-338005968",
      "id" : 338005968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-19T19:03:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/338005968",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Unit test issue should be fixed now.",
      "created_at" : "2017-10-19T21:02:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-338037130",
      "id" : 338037130,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-19T21:02:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/338037130",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145845983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145845983"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`int -= bool`?",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-19T23:07:59Z",
      "diff_hunk" : "@@ -534,6 +549,8 @@ void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTim\n     nPreferredDownload -= state->fPreferredDownload;\n     nPeersWithValidatedDownloads -= (state->nBlocksInFlightValidHeaders != 0);\n     assert(nPeersWithValidatedDownloads >= 0);\n+    g_outbound_peers_with_protect_from_disconnect -= state->m_protect_from_disconnect;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145845983",
      "id" : 145845983,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 40,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145845983",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145846296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145846296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Remove since this is easily calculated by counting nodes with `m_protect_from_disconnect`?",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-19T23:10:16Z",
      "diff_hunk" : "@@ -124,6 +124,9 @@ namespace {\n     /** Number of peers from which we're downloading blocks. */\n     int nPeersWithValidatedDownloads = 0;\n \n+    /** Number of outbound peers with m_protect_from_disconnect. */\n+    int g_outbound_peers_with_protect_from_disconnect = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145846296",
      "id" : 145846296,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145846296",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145846645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145846645"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`_FROM_DISCONNECT`?",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-19T23:12:44Z",
      "diff_hunk" : "@@ -21,6 +21,12 @@ static const unsigned int DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN = 100;\n  *  Timeout = base + per_header * (expected number of headers) */\n static constexpr int64_t HEADERS_DOWNLOAD_TIMEOUT_BASE = 15 * 60 * 1000000; // 15 minutes\n static constexpr int64_t HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER = 1000; // 1ms/header\n+/** Protect at least this many outbound peers from disconnection due to slow/\n+ * behind headers chain.\n+ */\n+static constexpr int32_t MAX_OUTBOUND_PEERS_TO_PROTECT = 4;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145846645",
      "id" : 145846645,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 7,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145846645",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848428"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "More verbose but IMO more clear:\r\n```cpp\r\nif (state->m_protect_from_disconnect) {\r\n    assert(g_outbound_peers_with_protect_from_disconnect > 0);\r\n    --g_outbound_peers_with_protect_from_disconnect;\r\n}\r\n```",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-19T23:26:27Z",
      "diff_hunk" : "@@ -534,6 +549,8 @@ void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTim\n     nPreferredDownload -= state->fPreferredDownload;\n     nPeersWithValidatedDownloads -= (state->nBlocksInFlightValidHeaders != 0);\n     assert(nPeersWithValidatedDownloads >= 0);\n+    g_outbound_peers_with_protect_from_disconnect -= state->m_protect_from_disconnect;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848428",
      "id" : 145848428,
      "in_reply_to_id" : 145845983,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 40,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848428",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848655"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Swap conditions as the second is faster?",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-19T23:28:11Z",
      "diff_hunk" : "@@ -2383,6 +2383,21 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848655",
      "id" : 145848655,
      "in_reply_to_id" : 145531028,
      "original_commit_id" : "6e21a4a7935108aed6cb8b7528a5e30ae71f63eb",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848655",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848695"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Remove extra space.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-19T23:28:26Z",
      "diff_hunk" : "@@ -2383,6 +2401,31 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848695",
      "id" : 145848695,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 58,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848695",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145849488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145849488"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Remove extra space.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-19T23:34:18Z",
      "diff_hunk" : "@@ -3247,6 +3290,52 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();\n+        if (!(state.m_protect_from_disconnect || pto->fInbound || pto->m_manual_connection || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,\n+            // we should sync to it, unless it's invalid, in which case we\n+            // should find that out and disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {\n+                if (state.m_headers_chain_timeout != 0) {\n+                    state.m_headers_chain_timeout = 0;\n+                    state.m_header_with_required_work = nullptr;\n+                    state.m_sent_getheaders_to_check_chain_sync = false;\n+                }\n+            } else if (state.m_headers_chain_timeout == 0 || (state.m_header_with_required_work != nullptr && state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= state.m_header_with_required_work->nChainWork)) {\n+                // Our best block known by this peer is behind our tip, and we're either noticing\n+                // that for the first time, OR this peer was able to catch up to some earlier point\n+                // where we checked against our tip.\n+                // Either way, set a new timeout based on current tip.\n+                state.m_headers_chain_timeout = time_in_seconds + CHAIN_SYNC_TIMEOUT;\n+                state.m_header_with_required_work = chainActive.Tip();\n+                state.m_sent_getheaders_to_check_chain_sync = false;\n+            } else if (state.m_headers_chain_timeout > 0 && time_in_seconds > state.m_headers_chain_timeout) {\n+                // No evidence yet that our peer has synced to a chain with work equal to that\n+                // of our tip, when we first detected it was behind.  Send a single getheaders",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145849488",
      "id" : 145849488,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 113,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145849488",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145853857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145853857"
         }
      },
      "author_association" : "MEMBER",
      "body" : "By looping over all the CNodeState objects when this value is needed?  I don't think that makes sense.  Note that tracking the value here is analogous to what we do with `nPeersWithValidatedDownloads` and `nPreferredDownload`.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-20T00:10:15Z",
      "diff_hunk" : "@@ -124,6 +124,9 @@ namespace {\n     /** Number of peers from which we're downloading blocks. */\n     int nPeersWithValidatedDownloads = 0;\n \n+    /** Number of outbound peers with m_protect_from_disconnect. */\n+    int g_outbound_peers_with_protect_from_disconnect = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145853857",
      "id" : 145853857,
      "in_reply_to_id" : 145846296,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70716818,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145853857",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145854096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145854096"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was following the pattern already in use in the lines above (`nPreferredDownload -= state->fPreferredDownload`).  But I can change to something like what you suggest if this is frowned upon for some reason.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-20T00:12:03Z",
      "diff_hunk" : "@@ -534,6 +549,8 @@ void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTim\n     nPreferredDownload -= state->fPreferredDownload;\n     nPeersWithValidatedDownloads -= (state->nBlocksInFlightValidHeaders != 0);\n     assert(nPeersWithValidatedDownloads >= 0);\n+    g_outbound_peers_with_protect_from_disconnect -= state->m_protect_from_disconnect;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145854096",
      "id" : 145854096,
      "in_reply_to_id" : 145845983,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 40,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70717062,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145854096",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145854280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145854280"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this really matters?  In the steady state (ie after we've caught up from initial sync), the second condition will generally be true, while the first condition will be false.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-20T00:13:44Z",
      "diff_hunk" : "@@ -2383,6 +2383,21 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145854280",
      "id" : 145854280,
      "in_reply_to_id" : 145531028,
      "original_commit_id" : "6e21a4a7935108aed6cb8b7528a5e30ae71f63eb",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70717256,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145854280",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145854518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145854518"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> if we receive fewer than MAX_HEADERS_RESULTS, then we have no reason to request more headers in order to update pindexBestKnownBlock. Note that in the logic below, we are using pindexBestKnownBlock, not pindexLast.\r\n\r\nI'm confused, then. If we randomly decide to request the header at height 1 in the middle of syncing our peer's header chain, we'd do fine in the rest of the ::HEADERS handling here, just (correctly) not requesting any further headers built on top of it. However, we'd immediately disconnect them if we're not in IBD by this new check. Previously this wouldn't break anything, as the next HEADERS they send us will result in us requesting further headers.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-20T00:16:00Z",
      "diff_hunk" : "@@ -2383,6 +2383,21 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145854518",
      "id" : 145854518,
      "in_reply_to_id" : 145531028,
      "original_commit_id" : "6e21a4a7935108aed6cb8b7528a5e30ae71f63eb",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70717509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145854518",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed some of @promag's nits at https://github.com/sdaftuar/bitcoin/commits/11490.2, squashed -> 39e0c8e",
      "created_at" : "2017-10-20T00:32:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-338074263",
      "id" : 338074263,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-20T00:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/338074263",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145859850"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145859850"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, you're right about that case -- I was thinking of the case where we send a random getheaders after we've already synced the chain, and therefore updated pindexBestKnownBlock to be some recent-ish thing.\r\n\r\nI guess it is true that if you just added a random getheaders message in the middle of initial sync, you might not break the sync logic, but this new logic would cause a disconnect...  I can add a comment indicating that we shouldn't do anything funky until after we've synced a peer's headers chain?",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-20T01:09:00Z",
      "diff_hunk" : "@@ -2383,6 +2383,21 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145859850",
      "id" : 145859850,
      "in_reply_to_id" : 145531028,
      "original_commit_id" : "6e21a4a7935108aed6cb8b7528a5e30ae71f63eb",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70723335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145859850",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146376617"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146376617"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Disconnecting from bad outbound peers in IBD\"\r\n\r\nCan you update comment to say why this is checking against nMinimumChainWork (and not chainActive.Tip()->nChainWork)?",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-23T19:58:25Z",
      "diff_hunk" : "@@ -2383,6 +2383,20 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain. Disconnect peers that are on chains with insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {\n+            // When nCount < MAX_HEADERS_RESULTS, we know we have no more\n+            // headers to fetch from this peer.\n+            if (nodestate->pindexBestKnownBlock->nChainWork < nMinimumChainWork) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146376617",
      "id" : 146376617,
      "original_commit_id" : "e9d58023aef97d954b7a75da806ee4f22c9760c3",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71309953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146376617",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146378731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146378731"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Disconnecting from bad outbound peers in IBD\"\r\n\r\nA comment saying why -whitelist is needed would be helfpul I think",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-23T20:06:59Z",
      "diff_hunk" : "@@ -27,7 +27,7 @@ class MinimumChainWorkTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.setup_clean_chain = True\n         self.num_nodes = 3\n-        self.extra_args = [[], [\"-minimumchainwork=0x65\"], [\"-minimumchainwork=0x65\"]]\n+        self.extra_args = [['-whitelist=127.0.0.1'], [\"-minimumchainwork=0x65\", '-whitelist=127.0.0.1'], [\"-minimumchainwork=0x65\"]]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146378731",
      "id" : 146378731,
      "original_commit_id" : "e9d58023aef97d954b7a75da806ee4f22c9760c3",
      "original_position" : 5,
      "path" : "test/functional/minchainwork.py",
      "position" : null,
      "pull_request_review_id" : 71309953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146378731",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146381766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146381766"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Permit disconnection of outbound peers on bad/slow chains\"\r\n\r\nI think you should do something to more clearly group these variables together. You could use doxygen grouping syntax:\r\n\r\n```c++\r\n//! State used to enforce CHAIN_SYNC_TIMEOUT.\r\n//! @{\r\n... variable declarations here ...\r\n//! @}\r\n```\r\n\r\nYou could also give them a common prefix like `m_sync_timeout_enable` / `m_sync_timeout_deadline` / `m_sync_timeout_min_work` / `m_sync_timeout_sent_getheaders` or move them to a nested struct, though that's probably asking a lot this far into the review.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-23T20:19:14Z",
      "diff_hunk" : "@@ -200,6 +203,14 @@ struct CNodeState {\n      * otherwise: whether this peer sends non-witnesses in cmpctblocks/blocktxns.\n      */\n     bool fSupportsDesiredCmpctVersion;\n+    //! Whether this peer is protected from disconnection due to a bad/slow chain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146381766",
      "id" : 146381766,
      "original_commit_id" : "9a70054f65cd9b63b3e5540160f4eb91fc505f17",
      "original_position" : 14,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71309953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146381766",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146387299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146387299"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Permit disconnection of outbound peers on bad/slow chains\"\r\n\r\nIt seems like it could be good to have an `pto->isOutbound()` helper returning `!pto->fInbound && !pto->m_manual_connection && !pto->fFeeler && !pto->fOneShot` so this long string of checks doesn't need to be repeated here and above in getheaders.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-23T20:40:31Z",
      "diff_hunk" : "@@ -3261,6 +3289,52 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();\n+        if (!(state.m_protect_from_disconnect || pto->fInbound || pto->m_manual_connection || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146387299",
      "id" : 146387299,
      "original_commit_id" : "9a70054f65cd9b63b3e5540160f4eb91fc505f17",
      "original_position" : 81,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71309953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146387299",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146389459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146389459"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Permit disconnection of outbound peers on bad/slow chains\"\r\n\r\nInstead of \"if their chain lags behind ours\" maybe be more specific and say \"if they don't announce a block with as much work as the current tip within CHAIN_SYNC_TIMEOUT+HEADERS_RESPONSE_TIME seconds.\"",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-23T20:48:48Z",
      "diff_hunk" : "@@ -3261,6 +3289,52 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();\n+        if (!(state.m_protect_from_disconnect || pto->fInbound || pto->m_manual_connection || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146389459",
      "id" : 146389459,
      "original_commit_id" : "9a70054f65cd9b63b3e5540160f4eb91fc505f17",
      "original_position" : 83,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71309953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146389459",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146394614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146394614"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Permit disconnection of outbound peers on bad/slow chains\":\r\n\r\nI don't see why the first and second branches of this if/else are distinct. It seems like you could unite them and drop unneeded checks with:\r\n\r\n```c++\r\nif (!state.m_header_with_required_work || (state.pindexBestKnownBlock && state.pindexBestKnownBlock->nChainWork >= state.m_header_with_required_work->nChainWork) {\r\n    // Reset timeout and min required work if peer caught up to previous requirement.\r\n    state.m_headers_chain_timeout = time_in_seconds + CHAIN_SYNC_TIMEOUT;\r\n    state.m_header_with_required_work = chainActive.Tip();\r\n    state.m_sent_getheaders_to_check_chain_sync = false;\r\n} else if (time_in_seconds > state.m_headers_chain_timeout) {\r\n...\r\n```\r\n\r\n\r\n",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-23T21:08:56Z",
      "diff_hunk" : "@@ -3261,6 +3289,52 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();\n+        if (!(state.m_protect_from_disconnect || pto->fInbound || pto->m_manual_connection || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,\n+            // we should sync to it, unless it's invalid, in which case we\n+            // should find that out and disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146394614",
      "id" : 146394614,
      "original_commit_id" : "9a70054f65cd9b63b3e5540160f4eb91fc505f17",
      "original_position" : 86,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71309953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146394614",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146400447"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146400447"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add unit test for outbound peer eviction\"\r\n\r\nMaybe check dummyNode1.vSendMsg size or contents to see if there actually was a getheaders.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-23T21:34:58Z",
      "diff_hunk" : "@@ -42,6 +42,48 @@ static NodeId id = 0;\n \n BOOST_FIXTURE_TEST_SUITE(DoS_tests, TestingSetup)\n \n+// Test eviction of an outbound peer whose chain never advances\n+// Mock a node connection, and use mocktime to simulate a peer\n+// which never sends any headers messages.  PeerLogic should\n+// decide to evict that outbound peer, after the appropriate timeouts.\n+// Note that we protect 4 outbound nodes from being subject to\n+// this logic; this test takes advantage of that protection only\n+// being applied to nodes which send headers with sufficient\n+// work.\n+BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n+{\n+    std::atomic<bool> interruptDummy(false);\n+\n+    // Mock an outbound peer\n+    CAddress addr1(ip(0xa0b0c001), NODE_NONE);\n+    CNode dummyNode1(id++, ServiceFlags(NODE_NETWORK|NODE_WITNESS), 0, INVALID_SOCKET, addr1, 0, 0, CAddress(), \"\", /*fInboundIn=*/ false);\n+    dummyNode1.SetSendVersion(PROTOCOL_VERSION);\n+\n+    peerLogic->InitializeNode(&dummyNode1);\n+    dummyNode1.nVersion = 1;\n+    dummyNode1.fSuccessfullyConnected = true;\n+\n+    // This test requires that we have a chain with non-zero work.\n+    BOOST_CHECK(chainActive.Tip() != nullptr);\n+    BOOST_CHECK(chainActive.Tip()->nChainWork > 0);\n+\n+    // Test starts here\n+    peerLogic->SendMessages(&dummyNode1, interruptDummy); // should result in getheaders\n+\n+    int64_t nStartTime = GetTime();\n+    // Wait 21 minutes, to\n+    SetMockTime(nStartTime+21*60);\n+    peerLogic->SendMessages(&dummyNode1, interruptDummy); // should result in getheaders",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146400447",
      "id" : 146400447,
      "original_commit_id" : "39e0c8e1e7b5cdf57437aa0f957b41183fd0e197",
      "original_position" : 35,
      "path" : "src/test/DoS_tests.cpp",
      "position" : 37,
      "pull_request_review_id" : 71309953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146400447",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146557036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146557036"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hm, I'll think about this.  I haven't quite convinced myself yet that there are no edge-case differences between your simplification and my original patch but you may be right.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T13:22:36Z",
      "diff_hunk" : "@@ -3261,6 +3289,52 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();\n+        if (!(state.m_protect_from_disconnect || pto->fInbound || pto->m_manual_connection || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,\n+            // we should sync to it, unless it's invalid, in which case we\n+            // should find that out and disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146557036",
      "id" : 146557036,
      "in_reply_to_id" : 146394614,
      "original_commit_id" : "9a70054f65cd9b63b3e5540160f4eb91fc505f17",
      "original_position" : 86,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71515238,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146557036",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky Thanks for the review; I've addressed all but one of your comments, which I'm still thinking about.",
      "created_at" : "2017-10-24T13:43:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-338994557",
      "id" : 338994557,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-24T13:43:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/338994557",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146585070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146585070"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Does it make sense to avoid the push above:\r\nhttps://github.com/bitcoin/bitcoin/blob/e9d58023aef97d954b7a75da806ee4f22c9760c3/src/net_processing.cpp#L2332\r\nnow that the node will disconnect?\r\n\r\nEdit: nevermind, since this is protected with `nCount != MAX_HEADERS_RESULTS`.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T14:47:22Z",
      "diff_hunk" : "@@ -2363,6 +2363,23 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {\n+            // When nCount < MAX_HEADERS_RESULTS, we know we have no more\n+            // headers to fetch from this peer.\n+            const arith_uint256 &peer_chainwork = nodestate->pindexBestKnownBlock->nChainWork;\n+            const arith_uint256 &our_chainwork = std::max(chainActive.Tip()->nChainWork, nMinimumChainWork);\n+            if (peer_chainwork < our_chainwork) {\n+                // This peer has too little work on their headers chain to help\n+                // us sync -- disconnect if using an outbound slot (unless\n+                // whitelisted).\n+                if (!(pfrom->fInbound || pfrom->fWhitelisted || pfrom->fAddnode)) {\n+                    pfrom->fDisconnect = true;\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146585070",
      "id" : 146585070,
      "in_reply_to_id" : 144503759,
      "original_commit_id" : "3203afcc7a42aa69b2d444e0322eb746e73fc361",
      "original_position" : 18,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71547747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146585070",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146614615"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146614615"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could maybe be more specific about the timeouts in the description. Instead of \"T in the future\", could write \"CHAIN_SYNC_TIMEOUT seconds in the future\", instead of \"bump the timeout\" could write \"reset the timeout\", instead of \"new shorter timeout\" could refer to HEADERS_RESPONSE_TIME.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T16:17:11Z",
      "diff_hunk" : "@@ -203,14 +203,32 @@ struct CNodeState {\n      * otherwise: whether this peer sends non-witnesses in cmpctblocks/blocktxns.\n      */\n     bool fSupportsDesiredCmpctVersion;\n-    //! Whether this peer is protected from disconnection due to a bad/slow chain\n-    bool m_protect_from_disconnect;\n-    //! A timeout used for checking whether our peer has sufficiently synced\n-    int64_t m_headers_chain_timeout;\n-    //! A header with the work we require on our peer's chain\n-    const CBlockIndex * m_header_with_required_work;\n-    //! After timeout is reached, set to true after sending getheaders\n-    bool m_sent_getheaders_to_check_chain_sync;\n+\n+    /** State used to enforce CHAIN_SYNC_TIMEOUT\n+      * Only in effect for outbound, non-manual connections, with\n+      * m_protect == false\n+      * Algorithm: if a peer's best known block has less work than our tip,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146614615",
      "id" : 146614615,
      "original_commit_id" : "b73dcd12b9d533b73c19572e03799860b0f11b6c",
      "original_position" : 25,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71581965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146614615",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146615542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146615542"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks. New \"compare their tip\" text might make a little more sense as part of the \"peer has too little work\" comment below rather than the \"no more headers to fetch from this peer\" comment up here.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T16:20:22Z",
      "diff_hunk" : "@@ -2383,6 +2383,20 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain. Disconnect peers that are on chains with insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {\n+            // When nCount < MAX_HEADERS_RESULTS, we know we have no more\n+            // headers to fetch from this peer.\n+            if (nodestate->pindexBestKnownBlock->nChainWork < nMinimumChainWork) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146615542",
      "id" : 146615542,
      "in_reply_to_id" : 146376617,
      "original_commit_id" : "e9d58023aef97d954b7a75da806ee4f22c9760c3",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71581965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146615542",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Squashed https://github.com/sdaftuar/bitcoin/commits/11490.3 -> 9dafb45",
      "created_at" : "2017-10-24T16:20:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-339047598",
      "id" : 339047598,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-24T16:20:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/339047598",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146633913"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146633913"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm unsure if it would be possible to get here without setting a pindexBestKnownBlock, but please double-check to be safe: ```if (nodestate->pindexBestKnownBlock && ...```",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T17:27:23Z",
      "diff_hunk" : "@@ -2383,6 +2383,24 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain. Disconnect peers that are on chains with insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {\n+            // When nCount < MAX_HEADERS_RESULTS, we know we have no more\n+            // headers to fetch from this peer. Compare their tip to\n+            // nMinimumChainWork (rather than chainActive.Tip()) because we\n+            // won't start block download until we have a headers chain that\n+            // has at least nMinimumChainWork, even if a peer has a chain past\n+            // our tip, as an anti-DoS measure.\n+            if (nodestate->pindexBestKnownBlock->nChainWork < nMinimumChainWork) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146633913",
      "id" : 146633913,
      "original_commit_id" : "0c4f59b7f8e3b5ea7e96c459789b4f55d7bca01b",
      "original_position" : 13,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71604379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146633913",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146637859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146637859"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T17:41:07Z",
      "diff_hunk" : "@@ -2383,6 +2383,24 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain. Disconnect peers that are on chains with insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {\n+            // When nCount < MAX_HEADERS_RESULTS, we know we have no more\n+            // headers to fetch from this peer. Compare their tip to\n+            // nMinimumChainWork (rather than chainActive.Tip()) because we\n+            // won't start block download until we have a headers chain that\n+            // has at least nMinimumChainWork, even if a peer has a chain past\n+            // our tip, as an anti-DoS measure.\n+            if (nodestate->pindexBestKnownBlock->nChainWork < nMinimumChainWork) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146637859",
      "id" : 146637859,
      "in_reply_to_id" : 146633913,
      "original_commit_id" : "0c4f59b7f8e3b5ea7e96c459789b4f55d7bca01b",
      "original_position" : 13,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71608892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146637859",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146637896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146637896"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T17:41:17Z",
      "diff_hunk" : "@@ -203,14 +203,32 @@ struct CNodeState {\n      * otherwise: whether this peer sends non-witnesses in cmpctblocks/blocktxns.\n      */\n     bool fSupportsDesiredCmpctVersion;\n-    //! Whether this peer is protected from disconnection due to a bad/slow chain\n-    bool m_protect_from_disconnect;\n-    //! A timeout used for checking whether our peer has sufficiently synced\n-    int64_t m_headers_chain_timeout;\n-    //! A header with the work we require on our peer's chain\n-    const CBlockIndex * m_header_with_required_work;\n-    //! After timeout is reached, set to true after sending getheaders\n-    bool m_sent_getheaders_to_check_chain_sync;\n+\n+    /** State used to enforce CHAIN_SYNC_TIMEOUT\n+      * Only in effect for outbound, non-manual connections, with\n+      * m_protect == false\n+      * Algorithm: if a peer's best known block has less work than our tip,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146637896",
      "id" : 146637896,
      "in_reply_to_id" : 146614615,
      "original_commit_id" : "b73dcd12b9d533b73c19572e03799860b0f11b6c",
      "original_position" : 25,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71608932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146637896",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146653950"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146653950"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```nodestate->pindexBestKnownBlock``` needs a nullptr check here too. Though after a quick look, it doesn't look like we can get here without a pindexBestKnownBlock. If that's the case (I haven't traced it fully) an assert may make more sense.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T18:36:19Z",
      "diff_hunk" : "@@ -2396,11 +2436,21 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 // This peer has too little work on their headers chain to help\n                 // us sync -- disconnect if using an outbound slot (unless\n                 // whitelisted or addnode).\n-                if (!(pfrom->fInbound || pfrom->fWhitelisted || pfrom->m_manual_connection)) {\n+                if (IsOutboundPeer(pfrom)) {\n+                    LogPrintf(\"Disconnecting outbound peer %d -- headers chain has insufficient work\\n\", pfrom->GetId());\n                     pfrom->fDisconnect = true;\n                 }\n             }\n         }\n+\n+        if (!pfrom->fDisconnect && IsOutboundPeer(pfrom)) {\n+            // If this is an outbound peer, check to see if we should protect\n+            // it from the bad/lagging chain logic.\n+            if (g_outbound_peers_with_protect_from_disconnect < MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT && nodestate->pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork && !nodestate->m_chain_sync.m_protect) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146653950",
      "id" : 146653950,
      "original_commit_id" : "ac5d938ef71d65c91cf2cb07b3125c961a462cfb",
      "original_position" : 97,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71627460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146653950",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146659652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146659652"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can this be factored out into a function? It seems we really only need to call it when we get new headers, or when a timer expires. Moving it out will make it easier to break up the SendMessages monster down the road.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T18:57:09Z",
      "diff_hunk" : "@@ -3265,6 +3315,54 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146659652",
      "id" : 146659652,
      "original_commit_id" : "ac5d938ef71d65c91cf2cb07b3125c961a462cfb",
      "original_position" : 111,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71634052,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146659652",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146664027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146664027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This name is really deceiving. Maybe IsOutboundDisconnectionCandidate?",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T19:13:56Z",
      "diff_hunk" : "@@ -502,6 +532,13 @@ void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vector<con\n \n } // namespace\n \n+// Returns true for outbound peers, excluding manual connections, feelers, and\n+// one-shots\n+bool IsOutboundPeer(const CNode *node)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146664027",
      "id" : 146664027,
      "original_commit_id" : "ac5d938ef71d65c91cf2cb07b3125c961a462cfb",
      "original_position" : 57,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71639040,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146664027",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146669594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146669594"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe peers can avoid being added as disconnection candidates if they just never respond to requests for blocks/headers (pindexBestKnownBlock is unset). In that case (assuming the \"Start block sync\" fired off an initial GETHEADERS above), should the clock also start here if pindexBestKnownBlock is null?\r\n\r\nNote: This comment conflicts with the one above about possibly asserting pindexBestKnownBlock here. Ignore whichever doesn't apply :)",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T19:36:32Z",
      "diff_hunk" : "@@ -3265,6 +3315,54 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();\n+        if (!state.m_chain_sync.m_protect && IsOutboundPeer(pto) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if they don't\n+            // announce a block with as much work as the current tip within\n+            // CHAIN_SYNC_TIMEOUT + HEADERS_RESPONSE_TIME seconds (note: if\n+            // their chain has more work than ours, we should sync to it,\n+            // unless it's invalid, in which case we should find that out and\n+            // disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {\n+                if (state.m_chain_sync.m_timeout != 0) {\n+                    state.m_chain_sync.m_timeout = 0;\n+                    state.m_chain_sync.m_work_header = nullptr;\n+                    state.m_chain_sync.m_sent_getheaders = false;\n+                }\n+            } else if (state.m_chain_sync.m_timeout == 0 || (state.m_chain_sync.m_work_header != nullptr && state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= state.m_chain_sync.m_work_header->nChainWork)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146669594",
      "id" : 146669594,
      "original_commit_id" : "ac5d938ef71d65c91cf2cb07b3125c961a462cfb",
      "original_position" : 125,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71645584,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146669594",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146677077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146677077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah it should be impossible due to the call to UpdateBlockAvailability() above, but I'll add the nullptr check anyway.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T20:06:47Z",
      "diff_hunk" : "@@ -2396,11 +2436,21 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 // This peer has too little work on their headers chain to help\n                 // us sync -- disconnect if using an outbound slot (unless\n                 // whitelisted or addnode).\n-                if (!(pfrom->fInbound || pfrom->fWhitelisted || pfrom->m_manual_connection)) {\n+                if (IsOutboundPeer(pfrom)) {\n+                    LogPrintf(\"Disconnecting outbound peer %d -- headers chain has insufficient work\\n\", pfrom->GetId());\n                     pfrom->fDisconnect = true;\n                 }\n             }\n         }\n+\n+        if (!pfrom->fDisconnect && IsOutboundPeer(pfrom)) {\n+            // If this is an outbound peer, check to see if we should protect\n+            // it from the bad/lagging chain logic.\n+            if (g_outbound_peers_with_protect_from_disconnect < MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT && nodestate->pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork && !nodestate->m_chain_sync.m_protect) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146677077",
      "id" : 146677077,
      "in_reply_to_id" : 146653950,
      "original_commit_id" : "ac5d938ef71d65c91cf2cb07b3125c961a462cfb",
      "original_position" : 97,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71654600,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146677077",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146682015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146682015"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If they don't respond, doesn't the timeout just expire and pindexBestKnownBlock doesn't matter?",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T20:26:18Z",
      "diff_hunk" : "@@ -3265,6 +3315,54 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();\n+        if (!state.m_chain_sync.m_protect && IsOutboundPeer(pto) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if they don't\n+            // announce a block with as much work as the current tip within\n+            // CHAIN_SYNC_TIMEOUT + HEADERS_RESPONSE_TIME seconds (note: if\n+            // their chain has more work than ours, we should sync to it,\n+            // unless it's invalid, in which case we should find that out and\n+            // disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {\n+                if (state.m_chain_sync.m_timeout != 0) {\n+                    state.m_chain_sync.m_timeout = 0;\n+                    state.m_chain_sync.m_work_header = nullptr;\n+                    state.m_chain_sync.m_sent_getheaders = false;\n+                }\n+            } else if (state.m_chain_sync.m_timeout == 0 || (state.m_chain_sync.m_work_header != nullptr && state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= state.m_chain_sync.m_work_header->nChainWork)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146682015",
      "id" : 146682015,
      "in_reply_to_id" : 146669594,
      "original_commit_id" : "ac5d938ef71d65c91cf2cb07b3125c961a462cfb",
      "original_position" : 125,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71660362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146682015",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146683222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146683222"
         }
      },
      "author_association" : "MEMBER",
      "body" : "~Nice catch, thanks!~\r\n\r\nActually I misread -- I think if a peer just never responds to a headers request, then (a) they won't be protected from this logic (because we only protect peers who give us headers with work at least equal to our tip), and (b) we'll drop into this else if clause if `m_timeout == 0`, ie if we've never set a timeout.  The rest of the condition is for the case where we had an existing timeout, then we'll reset it if we received a header that has sufficient work.\r\n\r\nAgree?",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T20:31:07Z",
      "diff_hunk" : "@@ -3265,6 +3315,54 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();\n+        if (!state.m_chain_sync.m_protect && IsOutboundPeer(pto) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if they don't\n+            // announce a block with as much work as the current tip within\n+            // CHAIN_SYNC_TIMEOUT + HEADERS_RESPONSE_TIME seconds (note: if\n+            // their chain has more work than ours, we should sync to it,\n+            // unless it's invalid, in which case we should find that out and\n+            // disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {\n+                if (state.m_chain_sync.m_timeout != 0) {\n+                    state.m_chain_sync.m_timeout = 0;\n+                    state.m_chain_sync.m_work_header = nullptr;\n+                    state.m_chain_sync.m_sent_getheaders = false;\n+                }\n+            } else if (state.m_chain_sync.m_timeout == 0 || (state.m_chain_sync.m_work_header != nullptr && state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= state.m_chain_sync.m_work_header->nChainWork)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146683222",
      "id" : 146683222,
      "in_reply_to_id" : 146669594,
      "original_commit_id" : "ac5d938ef71d65c91cf2cb07b3125c961a462cfb",
      "original_position" : 125,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71661810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146683222",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146686279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146686279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T20:42:15Z",
      "diff_hunk" : "@@ -3265,6 +3315,54 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146686279",
      "id" : 146686279,
      "in_reply_to_id" : 146659652,
      "original_commit_id" : "ac5d938ef71d65c91cf2cb07b3125c961a462cfb",
      "original_position" : 111,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71665357,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146686279",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146686294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146686294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T20:42:19Z",
      "diff_hunk" : "@@ -502,6 +532,13 @@ void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vector<con\n \n } // namespace\n \n+// Returns true for outbound peers, excluding manual connections, feelers, and\n+// one-shots\n+bool IsOutboundPeer(const CNode *node)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146686294",
      "id" : 146686294,
      "in_reply_to_id" : 146664027,
      "original_commit_id" : "ac5d938ef71d65c91cf2cb07b3125c961a462cfb",
      "original_position" : 57,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71665378,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:42:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146686294",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated to address latest comments from @theuni.",
      "created_at" : "2017-10-24T20:43:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-339124918",
      "id" : 339124918,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-24T20:43:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/339124918",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146689606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146689606"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, agreed.",
      "commit_id" : "011423049270dc288bb99d921620f9e0ba0bb43c",
      "created_at" : "2017-10-24T20:54:24Z",
      "diff_hunk" : "@@ -3265,6 +3315,54 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();\n+        if (!state.m_chain_sync.m_protect && IsOutboundPeer(pto) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if they don't\n+            // announce a block with as much work as the current tip within\n+            // CHAIN_SYNC_TIMEOUT + HEADERS_RESPONSE_TIME seconds (note: if\n+            // their chain has more work than ours, we should sync to it,\n+            // unless it's invalid, in which case we should find that out and\n+            // disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {\n+                if (state.m_chain_sync.m_timeout != 0) {\n+                    state.m_chain_sync.m_timeout = 0;\n+                    state.m_chain_sync.m_work_header = nullptr;\n+                    state.m_chain_sync.m_sent_getheaders = false;\n+                }\n+            } else if (state.m_chain_sync.m_timeout == 0 || (state.m_chain_sync.m_work_header != nullptr && state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= state.m_chain_sync.m_work_header->nChainWork)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r146689606",
      "id" : 146689606,
      "in_reply_to_id" : 146669594,
      "original_commit_id" : "ac5d938ef71d65c91cf2cb07b3125c961a462cfb",
      "original_position" : 125,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71669071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-24T20:54:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146689606",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 011423049270dc288bb99d921620f9e0ba0bb43c Needs squash",
      "created_at" : "2017-10-25T04:09:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-339208519",
      "id" : 339208519,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-25T04:09:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/339208519",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
