{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "I tried loading up all my wallet files at once to see how well it worked, then ran 'getbalance' on each of them. The balances of some were reported as being zero when they should have been non-zero.\r\n\r\nI believe the root cause is that I loaded up some old backups of the funded wallets as well as the up to date versions.\r\n\r\nIs that behavior meant to be supported? Or should each wallet have been created separately?\r\n\r\nMy guess is that the wallet database gets some kind of unique ID assigned to it when it is created, and loading up an old backup alongside the current version means I have two wallets with the same \"unique\" ID loaded at once, causing problems.\r\n\r\nAs an example, I have two wallets: `wallet.dat.finex` and `wallet.dat.finex2`. One is an old copy of the other. I loaded up a single third wallet, let it sync 3 blocks, shut down, then loaded the two `finex` wallets together. I had added debug to see why rescanning was being skipped in some cases.\r\n\r\n`wallet.cpp` has this test to decide whether the rescan is necessary:\r\n\r\n    if (chainActive.Tip() && chainActive.Tip() != pindexRescan)\r\n\r\nIn the debug output I saw:\r\n\r\n    2017-09-30 16:32:36 [wallet.dat.finex] rescan? checking tip()\r\n    2017-09-30 16:32:36 [wallet.dat.finex] rescan? maybe: chainActive.Tip() is true\r\n    2017-09-30 16:32:36 [wallet.dat.finex] rescan? yes: 0x7f60bf3f3db0 (487616) != 0x7f60d3d4aad0 (487613)\r\n\r\n    2017-09-30 16:32:36 [wallet.dat.finex2] rescan? checking tip()\r\n    2017-09-30 16:32:36 [wallet.dat.finex2] rescan? maybe: chainActive.Tip() is true\r\n    2017-09-30 16:32:36 [wallet.dat.finex2] rescan? no: 0x7f60bf3f3db0 (487616) == 0x7f60bf3f3db0 (487616)\r\n\r\nso the `finex` wallet gets 3 blocks rescanned, but the `finex2` wallet doesn't, even though it needs a rescan. I guess they share a `CWalletDB walletdb(*walletInstance->dbw);`.\r\n\r\nI stopped looking into it here, because maybe the solution is going to be \"stop loading copies of a wallet at the same time\".\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11429/comments",
   "created_at" : "2017-09-30T16:47:55Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11429/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/11429",
   "id" : 261856093,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11429/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 11429,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "multiwallet: issues arising from copying wallet files",
   "updated_at" : "2017-09-30T16:53:53Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11429",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/573356?v=4",
      "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
      "followers_url" : "https://api.github.com/users/dooglus/followers",
      "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
      "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/dooglus",
      "id" : 573356,
      "login" : "dooglus",
      "organizations_url" : "https://api.github.com/users/dooglus/orgs",
      "received_events_url" : "https://api.github.com/users/dooglus/received_events",
      "repos_url" : "https://api.github.com/users/dooglus/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/dooglus"
   }
}
