{
   "assignee" : null,
   "body" : "This is a first-pass change to begin resolving issues and #273, #1958, #2412.  I doubt this change completely ready, I intend on using this request for feedback on the current implementation of code and usage.\r\n\r\n____\r\n\r\n## Basic\r\nAllow users to set bandwidth limits on overall egress and/or command-specific egress bandwdith.  Overall egress bandwidth and command-specific egress bandwidth counts are saved to disk (currently every packet queued), to allow counts to be saved across runnings of the bitcoin node.  A simplified cron-expression is used to determine when to reset all bandwidth counts.\r\n\r\nThe cron-expression will cause start and reset times to \"snap\" to the closest values above and below the current time.  This allows exact control over when the bandwidth usage is reset via the expression, instead of relying on the time the program was last started or other arbitrary limitations.\r\n\r\n____\r\n\r\n## Configuration options\r\nFor command-line (prepend '-') or configuration file:\r\n* bandwidthsentmax - Overall egress bandwidth limit\r\n* bandwidthsentmax_[command] - Command-specific bandwidth limit\r\n* bandwidthresettimes - Cron-expression used to reset bandwidth counts\r\n\r\n____\r\n\r\n## Formats\r\n* Bandwidth - As regular expression /[0-9]+[BbKkMmGgTtPp]?[Bb]?/  - Valid for any values 0 - 18,446,744,073,709,551,616 bytes (16,384 Peta-bytes)\r\n* Cron - See [wiki](http://en.wikipedia.org/wiki/Cron#CRON_expression) for full cron expressions.  Numerical representations allowed only.  Special characters implemented: asterisk (*), slash (/) (with caveats), comma (,), and hyphen (-).  Slash requires the end value be landed upon (which means */4 requires the possible range be divisible by 4).\r\n\r\n____\r\n\r\n## Sample configuration\r\nBitcoin.conf\r\n````\r\n# minutes      hours       dayOfMonth  Month   dayOfWeek\r\n# Resets each month\r\n# 0            0           1           *       *\r\n#\r\n# Reset every sunday\r\n# *           *           *           *       0\r\n# Resets each minute\r\n# *           *           *           *       *\r\n#\r\n# Resets every 5 minutes\r\n# */5          *           *           *       *           \r\nbandwidthresettimes=0 0 0 * *\r\n\r\n# Only allow 2 GByte of sent data\r\nbandwidthsentmax=2G\r\n\r\n# Only send out 1 GByte of sent \"block\" commands\r\nbandwidthsentmax_block=1G\r\n````\r\n\r\n____\r\n\r\n## Files this change-set:\r\n### New\r\n#### bandwidthman.h and bandwdithman.cpp\r\n* New class to handle bandwidth management as needed, will serve a larger purpose as bandwidth management features are expanded.\r\n* Public functions\r\n    * LoadConfiguration() - Uses mapArgs to read reset time cron expression, uses mapArgs to read overall bandwidth cap and specific command bandwidth caps.\r\n    * TestScheduling(string strCronLine, struct tm tmTestTime) - Parses a given cron expression and uses a specific time to calculate start time and reset time.  Used only by the unit tester.\r\n    * AllowSendCommand(string strCommand, int nSize) - Determines if strCommand should be sent, given the command is nSize.\r\n\r\n#### tests/bandwidthman_tests.cpp\r\n* Contains unit tests for the calculation of start times and reset times used by the CBandwidthMan class.\r\n\r\n\r\n### Changed\r\n#### db.h\r\n* Rename CAddrDB to CDatDB and make abstract, generalize specific functions to globally applicable functions, consider the general format used by CAddrDB as being a \".dat\" file.\r\n* Create templated wrapper for new CDatDB named CSerialDatDB.  Extends CDatDB and allows for any serializable type to be used as the template type.\r\n* Create CAddrDB by making it an alias of CSerialDatDB<CAddrMan>, construct the CSerialDatDB with the static filename of \"peers.dat\" (as previously hard-coded).\r\n* Create CBandwidthDB by making it an alias of CSerialDatDB<CBandwidthMan>, construct CSerialDatDB with the static  filename of \"bandwidth.dat\".\r\n\r\nNote:  All changes to CAddrDB result in no usability changes.\r\n\r\n\r\n#### db.cpp\r\n* Change CAddrDB functions to CDatDB functions.\r\n* Modify write process to prepend message start and append hash due to change in serialization time of payload data (new lines 488-494).\r\n\r\n#### init.cpp\r\n* Insert new step 11: Load bandwidth manager.\r\n* Renumber old steps 11 and 12 to 12 and 13 respectively.\r\n\r\n#### makefile.*\r\n* Add objs/bandwidthman.o as new object\r\n\r\n#### net.h\r\n* Export instance of bandwidth manager.\r\n* Modify EndMessage to require the message name upon invocation and return success or failure to send message.\r\n     * EndMessage will return false if it is not allowed to send the message as determined by the bandwidth manager.\r\n     * If bandwidth manager does not allow the message to be sent, abort message.\r\n* Modify all push messages to return success or failure, determined by EndMessage call.\r\n    * Success/failure result is not currently used but planned for use later.\r\n\r\n#### net.cpp\r\n* Add new global instance of CBandwidthMan.\r\n\r\n____\r\n\r\n## Extra data\r\nWhile researching how to approach the problem, I collected command-specific egress data off of an unrestricted node that was on the latest block.  [This spreadsheet](https://docs.google.com/spreadsheet/ccc?key=0AnpjY4_hVstbdHpqeVRXeFZDM1lydmdYdndaWGlLZXc&usp=sharing) shows the count and total bandwidth of each of the commands.  I do not remember when or how long it took to collect this data, but I believe it was over a few hours with no local usage of the computer.  The branch at [brandondahler/bitcoin branch bandwidth-test](https://github.com/brandondahler/bitcoin/tree/bandwidth-test) can produce a text file that can aid in plugging in your own data into this spreadsheet.",
   "closed_at" : "2013-04-09T17:56:50Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
      "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
      "followers_url" : "https://api.github.com/users/gavinandresen/followers",
      "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/gavinandresen",
      "id" : 331997,
      "login" : "gavinandresen",
      "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
      "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
      "repos_url" : "https://api.github.com/users/gavinandresen/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/gavinandresen"
   },
   "comments" : 19,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2479/comments",
   "created_at" : "2013-04-07T06:24:57Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2479/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/2479",
   "id" : 12891057,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2479/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 2479,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/2479.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2479",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/2479.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2479"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Allow capping of bandwidth on overall or command-specific basis, reset via cron-like expression",
   "updated_at" : "2014-06-18T02:50:11Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2479",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/1155895?v=3",
      "events_url" : "https://api.github.com/users/brandondahler/events{/privacy}",
      "followers_url" : "https://api.github.com/users/brandondahler/followers",
      "following_url" : "https://api.github.com/users/brandondahler/following{/other_user}",
      "gists_url" : "https://api.github.com/users/brandondahler/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/brandondahler",
      "id" : 1155895,
      "login" : "brandondahler",
      "organizations_url" : "https://api.github.com/users/brandondahler/orgs",
      "received_events_url" : "https://api.github.com/users/brandondahler/received_events",
      "repos_url" : "https://api.github.com/users/brandondahler/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/brandondahler/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/brandondahler/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/brandondahler"
   }
}
