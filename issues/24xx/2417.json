{
   "assignee" : null,
   "body" : "This week I have been adding block replay into MultiBit for the bcj 0.8-MASTER code.\r\nI have it working but it is not as robust as it could be.\r\n\r\nThe main area is of trouble is the AbstractBlockChain#findSplit and related methods.\r\nThis is typical:\r\n\r\n14:02:25.127 [New I/O worker #2] WARN  com.google.bitcoin.core.Peer - [80.218.174.253]:8333 -  java.lang.NullPointerException: Attempt to follow an orphan chain\r\n\tat com.google.common.base.Preconditions.checkNotNull(Preconditions.java:204) ~[multibit-exe.jar:na]\r\n\tat com.google.bitcoin.core.AbstractBlockChain.findSplit(AbstractBlockChain.java:615) ~[multibit-exe.jar:na]\r\n\tat com.google.bitcoin.core.AbstractBlockChain.handleNewBestChain(AbstractBlockChain.java:524) ~[multibit-exe.jar:na]\r\n\tat com.google.bitcoin.core.AbstractBlockChain.connectBlock(AbstractBlockChain.java:483) ~[multibit-exe.jar:na]\r\n\tat com.google.bitcoin.core.AbstractBlockChain.add(AbstractBlockChain.java:359) ~[multibit-exe.jar:na]\r\n\tat com.google.bitcoin.core.AbstractBlockChain.add(AbstractBlockChain.java:247) ~[multibit-exe.jar:na]\r\n\tat com.google.bitcoin.core.Peer.endFilteredBlock(Peer.java:741) ~[multibit-exe.jar:na]\r\n\tat com.google.bitcoin.core.Peer.processMessage(Peer.java:257) ~[multibit-exe.jar:na]\r\n\tat com.google.bitcoin.core.Peer.access$400(Peer.java:48) ~[multibit-exe.jar:na]\r\n\tat com.google.bitcoin.core.Peer$PeerHandler.messageReceived(Peer.java:237) ~[multibit-exe.jar:na]\r\n\tat org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:296) ~[multibit-exe.jar:na]\r\n\tat org.jboss.netty.handler.codec.frame.FrameDecoder.unfoldAndFireMessageReceived(FrameDecoder.java:462) ~[multibit-exe.jar:na]\r\n\tat org.jboss.netty.handler.codec.replay.ReplayingDecoder.callDecode(ReplayingDecoder.java:536) ~[multibit-exe.jar:na]\r\n\tat org.jboss.netty.handler.codec.replay.ReplayingDecoder.messageReceived(ReplayingDecoder.java:435) ~[multibit-exe.jar:na]\r\n\tat org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:268) ~[multibit-exe.jar:na]\r\n\tat org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:255) ~[multibit-exe.jar:na]\r\n\tat org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:88) ~[multibit-exe.jar:na]\r\n\tat org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:107) ~[multibit-exe.jar:na]\r\n\tat org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:312) ~[multibit-exe.jar:na]\r\n\tat org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:88) ~[multibit-exe.jar:na]\r\n\tat org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178) ~[multibit-exe.jar:na]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:895) [na:1.6.0_43]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:918) [na:1.6.0_43]\r\n\tat java.lang.Thread.run(Thread.java:680) [na:1.6.0_43]\r\n\r\nThe net result of this is that the Peer gets dropped and so you waste time creating a new one. It still works but is not ideal.\r\n\r\nAlso to get the SPVBlockStore to replay ok I am creating a brand new SPVBlockStore on replay. If I don't, I precondition 'higher and lower are reversed' in AbstractBlockChain#getPartialChain\r\n\r\nAgain, recreating a new blockstore works but you always end up having to sync back to the last checkpoint even though you have all the block headers since then in the SPVBlockStore. This is a bit inefficient.\r\n\r\nThe code in the MultiBit mb-0.5-bcj-v0.8 branch is what I am working on.\r\n\r\n\r\n",
   "closed_at" : "2013-03-28T15:39:42Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/919427?v=3",
      "events_url" : "https://api.github.com/users/jim618/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jim618/followers",
      "following_url" : "https://api.github.com/users/jim618/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jim618/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jim618",
      "id" : 919427,
      "login" : "jim618",
      "organizations_url" : "https://api.github.com/users/jim618/orgs",
      "received_events_url" : "https://api.github.com/users/jim618/received_events",
      "repos_url" : "https://api.github.com/users/jim618/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jim618/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jim618/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jim618"
   },
   "comments" : 4,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2417/comments",
   "created_at" : "2013-03-28T12:31:12Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2417/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/2417",
   "id" : 12562412,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2417/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 2417,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Split processing on replay not as robust as it could be.",
   "updated_at" : "2013-03-28T15:39:42Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2417",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/919427?v=3",
      "events_url" : "https://api.github.com/users/jim618/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jim618/followers",
      "following_url" : "https://api.github.com/users/jim618/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jim618/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jim618",
      "id" : 919427,
      "login" : "jim618",
      "organizations_url" : "https://api.github.com/users/jim618/orgs",
      "received_events_url" : "https://api.github.com/users/jim618/received_events",
      "repos_url" : "https://api.github.com/users/jim618/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jim618/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jim618/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jim618"
   }
}
