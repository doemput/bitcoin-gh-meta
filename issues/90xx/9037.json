{
   "assignee" : null,
   "assignees" : [],
   "body" : "This change implement countermeasures 3 (test-before-evict) suggested in our paper: [\"Eclipse Attacks on BitcoinÃ¢ÂÂs Peer-to-Peer Network\"](http://cs-people.bu.edu/heilman/eclipse/).\n# Design:\n\nA collision occurs when an address, addr1, is being moved to the tried table from the new table, but maps to a position in the tried table which already contains an address (addr2). The current behavior is that addr1 would evict addr2 from the tried table.\n\nThis change ensures that during a collision, addr1 is not inserted into tried but instead inserted into a buffer (setTriedCollisions). The to-be-evicted address, addr2, is then tested by [a feeler connection](https://github.com/bitcoin/bitcoin/pull/8282). If addr2 is found to be online, we remove addr1 from the buffer and addr2 is not evicted, on the other hand if addr2 is found be offline it is replaced by addr1.\n\nAn additional small advantage of this change is that, as no more than ten addresses can be in the test buffer at once, and addresses are only cleared one at a time from the test buffer (at 2 minute intervals), thus an attacker is forced to wait at least two minutes to insert a new address into tried after filling up the test buffer. This rate limits an attacker attempting to launch an eclipse attack.\n# Risk mitigation:\n- To prevent this functionality from being used as a DoS vector, we limit the number of addresses which are to be tested to ten. If we have more than ten addresses to test, we drop new addresses being added to tried if they would evict an address. Since the feeler thread only creates one new connection every 2 minutes the additional network overhead is limited.\n- An address in tried gains immunity from tests for 4 hours after it has been tested or successfully connected to.\n# Tests:\n\nThis change includes additional addrman unittests which test this behavior.\n\nI ran an instance of this change with a much smaller tried table (2 buckets of 64 addresses) so that collisions were much more likely and observed evictions.\n\n```\n2016-10-27 07:20:26 Swapping 208.12.64.252:8333 for 68.62.95.247:8333 in tried table\n2016-10-27 07:20:26 Moving 208.12.64.252:8333 to tried\n```\n\nI documented tests we ran against similar earlier versions of this change in #6355.\n# Security Benefit\n\nThis is was originally posted in PR #8282 see [this comment for full details](https://github.com/bitcoin/bitcoin/pull/8282#issuecomment-237255215).\n\nTo determine the security benefit of these larger numbers of IPs in the tried table I modeled the attack presented in [Eclipse Attacks on BitcoinÃ¢ÂÂs Peer-to-Peer Network](https://eprint.iacr.org/2015/263).\n\n![attackergraph40000-10-1000short-line](https://cloud.githubusercontent.com/assets/274814/17366828/372af458-595b-11e6-81e5-2c9f97282305.png)\n\n**Default node:** 595 attacker IPs for ~50% attack success.\n**Default node + test-before-evict:** 620 attacker IPs for ~50% attack success.\n**Feeler node:** 5540 attacker IPs for ~50% attack success.\n**Feeler node + test-before-evict:** 8600 attacker IPs for ~50% attack success.\n\nThe node running feeler connections has 10 times as many online IP addresses in its tried table making an attack 10 times harder (i.e. requiring the an attacker require 10 times as many IP addresses in different /16s). Adding test-before-evict increases resistance of the node by an additional 3000 attacker IP addresses. \n\nBelow I graph the attack over even greater attacker resources (i.e. more attacker controled IP addresses). Note that test-before-evict maintains some security far longer even against an attacker with 50,000 IPs. If this node had a larger tried table test-before-evict could greatly boost a nodes resistance to eclipse attacks.\n\n![attacker graph long view](https://cloud.githubusercontent.com/assets/274814/17367108/96f46d64-595c-11e6-91cd-edba160598e7.png)\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 6,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9037/comments",
   "created_at" : "2016-10-28T21:53:59Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9037/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/9037",
   "id" : 186030760,
   "labels" : [
      {
         "color" : "006b75",
         "default" : false,
         "id" : 98298007,
         "name" : "P2P",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9037/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 9037,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/9037.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9037",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/9037.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9037"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "net: Add test-before-evict discipline to addrman",
   "updated_at" : "2017-02-16T11:38:55Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9037",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=3",
      "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
      "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
      "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
      "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/EthanHeilman",
      "id" : 274814,
      "login" : "EthanHeilman",
      "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
      "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
      "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/EthanHeilman"
   }
}
