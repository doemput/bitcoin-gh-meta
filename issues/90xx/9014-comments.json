[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84932213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84932213"
         }
      },
      "body" : "Don't you need a fallback for when the chainwork is identical?\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T15:35:52Z",
      "diff_hunk" : "@@ -2799,20 +2799,40 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct CompareBlockIndexByWork {\n+    bool operator()(const CBlockIndex* a, const CBlockIndex* b) const {\n+        return a->nChainWork < b->nChainWork;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84932213",
      "id" : 84932213,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 6,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5678302,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84932213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84941470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84941470"
         }
      },
      "body" : "nit: maybe do this as\n\n```\nit = blockTrace.mapBlocks.emplace(pindexNew, std::shared_ptr<const CBlock>(new CBlock())).first;\n```\n\nOr\n\n```\nauto pblockNew = std::make_shared<CBlock>();\n```\n\nand update following code accordingly\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T16:15:57Z",
      "diff_hunk" : "@@ -2799,20 +2799,40 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct CompareBlockIndexByWork {\n+    bool operator()(const CBlockIndex* a, const CBlockIndex* b) const {\n+        return a->nChainWork < b->nChainWork;\n+    }\n+};\n+\n+// Used in ActivateBestChain/ConnectBlock to keep track of blocks connected\n+// and notify listeners in the right order.\n+// Note that since mapBlocks is sorted lowest-work to highest-work, iterating\n+// over it will give you the order in which the blocks were connected\n+struct BlockConnectTrace {\n+    std::map<CBlockIndex*, std::shared_ptr<const CBlock>, CompareBlockIndexByWork> mapBlocks;\n+};\n+\n /**\n- * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n- * corresponding to pindexNew, to bypass loading it again from disk.\n+ * Connect a new block to chainActive.\n+ * If a shared_ptr to the block for pindexNew already exists in blockTrace.mapBlocks,\n+ * we will bypass re-loading the block from disk.\n  */\n-bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const CBlock* pblock, std::vector<std::shared_ptr<const CTransaction>> &txConflicted, std::vector<std::tuple<CTransaction,CBlockIndex*,int>> &txChanged)\n+bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, std::vector<std::shared_ptr<const CTransaction>> &txConflicted, BlockConnectTrace& blockTrace)\n {\n     assert(pindexNew->pprev == chainActive.Tip());\n     // Read block from disk.\n     int64_t nTime1 = GetTimeMicros();\n-    CBlock block;\n-    if (!pblock) {\n-        if (!ReadBlockFromDisk(block, pindexNew, chainparams.GetConsensus()))\n+    const CBlock *pblock;\n+    auto it = blockTrace.mapBlocks.find(pindexNew);\n+    if (it == blockTrace.mapBlocks.end()) {\n+        CBlock *pblockNew = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84941470",
      "id" : 84941470,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 37,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84941470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84941702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84941702"
         }
      },
      "body" : "Since its only used in each ActivateBestChainStep call individually, there is only ever one thing per given height/total work, but the map came out of an older version of the code and is now useless...so I'm replacing it with a vector.\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T16:16:57Z",
      "diff_hunk" : "@@ -2799,20 +2799,40 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct CompareBlockIndexByWork {\n+    bool operator()(const CBlockIndex* a, const CBlockIndex* b) const {\n+        return a->nChainWork < b->nChainWork;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84941702",
      "id" : 84941702,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 6,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5687211,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84941702",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948521"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948521"
         }
      },
      "body" : "See other comment about using make_shared\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T16:50:35Z",
      "diff_hunk" : "@@ -6023,23 +6050,24 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n     else if (strCommand == NetMsgType::BLOCK && !fImporting && !fReindex) // Ignore blocks received while importing\n     {\n-        CBlock block;\n-        vRecv >> block;\n+        CBlock *pblock = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948521",
      "id" : 84948521,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 181,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948692"
         }
      },
      "body" : "make_shared\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T16:51:24Z",
      "diff_hunk" : "@@ -132,7 +132,8 @@ UniValue generateBlocks(boost::shared_ptr<CReserveScript> coinbaseScript, int nG\n             continue;\n         }\n         CValidationState state;\n-        if (!ProcessNewBlock(state, Params(), NULL, pblock, true, NULL))\n+        std::shared_ptr<const CBlock> shared_pblock(new CBlock(*pblock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948692",
      "id" : 84948692,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 5,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948777"
         }
      },
      "body" : "make_shared\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T16:51:53Z",
      "diff_hunk" : "@@ -726,7 +727,9 @@ UniValue submitblock(const JSONRPCRequest& request)\n             + HelpExampleRpc(\"submitblock\", \"\\\"mydata\\\"\")\n         );\n \n-    CBlock block;\n+    CBlock* blockptr = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948777",
      "id" : 84948777,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 15,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948818"
         }
      },
      "body" : "make_shared\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T16:52:05Z",
      "diff_hunk" : "@@ -223,7 +223,8 @@ BOOST_AUTO_TEST_CASE(CreateNewBlock_validity)\n         pblock->hashMerkleRoot = BlockMerkleRoot(*pblock);\n         pblock->nNonce = blockinfo[i].nonce;\n         CValidationState state;\n-        BOOST_CHECK(ProcessNewBlock(state, chainparams, NULL, pblock, true, NULL));\n+        std::shared_ptr<const CBlock> shared_pblock(new CBlock(*pblock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948818",
      "id" : 84948818,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 5,
      "path" : "src/test/miner_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948843"
         }
      },
      "body" : "make_shared\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T16:52:13Z",
      "diff_hunk" : "@@ -127,7 +127,8 @@ TestChain100Setup::CreateAndProcessBlock(const std::vector<CMutableTransaction>&\n     while (!CheckProofOfWork(block.GetHash(), block.nBits, chainparams.GetConsensus())) ++block.nNonce;\n \n     CValidationState state;\n-    ProcessNewBlock(state, chainparams, NULL, &block, true, NULL);\n+    std::shared_ptr<const CBlock> shared_pblock(new CBlock(block));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948843",
      "id" : 84948843,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 5,
      "path" : "src/test/test_bitcoin.cpp",
      "position" : null,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948843",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84950014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84950014"
         }
      },
      "body" : "Semantics of passing shared_ptr by reference are a bit wonky. I think it is correct in this use case though. Perhaps it would be better for maintainability to eat the performance cost of an atomic increment and pass by value, or pass by const reference (if possible?).\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T16:58:11Z",
      "diff_hunk" : "@@ -3740,7 +3766,7 @@ static bool AcceptBlock(const CBlock& block, CValidationState& state, const CCha\n     return true;\n }\n \n-bool ProcessNewBlock(CValidationState& state, const CChainParams& chainparams, CNode* pfrom, const CBlock* pblock, bool fForceProcessing, const CDiskBlockPos* dbp)\n+bool ProcessNewBlock(CValidationState& state, const CChainParams& chainparams, CNode* pfrom, std::shared_ptr<const CBlock>& pblock, bool fForceProcessing, const CDiskBlockPos* dbp)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84950014",
      "id" : 84950014,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 137,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84950014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84950114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84950114"
         }
      },
      "body" : "make_shared\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T16:58:38Z",
      "diff_hunk" : "@@ -5829,7 +5855,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactions resp;\n         vRecv >> resp;\n \n-        CBlock block;\n+        CBlock *pblock = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84950114",
      "id" : 84950114,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 146,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84950114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84951636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84951636"
         }
      },
      "body" : "I think it may be worthwhile for you to make this a class and keep the implementation details hidden...\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T17:06:55Z",
      "diff_hunk" : "@@ -2799,20 +2799,40 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct CompareBlockIndexByWork {\n+    bool operator()(const CBlockIndex* a, const CBlockIndex* b) const {\n+        return a->nChainWork < b->nChainWork;\n+    }\n+};\n+\n+// Used in ActivateBestChain/ConnectBlock to keep track of blocks connected\n+// and notify listeners in the right order.\n+// Note that since mapBlocks is sorted lowest-work to highest-work, iterating\n+// over it will give you the order in which the blocks were connected\n+struct BlockConnectTrace {\n+    std::map<CBlockIndex*, std::shared_ptr<const CBlock>, CompareBlockIndexByWork> mapBlocks;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84951636",
      "id" : 84951636,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 15,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84951636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84953007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84953007"
         }
      },
      "body" : "The shared_ptrs are to a const CBlock, and IIRC you cant blindly cast a shared_ptr<CBlock> to a shared_ptr<const CBlock>, but you need to access the block as non-const, and I kinda prefer this over a const_cast.\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T17:13:42Z",
      "diff_hunk" : "@@ -5829,7 +5855,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactions resp;\n         vRecv >> resp;\n \n-        CBlock block;\n+        CBlock *pblock = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84953007",
      "id" : 84953007,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 146,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5698055,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84953007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84957095"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84957095"
         }
      },
      "body" : "implicit copy-cast should work...\n\n```\n#include <memory>\nint main() {\n    auto a = std::make_shared<int>(10);\n    std::shared_ptr<const int> b = a;\n}\n```\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T17:32:43Z",
      "diff_hunk" : "@@ -5829,7 +5855,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactions resp;\n         vRecv >> resp;\n \n-        CBlock block;\n+        CBlock *pblock = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84957095",
      "id" : 84957095,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 146,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5701877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84957095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84964567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84964567"
         }
      },
      "body" : "Cool, didnt realize that was a thing!\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T18:06:28Z",
      "diff_hunk" : "@@ -5829,7 +5855,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactions resp;\n         vRecv >> resp;\n \n-        CBlock block;\n+        CBlock *pblock = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84964567",
      "id" : 84964567,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 146,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5708818,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84964567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84969535"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84969535"
         }
      },
      "body" : "I added txConflicted here to make diffs of individual commits easier, which now requires a lot of access to the contents directly :/ Not sure its worth it.\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T18:29:28Z",
      "diff_hunk" : "@@ -2799,20 +2799,40 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct CompareBlockIndexByWork {\n+    bool operator()(const CBlockIndex* a, const CBlockIndex* b) const {\n+        return a->nChainWork < b->nChainWork;\n+    }\n+};\n+\n+// Used in ActivateBestChain/ConnectBlock to keep track of blocks connected\n+// and notify listeners in the right order.\n+// Note that since mapBlocks is sorted lowest-work to highest-work, iterating\n+// over it will give you the order in which the blocks were connected\n+struct BlockConnectTrace {\n+    std::map<CBlockIndex*, std::shared_ptr<const CBlock>, CompareBlockIndexByWork> mapBlocks;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84969535",
      "id" : 84969535,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 15,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5713582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84969535",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84969627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84969627"
         }
      },
      "body" : "The new version should be cleaner.\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-25T18:29:50Z",
      "diff_hunk" : "@@ -2799,20 +2799,40 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct CompareBlockIndexByWork {\n+    bool operator()(const CBlockIndex* a, const CBlockIndex* b) const {\n+        return a->nChainWork < b->nChainWork;\n+    }\n+};\n+\n+// Used in ActivateBestChain/ConnectBlock to keep track of blocks connected\n+// and notify listeners in the right order.\n+// Note that since mapBlocks is sorted lowest-work to highest-work, iterating\n+// over it will give you the order in which the blocks were connected\n+struct BlockConnectTrace {\n+    std::map<CBlockIndex*, std::shared_ptr<const CBlock>, CompareBlockIndexByWork> mapBlocks;\n+};\n+\n /**\n- * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n- * corresponding to pindexNew, to bypass loading it again from disk.\n+ * Connect a new block to chainActive.\n+ * If a shared_ptr to the block for pindexNew already exists in blockTrace.mapBlocks,\n+ * we will bypass re-loading the block from disk.\n  */\n-bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const CBlock* pblock, std::vector<std::shared_ptr<const CTransaction>> &txConflicted, std::vector<std::tuple<CTransaction,CBlockIndex*,int>> &txChanged)\n+bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, std::vector<std::shared_ptr<const CTransaction>> &txConflicted, BlockConnectTrace& blockTrace)\n {\n     assert(pindexNew->pprev == chainActive.Tip());\n     // Read block from disk.\n     int64_t nTime1 = GetTimeMicros();\n-    CBlock block;\n-    if (!pblock) {\n-        if (!ReadBlockFromDisk(block, pindexNew, chainparams.GetConsensus()))\n+    const CBlock *pblock;\n+    auto it = blockTrace.mapBlocks.find(pindexNew);\n+    if (it == blockTrace.mapBlocks.end()) {\n+        CBlock *pblockNew = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84969627",
      "id" : 84969627,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 37,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5713673,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84969627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "OK, ended up rewriting the PR quite a bit, cleaning it up and resolving the nits folks had raised - it now no longer has this crazy map thing that can be used as both a paramter and a return value.",
      "created_at" : "2016-10-25T18:30:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-256128799",
      "id" : 256128799,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-10-25T18:30:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/256128799",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "re-utack, much cleaner!",
      "created_at" : "2016-10-25T19:26:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-256149859",
      "id" : 256149859,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-10-25T19:26:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/256149859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85033430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85033430"
         }
      },
      "body" : "Can you use a doxygen compatible comment here?\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T01:06:18Z",
      "diff_hunk" : "@@ -2799,11 +2799,18 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+// Used to track conflicted transactions removed from mempool and transactions",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85033430",
      "id" : 85033430,
      "original_commit_id" : "34d0c884d612a3e2519ce3670894a32d668bd052",
      "original_position" : 4,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5773286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85033430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85034371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85034371"
         }
      },
      "body" : "This logic needs to be duplicated in the disconnect logic above. It's possible that an invalid block is received which triggers a reorg. So we start from chain A-B, and receive A-C-D, with D invalid. We'll first disconnect B, then successfully connect C, but fail when connecting D. We'll loop back then, disconnect C, and reconnect B. Your code will (I believe) report both C and B as newly connected, while it should be nothing at all.\n\nPerhaps it's easier to do a filtering step in ActivateBestChain that removes the errorneously blocks in the trace.\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T01:17:52Z",
      "diff_hunk" : "@@ -2974,6 +2975,8 @@ static bool ActivateBestChainStep(CValidationState& state, const CChainParams& c\n                     state = CValidationState();\n                     fInvalidFound = true;\n                     fContinue = false;\n+                    // If we didn't actually connect the block, don't notify listeners about it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85034371",
      "id" : 85034371,
      "original_commit_id" : "a0d30f80f31fbdc8e1aaf2bf1ea5f32c0b3e8ec4",
      "original_position" : 42,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5774127,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85034371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85034775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85034775"
         }
      },
      "body" : "Unintentional new lines?\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T01:22:46Z",
      "diff_hunk" : "@@ -2806,11 +2806,13 @@ struct ConnectTrace {\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n };\n \n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85034775",
      "id" : 85034775,
      "original_commit_id" : "051b9968cf32dfe7f05cf159b8b515bbdaae845d",
      "original_position" : 4,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5774478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85034775",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85035520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85035520"
         }
      },
      "body" : "In my opinion, passing by reference is preferred at any time when you're sure the shared_ptr itself (not the object it points to) is only accessed from a single thread. The cost of the atomic increment is negligable here though, so I don't care in this particular case.\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T01:32:54Z",
      "diff_hunk" : "@@ -3740,7 +3766,7 @@ static bool AcceptBlock(const CBlock& block, CValidationState& state, const CCha\n     return true;\n }\n \n-bool ProcessNewBlock(CValidationState& state, const CChainParams& chainparams, CNode* pfrom, const CBlock* pblock, bool fForceProcessing, const CDiskBlockPos* dbp)\n+bool ProcessNewBlock(CValidationState& state, const CChainParams& chainparams, CNode* pfrom, std::shared_ptr<const CBlock>& pblock, bool fForceProcessing, const CDiskBlockPos* dbp)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85035520",
      "id" : 85035520,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 137,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5775179,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85035520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85042624"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85042624"
         }
      },
      "body" : "Typo: deleted\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T03:07:25Z",
      "diff_hunk" : "@@ -5846,7 +5841,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactions resp;\n         vRecv >> resp;\n \n-        CBlock block;\n+        CBlock *pblock = new CBlock();\n+        std::shared_ptr<const CBlock> shared_pblock(pblock); // pblock will be delted by the shared_ptr",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85042624",
      "id" : 85042624,
      "original_commit_id" : "5095970c9703bdb23459839b4aade2ad56b792d5",
      "original_position" : 29,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5781432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85042624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85043630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85043630"
         }
      },
      "body" : "Hmm? I dont believe so? Note that the callbacks in question are called from ABC after each ABCS call, and might happen for blocks which will be reorged out in the next ABCS call (this is the existing behavior).\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T03:22:20Z",
      "diff_hunk" : "@@ -2974,6 +2975,8 @@ static bool ActivateBestChainStep(CValidationState& state, const CChainParams& c\n                     state = CValidationState();\n                     fInvalidFound = true;\n                     fContinue = false;\n+                    // If we didn't actually connect the block, don't notify listeners about it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85043630",
      "id" : 85043630,
      "original_commit_id" : "a0d30f80f31fbdc8e1aaf2bf1ea5f32c0b3e8ec4",
      "original_position" : 42,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5782379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85043630",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85047825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85047825"
         }
      },
      "body" : "No, cs_main is held during the entirety of the attempted reorg here, and the callbacks only fire after the whole thing (I think).\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T04:27:58Z",
      "diff_hunk" : "@@ -2959,14 +2968,16 @@ static bool ActivateBestChainStep(CValidationState& state, const CChainParams& c\n \n         // Connect new blocks.\n         BOOST_REVERSE_FOREACH(CBlockIndex *pindexConnect, vpindexToConnect) {\n-            if (!ConnectTip(state, chainparams, pindexConnect, pindexConnect == pindexMostWork ? pblock : NULL, txConflicted, txChanged)) {\n+            if (!ConnectTip(state, chainparams, pindexConnect, pindexConnect == pindexMostWork ? pblock : std::shared_ptr<const CBlock>(), connectTrace)) {\n                 if (state.IsInvalid()) {\n                     // The block violates a consensus rule.\n                     if (!state.CorruptionPossible())\n                         InvalidChainFound(vpindexToConnect.back());\n                     state = CValidationState();\n                     fInvalidFound = true;\n                     fContinue = false;\n+                    // If we didn't actually connect the block, don't notify listeners about it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85047825",
      "id" : 85047825,
      "original_commit_id" : "3f78bc176a3c612f320bce4516aadcd6234c0850",
      "original_position" : 84,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5786012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85047825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85133796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85133796"
         }
      },
      "body" : "I'm very confused. ActivateBestChain has always locked cs_main, called ActivateBestChainStep once, and then unlocked cs_main and made callbacks before repeating. In the old code we pushed transactions to update onto the callback queue at the end of ConnectTip and never removed them (since there will never be a DisconnectTip call within the same cs_main in ActivateBestChainStep since all DisconnectTips happen before ConnectTip).\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T14:24:01Z",
      "diff_hunk" : "@@ -2959,14 +2968,16 @@ static bool ActivateBestChainStep(CValidationState& state, const CChainParams& c\n \n         // Connect new blocks.\n         BOOST_REVERSE_FOREACH(CBlockIndex *pindexConnect, vpindexToConnect) {\n-            if (!ConnectTip(state, chainparams, pindexConnect, pindexConnect == pindexMostWork ? pblock : NULL, txConflicted, txChanged)) {\n+            if (!ConnectTip(state, chainparams, pindexConnect, pindexConnect == pindexMostWork ? pblock : std::shared_ptr<const CBlock>(), connectTrace)) {\n                 if (state.IsInvalid()) {\n                     // The block violates a consensus rule.\n                     if (!state.CorruptionPossible())\n                         InvalidChainFound(vpindexToConnect.back());\n                     state = CValidationState();\n                     fInvalidFound = true;\n                     fContinue = false;\n+                    // If we didn't actually connect the block, don't notify listeners about it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85133796",
      "id" : 85133796,
      "original_commit_id" : "3f78bc176a3c612f320bce4516aadcd6234c0850",
      "original_position" : 84,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5866264,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85133796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Before headers first, reorgs were dealt with by accumulating the changes in\r\nanother cache level, which was only flushed if the reorg succeeded.\r\n\r\nNow there is much less a concept of reorgs, and only attempts to improve\r\nthe tip. ABC finds what block we want and like to be the tip, and calls\r\nABCS to make progress towards that. In case of failure, we find what other\r\nblock we'd like to become the tip (which may be the previous one), and make\r\nprogress towards that. cs_main is only released once we're in a strictly\r\nbetter state than what we started off in, as otherwise you'd briefly expose\r\nthe forking point to GBT during a reorg.\r\n\r\nEDIT: see https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85174751 - I don't think there is an issue for this PR.",
      "created_at" : "2016-10-26T15:40:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-256386778",
      "id" : 256386778,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-10-26T17:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/256386778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85174751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85174751"
         }
      },
      "body" : "It seems that failed reorgs are an exception to what I said before, so ignore what I said. I think we should fix this (it could lead to GBT working on the forking point of a failed reorg), but that's outside of the scope here.\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T17:21:30Z",
      "diff_hunk" : "@@ -2959,14 +2968,16 @@ static bool ActivateBestChainStep(CValidationState& state, const CChainParams& c\n \n         // Connect new blocks.\n         BOOST_REVERSE_FOREACH(CBlockIndex *pindexConnect, vpindexToConnect) {\n-            if (!ConnectTip(state, chainparams, pindexConnect, pindexConnect == pindexMostWork ? pblock : NULL, txConflicted, txChanged)) {\n+            if (!ConnectTip(state, chainparams, pindexConnect, pindexConnect == pindexMostWork ? pblock : std::shared_ptr<const CBlock>(), connectTrace)) {\n                 if (state.IsInvalid()) {\n                     // The block violates a consensus rule.\n                     if (!state.CorruptionPossible())\n                         InvalidChainFound(vpindexToConnect.back());\n                     state = CValidationState();\n                     fInvalidFound = true;\n                     fContinue = false;\n+                    // If we didn't actually connect the block, don't notify listeners about it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85174751",
      "id" : 85174751,
      "original_commit_id" : "3f78bc176a3c612f320bce4516aadcd6234c0850",
      "original_position" : 84,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5905319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85174751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85176434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85176434"
         }
      },
      "body" : "Ultranit: if you swap this line with the one above, you can pass std::move(pblockNew) to emplace_back, avoiding an atomic increment + decrement when pblockNew goes out of scope.\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T17:29:20Z",
      "diff_hunk" : "@@ -2800,28 +2800,40 @@ static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n /**\n+ * Used to track conflicted transactions removed from mempool and transactions\n+ * applied to the UTXO state as a part of a single ActivateBestChainStep call.\n+ */\n+struct ConnectTrace {\n+    std::vector<std::shared_ptr<const CTransaction>> txConflicted;\n+    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+};\n+\n+/**\n  * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n  * corresponding to pindexNew, to bypass loading it again from disk.\n  */\n-bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const CBlock* pblock, std::vector<std::shared_ptr<const CTransaction>> &txConflicted, std::vector<std::tuple<CTransaction,CBlockIndex*,int>> &txChanged)\n+bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const std::shared_ptr<const CBlock>& pblock, ConnectTrace& connectTrace)\n {\n     assert(pindexNew->pprev == chainActive.Tip());\n     // Read block from disk.\n     int64_t nTime1 = GetTimeMicros();\n-    CBlock block;\n     if (!pblock) {\n-        if (!ReadBlockFromDisk(block, pindexNew, chainparams.GetConsensus()))\n+        std::shared_ptr<CBlock> pblockNew = std::make_shared<CBlock>();\n+        connectTrace.blocksConnected.emplace_back(pindexNew, pblockNew);\n+        if (!ReadBlockFromDisk(*pblockNew, pindexNew, chainparams.GetConsensus()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85176434",
      "id" : 85176434,
      "original_commit_id" : "3f78bc176a3c612f320bce4516aadcd6234c0850",
      "original_position" : 27,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5906887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85176434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85187415"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85187415"
         }
      },
      "body" : "No, because pblockNew is a std::shared_ptr<CBlock> not an std::shared_ptr<const CBlock>, so you must call the std::shared_ptr constructor to convert it.\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T18:20:49Z",
      "diff_hunk" : "@@ -2800,28 +2800,40 @@ static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n /**\n+ * Used to track conflicted transactions removed from mempool and transactions\n+ * applied to the UTXO state as a part of a single ActivateBestChainStep call.\n+ */\n+struct ConnectTrace {\n+    std::vector<std::shared_ptr<const CTransaction>> txConflicted;\n+    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+};\n+\n+/**\n  * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n  * corresponding to pindexNew, to bypass loading it again from disk.\n  */\n-bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const CBlock* pblock, std::vector<std::shared_ptr<const CTransaction>> &txConflicted, std::vector<std::tuple<CTransaction,CBlockIndex*,int>> &txChanged)\n+bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const std::shared_ptr<const CBlock>& pblock, ConnectTrace& connectTrace)\n {\n     assert(pindexNew->pprev == chainActive.Tip());\n     // Read block from disk.\n     int64_t nTime1 = GetTimeMicros();\n-    CBlock block;\n     if (!pblock) {\n-        if (!ReadBlockFromDisk(block, pindexNew, chainparams.GetConsensus()))\n+        std::shared_ptr<CBlock> pblockNew = std::make_shared<CBlock>();\n+        connectTrace.blocksConnected.emplace_back(pindexNew, pblockNew);\n+        if (!ReadBlockFromDisk(*pblockNew, pindexNew, chainparams.GetConsensus()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85187415",
      "id" : 85187415,
      "original_commit_id" : "3f78bc176a3c612f320bce4516aadcd6234c0850",
      "original_position" : 27,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5917235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85187415",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85189057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85189057"
         }
      },
      "body" : "I see!\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T18:28:20Z",
      "diff_hunk" : "@@ -2800,28 +2800,40 @@ static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n /**\n+ * Used to track conflicted transactions removed from mempool and transactions\n+ * applied to the UTXO state as a part of a single ActivateBestChainStep call.\n+ */\n+struct ConnectTrace {\n+    std::vector<std::shared_ptr<const CTransaction>> txConflicted;\n+    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+};\n+\n+/**\n  * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n  * corresponding to pindexNew, to bypass loading it again from disk.\n  */\n-bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const CBlock* pblock, std::vector<std::shared_ptr<const CTransaction>> &txConflicted, std::vector<std::tuple<CTransaction,CBlockIndex*,int>> &txChanged)\n+bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const std::shared_ptr<const CBlock>& pblock, ConnectTrace& connectTrace)\n {\n     assert(pindexNew->pprev == chainActive.Tip());\n     // Read block from disk.\n     int64_t nTime1 = GetTimeMicros();\n-    CBlock block;\n     if (!pblock) {\n-        if (!ReadBlockFromDisk(block, pindexNew, chainparams.GetConsensus()))\n+        std::shared_ptr<CBlock> pblockNew = std::make_shared<CBlock>();\n+        connectTrace.blocksConnected.emplace_back(pindexNew, pblockNew);\n+        if (!ReadBlockFromDisk(*pblockNew, pindexNew, chainparams.GetConsensus()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85189057",
      "id" : 85189057,
      "original_commit_id" : "3f78bc176a3c612f320bce4516aadcd6234c0850",
      "original_position" : 27,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5918727,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85189057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85193453"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85193453"
         }
      },
      "body" : "(if anyone else gets confused, Matt meant std::shared_ptr not std::atomic above)\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-10-26T18:49:31Z",
      "diff_hunk" : "@@ -2800,28 +2800,40 @@ static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n /**\n+ * Used to track conflicted transactions removed from mempool and transactions\n+ * applied to the UTXO state as a part of a single ActivateBestChainStep call.\n+ */\n+struct ConnectTrace {\n+    std::vector<std::shared_ptr<const CTransaction>> txConflicted;\n+    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+};\n+\n+/**\n  * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n  * corresponding to pindexNew, to bypass loading it again from disk.\n  */\n-bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const CBlock* pblock, std::vector<std::shared_ptr<const CTransaction>> &txConflicted, std::vector<std::tuple<CTransaction,CBlockIndex*,int>> &txChanged)\n+bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const std::shared_ptr<const CBlock>& pblock, ConnectTrace& connectTrace)\n {\n     assert(pindexNew->pprev == chainActive.Tip());\n     // Read block from disk.\n     int64_t nTime1 = GetTimeMicros();\n-    CBlock block;\n     if (!pblock) {\n-        if (!ReadBlockFromDisk(block, pindexNew, chainparams.GetConsensus()))\n+        std::shared_ptr<CBlock> pblockNew = std::make_shared<CBlock>();\n+        connectTrace.blocksConnected.emplace_back(pindexNew, pblockNew);\n+        if (!ReadBlockFromDisk(*pblockNew, pindexNew, chainparams.GetConsensus()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r85193453",
      "id" : 85193453,
      "original_commit_id" : "3f78bc176a3c612f320bce4516aadcd6234c0850",
      "original_position" : 27,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 5922923,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/85193453",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "Needs rebase.",
      "created_at" : "2016-11-07T22:26:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-258983475",
      "id" : 258983475,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-11-07T22:26:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/258983475",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Rebased.",
      "created_at" : "2016-11-07T22:48:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-258988616",
      "id" : 258988616,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-11-07T22:48:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/258988616",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Travis failures:\r\n```\r\n  CXX      libbitcoin_server_a-rest.o\r\n../../src/main.cpp: In function Ã¢ÂÂbool ProcessMessage(CNode*, std::string, CDataStream&, int64_t, const CChainParams&, CConnman&)Ã¢ÂÂ:\r\n../../src/main.cpp:6094:52: error: Ã¢ÂÂblockÃ¢ÂÂ was not declared in this scope\r\n             forceProcessing |= MarkBlockAsReceived(block.GetHash());\r\n```\r\n```\r\n  CXX      libbitcoin_server_a-torcontrol.o\r\n../../src/main.cpp: In function Ã¢ÂÂbool ProcessMessage(CNode*, std::string, CDataStream&, int64_t, const CChainParams&, CConnman&)Ã¢ÂÂ:\r\n../../src/main.cpp:6094:52: error: Ã¢ÂÂblockÃ¢ÂÂ was not declared in this scope\r\n             forceProcessing |= MarkBlockAsReceived(block.GetHash());\r\n```\r\n```\r\n../../src/main.cpp: In function Ã¢ÂÂbool ProcessMessage(CNode*, std::string, CDataStream&, int64_t, const CChainParams&, CConnman&)Ã¢ÂÂ:\r\n../../src/main.cpp:6094:52: error: Ã¢ÂÂblockÃ¢ÂÂ was not declared in this scope\r\n             forceProcessing |= MarkBlockAsReceived(block.GetHash());\r\n```",
      "created_at" : "2016-11-08T00:29:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-259008367",
      "id" : 259008367,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-11-08T00:29:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/259008367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=3",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "body" : "Looks like this is not rebased correctly - GH shows 5 conflicting files (and they match my own tests).",
      "created_at" : "2016-11-08T07:14:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-259063259",
      "id" : 259063259,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-11-08T07:14:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/259063259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6848764?v=3",
         "events_url" : "https://api.github.com/users/paveljanik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paveljanik/followers",
         "following_url" : "https://api.github.com/users/paveljanik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paveljanik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paveljanik",
         "id" : 6848764,
         "login" : "paveljanik",
         "organizations_url" : "https://api.github.com/users/paveljanik/orgs",
         "received_events_url" : "https://api.github.com/users/paveljanik/received_events",
         "repos_url" : "https://api.github.com/users/paveljanik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paveljanik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paveljanik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paveljanik"
      }
   },
   {
      "body" : "It just needs rebased again, closing for now and will rebase on top of #9075 after that gets merged.",
      "created_at" : "2016-11-09T01:19:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-259310666",
      "id" : 259310666,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-11-09T01:19:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/259310666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Rebased on  #9075.",
      "created_at" : "2016-11-17T23:28:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-261402967",
      "id" : 261402967,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-11-17T23:28:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/261402967",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Rebased after #9125 was merged. Note that #9125 should have fixed most of the performance regression here (and was likely the source of its major reorg speedup, though it should help in more real-world conditions as well), though this should still help some, and is a good step towards #9027 as well as improving callback concurrency in the future.",
      "created_at" : "2016-11-22T02:51:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-262133519",
      "id" : 262133519,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-11-22T02:51:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/262133519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r89256214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/89256214"
         }
      },
      "body" : "Ok (answered elsewhere).",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-11-23T04:44:44Z",
      "diff_hunk" : "@@ -2974,6 +2975,8 @@ static bool ActivateBestChainStep(CValidationState& state, const CChainParams& c\n                     state = CValidationState();\n                     fInvalidFound = true;\n                     fContinue = false;\n+                    // If we didn't actually connect the block, don't notify listeners about it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r89256214",
      "id" : 89256214,
      "original_commit_id" : "a0d30f80f31fbdc8e1aaf2bf1ea5f32c0b3e8ec4",
      "original_position" : 42,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 9802773,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/89256214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r89257012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/89257012"
         }
      },
      "body" : "This loop could be rewritten as \r\n```\r\nfor (const auto& ptx : pair.second->vtx)\r\n    GetMainSignals().SyncTransaction(*ptx, pair.first, i);\r\n```\r\n",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-11-23T05:01:13Z",
      "diff_hunk" : "@@ -3110,13 +3118,17 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n         // throw all transactions though the signal-interface\n         // while _not_ holding the cs_main lock\n-        for (const auto& tx : txConflicted)\n+        for (const auto& tx : connectTrace.txConflicted)\n         {\n             GetMainSignals().SyncTransaction(*tx, pindexNewTip, CMainSignals::SYNC_TRANSACTION_NOT_IN_BLOCK);\n         }\n         // ... and about transactions that got confirmed:\n-        for (unsigned int i = 0; i < txChanged.size(); i++)\n-            GetMainSignals().SyncTransaction(*std::get<0>(txChanged[i]), std::get<1>(txChanged[i]), std::get<2>(txChanged[i]));\n+        for (const auto& pair : connectTrace.blocksConnected) {\n+            assert(pair.second);\n+            const CBlock& block = *(pair.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r89257012",
      "id" : 89257012,
      "original_commit_id" : "7b717cdf7fde0614f64237d3430b7728103ee7e4",
      "original_position" : 136,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 9803498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/89257012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "utACK",
      "created_at" : "2016-11-24T20:59:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-262843945",
      "id" : 262843945,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-11-24T20:59:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/262843945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r89928493"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/89928493"
         }
      },
      "body" : "nit: slightly weird that the caller of ConnectTip() has to know to do this on failures.  Perhaps document this somewhere?",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-11-29T02:13:48Z",
      "diff_hunk" : "@@ -3018,6 +3019,8 @@ static bool ActivateBestChainStep(CValidationState& state, const CChainParams& c\n                     state = CValidationState();\n                     fInvalidFound = true;\n                     fContinue = false;\n+                    // If we didn't actually connect the block, don't notify listeners about it\n+                    connectTrace.blocksConnected.pop_back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r89928493",
      "id" : 89928493,
      "original_commit_id" : "eb33aa1412264a982ff315c88a231671c876e590",
      "original_position" : 43,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 10456731,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/89928493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Code review ACK, will test.",
      "created_at" : "2016-11-29T02:21:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-263457490",
      "id" : 263457490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-11-29T02:21:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/263457490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "ACK 7b717cd",
      "created_at" : "2016-11-29T22:33:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-263722051",
      "id" : 263722051,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-11-29T22:33:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/263722051",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r90170769"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/90170769"
         }
      },
      "body" : "Fixed",
      "commit_id" : "dd0df81ebdbf705f7ad386c7229bf1bbc3125f62",
      "created_at" : "2016-11-30T05:26:43Z",
      "diff_hunk" : "@@ -3018,6 +3019,8 @@ static bool ActivateBestChainStep(CValidationState& state, const CChainParams& c\n                     state = CValidationState();\n                     fInvalidFound = true;\n                     fContinue = false;\n+                    // If we didn't actually connect the block, don't notify listeners about it\n+                    connectTrace.blocksConnected.pop_back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r90170769",
      "id" : 90170769,
      "original_commit_id" : "eb33aa1412264a982ff315c88a231671c876e590",
      "original_position" : 43,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 10693090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-12-04T08:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/90170769",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Rebased after #9260.",
      "created_at" : "2016-12-04T08:21:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#issuecomment-264690796",
      "id" : 264690796,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9014",
      "updated_at" : "2016-12-04T08:21:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/264690796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
