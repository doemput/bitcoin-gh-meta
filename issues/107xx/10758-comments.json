[
   {
      "body" : "Note that the two generic \"Error initializing block database\" strings really should be changed, but as we are already in string freeze for 0.15, they will have to stay as-is for now :(.",
      "created_at" : "2017-07-07T00:07:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-313552143",
      "id" : 313552143,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-07T00:07:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/313552143",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "More explicitly fixed the bug that I accidentally fixed by being more explicit - RewindBlockIndex MUST be called even if we start with -reindex-chainstate.",
      "created_at" : "2017-07-07T01:33:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-313563496",
      "id" : 313563496,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-07T01:33:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/313563496",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "This needs an 0.15 tag as it fixes some bugs.",
      "created_at" : "2017-07-10T17:45:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-314181608",
      "id" : 314181608,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-10T17:45:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/314181608",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Rebased and added a fix for the issue @sipa pointed out at https://github.com/bitcoin/bitcoin/pull/10770#issuecomment-315558931",
      "created_at" : "2017-07-16T00:05:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-315571715",
      "id" : 315571715,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-16T00:05:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315571715",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r127596033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127596033"
         }
      },
      "body" : "I have difficulty parsing this sentence. Can you split it up?",
      "commit_id" : "c0025d0a92e438155901438580e4d2ebb376b951",
      "created_at" : "2017-07-16T00:42:53Z",
      "diff_hunk" : "@@ -3864,42 +3864,53 @@ void UnloadBlockIndex()\n bool LoadBlockIndex(const CChainParams& chainparams)\n {\n     // Load block index from databases\n-    if (!fReindex && !LoadBlockIndexDB(chainparams))\n-        return false;\n+    bool needs_init = fReindex;\n+    if (!fReindex) {\n+        bool ret = LoadBlockIndexDB(chainparams);\n+        if (!ret) return false;\n+        needs_init = mapBlockIndex.empty();\n+    }\n+\n+    if (needs_init) {\n+        // Note that LoadBlockIndexDB may have set fReindex if we shut down",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r127596033",
      "id" : 127596033,
      "original_commit_id" : "ccc35ffdc0e5a47976b9f842bdbb9ad6a5a470e6",
      "original_position" : 14,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 50200445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758",
      "updated_at" : "2017-07-27T19:03:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127596033",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@TheBlueMatt When starting with `-reindex`, and then restart before completing without `-reindex`, it seems to start over from scratch.",
      "created_at" : "2017-07-16T02:22:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-315576849",
      "id" : 315576849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-16T02:22:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315576849",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r127618896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127618896"
         }
      },
      "body" : "OK, rewrote the comment.",
      "commit_id" : "c0025d0a92e438155901438580e4d2ebb376b951",
      "created_at" : "2017-07-16T22:44:06Z",
      "diff_hunk" : "@@ -3864,42 +3864,53 @@ void UnloadBlockIndex()\n bool LoadBlockIndex(const CChainParams& chainparams)\n {\n     // Load block index from databases\n-    if (!fReindex && !LoadBlockIndexDB(chainparams))\n-        return false;\n+    bool needs_init = fReindex;\n+    if (!fReindex) {\n+        bool ret = LoadBlockIndexDB(chainparams);\n+        if (!ret) return false;\n+        needs_init = mapBlockIndex.empty();\n+    }\n+\n+    if (needs_init) {\n+        // Note that LoadBlockIndexDB may have set fReindex if we shut down",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r127618896",
      "id" : 127618896,
      "original_commit_id" : "ccc35ffdc0e5a47976b9f842bdbb9ad6a5a470e6",
      "original_position" : 14,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 50222368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758",
      "updated_at" : "2017-07-27T19:03:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127618896",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "ACK \r\n\r\n@TheBlueMatt I retract my comment, everything seems to be working like before.\r\n",
      "created_at" : "2017-07-17T05:18:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-315669990",
      "id" : 315669990,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-17T05:18:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315669990",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I'd like to see this in 0.15 as it at least turns an assert into an error message, in case your chainstate is out of sync with the block chain.",
      "created_at" : "2017-07-17T17:48:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-315828971",
      "id" : 315828971,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-17T17:48:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315828971",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "This (or some subset of it) absolutely has to land for 15, it fixes several regressions currently on master, but its a bugfix, so doesn't need to land today (but isnt small, so should go sooner rather than later).",
      "created_at" : "2017-07-17T17:49:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-315829317",
      "id" : 315829317,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-17T17:49:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315829317",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "I haven't finished reviewing, but this also fixes a crash when using an invalid -wallet argument. For example: ```./bitcoind -wallet='with spaces'```, which crashes for me on master.",
      "created_at" : "2017-07-19T18:10:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-316470855",
      "id" : 316470855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-19T18:10:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/316470855",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "utACK c93db42\r\n\r\nStrongly advocate for merging this in the near term.\r\nAlthough I have not gone through testing all sequences, I think this logic is far clearer and more straight forward than the existing logic and there are known bugs in the existing startup sequence.\r\nWith all the other changes to databases recently (rewinding, replaying, reindexing), I think it makes sense to have as much testing as possible with this new code rather than waste our time potentially finding more bugs with the old logic.\r\n",
      "created_at" : "2017-07-20T18:33:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-316791726",
      "id" : 316791726,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-20T18:33:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/316791726",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/4360349?v=4",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "In current master running `bitcoind -regtest '-wallet=foo%.dat'` gives:\r\n```\r\n./src/bitcoind -regtest '-wallet=foo%.dat'\r\nError: Invalid characters in -wallet filename\r\nSegmentation fault (core dumped)\r\n```\r\nWith this branch gives\r\n```\r\nError: Invalid characters in -wallet filename\r\nbitcoind: scheduler.cpp:200: void SingleThreadedSchedulerClient::EmptyQueue(): Assertion `!m_pscheduler->AreThreadsServicingQueue()' failed.\r\nAborted (core dumped)\r\n```\r\nReporting this here because of c93db42.",
      "created_at" : "2017-07-21T16:03:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-317041663",
      "id" : 317041663,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-21T16:03:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/317041663",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "Hmm, I went ahead and added the fix for @promag's race here, feel free to tell me it should be in a different PR. (@theuni note that it was a race, which may explain why you didnt see it).",
      "created_at" : "2017-07-23T17:55:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-317270239",
      "id" : 317270239,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-23T17:55:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/317270239",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@sipa hmm, re: restarting-mid-reindex: your original comment that it was broken was more correct than your later retraction. Fixed and cleaned that stuff up more with more comments :).",
      "created_at" : "2017-07-23T22:11:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-317285962",
      "id" : 317285962,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-23T22:11:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/317285962",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt if it's not related with your refactor then IMO a new PR would be best.",
      "created_at" : "2017-07-23T23:08:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-317288962",
      "id" : 317288962,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-23T23:08:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/317288962",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "OK, removed the top two commits so this is just what it was that got ACKs. The two commits from the top are in #10919, which should likely also be taken for 15.",
      "created_at" : "2017-07-24T18:58:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-317521420",
      "id" : 317521420,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-24T18:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/317521420",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "reutACK c93db429f909e75fbeacd2419fb8434350e3b674",
      "created_at" : "2017-07-25T01:42:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-317603655",
      "id" : 317603655,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-25T01:42:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/317603655",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r129809214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/129809214"
         }
      },
      "body" : "This error is no longer correct, this is \"failed to load genesis block\" now I guess?",
      "commit_id" : "c0025d0a92e438155901438580e4d2ebb376b951",
      "created_at" : "2017-07-27T10:44:06Z",
      "diff_hunk" : "@@ -3864,42 +3884,55 @@ void UnloadBlockIndex()\n bool LoadBlockIndex(const CChainParams& chainparams)\n {\n     // Load block index from databases\n-    if (!fReindex && !LoadBlockIndexDB(chainparams))\n-        return false;\n+    bool needs_init = fReindex;\n+    if (!fReindex) {\n+        bool ret = LoadBlockIndexDB(chainparams);\n+        if (!ret) return false;\n+        needs_init = mapBlockIndex.empty();\n+    }\n+\n+    if (needs_init) {\n+        // Everything here is for *new* reindex/DBs. Thus, though\n+        // LoadBlockIndexDB may have set fReindex if we shut down\n+        // mid-reindex previously, we don't check fReindex and\n+        // instead only check it prior to LoadBlockIndexDB to set\n+        // needs_init.\n+\n+        LogPrintf(\"Initializing databases...\\n\");\n+        // Use the provided setting for -txindex in the new database\n+        fTxIndex = GetBoolArg(\"-txindex\", DEFAULT_TXINDEX);\n+        pblocktree->WriteFlag(\"txindex\", fTxIndex);\n+    }\n     return true;\n }\n \n-bool InitBlockIndex(const CChainParams& chainparams)\n+bool LoadGenesisBlock(const CChainParams& chainparams)\n {\n     LOCK(cs_main);\n \n-    // Check whether we're already initialized\n-    if (chainActive.Genesis() != NULL)\n+    // Check whether we're already initialized by checking for genesis in\n+    // mapBlockIndex. Note that we can't use chainActive here, since it is\n+    // set based on the coins db, not the block index db, which is the only\n+    // thing loaded at this point.\n+    if (mapBlockIndex.count(chainparams.GenesisBlock().GetHash()))\n         return true;\n \n-    // Use the provided setting for -txindex in the new database\n-    fTxIndex = GetBoolArg(\"-txindex\", DEFAULT_TXINDEX);\n-    pblocktree->WriteFlag(\"txindex\", fTxIndex);\n-    LogPrintf(\"Initializing databases...\\n\");\n-\n     // Only add the genesis block if not reindexing (in which case we reuse the one already on disk)\n-    if (!fReindex) {\n-        try {\n-            CBlock &block = const_cast<CBlock&>(chainparams.GenesisBlock());\n-            // Start new block file\n-            unsigned int nBlockSize = ::GetSerializeSize(block, SER_DISK, CLIENT_VERSION);\n-            CDiskBlockPos blockPos;\n-            CValidationState state;\n-            if (!FindBlockPos(state, blockPos, nBlockSize+8, 0, block.GetBlockTime()))\n-                return error(\"LoadBlockIndex(): FindBlockPos failed\");\n-            if (!WriteBlockToDisk(block, blockPos, chainparams.MessageStart()))\n-                return error(\"LoadBlockIndex(): writing genesis block to disk failed\");\n-            CBlockIndex *pindex = AddToBlockIndex(block);\n-            if (!ReceivedBlockTransactions(block, state, pindex, blockPos, chainparams.GetConsensus()))\n-                return error(\"LoadBlockIndex(): genesis block not accepted\");\n-        } catch (const std::runtime_error& e) {\n-            return error(\"LoadBlockIndex(): failed to initialize block database: %s\", e.what());\n-        }\n+    try {\n+        CBlock &block = const_cast<CBlock&>(chainparams.GenesisBlock());\n+        // Start new block file\n+        unsigned int nBlockSize = ::GetSerializeSize(block, SER_DISK, CLIENT_VERSION);\n+        CDiskBlockPos blockPos;\n+        CValidationState state;\n+        if (!FindBlockPos(state, blockPos, nBlockSize+8, 0, block.GetBlockTime()))\n+            return error(\"LoadBlockIndex(): FindBlockPos failed\");\n+        if (!WriteBlockToDisk(block, blockPos, chainparams.MessageStart()))\n+            return error(\"LoadBlockIndex(): writing genesis block to disk failed\");\n+        CBlockIndex *pindex = AddToBlockIndex(block);\n+        if (!ReceivedBlockTransactions(block, state, pindex, blockPos, chainparams.GetConsensus()))\n+            return error(\"LoadBlockIndex(): genesis block not accepted\");\n+    } catch (const std::runtime_error& e) {\n+        return error(\"LoadBlockIndex(): failed to initialize block database: %s\", e.what());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r129809214",
      "id" : 129809214,
      "original_commit_id" : "c93db429f909e75fbeacd2419fb8434350e3b674",
      "original_position" : 148,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 52619303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758",
      "updated_at" : "2017-07-27T19:03:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/129809214",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r129809348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/129809348"
         }
      },
      "body" : "Would be better to use `error(\"%s: ...\", __func__)` here as in other places, but in any case, the function name is wrong now.",
      "commit_id" : "c0025d0a92e438155901438580e4d2ebb376b951",
      "created_at" : "2017-07-27T10:44:57Z",
      "diff_hunk" : "@@ -3864,42 +3884,55 @@ void UnloadBlockIndex()\n bool LoadBlockIndex(const CChainParams& chainparams)\n {\n     // Load block index from databases\n-    if (!fReindex && !LoadBlockIndexDB(chainparams))\n-        return false;\n+    bool needs_init = fReindex;\n+    if (!fReindex) {\n+        bool ret = LoadBlockIndexDB(chainparams);\n+        if (!ret) return false;\n+        needs_init = mapBlockIndex.empty();\n+    }\n+\n+    if (needs_init) {\n+        // Everything here is for *new* reindex/DBs. Thus, though\n+        // LoadBlockIndexDB may have set fReindex if we shut down\n+        // mid-reindex previously, we don't check fReindex and\n+        // instead only check it prior to LoadBlockIndexDB to set\n+        // needs_init.\n+\n+        LogPrintf(\"Initializing databases...\\n\");\n+        // Use the provided setting for -txindex in the new database\n+        fTxIndex = GetBoolArg(\"-txindex\", DEFAULT_TXINDEX);\n+        pblocktree->WriteFlag(\"txindex\", fTxIndex);\n+    }\n     return true;\n }\n \n-bool InitBlockIndex(const CChainParams& chainparams)\n+bool LoadGenesisBlock(const CChainParams& chainparams)\n {\n     LOCK(cs_main);\n \n-    // Check whether we're already initialized\n-    if (chainActive.Genesis() != NULL)\n+    // Check whether we're already initialized by checking for genesis in\n+    // mapBlockIndex. Note that we can't use chainActive here, since it is\n+    // set based on the coins db, not the block index db, which is the only\n+    // thing loaded at this point.\n+    if (mapBlockIndex.count(chainparams.GenesisBlock().GetHash()))\n         return true;\n \n-    // Use the provided setting for -txindex in the new database\n-    fTxIndex = GetBoolArg(\"-txindex\", DEFAULT_TXINDEX);\n-    pblocktree->WriteFlag(\"txindex\", fTxIndex);\n-    LogPrintf(\"Initializing databases...\\n\");\n-\n     // Only add the genesis block if not reindexing (in which case we reuse the one already on disk)\n-    if (!fReindex) {\n-        try {\n-            CBlock &block = const_cast<CBlock&>(chainparams.GenesisBlock());\n-            // Start new block file\n-            unsigned int nBlockSize = ::GetSerializeSize(block, SER_DISK, CLIENT_VERSION);\n-            CDiskBlockPos blockPos;\n-            CValidationState state;\n-            if (!FindBlockPos(state, blockPos, nBlockSize+8, 0, block.GetBlockTime()))\n-                return error(\"LoadBlockIndex(): FindBlockPos failed\");\n-            if (!WriteBlockToDisk(block, blockPos, chainparams.MessageStart()))\n-                return error(\"LoadBlockIndex(): writing genesis block to disk failed\");\n-            CBlockIndex *pindex = AddToBlockIndex(block);\n-            if (!ReceivedBlockTransactions(block, state, pindex, blockPos, chainparams.GetConsensus()))\n-                return error(\"LoadBlockIndex(): genesis block not accepted\");\n-        } catch (const std::runtime_error& e) {\n-            return error(\"LoadBlockIndex(): failed to initialize block database: %s\", e.what());\n-        }\n+    try {\n+        CBlock &block = const_cast<CBlock&>(chainparams.GenesisBlock());\n+        // Start new block file\n+        unsigned int nBlockSize = ::GetSerializeSize(block, SER_DISK, CLIENT_VERSION);\n+        CDiskBlockPos blockPos;\n+        CValidationState state;\n+        if (!FindBlockPos(state, blockPos, nBlockSize+8, 0, block.GetBlockTime()))\n+            return error(\"LoadBlockIndex(): FindBlockPos failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r129809348",
      "id" : 129809348,
      "original_commit_id" : "c93db429f909e75fbeacd2419fb8434350e3b674",
      "original_position" : 141,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 52619464,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758",
      "updated_at" : "2017-07-27T19:03:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/129809348",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "utACK apart from error message nits",
      "created_at" : "2017-07-27T11:19:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-318333958",
      "id" : 318333958,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-27T11:19:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/318333958",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Fixed error printings in LoadGenesisBlock.",
      "created_at" : "2017-07-27T19:03:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-318456619",
      "id" : 318456619,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-27T19:03:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/318456619",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "re-utACK c0025d0\r\n",
      "created_at" : "2017-07-28T02:38:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-318540606",
      "id" : 318540606,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-07-28T02:38:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/318540606",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/4360349?v=4",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r130388261"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/130388261"
         }
      },
      "body" : "The string on the next line ought to be changed to reflect the new function name.",
      "commit_id" : "c0025d0a92e438155901438580e4d2ebb376b951",
      "created_at" : "2017-07-31T15:38:01Z",
      "diff_hunk" : "@@ -72,7 +72,7 @@ TestingSetup::TestingSetup(const std::string& chainName) : BasicTestingSetup(cha\n         pblocktree = new CBlockTreeDB(1 << 20, true);\n         pcoinsdbview = new CCoinsViewDB(1 << 23, true);\n         pcoinsTip = new CCoinsViewCache(pcoinsdbview);\n-        if (!InitBlockIndex(chainparams)) {\n+        if (!LoadGenesisBlock(chainparams)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r130388261",
      "id" : 130388261,
      "original_commit_id" : "c0025d0a92e438155901438580e4d2ebb376b951",
      "original_position" : 5,
      "path" : "src/test/test_bitcoin.cpp",
      "position" : 5,
      "pull_request_review_id" : 53257598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758",
      "updated_at" : "2017-07-31T18:45:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/130388261",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r130407601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/130407601"
         }
      },
      "body" : "The comment at line 3900 now seems outdated; perhaps it makes more sense to move it to `init.cpp:1422`?",
      "commit_id" : "c0025d0a92e438155901438580e4d2ebb376b951",
      "created_at" : "2017-07-31T17:28:10Z",
      "diff_hunk" : "@@ -3864,42 +3864,55 @@ void UnloadBlockIndex()\n bool LoadBlockIndex(const CChainParams& chainparams)\n {\n     // Load block index from databases\n-    if (!fReindex && !LoadBlockIndexDB(chainparams))\n-        return false;\n+    bool needs_init = fReindex;\n+    if (!fReindex) {\n+        bool ret = LoadBlockIndexDB(chainparams);\n+        if (!ret) return false;\n+        needs_init = mapBlockIndex.empty();\n+    }\n+\n+    if (needs_init) {\n+        // Everything here is for *new* reindex/DBs. Thus, though\n+        // LoadBlockIndexDB may have set fReindex if we shut down\n+        // mid-reindex previously, we don't check fReindex and\n+        // instead only check it prior to LoadBlockIndexDB to set\n+        // needs_init.\n+\n+        LogPrintf(\"Initializing databases...\\n\");\n+        // Use the provided setting for -txindex in the new database\n+        fTxIndex = GetBoolArg(\"-txindex\", DEFAULT_TXINDEX);\n+        pblocktree->WriteFlag(\"txindex\", fTxIndex);\n+    }\n     return true;\n }\n \n-bool InitBlockIndex(const CChainParams& chainparams)\n+bool LoadGenesisBlock(const CChainParams& chainparams)\n {\n     LOCK(cs_main);\n \n-    // Check whether we're already initialized\n-    if (chainActive.Genesis() != NULL)\n+    // Check whether we're already initialized by checking for genesis in\n+    // mapBlockIndex. Note that we can't use chainActive here, since it is\n+    // set based on the coins db, not the block index db, which is the only\n+    // thing loaded at this point.\n+    if (mapBlockIndex.count(chainparams.GenesisBlock().GetHash()))\n         return true;\n \n-    // Use the provided setting for -txindex in the new database\n-    fTxIndex = GetBoolArg(\"-txindex\", DEFAULT_TXINDEX);\n-    pblocktree->WriteFlag(\"txindex\", fTxIndex);\n-    LogPrintf(\"Initializing databases...\\n\");\n-\n     // Only add the genesis block if not reindexing (in which case we reuse the one already on disk)\n-    if (!fReindex) {\n-        try {\n-            CBlock &block = const_cast<CBlock&>(chainparams.GenesisBlock());\n-            // Start new block file\n-            unsigned int nBlockSize = ::GetSerializeSize(block, SER_DISK, CLIENT_VERSION);\n-            CDiskBlockPos blockPos;\n-            CValidationState state;\n-            if (!FindBlockPos(state, blockPos, nBlockSize+8, 0, block.GetBlockTime()))\n-                return error(\"LoadBlockIndex(): FindBlockPos failed\");\n-            if (!WriteBlockToDisk(block, blockPos, chainparams.MessageStart()))\n-                return error(\"LoadBlockIndex(): writing genesis block to disk failed\");\n-            CBlockIndex *pindex = AddToBlockIndex(block);\n-            if (!ReceivedBlockTransactions(block, state, pindex, blockPos, chainparams.GetConsensus()))\n-                return error(\"LoadBlockIndex(): genesis block not accepted\");\n-        } catch (const std::runtime_error& e) {\n-            return error(\"LoadBlockIndex(): failed to initialize block database: %s\", e.what());\n-        }\n+    try {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r130407601",
      "id" : 130407601,
      "original_commit_id" : "eda888e57352037ab2e60f6ef90098b3ce23a157",
      "original_position" : 65,
      "path" : "src/validation.cpp",
      "position" : 134,
      "pull_request_review_id" : 53257598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758",
      "updated_at" : "2017-07-31T18:45:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/130407601",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r130410374"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/130410374"
         }
      },
      "body" : "style nit: curly braces for this `if`",
      "commit_id" : "c0025d0a92e438155901438580e4d2ebb376b951",
      "created_at" : "2017-07-31T17:39:50Z",
      "diff_hunk" : "@@ -3864,42 +3864,55 @@ void UnloadBlockIndex()\n bool LoadBlockIndex(const CChainParams& chainparams)\n {\n     // Load block index from databases\n-    if (!fReindex && !LoadBlockIndexDB(chainparams))\n-        return false;\n+    bool needs_init = fReindex;\n+    if (!fReindex) {\n+        bool ret = LoadBlockIndexDB(chainparams);\n+        if (!ret) return false;\n+        needs_init = mapBlockIndex.empty();\n+    }\n+\n+    if (needs_init) {\n+        // Everything here is for *new* reindex/DBs. Thus, though\n+        // LoadBlockIndexDB may have set fReindex if we shut down\n+        // mid-reindex previously, we don't check fReindex and\n+        // instead only check it prior to LoadBlockIndexDB to set\n+        // needs_init.\n+\n+        LogPrintf(\"Initializing databases...\\n\");\n+        // Use the provided setting for -txindex in the new database\n+        fTxIndex = GetBoolArg(\"-txindex\", DEFAULT_TXINDEX);\n+        pblocktree->WriteFlag(\"txindex\", fTxIndex);\n+    }\n     return true;\n }\n \n-bool InitBlockIndex(const CChainParams& chainparams)\n+bool LoadGenesisBlock(const CChainParams& chainparams)\n {\n     LOCK(cs_main);\n \n-    // Check whether we're already initialized\n-    if (chainActive.Genesis() != NULL)\n+    // Check whether we're already initialized by checking for genesis in\n+    // mapBlockIndex. Note that we can't use chainActive here, since it is\n+    // set based on the coins db, not the block index db, which is the only\n+    // thing loaded at this point.\n+    if (mapBlockIndex.count(chainparams.GenesisBlock().GetHash()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r130410374",
      "id" : 130410374,
      "original_commit_id" : "eda888e57352037ab2e60f6ef90098b3ce23a157",
      "original_position" : 39,
      "path" : "src/validation.cpp",
      "position" : 108,
      "pull_request_review_id" : 53257598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758",
      "updated_at" : "2017-07-31T18:45:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/130410374",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r130417278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/130417278"
         }
      },
      "body" : "style nit: perhaps add the curly braces here, while you're at it",
      "commit_id" : "c0025d0a92e438155901438580e4d2ebb376b951",
      "created_at" : "2017-07-31T18:04:50Z",
      "diff_hunk" : "@@ -3538,14 +3538,24 @@ bool static LoadBlockIndexDB(const CChainParams& chainparams)\n     return true;\n }\n \n-void LoadChainTip(const CChainParams& chainparams)\n+bool LoadChainTip(const CChainParams& chainparams)\n {\n-    if (chainActive.Tip() && chainActive.Tip()->GetBlockHash() == pcoinsTip->GetBestBlock()) return;\n+    if (chainActive.Tip() && chainActive.Tip()->GetBlockHash() == pcoinsTip->GetBestBlock()) return true;\n+\n+    if (pcoinsTip->GetBestBlock().IsNull() && mapBlockIndex.size() == 1) {\n+        // In case we just added the genesis block, connect it now, so\n+        // that we always have a chainActive.Tip() when we return.\n+        LogPrintf(\"%s: Connecting genesis block...\\n\", __func__);\n+        CValidationState state;\n+        if (!ActivateBestChain(state, chainparams)) {\n+            return false;\n+        }\n+    }\n \n     // Load pointer to end of best chain\n     BlockMap::iterator it = mapBlockIndex.find(pcoinsTip->GetBestBlock());\n     if (it == mapBlockIndex.end())\n-        return;\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r130417278",
      "id" : 130417278,
      "original_commit_id" : "b0f32497b873cd1eaf0be86f8e265355aa86174f",
      "original_position" : 24,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 53257598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758",
      "updated_at" : "2017-07-31T18:45:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/130417278",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r130423113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/130423113"
         }
      },
      "body" : "\"in the reindex completes\" -> \"after the reindex completes\"?",
      "commit_id" : "c0025d0a92e438155901438580e4d2ebb376b951",
      "created_at" : "2017-07-31T18:25:25Z",
      "diff_hunk" : "@@ -1437,10 +1427,34 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n                     break;\n                 }\n \n+                // At this point blocktree args are consistent with what's on disk.\n+                // If we're not mid-reindex (based on disk + args), add a genesis block on disk.\n+                // This is called again in ThreadImport in the reindex completes.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#discussion_r130423113",
      "id" : 130423113,
      "original_commit_id" : "138569722cae09bb9e3bc31bbae4b1886b904bb5",
      "original_position" : 47,
      "path" : "src/init.cpp",
      "position" : 67,
      "pull_request_review_id" : 53257598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10758",
      "updated_at" : "2017-07-31T18:45:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/130423113",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "I'm going to merge this now - sorry @sdaftuar, we should fix your minor nits later, but we have to make some progress with merging for 0.15",
      "created_at" : "2017-08-01T10:50:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-319337111",
      "id" : 319337111,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-08-01T10:50:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/319337111",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj Agreed, I don't think those nits should have held this up.",
      "created_at" : "2017-08-01T17:22:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10758#issuecomment-319438265",
      "id" : 319438265,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10758",
      "updated_at" : "2017-08-01T17:22:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/319438265",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   }
]
