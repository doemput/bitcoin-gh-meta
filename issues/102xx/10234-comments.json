[
   {
      "body" : "Nice find. Though I can't think of a good reason why we'd ever want a stale list coming out of GetBanned(). Why not just sweep there?",
      "created_at" : "2017-04-19T17:07:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10234#issuecomment-295348002",
      "id" : 295348002,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10234",
      "updated_at" : "2017-04-19T17:07:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/295348002",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "utACK ea2c925c99969d06320495afbf1188f54e25e015\r\nCalling sweep from within `GetBanned()` looks simpler in the first place but would break the assumption that `GetBanned()` can never change the `setBannedIsDirty` to `true`.\r\nNo strong opinion though.",
      "created_at" : "2017-04-19T17:12:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10234#issuecomment-295350315",
      "id" : 295350315,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10234",
      "updated_at" : "2017-04-19T17:12:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/295350315",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "> Calling sweep from within GetBanned() looks simpler in the first place but would break the assumption that GetBanned() can never change the setBannedIsDirty to true.\r\n\r\nRight. `CConnman::DumpBanlist()` sets `SetBannedSetDirty` and then calls `GetBanned()` (I believe making the assumption that `GetBanned()` wouldn't change `SetBannedSetDirty`). I didn't know whether it was safe to change that.\r\n\r\nIf you think that's ok, then calling sweep from with `GetBanned()` is obviously tidier, and means I don't need to make SweepBanned() public.",
      "created_at" : "2017-04-19T17:25:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10234#issuecomment-295354958",
      "id" : 295354958,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10234",
      "updated_at" : "2017-04-19T17:25:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/295354958",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "Needs rebase",
      "created_at" : "2017-04-23T15:22:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10234#issuecomment-296450687",
      "id" : 296450687,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10234",
      "updated_at" : "2017-04-23T15:22:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/296450687",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "body" : "Discussion on IRC: the `disconnect_ban.py` test is slow until this is merged, due to  https://github.com/bitcoin/bitcoin/blob/master/test/functional/disconnect_ban.py#L67",
      "created_at" : "2017-04-25T13:49:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10234#issuecomment-297036031",
      "id" : 297036031,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10234",
      "updated_at" : "2017-04-25T13:49:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/297036031",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "rebased with fix to disconnect_ban.py test suite.",
      "created_at" : "2017-04-25T14:12:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10234#issuecomment-297042925",
      "id" : 297042925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10234",
      "updated_at" : "2017-04-25T14:12:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/297042925",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "@jnewbery Yea, I'd prefer to see this moved to GetBanned(). Otherwise correct usage just isn't obvious enough (as evidenced by this bug).\r\n\r\nIdeally the sweep would be a static function operating on a banlist_t rather than this, but I don't think it's worth worrying about.\r\n\r\nLooks like the only other change needed would be:\r\n```c++\r\n@@ -496,10 +499,9 @@ void CConnman::DumpBanlist()\r\n \r\n     CBanDB bandb;\r\n     banmap_t banmap;\r\n-    SetBannedSetDirty(false);\r\n     GetBanned(banmap);\r\n-    if (!bandb.Write(banmap))\r\n-        SetBannedSetDirty(true);\r\n+    if (bandb.Write(banmap))\r\n+        SetBannedSetDirty(false);\r\n```\r\n\r\nNote that this code is pretty racy either way. We should fix that as a follow-up.",
      "created_at" : "2017-04-25T14:48:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10234#issuecomment-297054613",
      "id" : 297054613,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10234",
      "updated_at" : "2017-04-25T14:48:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/297054613",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "thanks @theuni - that's definitely cleaner. I've changed this PR to use your fix.",
      "created_at" : "2017-04-28T15:25:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10234#issuecomment-298028602",
      "id" : 298028602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10234",
      "updated_at" : "2017-04-28T15:25:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/298028602",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "It fails locally here (every time, not just intermittently):\r\n```\r\ndisconnect_ban.py failed, Duration: 26 s\r\n\r\nstdout:\r\n2017-05-01 08:21:38.048000 TestFramework (INFO): Initializing test directory /tmp/testh_zvdgd7/435\r\n2017-05-01 08:21:39.087000 TestFramework (INFO): Test setban and listbanned RPCs\r\n2017-05-01 08:21:39.087000 TestFramework (INFO): setban: successfully ban single IP address\r\n2017-05-01 08:21:39.148000 TestFramework (INFO): clearbanned: successfully clear ban list\r\n2017-05-01 08:21:39.179000 TestFramework (INFO): setban: fail to ban an already banned subnet\r\n2017-05-01 08:21:39.184000 TestFramework (INFO): setban: fail to ban an invalid subnet\r\n2017-05-01 08:21:39.189000 TestFramework (INFO): setban remove: fail to unban a non-banned subnet\r\n2017-05-01 08:21:39.194000 TestFramework (INFO): setban remove: successfully unban subnet\r\n2017-05-01 08:21:39.243000 TestFramework (INFO): setban: test persistence across node restart\r\n2017-05-01 08:21:49.801000 TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/store/orion/projects/bitcoin/bitcoin/test/functional/test_framework/test_framework.py\", line 151, in main\r\n    self.run_test()\r\n  File \"/home/orion/projects/bitcoin/bitcoin/test/functional/disconnect_ban.py\", line 67, in run_test\r\n    assert wait_until(lambda: len(self.nodes[1].listbanned()) == 3, timeout=10)\r\nAssertionError\r\n2017-05-01 08:21:49.819000 TestFramework (INFO): Stopping nodes\r\n2017-05-01 08:22:04.002000 TestFramework (WARNING): Not cleaning up dir /tmp/testh_zvdgd7/435\r\n2017-05-01 08:22:04.003000 TestFramework (ERROR): Test failed. Test logging available at /tmp/testh_zvdgd7/435/test_\r\nframework.log\r\n```",
      "created_at" : "2017-05-01T10:28:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10234#issuecomment-298316271",
      "id" : 298316271,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10234",
      "updated_at" : "2017-05-01T10:29:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/298316271",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj that's very strange. The test passes for me consistently, and also passes on travis. Can you try rebuilding and clearing the functional test cache. If it's still failing, can you send me the test logs?",
      "created_at" : "2017-05-01T17:48:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10234#issuecomment-298385556",
      "id" : 298385556,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10234",
      "updated_at" : "2017-05-01T17:48:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/298385556",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "Seems to work now. Strange.",
      "created_at" : "2017-05-02T16:35:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10234#issuecomment-298689531",
      "id" : 298689531,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10234",
      "updated_at" : "2017-05-02T16:35:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/298689531",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
