[
   {
      "body" : "I know there was discussion about this in IRC last week, but I didn't follow closely. Would it be better to review this PR now, or hold off for more changes?",
      "created_at" : "2017-05-01T18:46:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#issuecomment-298399758",
      "id" : 298399758,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10240",
      "updated_at" : "2017-05-01T18:46:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/298399758",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "body" : "I'm currently implementing the changes we discussed in last weeks RIC meeting. A review makes more sense after the overhaul.",
      "created_at" : "2017-05-02T13:08:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#issuecomment-298630235",
      "id" : 298630235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10240",
      "updated_at" : "2017-05-02T13:08:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/298630235",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Completely rewrote this PR. Keeping the WIP tag for now.\r\nThe current implementation takes care of encrypted and unencrypted wallets (also in conjunction with pruning).\r\n\r\n### unencrypted wallets\r\nFor unencrypted wallets, the key pool will always be topped up. During sync (SyncTransaction), we check for used keypool keys and mark all keys up to the matched key as used. Additionally we topup the keypool to ensure we not fall below the gap limit (20 keys).\r\n\r\n### encrypted wallets in non pruning mode\r\nSame as above, but, If we hit the gap limit with an encrypted wallet, we can't topup the keypool. In that case, we just pause the sync (not the node, only the wallet).\r\nOnce the user unlocks the wallet over `walletpassphrase`, we rescan down to the point where we have stopped previously to ensure we don't miss possible funds.\r\n\r\n### encrypted wallets in pruned mode\r\nSame as above, but, we also stop requesting and connecting blocks. The full node will \"pause\" in this case until the user did unlock his wallet (== topup, rescan, etc.).\r\n\r\nThis has a little bit of complexity and requires careful reviews.\r\nThanks for early feedback.\r\n",
      "created_at" : "2017-05-03T15:37:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#issuecomment-298949058",
      "id" : 298949058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10240",
      "updated_at" : "2017-05-03T15:37:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/298949058",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "All tests are passing now.\r\nRemoved WIP tag.\r\nOverhauled PR description",
      "created_at" : "2017-05-04T15:48:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#issuecomment-299226759",
      "id" : 299226759,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10240",
      "updated_at" : "2017-05-04T15:48:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/299226759",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r114818486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114818486"
         }
      },
      "body" : "I guess this is very inefficient and something like #10235 should allow to speed up things.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-04T15:53:27Z",
      "diff_hunk" : "@@ -970,6 +1004,22 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockI\n         if (fExisted && !fUpdate) return false;\n         if (fExisted || IsMine(tx) || IsFromMe(tx))\n         {\n+            // check if we need to flag used keypool keys\n+            std::set<CKeyID> setKeyPool;\n+            GetAllReserveKeys(setKeyPool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r114818486",
      "id" : 114818486,
      "original_commit_id" : "cada7263fa95dff17ec2bab3b3b081cfdec2ae8e",
      "original_position" : 61,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36310520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114818486",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115032554"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115032554"
         }
      },
      "body" : "In commit \"Add basic HD wallet restore functionality\"\r\n\r\nMaybe rename this variable. (It shadows CWallet::setKeyPool, which makes that variable more annoying to grep for.)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T16:03:34Z",
      "diff_hunk" : "@@ -970,6 +1004,22 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockI\n         if (fExisted && !fUpdate) return false;\n         if (fExisted || IsMine(tx) || IsFromMe(tx))\n         {\n+            // check if we need to flag used keypool keys\n+            std::set<CKeyID> setKeyPool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115032554",
      "id" : 115032554,
      "original_commit_id" : "11cccadf1308976cd61de0a7286f2902e6d32426",
      "original_position" : 60,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T16:48:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115032554",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115037977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115037977"
         }
      },
      "body" : "In commit \"Add basic HD wallet restore functionality\"\r\n\r\nMaybe avoid BOOST_FOREACH here and below.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T16:32:30Z",
      "diff_hunk" : "@@ -970,6 +1004,22 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockI\n         if (fExisted && !fUpdate) return false;\n         if (fExisted || IsMine(tx) || IsFromMe(tx))\n         {\n+            // check if we need to flag used keypool keys\n+            std::set<CKeyID> setKeyPool;\n+            GetAllReserveKeys(setKeyPool);\n+            // loop though all outputs\n+            BOOST_FOREACH(const CTxOut& txout, tx.vout) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115037977",
      "id" : 115037977,
      "original_commit_id" : "11cccadf1308976cd61de0a7286f2902e6d32426",
      "original_position" : 63,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T16:49:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115037977",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115042948"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115042948"
         }
      },
      "body" : "In commit \"Add basic HD wallet restore functionality\"\r\n\r\nIt seems like this for-loop could be eliminated if you just changed GetAllReserveKeys to return `map<CKeyID, int64_t>` instead of `set<CKeyID>`. I think making this change would add less code than is written here.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T16:59:29Z",
      "diff_hunk" : "@@ -3349,14 +3365,62 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n+{\n+    LOCK(cs_wallet);\n+    CWalletDB walletdb(*dbw);\n+    auto it = std::begin(setKeyPool);\n+\n+    bool foundInternal = false;\n+    int64_t foundIndex = -1;\n+    for (const int64_t& id : setKeyPool) {\n+        CKeyPool keypool;\n+        if (!walletdb.ReadPool(id, keypool))\n+            throw std::runtime_error(std::string(__func__) + \": read failed\");\n+\n+        if (keypool.vchPubKey.GetID() == keyId) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115042948",
      "id" : 115042948,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 40,
      "path" : "src/wallet/wallet.cpp",
      "position" : 253,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T16:51:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115042948",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115043447"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115043447"
         }
      },
      "body" : "In commit \"Add basic HD wallet restore functionality\"\r\n\r\nShould move this declaration closer to where it's actually used way below.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T17:01:52Z",
      "diff_hunk" : "@@ -3349,14 +3365,62 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n+{\n+    LOCK(cs_wallet);\n+    CWalletDB walletdb(*dbw);\n+    auto it = std::begin(setKeyPool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115043447",
      "id" : 115043447,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 31,
      "path" : "src/wallet/wallet.cpp",
      "position" : 244,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T16:51:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115043447",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115044224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115044224"
         }
      },
      "body" : "In commit \"Add basic HD wallet restore functionality\"\r\n\r\nShouldn't it be an error if this condition is not true?",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T17:05:46Z",
      "diff_hunk" : "@@ -3349,14 +3365,62 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n+{\n+    LOCK(cs_wallet);\n+    CWalletDB walletdb(*dbw);\n+    auto it = std::begin(setKeyPool);\n+\n+    bool foundInternal = false;\n+    int64_t foundIndex = -1;\n+    for (const int64_t& id : setKeyPool) {\n+        CKeyPool keypool;\n+        if (!walletdb.ReadPool(id, keypool))\n+            throw std::runtime_error(std::string(__func__) + \": read failed\");\n+\n+        if (keypool.vchPubKey.GetID() == keyId) {\n+            foundInternal = keypool.fInternal;\n+            foundIndex = id;\n+            if (!keypool.fInternal) {\n+                SetAddressBook(keyId, \"\", \"receive\");\n+            }\n+            break;\n+        }\n+    }\n+\n+    // mark all keys up to the found key as used\n+    if (foundIndex >= 0) {\n+        while (it != std::end(setKeyPool)) {\n+            const int64_t& id = *(it);\n+            if (id <= foundIndex) {\n+                CKeyPool keypool;\n+                if (!walletdb.ReadPool(id, keypool))\n+                    throw std::runtime_error(std::string(__func__) + \": read failed\");\n+\n+                // only mark keys on the corresponding chain\n+                if (keypool.fInternal == foundInternal) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115044224",
      "id" : 115044224,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 60,
      "path" : "src/wallet/wallet.cpp",
      "position" : 273,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T16:49:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115044224",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115044903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115044903"
         }
      },
      "body" : "In commit \"Add basic HD wallet restore functionality\"\r\n\r\nAs an simplification (and optimization), you can exit the loop if `id > foundIndex`, since `setKeyPool` is an ordered set.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T17:09:25Z",
      "diff_hunk" : "@@ -3349,14 +3365,62 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n+{\n+    LOCK(cs_wallet);\n+    CWalletDB walletdb(*dbw);\n+    auto it = std::begin(setKeyPool);\n+\n+    bool foundInternal = false;\n+    int64_t foundIndex = -1;\n+    for (const int64_t& id : setKeyPool) {\n+        CKeyPool keypool;\n+        if (!walletdb.ReadPool(id, keypool))\n+            throw std::runtime_error(std::string(__func__) + \": read failed\");\n+\n+        if (keypool.vchPubKey.GetID() == keyId) {\n+            foundInternal = keypool.fInternal;\n+            foundIndex = id;\n+            if (!keypool.fInternal) {\n+                SetAddressBook(keyId, \"\", \"receive\");\n+            }\n+            break;\n+        }\n+    }\n+\n+    // mark all keys up to the found key as used\n+    if (foundIndex >= 0) {\n+        while (it != std::end(setKeyPool)) {\n+            const int64_t& id = *(it);\n+            if (id <= foundIndex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115044903",
      "id" : 115044903,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 54,
      "path" : "src/wallet/wallet.cpp",
      "position" : 267,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T16:50:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115044903",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115049299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115049299"
         }
      },
      "body" : "In commit \"Add basic HD wallet restore functionality\"\r\n\r\nPhrase \"In case you recover a HD wallet\" seems too vague to be meaningful. I might say something more detailed like, \"In the case where you just restored an old wallet.dat backup that was not topped-up with the most recently derived HD keys, transactions using those keys will not show up in the wallet, and funds that are available to spend may not appear. You can avoid this problem by either manually topping up your wallet keypool, or (less reliably) just leaving your wallet decrypted while it scans for relevant transactions.\"",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T17:32:11Z",
      "diff_hunk" : "@@ -3725,6 +3789,19 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n \n     RegisterValidationInterface(walletInstance);\n \n+    // HD Restore: Make sure we always have a reasonable keypool size if HD is enabled\n+    if (walletInstance->IsHDEnabled()) {\n+        if (walletInstance->IsCrypted()) {\n+            InitWarning(_(\"Your are using an encrypted HD wallet. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115049299",
      "id" : 115049299,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 94,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-17T15:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115049299",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115052129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115052129"
         }
      },
      "body" : "In commit \"Add basic HD wallet restore functionality\"\r\n\r\nSince this is warning that the requested size is below the recommended limit, it would be good to mention what the recommended limit actually is. And again \"recover a HD wallet\" seems vague. I'd maybe write this as, \"Your keypool configured to store less than 20 keys. The recommended size is -keypool=100. Using a larger keypool will make it less likely that your wallet will be missing transactions and funds if it is restored from an old backup.\" (Substituting HD_RESTORE_KEYPOOL_SIZE_MIN and DEFAULT_KEYPOOL_SIZE for the 20 and 100 values.)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T17:46:36Z",
      "diff_hunk" : "@@ -3725,6 +3789,19 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n \n     RegisterValidationInterface(walletInstance);\n \n+    // HD Restore: Make sure we always have a reasonable keypool size if HD is enabled\n+    if (walletInstance->IsHDEnabled()) {\n+        if (walletInstance->IsCrypted()) {\n+            InitWarning(_(\"Your are using an encrypted HD wallet. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));\n+        }\n+        else {\n+            if (GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE) < HD_RESTORE_KEYPOOL_SIZE_MIN ) {\n+                InitWarning(_(\"Your keypool size is below the recommended limit for HD rescans. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115052129",
      "id" : 115052129,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 98,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-17T15:55:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115052129",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115055571"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115055571"
         }
      },
      "body" : "In commit \"Add basic HD wallet restore functionality\"\r\n\r\nWould expand this comment. Maybe \"Check if any keys in the wallet keypool that were supposed to be unused have appeared in a new transaction. If so, remove those keys from the keypool. This can happen when restoring an old wallet backup that does not contain the mostly recently created transactions from newer versions of the wallet.\"",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T18:03:36Z",
      "diff_hunk" : "@@ -1002,6 +1002,22 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockI\n         if (fExisted && !fUpdate) return false;\n         if (fExisted || IsMine(tx) || IsFromMe(tx))\n         {\n+            // check if we need to flag used keypool keys",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115055571",
      "id" : 115055571,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 4,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T16:46:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115055571",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115060607"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115060607"
         }
      },
      "body" : "In commit \"Add request-halt flag to BlockConnected signal\".\r\n\r\nCompile error here (line needs to be moved up)\r\n\r\n",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T18:28:33Z",
      "diff_hunk" : "@@ -1182,6 +1181,7 @@ void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const\n     }\n     for (size_t i = 0; i < pblock->vtx.size(); i++) {\n         SyncTransaction(pblock->vtx[i], pindex, i);\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted, bool &requestPause) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115060607",
      "id" : 115060607,
      "original_commit_id" : "5e672d36d922a780de86bc0ca64e220d758ab14c",
      "original_position" : 12,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115060607",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115061522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115061522"
         }
      },
      "body" : "In commit \"Wallet: allow to eventually pause verification if keypool requires\"\r\n\r\nNo need to add the {} and extra indentation here in TransactionAddedToMempool. (It throws off the github diff and makes the other changes harder to follow).",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T18:33:21Z",
      "diff_hunk" : "@@ -1163,33 +1164,51 @@ void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pin\n }\n \n void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n-    LOCK2(cs_main, cs_wallet);\n-    SyncTransaction(ptx);\n-}\n+    if (fSyncPausedUntilKeypoolExt) return;\n \n-    LOCK2(cs_main, cs_wallet);\n-    // TODO: Temporarily ensure that mempool removals are notified before\n-    // connected transactions.  This shouldn't matter, but the abandoned\n-    // state of transactions in our wallet is currently cleared when we\n-    // receive another notification and there is a race condition where\n-    // notification of a connected conflict might cause an outside process\n-    // to abandon a transaction and then have it inadvertently cleared by\n-    // the notification that the conflicted transaction was evicted.\n-\n-    for (const CTransactionRef& ptx : vtxConflicted) {\n+    {\n+        LOCK2(cs_main, cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115061522",
      "id" : 115061522,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 28,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115061522",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115061963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115061963"
         }
      },
      "body" : "In commit \"Wallet: allow to eventually pause verification if keypool requires\"\r\n\r\nAgain unnecessary {} and indentation make the diff messy here in BlockDisconnected",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T18:35:26Z",
      "diff_hunk" : "@@ -1163,33 +1164,51 @@ void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pin\n }\n \n void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n-    LOCK2(cs_main, cs_wallet);\n-    SyncTransaction(ptx);\n-}\n+    if (fSyncPausedUntilKeypoolExt) return;\n \n-    LOCK2(cs_main, cs_wallet);\n-    // TODO: Temporarily ensure that mempool removals are notified before\n-    // connected transactions.  This shouldn't matter, but the abandoned\n-    // state of transactions in our wallet is currently cleared when we\n-    // receive another notification and there is a race condition where\n-    // notification of a connected conflict might cause an outside process\n-    // to abandon a transaction and then have it inadvertently cleared by\n-    // the notification that the conflicted transaction was evicted.\n-\n-    for (const CTransactionRef& ptx : vtxConflicted) {\n+    {\n+        LOCK2(cs_main, cs_wallet);\n         SyncTransaction(ptx);\n     }\n-    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n-        SyncTransaction(pblock->vtx[i], pindex, i);\n+}\n+\n void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted, bool &requestPause) {\n+    if (fSyncPausedUntilKeypoolExt) {\n+        requestPause = true;\n+        return;\n+    }\n+\n+    {\n+        LOCK2(cs_main, cs_wallet);\n+        // TODO: Temporarily ensure that mempool removals are notified before\n+        // connected transactions.  This shouldn't matter, but the abandoned\n+        // state of transactions in our wallet is currently cleared when we\n+        // receive another notification and there is a race condition where\n+        // notification of a connected conflict might cause an outside process\n+        // to abandon a transaction and then have it inadvertently cleared by\n+        // the notification that the conflicted transaction was evicted.\n+\n+        for (const CTransactionRef& ptx : vtxConflicted) {\n+            SyncTransaction(ptx);\n+        }\n+        for (size_t i = 0; i < pblock->vtx.size(); i++) {\n+            SyncTransaction(pblock->vtx[i], pindex, i);\n+        }\n+        if (fSyncPausedUntilKeypoolExt) {\n+            requestPause = true;\n+        }\n     }\n }\n \n void CWallet::BlockDisconnected(const std::shared_ptr<const CBlock>& pblock) {\n-    LOCK2(cs_main, cs_wallet);\n+    if (fSyncPausedUntilKeypoolExt) return;\n \n-    for (const CTransactionRef& ptx : pblock->vtx) {\n-        SyncTransaction(ptx);\n+    {\n+        LOCK2(cs_main, cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115061963",
      "id" : 115061963,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 70,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115061963",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115062815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115062815"
         }
      },
      "body" : "In commit \"Wallet: allow to eventually pause verification if keypool requires\"\r\n\r\nThese functions are never called anywhere, and appear to be deleted in the next commit. Would remove them from this commit.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T18:39:39Z",
      "diff_hunk" : "@@ -1106,6 +1108,9 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n        caller must ensure the current wallet version is correct before calling\n        this function). */\n     bool SetHDMasterKey(const CPubKey& key);\n+\n+    bool IsSyncPausedUntilKeypoolExt() { return fSyncPausedUntilKeypoolExt; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115062815",
      "id" : 115062815,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 21,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115062815",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115063131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115063131"
         }
      },
      "body" : "In commit \"Wallet: allow to eventually pause verification if keypool requires\"\r\n\r\nWould update the printf to say this is pausing downloads / transaction processing.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T18:41:29Z",
      "diff_hunk" : "@@ -3409,6 +3428,7 @@ void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n     }\n \n     if (IsHDEnabled() && !TopUpKeyPool()) {\n+        fSyncPausedUntilKeypoolExt = true;\n         LogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115063131",
      "id" : 115063131,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 83,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115063131",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115063363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115063363"
         }
      },
      "body" : "In commit \"Wallet: allow to eventually pause verification if keypool requires\"\r\n\r\nThis variable should be better documented. I think you could basically take the text from your PR description and paste it here.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T18:42:46Z",
      "diff_hunk" : "@@ -652,6 +652,7 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n     static std::atomic<bool> fFlushScheduled;\n     std::atomic<bool> fAbortRescan;\n     std::atomic<bool> fScanningWallet;\n+    std::atomic<bool> fSyncPausedUntilKeypoolExt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115063363",
      "id" : 115063363,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 4,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115063363",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115064943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115064943"
         }
      },
      "body" : "In commit \"Add request-halt flag to BlockConnected signal\".\r\n\r\nWhat's the advantage of requesting a pause in this delayed and indirect way via BlockConnected instead of immediately setting `setBlockRequestsPaused(true); setTipUpdatesPaused(true);` when the keypool fails to top up in `MarkReserveKeysAsUsed()`? The indirect approach seems to add a lot of complexity.\r\n\r\n\r\n",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T18:50:43Z",
      "diff_hunk" : "@@ -1163,33 +1164,51 @@ void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pin\n }\n \n void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n-    LOCK2(cs_main, cs_wallet);\n-    SyncTransaction(ptx);\n-}\n+    if (fSyncPausedUntilKeypoolExt) return;\n \n-    LOCK2(cs_main, cs_wallet);\n-    // TODO: Temporarily ensure that mempool removals are notified before\n-    // connected transactions.  This shouldn't matter, but the abandoned\n-    // state of transactions in our wallet is currently cleared when we\n-    // receive another notification and there is a race condition where\n-    // notification of a connected conflict might cause an outside process\n-    // to abandon a transaction and then have it inadvertently cleared by\n-    // the notification that the conflicted transaction was evicted.\n-\n-    for (const CTransactionRef& ptx : vtxConflicted) {\n+    {\n+        LOCK2(cs_main, cs_wallet);\n         SyncTransaction(ptx);\n     }\n-    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n-        SyncTransaction(pblock->vtx[i], pindex, i);\n+}\n+\n void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted, bool &requestPause) {\n+    if (fSyncPausedUntilKeypoolExt) {\n+        requestPause = true;\n+        return;\n+    }\n+\n+    {\n+        LOCK2(cs_main, cs_wallet);\n+        // TODO: Temporarily ensure that mempool removals are notified before\n+        // connected transactions.  This shouldn't matter, but the abandoned\n+        // state of transactions in our wallet is currently cleared when we\n+        // receive another notification and there is a race condition where\n+        // notification of a connected conflict might cause an outside process\n+        // to abandon a transaction and then have it inadvertently cleared by\n+        // the notification that the conflicted transaction was evicted.\n+\n+        for (const CTransactionRef& ptx : vtxConflicted) {\n+            SyncTransaction(ptx);\n+        }\n+        for (size_t i = 0; i < pblock->vtx.size(); i++) {\n+            SyncTransaction(pblock->vtx[i], pindex, i);\n+        }\n+        if (fSyncPausedUntilKeypoolExt) {\n+            requestPause = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115064943",
      "id" : 115064943,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 58,
      "path" : "src/wallet/wallet.cpp",
      "position" : 128,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115064943",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115065542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115065542"
         }
      },
      "body" : "In commit \"Ensure we pause wallet sync when the keypool requires extension\"\r\n\r\nThis diff logically seems like it should be part of the \"Add request-halt flag to BlockConnected signal\" commit. Moving it there would make the commit history easier to understand.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T18:54:04Z",
      "diff_hunk" : "@@ -2533,6 +2533,14 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n             for (const PerBlockConnectTrace& trace : connectTrace.GetBlocksConnected()) {\n                 assert(trace.pblock && trace.pindex);\n                 GetMainSignals().BlockConnected(trace.pblock, trace.pindex, *trace.conflictedTxs, requestPause);\n+                if (requestPause) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115065542",
      "id" : 115065542,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 4,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115065542",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115065830"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115065830"
         }
      },
      "body" : "In commit \"Ensure we pause wallet sync when the keypool requires extension\"\r\n\r\nConsider moving this change to the \"Add option to pause block requests\" commit.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T18:55:33Z",
      "diff_hunk" : "@@ -4316,6 +4324,7 @@ bool isBlockRequestsPaused() {\n }\n \n void setBlockRequestsPaused(bool state) {\n+    LogPrintf(\"%s Block Requests\\n\", (state ? \"Pause\" : \"Resume\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115065830",
      "id" : 115065830,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 19,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115065830",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115065922"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115065922"
         }
      },
      "body" : "In commit \"Ensure we pause wallet sync when the keypool requires extension\"\r\n\r\nConsider moving this change to the \"Add option to pause tip updates\" commit.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T18:55:57Z",
      "diff_hunk" : "@@ -4324,6 +4333,7 @@ bool isTipUpdatesPaused() {\n }\n \n void setTipUpdatesPaused(bool state) {\n+    LogPrintf(\"%s Tip Updates\\n\", (state ? \"Pause\" : \"Resume\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115065922",
      "id" : 115065922,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 27,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115065922",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115066863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115066863"
         }
      },
      "body" : "In commit \"Ensure we pause wallet sync when the keypool requires extension\"\r\n\r\nWould it make sense to call this automatically inside TopUpKeyPool? Seems strange to have to implement it separately for RPC and Qt wallet interfaces.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T19:01:33Z",
      "diff_hunk" : "@@ -2044,6 +2044,9 @@ UniValue walletpassphrase(const JSONRPCRequest& request)\n \n     pwallet->TopUpKeyPool();\n \n+    // give a hint to the wallet in case we have paused sync (we may have fall bellow the hd gap limit)\n+    pwallet->EventuallyRescanAfterKeypoolTopUp();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115066863",
      "id" : 115066863,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 5,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115066863",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115068537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115068537"
         }
      },
      "body" : "In commit \"Ensure we pause wallet sync when the keypool requires extension\"\r\n\r\nIt seems kind of abrupt and unfriendly that entering your passphrase to unlock the wallet could suddenly trigger a shutdown. Wouldn't it be better to detect this condition before unpausing, and if it happens, let the node stay up and paused instead of shutting it down?",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T19:11:11Z",
      "diff_hunk" : "@@ -1417,6 +1418,57 @@ bool CWallet::IsHDEnabled() const\n     return !hdChain.masterKeyID.IsNull();\n }\n \n+void CWallet::EventuallyRescanAfterKeypoolTopUp() {\n+    if (fSyncPausedUntilKeypoolExt) {\n+\n+        // for now, enable block requests and tip updates via the states\n+        // this will only be sufficient as long as only a single wallet adjusts these stats\n+        // otherwise the net-/validation-logic needs to poll the state over a signal (or similar)\n+        ::setBlockRequestsPaused(false);\n+        ::setTipUpdatesPaused(false);\n+\n+        // disabled the per-wallet pause\n+        fSyncPausedUntilKeypoolExt = false;\n+\n+        const CChainParams& chainparams = Params();\n+        CValidationState state;\n+        if (!ActivateBestChain(state, chainparams)) {\n+            LogPrintf(\"Failed to connect best block\");\n+            StartShutdown();\n+        }\n+\n+        CBlockIndex *pindexRescan = chainActive.Genesis();\n+        CWalletDB walletdb(*dbw);\n+        CBlockLocator locator;\n+        if (walletdb.ReadBestBlock(locator))\n+            pindexRescan = FindForkInGlobalIndex(chainActive, locator);\n+\n+        if (chainActive.Tip() && chainActive.Tip() != pindexRescan)\n+        {\n+            //We can't rescan beyond non-pruned blocks, stop and throw an error\n+            //this might happen if a user uses a old wallet within a pruned node\n+            // or if he ran -disablewallet for a longer time, then decided to re-enable\n+            if (fPruneMode)\n+            {\n+                CBlockIndex *block = chainActive.Tip();\n+                while (block && block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA) && block->pprev->nTx > 0 && pindexRescan != block)\n+                    block = block->pprev;\n+\n+                if (pindexRescan != block) {\n+                    const static std::string pruneError = \"Prune: last wallet synchronisation goes beyond pruned data. You need to -reindex (download the whole blockchain again in case of pruned node)\";\n+                    uiInterface.ThreadSafeMessageBox(pruneError, \"\", CClientUIInterface::MSG_ERROR);\n+                    StartShutdown();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115068537",
      "id" : 115068537,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 51,
      "path" : "src/wallet/wallet.cpp",
      "position" : 181,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115068537",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115069097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115069097"
         }
      },
      "body" : "In commit \"Extend wallet hd restore functional test\"\r\n\r\nAlready listed",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T19:14:32Z",
      "diff_hunk" : "@@ -54,6 +54,7 @@\n     # Longest test should go first, to favor running tests in parallel\n     'wallet-hd.py',\n     'wallet-hd-restore.py',\n+    'wallet-hd-restore.py',",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115069097",
      "id" : 115069097,
      "original_commit_id" : "ec5bf977339e30df1192a6bbdc259bcf5f702c45",
      "original_position" : 4,
      "path" : "test/functional/test_runner.py",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115069097",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115071463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115071463"
         }
      },
      "body" : "In commit \"Make sure we check the keypool min size during startup\"\r\n\r\nWarning should suggest how to fix the problem, and also ideally also include more background information (maybe consider using my previous suggestion for the -keypool limit warning).",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T19:28:30Z",
      "diff_hunk" : "@@ -3881,12 +3888,11 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n             InitWarning(_(\"Your are using an encrypted HD wallet. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));\n         }\n         else {\n-            if (GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE) < HD_RESTORE_KEYPOOL_SIZE_MIN ) {\n-                InitWarning(_(\"Your keypool size is below the recommended limit for HD rescans. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));\n-            }\n             walletInstance->TopUpKeyPool();\n         }\n-\n+        if (!walletInstance->CheckKeypoolMinSize()) {\n+            InitWarning(_(\"Your keypool size is below the required limit for HD rescans. Wallet synchronisation is now paused until you have refilled the keypool.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115071463",
      "id" : 115071463,
      "original_commit_id" : "f6f09a8eb24c583eac8dd6abd04e97ba0dee0637",
      "original_position" : 53,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115071463",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115073522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115073522"
         }
      },
      "body" : "In commit \"Make sure we check the keypool min size during startup\"\r\n\r\nThis pausing behavior seems like it should be optional, because even in the worst case, you should be able to recover from any problem by topping up your keypool and doing a rescan. Maybe `HD_RESTORE_KEYPOOL_SIZE_MIN` should be renamed something like `PAUSE_SYNC_WHEN_KEYPOOL_SMALLER_THAN` and be a config option.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T19:41:06Z",
      "diff_hunk" : "@@ -3442,6 +3443,18 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+bool CWallet::CheckKeypoolMinSize() {\n+    LOCK(cs_wallet);\n+    size_t extKeypoolSize = KeypoolCountExternalKeys();\n+    if (IsHDEnabled() && (extKeypoolSize < HD_RESTORE_KEYPOOL_SIZE_MIN || (setKeyPool.size()-extKeypoolSize) < HD_RESTORE_KEYPOOL_SIZE_MIN)) {\n+        // if the remaining keypool size is below the gap limit, refuse to continue with the sync\n+        fSyncPausedUntilKeypoolExt = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115073522",
      "id" : 115073522,
      "original_commit_id" : "f6f09a8eb24c583eac8dd6abd04e97ba0dee0637",
      "original_position" : 17,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115073522",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115074802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115074802"
         }
      },
      "body" : "In commit \"Make sure we pause immediately if we receive a pause-request\"\r\n\r\nWould squash this commit into the commit \"Add request-halt flag to BlockConnected signal\" (along with the other change I suggest moving there) so this is understandable in the correct context.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T19:48:49Z",
      "diff_hunk" : "@@ -2554,7 +2554,7 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n         if (pindexFork != pindexNewTip) {\n             uiInterface.NotifyBlockTip(fInitialDownload, pindexNewTip);\n         }\n-    } while (pindexNewTip != pindexMostWork);\n+    } while (pindexNewTip != pindexMostWork && !isTipUpdatesPaused());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115074802",
      "id" : 115074802,
      "original_commit_id" : "11cccadf1308976cd61de0a7286f2902e6d32426",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : 53,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115074802",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115076481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115076481"
         }
      },
      "body" : "In commit \"SetSoftArg the keypool always to the minimum gap limit if HD is enabled\"\r\n\r\nIt seems like it would be a lot harder to for someone to understand what this \"ignore gap limit\" option does than the `PAUSE_SYNC_WHEN_KEYPOOL_SMALLER_THAN` option I suggested in another comment. Would be curious to know what you think about it.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T19:58:36Z",
      "diff_hunk" : "@@ -3764,6 +3764,7 @@ std::string CWallet::GetWalletHelpString(bool showDebug)\n         strUsage += HelpMessageOpt(\"-flushwallet\", strprintf(\"Run a thread to flush wallet periodically (default: %u)\", DEFAULT_FLUSHWALLET));\n         strUsage += HelpMessageOpt(\"-privdb\", strprintf(\"Sets the DB_PRIVATE flag in the wallet db environment (default: %u)\", DEFAULT_WALLET_PRIVDB));\n         strUsage += HelpMessageOpt(\"-walletrejectlongchains\", strprintf(_(\"Wallet will not create transactions that violate mempool chain limits (default: %u)\"), DEFAULT_WALLET_REJECT_LONG_CHAINS));\n+        strUsage += HelpMessageOpt(\"-hdignoregaplimit\", strprintf(_(\"Ignores the minimum keypool-size warning for HD restore (default: %u)\"), DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115076481",
      "id" : 115076481,
      "original_commit_id" : "cada7263fa95dff17ec2bab3b3b081cfdec2ae8e",
      "original_position" : 13,
      "path" : "src/wallet/wallet.cpp",
      "position" : 346,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115076481",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115076701"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115076701"
         }
      },
      "body" : "In commit \"SetSoftArg the keypool always to the minimum gap limit if HD is enabled\"\r\n\r\nThis seems broken. It's still pausing but just no longer warning that the pause took place?",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T19:59:54Z",
      "diff_hunk" : "@@ -3884,13 +3885,14 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n \n     // HD Restore: Make sure we always have a reasonable keypool size if HD is enabled\n     if (walletInstance->IsHDEnabled()) {\n-        if (walletInstance->IsCrypted()) {\n-            InitWarning(_(\"Your are using an encrypted HD wallet. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));\n+        if (GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE) < HD_RESTORE_KEYPOOL_SIZE_MIN && !GetBoolArg(\"-hdignoregaplimit\", DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE)) {\n+            LogPrintf(\"Parameter Interaction: set keypool to required minimum for encrypted wallets (%d)\\n\", HD_RESTORE_KEYPOOL_SIZE_MIN);\n+            SoftSetArg(\"-keypool\", std::to_string(HD_RESTORE_KEYPOOL_SIZE_MIN));\n         }\n         else {\n             walletInstance->TopUpKeyPool();\n         }\n-        if (!walletInstance->CheckKeypoolMinSize()) {\n+        if (!walletInstance->CheckKeypoolMinSize() && !GetBoolArg(\"-hdignoregaplimit\", DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115076701",
      "id" : 115076701,
      "original_commit_id" : "cada7263fa95dff17ec2bab3b3b081cfdec2ae8e",
      "original_position" : 31,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115076701",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115077168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115077168"
         }
      },
      "body" : "In commit \"SetSoftArg the keypool always to the minimum gap limit if HD is enabled\"\r\n\r\nIs this change meant to be part of this commit? I don't think there's an interaction with hdignoregaplimit here.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T20:02:26Z",
      "diff_hunk" : "@@ -75,10 +75,12 @@ def run_test (self):\n \n         self.log.info(\"Restore backup ...\")\n         self.stop_node(1)\n-        os.remove(self.options.tmpdir + \"/node1/regtest/wallet.dat\")\n+        # we need to delete the complete regtest directory\n+        # otherwise node1 would auto-recover all funds in flag the keypool keys as used",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115077168",
      "id" : 115077168,
      "original_commit_id" : "cada7263fa95dff17ec2bab3b3b081cfdec2ae8e",
      "original_position" : 6,
      "path" : "test/functional/wallet-hd.py",
      "position" : 6,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:02:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115077168",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115078268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115078268"
         }
      },
      "body" : "In commit \"Ensure we pause wallet sync when the keypool requires extension\"\r\n\r\nIt should be possible to handle this without any polling or notifications by making `fPauseBlockRequests` and `fPauseTipUpdates` counters instead of bools. The counters would need to be incremented whenever `fSyncPausedUntilKeypoolExt` changed from false to true in any wallet, and decremented when it changed from true to false. Block requesting or tip updating would be paused whenever its respective counter was greater than 0.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-05T20:08:57Z",
      "diff_hunk" : "@@ -1417,6 +1418,57 @@ bool CWallet::IsHDEnabled() const\n     return !hdChain.masterKeyID.IsNull();\n }\n \n+void CWallet::EventuallyRescanAfterKeypoolTopUp() {\n+    if (fSyncPausedUntilKeypoolExt) {\n+\n+        // for now, enable block requests and tip updates via the states\n+        // this will only be sufficient as long as only a single wallet adjusts these stats\n+        // otherwise the net-/validation-logic needs to poll the state over a signal (or similar)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115078268",
      "id" : 115078268,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 17,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 36546706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115078268",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r116170837"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/116170837"
         }
      },
      "body" : "As you mention, it would be much simpler to call `setBlockRequestsPaused()`, but, wouldn't it be a massive layer violation? Communicating through the signals doesn't require that the wallet needs to know what the full node parts is really doing. But maybe im overcomplicating things here.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-12T07:56:07Z",
      "diff_hunk" : "@@ -1163,33 +1164,51 @@ void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pin\n }\n \n void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n-    LOCK2(cs_main, cs_wallet);\n-    SyncTransaction(ptx);\n-}\n+    if (fSyncPausedUntilKeypoolExt) return;\n \n-    LOCK2(cs_main, cs_wallet);\n-    // TODO: Temporarily ensure that mempool removals are notified before\n-    // connected transactions.  This shouldn't matter, but the abandoned\n-    // state of transactions in our wallet is currently cleared when we\n-    // receive another notification and there is a race condition where\n-    // notification of a connected conflict might cause an outside process\n-    // to abandon a transaction and then have it inadvertently cleared by\n-    // the notification that the conflicted transaction was evicted.\n-\n-    for (const CTransactionRef& ptx : vtxConflicted) {\n+    {\n+        LOCK2(cs_main, cs_wallet);\n         SyncTransaction(ptx);\n     }\n-    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n-        SyncTransaction(pblock->vtx[i], pindex, i);\n+}\n+\n void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted, bool &requestPause) {\n+    if (fSyncPausedUntilKeypoolExt) {\n+        requestPause = true;\n+        return;\n+    }\n+\n+    {\n+        LOCK2(cs_main, cs_wallet);\n+        // TODO: Temporarily ensure that mempool removals are notified before\n+        // connected transactions.  This shouldn't matter, but the abandoned\n+        // state of transactions in our wallet is currently cleared when we\n+        // receive another notification and there is a race condition where\n+        // notification of a connected conflict might cause an outside process\n+        // to abandon a transaction and then have it inadvertently cleared by\n+        // the notification that the conflicted transaction was evicted.\n+\n+        for (const CTransactionRef& ptx : vtxConflicted) {\n+            SyncTransaction(ptx);\n+        }\n+        for (size_t i = 0; i < pblock->vtx.size(); i++) {\n+            SyncTransaction(pblock->vtx[i], pindex, i);\n+        }\n+        if (fSyncPausedUntilKeypoolExt) {\n+            requestPause = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r116170837",
      "id" : 116170837,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 58,
      "path" : "src/wallet/wallet.cpp",
      "position" : 128,
      "pull_request_review_id" : 37773294,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/116170837",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r116173110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/116173110"
         }
      },
      "body" : "The `-hdignoregaplimit` is for debug purposes only. Our tests run with a keypool size of 1 and therefor would cause troubles running post this PR without a \"ignore\" option, and I don't think it matter how we \"ignore\" the gap limit and over a startup argument seems the be the simplest way.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-12T08:10:26Z",
      "diff_hunk" : "@@ -3764,6 +3764,7 @@ std::string CWallet::GetWalletHelpString(bool showDebug)\n         strUsage += HelpMessageOpt(\"-flushwallet\", strprintf(\"Run a thread to flush wallet periodically (default: %u)\", DEFAULT_FLUSHWALLET));\n         strUsage += HelpMessageOpt(\"-privdb\", strprintf(\"Sets the DB_PRIVATE flag in the wallet db environment (default: %u)\", DEFAULT_WALLET_PRIVDB));\n         strUsage += HelpMessageOpt(\"-walletrejectlongchains\", strprintf(_(\"Wallet will not create transactions that violate mempool chain limits (default: %u)\"), DEFAULT_WALLET_REJECT_LONG_CHAINS));\n+        strUsage += HelpMessageOpt(\"-hdignoregaplimit\", strprintf(_(\"Ignores the minimum keypool-size warning for HD restore (default: %u)\"), DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r116173110",
      "id" : 116173110,
      "original_commit_id" : "cada7263fa95dff17ec2bab3b3b081cfdec2ae8e",
      "original_position" : 13,
      "path" : "src/wallet/wallet.cpp",
      "position" : 346,
      "pull_request_review_id" : 37775637,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/116173110",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r116173407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/116173407"
         }
      },
      "body" : "Yes. Thats a good idea. Do you think this should be done in this PR or can we tackle this once we have multiple places where the sync may get paused?\r\nCounters may also introduce the risk of unwillingly increasing it twice (while only decrease it once).",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-12T08:12:12Z",
      "diff_hunk" : "@@ -1417,6 +1418,57 @@ bool CWallet::IsHDEnabled() const\n     return !hdChain.masterKeyID.IsNull();\n }\n \n+void CWallet::EventuallyRescanAfterKeypoolTopUp() {\n+    if (fSyncPausedUntilKeypoolExt) {\n+\n+        // for now, enable block requests and tip updates via the states\n+        // this will only be sufficient as long as only a single wallet adjusts these stats\n+        // otherwise the net-/validation-logic needs to poll the state over a signal (or similar)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r116173407",
      "id" : 116173407,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 17,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 37775957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/116173407",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r116173980"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/116173980"
         }
      },
      "body" : "It would also require to keep the `fInternal` flags in memory (for the address book internal/external change flagging). This is independently addresses in #10238.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-12T08:15:28Z",
      "diff_hunk" : "@@ -3349,14 +3365,62 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n+{\n+    LOCK(cs_wallet);\n+    CWalletDB walletdb(*dbw);\n+    auto it = std::begin(setKeyPool);\n+\n+    bool foundInternal = false;\n+    int64_t foundIndex = -1;\n+    for (const int64_t& id : setKeyPool) {\n+        CKeyPool keypool;\n+        if (!walletdb.ReadPool(id, keypool))\n+            throw std::runtime_error(std::string(__func__) + \": read failed\");\n+\n+        if (keypool.vchPubKey.GetID() == keyId) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r116173980",
      "id" : 116173980,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 40,
      "path" : "src/wallet/wallet.cpp",
      "position" : 253,
      "pull_request_review_id" : 37776598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/116173980",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r116174946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/116174946"
         }
      },
      "body" : "I guess it already tries to avoid this situation by disabling the block downloads if the wallet is encrypted and the node runes in prune-mode.\r\nBut there is no guarantee that we won't prune bellow the wallets best block,.. this why this shutdown/protection is here.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-05-12T08:20:00Z",
      "diff_hunk" : "@@ -1417,6 +1418,57 @@ bool CWallet::IsHDEnabled() const\n     return !hdChain.masterKeyID.IsNull();\n }\n \n+void CWallet::EventuallyRescanAfterKeypoolTopUp() {\n+    if (fSyncPausedUntilKeypoolExt) {\n+\n+        // for now, enable block requests and tip updates via the states\n+        // this will only be sufficient as long as only a single wallet adjusts these stats\n+        // otherwise the net-/validation-logic needs to poll the state over a signal (or similar)\n+        ::setBlockRequestsPaused(false);\n+        ::setTipUpdatesPaused(false);\n+\n+        // disabled the per-wallet pause\n+        fSyncPausedUntilKeypoolExt = false;\n+\n+        const CChainParams& chainparams = Params();\n+        CValidationState state;\n+        if (!ActivateBestChain(state, chainparams)) {\n+            LogPrintf(\"Failed to connect best block\");\n+            StartShutdown();\n+        }\n+\n+        CBlockIndex *pindexRescan = chainActive.Genesis();\n+        CWalletDB walletdb(*dbw);\n+        CBlockLocator locator;\n+        if (walletdb.ReadBestBlock(locator))\n+            pindexRescan = FindForkInGlobalIndex(chainActive, locator);\n+\n+        if (chainActive.Tip() && chainActive.Tip() != pindexRescan)\n+        {\n+            //We can't rescan beyond non-pruned blocks, stop and throw an error\n+            //this might happen if a user uses a old wallet within a pruned node\n+            // or if he ran -disablewallet for a longer time, then decided to re-enable\n+            if (fPruneMode)\n+            {\n+                CBlockIndex *block = chainActive.Tip();\n+                while (block && block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA) && block->pprev->nTx > 0 && pindexRescan != block)\n+                    block = block->pprev;\n+\n+                if (pindexRescan != block) {\n+                    const static std::string pruneError = \"Prune: last wallet synchronisation goes beyond pruned data. You need to -reindex (download the whole blockchain again in case of pruned node)\";\n+                    uiInterface.ThreadSafeMessageBox(pruneError, \"\", CClientUIInterface::MSG_ERROR);\n+                    StartShutdown();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r116174946",
      "id" : 116174946,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 51,
      "path" : "src/wallet/wallet.cpp",
      "position" : 181,
      "pull_request_review_id" : 37777656,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-05-12T08:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/116174946",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Needed rebase.\r\nAddressed most of @ryanofsky points.",
      "created_at" : "2017-05-12T08:29:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#issuecomment-301017020",
      "id" : 301017020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10240",
      "updated_at" : "2017-05-12T08:30:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/301017020",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120918741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120918741"
         }
      },
      "body" : "> Would squash this commit into the commit \"Add request-halt flag to BlockConnected signal\" (along with the other change I suggest moving there) so this is understandable in the correct context.\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:22:10Z",
      "diff_hunk" : "@@ -2554,7 +2554,7 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n         if (pindexFork != pindexNewTip) {\n             uiInterface.NotifyBlockTip(fInitialDownload, pindexNewTip);\n         }\n-    } while (pindexNewTip != pindexMostWork);\n+    } while (pindexNewTip != pindexMostWork && !isTipUpdatesPaused());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120918741",
      "id" : 120918741,
      "original_commit_id" : "11cccadf1308976cd61de0a7286f2902e6d32426",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : 53,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120918741",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120918877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120918877"
         }
      },
      "body" : "> As you mention, it would be much simpler to call setBlockRequestsPaused(), but, wouldn't it be a massive layer violation? Communicating through the signals doesn't require that the wallet needs to know what the full node parts is really doing. But maybe im overcomplicating things here.\r\n\r\nI don't see why it would be a problem to call `setBlockRequestsPaused(true)` from `CWallet::MarkReserveKeysAsUsed`, especially if it isn't a problem to call `setBlockRequestsPaused(false)` from `CWallet::EventuallyRescanAfterKeypoolTopUp` which the current code already does. It seems like it would just make pausing simpler, and more consistent with unpausing.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:22:38Z",
      "diff_hunk" : "@@ -1163,33 +1164,51 @@ void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pin\n }\n \n void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n-    LOCK2(cs_main, cs_wallet);\n-    SyncTransaction(ptx);\n-}\n+    if (fSyncPausedUntilKeypoolExt) return;\n \n-    LOCK2(cs_main, cs_wallet);\n-    // TODO: Temporarily ensure that mempool removals are notified before\n-    // connected transactions.  This shouldn't matter, but the abandoned\n-    // state of transactions in our wallet is currently cleared when we\n-    // receive another notification and there is a race condition where\n-    // notification of a connected conflict might cause an outside process\n-    // to abandon a transaction and then have it inadvertently cleared by\n-    // the notification that the conflicted transaction was evicted.\n-\n-    for (const CTransactionRef& ptx : vtxConflicted) {\n+    {\n+        LOCK2(cs_main, cs_wallet);\n         SyncTransaction(ptx);\n     }\n-    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n-        SyncTransaction(pblock->vtx[i], pindex, i);\n+}\n+\n void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted, bool &requestPause) {\n+    if (fSyncPausedUntilKeypoolExt) {\n+        requestPause = true;\n+        return;\n+    }\n+\n+    {\n+        LOCK2(cs_main, cs_wallet);\n+        // TODO: Temporarily ensure that mempool removals are notified before\n+        // connected transactions.  This shouldn't matter, but the abandoned\n+        // state of transactions in our wallet is currently cleared when we\n+        // receive another notification and there is a race condition where\n+        // notification of a connected conflict might cause an outside process\n+        // to abandon a transaction and then have it inadvertently cleared by\n+        // the notification that the conflicted transaction was evicted.\n+\n+        for (const CTransactionRef& ptx : vtxConflicted) {\n+            SyncTransaction(ptx);\n+        }\n+        for (size_t i = 0; i < pblock->vtx.size(); i++) {\n+            SyncTransaction(pblock->vtx[i], pindex, i);\n+        }\n+        if (fSyncPausedUntilKeypoolExt) {\n+            requestPause = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120918877",
      "id" : 120918877,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 58,
      "path" : "src/wallet/wallet.cpp",
      "position" : 128,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120918877",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919001"
         }
      },
      "body" : "> But there is no guarantee that we won't prune bellow the wallets best block,.. this why this shutdown/protection is here.\r\n\r\nWouldn't just staying paused in this case offer as much protection as briefly unpausing and then shutting down?",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:23:03Z",
      "diff_hunk" : "@@ -1417,6 +1418,57 @@ bool CWallet::IsHDEnabled() const\n     return !hdChain.masterKeyID.IsNull();\n }\n \n+void CWallet::EventuallyRescanAfterKeypoolTopUp() {\n+    if (fSyncPausedUntilKeypoolExt) {\n+\n+        // for now, enable block requests and tip updates via the states\n+        // this will only be sufficient as long as only a single wallet adjusts these stats\n+        // otherwise the net-/validation-logic needs to poll the state over a signal (or similar)\n+        ::setBlockRequestsPaused(false);\n+        ::setTipUpdatesPaused(false);\n+\n+        // disabled the per-wallet pause\n+        fSyncPausedUntilKeypoolExt = false;\n+\n+        const CChainParams& chainparams = Params();\n+        CValidationState state;\n+        if (!ActivateBestChain(state, chainparams)) {\n+            LogPrintf(\"Failed to connect best block\");\n+            StartShutdown();\n+        }\n+\n+        CBlockIndex *pindexRescan = chainActive.Genesis();\n+        CWalletDB walletdb(*dbw);\n+        CBlockLocator locator;\n+        if (walletdb.ReadBestBlock(locator))\n+            pindexRescan = FindForkInGlobalIndex(chainActive, locator);\n+\n+        if (chainActive.Tip() && chainActive.Tip() != pindexRescan)\n+        {\n+            //We can't rescan beyond non-pruned blocks, stop and throw an error\n+            //this might happen if a user uses a old wallet within a pruned node\n+            // or if he ran -disablewallet for a longer time, then decided to re-enable\n+            if (fPruneMode)\n+            {\n+                CBlockIndex *block = chainActive.Tip();\n+                while (block && block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA) && block->pprev->nTx > 0 && pindexRescan != block)\n+                    block = block->pprev;\n+\n+                if (pindexRescan != block) {\n+                    const static std::string pruneError = \"Prune: last wallet synchronisation goes beyond pruned data. You need to -reindex (download the whole blockchain again in case of pruned node)\";\n+                    uiInterface.ThreadSafeMessageBox(pruneError, \"\", CClientUIInterface::MSG_ERROR);\n+                    StartShutdown();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919001",
      "id" : 120919001,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 51,
      "path" : "src/wallet/wallet.cpp",
      "position" : 181,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919001",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919053"
         }
      },
      "body" : "> Should move this declaration closer to where it's actually used way below.\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:23:13Z",
      "diff_hunk" : "@@ -3349,14 +3365,62 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n+{\n+    LOCK(cs_wallet);\n+    CWalletDB walletdb(*dbw);\n+    auto it = std::begin(setKeyPool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919053",
      "id" : 120919053,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 31,
      "path" : "src/wallet/wallet.cpp",
      "position" : 244,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919053",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919083"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919083"
         }
      },
      "body" : "> It would also require to keep the fInternal flags in memory (for the address book internal/external change flagging). This is independently addresses in #10238.\r\n\r\nYeah probably not worth simplifying this if it will be obsoleted by #10238.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:23:19Z",
      "diff_hunk" : "@@ -3349,14 +3365,62 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n+{\n+    LOCK(cs_wallet);\n+    CWalletDB walletdb(*dbw);\n+    auto it = std::begin(setKeyPool);\n+\n+    bool foundInternal = false;\n+    int64_t foundIndex = -1;\n+    for (const int64_t& id : setKeyPool) {\n+        CKeyPool keypool;\n+        if (!walletdb.ReadPool(id, keypool))\n+            throw std::runtime_error(std::string(__func__) + \": read failed\");\n+\n+        if (keypool.vchPubKey.GetID() == keyId) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919083",
      "id" : 120919083,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 40,
      "path" : "src/wallet/wallet.cpp",
      "position" : 253,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919083",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919114"
         }
      },
      "body" : "> As an simplification (and optimization), you can exit the loop if id > foundIndex, since setKeyPool is an ordered set.\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:23:26Z",
      "diff_hunk" : "@@ -3349,14 +3365,62 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n+{\n+    LOCK(cs_wallet);\n+    CWalletDB walletdb(*dbw);\n+    auto it = std::begin(setKeyPool);\n+\n+    bool foundInternal = false;\n+    int64_t foundIndex = -1;\n+    for (const int64_t& id : setKeyPool) {\n+        CKeyPool keypool;\n+        if (!walletdb.ReadPool(id, keypool))\n+            throw std::runtime_error(std::string(__func__) + \": read failed\");\n+\n+        if (keypool.vchPubKey.GetID() == keyId) {\n+            foundInternal = keypool.fInternal;\n+            foundIndex = id;\n+            if (!keypool.fInternal) {\n+                SetAddressBook(keyId, \"\", \"receive\");\n+            }\n+            break;\n+        }\n+    }\n+\n+    // mark all keys up to the found key as used\n+    if (foundIndex >= 0) {\n+        while (it != std::end(setKeyPool)) {\n+            const int64_t& id = *(it);\n+            if (id <= foundIndex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919114",
      "id" : 120919114,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 54,
      "path" : "src/wallet/wallet.cpp",
      "position" : 267,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919114",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919150"
         }
      },
      "body" : "> Shouldn't it be an error if this condition is not true?\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:23:34Z",
      "diff_hunk" : "@@ -3349,14 +3365,62 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n+{\n+    LOCK(cs_wallet);\n+    CWalletDB walletdb(*dbw);\n+    auto it = std::begin(setKeyPool);\n+\n+    bool foundInternal = false;\n+    int64_t foundIndex = -1;\n+    for (const int64_t& id : setKeyPool) {\n+        CKeyPool keypool;\n+        if (!walletdb.ReadPool(id, keypool))\n+            throw std::runtime_error(std::string(__func__) + \": read failed\");\n+\n+        if (keypool.vchPubKey.GetID() == keyId) {\n+            foundInternal = keypool.fInternal;\n+            foundIndex = id;\n+            if (!keypool.fInternal) {\n+                SetAddressBook(keyId, \"\", \"receive\");\n+            }\n+            break;\n+        }\n+    }\n+\n+    // mark all keys up to the found key as used\n+    if (foundIndex >= 0) {\n+        while (it != std::end(setKeyPool)) {\n+            const int64_t& id = *(it);\n+            if (id <= foundIndex) {\n+                CKeyPool keypool;\n+                if (!walletdb.ReadPool(id, keypool))\n+                    throw std::runtime_error(std::string(__func__) + \": read failed\");\n+\n+                // only mark keys on the corresponding chain\n+                if (keypool.fInternal == foundInternal) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919150",
      "id" : 120919150,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 60,
      "path" : "src/wallet/wallet.cpp",
      "position" : 273,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919150",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919193"
         }
      },
      "body" : ">Is this change meant to be part of this commit? I don't think there's an interaction with hdignoregaplimit here.\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:23:42Z",
      "diff_hunk" : "@@ -75,10 +75,12 @@ def run_test (self):\n \n         self.log.info(\"Restore backup ...\")\n         self.stop_node(1)\n-        os.remove(self.options.tmpdir + \"/node1/regtest/wallet.dat\")\n+        # we need to delete the complete regtest directory\n+        # otherwise node1 would auto-recover all funds in flag the keypool keys as used",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919193",
      "id" : 120919193,
      "original_commit_id" : "cada7263fa95dff17ec2bab3b3b081cfdec2ae8e",
      "original_position" : 6,
      "path" : "test/functional/wallet-hd.py",
      "position" : 6,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919193",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919269"
         }
      },
      "body" : "> The -hdignoregaplimit is for debug purposes only\r\n\r\nMaybe it's not worth fixing, but even as a developer I think \"pause sync when keypool is smaller than\" is clearer than \"ignore hd gap limit\" because one name tells you literally what the option does, while the other refers obliquely to what the option doesn't do.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:23:56Z",
      "diff_hunk" : "@@ -3764,6 +3764,7 @@ std::string CWallet::GetWalletHelpString(bool showDebug)\n         strUsage += HelpMessageOpt(\"-flushwallet\", strprintf(\"Run a thread to flush wallet periodically (default: %u)\", DEFAULT_FLUSHWALLET));\n         strUsage += HelpMessageOpt(\"-privdb\", strprintf(\"Sets the DB_PRIVATE flag in the wallet db environment (default: %u)\", DEFAULT_WALLET_PRIVDB));\n         strUsage += HelpMessageOpt(\"-walletrejectlongchains\", strprintf(_(\"Wallet will not create transactions that violate mempool chain limits (default: %u)\"), DEFAULT_WALLET_REJECT_LONG_CHAINS));\n+        strUsage += HelpMessageOpt(\"-hdignoregaplimit\", strprintf(_(\"Ignores the minimum keypool-size warning for HD restore (default: %u)\"), DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919269",
      "id" : 120919269,
      "original_commit_id" : "cada7263fa95dff17ec2bab3b3b081cfdec2ae8e",
      "original_position" : 13,
      "path" : "src/wallet/wallet.cpp",
      "position" : 346,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919269",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919546"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919546"
         }
      },
      "body" : "Fixed in 5b70a2289e96f0ce8c49678e613845572d8203bc",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:24:52Z",
      "diff_hunk" : "@@ -3409,6 +3428,7 @@ void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n     }\n \n     if (IsHDEnabled() && !TopUpKeyPool()) {\n+        fSyncPausedUntilKeypoolExt = true;\n         LogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919546",
      "id" : 120919546,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 83,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919546",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919583"
         }
      },
      "body" : "> Phrase \"In case you recover a HD wallet\" seems too vague to be meaningful.\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:24:58Z",
      "diff_hunk" : "@@ -3725,6 +3789,19 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n \n     RegisterValidationInterface(walletInstance);\n \n+    // HD Restore: Make sure we always have a reasonable keypool size if HD is enabled\n+    if (walletInstance->IsHDEnabled()) {\n+        if (walletInstance->IsCrypted()) {\n+            InitWarning(_(\"Your are using an encrypted HD wallet. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919583",
      "id" : 120919583,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 94,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919583",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919724"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919724"
         }
      },
      "body" : "> Since this is warning that the requested size is below the recommended limit, it would be good to mention what the recommended limit actually is.\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:25:32Z",
      "diff_hunk" : "@@ -3725,6 +3789,19 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n \n     RegisterValidationInterface(walletInstance);\n \n+    // HD Restore: Make sure we always have a reasonable keypool size if HD is enabled\n+    if (walletInstance->IsHDEnabled()) {\n+        if (walletInstance->IsCrypted()) {\n+            InitWarning(_(\"Your are using an encrypted HD wallet. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));\n+        }\n+        else {\n+            if (GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE) < HD_RESTORE_KEYPOOL_SIZE_MIN ) {\n+                InitWarning(_(\"Your keypool size is below the recommended limit for HD rescans. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919724",
      "id" : 120919724,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 98,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919724",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919944"
         }
      },
      "body" : "> Compile error here (line needs to be moved up)\r\n\r\nError is still present (commit \"Add request-halt flag to BlockConnected signal)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:26:15Z",
      "diff_hunk" : "@@ -1182,6 +1181,7 @@ void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const\n     }\n     for (size_t i = 0; i < pblock->vtx.size(); i++) {\n         SyncTransaction(pblock->vtx[i], pindex, i);\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted, bool &requestPause) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120919944",
      "id" : 120919944,
      "original_commit_id" : "5e672d36d922a780de86bc0ca64e220d758ab14c",
      "original_position" : 12,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120919944",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920008"
         }
      },
      "body" : "Added in 5b70a2289e96f0ce8c49678e613845572d8203bc.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:26:31Z",
      "diff_hunk" : "@@ -652,6 +652,7 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n     static std::atomic<bool> fFlushScheduled;\n     std::atomic<bool> fAbortRescan;\n     std::atomic<bool> fScanningWallet;\n+    std::atomic<bool> fSyncPausedUntilKeypoolExt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920008",
      "id" : 120920008,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 4,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920008",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920174"
         }
      },
      "body" : ">This diff logically seems like it should be part of the \"Add request-halt flag to BlockConnected signal\" commit. Moving it there would make the commit history easier to understand.\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:27:02Z",
      "diff_hunk" : "@@ -2533,6 +2533,14 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n             for (const PerBlockConnectTrace& trace : connectTrace.GetBlocksConnected()) {\n                 assert(trace.pblock && trace.pindex);\n                 GetMainSignals().BlockConnected(trace.pblock, trace.pindex, *trace.conflictedTxs, requestPause);\n+                if (requestPause) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920174",
      "id" : 120920174,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 4,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920174",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920214"
         }
      },
      "body" : "> Consider moving this change to the \"Add option to pause block requests\" commit.\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:27:09Z",
      "diff_hunk" : "@@ -4316,6 +4324,7 @@ bool isBlockRequestsPaused() {\n }\n \n void setBlockRequestsPaused(bool state) {\n+    LogPrintf(\"%s Block Requests\\n\", (state ? \"Pause\" : \"Resume\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920214",
      "id" : 120920214,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 19,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920214",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920245"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920245"
         }
      },
      "body" : ">Consider moving this change to the \"Add option to pause tip updates\" commit.\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:27:15Z",
      "diff_hunk" : "@@ -4324,6 +4333,7 @@ bool isTipUpdatesPaused() {\n }\n \n void setTipUpdatesPaused(bool state) {\n+    LogPrintf(\"%s Tip Updates\\n\", (state ? \"Pause\" : \"Resume\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920245",
      "id" : 120920245,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 27,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920245",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920268"
         }
      },
      "body" : ">Would it make sense to call this automatically inside TopUpKeyPool? Seems strange to have to implement it separately for RPC and Qt wallet interfaces\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:27:21Z",
      "diff_hunk" : "@@ -2044,6 +2044,9 @@ UniValue walletpassphrase(const JSONRPCRequest& request)\n \n     pwallet->TopUpKeyPool();\n \n+    // give a hint to the wallet in case we have paused sync (we may have fall bellow the hd gap limit)\n+    pwallet->EventuallyRescanAfterKeypoolTopUp();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920268",
      "id" : 120920268,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 5,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920268",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920419"
         }
      },
      "body" : ">Already listed\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:27:52Z",
      "diff_hunk" : "@@ -54,6 +54,7 @@\n     # Longest test should go first, to favor running tests in parallel\n     'wallet-hd.py',\n     'wallet-hd-restore.py',\n+    'wallet-hd-restore.py',",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920419",
      "id" : 120920419,
      "original_commit_id" : "ec5bf977339e30df1192a6bbdc259bcf5f702c45",
      "original_position" : 4,
      "path" : "test/functional/test_runner.py",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920419",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920486"
         }
      },
      "body" : "> This pausing behavior seems like it should be optional\r\n\r\nThe \"-hdignoregaplimit\" argument added in the next commit does make this optional (commit \"SetSoftArg the keypool always to the minimum gap limit\"), though I still think a single \"pause sync when keypool smaller than\" check would be a little cleaner than separate \"keypool size min\" and \"ignore gap limit\" checks.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:28:05Z",
      "diff_hunk" : "@@ -3442,6 +3443,18 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+bool CWallet::CheckKeypoolMinSize() {\n+    LOCK(cs_wallet);\n+    size_t extKeypoolSize = KeypoolCountExternalKeys();\n+    if (IsHDEnabled() && (extKeypoolSize < HD_RESTORE_KEYPOOL_SIZE_MIN || (setKeyPool.size()-extKeypoolSize) < HD_RESTORE_KEYPOOL_SIZE_MIN)) {\n+        // if the remaining keypool size is below the gap limit, refuse to continue with the sync\n+        fSyncPausedUntilKeypoolExt = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920486",
      "id" : 120920486,
      "original_commit_id" : "f6f09a8eb24c583eac8dd6abd04e97ba0dee0637",
      "original_position" : 17,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920486",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920557"
         }
      },
      "body" : "> Warning should suggest how to fix the problem, and also ideally also include more background information (maybe consider using my previous suggestion for the -keypool limit warning).\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:28:23Z",
      "diff_hunk" : "@@ -3881,12 +3888,11 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n             InitWarning(_(\"Your are using an encrypted HD wallet. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));\n         }\n         else {\n-            if (GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE) < HD_RESTORE_KEYPOOL_SIZE_MIN ) {\n-                InitWarning(_(\"Your keypool size is below the recommended limit for HD rescans. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));\n-            }\n             walletInstance->TopUpKeyPool();\n         }\n-\n+        if (!walletInstance->CheckKeypoolMinSize()) {\n+            InitWarning(_(\"Your keypool size is below the required limit for HD rescans. Wallet synchronisation is now paused until you have refilled the keypool.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920557",
      "id" : 120920557,
      "original_commit_id" : "f6f09a8eb24c583eac8dd6abd04e97ba0dee0637",
      "original_position" : 53,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920557",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920775"
         }
      },
      "body" : "> This seems broken. It's still pausing but just no longer warning that the pause took place?\r\n\r\nOn second look, this seems ok because CWallet::CheckKeypoolMinSize now checks for \"-hdignoregaplimit\" and disables the pause.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T15:29:14Z",
      "diff_hunk" : "@@ -3884,13 +3885,14 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n \n     // HD Restore: Make sure we always have a reasonable keypool size if HD is enabled\n     if (walletInstance->IsHDEnabled()) {\n-        if (walletInstance->IsCrypted()) {\n-            InitWarning(_(\"Your are using an encrypted HD wallet. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));\n+        if (GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE) < HD_RESTORE_KEYPOOL_SIZE_MIN && !GetBoolArg(\"-hdignoregaplimit\", DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE)) {\n+            LogPrintf(\"Parameter Interaction: set keypool to required minimum for encrypted wallets (%d)\\n\", HD_RESTORE_KEYPOOL_SIZE_MIN);\n+            SoftSetArg(\"-keypool\", std::to_string(HD_RESTORE_KEYPOOL_SIZE_MIN));\n         }\n         else {\n             walletInstance->TopUpKeyPool();\n         }\n-        if (!walletInstance->CheckKeypoolMinSize()) {\n+        if (!walletInstance->CheckKeypoolMinSize() && !GetBoolArg(\"-hdignoregaplimit\", DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120920775",
      "id" : 120920775,
      "original_commit_id" : "cada7263fa95dff17ec2bab3b3b081cfdec2ae8e",
      "original_position" : 31,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120920775",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120965597"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120965597"
         }
      },
      "body" : "In commit \"SetSoftArg the keypool always to the minimum gap limit if HD is enabled\"\r\n\r\nIt might be a good idea to keep the warning about missing funds in the case where IsCrypted && size < KEYPOOL_SIZE_MIN && GetBool(\"-hdignoregaplimit\"). I also had a suggestion about this warning in\r\nhttps://github.com/bitcoin/bitcoin/pull/10240#discussion_r115049299",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T18:33:52Z",
      "diff_hunk" : "@@ -3882,13 +3883,14 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n \n     // HD Restore: Make sure we always have a reasonable keypool size if HD is enabled\n     if (walletInstance->IsHDEnabled()) {\n-        if (walletInstance->IsCrypted()) {\n-            InitWarning(_(\"Your are using an encrypted HD wallet. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120965597",
      "id" : 120965597,
      "original_commit_id" : "bd9e1e8f89e8470eecb57338e355a9519da66cd9",
      "original_position" : 22,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120965597",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120969753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120969753"
         }
      },
      "body" : "In commit \"Make sure we check the keypool min size during startup\"\r\n\r\nWhy drop this warning? It still seems useful to warn about the \"-keypool\" being too small even if KeypoolCountExternalKeys() is momentarily returning a high number of keys. (I also had another suggestion about this warning at https://github.com/bitcoin/bitcoin/pull/10240#discussion_r115052129)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T18:50:15Z",
      "diff_hunk" : "@@ -3879,12 +3886,11 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n             InitWarning(_(\"Your are using an encrypted HD wallet. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));\n         }\n         else {\n-            if (GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE) < HD_RESTORE_KEYPOOL_SIZE_MIN ) {\n-                InitWarning(_(\"Your keypool size is below the recommended limit for HD rescans. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120969753",
      "id" : 120969753,
      "original_commit_id" : "46060c261c0edc7ef13bbee7575801c98534f440",
      "original_position" : 47,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42924281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120969753",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120976622"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120976622"
         }
      },
      "body" : ">Would expand this comment\r\n\r\nDone in 2a203b73fd2d7b016cd5f55977135a15a982414d",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T19:22:52Z",
      "diff_hunk" : "@@ -1002,6 +1002,22 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockI\n         if (fExisted && !fUpdate) return false;\n         if (fExisted || IsMine(tx) || IsFromMe(tx))\n         {\n+            // check if we need to flag used keypool keys",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120976622",
      "id" : 120976622,
      "original_commit_id" : "b5f9bc2c11d9793d3f7a3ffef5e0d881c8e60e6b",
      "original_position" : 4,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42988490,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:22:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120976622",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120976859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120976859"
         }
      },
      "body" : ">Do you think this should be done in this PR or can we tackle this once we have multiple places where the sync may get paused?\r\n\r\nMaybe, this PR is already pretty complicated, so I wouldn't want to tack this on in extra commits, but it could be nice if implemented to replace the existing \"Add option to pause...\" commits.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T19:23:50Z",
      "diff_hunk" : "@@ -1417,6 +1418,57 @@ bool CWallet::IsHDEnabled() const\n     return !hdChain.masterKeyID.IsNull();\n }\n \n+void CWallet::EventuallyRescanAfterKeypoolTopUp() {\n+    if (fSyncPausedUntilKeypoolExt) {\n+\n+        // for now, enable block requests and tip updates via the states\n+        // this will only be sufficient as long as only a single wallet adjusts these stats\n+        // otherwise the net-/validation-logic needs to poll the state over a signal (or similar)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120976859",
      "id" : 120976859,
      "original_commit_id" : "8ac56f8ebddb22e9281c4a7dab21939da18a543b",
      "original_position" : 17,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42988720,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:23:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120976859",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120977058"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120977058"
         }
      },
      "body" : "> Maybe rename this variable. (It shadows CWallet::setKeyPool, which makes that variable more annoying to grep for.)\r\n\r\nDone in 2a203b73fd2d7b016cd5f55977135a15a982414d\r\n",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T19:24:42Z",
      "diff_hunk" : "@@ -970,6 +1004,22 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockI\n         if (fExisted && !fUpdate) return false;\n         if (fExisted || IsMine(tx) || IsFromMe(tx))\n         {\n+            // check if we need to flag used keypool keys\n+            std::set<CKeyID> setKeyPool;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120977058",
      "id" : 120977058,
      "original_commit_id" : "11cccadf1308976cd61de0a7286f2902e6d32426",
      "original_position" : 60,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42988942,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:24:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120977058",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120977130"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120977130"
         }
      },
      "body" : ">No need to add the {} and extra indentation\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T19:25:03Z",
      "diff_hunk" : "@@ -1163,33 +1164,51 @@ void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pin\n }\n \n void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n-    LOCK2(cs_main, cs_wallet);\n-    SyncTransaction(ptx);\n-}\n+    if (fSyncPausedUntilKeypoolExt) return;\n \n-    LOCK2(cs_main, cs_wallet);\n-    // TODO: Temporarily ensure that mempool removals are notified before\n-    // connected transactions.  This shouldn't matter, but the abandoned\n-    // state of transactions in our wallet is currently cleared when we\n-    // receive another notification and there is a race condition where\n-    // notification of a connected conflict might cause an outside process\n-    // to abandon a transaction and then have it inadvertently cleared by\n-    // the notification that the conflicted transaction was evicted.\n-\n-    for (const CTransactionRef& ptx : vtxConflicted) {\n+    {\n+        LOCK2(cs_main, cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120977130",
      "id" : 120977130,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 28,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42989025,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:25:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120977130",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120977187"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120977187"
         }
      },
      "body" : ">Maybe avoid BOOST_FOREACH here and below.\r\n\r\nDone in 2a203b73fd2d7b016cd5f55977135a15a982414d",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T19:25:22Z",
      "diff_hunk" : "@@ -970,6 +1004,22 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockI\n         if (fExisted && !fUpdate) return false;\n         if (fExisted || IsMine(tx) || IsFromMe(tx))\n         {\n+            // check if we need to flag used keypool keys\n+            std::set<CKeyID> setKeyPool;\n+            GetAllReserveKeys(setKeyPool);\n+            // loop though all outputs\n+            BOOST_FOREACH(const CTxOut& txout, tx.vout) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120977187",
      "id" : 120977187,
      "original_commit_id" : "11cccadf1308976cd61de0a7286f2902e6d32426",
      "original_position" : 63,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42989093,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:25:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120977187",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120977253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120977253"
         }
      },
      "body" : ">Again unnecessary {} and indentation make the diff messy here in BlockDisconnected\r\n\r\n(unchanged)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T19:25:42Z",
      "diff_hunk" : "@@ -1163,33 +1164,51 @@ void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pin\n }\n \n void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n-    LOCK2(cs_main, cs_wallet);\n-    SyncTransaction(ptx);\n-}\n+    if (fSyncPausedUntilKeypoolExt) return;\n \n-    LOCK2(cs_main, cs_wallet);\n-    // TODO: Temporarily ensure that mempool removals are notified before\n-    // connected transactions.  This shouldn't matter, but the abandoned\n-    // state of transactions in our wallet is currently cleared when we\n-    // receive another notification and there is a race condition where\n-    // notification of a connected conflict might cause an outside process\n-    // to abandon a transaction and then have it inadvertently cleared by\n-    // the notification that the conflicted transaction was evicted.\n-\n-    for (const CTransactionRef& ptx : vtxConflicted) {\n+    {\n+        LOCK2(cs_main, cs_wallet);\n         SyncTransaction(ptx);\n     }\n-    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n-        SyncTransaction(pblock->vtx[i], pindex, i);\n+}\n+\n void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted, bool &requestPause) {\n+    if (fSyncPausedUntilKeypoolExt) {\n+        requestPause = true;\n+        return;\n+    }\n+\n+    {\n+        LOCK2(cs_main, cs_wallet);\n+        // TODO: Temporarily ensure that mempool removals are notified before\n+        // connected transactions.  This shouldn't matter, but the abandoned\n+        // state of transactions in our wallet is currently cleared when we\n+        // receive another notification and there is a race condition where\n+        // notification of a connected conflict might cause an outside process\n+        // to abandon a transaction and then have it inadvertently cleared by\n+        // the notification that the conflicted transaction was evicted.\n+\n+        for (const CTransactionRef& ptx : vtxConflicted) {\n+            SyncTransaction(ptx);\n+        }\n+        for (size_t i = 0; i < pblock->vtx.size(); i++) {\n+            SyncTransaction(pblock->vtx[i], pindex, i);\n+        }\n+        if (fSyncPausedUntilKeypoolExt) {\n+            requestPause = true;\n+        }\n     }\n }\n \n void CWallet::BlockDisconnected(const std::shared_ptr<const CBlock>& pblock) {\n-    LOCK2(cs_main, cs_wallet);\n+    if (fSyncPausedUntilKeypoolExt) return;\n \n-    for (const CTransactionRef& ptx : pblock->vtx) {\n-        SyncTransaction(ptx);\n+    {\n+        LOCK2(cs_main, cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120977253",
      "id" : 120977253,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 70,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 42989178,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:25:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120977253",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120977350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120977350"
         }
      },
      "body" : ">These functions are never called anywhere, and appear to be deleted in the next commit. Would remove them from this commit.\r\n\r\nRemoved in 5b70a2289e96f0ce8c49678e613845572d8203bc\r\n",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-08T19:26:09Z",
      "diff_hunk" : "@@ -1106,6 +1108,9 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n        caller must ensure the current wallet version is correct before calling\n        this function). */\n     bool SetHDMasterKey(const CPubKey& key);\n+\n+    bool IsSyncPausedUntilKeypoolExt() { return fSyncPausedUntilKeypoolExt; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r120977350",
      "id" : 120977350,
      "original_commit_id" : "b9a95b08e587c722c0b0bb15adf805ba42584d9c",
      "original_position" : 21,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 42989303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-08T19:26:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/120977350",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121538887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121538887"
         }
      },
      "body" : "I'm not going to comment on @ryanofsky's other comments regarding commit order (although they all sound sensible). This one should definitely be fixed in commit  \"Add request-halt flag to BlockConnected signal\" since it breaks the build and so breaks git bisect.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:06:24Z",
      "diff_hunk" : "@@ -1115,29 +1169,41 @@ void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pin\n }\n \n void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n+    if (fSyncPausedUntilKeypoolExt) return;\n     LOCK2(cs_main, cs_wallet);\n     SyncTransaction(ptx);\n }\n \n-void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n-    LOCK2(cs_main, cs_wallet);\n-    // TODO: Temporarily ensure that mempool removals are notified before\n-    // connected transactions.  This shouldn't matter, but the abandoned\n-    // state of transactions in our wallet is currently cleared when we\n-    // receive another notification and there is a race condition where\n-    // notification of a connected conflict might cause an outside process\n-    // to abandon a transaction and then have it inadvertently cleared by\n-    // the notification that the conflicted transaction was evicted.\n-\n-    for (const CTransactionRef& ptx : vtxConflicted) {\n-        SyncTransaction(ptx);\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted, bool &requestPause) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121538887",
      "id" : 121538887,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 103,
      "path" : "src/wallet/wallet.cpp",
      "position" : 103,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121538887",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121538932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121538932"
         }
      },
      "body" : "nit: braces",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:06:38Z",
      "diff_hunk" : "@@ -480,6 +480,9 @@ void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vector<con\n     // Make sure pindexBestKnownBlock is up to date, we'll need it.\n     ProcessBlockAvailability(nodeid);\n \n+    if (isBlockRequestsPaused())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121538932",
      "id" : 121538932,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121538932",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121539814"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121539814"
         }
      },
      "body" : "nit: s/will allow to temporary/will temporarily",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:11:54Z",
      "diff_hunk" : "@@ -287,6 +287,20 @@ CAmount GetBlockSubsidy(int nHeight, const Consensus::Params& consensusParams);\n double GuessVerificationProgress(const ChainTxData& data, CBlockIndex* pindex);\n \n /**\n+ * Pausing block requests will allow to temporary pause the verification process.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121539814",
      "id" : 121539814,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 4,
      "path" : "src/validation.h",
      "position" : 4,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121539814",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121539847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121539847"
         }
      },
      "body" : "nit: s/will temporary/will temporarily",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:12:06Z",
      "diff_hunk" : "@@ -287,6 +287,20 @@ CAmount GetBlockSubsidy(int nHeight, const Consensus::Params& consensusParams);\n double GuessVerificationProgress(const ChainTxData& data, CBlockIndex* pindex);\n \n /**\n+ * Pausing block requests will allow to temporary pause the verification process.\n+ * Pausing won't prevent ActivateBestChain from connecting blocks (that are in flight or already on disk)\n+ */\n+bool isBlockRequestsPaused();\n+void setBlockRequestsPaused(bool state);\n+\n+/**\n+ * Pausing tip updates will temporary pause connecting new blocks",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121539847",
      "id" : 121539847,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 11,
      "path" : "src/validation.h",
      "position" : 11,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121539847",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121540156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121540156"
         }
      },
      "body" : "nit:\r\n\r\n    // Give a hint to the wallet in case we have paused sync (we may have fallen bellow the hd gap limit).\r\n    // This runs synchronously, at least during the resync, we can be sure the keypool can be topped up",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:14:03Z",
      "diff_hunk" : "@@ -2046,6 +2046,10 @@ UniValue walletpassphrase(const JSONRPCRequest& request)\n \n     pwallet->TopUpKeyPool();\n \n+    // give a hint to the wallet in case we have paused sync (we may have fall bellow the hd gap limit)\n+    // this runs synchronous, at least during the resync, we can be sure the keypool can be topped up",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121540156",
      "id" : 121540156,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 5,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121540156",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121540588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121540588"
         }
      },
      "body" : "nit: avoid `BOOST_FOREACH`",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:16:54Z",
      "diff_hunk" : "@@ -970,6 +1004,26 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const CBlockI\n         if (fExisted && !fUpdate) return false;\n         if (fExisted || IsMine(tx) || IsFromMe(tx))\n         {\n+            /* Check if any keys in the wallet keypool that were supposed to be unused\n+             * have appeared in a new transaction. If so, remove those keys from the keypool.\n+             * This can happen when restoring an old wallet backup that does not contain\n+             * the mostly recently created transactions from newer versions of the wallet.\n+             */\n+            std::set<CKeyID> keyPool;\n+            GetAllReserveKeys(keyPool);\n+            // loop though all outputs\n+            for(const CTxOut& txout: tx.vout) {\n+                // extract addresses and check if they match with an unused keypool key\n+                std::vector<CKeyID> vAffected;\n+                CAffectedKeysVisitor(*this, vAffected).Process(txout.scriptPubKey);\n+                BOOST_FOREACH(const CKeyID &keyid, vAffected) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121540588",
      "id" : 121540588,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 71,
      "path" : "src/wallet/wallet.cpp",
      "position" : 71,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121540588",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121541385"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121541385"
         }
      },
      "body" : "I don't think there's any need to change the indentation here",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:21:34Z",
      "diff_hunk" : "@@ -1115,29 +1169,41 @@ void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pin\n }\n \n void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n+    if (fSyncPausedUntilKeypoolExt) return;\n     LOCK2(cs_main, cs_wallet);\n     SyncTransaction(ptx);\n }\n \n-void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n-    LOCK2(cs_main, cs_wallet);\n-    // TODO: Temporarily ensure that mempool removals are notified before\n-    // connected transactions.  This shouldn't matter, but the abandoned\n-    // state of transactions in our wallet is currently cleared when we\n-    // receive another notification and there is a race condition where\n-    // notification of a connected conflict might cause an outside process\n-    // to abandon a transaction and then have it inadvertently cleared by\n-    // the notification that the conflicted transaction was evicted.\n-\n-    for (const CTransactionRef& ptx : vtxConflicted) {\n-        SyncTransaction(ptx);\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted, bool &requestPause) {\n+    if (fSyncPausedUntilKeypoolExt) {\n+        requestPause = true;\n+        return;\n     }\n-    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n-        SyncTransaction(pblock->vtx[i], pindex, i);\n+\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121541385",
      "id" : 121541385,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 111,
      "path" : "src/wallet/wallet.cpp",
      "position" : 111,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121541385",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121541946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121541946"
         }
      },
      "body" : "As you note, this doesn't work with multiwallet, which has now been merged. I think the `setBlockRequestsPaused()` and `setTipUpdatesPaused()` logic will now need to be updated to store the BlockRequests and TipUpdates state for each of the wallets.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:25:14Z",
      "diff_hunk" : "@@ -1350,6 +1416,57 @@ bool CWallet::IsHDEnabled() const\n     return !hdChain.masterKeyID.IsNull();\n }\n \n+void CWallet::EventuallyRescanAfterKeypoolTopUp() {\n+    if (fSyncPausedUntilKeypoolExt) {\n+\n+        // for now, enable block requests and tip updates via the states\n+        // this will only be sufficient as long as only a single wallet adjusts these stats\n+        // switch to counters (instead of a single boolean state) could solve this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121541946",
      "id" : 121541946,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 147,
      "path" : "src/wallet/wallet.cpp",
      "position" : 147,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121541946",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121542001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121542001"
         }
      },
      "body" : "nit: braces",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:25:35Z",
      "diff_hunk" : "@@ -1350,6 +1416,57 @@ bool CWallet::IsHDEnabled() const\n     return !hdChain.masterKeyID.IsNull();\n }\n \n+void CWallet::EventuallyRescanAfterKeypoolTopUp() {\n+    if (fSyncPausedUntilKeypoolExt) {\n+\n+        // for now, enable block requests and tip updates via the states\n+        // this will only be sufficient as long as only a single wallet adjusts these stats\n+        // switch to counters (instead of a single boolean state) could solve this\n+        ::setBlockRequestsPaused(false);\n+        ::setTipUpdatesPaused(false);\n+\n+        // disabled the per-wallet pause\n+        fSyncPausedUntilKeypoolExt = false;\n+\n+        const CChainParams& chainparams = Params();\n+        CValidationState state;\n+        if (!ActivateBestChain(state, chainparams)) {\n+            LogPrintf(\"Failed to connect best block\");\n+            StartShutdown();\n+        }\n+\n+        CBlockIndex *pindexRescan = chainActive.Genesis();\n+        CWalletDB walletdb(*dbw);\n+        CBlockLocator locator;\n+        if (walletdb.ReadBestBlock(locator))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121542001",
      "id" : 121542001,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 164,
      "path" : "src/wallet/wallet.cpp",
      "position" : 164,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121542001",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121542158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121542158"
         }
      },
      "body" : "nit: braces",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:26:32Z",
      "diff_hunk" : "@@ -1350,6 +1416,57 @@ bool CWallet::IsHDEnabled() const\n     return !hdChain.masterKeyID.IsNull();\n }\n \n+void CWallet::EventuallyRescanAfterKeypoolTopUp() {\n+    if (fSyncPausedUntilKeypoolExt) {\n+\n+        // for now, enable block requests and tip updates via the states\n+        // this will only be sufficient as long as only a single wallet adjusts these stats\n+        // switch to counters (instead of a single boolean state) could solve this\n+        ::setBlockRequestsPaused(false);\n+        ::setTipUpdatesPaused(false);\n+\n+        // disabled the per-wallet pause\n+        fSyncPausedUntilKeypoolExt = false;\n+\n+        const CChainParams& chainparams = Params();\n+        CValidationState state;\n+        if (!ActivateBestChain(state, chainparams)) {\n+            LogPrintf(\"Failed to connect best block\");\n+            StartShutdown();\n+        }\n+\n+        CBlockIndex *pindexRescan = chainActive.Genesis();\n+        CWalletDB walletdb(*dbw);\n+        CBlockLocator locator;\n+        if (walletdb.ReadBestBlock(locator))\n+            pindexRescan = FindForkInGlobalIndex(chainActive, locator);\n+\n+        if (chainActive.Tip() && chainActive.Tip() != pindexRescan)\n+        {\n+            //We can't rescan beyond non-pruned blocks, stop and throw an error\n+            //this might happen if a user uses a old wallet within a pruned node\n+            // or if he ran -disablewallet for a longer time, then decided to re-enable\n+            if (fPruneMode)\n+            {\n+                CBlockIndex *block = chainActive.Tip();\n+                while (block && block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA) && block->pprev->nTx > 0 && pindexRescan != block)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121542158",
      "id" : 121542158,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 175,
      "path" : "src/wallet/wallet.cpp",
      "position" : 175,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121542158",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "Needs rebase.",
      "created_at" : "2017-06-12T22:31:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#issuecomment-307952392",
      "id" : 307952392,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10240",
      "updated_at" : "2017-06-12T22:31:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/307952392",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121544508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121544508"
         }
      },
      "body" : "I don't think you need to set `fSyncPausedUntilKeypoolExt` and log here, since the call to `CheckKeypoolMinSize()` below will catch when the keypool is too small.\r\n\r\nI think this also prevents `-hdignoregaplimit` from working, since `TopUpKeyPool()` returns false without checking that argument.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:41:10Z",
      "diff_hunk" : "@@ -3317,14 +3441,77 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+bool CWallet::CheckKeypoolMinSize() {\n+    LOCK(cs_wallet);\n+    size_t extKeypoolSize = KeypoolCountExternalKeys();\n+    if (!GetBoolArg(\"-hdignoregaplimit\", DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE) && IsHDEnabled() && (extKeypoolSize < HD_RESTORE_KEYPOOL_SIZE_MIN || (setKeyPool.size()-extKeypoolSize) < HD_RESTORE_KEYPOOL_SIZE_MIN)) {\n+        // if the remaining keypool size is below the gap limit, refuse to continue with the sync\n+        fSyncPausedUntilKeypoolExt = true;\n+        LogPrintf(\"%s: Keypool ran below min size, pause wallet sync\\n\", __func__);\n+        return false;\n+    }\n+    return true;\n+}\n+\n+void CWallet::MarkReserveKeysAsUsed(const CKeyID& keyId)\n+{\n+    LOCK(cs_wallet);\n+    CWalletDB walletdb(*dbw);\n+    auto it = std::begin(setKeyPool);\n+\n+    bool foundInternal = false;\n+    int64_t foundIndex = -1;\n+    for (const int64_t& id : setKeyPool) {\n+        CKeyPool keypool;\n+        if (!walletdb.ReadPool(id, keypool))\n+            throw std::runtime_error(std::string(__func__) + \": read failed\");\n+\n+        if (keypool.vchPubKey.GetID() == keyId) {\n+            foundInternal = keypool.fInternal;\n+            foundIndex = id;\n+            if (!keypool.fInternal) {\n+                SetAddressBook(keyId, \"\", \"receive\");\n+            }\n+            break;\n+        }\n+    }\n+\n+    // mark all keys up to the found key as used\n+    if (foundIndex >= 0) {\n+        while (it != std::end(setKeyPool)) {\n+            const int64_t& id = *(it);\n+            if (id <= foundIndex) {\n+                CKeyPool keypool;\n+                if (!walletdb.ReadPool(id, keypool))\n+                    throw std::runtime_error(std::string(__func__) + \": read failed\");\n+\n+                // only mark keys on the corresponding chain\n+                if (keypool.fInternal == foundInternal) {\n+                    KeepKey(id);\n+                    it = setKeyPool.erase(it);\n+                    continue;\n+                }\n+            }\n+            ++it;\n+        }\n+    }\n+\n+    if (IsHDEnabled() && !TopUpKeyPool()) {\n+        fSyncPausedUntilKeypoolExt = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121544508",
      "id" : 121544508,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 284,
      "path" : "src/wallet/wallet.cpp",
      "position" : 284,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121544508",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121544804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121544804"
         }
      },
      "body" : "> I think \"pause sync when keypool is smaller than\" is clearer than \"ignore hd gap limit\"\r\n\r\n:+1:\r\n\r\nnit: place this argument in the correct alphabetic order.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:43:05Z",
      "diff_hunk" : "@@ -3764,6 +3764,7 @@ std::string CWallet::GetWalletHelpString(bool showDebug)\n         strUsage += HelpMessageOpt(\"-flushwallet\", strprintf(\"Run a thread to flush wallet periodically (default: %u)\", DEFAULT_FLUSHWALLET));\n         strUsage += HelpMessageOpt(\"-privdb\", strprintf(\"Sets the DB_PRIVATE flag in the wallet db environment (default: %u)\", DEFAULT_WALLET_PRIVDB));\n         strUsage += HelpMessageOpt(\"-walletrejectlongchains\", strprintf(_(\"Wallet will not create transactions that violate mempool chain limits (default: %u)\"), DEFAULT_WALLET_REJECT_LONG_CHAINS));\n+        strUsage += HelpMessageOpt(\"-hdignoregaplimit\", strprintf(_(\"Ignores the minimum keypool-size warning for HD restore (default: %u)\"), DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121544804",
      "id" : 121544804,
      "original_commit_id" : "cada7263fa95dff17ec2bab3b3b081cfdec2ae8e",
      "original_position" : 13,
      "path" : "src/wallet/wallet.cpp",
      "position" : 346,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121544804",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121545265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121545265"
         }
      },
      "body" : "I don't understand why you're calling `TopUpKeyPool()` here only if -keypool >= HD_RESTORE_KEYPOOL_SIZE_MIN or hdignoregaplimit is set.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:46:09Z",
      "diff_hunk" : "@@ -3725,6 +3881,19 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n \n     RegisterValidationInterface(walletInstance);\n \n+    // HD Restore: Make sure we always have a reasonable keypool size if HD is enabled\n+    if (walletInstance->IsHDEnabled()) {\n+        if (GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE) < HD_RESTORE_KEYPOOL_SIZE_MIN && !GetBoolArg(\"-hdignoregaplimit\", DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE)) {\n+            LogPrintf(\"Parameter Interaction: set keypool to required minimum for encrypted wallets (%d)\\n\", HD_RESTORE_KEYPOOL_SIZE_MIN);\n+            SoftSetArg(\"-keypool\", std::to_string(HD_RESTORE_KEYPOOL_SIZE_MIN));\n+        }\n+        else {\n+            walletInstance->TopUpKeyPool();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121545265",
      "id" : 121545265,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 361,
      "path" : "src/wallet/wallet.cpp",
      "position" : 361,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121545265",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121545587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121545587"
         }
      },
      "body" : "`-hdignoregaplimit` is checked within `CheckKeypoolMinSize()` so I don't think you need it here (CheckKeypoolMinSize() will not return false if `-hdignoregaplimit` is true)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:48:25Z",
      "diff_hunk" : "@@ -3725,6 +3881,19 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n \n     RegisterValidationInterface(walletInstance);\n \n+    // HD Restore: Make sure we always have a reasonable keypool size if HD is enabled\n+    if (walletInstance->IsHDEnabled()) {\n+        if (GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE) < HD_RESTORE_KEYPOOL_SIZE_MIN && !GetBoolArg(\"-hdignoregaplimit\", DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE)) {\n+            LogPrintf(\"Parameter Interaction: set keypool to required minimum for encrypted wallets (%d)\\n\", HD_RESTORE_KEYPOOL_SIZE_MIN);\n+            SoftSetArg(\"-keypool\", std::to_string(HD_RESTORE_KEYPOOL_SIZE_MIN));\n+        }\n+        else {\n+            walletInstance->TopUpKeyPool();\n+        }\n+        if (!walletInstance->CheckKeypoolMinSize() && !GetBoolArg(\"-hdignoregaplimit\", DEFAULT_IGNORE_HD_MIN_KEYPOOL_SIZE)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121545587",
      "id" : 121545587,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 363,
      "path" : "src/wallet/wallet.cpp",
      "position" : 363,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121545587",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121545860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121545860"
         }
      },
      "body" : "Why does this need to be changed for creating the cache directories?",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:50:10Z",
      "diff_hunk" : "@@ -285,7 +285,7 @@ def _initialize_chain(self, test_dir, num_nodes, cachedir):\n             # Create cache directories, run bitcoinds:\n             for i in range(MAX_NODES):\n                 datadir = initialize_datadir(cachedir, i)\n-                args = [os.getenv(\"BITCOIND\", \"bitcoind\"), \"-server\", \"-keypool=1\", \"-datadir=\" + datadir, \"-discover=0\"]\n+                args = [os.getenv(\"BITCOIND\", \"bitcoind\"), \"-server\", \"-keypool=1\", \"-hdignoregaplimit\", \"-datadir=\" + datadir, \"-discover=0\"]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121545860",
      "id" : 121545860,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 5,
      "path" : "test/functional/test_framework/test_framework.py",
      "position" : 5,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121545860",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546032"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546032"
         }
      },
      "body" : "I don't think you should be changing this command line argument for all tests.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:51:14Z",
      "diff_hunk" : "@@ -234,7 +234,7 @@ def start_node(i, dirname, extra_args=None, rpchost=None, timewait=None, binary=\n     datadir = os.path.join(dirname, \"node\"+str(i))\n     if binary is None:\n         binary = os.getenv(\"BITCOIND\", \"bitcoind\")\n-    args = [binary, \"-datadir=\" + datadir, \"-server\", \"-keypool=1\", \"-discover=0\", \"-rest\", \"-logtimemicros\", \"-debug\", \"-debugexclude=libevent\", \"-debugexclude=leveldb\", \"-mocktime=\" + str(get_mocktime()), \"-uacomment=testnode%d\" % i]\n+    args = [binary, \"-datadir=\" + datadir, \"-server\", \"-keypool=1\", \"-hdignoregaplimit\", \"-discover=0\", \"-rest\", \"-logtimemicros\", \"-debug\", \"-debugexclude=libevent\", \"-debugexclude=leveldb\", \"-mocktime=\" + str(get_mocktime()), \"-uacomment=testnode%d\" % i]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546032",
      "id" : 121546032,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 5,
      "path" : "test/functional/test_framework/util.py",
      "position" : 5,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546032",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546057"
         }
      },
      "body" : "remove duplicate",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:51:25Z",
      "diff_hunk" : "@@ -53,6 +53,8 @@\n     # Scripts that are run by the travis build process.\n     # Longest test should go first, to favor running tests in parallel\n     'wallet-hd.py',\n+    'wallet-hd-restore.py',\n+    'wallet-hd-restore.py',",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546057",
      "id" : 121546057,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 5,
      "path" : "test/functional/test_runner.py",
      "position" : 5,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546057",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546151"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546151"
         }
      },
      "body" : "Please update docstring to describe what this test is doing (I think you copied this directly from wallet-hd.py)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:52:06Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test Hierarchical Deterministic wallet function.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546151",
      "id" : 121546151,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 5,
      "path" : "test/functional/wallet-hd-restore.py",
      "position" : 5,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546151",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546215"
         }
      },
      "body" : "Please order imports in PEP8 ordering (std library, then 3rd party libraries, then local imports)",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:52:30Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test Hierarchical Deterministic wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546215",
      "id" : 121546215,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 7,
      "path" : "test/functional/wallet-hd-restore.py",
      "position" : 7,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546215",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546260"
         }
      },
      "body" : "import not used",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:52:48Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test Hierarchical Deterministic wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import os\n+import shutil\n+from pprint import pprint",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546260",
      "id" : 121546260,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 11,
      "path" : "test/functional/wallet-hd-restore.py",
      "position" : 11,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546260",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546394"
         }
      },
      "body" : "you can set `self.extra_args` here, and then you won't need to override the `setup_network()` method below (the test framework will take care of everything if you set the extra_args here.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:53:47Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test Hierarchical Deterministic wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import os\n+import shutil\n+from pprint import pprint\n+\n+class WalletHDRestoreTest(BitcoinTestFramework):\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.node_args = [['-usehd=0'], ['-usehd=1', '-keypool=100', '-hdignoregaplimit=0']]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546394",
      "id" : 121546394,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 19,
      "path" : "test/functional/wallet-hd-restore.py",
      "position" : 19,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546394",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546471"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546471"
         }
      },
      "body" : "Please use self.log.info() instead of print for logging.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:54:15Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test Hierarchical Deterministic wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import os\n+import shutil\n+from pprint import pprint\n+\n+class WalletHDRestoreTest(BitcoinTestFramework):\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.node_args = [['-usehd=0'], ['-usehd=1', '-keypool=100', '-hdignoregaplimit=0']]\n+\n+    def setup_network(self):\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, self.node_args)\n+        self.is_network_split = False\n+        connect_nodes_bi(self.nodes, 0, 1)\n+\n+    def run_test (self):\n+        tmpdir = self.options.tmpdir\n+\n+        print(\"Initialize wallet including backups of unencrypted and encrypted wallet\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546471",
      "id" : 121546471,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 29,
      "path" : "test/functional/wallet-hd-restore.py",
      "position" : 29,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546471",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546980"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546980"
         }
      },
      "body" : "Suggest you set the timeout higher, perhaps to 60 seconds. Tests should be robust to bitcoind hanging for several seconds, especially if running in parallel on Travis.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T22:58:12Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test Hierarchical Deterministic wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import os\n+import shutil\n+from pprint import pprint\n+\n+class WalletHDRestoreTest(BitcoinTestFramework):\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.node_args = [['-usehd=0'], ['-usehd=1', '-keypool=100', '-hdignoregaplimit=0']]\n+\n+    def setup_network(self):\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, self.node_args)\n+        self.is_network_split = False\n+        connect_nodes_bi(self.nodes, 0, 1)\n+\n+    def run_test (self):\n+        tmpdir = self.options.tmpdir\n+\n+        print(\"Initialize wallet including backups of unencrypted and encrypted wallet\")\n+        # stop and backup original wallet (only keypool has been initialized)\n+        self.stop_node(1)\n+        shutil.copyfile(tmpdir + \"/node1/regtest/wallet.dat\", tmpdir + \"/hd.bak\")\n+\n+        # start again and encrypt wallet\n+        self.nodes[1] = start_node(1, self.options.tmpdir, self.node_args[1])\n+        self.nodes[1].encryptwallet('test')\n+        bitcoind_processes[1].wait()\n+        # node will be stopped during encryption, now do a backup\n+        shutil.copyfile(tmpdir + \"/node1/regtest/wallet.dat\", tmpdir + \"/hd.enc.bak\") \n+\n+        # start the node with encrypted wallet, get address in new pool at pos 50 (over the gap limit)\n+        self.nodes[1] = start_node(1, self.options.tmpdir, self.node_args[1])\n+        for _ in range(50):\n+            addr_enc_oldpool = self.nodes[1].getnewaddress()\n+\n+        # now make sure we retrive an address in the extended pool\n+        self.nodes[1].walletpassphrase(\"test\", 10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121546980",
      "id" : 121546980,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 47,
      "path" : "test/functional/wallet-hd-restore.py",
      "position" : 47,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121546980",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121547328"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121547328"
         }
      },
      "body" : "please don't do this! It erases the debug.log file. Are you able to be more targeted in what you're erasing?",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T23:00:35Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test Hierarchical Deterministic wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import os\n+import shutil\n+from pprint import pprint\n+\n+class WalletHDRestoreTest(BitcoinTestFramework):\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.node_args = [['-usehd=0'], ['-usehd=1', '-keypool=100', '-hdignoregaplimit=0']]\n+\n+    def setup_network(self):\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, self.node_args)\n+        self.is_network_split = False\n+        connect_nodes_bi(self.nodes, 0, 1)\n+\n+    def run_test (self):\n+        tmpdir = self.options.tmpdir\n+\n+        print(\"Initialize wallet including backups of unencrypted and encrypted wallet\")\n+        # stop and backup original wallet (only keypool has been initialized)\n+        self.stop_node(1)\n+        shutil.copyfile(tmpdir + \"/node1/regtest/wallet.dat\", tmpdir + \"/hd.bak\")\n+\n+        # start again and encrypt wallet\n+        self.nodes[1] = start_node(1, self.options.tmpdir, self.node_args[1])\n+        self.nodes[1].encryptwallet('test')\n+        bitcoind_processes[1].wait()\n+        # node will be stopped during encryption, now do a backup\n+        shutil.copyfile(tmpdir + \"/node1/regtest/wallet.dat\", tmpdir + \"/hd.enc.bak\") \n+\n+        # start the node with encrypted wallet, get address in new pool at pos 50 (over the gap limit)\n+        self.nodes[1] = start_node(1, self.options.tmpdir, self.node_args[1])\n+        for _ in range(50):\n+            addr_enc_oldpool = self.nodes[1].getnewaddress()\n+\n+        # now make sure we retrive an address in the extended pool\n+        self.nodes[1].walletpassphrase(\"test\", 10)\n+        for _ in range(80):\n+            addr_enc_extpool = self.nodes[1].getnewaddress()\n+\n+        # stop and load initial backup of the unencrypted wallet\n+        self.stop_node(1)\n+        os.remove(tmpdir + \"/node1/regtest/wallet.dat\")\n+        shutil.copyfile(tmpdir + \"/hd.bak\", tmpdir + \"/node1/regtest/wallet.dat\")\n+        self.nodes[1] = start_node(1, self.options.tmpdir, self.node_args[1])\n+        connect_nodes_bi(self.nodes,0,1)\n+        for _ in range(10):\n+            addr = self.nodes[1].getnewaddress()\n+\n+        self.nodes[0].generate(101)\n+        addr = self.nodes[1].getnewaddress()\n+        assert_equal(self.nodes[1].validateaddress(addr)['hdkeypath'], \"m/0'/0'/11'\")\n+\n+        rawch = self.nodes[1].getrawchangeaddress()\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\n+        n0addr = self.nodes[0].getnewaddress()\n+        txdata = self.nodes[0].createrawtransaction([], {rawch : 2.0, n0addr: 3.0})\n+\n+        txdata_f = self.nodes[0].fundrawtransaction(txdata)\n+        txdata_s = self.nodes[0].signrawtransaction(txdata_f['hex'])\n+        txid = self.nodes[0].sendrawtransaction(txdata_s['hex'])\n+\n+        self.sync_all()\n+        self.nodes[0].generate(1)\n+        self.sync_all()\n+\n+        assert_equal(self.nodes[1].getbalance(), 3)\n+        assert_equal(self.nodes[1].listtransactions()[0]['category'], \"receive\")\n+\n+        print(\"Testing with unencrypted wallet\")\n+        self.stop_node(1)\n+        shutil.rmtree(tmpdir + \"/node1/regtest\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121547328",
      "id" : 121547328,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 82,
      "path" : "test/functional/wallet-hd-restore.py",
      "position" : 82,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121547328",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121547598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121547598"
         }
      },
      "body" : "`txid` isn't used. No need to assign it here or below.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T23:02:31Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test Hierarchical Deterministic wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import os\n+import shutil\n+from pprint import pprint\n+\n+class WalletHDRestoreTest(BitcoinTestFramework):\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.node_args = [['-usehd=0'], ['-usehd=1', '-keypool=100', '-hdignoregaplimit=0']]\n+\n+    def setup_network(self):\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, self.node_args)\n+        self.is_network_split = False\n+        connect_nodes_bi(self.nodes, 0, 1)\n+\n+    def run_test (self):\n+        tmpdir = self.options.tmpdir\n+\n+        print(\"Initialize wallet including backups of unencrypted and encrypted wallet\")\n+        # stop and backup original wallet (only keypool has been initialized)\n+        self.stop_node(1)\n+        shutil.copyfile(tmpdir + \"/node1/regtest/wallet.dat\", tmpdir + \"/hd.bak\")\n+\n+        # start again and encrypt wallet\n+        self.nodes[1] = start_node(1, self.options.tmpdir, self.node_args[1])\n+        self.nodes[1].encryptwallet('test')\n+        bitcoind_processes[1].wait()\n+        # node will be stopped during encryption, now do a backup\n+        shutil.copyfile(tmpdir + \"/node1/regtest/wallet.dat\", tmpdir + \"/hd.enc.bak\") \n+\n+        # start the node with encrypted wallet, get address in new pool at pos 50 (over the gap limit)\n+        self.nodes[1] = start_node(1, self.options.tmpdir, self.node_args[1])\n+        for _ in range(50):\n+            addr_enc_oldpool = self.nodes[1].getnewaddress()\n+\n+        # now make sure we retrive an address in the extended pool\n+        self.nodes[1].walletpassphrase(\"test\", 10)\n+        for _ in range(80):\n+            addr_enc_extpool = self.nodes[1].getnewaddress()\n+\n+        # stop and load initial backup of the unencrypted wallet\n+        self.stop_node(1)\n+        os.remove(tmpdir + \"/node1/regtest/wallet.dat\")\n+        shutil.copyfile(tmpdir + \"/hd.bak\", tmpdir + \"/node1/regtest/wallet.dat\")\n+        self.nodes[1] = start_node(1, self.options.tmpdir, self.node_args[1])\n+        connect_nodes_bi(self.nodes,0,1)\n+        for _ in range(10):\n+            addr = self.nodes[1].getnewaddress()\n+\n+        self.nodes[0].generate(101)\n+        addr = self.nodes[1].getnewaddress()\n+        assert_equal(self.nodes[1].validateaddress(addr)['hdkeypath'], \"m/0'/0'/11'\")\n+\n+        rawch = self.nodes[1].getrawchangeaddress()\n+        txid = self.nodes[0].sendtoaddress(addr, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121547598",
      "id" : 121547598,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 65,
      "path" : "test/functional/wallet-hd-restore.py",
      "position" : 65,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121547598",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121548023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121548023"
         }
      },
      "body" : "I'm also confused about why wallet-hd.py needs to be updated.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-06-12T23:05:12Z",
      "diff_hunk" : "@@ -75,10 +75,12 @@ def run_test (self):\n \n         self.log.info(\"Restore backup ...\")\n         self.stop_node(1)\n-        os.remove(self.options.tmpdir + \"/node1/regtest/wallet.dat\")\n+        # we need to delete the complete regtest directory\n+        # otherwise node1 would auto-recover all funds in flag the keypool keys as used",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r121548023",
      "id" : 121548023,
      "original_commit_id" : "cada7263fa95dff17ec2bab3b3b081cfdec2ae8e",
      "original_position" : 6,
      "path" : "test/functional/wallet-hd.py",
      "position" : 6,
      "pull_request_review_id" : 43576283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-06-12T23:06:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/121548023",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "Will begin code review post rebase.\r\n\r\nQuestion about the parameters--  Why 20? that is very small,  I am not aware of any reason to not have it be more like-- say-- 10,000.   With a large number the pause is hopefully seldom/never hit.  Electrum uses a very small number because its a single user wallet and has to send all these addresses for processing to a remote server.   In a commercial application getting reordering beyond 20 would be very easy. (e.g hand out 30 keys to different users and only the first one makes a payment). ",
      "created_at" : "2017-06-15T20:05:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#issuecomment-308851475",
      "id" : 308851475,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10240",
      "updated_at" : "2017-06-15T20:05:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/308851475",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Agree that 20 is probably way to low.\r\nIt's just a single constant and I worry more about getting the PR on a level where everything works as expected. Changing the 20 to 1000 then is simple... once the PR is stable, we can also test performance better (maybe between 20 and 10k).",
      "created_at" : "2017-06-15T20:27:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#issuecomment-308856449",
      "id" : 308856449,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10240",
      "updated_at" : "2017-06-15T20:27:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/308856449",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r127095122"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127095122"
         }
      },
      "body" : "Please address.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-07-12T23:10:44Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test Hierarchical Deterministic wallet function.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r127095122",
      "id" : 127095122,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 5,
      "path" : "test/functional/wallet-hd-restore.py",
      "position" : 5,
      "pull_request_review_id" : 49644483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-07-12T23:18:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127095122",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r127095162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127095162"
         }
      },
      "body" : "Please address.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-07-12T23:11:07Z",
      "diff_hunk" : "@@ -0,0 +1,162 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test Hierarchical Deterministic wallet function.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+import os\n+import shutil\n+from pprint import pprint\n+\n+class WalletHDRestoreTest(BitcoinTestFramework):\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.node_args = [['-usehd=0'], ['-usehd=1', '-keypool=100', '-hdignoregaplimit=0']]\n+\n+    def setup_network(self):\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, self.node_args)\n+        self.is_network_split = False\n+        connect_nodes_bi(self.nodes, 0, 1)\n+\n+    def run_test (self):\n+        tmpdir = self.options.tmpdir\n+\n+        print(\"Initialize wallet including backups of unencrypted and encrypted wallet\")\n+        # stop and backup original wallet (only keypool has been initialized)\n+        self.stop_node(1)\n+        shutil.copyfile(tmpdir + \"/node1/regtest/wallet.dat\", tmpdir + \"/hd.bak\")\n+\n+        # start again and encrypt wallet\n+        self.nodes[1] = start_node(1, self.options.tmpdir, self.node_args[1])\n+        self.nodes[1].encryptwallet('test')\n+        bitcoind_processes[1].wait()\n+        # node will be stopped during encryption, now do a backup\n+        shutil.copyfile(tmpdir + \"/node1/regtest/wallet.dat\", tmpdir + \"/hd.enc.bak\") \n+\n+        # start the node with encrypted wallet, get address in new pool at pos 50 (over the gap limit)\n+        self.nodes[1] = start_node(1, self.options.tmpdir, self.node_args[1])\n+        for _ in range(50):\n+            addr_enc_oldpool = self.nodes[1].getnewaddress()\n+\n+        # now make sure we retrive an address in the extended pool\n+        self.nodes[1].walletpassphrase(\"test\", 10)\n+        for _ in range(80):\n+            addr_enc_extpool = self.nodes[1].getnewaddress()\n+\n+        # stop and load initial backup of the unencrypted wallet\n+        self.stop_node(1)\n+        os.remove(tmpdir + \"/node1/regtest/wallet.dat\")\n+        shutil.copyfile(tmpdir + \"/hd.bak\", tmpdir + \"/node1/regtest/wallet.dat\")\n+        self.nodes[1] = start_node(1, self.options.tmpdir, self.node_args[1])\n+        connect_nodes_bi(self.nodes,0,1)\n+        for _ in range(10):\n+            addr = self.nodes[1].getnewaddress()\n+\n+        self.nodes[0].generate(101)\n+        addr = self.nodes[1].getnewaddress()\n+        assert_equal(self.nodes[1].validateaddress(addr)['hdkeypath'], \"m/0'/0'/11'\")\n+\n+        rawch = self.nodes[1].getrawchangeaddress()\n+        txid = self.nodes[0].sendtoaddress(addr, 1)\n+        n0addr = self.nodes[0].getnewaddress()\n+        txdata = self.nodes[0].createrawtransaction([], {rawch : 2.0, n0addr: 3.0})\n+\n+        txdata_f = self.nodes[0].fundrawtransaction(txdata)\n+        txdata_s = self.nodes[0].signrawtransaction(txdata_f['hex'])\n+        txid = self.nodes[0].sendrawtransaction(txdata_s['hex'])\n+\n+        self.sync_all()\n+        self.nodes[0].generate(1)\n+        self.sync_all()\n+\n+        assert_equal(self.nodes[1].getbalance(), 3)\n+        assert_equal(self.nodes[1].listtransactions()[0]['category'], \"receive\")\n+\n+        print(\"Testing with unencrypted wallet\")\n+        self.stop_node(1)\n+        shutil.rmtree(tmpdir + \"/node1/regtest\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r127095162",
      "id" : 127095162,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 82,
      "path" : "test/functional/wallet-hd-restore.py",
      "position" : 82,
      "pull_request_review_id" : 49644483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-07-12T23:18:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127095162",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r127095281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127095281"
         }
      },
      "body" : "Nit: else on the same line as `}`",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-07-12T23:11:48Z",
      "diff_hunk" : "@@ -3725,6 +3793,19 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n \n     RegisterValidationInterface(walletInstance);\n \n+    // HD Restore: Make sure we always have a reasonable keypool size if HD is enabled\n+    if (walletInstance->IsHDEnabled()) {\n+        if (walletInstance->IsCrypted()) {\n+            InitWarning(_(\"Your are using an encrypted HD wallet. In case you recover a HD wallet, you may miss incomming or outgoing funds.\"));\n+        }\n+        else {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r127095281",
      "id" : 127095281,
      "original_commit_id" : "2a203b73fd2d7b016cd5f55977135a15a982414d",
      "original_position" : 100,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 49644483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-07-12T23:18:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127095281",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r127095453"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127095453"
         }
      },
      "body" : "Please address.",
      "commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "created_at" : "2017-07-12T23:12:57Z",
      "diff_hunk" : "@@ -480,6 +480,9 @@ void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vector<con\n     // Make sure pindexBestKnownBlock is up to date, we'll need it.\n     ProcessBlockAvailability(nodeid);\n \n+    if (isBlockRequestsPaused())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#discussion_r127095453",
      "id" : 127095453,
      "original_commit_id" : "4cbc21689c359fee67e877355c04f808b2f749d6",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 49644483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10240",
      "updated_at" : "2017-07-12T23:18:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127095453",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Closing in favor of #10830",
      "created_at" : "2017-07-14T21:22:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10240#issuecomment-315471237",
      "id" : 315471237,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10240",
      "updated_at" : "2017-07-14T21:22:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315471237",
      "user" : {
         "avatar_url" : "https://avatars7.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   }
]
