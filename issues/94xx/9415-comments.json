[
   {
      "body" : "There's so much currently wrong with this loop that I'm hesitant to make changes before rewriting it entirely. I've been discussing my plans with @TheBlueMatt for doing just that after #9289 is merged.\r\n\r\nSome other fun issues with this loop (I'm sure I'm leaving several out):\r\n- messageHandlerCondition wakes spuriously\r\n- The depth of vRecvGetData and messages to send aren't taken into consideration\r\n- cs_vRecvMsg is held for the duration of message processing, leading to insane lock contention\r\n\r\nI have no objections to slapping some band-aids on here, but I'm really really hoping to address all of those at once in my next PR which moves this handler into net_processing. As a bonus, it should simplify @TheBlueMatt's multi-threaded processing.",
      "created_at" : "2016-12-24T07:41:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269073566",
      "id" : 269073566,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-24T07:41:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269073566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "> messageHandlerCondition wakes spuriously\r\n\r\nwho cares? :) It's not like this loop or processing that results from random wakes ever shows up in profiles. \r\n\r\nIf it were a real concern it would be easy to go back to sleep if the boolean hasn't been flipped and not enough time has passed.\r\n\r\n>  but I'm really really hoping to address all of those at once in my next PR which moves this handler into net_processing.\r\n\r\nMy guess is that we may be a bit close to the end of 0.14 to achieve much more in the way of big changes, especially ones with difficult to test concurrency implications.  I just don't want efforts to make big sweeping changes to stand in the way of meaningful improvement-- we probably should have made the changes in this PR a year ago.\r\n\r\nI'm reviewing 9289-- hopefully we can get that in soon.\r\n",
      "created_at" : "2016-12-24T22:19:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269102470",
      "id" : 269102470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-24T22:19:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269102470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "I'm hoping the next PR isn't huge in the way of complicated locking implications, more like simplified locking implications compared to master. Let's wait and take a look next week (and if we decide it can't make it we can come back to here - I think the potential advantage in initial from-network sync time from \"doing it right\" might be worth the extra review/testing implications).\n\nOn December 24, 2016 5:19:59 PM EST, Gregory Maxwell <notifications@github.com> wrote:\n>> messageHandlerCondition wakes spuriously\n>\n>who cares? :) It's not like this loop or processing that results from\n>random wakes ever shows up in profiles. \n>\n>If it were a real concern it would be easy to go back to sleep if the\n>boolean hasn't been flipped and not enough time has passed.\n>\n>>  but I'm really really hoping to address all of those at once in my\n>next PR which moves this handler into net_processing.\n>\n>My guess is that we may be a bit close to the end of 0.14 to achieve\n>much more in the way of big changes, especially ones with difficult to\n>test concurrency implications.  I just don't want efforts to make big\n>sweeping changes to stand in the way of meaningful improvement-- we\n>probably should have made the changes in this PR a year ago.\n>\n>I'm reviewing 9289-- hopefully we can get that in soon.\n>\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269102470\n",
      "created_at" : "2016-12-24T22:33:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269102850",
      "id" : 269102850,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-24T22:33:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269102850",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "> who cares? :) It's not like this loop or processing that results from random wakes ever shows up in profiles.\r\n\r\nMy concern was moreso that some platforms (win32) may vary significantly in this wakeup behavior.\r\n\r\nCompletely agree with you though. I certainly wasn't suggesting that we not take the improvements here for the sake of something coming later. In fact, the wake from the miner is necessary either way. I was just pointing out that I'm hoping to be able to delete most of this code soon anyway :)",
      "created_at" : "2016-12-25T06:00:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269111417",
      "id" : 269111417,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-25T06:00:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269111417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Mystery: this slows the IBD of the first 200k blocks from a local gigabit ethernet connected peer by about 40%. I've run the test 4 times each way, same result.  Maybe if we solve that, we make IBD faster.",
      "created_at" : "2016-12-27T11:52:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269316189",
      "id" : 269316189,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-27T11:52:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269316189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "I bisected my patch down to the  cs_vSend cs_vRecvMsg contention causing fsleep=false to be the cause of the IBD performance regression.",
      "created_at" : "2016-12-27T23:39:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269398595",
      "id" : 269398595,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-27T23:39:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269398595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Ugh, yea, those desperately need splitting. I know @theuni has been working on a patch to do that, see-also https://github.com/bitcoin/bitcoin/pull/9419/commits/c214d120a363a05ba9afdccff6b4bda6e29ae7c4\n\nOn December 28, 2016 12:39:28 AM GMT+01:00, Gregory Maxwell <notifications@github.com> wrote:\n>I bisected my patch down to the  cs_vSend cs_vRecvMsg contention\n>causing fsleep=false to be the cause of the IBD performance regression.\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269398595\n",
      "created_at" : "2016-12-28T11:34:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269465287",
      "id" : 269465287,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-28T11:34:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269465287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "I tested reducing the message handler hold of cs_vrecv lock to be just a narrow space small enough to std::move the message out, and speed up IBD to 200k from a single peer by more than a factor of two over master.",
      "created_at" : "2016-12-29T08:12:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269595765",
      "id" : 269595765,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-29T14:08:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269595765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9415#discussion_r94116433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94116433"
         }
      },
      "body" : "Looping here to process all outstanding messages might not be desirable because it could let a single peer monopolize processing. Any thoughts on that?",
      "commit_id" : "0199fd1afa60801413ad55fbc9f52c95a8fe0048",
      "created_at" : "2016-12-29T09:28:41Z",
      "diff_hunk" : "@@ -2444,36 +2443,36 @@ bool ProcessMessages(CNode* pfrom, CConnman& connman)\n         ProcessGetData(pfrom, chainparams.GetConsensus(), connman);\n \n     // this maintains the order of responses\n-    if (!pfrom->vRecvGetData.empty()) return fOk;\n-\n-    std::deque<CNetMessage>::iterator it = pfrom->vRecvMsg.begin();\n-    while (!pfrom->fDisconnect && it != pfrom->vRecvMsg.end()) {\n-        // Don't bother if send buffer is too full to respond anyway\n-        if (pfrom->nSendSize >= nMaxSendBufferSize)\n-            break;\n-\n-        // get next message\n-        CNetMessage& msg = *it;\n-\n-        //if (fDebug)\n-        //    LogPrintf(\"%s(message %u msgsz, %u bytes, complete:%s)\\n\", __func__,\n-        //            msg.hdr.nMessageSize, msg.vRecv.size(),\n-        //            msg.complete() ? \"Y\" : \"N\");\n-\n-        // end, if an incomplete message is found\n-        if (!msg.complete())\n-            break;\n-\n-        // at this point, any failure means we can delete the current message\n-        it++;\n+    if (!pfrom->vRecvGetData.empty()) {\n+        connman.WakeMessageHandler();\n+        return fOk;\n+    }\n \n-        // Scan for message start\n-        if (memcmp(msg.hdr.pchMessageStart, chainparams.MessageStart(), CMessageHeader::MESSAGE_START_SIZE) != 0) {\n-            LogPrintf(\"PROCESSMESSAGE: INVALID MESSAGESTART %s peer=%d\\n\", SanitizeString(msg.hdr.GetCommand()), pfrom->id);\n-            fOk = false;\n+    while (!pfrom->fDisconnect) {\n+        std::vector<CNetMessage> vMsg;\n+        if (pfrom->nSendSize >= nMaxSendBufferSize) {\n+            connman.WakeMessageHandler();\n             break;\n         }\n+        {\n+            TRY_LOCK(pfrom->cs_vRecvMsg, lockRecv);\n+            if (lockRecv)\n+            {\n+                if (!pfrom->vRecvMsg.empty()) {\n+                    if (!pfrom->vRecvMsg.front().complete()) break;\n+                    // Move the message.\n+                    vMsg.push_back(std::move(pfrom->vRecvMsg.front()));\n+                    if (pfrom->fDisconnect) break;\n+                    pfrom->vRecvMsg.pop_front();\n+                }\n+            } else {\n+                connman.WakeMessageHandler();\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#discussion_r94116433",
      "id" : 94116433,
      "original_commit_id" : "45bd16ea210858051907126540a5b56849cf60f0",
      "original_position" : 63,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 14646739,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9415",
      "updated_at" : "2016-12-29T09:30:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94116433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Sync to 200k with master:  243.7 blocks per second.\r\nWith this PR on the receiver:  465.431 blocks per second.\r\nWith the PR on both sender and receiver: 782.287  (3.2x master's speed).\r\n\r\n(Chainstate reindex is about 1000/s so there is still perhaps some room for improvement.)",
      "created_at" : "2016-12-29T14:51:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269640771",
      "id" : 269640771,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-29T14:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269640771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Looks like weÃ¢ÂÂre stepping on each-other :)\r\n\r\nWeÃ¢ÂÂre definitely working to solve the same issue, though it seems we disagree on the approach. This is less flexible for a clean separation of layers as it requires constant two-way communication between the net layer and the message processor. Done this way, the net must notify the processor that new messages are available, then the processor must grab the messages from the net.\r\n\r\nThe more typical approach (what IÃ¢ÂÂve seen, anyway) is a one-way model where the net throws its messages to the processor, which is forced to consume them. That greatly reduces the risk of the processor throttling the network. It also makes things much easier as processing becomes multi-threaded, because the processor maintains the message queue, as opposed to having each new thread contend with the net lock. So the net side doesnÃ¢ÂÂt care what happens once itÃ¢ÂÂs handed off a message, it only has to have a means of being corked if the processor is at capacity.\r\n\r\nThe last abstraction step (moving processing out of CConnman, as seen [in a quick/dirty attempt here](https://github.com/theuni/bitcoin/commit/1a6b10aea129ac363727c2d68fae809c2861e4da)) relies on this one-way model.\r\n\r\nAll that to say: I prefer the approach in #9441, which yields the same speedups :)",
      "created_at" : "2016-12-29T15:46:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269648692",
      "id" : 269648692,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-29T15:46:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269648692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "I don't follow your two-way comments.  There is communication only one way here: from the ThreadSocketHandler to ThreadMessageHandler  for receive, and the reverse for sending.\r\n\r\nThe processing cannot itself throttle the network (except in terms of the input rate exceeding the processing rate):  Assuming we haven't hit the GetReceiveFloodSize  the only time message processing can stall reception is holding the per-peer lock during a simple move.  The network does let it know new things are available-- allowing it to sleep when there is nothing to do.  \r\n\r\nIf messages were to be handled concurrently, it would be no finer grained than per-peer+per-direction in any case to preserve ordering; which is the granularity of the locks in this configuration. Though message handling takes cs_main for effectively everything, so at the moment there wouldn't really be any gain in making it concurrent.\r\n\r\nPerhaps you're referring to the WakeMessageHandler calls in ProcessMessages?  Those are communication from ThreadMessageHandler to itself-- just reusing the mechanism so that the handler doesn't sleep when there is more work to be done. It could more cleanly be done with a return argument, but the signaling mechanism already exists.\r\n\r\n> which yields the same speedups \r\n\r\nSure takes a lot more code to do it. The purpose of its architecture is unclear to me, I don't see what we're gaining for the extra complexity. ",
      "created_at" : "2016-12-29T16:18:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269653447",
      "id" : 269653447,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-29T16:18:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269653447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "> I don't follow your two-way comments. There is communication only one way here: from the ThreadSocketHandler to ThreadMessageHandler for receive, and the reverse for sending.\r\n\r\nThreadSocketHandler notifies ThreadMessageHandler that it has a new message. \r\nThreadMessageHandler then reaches into the socket handler's buffer to get and remove it. Logically the queue belongs in the processor so that it can delegate intelligently. After all, the net is done with a message as soon as it's come in.\r\n\r\n> Sure takes a lot more code to do it. The purpose of its architecture is unclear to me, I don't see what we're gaining for the extra complexity.\r\n\r\nEh? It's essentially 2 changes. The first changes to use a return value rather than signaling (as you suggested above): https://github.com/bitcoin/bitcoin/pull/9441/commits/1d232f47ab9ad978aa3324e390f8baca1bea72e3\r\n And the second looks much like yours: https://github.com/bitcoin/bitcoin/pull/9441/commits/65e916c499658e656a6e23455f22666fb0068edc\r\n\r\nMaybe you're referring to the boost commits that it's built on? That's only because they touch so much of the same code that I didn't want to have to keep up with rebasing.",
      "created_at" : "2016-12-29T16:45:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269657451",
      "id" : 269657451,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-29T16:45:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269657451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "> After all, the net is done with a message as soon as it's come in.\r\n\r\nI don't think it is-- e.g need to stop reading data off the socket if we have too much queued data. Otherwise the memory usage is unbounded: I don't think going around and lazily asking it to stop is sufficient, as AFAIK we have no guarantee about how much data we can receive between times the message handler will make its way back around to notice that it's too large. E.g. cold caches it can take 5 seconds to validate a block, an on a gigabit link you could receive >500MB of data in that time.  It looks to me like your code handles this-- by having the socket side stay aware of the queue usage. So it's functionally fine, though you end up duplicating the code that does this size management in both message handling and socket handling.\r\n\r\nI don't think that \"belongs\" is even the right way to think about this.  The queue \"belongs\" to the node-- as its the destruction of the node that ultimately destroys the queue.  It is accessed by the socket thread and the message handling thread, for their respective operations.\r\n",
      "created_at" : "2016-12-29T17:12:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269661459",
      "id" : 269661459,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-29T17:17:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269661459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "> I don't think it is its need to stop reading data off the socket if we have too much queued data. Otherwise the memory usage is unbounded: I don't think going around and lazily asking it to stop is sufficient, as AFAIK we have no guarantee about how much data we can receive between times the message handler will make its way back around to notice that it's too large.\r\n\r\nNor do I.\r\n\r\nWith each message, the message handler immediately notifies the socket handler whether it should cork. There's no lag there, it's done atomically with the message hand-off: https://github.com/bitcoin/bitcoin/pull/9441/files#diff-eff7adeaec73a769788bb78858815c91R2463\r\n\r\nIn the refactored code, the cork is the return value of the \"take my message\" function: https://github.com/theuni/bitcoin/commit/1a6b10aea129ac363727c2d68fae809c2861e4da#diff-9a82240fe7dfe86564178691cc57f2f1R1255\r\n\r\n> I don't think that \"belongs\" is even the right way to think about this. The queue \"belongs\" to the node-- as its the destruction of the node that ultimately destroys the queue. It is accessed by the socket thread and the message handling thread, for their respective operations.\r\n\r\nDisagreed. These are two separate layers. The queue could easily outlive the node. For ex, during IBD a node may send 10 blocks and immediately disconnect. There's no requirement that we destroy the queue before deleting the node.",
      "created_at" : "2016-12-29T17:48:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269666581",
      "id" : 269666581,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-29T17:48:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269666581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
