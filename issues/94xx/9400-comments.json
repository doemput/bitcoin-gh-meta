[
   {
      "body" : "Is it still the case that the first peer to send us the header is the only peer we'll request the block from (with a timeout for non-response of 10 minutes)? ",
      "created_at" : "2016-12-21T16:18:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-268564171",
      "id" : 268564171,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-21T16:18:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268564171",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@rebroad This code doesn't change any inv behavior.",
      "created_at" : "2016-12-21T16:21:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-268565152",
      "id" : 268565152,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-21T16:21:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268565152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93580736"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580736"
         }
      },
      "body" : "nit: maybe move the State() check inside MaybeSet...?",
      "commit_id" : "d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2016-12-22T08:12:13Z",
      "diff_hunk" : "@@ -798,6 +803,11 @@ void PeerLogicValidation::BlockChecked(const CBlock& block, const CValidationSta\n                 Misbehaving(it->second.first, nDoS);\n         }\n     }\n+    else if (state.IsValid() && !IsInitialBlockDownload()) {\n+        if (it != mapBlockSource.end() && State(it->second.first)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93580736",
      "id" : 93580736,
      "original_commit_id" : "ee43109e6378c13ee5dff65053419daf2106f888",
      "original_position" : 61,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14110519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400",
      "updated_at" : "2016-12-30T19:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580736",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93582234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93582234"
         }
      },
      "body" : "Ideally this would go in UpdatedBlockTip instead. mapBlockSource wouldn't be available there, but BlockChecked isnt really capturing where we want this - we want to know that this is actually the best currently available block, not just a block that was just checked.\r\n\r\nNot really sure how to fix this - maybe just a mapBlocksInFlight.empty() is sufficient, but its still super ugly.",
      "commit_id" : "d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2016-12-22T08:27:37Z",
      "diff_hunk" : "@@ -798,6 +803,11 @@ void PeerLogicValidation::BlockChecked(const CBlock& block, const CValidationSta\n                 Misbehaving(it->second.first, nDoS);\n         }\n     }\n+    else if (state.IsValid() && !IsInitialBlockDownload()) {\n+        if (it != mapBlockSource.end() && State(it->second.first)) {\n+            MaybeSetPeerAsAnnouncingHeaderAndIDs(it->second.first, *connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93582234",
      "id" : 93582234,
      "original_commit_id" : "ee43109e6378c13ee5dff65053419daf2106f888",
      "original_position" : 62,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14110519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400",
      "updated_at" : "2016-12-30T19:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93582234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "On second thought, I suppose I could be convinced that using BlockChecked here was OK if there were very explicit documentation on when it is/isn't called in validationinterface.h and maybe some flags passed in to further disambiguate.\n\nOn December 21, 2016 8:22:02 AM PST, Gregory Sanders <notifications@github.com> wrote:\n>@rebroad This code doesn't change any inv behavior.\n>\n>-- \n>You are receiving this because you are subscribed to this thread.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-268565152\n",
      "created_at" : "2016-12-22T08:54:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-268750400",
      "id" : 268750400,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-22T08:54:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268750400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93626388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93626388"
         }
      },
      "body" : "Could we change the lifetime of mapBlockSource to keep it around until then? We could sweep it later.",
      "commit_id" : "d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2016-12-22T13:53:36Z",
      "diff_hunk" : "@@ -798,6 +803,11 @@ void PeerLogicValidation::BlockChecked(const CBlock& block, const CValidationSta\n                 Misbehaving(it->second.first, nDoS);\n         }\n     }\n+    else if (state.IsValid() && !IsInitialBlockDownload()) {\n+        if (it != mapBlockSource.end() && State(it->second.first)) {\n+            MaybeSetPeerAsAnnouncingHeaderAndIDs(it->second.first, *connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93626388",
      "id" : 93626388,
      "original_commit_id" : "ee43109e6378c13ee5dff65053419daf2106f888",
      "original_position" : 62,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14158041,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400",
      "updated_at" : "2016-12-30T19:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93626388",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "Changing the lifetime is hard, as only BlockChecked is guaranteed to be called if the block's PoW is invalid.\r\n\r\nOn December 22, 2016 5:53:40 AM PST, Gregory Sanders <notifications@github.com> wrote:\r\n>instagibbs commented on this pull request.\r\n>\r\n>\r\n>\r\n>> @@ -798,6 +803,11 @@ void PeerLogicValidation::BlockChecked(const\r\n>CBlock& block, const CValidationSta\r\n>                 Misbehaving(it->second.first, nDoS);\r\n>         }\r\n>     }\r\n>+    else if (state.IsValid() && !IsInitialBlockDownload()) {\r\n>+        if (it != mapBlockSource.end() && State(it->second.first)) {\r\n>+            MaybeSetPeerAsAnnouncingHeaderAndIDs(it->second.first,\r\n>*connman);\r\n>\r\n>Could we change the lifetime of mapBlockSource to keep it around until\r\n>then? We could sweep it later.\r\n>\r\n>-- \r\n>You are receiving this because you commented.\r\n>Reply to this email directly or view it on GitHub:\r\n>https://github.com/bitcoin/bitcoin/pull/9400\r\n",
      "created_at" : "2016-12-23T00:05:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-268917873",
      "id" : 268917873,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-23T04:21:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268917873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93839025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93839025"
         }
      },
      "body" : "why return true? it's a void function.",
      "commit_id" : "d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2016-12-26T02:54:23Z",
      "diff_hunk" : "@@ -395,33 +395,38 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n     }\n }\n \n-void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pfrom, CConnman& connman) {\n+void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connman) {\n+    AssertLockHeld(cs_main);\n+    CNodeState* nodestate = State(nodeid);\n     if (!nodestate->fSupportsDesiredCmpctVersion) {\n         // Never ask from peers who can't provide witnesses.\n         return;\n     }\n     if (nodestate->fProvidesHeaderAndIDs) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n-            if (*it == pfrom->GetId()) {\n+            if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n-                lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\n+                lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n-        bool fAnnounceUsingCMPCTBLOCK = false;\n-        uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-            // As per BIP152, we only get 3 of our peers to announce\n-            // blocks using compact encodings.\n-            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-                return true;\n-            });\n-            lNodesAnnouncingHeaderAndIDs.pop_front();\n-        }\n-        fAnnounceUsingCMPCTBLOCK = true;\n-        connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-        lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\n+        connman.ForNode(nodeid, [&connman](CNode* pfrom){\n+            bool fAnnounceUsingCMPCTBLOCK = false;\n+            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n+            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+                // As per BIP152, we only get 3 of our peers to announce\n+                // blocks using compact encodings.\n+                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion](CNode* pnodeStop){\n+                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+                    return true;\n+                });\n+                lNodesAnnouncingHeaderAndIDs.pop_front();\n+            }\n+            fAnnounceUsingCMPCTBLOCK = true;\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+            lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\n+            return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93839025",
      "id" : 93839025,
      "original_commit_id" : "ee43109e6378c13ee5dff65053419daf2106f888",
      "original_position" : 51,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 14372970,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400",
      "updated_at" : "2016-12-30T19:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93839025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93865800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93865800"
         }
      },
      "body" : "@rebroad It is not a void function https://dev.visucore.com/bitcoin/doxygen/class_c_connman.html#a16958796bb02ef0151b5b5544316c048",
      "commit_id" : "d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2016-12-26T12:57:58Z",
      "diff_hunk" : "@@ -395,33 +395,38 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n     }\n }\n \n-void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pfrom, CConnman& connman) {\n+void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connman) {\n+    AssertLockHeld(cs_main);\n+    CNodeState* nodestate = State(nodeid);\n     if (!nodestate->fSupportsDesiredCmpctVersion) {\n         // Never ask from peers who can't provide witnesses.\n         return;\n     }\n     if (nodestate->fProvidesHeaderAndIDs) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n-            if (*it == pfrom->GetId()) {\n+            if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n-                lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\n+                lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n-        bool fAnnounceUsingCMPCTBLOCK = false;\n-        uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-            // As per BIP152, we only get 3 of our peers to announce\n-            // blocks using compact encodings.\n-            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-                return true;\n-            });\n-            lNodesAnnouncingHeaderAndIDs.pop_front();\n-        }\n-        fAnnounceUsingCMPCTBLOCK = true;\n-        connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-        lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\n+        connman.ForNode(nodeid, [&connman](CNode* pfrom){\n+            bool fAnnounceUsingCMPCTBLOCK = false;\n+            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n+            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+                // As per BIP152, we only get 3 of our peers to announce\n+                // blocks using compact encodings.\n+                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion](CNode* pnodeStop){\n+                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+                    return true;\n+                });\n+                lNodesAnnouncingHeaderAndIDs.pop_front();\n+            }\n+            fAnnounceUsingCMPCTBLOCK = true;\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+            lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\n+            return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93865800",
      "id" : 93865800,
      "original_commit_id" : "ee43109e6378c13ee5dff65053419daf2106f888",
      "original_position" : 51,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 14399312,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400",
      "updated_at" : "2016-12-30T19:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93865800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "body" : "Not sure if this is behaving as it's supposed to:-\r\n\r\n```\r\n2016-12-26 17:13:12.258123 UpdateTip: new best=00000000000000000153e83f7511f8b104912bc578ad69d5ee5f138bd418a4cf (445158) ver=0x20000000 age=10.2h workage=9.3h tx=448\r\n2016-12-26 17:13:13.525927 send sendcmpct (no announce) ver=1 peer=2\r\n2016-12-26 17:13:13.526175 send sendcmpct (announce) ver=1 peer=9\r\n2016-12-26 17:13:13.583144 UpdateTip: new best=00000000000000000185ee972011605697340a4a4fa8ba778a93bc61a95dc315 (445159) ver=0x20000000 age=9.8h workage=9.2h tx=2823\r\n2016-12-26 17:13:16.007449 UpdateTip: new best=0000000000000000028907ba1fd6f492cdccfd0be79d11c6c43352834964378e (445160) ver=0x20000000 age=9.8h workage=9.0h tx=929\r\n2016-12-26 17:13:16.143575 send sendcmpct (no announce) ver=1 peer=12\r\n2016-12-26 17:13:16.143707 send sendcmpct (announce) ver=1 peer=2\r\n2016-12-26 17:13:16.150024 UpdateTip: new best=0000000000000000034a8dca7fe1801ed65e03aaeff94eeb34236cda2808f19d (445161) ver=0x20000000 age=9.8h workage=8.8h tx=175\r\n2016-12-26 17:13:18.224032 send sendcmpct (no announce) ver=1 peer=8\r\n2016-12-26 17:13:18.224165 send sendcmpct (announce) ver=1 peer=4\r\n2016-12-26 17:13:18.280457 UpdateTip: new best=000000000000000001bfb4c8427fd5d8256d899d60411c339c52b1c87e6df049 (445162) ver=0x20000002 age=9.5h workage=8.7h tx=1608\r\n2016-12-26 17:13:19.570130 UpdateTip: new best=00000000000000000005546a59fcc5f489a6f0ea15111a137ebc9be21b646b8e (445163) ver=0x20000000 age=9.1h workage=8.5h tx=2579\r\n2016-12-26 17:13:20.929863 send sendcmpct (no announce) ver=1 peer=9\r\n2016-12-26 17:13:20.929987 send sendcmpct (announce) ver=1 peer=8\r\n2016-12-26 17:13:20.985947 UpdateTip: new best=0000000000000000003c52ad03a94a8da08e2bce3c76430d798fba39d1083ff7 (445164) ver=0x20000000 age=9.1h workage=8.3h tx=2110\r\n```\r\n(there are no blocks being received, it's just catching up with the chain using blocks already downloaded quite some time ago)",
      "created_at" : "2016-12-26T17:19:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269228342",
      "id" : 269228342,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-26T17:20:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269228342",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@rebroad can you try adding a mapBlocksInFlight.empty() check prior to sending the sendcmpct message in the function? I believe that should (at least mostly) fix the issue.\n\nOn December 26, 2016 12:19:27 PM EST, R E Broadley <notifications@github.com> wrote:\n>Not sure if this is behaving as it's supposed to:-\n>\n>```\n>2016-12-26 17:13:12.258123 UpdateTip: new\n>best=00000000000000000153e83f7511f8b104912bc578ad69d5ee5f138bd418a4cf\n>(445158) ver=0x20000000 age=10.2h workage=9.3h tx=448\n>2016-12-26 17:13:13.525927 send sendcmpct (no announce) ver=1 peer=2\n>2016-12-26 17:13:13.526175 send sendcmpct (announce) ver=1 peer=9\n>2016-12-26 17:13:13.583144 UpdateTip: new\n>best=00000000000000000185ee972011605697340a4a4fa8ba778a93bc61a95dc315\n>(445159) ver=0x20000000 age=9.8h workage=9.2h tx=2823\n>2016-12-26 17:13:16.007449 UpdateTip: new\n>best=0000000000000000028907ba1fd6f492cdccfd0be79d11c6c43352834964378e\n>(445160) ver=0x20000000 age=9.8h workage=9.0h tx=929\n>2016-12-26 17:13:16.143575 send sendcmpct (no announce) ver=1 peer=12\n>2016-12-26 17:13:16.143707 send sendcmpct (announce) ver=1 peer=2\n>2016-12-26 17:13:16.150024 UpdateTip: new\n>best=0000000000000000034a8dca7fe1801ed65e03aaeff94eeb34236cda2808f19d\n>(445161) ver=0x20000000 age=9.8h workage=8.8h tx=175\n>2016-12-26 17:13:18.224032 send sendcmpct (no announce) ver=1 peer=8\n>2016-12-26 17:13:18.224165 send sendcmpct (announce) ver=1 peer=4\n>2016-12-26 17:13:18.280457 UpdateTip: new\n>best=000000000000000001bfb4c8427fd5d8256d899d60411c339c52b1c87e6df049\n>(445162) ver=0x20000002 age=9.5h workage=8.7h tx=1608\n>2016-12-26 17:13:19.570130 UpdateTip: new\n>best=00000000000000000005546a59fcc5f489a6f0ea15111a137ebc9be21b646b8e\n>(445163) ver=0x20000000 age=9.1h workage=8.5h tx=2579\n>2016-12-26 17:13:20.929863 send sendcmpct (no announce) ver=1 peer=9\n>2016-12-26 17:13:20.929987 send sendcmpct (announce) ver=1 peer=8\n>2016-12-26 17:13:20.985947 UpdateTip: new\n>best=0000000000000000003c52ad03a94a8da08e2bce3c76430d798fba39d1083ff7\n>(445164) ver=0x20000000 age=9.1h workage=8.3h tx=2110\n>```\n>\n>\n>-- \n>You are receiving this because you commented.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269228342\n",
      "created_at" : "2016-12-26T17:39:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269229597",
      "id" : 269229597,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-26T17:39:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269229597",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Updated to hopefully fix issue @rebroad ",
      "created_at" : "2016-12-26T18:14:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269232183",
      "id" : 269232183,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-26T18:14:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269232183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93893454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93893454"
         }
      },
      "body" : "I was referring to MaybeSetPeerAsAnnouncingHeaderAndIDs()... was misreading the flow of the code. Sorry.",
      "commit_id" : "d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2016-12-27T03:31:26Z",
      "diff_hunk" : "@@ -395,33 +395,38 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n     }\n }\n \n-void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pfrom, CConnman& connman) {\n+void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connman) {\n+    AssertLockHeld(cs_main);\n+    CNodeState* nodestate = State(nodeid);\n     if (!nodestate->fSupportsDesiredCmpctVersion) {\n         // Never ask from peers who can't provide witnesses.\n         return;\n     }\n     if (nodestate->fProvidesHeaderAndIDs) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n-            if (*it == pfrom->GetId()) {\n+            if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n-                lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\n+                lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n-        bool fAnnounceUsingCMPCTBLOCK = false;\n-        uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-            // As per BIP152, we only get 3 of our peers to announce\n-            // blocks using compact encodings.\n-            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-                return true;\n-            });\n-            lNodesAnnouncingHeaderAndIDs.pop_front();\n-        }\n-        fAnnounceUsingCMPCTBLOCK = true;\n-        connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-        lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\n+        connman.ForNode(nodeid, [&connman](CNode* pfrom){\n+            bool fAnnounceUsingCMPCTBLOCK = false;\n+            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n+            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+                // As per BIP152, we only get 3 of our peers to announce\n+                // blocks using compact encodings.\n+                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion](CNode* pnodeStop){\n+                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+                    return true;\n+                });\n+                lNodesAnnouncingHeaderAndIDs.pop_front();\n+            }\n+            fAnnounceUsingCMPCTBLOCK = true;\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetSendVersion()).Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+            lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\n+            return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93893454",
      "id" : 93893454,
      "original_commit_id" : "ee43109e6378c13ee5dff65053419daf2106f888",
      "original_position" : 51,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 14425321,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400",
      "updated_at" : "2016-12-30T19:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93893454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93894156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93894156"
         }
      },
      "body" : "nodestate can be NULL...?",
      "commit_id" : "d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2016-12-27T03:52:10Z",
      "diff_hunk" : "@@ -398,7 +398,7 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connman) {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93894156",
      "id" : 93894156,
      "original_commit_id" : "bbdf9563b41ce9a7f032e19afbba1f38fabefa7e",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14425972,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400",
      "updated_at" : "2016-12-30T19:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93894156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93933640"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93933640"
         }
      },
      "body" : "yes?",
      "commit_id" : "d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2016-12-27T14:01:49Z",
      "diff_hunk" : "@@ -398,7 +398,7 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connman) {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93933640",
      "id" : 93933640,
      "original_commit_id" : "bbdf9563b41ce9a7f032e19afbba1f38fabefa7e",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14464927,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400",
      "updated_at" : "2016-12-30T19:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93933640",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93933988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93933988"
         }
      },
      "body" : "If the peer is disconnected between when it provides the block and when the block is connected it can, sure.",
      "commit_id" : "d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2016-12-27T14:06:16Z",
      "diff_hunk" : "@@ -398,7 +398,7 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connman) {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r93933988",
      "id" : 93933988,
      "original_commit_id" : "bbdf9563b41ce9a7f032e19afbba1f38fabefa7e",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14465265,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400",
      "updated_at" : "2016-12-30T19:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93933988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "utACK bbdf9563b41ce9a7f032e19afbba1f38fabefa7e",
      "created_at" : "2016-12-27T19:04:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269368231",
      "id" : 269368231,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-27T19:04:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269368231",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I think we should have more discussion on whether this is the right logic to implement and not just is the code correct for implementing it.  My guess is there is little benefit from this code and its maybe  not worth the risk of introducing a change until we have something that will provide a more significant benefit.  \r\n\r\nIt's already the case that the first peer to announce anything to you is the only peer that you will allow to deliver you the full block (barring a full timeout), so for the most part this doesn't change who can be considered for HB peer.  The exception to this is peers that are already HB peers and give you cmpctblocks that get optimistically reconstructed.  Those peers are already HB so it doesn't help them, but it does prevent any peer who had previously headered you but not yet delivered the block from being considered.  But this is a minor roadblock for any attacker (or just inadvertent bad behavior) because as soon as you have a cmpctblock that doesn't optimistically reconstruct, you're back to the base case.\r\n\r\nThat said I think this is the general right idea, but I'd just prefer to see it in the context of a larger change so that we're not hacking around in this code repeatedly and at risk of introducing another bug.  There is definitely an improvement needed in better maintaining good HB peers.  \r\n\r\nBut perhaps I'm wrong and the benefit from this code is worth it on its own?\r\n\r\n\r\n\r\n",
      "created_at" : "2016-12-27T20:32:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269378936",
      "id" : 269378936,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-27T20:32:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269378936",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "@morcos completely agree - and I think I'm testing this code only because it potentially compliments other code I have added myself (e.g. requesting blocktxns from more then one node), but without such further changes, this code alone, at this stage, doesn't really provide any benefit from what I can see either, and needs to be combined with other improvements (i.e. more refined versions of what I'm also hackily producing).\r\n\r\nHaving said that, I don't think using the PR system to share our hacks (that we may often think are more complete than they are) is intrinsically a bad thing, and the review system is designed to help reveal the level of completeness of a PR raised, or dependencies needed, as we are doing.",
      "created_at" : "2016-12-28T02:31:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269415139",
      "id" : 269415139,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-28T02:37:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269415139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@instagibbs ok, looking at this debug.log output:-\r\n```\r\n2016-12-28 09:05:41.928636 recv new best header 00000000000000000320a325788953e769b47205654f55ea80a4c2e108a1189a (445473) age=21s peer=813\r\n2016-12-28 09:05:41.928868 send getdata cmpctblock 00000000000000000320a325788953e769b47205654f55ea80a4c2e108a1189a (445473) age=21s peer=813\r\n2016-12-28 09:05:42.085294 recv best cmpctblock 00000000000000000320a325788953e769b47205654f55ea80a4c2e108a1189a (445473) age=22s size=11814 peer=736\r\n2016-12-28 09:05:42.089384 send getblocktxn 00000000000000000320a325788953e769b47205654f55ea80a4c2e108a1189a (445473) age=22s indexes=1/1933 size=60 peer=736\r\n2016-12-28 09:05:42.479448 recv best cmpctblock 00000000000000000320a325788953e769b47205654f55ea80a4c2e108a1189a (445473) age=22s size=11814 peer=813\r\n2016-12-28 09:05:42.587522 recv blocktxn 00000000000000000320a325788953e769b47205654f55ea80a4c2e108a1189a (445473) age=22s indexes=1 size=256 expected-peer=813 peer=736\r\n2016-12-28 09:05:42.612230 made block 00000000000000000320a325788953e769b47205654f55ea80a4c2e108a1189a size=998115 txs: mempool=1931 req=1\r\n```\r\nwe can see that peer 813 is the first to advertise the block, but if we change the logic to fetch blocktxns from the first peer to provide the compact block, then often the one that provided the header will not be the one to provide the block as it requries an extra round trip to request it, so it'll often not be asked to announce with compact blocks, even though this might mean it then becomes the best block provider - how do we deal with this situation? (Does it need dealing with?) I think the only way to determine if peer 813 would be better would be to measure it's bandwidth and work out whether it would have sent the larger message (the compact block of 11814 bytes) before the other peers were able to.",
      "created_at" : "2016-12-28T11:15:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269463315",
      "id" : 269463315,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-28T11:18:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269463315",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@rebroad are you also running modified logic above?  In master, we would not have requested blocktxn from peer 736 in your example.",
      "created_at" : "2016-12-28T12:50:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269472862",
      "id" : 269472862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-28T12:50:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269472862",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "@morcos Yes, I am running this PR combined with some of my changes - in an aim to make the changes this PR provides more useful, although I think further refinement is still needed as mentioned in my previous comment.\r\n\r\n...ah. I see what you are saying now... yes without my changes, peer 813 would have provided the block and therefore been requested to announce as compact blocks going forward, but at the cost of receiving the block more slowly. My proposal in my previous comment was a way in which we could get the block more quickly AND ensure we are requested compact block announcements from the correct peers - assuming both these things are important.",
      "created_at" : "2016-12-29T07:58:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269594628",
      "id" : 269594628,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-29T08:00:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269594628",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r94159503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94159503"
         }
      },
      "body" : "I don't think this check of mapBlocksInFlight.empty() will play nicely with #9352 which doesn't MarkBlockReceived until after ProcessNewBlock",
      "commit_id" : "d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2016-12-29T17:27:40Z",
      "diff_hunk" : "@@ -798,6 +803,11 @@ void PeerLogicValidation::BlockChecked(const CBlock& block, const CValidationSta\n                 Misbehaving(it->second.first, nDoS);\n         }\n     }\n+    else if (state.IsValid() && !IsInitialBlockDownload() && mapBlocksInFlight.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r94159503",
      "id" : 94159503,
      "original_commit_id" : "bbdf9563b41ce9a7f032e19afbba1f38fabefa7e",
      "original_position" : 61,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14690587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400",
      "updated_at" : "2016-12-30T19:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94159503",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r94173438"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94173438"
         }
      },
      "body" : "perhaps `mapBlocksInFlight.count(hash) == mapBlocksInFlight.size()` instead?",
      "commit_id" : "d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2016-12-29T19:49:46Z",
      "diff_hunk" : "@@ -798,6 +803,11 @@ void PeerLogicValidation::BlockChecked(const CBlock& block, const CValidationSta\n                 Misbehaving(it->second.first, nDoS);\n         }\n     }\n+    else if (state.IsValid() && !IsInitialBlockDownload() && mapBlocksInFlight.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#discussion_r94173438",
      "id" : 94173438,
      "original_commit_id" : "bbdf9563b41ce9a7f032e19afbba1f38fabefa7e",
      "original_position" : 61,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14704508,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9400",
      "updated_at" : "2016-12-30T19:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94173438",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "@morcos I think this is the right logic: We should pick for HB usage peers that actually helped us get the block, not one that merely said they would.\r\n\r\nBeyond the slightly improved misbehavior resistance, this should reduce a small bias towards non-HB (or non-predicting HB) peers that arises because their announcement has less bytes on the wire, so it transmits somewhat faster even though it results in block recovery somewhat slower. Perhaps it over corrects for it somewhat: in a world without attacks you'd promote to HB status based on time of announcement adjusted by the serialization size (\"who would have been first if all were sending CBs?\")-- but we don't know the adjustment and we're not in a world without attacks. The net result of the over-correction is just a little hysteresis-- we're more likely to keep our existing HB set unless someone was faster by at least a RTT--, easily justified by the fact that changing HB selection isn't completely free.\r\n\r\nCalling maybe on a peer that is already HB is not a no-op: they get moved to the front of the list, which makes them less likely to get dropped.\r\n\r\nI do think this is more interesting once we have multiple reconstructions in flight.\r\n",
      "created_at" : "2016-12-30T02:39:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269724606",
      "id" : 269724606,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-30T02:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269724606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell @instagibbs Yes, after spending more time reviewing this, I agree it is the right approach, and its simpler than I thought.  Still suggest the fix above, but otherwise ACK.",
      "created_at" : "2016-12-30T14:23:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269776978",
      "id" : 269776978,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-30T14:23:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269776978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "@morcos fixed and squashed",
      "created_at" : "2016-12-30T19:29:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-269812305",
      "id" : 269812305,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2016-12-30T19:29:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269812305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "tested ACK d4781ac\r\n\r\nI think this would be nice for 0.14",
      "created_at" : "2017-01-14T15:54:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-272632584",
      "id" : 272632584,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2017-01-14T15:54:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272632584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "utACK d4781ac6c26399d316a2b25f656d9a4c0990c419",
      "created_at" : "2017-01-14T20:47:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-272651935",
      "id" : 272651935,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2017-01-14T20:47:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272651935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "utACK.",
      "created_at" : "2017-01-15T15:48:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9400#issuecomment-272703405",
      "id" : 272703405,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9400",
      "updated_at" : "2017-01-15T15:48:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272703405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   }
]
