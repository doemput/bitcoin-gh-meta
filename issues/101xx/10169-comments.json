[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111800001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111800001"
         }
      },
      "body" : "This function seems to duplicate a lot of what `wait_until` above does. Maybe it makes sense to do something like:\r\n\r\n    def sync(self, test_function, timeout=60):\r\n        if not wait_until(test_function, timeout=timeout):\r\n            AssertionError(\"Sync failed to complete\")\r\n",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-17T19:11:47Z",
      "diff_hunk" : "@@ -1548,44 +1579,69 @@ def on_version(self, conn, message):\n             conn.ver_recv = conn.ver_send\n         conn.nServices = message.nServices\n \n-    # Helper functions\n-    ##################\n+    # Connection helper methods\n \n     def add_connection(self, conn):\n         self.connection = conn\n \n-    # Wrapper for the NodeConn's send_message function\n+    def wait_for_disconnect(self, timeout=60):\n+        test_function = lambda: not self.connected\n+        assert wait_until(test_function, timeout=timeout)\n+\n+    # Message receiving helper methods\n+\n+    def sync(self, test_function, timeout=60):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111800001",
      "id" : 111800001,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 160,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111800001",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111800195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111800195"
         }
      },
      "body" : "This seems like it should also use `sync`:\r\n\r\n    self.sync(test_function, timeout)",
      "commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "created_at" : "2017-04-17T19:13:01Z",
      "diff_hunk" : "@@ -1548,44 +1579,69 @@ def on_version(self, conn, message):\n             conn.ver_recv = conn.ver_send\n         conn.nServices = message.nServices\n \n-    # Helper functions\n-    ##################\n+    # Connection helper methods\n \n     def add_connection(self, conn):\n         self.connection = conn\n \n-    # Wrapper for the NodeConn's send_message function\n+    def wait_for_disconnect(self, timeout=60):\n+        test_function = lambda: not self.connected\n+        assert wait_until(test_function, timeout=timeout)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111800195",
      "id" : 111800195,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 156,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : 156,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-17T19:50:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111800195",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111801053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111801053"
         }
      },
      "body" : "Also looks like it should use `self.sync` instead and maybe get rid of the `if not success` below.",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-17T19:17:55Z",
      "diff_hunk" : "@@ -1548,44 +1579,69 @@ def on_version(self, conn, message):\n             conn.ver_recv = conn.ver_send\n         conn.nServices = message.nServices\n \n-    # Helper functions\n-    ##################\n+    # Connection helper methods\n \n     def add_connection(self, conn):\n         self.connection = conn\n \n-    # Wrapper for the NodeConn's send_message function\n+    def wait_for_disconnect(self, timeout=60):\n+        test_function = lambda: not self.connected\n+        assert wait_until(test_function, timeout=timeout)\n+\n+    # Message receiving helper methods\n+\n+    def sync(self, test_function, timeout=60):\n+        while timeout > 0:\n+            with mininode_lock:\n+                if test_function():\n+                    return\n+            time.sleep(0.05)\n+            timeout -= 0.05\n+        raise AssertionError(\"Sync failed to complete\")\n+\n+    def wait_for_block(self, blockhash, timeout=60):\n+        test_function = lambda: self.last_message.get(\"block\") and self.last_message[\"block\"].block.rehash() == blockhash\n+        self.sync(test_function, timeout)\n+\n+    def wait_for_getdata(self, timeout=60):\n+        test_function = lambda: self.last_message.get(\"getdata\")\n+        self.sync(test_function, timeout)\n+\n+    def wait_for_getheaders(self, timeout=60):\n+        test_function = lambda: self.last_message.get(\"getheaders\")\n+        self.sync(test_function, timeout)\n+\n+    def wait_for_inv(self, expected_inv, timeout=60):\n+        test_function = lambda: self.last_message.get(\"inv\") and self.last_message[\"inv\"] != expected_inv\n+        self.sync(test_function, timeout)\n+\n+    def wait_for_verack(self, timeout=60):\n+        test_function = lambda: self.message_count[\"verack\"]\n+        self.sync(test_function, timeout)\n+\n+    # Message sending helper functions\n+\n     def send_message(self, message):\n-        self.connection.send_message(message)\n+        if self.connection:\n+            self.connection.send_message(message)\n+        else:\n+            logger.error(\"Cannot send message. No connection to node!\")\n \n     def send_and_ping(self, message):\n         self.send_message(message)\n         self.sync_with_ping()\n \n     # Sync up with the node\n     def sync_with_ping(self, timeout=60):\n-        def received_pong():\n-            return (self.last_pong.nonce == self.ping_counter)\n         self.send_message(msg_ping(nonce=self.ping_counter))\n-        success = wait_until(received_pong, timeout=timeout)\n+        test_function = lambda: self.last_message.get(\"pong\") and self.last_message[\"pong\"].nonce == self.ping_counter\n+        success = wait_until(test_function, timeout = timeout)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111801053",
      "id" : 111801053,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 209,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111801053",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111801707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111801707"
         }
      },
      "body" : "Any reason not to return the value like this?\r\n\r\n    return all(node.wait_for_verack() for node in self.test_nodes)\r\n\r\n",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-17T19:22:12Z",
      "diff_hunk" : "@@ -192,9 +192,7 @@ def disconnected():\n         return wait_until(disconnected, timeout=10)\n \n     def wait_for_verack(self):\n-        def veracked():\n-            return all(node.verack_received for node in self.test_nodes)\n-        return wait_until(veracked, timeout=10)\n+        [node.wait_for_verack() for node in self.test_nodes]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111801707",
      "id" : 111801707,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 7,
      "path" : "test/functional/test_framework/comptool.py",
      "position" : null,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111801707",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111802722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111802722"
         }
      },
      "body" : "`self.sync` looks more appropriate here.",
      "commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "created_at" : "2017-04-17T19:28:18Z",
      "diff_hunk" : "@@ -155,43 +137,27 @@ def check_last_announcement(self, headers=None, inv=None):\n \n             success = True\n             compare_inv = []\n-            if self.last_inv != None:\n-                compare_inv = [x.hash for x in self.last_inv.inv]\n+            if \"inv\" in self.last_message:\n+                compare_inv = [x.hash for x in self.last_message[\"inv\"].inv]\n             if compare_inv != expect_inv:\n                 success = False\n \n             hash_headers = []\n-            if self.last_headers != None:\n+            if \"headers\" in self.last_message:\n                 # treat headers as a list of block hashes\n-                hash_headers = [ x.sha256 for x in self.last_headers.headers ]\n+                hash_headers = [ x.sha256 for x in self.last_message[\"headers\"].headers ]\n             if hash_headers != expect_headers:\n                 success = False\n \n-            self.last_inv = None\n-            self.last_headers = None\n+            self.last_message.pop(\"inv\", None)\n+            self.last_message.pop(\"headers\", None)\n         return success\n \n-    # Syncing helpers\n-    def wait_for_block(self, blockhash, timeout=60):\n-        test_function = lambda: self.last_block != None and self.last_block.sha256 == blockhash\n-        assert(wait_until(test_function, timeout=timeout))\n-        return\n-\n-    def wait_for_getheaders(self, timeout=60):\n-        test_function = lambda: self.last_getheaders != None\n-        assert(wait_until(test_function, timeout=timeout))\n-        return\n-\n     def wait_for_getdata(self, hash_list, timeout=60):\n         if hash_list == []:\n             return\n \n-        test_function = lambda: self.last_getdata != None and [x.hash for x in self.last_getdata.inv] == hash_list\n-        assert(wait_until(test_function, timeout=timeout))\n-        return\n-\n-    def wait_for_disconnect(self, timeout=60):\n-        test_function = lambda: self.disconnected\n+        test_function = lambda: \"getdata\" in self.last_message and [x.hash for x in self.last_message[\"getdata\"].inv] == hash_list\n         assert(wait_until(test_function, timeout=timeout))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111802722",
      "id" : 111802722,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 106,
      "path" : "test/functional/sendheaders.py",
      "position" : 106,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-17T19:50:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111802722",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111803781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111803781"
         }
      },
      "body" : "Any reason to get rid of this and the one 5 lines below? I expected `self.last_message.pop`.",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-17T19:34:17Z",
      "diff_hunk" : "@@ -581,25 +536,21 @@ def run_test(self):\n         for i in range(5*MAX_UNCONNECTING_HEADERS - 1):\n             # Send a header that doesn't connect, check that we get a getheaders.\n             with mininode_lock:\n-                test_node.last_getheaders = None\n+                test_node.last_message.pop(\"getheaders\", None)\n             test_node.send_header_for_blocks([blocks[i%len(blocks)]])\n             test_node.wait_for_getheaders(timeout=1)\n \n         # Eventually this stops working.\n-        with mininode_lock:\n-            self.last_getheaders = None",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111803781",
      "id" : 111803781,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 228,
      "path" : "test/functional/sendheaders.py",
      "position" : 228,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111803781",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111804160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111804160"
         }
      },
      "body" : "how about `getheaders`?",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-17T19:36:39Z",
      "diff_hunk" : "@@ -35,79 +35,21 @@ def get_virtual_size(witness_block):\n class TestNode(NodeConnCB):\n     def __init__(self):\n         super().__init__()\n-        self.connection = None\n-        self.ping_counter = 1\n-        self.last_pong = msg_pong(0)\n-        self.sleep_time = 0.05\n         self.getdataset = set()\n-        self.last_reject = None\n-\n-    def add_connection(self, conn):\n-        self.connection = conn\n-\n-    # Wrapper for the NodeConn's send_message function\n-    def send_message(self, message):\n-        self.connection.send_message(message)\n-\n-    def on_inv(self, conn, message):\n-        self.last_inv = message\n-\n-    def on_block(self, conn, message):\n-        self.last_block = message.block\n-        self.last_block.calc_sha256()\n \n     def on_getdata(self, conn, message):\n         for inv in message.inv:\n             self.getdataset.add(inv.hash)\n-        self.last_getdata = message\n-\n-    def on_getheaders(self, conn, message):\n-        self.last_getheaders = message\n-\n-    def on_pong(self, conn, message):\n-        self.last_pong = message\n-\n-    def on_reject(self, conn, message):\n-        self.last_reject = message\n-\n-    # Syncing helpers\n-    def sync(self, test_function, timeout=60):\n-        while timeout > 0:\n-            with mininode_lock:\n-                if test_function():\n-                    return\n-            time.sleep(self.sleep_time)\n-            timeout -= self.sleep_time\n-        raise AssertionError(\"Sync failed to complete\")\n-        \n-    def wait_for_block(self, blockhash, timeout=60):\n-        test_function = lambda: self.last_block != None and self.last_block.sha256 == blockhash\n-        self.sync(test_function, timeout)\n-        return\n-\n-    def wait_for_getdata(self, timeout=60):\n-        test_function = lambda: self.last_getdata != None\n-        self.sync(test_function, timeout)\n-\n-    def wait_for_getheaders(self, timeout=60):\n-        test_function = lambda: self.last_getheaders != None\n-        self.sync(test_function, timeout)\n-\n-    def wait_for_inv(self, expected_inv, timeout=60):\n-        test_function = lambda: self.last_inv != expected_inv\n-        self.sync(test_function, timeout)\n \n     def announce_tx_and_wait_for_getdata(self, tx, timeout=60):\n         with mininode_lock:\n-            self.last_getdata = None\n+            self.last_message.pop(\"getdata\", None)\n         self.send_message(msg_inv(inv=[CInv(1, tx.sha256)]))\n         self.wait_for_getdata(timeout)\n-        return\n \n     def announce_block_and_wait_for_getdata(self, block, use_header, timeout=60):\n         with mininode_lock:\n-            self.last_getdata = None\n-            self.last_getheaders = None\n+            self.last_message.pop(\"getdata\", None)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111804160",
      "id" : 111804160,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 78,
      "path" : "test/functional/p2p-segwit.py",
      "position" : 78,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111804160",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111804484"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111804484"
         }
      },
      "body" : "`self.sync`?",
      "commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "created_at" : "2017-04-17T19:38:33Z",
      "diff_hunk" : "@@ -121,7 +112,9 @@ def run_test(self):\n \n         NetworkThread().start()  # Start up network handling in another thread\n \n-        assert(wait_until(lambda: no_version_bannode.connected and no_version_idlenode.connected and no_verack_idlenode.version_received, timeout=10))\n+        assert wait_until(lambda: no_version_bannode.ever_connected, timeout=10)\n+        assert wait_until(lambda: no_version_idlenode.ever_connected, timeout=10)\n+        assert wait_until(lambda: no_verack_idlenode.version_received, timeout=10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111804484",
      "id" : 111804484,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 42,
      "path" : "test/functional/p2p-leaktests.py",
      "position" : 42,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-17T19:50:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111804484",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111804710"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111804710"
         }
      },
      "body" : "Why did the constant change from 15000 to 15001?",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-17T19:39:43Z",
      "diff_hunk" : "@@ -78,7 +72,7 @@ def run_test(self):\n         test_node.clear_invs()\n \n         # Set a filter of 15 sat/byte\n-        test_node.send_filter(15000)\n+        test_node.send_and_ping(msg_feefilter(15001))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111804710",
      "id" : 111804710,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 25,
      "path" : "test/functional/p2p-feefilter.py",
      "position" : null,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111804710",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111805087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111805087"
         }
      },
      "body" : "Please let me know if this is inappropriate, but the object attribute `set_announced_blockhashes` is a bit confusing. Would changing the name to something like `announced_blockhashes_set` be appropriate here?",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-17T19:41:36Z",
      "diff_hunk" : "@@ -43,51 +35,33 @@ def on_close(self, conn):\n     def on_sendcmpct(self, conn, message):\n         self.last_sendcmpct.append(message)\n \n-    def on_block(self, conn, message):\n-        self.last_block = message\n-\n     def on_cmpctblock(self, conn, message):\n-        self.last_cmpctblock = message\n         self.block_announced = True\n-        self.last_cmpctblock.header_and_shortids.header.calc_sha256()\n-        self.set_announced_blockhashes.add(self.last_cmpctblock.header_and_shortids.header.sha256)\n+        self.last_message[\"cmpctblock\"].header_and_shortids.header.calc_sha256()\n+        self.set_announced_blockhashes.add(self.last_message[\"cmpctblock\"].header_and_shortids.header.sha256)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111805087",
      "id" : 111805087,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 29,
      "path" : "test/functional/p2p-compactblocks.py",
      "position" : null,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111805087",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111805156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111805156"
         }
      },
      "body" : "`self.sync`?",
      "commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "created_at" : "2017-04-17T19:42:02Z",
      "diff_hunk" : "@@ -103,8 +77,7 @@ def send_header_for_blocks(self, new_blocks):\n     def request_headers_and_sync(self, locator, hashstop=0):\n         self.clear_block_announcement()\n         self.get_headers(locator, hashstop)\n-        assert(wait_until(self.received_block_announcement, timeout=30))\n-        assert(self.received_block_announcement())\n+        assert wait_until(self.received_block_announcement, timeout=30)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111805156",
      "id" : 111805156,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 81,
      "path" : "test/functional/p2p-compactblocks.py",
      "position" : 81,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-17T19:50:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111805156",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111805255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111805255"
         }
      },
      "body" : "Why `pop` instead of `get` for the inv message?",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-17T19:42:39Z",
      "diff_hunk" : "@@ -214,14 +187,14 @@ def check_announcement_of_new_block(node, peer, predicate):\n             with mininode_lock:\n                 assert predicate(peer), (\n                     \"block_hash={!r}, cmpctblock={!r}, inv={!r}\".format(\n-                        block_hash, peer.last_cmpctblock, peer.last_inv))\n+                        block_hash, peer.last_message.get(\"cmpctblock\", None), peer.last_message.pop(\"inv\", None)))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111805255",
      "id" : 111805255,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 90,
      "path" : "test/functional/p2p-compactblocks.py",
      "position" : null,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111805255",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111805963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111805963"
         }
      },
      "body" : "Am I correct in assuming you're creating 1 node instead of 3 because the other two aren't being used?",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-17T19:46:26Z",
      "diff_hunk" : "@@ -192,33 +153,26 @@ def run_test(self):\n         stop_node(self.nodes[0], 0)\n         self.nodes[0] = start_node(0, self.options.tmpdir, [\"-whitelist=127.0.0.1\", \"-maxuploadtarget=1\", \"-blockmaxsize=999000\"])\n \n-        #recreate/reconnect 3 test nodes\n-        test_nodes = []\n-        connections = []\n-\n-        for i in range(3):\n-            test_nodes.append(TestNode())\n-            connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], test_nodes[i]))\n-            test_nodes[i].add_connection(connections[i])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r111805963",
      "id" : 111805963,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 79,
      "path" : "test/functional/maxuploadtarget.py",
      "position" : 79,
      "pull_request_review_id" : 33066718,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111805963",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112023795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112023795"
         }
      },
      "body" : "correct. I was altering this line anyway, so I thought I'd optimize while I was here.",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-18T18:05:09Z",
      "diff_hunk" : "@@ -192,33 +153,26 @@ def run_test(self):\n         stop_node(self.nodes[0], 0)\n         self.nodes[0] = start_node(0, self.options.tmpdir, [\"-whitelist=127.0.0.1\", \"-maxuploadtarget=1\", \"-blockmaxsize=999000\"])\n \n-        #recreate/reconnect 3 test nodes\n-        test_nodes = []\n-        connections = []\n-\n-        for i in range(3):\n-            test_nodes.append(TestNode())\n-            connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], test_nodes[i]))\n-            test_nodes[i].add_connection(connections[i])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112023795",
      "id" : 112023795,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 79,
      "path" : "test/functional/maxuploadtarget.py",
      "position" : 79,
      "pull_request_review_id" : 33307208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112023795",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112024546"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112024546"
         }
      },
      "body" : "Yes, agreed. Absolutely fine to point this out even though the variable name wasn't changed by this PR. I've gone ahead and changed it to `announced_blockhashes`. No need for the variable name to contain the name of the data structure.",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-18T18:08:02Z",
      "diff_hunk" : "@@ -43,51 +35,33 @@ def on_close(self, conn):\n     def on_sendcmpct(self, conn, message):\n         self.last_sendcmpct.append(message)\n \n-    def on_block(self, conn, message):\n-        self.last_block = message\n-\n     def on_cmpctblock(self, conn, message):\n-        self.last_cmpctblock = message\n         self.block_announced = True\n-        self.last_cmpctblock.header_and_shortids.header.calc_sha256()\n-        self.set_announced_blockhashes.add(self.last_cmpctblock.header_and_shortids.header.sha256)\n+        self.last_message[\"cmpctblock\"].header_and_shortids.header.calc_sha256()\n+        self.set_announced_blockhashes.add(self.last_message[\"cmpctblock\"].header_and_shortids.header.sha256)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112024546",
      "id" : 112024546,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 29,
      "path" : "test/functional/p2p-compactblocks.py",
      "position" : null,
      "pull_request_review_id" : 33307208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112024546",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112024839"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112024839"
         }
      },
      "body" : "bad search-and-replace I think. It doesn't really matter, since this block would only get executed if the assert failed, in which case the test case has failed. I've fixed it anyway.",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-18T18:09:16Z",
      "diff_hunk" : "@@ -214,14 +187,14 @@ def check_announcement_of_new_block(node, peer, predicate):\n             with mininode_lock:\n                 assert predicate(peer), (\n                     \"block_hash={!r}, cmpctblock={!r}, inv={!r}\".format(\n-                        block_hash, peer.last_cmpctblock, peer.last_inv))\n+                        block_hash, peer.last_message.get(\"cmpctblock\", None), peer.last_message.pop(\"inv\", None)))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112024839",
      "id" : 112024839,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 90,
      "path" : "test/functional/p2p-compactblocks.py",
      "position" : null,
      "pull_request_review_id" : 33307208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112024839",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112024907"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112024907"
         }
      },
      "body" : "bah. My mistake. Fixed",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-18T18:09:33Z",
      "diff_hunk" : "@@ -78,7 +72,7 @@ def run_test(self):\n         test_node.clear_invs()\n \n         # Set a filter of 15 sat/byte\n-        test_node.send_filter(15000)\n+        test_node.send_and_ping(msg_feefilter(15001))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112024907",
      "id" : 112024907,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 25,
      "path" : "test/functional/p2p-feefilter.py",
      "position" : null,
      "pull_request_review_id" : 33307208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112024907",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112025814"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112025814"
         }
      },
      "body" : "Yes. My mistake. Fixed",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-18T18:12:40Z",
      "diff_hunk" : "@@ -35,79 +35,21 @@ def get_virtual_size(witness_block):\n class TestNode(NodeConnCB):\n     def __init__(self):\n         super().__init__()\n-        self.connection = None\n-        self.ping_counter = 1\n-        self.last_pong = msg_pong(0)\n-        self.sleep_time = 0.05\n         self.getdataset = set()\n-        self.last_reject = None\n-\n-    def add_connection(self, conn):\n-        self.connection = conn\n-\n-    # Wrapper for the NodeConn's send_message function\n-    def send_message(self, message):\n-        self.connection.send_message(message)\n-\n-    def on_inv(self, conn, message):\n-        self.last_inv = message\n-\n-    def on_block(self, conn, message):\n-        self.last_block = message.block\n-        self.last_block.calc_sha256()\n \n     def on_getdata(self, conn, message):\n         for inv in message.inv:\n             self.getdataset.add(inv.hash)\n-        self.last_getdata = message\n-\n-    def on_getheaders(self, conn, message):\n-        self.last_getheaders = message\n-\n-    def on_pong(self, conn, message):\n-        self.last_pong = message\n-\n-    def on_reject(self, conn, message):\n-        self.last_reject = message\n-\n-    # Syncing helpers\n-    def sync(self, test_function, timeout=60):\n-        while timeout > 0:\n-            with mininode_lock:\n-                if test_function():\n-                    return\n-            time.sleep(self.sleep_time)\n-            timeout -= self.sleep_time\n-        raise AssertionError(\"Sync failed to complete\")\n-        \n-    def wait_for_block(self, blockhash, timeout=60):\n-        test_function = lambda: self.last_block != None and self.last_block.sha256 == blockhash\n-        self.sync(test_function, timeout)\n-        return\n-\n-    def wait_for_getdata(self, timeout=60):\n-        test_function = lambda: self.last_getdata != None\n-        self.sync(test_function, timeout)\n-\n-    def wait_for_getheaders(self, timeout=60):\n-        test_function = lambda: self.last_getheaders != None\n-        self.sync(test_function, timeout)\n-\n-    def wait_for_inv(self, expected_inv, timeout=60):\n-        test_function = lambda: self.last_inv != expected_inv\n-        self.sync(test_function, timeout)\n \n     def announce_tx_and_wait_for_getdata(self, tx, timeout=60):\n         with mininode_lock:\n-            self.last_getdata = None\n+            self.last_message.pop(\"getdata\", None)\n         self.send_message(msg_inv(inv=[CInv(1, tx.sha256)]))\n         self.wait_for_getdata(timeout)\n-        return\n \n     def announce_block_and_wait_for_getdata(self, block, use_header, timeout=60):\n         with mininode_lock:\n-            self.last_getdata = None\n-            self.last_getheaders = None\n+            self.last_message.pop(\"getdata\", None)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112025814",
      "id" : 112025814,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 78,
      "path" : "test/functional/p2p-segwit.py",
      "position" : 78,
      "pull_request_review_id" : 33307208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112025814",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112026717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112026717"
         }
      },
      "body" : "because we're never testing `last_getheaders` after this, so these lines are just setting a variable that never gets used.",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-18T18:16:22Z",
      "diff_hunk" : "@@ -581,25 +536,21 @@ def run_test(self):\n         for i in range(5*MAX_UNCONNECTING_HEADERS - 1):\n             # Send a header that doesn't connect, check that we get a getheaders.\n             with mininode_lock:\n-                test_node.last_getheaders = None\n+                test_node.last_message.pop(\"getheaders\", None)\n             test_node.send_header_for_blocks([blocks[i%len(blocks)]])\n             test_node.wait_for_getheaders(timeout=1)\n \n         # Eventually this stops working.\n-        with mininode_lock:\n-            self.last_getheaders = None",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112026717",
      "id" : 112026717,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 228,
      "path" : "test/functional/sendheaders.py",
      "position" : 228,
      "pull_request_review_id" : 33307208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112026717",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112027098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112027098"
         }
      },
      "body" : "yes, that's much better. Changed, thanks.",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-18T18:18:02Z",
      "diff_hunk" : "@@ -192,9 +192,7 @@ def disconnected():\n         return wait_until(disconnected, timeout=10)\n \n     def wait_for_verack(self):\n-        def veracked():\n-            return all(node.verack_received for node in self.test_nodes)\n-        return wait_until(veracked, timeout=10)\n+        [node.wait_for_verack() for node in self.test_nodes]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112027098",
      "id" : 112027098,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 7,
      "path" : "test/functional/test_framework/comptool.py",
      "position" : null,
      "pull_request_review_id" : 33307208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112027098",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "Thanks for the excellent review @jimmysong . I've responded to most of your points. I'm just running the extended test suite locally before pushing up to github.\r\n\r\nI've decided to remove the `sync()` method from NodeConnCB entirely for now, since it's just duplicating the functionality of `wait_until()` and doesn't actually need to be a method. I'm still not entirely happy with `wait_until()`, but I think it's better to not duplicate code for no good reason in this PR.",
      "created_at" : "2017-04-18T20:18:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#issuecomment-294967889",
      "id" : 294967889,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10169",
      "updated_at" : "2017-04-18T20:18:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/294967889",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "rebased, review comments addressed and pushed",
      "created_at" : "2017-04-18T20:34:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#issuecomment-294972967",
      "id" : 294972967,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10169",
      "updated_at" : "2017-04-18T20:34:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/294972967",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112063492"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112063492"
         }
      },
      "body" : "makes sense.",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-18T21:03:45Z",
      "diff_hunk" : "@@ -581,25 +536,21 @@ def run_test(self):\n         for i in range(5*MAX_UNCONNECTING_HEADERS - 1):\n             # Send a header that doesn't connect, check that we get a getheaders.\n             with mininode_lock:\n-                test_node.last_getheaders = None\n+                test_node.last_message.pop(\"getheaders\", None)\n             test_node.send_header_for_blocks([blocks[i%len(blocks)]])\n             test_node.wait_for_getheaders(timeout=1)\n \n         # Eventually this stops working.\n-        with mininode_lock:\n-            self.last_getheaders = None",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112063492",
      "id" : 112063492,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 228,
      "path" : "test/functional/sendheaders.py",
      "position" : 228,
      "pull_request_review_id" : 33350706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112063492",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112064436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112064436"
         }
      },
      "body" : "I don't see this yet? Maybe missing a changeset or I'm missing something?",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-18T21:08:06Z",
      "diff_hunk" : "@@ -78,7 +72,7 @@ def run_test(self):\n         test_node.clear_invs()\n \n         # Set a filter of 15 sat/byte\n-        test_node.send_filter(15000)\n+        test_node.send_and_ping(msg_feefilter(15001))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112064436",
      "id" : 112064436,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 25,
      "path" : "test/functional/p2p-feefilter.py",
      "position" : null,
      "pull_request_review_id" : 33350706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112064436",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112067269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112067269"
         }
      },
      "body" : "argh! Fixed now",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-18T21:20:44Z",
      "diff_hunk" : "@@ -78,7 +72,7 @@ def run_test(self):\n         test_node.clear_invs()\n \n         # Set a filter of 15 sat/byte\n-        test_node.send_filter(15000)\n+        test_node.send_and_ping(msg_feefilter(15001))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r112067269",
      "id" : 112067269,
      "original_commit_id" : "e74cf5028bbe6bc7fe520647860590f855eb8b3e",
      "original_position" : 25,
      "path" : "test/functional/p2p-feefilter.py",
      "position" : null,
      "pull_request_review_id" : 33354596,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-04-18T21:20:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112067269",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "ACK 2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-04-18T21:45:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#issuecomment-294992812",
      "id" : 294992812,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10169",
      "updated_at" : "2017-04-18T21:45:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/294992812",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/524761?v=3",
         "events_url" : "https://api.github.com/users/jimmysong/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimmysong/followers",
         "following_url" : "https://api.github.com/users/jimmysong/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimmysong/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimmysong",
         "id" : 524761,
         "login" : "jimmysong",
         "organizations_url" : "https://api.github.com/users/jimmysong/orgs",
         "received_events_url" : "https://api.github.com/users/jimmysong/received_events",
         "repos_url" : "https://api.github.com/users/jimmysong/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimmysong/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimmysong/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimmysong"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r114389770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114389770"
         }
      },
      "body" : "@jnewbery Can you explain why the second operand is `!=` and not `==`?",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-05-02T18:26:16Z",
      "diff_hunk" : "@@ -1548,43 +1579,56 @@ def on_version(self, conn, message):\n             conn.ver_recv = conn.ver_send\n         conn.nServices = message.nServices\n \n-    # Helper functions\n-    ##################\n+    # Connection helper methods\n \n     def add_connection(self, conn):\n         self.connection = conn\n \n-    # Wrapper for the NodeConn's send_message function\n+    def wait_for_disconnect(self, timeout=60):\n+        test_function = lambda: not self.connected\n+        assert wait_until(test_function, timeout=timeout)\n+\n+    # Message receiving helper methods\n+\n+    def wait_for_block(self, blockhash, timeout=60):\n+        test_function = lambda: self.last_message.get(\"block\") and self.last_message[\"block\"].block.rehash() == blockhash\n+        assert wait_until(test_function, timeout=timeout)\n+\n+    def wait_for_getdata(self, timeout=60):\n+        test_function = lambda: self.last_message.get(\"getdata\")\n+        assert wait_until(test_function, timeout=timeout)\n+\n+    def wait_for_getheaders(self, timeout=60):\n+        test_function = lambda: self.last_message.get(\"getheaders\")\n+        assert wait_until(test_function, timeout=timeout)\n+\n+    def wait_for_inv(self, expected_inv, timeout=60):\n+        test_function = lambda: self.last_message.get(\"inv\") and self.last_message[\"inv\"] != expected_inv",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r114389770",
      "id" : 114389770,
      "original_commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "original_position" : 173,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : 173,
      "pull_request_review_id" : 35851747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-05-02T18:26:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114389770",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r114419023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114419023"
         }
      },
      "body" : "This was a code move from p2p-segwit.py to here, but you're right that this is a bug.\r\n\r\nFix here: #10318",
      "commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "created_at" : "2017-05-02T20:37:50Z",
      "diff_hunk" : "@@ -1548,43 +1579,56 @@ def on_version(self, conn, message):\n             conn.ver_recv = conn.ver_send\n         conn.nServices = message.nServices\n \n-    # Helper functions\n-    ##################\n+    # Connection helper methods\n \n     def add_connection(self, conn):\n         self.connection = conn\n \n-    # Wrapper for the NodeConn's send_message function\n+    def wait_for_disconnect(self, timeout=60):\n+        test_function = lambda: not self.connected\n+        assert wait_until(test_function, timeout=timeout)\n+\n+    # Message receiving helper methods\n+\n+    def wait_for_block(self, blockhash, timeout=60):\n+        test_function = lambda: self.last_message.get(\"block\") and self.last_message[\"block\"].block.rehash() == blockhash\n+        assert wait_until(test_function, timeout=timeout)\n+\n+    def wait_for_getdata(self, timeout=60):\n+        test_function = lambda: self.last_message.get(\"getdata\")\n+        assert wait_until(test_function, timeout=timeout)\n+\n+    def wait_for_getheaders(self, timeout=60):\n+        test_function = lambda: self.last_message.get(\"getheaders\")\n+        assert wait_until(test_function, timeout=timeout)\n+\n+    def wait_for_inv(self, expected_inv, timeout=60):\n+        test_function = lambda: self.last_message.get(\"inv\") and self.last_message[\"inv\"] != expected_inv",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10169#discussion_r114419023",
      "id" : 114419023,
      "original_commit_id" : "2a52ae63bfdde948250df1c876dcdd5af99f03b5",
      "original_position" : 173,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : 173,
      "pull_request_review_id" : 35883664,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10169",
      "updated_at" : "2017-05-02T20:37:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114419023",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
