{
   "assignee" : null,
   "assignees" : [],
   "body" : "This implements an alternative solution to the flush-time memory usage peak, suggested by @gmaxwell.\r\n\r\nInstead of relying on using atomic batch writes in LevelDB for the chainstate, we rely on the fact that we have an external log of updates to it already (called the blockchain).\r\n\r\nThis patch adds an extra \"head blocks\" to the chainstate, which gives the range of blocks for writes may be incomplete. At the start of a flush, we write this record, write the dirty dbcache entries in 16 MiB batches, and at the end we remove the heads record again. If it is present at startup it means we crashed during flush, and we rollback/roll forward blocks inside of it to get a consistent tip on disk before proceeding.\r\n\r\nIf a flush completes succesfully, the resulting database is compatible with previous versions (down to 0.8). If the node crashes in the middle of a flush, a version of the code with this patch is needed to recovery.",
   "closed_at" : "2017-06-28T16:27:26Z",
   "closed_by" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 28,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148/comments",
   "created_at" : "2017-04-04T09:50:50Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148",
   "id" : 219196290,
   "labels" : [
      {
         "color" : "981023",
         "default" : false,
         "id" : 326918230,
         "name" : "Resource usage",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Resource%20usage"
      },
      {
         "color" : "fbca04",
         "default" : false,
         "id" : 97470796,
         "name" : "UTXO Db and Indexes",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 10148,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/10148.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/10148.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Use non-atomic flushing with block replay",
   "updated_at" : "2017-06-28T16:27:27Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148",
   "user" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
      "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sipa/followers",
      "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sipa",
      "id" : 548488,
      "login" : "sipa",
      "organizations_url" : "https://api.github.com/users/sipa/orgs",
      "received_events_url" : "https://api.github.com/users/sipa/received_events",
      "repos_url" : "https://api.github.com/users/sipa/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sipa"
   }
}
