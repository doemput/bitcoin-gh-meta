[
   {
      "body" : "I don't get the bitfield stuff here. Why?  It adds a lot of code with indirect effects, and means that we cannot use a perfect hash to set the enum value (e.g. stuck with a map of strings at best, though this code doesn't do that). ",
      "created_at" : "2017-04-03T22:23:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-291291673",
      "id" : 291291673,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-04-03T22:23:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291291673",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell I agree. I asked @JeremyRubin to check my logic in https://github.com/theuni/bitcoin/commit/f1e4e281e3f1eb884f8010ac941c82752174bdbe, and after reviewing, he wanted to take a stab at a more direct mapping for the initial filter.\r\n\r\nThis is an interesting approach, but I think this is much less clear than f1e4e281e3f1eb884f8010ac941c82752174bdbe, and it tangles the rules up with the enum values.",
      "created_at" : "2017-04-03T22:39:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-291294719",
      "id" : 291294719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-04-03T22:39:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291294719",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "It's actually trivial to make this work very well with a perfect hash and\r\nthis implementation doesn't add any network dependency on the order. If you\r\nhave a perfect hash available I could demonstrate :)\r\n\r\nThe bitwise stuff is the set of current policies. It's much more explicit\r\nabout which operations are allowed in which contexts compared to a list of\r\nconditionals. There might be a better way to aggregate those rules\r\ntogether, but those are the rules. Blacklists would be shorter (I used one\r\nfor the bloom stuff, now that I think of it), but it's generally easier to\r\naudit what is permitted rather than what is not.\r\n",
      "created_at" : "2017-04-03T22:41:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-291295072",
      "id" : 291295072,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-04-04T00:51:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291295072",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "> If you have a perfect hash available \r\n\r\ngperf works in a pinch\r\n\r\ncat protocol.cpp | grep '^const char *' | cut -d'\"' -f2 | sort | gperf -lCcE\r\n\r\n> . It's much more explicit about which operations are allowed in which contexts compared to a list of conditionals.\r\n\r\n/Generally/ moving function preconditions far away from their code results in defects. When its something that applies basically universally (like the check for the version handshake finishing), then it can make sense... but I think having if (importing) return; at the top of a message handling function is a lot more maintainable than what is effectively an additional state machine.",
      "created_at" : "2017-04-03T23:16:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-291309935",
      "id" : 291309935,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-04-03T23:17:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291309935",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "> cat protocol.cpp | grep '^const char *' | cut -d'\"' -f2 | sort | gperf -lCcE\r\n\r\nAs promised, perfect hashing patch in https://github.com/JeremyRubin/bitcoin/tree/perfect_hashing (a little bit less clean than it could be, because I didn't want to modify protocol.h, but you get the idea). \r\n\r\nIt's like 8 lines of code. At initialize you just fill up a translation table to map the perfect hashes. Note that I slightly tweaked the API of the gperf hash to return the hash key and max+1 on fail to make this design easier.\r\n\r\nWhat's nice about the translation table is it could be modified to store the function pointers to the handlers directly as well, skipping the jump table/switch.\r\n\r\n> /Generally/ moving function preconditions far away from their code results in defects. When its something that applies basically universally (like the check for the version handshake finishing), then it can make sense... but I think having if (importing) return; at the top of a message handling function is a lot more maintainable than what is effectively an additional state machine.\r\n\r\nI'm mixed on this one. I agree that having preconditions closer to the code can be good; but it's also good to have a non-exposed function which only takes sanitized inputs, and do the sanitizing elsewhere. I agree with the state machine comment, but that was the existing state of the code: there is currently an implicit state machine on what order messages were allowed to come in. This PR makes it more explicit; if you want to make it even more explicit (e.g., ProtocolStateMachine class I think that would be great :)). This at least makes it really easy to do whatever you want with the actual dispatch as it is state independent.\r\n\r\nI don't think it's more maintainable to have repeated preconditions throughout the code, because then it is easier to forget to check a precondition in a handler and you repeat precondition checking code, leading to more opportunity for error. It's a trade off.\r\n\r\nIt is possible to re-check these preconditions if critical, which would maybe be \"the best/worst\" of both worlds.",
      "created_at" : "2017-04-04T02:12:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-291374007",
      "id" : 291374007,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-04-04T02:12:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291374007",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "A serious drawback of perfect hashing is that it makes it hard to add message types, especially in PRs or third-party patches. It reduces flexibility.\r\n\r\nUnless it can be clearly shown from performance results that matching a small string in e.g. a sorted table or run-time constructed hash is really a performance sink, and given the small number of small messages I would be really surprised (12 bytes isn't even two 64-bit words!), I'd prefer if adding a message type was just adding a line. \r\n\r\n> ProtocolStateMachine \r\n\r\nIf you go this way, I don't think there should be one protocol state machine. Different concerns (e.g. initial negotiation, handling pings, handling transactions, handling blocks, handling filters) could be separate state machines that handle groups of messages (this was @sipa's idea). Creating a separate handler class for every message type would be typical OOP overkill, but for separate concerns I think it'd make sense and would help untangle the current labyrinth.",
      "created_at" : "2017-04-04T06:27:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-291405594",
      "id" : 291405594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-04-04T06:40:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291405594",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I think using a perfect hash is unnecessary overkill here.",
      "created_at" : "2017-04-04T07:07:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-291413416",
      "id" : 291413416,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-04-04T07:07:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291413416",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Ultimately if we want to check preconditions, it can't hurt to check some general preconditions in ContextualProcessMessage which apply to either the ProcessMessage state machine (e.g., that only one version may be received) or affect more than one handler. Individual handlers that rely on global preconditions should also re-check these global preconditions to harden them against a failure in ContextualProcessMessage.\r\n\r\nI pushed up a better version. \r\n\r\nMore Modular:\r\n  - there is no external dependency on the value of message types in the enum\r\n  - Each handler is a separate function (this duplicates/replaces some of @jtimon's work)\r\n\r\nCleaner:\r\n  - The whitelists are now a std::array<bool, ...> rather than (previously) a uint64_t, so no masking just indexing\r\n  - Identifiers are renamed to be a bit more clear\r\n  - whitelists are now separated into global and connection specific\r\n  - diff is easier to read\r\n\r\nMore Extensible:\r\n  - The whitelists are now a std::array<bool, ...> rather than (previously) a uint64_t, so no refactoring needed to have more than 64 messages. Adding new whitelists is also easier/cleaner.\r\n  - The use of the function pointers/whitelist arrays makes future work easier, including having per-node handler tables/whitelists (e.g., if a client says it is SPV disable certain operations).\r\n\r\n\r\nold version exists at https://github.com/jeremyrubin/bitcoin/tree/netprocessing_enum_backup for reference.\r\n",
      "created_at" : "2017-04-04T21:09:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-291632820",
      "id" : 291632820,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-04-04T21:09:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291632820",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "I only looked fast at the changes and read the rest of the comments, but this does way more than #9608 , even if #9608 would rebase on top of https://github.com/theuni/bitcoin/commit/f1e4e281e3f1eb884f8010ac941c82752174bdbe (which at a glance look like something good to do before #9608, but I haven't reviewed it deeply because I'm not that familiar with the network code).\r\n\r\n#9608 is very easy to review and trivial to rebase (or re-write) and personally I think it makes the network code easier to read for people like me (perhaps combined with https://github.com/theuni/bitcoin/commit/f1e4e281e3f1eb884f8010ac941c82752174bdbe even more, I haven't tried combining them). In contrast, it seems like this PR would make harder for me to read at a glance (or maybe not, or maybe it is still worth it, I honestly don't know). Although I've written #9608 (which as said is trivial to write IMO, just a little bit painful [could have been lesss painful if I still used eclipse http://help.eclipse.org/neon/index.jsp?topic=%2Forg.eclipse.jdt.doc.user%2FgettingStarted%2Fqs-ExtractMethod.htm ]), I don't feel very capacitated to review this PR or even https://github.com/theuni/bitcoin/commit/f1e4e281e3f1eb884f8010ac941c82752174bdbe which looks much simpler.\r\n",
      "created_at" : "2017-04-05T16:44:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-291922420",
      "id" : 291922420,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-04-05T16:48:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291922420",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "rebased to 1b389b0",
      "created_at" : "2017-09-05T23:34:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-327332283",
      "id" : 327332283,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-09-05T23:34:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/327332283",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137334628"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137334628"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe leave this as ProcessMessage instead of renaming to ContextualProcessMessage. \"Contextual\" doesn't seem that elucidating, and the PR could be a little smaller without this change.",
      "commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "created_at" : "2017-09-06T17:24:02Z",
      "diff_hunk" : "@@ -1172,31 +1172,13 @@ inline void static SendBlockTransactions(const CBlock& block, const BlockTransac\n     connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCKTXN, resp));\n }\n \n-bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vRecv, int64_t nTimeReceived, const CChainParams& chainparams, CConnman& connman, const std::atomic<bool>& interruptMsgProc)\n-{\n-    LogPrint(BCLog::NET, \"received: %s (%u bytes) peer=%d\\n\", SanitizeString(strCommand), vRecv.size(), pfrom->GetId());\n-    if (gArgs.IsArgSet(\"-dropmessagestest\") && GetRand(gArgs.GetArg(\"-dropmessagestest\", 0)) == 0)\n-    {\n-        LogPrintf(\"dropmessagestest DROPPING RECV MESSAGE\\n\");\n-        return true;\n-    }\n-\n-\n-    if (!(pfrom->GetLocalServices() & NODE_BLOOM) &&\n-              (strCommand == NetMsgType::FILTERLOAD ||\n-               strCommand == NetMsgType::FILTERADD))\n-    {\n-        if (pfrom->nVersion >= NO_BLOOM_VERSION) {\n-            LOCK(cs_main);\n-            Misbehaving(pfrom->GetId(), 100);\n-            return false;\n-        } else {\n-            pfrom->fDisconnect = true;\n-            return false;\n-        }\n-    }\n+static bool ContextualProcessMessage(CNode* pfrom, const std::string&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137334628",
      "id" : 137334628,
      "original_commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "original_position" : 27,
      "path" : "src/net_processing.cpp",
      "position" : 27,
      "pull_request_review_id" : 60987891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145",
      "updated_at" : "2017-09-06T19:17:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137334628",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137335652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137335652"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Style guide probably changed since this PR was written, but currently says to use a snake_case name for a namespace, put the brace on the next line, and not indent the contents. Could maybe name this \"handlers\" instead of \"handler\" too since it is a collection of handlers.",
      "commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "created_at" : "2017-09-06T17:28:06Z",
      "diff_hunk" : "@@ -1172,31 +1172,13 @@ inline void static SendBlockTransactions(const CBlock& block, const BlockTransac\n     connman.PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::BLOCKTXN, resp));\n }\n \n-bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStream& vRecv, int64_t nTimeReceived, const CChainParams& chainparams, CConnman& connman, const std::atomic<bool>& interruptMsgProc)\n-{\n-    LogPrint(BCLog::NET, \"received: %s (%u bytes) peer=%d\\n\", SanitizeString(strCommand), vRecv.size(), pfrom->GetId());\n-    if (gArgs.IsArgSet(\"-dropmessagestest\") && GetRand(gArgs.GetArg(\"-dropmessagestest\", 0)) == 0)\n-    {\n-        LogPrintf(\"dropmessagestest DROPPING RECV MESSAGE\\n\");\n-        return true;\n-    }\n-\n-\n-    if (!(pfrom->GetLocalServices() & NODE_BLOOM) &&\n-              (strCommand == NetMsgType::FILTERLOAD ||\n-               strCommand == NetMsgType::FILTERADD))\n-    {\n-        if (pfrom->nVersion >= NO_BLOOM_VERSION) {\n-            LOCK(cs_main);\n-            Misbehaving(pfrom->GetId(), 100);\n-            return false;\n-        } else {\n-            pfrom->fDisconnect = true;\n-            return false;\n-        }\n-    }\n+static bool ContextualProcessMessage(CNode* pfrom, const std::string&\n+        strCommand, CDataStream& vRecv, int64_t nTimeReceived, const\n+        CChainParams& chainparams, CConnman& connman, const std::atomic<bool>&\n+        interruptMsgProc);\n+namespace ProcessMessageHandler {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137335652",
      "id" : 137335652,
      "original_commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "original_position" : 31,
      "path" : "src/net_processing.cpp",
      "position" : 31,
      "pull_request_review_id" : 60987891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145",
      "updated_at" : "2017-09-06T19:17:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137335652",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137340640"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137340640"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You might be able to cut down on the size of the PR by making these handlers classes instead of functions. E.g. you wouldn't need to repeat these pfrom, vRecv, nTimeReceived declarations because they could be members initialized by an inherited constructor. strCommand variables could be static members, so PushMessage calls wouldn't need to change. And you could replace handler_registry table with initialization from a flat list of handler classes.\r\n\r\nI could imagine other reviewers liking functions more than classes though, and the differences are pretty superficial, so should just consider this a tentative suggestion.",
      "commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "created_at" : "2017-09-06T17:47:11Z",
      "diff_hunk" : "@@ -1218,19 +1200,12 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 LogPrint(BCLog::NET, \"Unparseable reject message received\\n\");\n             }\n         }\n+        return true;\n     }\n \n-    else if (strCommand == NetMsgType::VERSION)\n+static bool ProcessVersionMessage(CNode* pfrom, CDataStream& vRecv, int64_t nTimeReceived, const CChainParams& chainparams, CConnman& connman, const std::atomic<bool>& interruptMsgProc)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137340640",
      "id" : 137340640,
      "original_commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "original_position" : 46,
      "path" : "src/net_processing.cpp",
      "position" : 46,
      "pull_request_review_id" : 60987891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145",
      "updated_at" : "2017-09-06T19:17:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137340640",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137343501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137343501"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe add a comment here that this must be last.",
      "commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "created_at" : "2017-09-06T17:57:43Z",
      "diff_hunk" : "@@ -2612,20 +2581,210 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             }\n             LogPrint(BCLog::NET, \"received: feefilter of %s from peer=%d\\n\", CFeeRate(newFeeFilter).ToString(), pfrom->GetId());\n         }\n+        return true;\n     }\n \n-    else if (strCommand == NetMsgType::NOTFOUND) {\n+    static bool ProcessNotFoundMessage(CNode* pfrom, CDataStream& vRecv, int64_t nTimeReceived, const CChainParams& chainparams, CConnman& connman, const std::atomic<bool>& interruptMsgProc)\n+    {\n         // We do not care about the NOTFOUND message, but logging an Unknown Command\n         // message would be undesirable as we transmit it ourselves.\n+        return true;\n     }\n \n-    else {\n-        // Ignore unknown commands for extensibility\n-        LogPrint(BCLog::NET, \"Unknown command \\\"%s\\\" from peer=%d\\n\", SanitizeString(strCommand), pfrom->GetId());\n+    // Message Indexes do not have to be in order\n+    // For whitelist size correctness INDEX_COUNT must come last\n+    enum whitelist_index : uint64_t {\n+        // Message Tags\n+        VERSION,\n+        VERACK,\n+        ADDR,\n+        INV,\n+        GETDATA,\n+        MERKLEBLOCK,\n+        GETBLOCKS,\n+        GETHEADERS,\n+        TX,\n+        HEADERS,\n+        BLOCK,\n+        GETADDR,\n+        MEMPOOL,\n+        PING,\n+        PONG,\n+        NOTFOUND,\n+        FILTERLOAD,\n+        FILTERADD,\n+        FILTERCLEAR,\n+        REJECT,\n+        SENDHEADERS,\n+        FEEFILTER,\n+        SENDCMPCT,\n+        CMPCTBLOCK,\n+        GETBLOCKTXN,\n+        BLOCKTXN,\n+        // Unknown Index\n+        MSG_TYPE_UNKNOWN,\n+        // Size\n+        INDEX_COUNT,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137343501",
      "id" : 137343501,
      "original_commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "original_position" : 460,
      "path" : "src/net_processing.cpp",
      "position" : 460,
      "pull_request_review_id" : 60987891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145",
      "updated_at" : "2017-09-06T19:17:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137343501",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137345472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137345472"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No good reason not to make these constant, I think. You can assign them values at initialization by returning from a function or lambda.",
      "commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "created_at" : "2017-09-06T18:05:10Z",
      "diff_hunk" : "@@ -2612,20 +2581,210 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             }\n             LogPrint(BCLog::NET, \"received: feefilter of %s from peer=%d\\n\", CFeeRate(newFeeFilter).ToString(), pfrom->GetId());\n         }\n+        return true;\n     }\n \n-    else if (strCommand == NetMsgType::NOTFOUND) {\n+    static bool ProcessNotFoundMessage(CNode* pfrom, CDataStream& vRecv, int64_t nTimeReceived, const CChainParams& chainparams, CConnman& connman, const std::atomic<bool>& interruptMsgProc)\n+    {\n         // We do not care about the NOTFOUND message, but logging an Unknown Command\n         // message would be undesirable as we transmit it ourselves.\n+        return true;\n     }\n \n-    else {\n-        // Ignore unknown commands for extensibility\n-        LogPrint(BCLog::NET, \"Unknown command \\\"%s\\\" from peer=%d\\n\", SanitizeString(strCommand), pfrom->GetId());\n+    // Message Indexes do not have to be in order\n+    // For whitelist size correctness INDEX_COUNT must come last\n+    enum whitelist_index : uint64_t {\n+        // Message Tags\n+        VERSION,\n+        VERACK,\n+        ADDR,\n+        INV,\n+        GETDATA,\n+        MERKLEBLOCK,\n+        GETBLOCKS,\n+        GETHEADERS,\n+        TX,\n+        HEADERS,\n+        BLOCK,\n+        GETADDR,\n+        MEMPOOL,\n+        PING,\n+        PONG,\n+        NOTFOUND,\n+        FILTERLOAD,\n+        FILTERADD,\n+        FILTERCLEAR,\n+        REJECT,\n+        SENDHEADERS,\n+        FEEFILTER,\n+        SENDCMPCT,\n+        CMPCTBLOCK,\n+        GETBLOCKTXN,\n+        BLOCKTXN,\n+        // Unknown Index\n+        MSG_TYPE_UNKNOWN,\n+        // Size\n+        INDEX_COUNT,\n+    };\n+\n+    typedef std::function<bool(CNode* pfrom, CDataStream& vRecv, int64_t nTimeReceived, const CChainParams& chainparams, CConnman& connman, const std::atomic<bool>& interruptMsgProc)> handler_t;\n+\n+\n+    static const std::map<std::string, std::pair<handler_t, whitelist_index>> handler_registry =\n+    { { NetMsgType::VERSION,     { ProcessVersionMessage,      VERSION     } },\n+    {   NetMsgType::VERACK,      { ProcessVerackMessage,       VERACK      } },\n+    {   NetMsgType::ADDR,        { ProcessAddrMessage,         ADDR        } },\n+    {   NetMsgType::INV,         { ProcessInvMessage,          INV         } },\n+    {   NetMsgType::GETDATA,     { ProcessGetDataMessage,      GETDATA     } },\n+    {   NetMsgType::MERKLEBLOCK, { nullptr,                    MERKLEBLOCK } },\n+    {   NetMsgType::GETBLOCKS,   { ProcessGetBlocksMessage,    GETBLOCKS   } },\n+    {   NetMsgType::GETHEADERS,  { ProcessGetHeadersMessage,   GETHEADERS  } },\n+    {   NetMsgType::TX,          { ProcessTxMessage,           TX          } },\n+    {   NetMsgType::HEADERS,     { ProcessHeadersMessage,      HEADERS     } },\n+    {   NetMsgType::BLOCK,       { ProcessBlockMessage,        BLOCK       } },\n+    {   NetMsgType::GETADDR,     { ProcessGetAddrMessage,      GETADDR     } },\n+    {   NetMsgType::MEMPOOL,     { ProcessMempoolMessage,      MEMPOOL     } },\n+    {   NetMsgType::PING,        { ProcessPingMessage,         PING        } },\n+    {   NetMsgType::PONG,        { ProcessPongMessage,         PONG        } },\n+    {   NetMsgType::NOTFOUND,    { ProcessNotFoundMessage,     NOTFOUND    } },\n+    {   NetMsgType::FILTERLOAD,  { ProcessFilterLoadMessage,   FILTERLOAD  } },\n+    {   NetMsgType::FILTERADD,   { ProcessFilterAddMessage,    FILTERADD   } },\n+    {   NetMsgType::FILTERCLEAR, { ProcessFilterClearMessage,  FILTERCLEAR } },\n+    {   NetMsgType::REJECT,      { ProcessRejectMessage,       REJECT      } },\n+    {   NetMsgType::SENDHEADERS, { ProcessSendHeadersMessage,  SENDHEADERS } },\n+    {   NetMsgType::FEEFILTER,   { ProcessFeeFilterMessage,    FEEFILTER   } },\n+    {   NetMsgType::SENDCMPCT,   { ProcessSendCompactMessage,  SENDCMPCT   } },\n+    {   NetMsgType::CMPCTBLOCK,  { ProcessCompactBlockMessage, CMPCTBLOCK  } },\n+    {   NetMsgType::GETBLOCKTXN, { ProcessGetBlockTxnMessage,  GETBLOCKTXN } },\n+    {   NetMsgType::BLOCKTXN,    { ProcessBlockTxnMessage,     BLOCKTXN    } } };\n+\n+    static const std::pair<handler_t, whitelist_index> failed_lookup {nullptr, MSG_TYPE_UNKNOWN};\n+    const std::pair<handler_t, whitelist_index>& lookup(const std::string& strCommand) {\n+        auto it = handler_registry.find(strCommand);\n+        if (it == handler_registry.end())\n+            return failed_lookup;\n+        return it->second;\n     }\n \n \n \n+    //! Message Processing Whitelists (default init 0)\n+    //! Not const for initialization\n+    static std::array<bool, INDEX_COUNT> KNOWN_MESSAGES {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137345472",
      "id" : 137345472,
      "original_commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "original_position" : 506,
      "path" : "src/net_processing.cpp",
      "position" : 506,
      "pull_request_review_id" : 60987891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145",
      "updated_at" : "2017-09-06T19:17:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137345472",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137354361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137354361"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could you initialize this from the registry table instead of listing all the messages again?",
      "commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "created_at" : "2017-09-06T18:36:46Z",
      "diff_hunk" : "@@ -2612,20 +2581,210 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             }\n             LogPrint(BCLog::NET, \"received: feefilter of %s from peer=%d\\n\", CFeeRate(newFeeFilter).ToString(), pfrom->GetId());\n         }\n+        return true;\n     }\n \n-    else if (strCommand == NetMsgType::NOTFOUND) {\n+    static bool ProcessNotFoundMessage(CNode* pfrom, CDataStream& vRecv, int64_t nTimeReceived, const CChainParams& chainparams, CConnman& connman, const std::atomic<bool>& interruptMsgProc)\n+    {\n         // We do not care about the NOTFOUND message, but logging an Unknown Command\n         // message would be undesirable as we transmit it ourselves.\n+        return true;\n     }\n \n-    else {\n-        // Ignore unknown commands for extensibility\n-        LogPrint(BCLog::NET, \"Unknown command \\\"%s\\\" from peer=%d\\n\", SanitizeString(strCommand), pfrom->GetId());\n+    // Message Indexes do not have to be in order\n+    // For whitelist size correctness INDEX_COUNT must come last\n+    enum whitelist_index : uint64_t {\n+        // Message Tags\n+        VERSION,\n+        VERACK,\n+        ADDR,\n+        INV,\n+        GETDATA,\n+        MERKLEBLOCK,\n+        GETBLOCKS,\n+        GETHEADERS,\n+        TX,\n+        HEADERS,\n+        BLOCK,\n+        GETADDR,\n+        MEMPOOL,\n+        PING,\n+        PONG,\n+        NOTFOUND,\n+        FILTERLOAD,\n+        FILTERADD,\n+        FILTERCLEAR,\n+        REJECT,\n+        SENDHEADERS,\n+        FEEFILTER,\n+        SENDCMPCT,\n+        CMPCTBLOCK,\n+        GETBLOCKTXN,\n+        BLOCKTXN,\n+        // Unknown Index\n+        MSG_TYPE_UNKNOWN,\n+        // Size\n+        INDEX_COUNT,\n+    };\n+\n+    typedef std::function<bool(CNode* pfrom, CDataStream& vRecv, int64_t nTimeReceived, const CChainParams& chainparams, CConnman& connman, const std::atomic<bool>& interruptMsgProc)> handler_t;\n+\n+\n+    static const std::map<std::string, std::pair<handler_t, whitelist_index>> handler_registry =\n+    { { NetMsgType::VERSION,     { ProcessVersionMessage,      VERSION     } },\n+    {   NetMsgType::VERACK,      { ProcessVerackMessage,       VERACK      } },\n+    {   NetMsgType::ADDR,        { ProcessAddrMessage,         ADDR        } },\n+    {   NetMsgType::INV,         { ProcessInvMessage,          INV         } },\n+    {   NetMsgType::GETDATA,     { ProcessGetDataMessage,      GETDATA     } },\n+    {   NetMsgType::MERKLEBLOCK, { nullptr,                    MERKLEBLOCK } },\n+    {   NetMsgType::GETBLOCKS,   { ProcessGetBlocksMessage,    GETBLOCKS   } },\n+    {   NetMsgType::GETHEADERS,  { ProcessGetHeadersMessage,   GETHEADERS  } },\n+    {   NetMsgType::TX,          { ProcessTxMessage,           TX          } },\n+    {   NetMsgType::HEADERS,     { ProcessHeadersMessage,      HEADERS     } },\n+    {   NetMsgType::BLOCK,       { ProcessBlockMessage,        BLOCK       } },\n+    {   NetMsgType::GETADDR,     { ProcessGetAddrMessage,      GETADDR     } },\n+    {   NetMsgType::MEMPOOL,     { ProcessMempoolMessage,      MEMPOOL     } },\n+    {   NetMsgType::PING,        { ProcessPingMessage,         PING        } },\n+    {   NetMsgType::PONG,        { ProcessPongMessage,         PONG        } },\n+    {   NetMsgType::NOTFOUND,    { ProcessNotFoundMessage,     NOTFOUND    } },\n+    {   NetMsgType::FILTERLOAD,  { ProcessFilterLoadMessage,   FILTERLOAD  } },\n+    {   NetMsgType::FILTERADD,   { ProcessFilterAddMessage,    FILTERADD   } },\n+    {   NetMsgType::FILTERCLEAR, { ProcessFilterClearMessage,  FILTERCLEAR } },\n+    {   NetMsgType::REJECT,      { ProcessRejectMessage,       REJECT      } },\n+    {   NetMsgType::SENDHEADERS, { ProcessSendHeadersMessage,  SENDHEADERS } },\n+    {   NetMsgType::FEEFILTER,   { ProcessFeeFilterMessage,    FEEFILTER   } },\n+    {   NetMsgType::SENDCMPCT,   { ProcessSendCompactMessage,  SENDCMPCT   } },\n+    {   NetMsgType::CMPCTBLOCK,  { ProcessCompactBlockMessage, CMPCTBLOCK  } },\n+    {   NetMsgType::GETBLOCKTXN, { ProcessGetBlockTxnMessage,  GETBLOCKTXN } },\n+    {   NetMsgType::BLOCKTXN,    { ProcessBlockTxnMessage,     BLOCKTXN    } } };\n+\n+    static const std::pair<handler_t, whitelist_index> failed_lookup {nullptr, MSG_TYPE_UNKNOWN};\n+    const std::pair<handler_t, whitelist_index>& lookup(const std::string& strCommand) {\n+        auto it = handler_registry.find(strCommand);\n+        if (it == handler_registry.end())\n+            return failed_lookup;\n+        return it->second;\n     }\n \n \n \n+    //! Message Processing Whitelists (default init 0)\n+    //! Not const for initialization\n+    static std::array<bool, INDEX_COUNT> KNOWN_MESSAGES {};\n+    static std::array<bool, INDEX_COUNT> WHILE_IMPORT {};\n+    static std::array<bool, INDEX_COUNT> BEFORE_VERACK {};\n+    static std::array<bool, INDEX_COUNT> BEFORE_VERSION {};\n+    static std::array<bool, INDEX_COUNT> AFTER_VERACK {};\n+    static std::array<bool, INDEX_COUNT> NO_REQUIRE_BLOOM {};\n+\n+    bool init_whitelists() {\n+        for (auto x : { VERSION, VERACK, ADDR, INV, GETDATA, MERKLEBLOCK,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137354361",
      "id" : 137354361,
      "original_commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "original_position" : 514,
      "path" : "src/net_processing.cpp",
      "position" : 514,
      "pull_request_review_id" : 60987891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145",
      "updated_at" : "2017-09-06T19:17:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137354361",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137355038"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137355038"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would be good to have comments describing what each whitelist does, and maybe the types of messages make sense to have in the whitelist. For example, it's not immediately obvious which messages should go in KNOWN_MESSAGES (all the message types, or only the messages types with handlers).\r\n\r\nAlternately could add an overall comment here pointing to the ContextualProcessMessage function for specifics on what the whitelists do.",
      "commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "created_at" : "2017-09-06T18:39:26Z",
      "diff_hunk" : "@@ -2612,20 +2581,210 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             }\n             LogPrint(BCLog::NET, \"received: feefilter of %s from peer=%d\\n\", CFeeRate(newFeeFilter).ToString(), pfrom->GetId());\n         }\n+        return true;\n     }\n \n-    else if (strCommand == NetMsgType::NOTFOUND) {\n+    static bool ProcessNotFoundMessage(CNode* pfrom, CDataStream& vRecv, int64_t nTimeReceived, const CChainParams& chainparams, CConnman& connman, const std::atomic<bool>& interruptMsgProc)\n+    {\n         // We do not care about the NOTFOUND message, but logging an Unknown Command\n         // message would be undesirable as we transmit it ourselves.\n+        return true;\n     }\n \n-    else {\n-        // Ignore unknown commands for extensibility\n-        LogPrint(BCLog::NET, \"Unknown command \\\"%s\\\" from peer=%d\\n\", SanitizeString(strCommand), pfrom->GetId());\n+    // Message Indexes do not have to be in order\n+    // For whitelist size correctness INDEX_COUNT must come last\n+    enum whitelist_index : uint64_t {\n+        // Message Tags\n+        VERSION,\n+        VERACK,\n+        ADDR,\n+        INV,\n+        GETDATA,\n+        MERKLEBLOCK,\n+        GETBLOCKS,\n+        GETHEADERS,\n+        TX,\n+        HEADERS,\n+        BLOCK,\n+        GETADDR,\n+        MEMPOOL,\n+        PING,\n+        PONG,\n+        NOTFOUND,\n+        FILTERLOAD,\n+        FILTERADD,\n+        FILTERCLEAR,\n+        REJECT,\n+        SENDHEADERS,\n+        FEEFILTER,\n+        SENDCMPCT,\n+        CMPCTBLOCK,\n+        GETBLOCKTXN,\n+        BLOCKTXN,\n+        // Unknown Index\n+        MSG_TYPE_UNKNOWN,\n+        // Size\n+        INDEX_COUNT,\n+    };\n+\n+    typedef std::function<bool(CNode* pfrom, CDataStream& vRecv, int64_t nTimeReceived, const CChainParams& chainparams, CConnman& connman, const std::atomic<bool>& interruptMsgProc)> handler_t;\n+\n+\n+    static const std::map<std::string, std::pair<handler_t, whitelist_index>> handler_registry =\n+    { { NetMsgType::VERSION,     { ProcessVersionMessage,      VERSION     } },\n+    {   NetMsgType::VERACK,      { ProcessVerackMessage,       VERACK      } },\n+    {   NetMsgType::ADDR,        { ProcessAddrMessage,         ADDR        } },\n+    {   NetMsgType::INV,         { ProcessInvMessage,          INV         } },\n+    {   NetMsgType::GETDATA,     { ProcessGetDataMessage,      GETDATA     } },\n+    {   NetMsgType::MERKLEBLOCK, { nullptr,                    MERKLEBLOCK } },\n+    {   NetMsgType::GETBLOCKS,   { ProcessGetBlocksMessage,    GETBLOCKS   } },\n+    {   NetMsgType::GETHEADERS,  { ProcessGetHeadersMessage,   GETHEADERS  } },\n+    {   NetMsgType::TX,          { ProcessTxMessage,           TX          } },\n+    {   NetMsgType::HEADERS,     { ProcessHeadersMessage,      HEADERS     } },\n+    {   NetMsgType::BLOCK,       { ProcessBlockMessage,        BLOCK       } },\n+    {   NetMsgType::GETADDR,     { ProcessGetAddrMessage,      GETADDR     } },\n+    {   NetMsgType::MEMPOOL,     { ProcessMempoolMessage,      MEMPOOL     } },\n+    {   NetMsgType::PING,        { ProcessPingMessage,         PING        } },\n+    {   NetMsgType::PONG,        { ProcessPongMessage,         PONG        } },\n+    {   NetMsgType::NOTFOUND,    { ProcessNotFoundMessage,     NOTFOUND    } },\n+    {   NetMsgType::FILTERLOAD,  { ProcessFilterLoadMessage,   FILTERLOAD  } },\n+    {   NetMsgType::FILTERADD,   { ProcessFilterAddMessage,    FILTERADD   } },\n+    {   NetMsgType::FILTERCLEAR, { ProcessFilterClearMessage,  FILTERCLEAR } },\n+    {   NetMsgType::REJECT,      { ProcessRejectMessage,       REJECT      } },\n+    {   NetMsgType::SENDHEADERS, { ProcessSendHeadersMessage,  SENDHEADERS } },\n+    {   NetMsgType::FEEFILTER,   { ProcessFeeFilterMessage,    FEEFILTER   } },\n+    {   NetMsgType::SENDCMPCT,   { ProcessSendCompactMessage,  SENDCMPCT   } },\n+    {   NetMsgType::CMPCTBLOCK,  { ProcessCompactBlockMessage, CMPCTBLOCK  } },\n+    {   NetMsgType::GETBLOCKTXN, { ProcessGetBlockTxnMessage,  GETBLOCKTXN } },\n+    {   NetMsgType::BLOCKTXN,    { ProcessBlockTxnMessage,     BLOCKTXN    } } };\n+\n+    static const std::pair<handler_t, whitelist_index> failed_lookup {nullptr, MSG_TYPE_UNKNOWN};\n+    const std::pair<handler_t, whitelist_index>& lookup(const std::string& strCommand) {\n+        auto it = handler_registry.find(strCommand);\n+        if (it == handler_registry.end())\n+            return failed_lookup;\n+        return it->second;\n     }\n \n \n \n+    //! Message Processing Whitelists (default init 0)\n+    //! Not const for initialization\n+    static std::array<bool, INDEX_COUNT> KNOWN_MESSAGES {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#discussion_r137355038",
      "id" : 137355038,
      "original_commit_id" : "1b389b0e7e57534a2a4b18a2fead70c24dd69ced",
      "original_position" : 506,
      "path" : "src/net_processing.cpp",
      "position" : 506,
      "pull_request_review_id" : 60987891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10145",
      "updated_at" : "2017-09-06T19:17:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/137355038",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've thought about this a good bit lately, sorry for the delayed response.\r\n\r\nAfter rewriting this about a dozen different ways now, I'm now convinced that the approach in #9608 is the way to go.\r\n\r\nA dispatcher with registered functions and a state checker (like you've done here, and like I attempted as well) seems like the obviously correct approach, but once implemented, it's far less straightforward than the simplistic #9608.\r\n\r\nWe can avoid some duplication and keep some of the whitelist functionality here with a few helper functions like CanProcessWhileImporting(command).\r\n\r\nA dumb if/then/else parser seems icky, but I think it's the least likely to cause us issues in the future :(",
      "created_at" : "2017-09-22T22:25:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-331574431",
      "id" : 331574431,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-09-22T22:25:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/331574431",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> A dumb if/then/else parser seems icky, but I think it's the least likely to cause us issues in the future :(\r\n\r\nCan you clarify the kinds of future issues you're worried about? I think something like #9608 is more likely to cause issues. I think verifying correctness of changes to the processing logic is more complicated under #9608. I'd love to understand what other future considerations you're making though.\r\n\r\n\r\n> A dispatcher with registered functions and a state checker (like you've done here, and like I attempted as well) seems like the obviously correct approach, but once implemented, it's far less straightforward than the simplistic #9608.\r\n\r\nI think that there may be a similarity bias. #9608 is more similar to the existing code, which makes it more straightforward. But my guess would be that #10145 is much easier to understand for anyone new to the project/seeing the code for the first time.\r\n\r\n\r\n<hr>\r\n\r\nPersonally, I think this design has the following benefits over the 'simpler' design:\r\n\r\n- Easier to 'prove correct' design/write exhaustive tests for\r\n- Extensible to per connection handler tables\r\n- Extensible to middlewares (e.g., a statistics middleware or maybe an encryption one)\r\n- Easier to add new message types & less chance of hitting an unforseen edge case\r\n- Lower latency dispatch\r\n",
      "created_at" : "2017-09-23T00:16:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-331587174",
      "id" : 331587174,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-09-23T00:16:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/331587174",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Can you clarify the kinds of future issues you're worried about? I think something like #9608 is more likely to cause issues. I think verifying correctness of changes to the processing logic is more complicated under #9608. I'd love to understand what other future considerations you're making though.\r\n\r\nBecause of all of the pesky interactions with our own state, we can only go so far in laying out the rules up-front.\r\n\r\nFor example, someone could be forgiven for assuming (based on the whitelist here) that INVs are processed while importing/reindexing, though in reality, there's only a tiny wallet interaction.\r\n\r\nSimilarly, IsInitialBlockDownload() isn't handled by the dispatcher, leaving it up to individual messages to decide. And that's as it should be, because each message will have their own criteria for that.\r\n\r\nSo if the rules can't be completely enumerated, we're only spreading them out and adding more places to check (or miss). The current behavior (and that of #9608) is to only check for proper handshake behavior outside of individual message parsing. That basically boils down to:\r\n```c++\r\nif (!node->nVersion && strCommand != NetMsgType::VERSION) return;\r\nelse if (!node->fSuccessfullyConnected && strCommand != NetMsgType::VERACK) return;\r\nDispatch(strCommand);\r\n```\r\n\r\nI might be convinced that a slimmed-down version of this that only performed ^^ checks before dispatching would be reasonable.",
      "created_at" : "2017-09-25T20:26:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10145#issuecomment-332001769",
      "id" : 332001769,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10145",
      "updated_at" : "2017-09-25T20:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/332001769",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
