[
   {
      "body" : "This seems right to me and it solved the problem, but I'm not confident enough in understanding startup/shutdown to actually give it an ACK.\r\n\r\nThanks!\r\n",
      "created_at" : "2017-07-13T21:33:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10818#issuecomment-315208268",
      "id" : 315208268,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10818",
      "updated_at" : "2017-07-13T21:33:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315208268",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "utACK https://github.com/bitcoin/bitcoin/commit/73b6b4e7c0a450bb88074a7d59a9237b4703302b",
      "created_at" : "2017-07-13T23:23:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10818#issuecomment-315228236",
      "id" : 315228236,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10818",
      "updated_at" : "2017-07-13T23:23:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315228236",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "body" : "utACK 73b6b4e7c0a450bb88074a7d59a9237b4703302b",
      "created_at" : "2017-07-14T08:13:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10818#issuecomment-315300046",
      "id" : 315300046,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10818",
      "updated_at" : "2017-07-14T08:13:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315300046",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "utACK 73b6b4e7c0a450bb88074a7d59a9237b4703302b",
      "created_at" : "2017-07-14T18:21:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10818#issuecomment-315431213",
      "id" : 315431213,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10818",
      "updated_at" : "2017-07-14T18:21:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315431213",
      "user" : {
         "avatar_url" : "https://avatars7.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "body" : "Why not just make AppInitSanityCheck actually take the lock instead of just probing? It seems strange to call the entire shutdown sequence instead when literally none of it is needed when we already have a framework for skipping it (ala if AppinitSanityCheck fails, except for GUI, which really should be fixed in GUI, not by adding a boolean).",
      "created_at" : "2017-07-14T22:34:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10818#issuecomment-315483601",
      "id" : 315483601,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10818",
      "updated_at" : "2017-07-14T22:34:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315483601",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt I'm confused how that would help here.",
      "created_at" : "2017-07-14T23:41:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10818#issuecomment-315491817",
      "id" : 315491817,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10818",
      "updated_at" : "2017-07-14T23:41:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315491817",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "My point is that this is (effecitlvely) not a problem in bitcoind. The issue in bitcoin-qt is that it calls Shutdown() where it should not (and bitcoind does not). If we want to separately fix the race that is also present in bitcoind, we should stop doing this strange LockDataDirectory(true)...one function return/call later...LockDataDirectory(false) thing.",
      "created_at" : "2017-07-14T23:51:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10818#issuecomment-315492849",
      "id" : 315492849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10818",
      "updated_at" : "2017-07-14T23:51:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315492849",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10818#discussion_r127569154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10818"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127569154"
         }
      },
      "body" : "Should be static and atomic?",
      "commit_id" : "73b6b4e7c0a450bb88074a7d59a9237b4703302b",
      "created_at" : "2017-07-14T23:56:47Z",
      "diff_hunk" : "@@ -75,6 +75,9 @@ static const bool DEFAULT_STOPAFTERBLOCKIMPORT = false;\n std::unique_ptr<CConnman> g_connman;\n std::unique_ptr<PeerLogicValidation> peerLogic;\n \n+/** Set at startup if the data directory was succesfully locked */\n+bool g_locked_data_directory = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10818#discussion_r127569154",
      "id" : 127569154,
      "original_commit_id" : "73b6b4e7c0a450bb88074a7d59a9237b4703302b",
      "original_position" : 5,
      "path" : "src/init.cpp",
      "position" : 5,
      "pull_request_review_id" : 50174396,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10818",
      "updated_at" : "2017-07-14T23:57:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127569154",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10818#discussion_r127579461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10818"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127579461"
         }
      },
      "body" : "static ok, atomic no, there's no concurrent modification as the flag is set from one place in the initialization sequence.",
      "commit_id" : "73b6b4e7c0a450bb88074a7d59a9237b4703302b",
      "created_at" : "2017-07-15T08:04:59Z",
      "diff_hunk" : "@@ -75,6 +75,9 @@ static const bool DEFAULT_STOPAFTERBLOCKIMPORT = false;\n std::unique_ptr<CConnman> g_connman;\n std::unique_ptr<PeerLogicValidation> peerLogic;\n \n+/** Set at startup if the data directory was succesfully locked */\n+bool g_locked_data_directory = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10818#discussion_r127579461",
      "id" : 127579461,
      "original_commit_id" : "73b6b4e7c0a450bb88074a7d59a9237b4703302b",
      "original_position" : 5,
      "path" : "src/init.cpp",
      "position" : 5,
      "pull_request_review_id" : 50184628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10818",
      "updated_at" : "2017-07-15T08:04:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127579461",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : ">  when we already have a framework for skipping it (ala if AppinitSanityCheck fails, except for GUI, which really should be fixed in GUI, not by adding a boolean).\r\n\r\nThe point, which I explain in https://github.com/bitcoin/bitcoin/issues/10815#issuecomment-315170581, is that that mechanism *ALSO* doesn't work for bitcoind.\r\n\r\n> If we want to separately fix the race that is also present in bitcoind, we should stop doing this strange LockDataDirectory(true)...one function return/call later...LockDataDirectory(false) thing.\r\n\r\nThe point of that 'strange sequence' is to be able to give a proper error in the case of `-daemon`.\r\nIf you take the data directory lock before forking, bad things happen. If you only take it after the fork, it's impossible to print an error to the standard output as that has been detached. That's why the probing is done.\r\n\r\nDo you mean calling LockDataDirectory in a separate initialization step after daemonizing? That could work, though as it is already so easy to introduce bugs like this I thought it was more robust to add a flag.",
      "created_at" : "2017-07-15T08:09:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10818#issuecomment-315518308",
      "id" : 315518308,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10818",
      "updated_at" : "2017-07-15T08:09:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315518308",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Closign in favor of #10832",
      "created_at" : "2017-07-15T08:49:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10818#issuecomment-315520298",
      "id" : 315520298,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10818",
      "updated_at" : "2017-07-15T08:49:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315520298",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
