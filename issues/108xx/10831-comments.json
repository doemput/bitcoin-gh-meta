[
   {
      "body" : "@pstratem  you might have some interest in reviewing this.",
      "created_at" : "2017-07-15T04:02:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315507700",
      "id" : 315507700,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-15T04:02:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315507700",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "utACK ff9a291b30d7464c1ff0990b1cab36d6119b2ae5",
      "created_at" : "2017-07-15T18:06:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315551806",
      "id" : 315551806,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-15T18:06:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315551806",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "tACK https://github.com/bitcoin/bitcoin/pull/10831/commits/ff9a291b30d7464c1ff0990b1cab36d6119b2ae5\r\n\r\nwith 1000 keypool size, topup went from 20 seconds to 1.6.",
      "created_at" : "2017-07-15T19:09:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315555429",
      "id" : 315555429,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-15T19:09:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315555429",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "utACK ff9a291b30d7464c1ff0990b1cab36d6119b2ae5 (needs rebase, though). ",
      "created_at" : "2017-07-15T23:41:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315570741",
      "id" : 315570741,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-15T23:41:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315570741",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt  rebased, please re-review",
      "created_at" : "2017-07-16T00:18:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315572295",
      "id" : 315572295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-16T00:18:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315572295",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127619405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127619405"
         }
      },
      "body" : "It seems strange that we're creating a db transaction, only to throw it out in a second. I think its safe, but it might be nicer to let AddKeyPubKeyWithDB create a CWalletDB if it needs one automagically (eg by passing the walletdb in as a pointer).",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-16T23:05:48Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,\n                                                  secret.GetPrivKey(),\n                                                  mapKeyMetadata[pubkey.GetID()]);\n     }\n     return true;\n }\n \n+bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+{\n+    CWalletDB walletdb(*dbw);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127619405",
      "id" : 127619405,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 92,
      "path" : "src/wallet/wallet.cpp",
      "position" : 95,
      "pull_request_review_id" : 50222851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127619405",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622400"
         }
      },
      "body" : "Another approach is to use `dbw` as the storage of the transaction. For instance, `CWalletDBWrapper` could keep a `CBD` instance, referenced counted by `CWalletDB`. This could be thread safe too.",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T01:03:21Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622400",
      "id" : 127622400,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 83,
      "path" : "src/wallet/wallet.cpp",
      "position" : 86,
      "pull_request_review_id" : 50225909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622400",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622496"
         }
      },
      "body" : "I'm happy to write such alternative if there is interest.",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T01:06:20Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622496",
      "id" : 127622496,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 83,
      "path" : "src/wallet/wallet.cpp",
      "position" : 86,
      "pull_request_review_id" : 50226004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622496",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "@promag sadly I think it's a bit late for that for 15, it might be a decent change later, however.\n\nOn July 16, 2017 7:05:52 PM EDT, Matt Corallo <notifications@github.com> wrote:\n>TheBlueMatt commented on this pull request.\n>\n>\n>\n>>                                                  \n>secret.GetPrivKey(),\n>                                       mapKeyMetadata[pubkey.GetID()]);\n>     }\n>     return true;\n> }\n> \n>+bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n>+{\n>+    CWalletDB walletdb(*dbw);\n>\n>It seems strange that we're creating a db transaction, only to throw it\n>out in a second. I think its safe, but it might be nicer to let\n>AddKeyPubKeyWithDB create a CWalletDB if it needs one automagically (eg\n>by passing the walletdb in as a pointer).\n",
      "created_at" : "2017-07-17T01:17:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315652287",
      "id" : 315652287,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-17T01:17:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315652287",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626915"
         }
      },
      "body" : "This isn't called when we don't need one; the case where we already have a dbwallet calls the WithDB version.  (and changing the prototype of the function would mean changing the function it overrides, which a db handle doesn't even make sense for, and 29 callsites) Unless I'm misunderstanding you.",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T02:57:03Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,\n                                                  secret.GetPrivKey(),\n                                                  mapKeyMetadata[pubkey.GetID()]);\n     }\n     return true;\n }\n \n+bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+{\n+    CWalletDB walletdb(*dbw);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626915",
      "id" : 127626915,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 92,
      "path" : "src/wallet/wallet.cpp",
      "position" : 95,
      "pull_request_review_id" : 50230551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626915",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626971"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626971"
         }
      },
      "body" : "Seems like a reasonable thing to do, but I didn't even want to consider anything that complex-- I wanted to eliminate the complaint that having many keys is 'slow' for 0.15 because of the bad interactions with hd-wallet and rescan when the keypool isn't big.",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T02:58:23Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626971",
      "id" : 127626971,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 83,
      "path" : "src/wallet/wallet.cpp",
      "position" : 86,
      "pull_request_review_id" : 50230624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626971",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@TheBlueMatt another PR then.\r\n\r\nutACK 3986271.\r\n",
      "created_at" : "2017-07-17T07:45:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315687135",
      "id" : 315687135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-17T07:45:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315687135",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "reutACK 3986271c0accfe896c66a48d3ed884a7553b6413",
      "created_at" : "2017-07-17T08:03:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315690170",
      "id" : 315690170,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-17T08:03:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315690170",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127649698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127649698"
         }
      },
      "body" : "If we increase the default keypool size, the `LogPrintf(\"keypool added key %d` message below shouldn't be logged for every key. Or at least moved to a debug category. It's ugly to log that many messages at first run, and it is performance overhead too.",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T08:04:17Z",
      "diff_hunk" : "@@ -3183,8 +3201,9 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n                 nEnd = std::max(nEnd, *(setExternalKeyPool.rbegin()) + 1);\n             }\n \n-            if (!walletdb.WritePool(nEnd, CKeyPool(GenerateNewKey(internal), internal)))\n+            if (!walletdb.WritePool(nEnd, CKeyPool(GenerateNewKey(walletdb, internal), internal))) {\n                 throw std::runtime_error(std::string(__func__) + \": writing generated key failed\");\n+            }\n \n             if (internal) {\n                 setInternalKeyPool.insert(nEnd);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127649698",
      "id" : 127649698,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 109,
      "path" : "src/wallet/wallet.cpp",
      "position" : 112,
      "pull_request_review_id" : 50254385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127649698",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127662078"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127662078"
         }
      },
      "body" : "Unrelated, unless you want to fix all style issues?",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T09:16:51Z",
      "diff_hunk" : "@@ -100,27 +100,29 @@ CPubKey CWallet::GenerateNewKey(bool internal)\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        DeriveNewChildKey(metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n+        DeriveNewChildKey(walletdb, metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n     } else {\n         secret.MakeNewKey(fCompressed);\n     }\n \n     // Compressed public keys were introduced in version 0.6.0\n-    if (fCompressed)\n+    if (fCompressed) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127662078",
      "id" : 127662078,
      "original_commit_id" : "4f811059fab9a9121befae09f66b9b12244051f0",
      "original_position" : 21,
      "path" : "src/wallet/wallet.cpp",
      "position" : 21,
      "pull_request_review_id" : 50267883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127662078",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127700902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127700902"
         }
      },
      "body" : "I don't think we should nit people doing partial style issue fixes unless it affects reviewability.",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T13:01:54Z",
      "diff_hunk" : "@@ -100,27 +100,29 @@ CPubKey CWallet::GenerateNewKey(bool internal)\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        DeriveNewChildKey(metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n+        DeriveNewChildKey(walletdb, metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n     } else {\n         secret.MakeNewKey(fCompressed);\n     }\n \n     // Compressed public keys were introduced in version 0.6.0\n-    if (fCompressed)\n+    if (fCompressed) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127700902",
      "id" : 127700902,
      "original_commit_id" : "4f811059fab9a9121befae09f66b9b12244051f0",
      "original_position" : 21,
      "path" : "src/wallet/wallet.cpp",
      "position" : 21,
      "pull_request_review_id" : 50310996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127700902",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "reACK https://github.com/bitcoin/bitcoin/pull/10831/commits/4f811059fab9a9121befae09f66b9b12244051f0",
      "created_at" : "2017-07-17T13:05:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315749702",
      "id" : 315749702,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-17T13:05:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315749702",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127702860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127702860"
         }
      },
      "body" : "Yes, this seems to be a \"damned if you do, damned if you don't\" thing.\r\n- If you deliberately make style fixes to code you touch, you get comments that it's unrelated\r\n- If you deliberately don't make style fixes to code you touch, you get questions why you didn't update the code for the style guidelines\r\n\r\nI think both are valid, unless it makes review-ability in which case it could still be done in a separate commit in the same PR.",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T13:10:34Z",
      "diff_hunk" : "@@ -100,27 +100,29 @@ CPubKey CWallet::GenerateNewKey(bool internal)\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        DeriveNewChildKey(metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n+        DeriveNewChildKey(walletdb, metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n     } else {\n         secret.MakeNewKey(fCompressed);\n     }\n \n     // Compressed public keys were introduced in version 0.6.0\n-    if (fCompressed)\n+    if (fCompressed) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127702860",
      "id" : 127702860,
      "original_commit_id" : "4f811059fab9a9121befae09f66b9b12244051f0",
      "original_position" : 21,
      "path" : "src/wallet/wallet.cpp",
      "position" : 21,
      "pull_request_review_id" : 50313253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127702860",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Nice!\r\nutACK 4f811059fab9a9121befae09f66b9b12244051f0.",
      "created_at" : "2017-07-17T13:20:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315753323",
      "id" : 315753323,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-17T13:20:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315753323",
      "user" : {
         "avatar_url" : "https://avatars7.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127705930"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127705930"
         }
      },
      "body" : "I don't understand this code.\r\nGiven that `pwalletdbEncryption` is not used in `CCryptoKeyStore::AddKeyPubKey`, could this code be moved before `if (!CCryptoKeyStore::AddKeyPubKey`? This would avoid some awkward duplication here.\r\nOr is it used indirectly? This looks really sneaky. Please add a comment if you need to keep it at least, so that no one else gets my bad idea.",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T13:23:28Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127705930",
      "id" : 127705930,
      "original_commit_id" : "4f811059fab9a9121befae09f66b9b12244051f0",
      "original_position" : 66,
      "path" : "src/wallet/wallet.cpp",
      "position" : 69,
      "pull_request_review_id" : 50316634,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127705930",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127709130"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127709130"
         }
      },
      "body" : "It's used-- alas,  the whole purpose of that pre-existing terrible variable is because CCryptoKeyStore::AddKeyPubKey  calls AddCryptedKey which on actual wallets is overridden to the function below.  CCryptoKeyStore rightfully has no concept of wallet databases, so the variable is used to tunnel through it, to get it to the AddCryptedKey override below.  This infrastructure was preexisting because the encryption setup needs it.    I can add a comment explaining it.  Some people have suggested larger refactors to remove this knitted maze, but it's clearly out of scope for now. ",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T13:36:49Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127709130",
      "id" : 127709130,
      "original_commit_id" : "4f811059fab9a9121befae09f66b9b12244051f0",
      "original_position" : 66,
      "path" : "src/wallet/wallet.cpp",
      "position" : 69,
      "pull_request_review_id" : 50320377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127709130",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127711641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127711641"
         }
      },
      "body" : "Added a comment",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T13:46:37Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127711641",
      "id" : 127711641,
      "original_commit_id" : "4f811059fab9a9121befae09f66b9b12244051f0",
      "original_position" : 66,
      "path" : "src/wallet/wallet.cpp",
      "position" : 69,
      "pull_request_review_id" : 50323222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T13:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127711641",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127715298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127715298"
         }
      },
      "body" : "Aggregated to a summary line.",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T14:00:16Z",
      "diff_hunk" : "@@ -3183,8 +3201,9 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n                 nEnd = std::max(nEnd, *(setExternalKeyPool.rbegin()) + 1);\n             }\n \n-            if (!walletdb.WritePool(nEnd, CKeyPool(GenerateNewKey(internal), internal)))\n+            if (!walletdb.WritePool(nEnd, CKeyPool(GenerateNewKey(walletdb, internal), internal))) {\n                 throw std::runtime_error(std::string(__func__) + \": writing generated key failed\");\n+            }\n \n             if (internal) {\n                 setInternalKeyPool.insert(nEnd);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127715298",
      "id" : 127715298,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 109,
      "path" : "src/wallet/wallet.cpp",
      "position" : 112,
      "pull_request_review_id" : 50327462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T14:00:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127715298",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127715733"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127715733"
         }
      },
      "body" : "I have been trying to limit them to things that will show up in the same patch hunks, and only changes which I'm pretty sure won't break review.   I'm happy to do what other people want, though I prefer to at least fix braces (because I dislike reviewing the risky looking unbraced code myself)-- but ultimately I just need clear guidance to avoid the damned if/don't.",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T14:01:56Z",
      "diff_hunk" : "@@ -100,27 +100,29 @@ CPubKey CWallet::GenerateNewKey(bool internal)\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        DeriveNewChildKey(metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n+        DeriveNewChildKey(walletdb, metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n     } else {\n         secret.MakeNewKey(fCompressed);\n     }\n \n     // Compressed public keys were introduced in version 0.6.0\n-    if (fCompressed)\n+    if (fCompressed) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127715733",
      "id" : 127715733,
      "original_commit_id" : "4f811059fab9a9121befae09f66b9b12244051f0",
      "original_position" : 21,
      "path" : "src/wallet/wallet.cpp",
      "position" : 21,
      "pull_request_review_id" : 50327936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T14:01:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127715733",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "(new revisions are just due to adding a comment in the middle of the patch stack)",
      "created_at" : "2017-07-17T14:02:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315764720",
      "id" : 315764720,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-17T14:02:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315764720",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127737165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127737165"
         }
      },
      "body" : "I was confused, sorry.",
      "commit_id" : "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
      "created_at" : "2017-07-17T15:17:18Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,\n                                                  secret.GetPrivKey(),\n                                                  mapKeyMetadata[pubkey.GetID()]);\n     }\n     return true;\n }\n \n+bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+{\n+    CWalletDB walletdb(*dbw);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127737165",
      "id" : 127737165,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 92,
      "path" : "src/wallet/wallet.cpp",
      "position" : 95,
      "pull_request_review_id" : 50351530,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T15:17:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127737165",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "postumous utACK b0e8e2de8408cbaed9d70914c67b4c9f11397cb7 (lets clean up some of this stuff in 16).",
      "created_at" : "2017-07-17T15:19:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315786724",
      "id" : 315786724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-17T15:19:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315786724",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
