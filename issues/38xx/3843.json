{
   "assignee" : null,
   "body" : "tl;dr: CHECKMULTISIG has a bug that causes it to consume an extra dummy argument on the stack. While normally OP_0 is used, the actual value of this argument is not checked, and thus creates a source of mutability for any transaction with CHECKMULTISIG inputs.\r\n\r\nSo to fix this we do a few things:\r\n\r\n1) Introduce the notion of mandatory and standard script verification flags. The former is what all *new* blocks must adhere to - currently just P2SH - while the latter are soft restrictions that may later become mandatory in a soft-fork such as signature encoding checks. (the canonical PUSHDATA checks should become a verification flag as well in a future pull-req)\r\n\r\n2) Modify tx_(in)valid unit tests to allow verification flags to be specified by name rather than only P2SH. (again, tests of the STRICTENC flags should be added in a future pull-req)\r\n\r\n3) Add the SCRIPT_VERIFY_NULLDUMMY flag and corresponding code to EvalScript() to verify that the dummy argument is in fact null. Rational: checking this as a IsStandard() test would be awkward, and a future soft-fork should make this mandatory anyway. I also added more unittests, including an explicit check to tx_invalid.json that a lack of a dummy argument *does* fail the transaction. Tested that blocks breaking this rule are accepted, including a testnet and mainnet reindex.\r\n\r\n4) Generalize the SCRIPTENC DoS-ban exemption to all non-mandatory SCRIPT_VERIFY flags so that we don't split the network. Note the minor logic error we fixed: previously an invalid P2SH transaction with the inner script failing was classified as REJECT_NONSTANDARD with the message \"non-canonical\"; a future pull-req can make the new messages more useful if EvalScript() is modified to return rejection strings or similar. (or god forbid, something like the scary-complex exception based scheme in my python-bitcoinlib that'll surely add a consensus bug) Tested by injecting non-compliant transactions elsewhere on the network and observing debug.log\r\n\r\nWith the dummy argument checked, we can remove the weird arbitrary limits on the # of signatures by upping the allowed scriptSig size, letting advanced escrow/oracle/etc. applications do as they wish within the 15 pubkey/520 byte redeemScript limit with P2SH. (see https://github.com/bitcoin/bips/pull/24) With the dummy value forced to always be null, the \"stuff data in the chain\" situation remains essentially unchanged as all the extra scriptSig space can only be used for signatures; the non-P2SH limit is kept as-is and remains <= 3 pubkeys.\r\n\r\nFinally, now is a good time to teach addmultisigaddress/createmultisig/the wallet to raise an error on >520 byte redeemScripts.",
   "closed_at" : "2014-05-09T14:09:30Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 16,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3843/comments",
   "created_at" : "2014-03-11T05:55:53Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3843/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/3843",
   "id" : 29155675,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3843/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : "2015-12-03T11:08:31Z",
      "closed_issues" : 134,
      "created_at" : "2013-12-05T10:34:42Z",
      "creator" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      },
      "description" : "",
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestones/0.10.0",
      "id" : 505738,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/14/labels",
      "number" : 14,
      "open_issues" : 0,
      "state" : "closed",
      "title" : "0.10.0",
      "updated_at" : "2015-12-03T11:08:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/14"
   },
   "number" : 3843,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/3843.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3843",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/3843.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3843"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Fix CHECKMULTISIG mutability and remove P2SH CHECKMULTISIG # of signatures limit",
   "updated_at" : "2014-06-12T15:01:14Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3843",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
      "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
      "followers_url" : "https://api.github.com/users/petertodd/followers",
      "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
      "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/petertodd",
      "id" : 7042,
      "login" : "petertodd",
      "organizations_url" : "https://api.github.com/users/petertodd/orgs",
      "received_events_url" : "https://api.github.com/users/petertodd/received_events",
      "repos_url" : "https://api.github.com/users/petertodd/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/petertodd"
   }
}
