[
   {
      "body" : "Update OP with a correction and a more relevant statistic.",
      "created_at" : "2017-03-09T19:10:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-285449398",
      "id" : 285449398,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-09T19:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/285449398",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105249723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105249723"
         }
      },
      "body" : "Might make more sense to put these on the class, rather than pass by-reference?",
      "commit_id" : "4d1eb109f0fe2b4d7389b11913e11d429c60f7a3",
      "created_at" : "2017-03-09T19:27:22Z",
      "diff_hunk" : "@@ -177,7 +179,11 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     // transaction (which in most cases can be a no-op).\n     fIncludeWitness = IsWitnessEnabled(pindexPrev, chainparams.GetConsensus());\n \n-    addPackageTxs();\n+    int nPackagesSelected = 0;\n+    int nDescendantsUpdated = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105249723",
      "id" : 105249723,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 15,
      "path" : "src/miner.cpp",
      "position" : 15,
      "pull_request_review_id" : 26120724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-29T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105249723",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105250148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105250148"
         }
      },
      "body" : "The old code used 50 for this. Does 1000 work good enough in practice?",
      "commit_id" : "4d1eb109f0fe2b4d7389b11913e11d429c60f7a3",
      "created_at" : "2017-03-09T19:29:06Z",
      "diff_hunk" : "@@ -358,6 +370,12 @@ void BlockAssembler::addPackageTxs()\n \n     CTxMemPool::indexed_transaction_set::index<ancestor_score>::type::iterator mi = mempool.mapTx.get<ancestor_score>().begin();\n     CTxMemPool::txiter iter;\n+\n+    // Limit the number of attempts to add transactions to the block when it is\n+    // close to full.\n+    const int64_t MAX_CONSECUTIVE_FAILURES = 1000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105250148",
      "id" : 105250148,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 76,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 26120724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-29T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105250148",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105250686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105250686"
         }
      },
      "body" : "Perhaps the additional condition(s) should be before incrementing, or we could end up just aborting immediately as we approach the max block weight even if we could easily fit a few more txs in.",
      "commit_id" : "4d1eb109f0fe2b4d7389b11913e11d429c60f7a3",
      "created_at" : "2017-03-09T19:31:31Z",
      "diff_hunk" : "@@ -419,6 +437,14 @@ void BlockAssembler::addPackageTxs()\n                 mapModifiedTx.get<ancestor_score>().erase(modit);\n                 failedTx.insert(iter);\n             }\n+\n+            ++nConsecutiveFailed;\n+\n+            if (nConsecutiveFailed > MAX_CONSECUTIVE_FAILURES && nBlockWeight >\n+                    nBlockMaxWeight - 4000) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105250686",
      "id" : 105250686,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 90,
      "path" : "src/miner.cpp",
      "position" : 91,
      "pull_request_review_id" : 26120724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-29T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105250686",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "utACK 03a407662b008fe030d81bb54dfd3b677b248392, didnt bother to benchmark, should be obvious wins, even if minor.",
      "created_at" : "2017-03-09T20:05:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-285465536",
      "id" : 285465536,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-09T20:05:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/285465536",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396576"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396576"
         }
      },
      "body" : "I'm working on a refactor of the `BlockAssembler` members separately (as part of a patch to exclude recent transactions from new blocks, when the fee difference is negligible), so I'd prefer to defer the decision of whether to include this in the class until I'm ready to PR that patch.",
      "commit_id" : "4d1eb109f0fe2b4d7389b11913e11d429c60f7a3",
      "created_at" : "2017-03-10T13:33:49Z",
      "diff_hunk" : "@@ -177,7 +179,11 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     // transaction (which in most cases can be a no-op).\n     fIncludeWitness = IsWitnessEnabled(pindexPrev, chainparams.GetConsensus());\n \n-    addPackageTxs();\n+    int nPackagesSelected = 0;\n+    int nDescendantsUpdated = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396576",
      "id" : 105396576,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 15,
      "path" : "src/miner.cpp",
      "position" : 15,
      "pull_request_review_id" : 26276554,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-29T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396576",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396657"
         }
      },
      "body" : "Yes, well I also tried setting this to 100 and the performance was not really distinguishable.",
      "commit_id" : "4d1eb109f0fe2b4d7389b11913e11d429c60f7a3",
      "created_at" : "2017-03-10T13:34:25Z",
      "diff_hunk" : "@@ -358,6 +370,12 @@ void BlockAssembler::addPackageTxs()\n \n     CTxMemPool::indexed_transaction_set::index<ancestor_score>::type::iterator mi = mempool.mapTx.get<ancestor_score>().begin();\n     CTxMemPool::txiter iter;\n+\n+    // Limit the number of attempts to add transactions to the block when it is\n+    // close to full.\n+    const int64_t MAX_CONSECUTIVE_FAILURES = 1000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396657",
      "id" : 105396657,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 76,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 26276653,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-29T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396657",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396891"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396891"
         }
      },
      "body" : "I'm not following; every time we add a new tx to the block we reset the counter...  Can you clarify?",
      "commit_id" : "4d1eb109f0fe2b4d7389b11913e11d429c60f7a3",
      "created_at" : "2017-03-10T13:36:00Z",
      "diff_hunk" : "@@ -419,6 +437,14 @@ void BlockAssembler::addPackageTxs()\n                 mapModifiedTx.get<ancestor_score>().erase(modit);\n                 failedTx.insert(iter);\n             }\n+\n+            ++nConsecutiveFailed;\n+\n+            if (nConsecutiveFailed > MAX_CONSECUTIVE_FAILURES && nBlockWeight >\n+                    nBlockMaxWeight - 4000) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396891",
      "id" : 105396891,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 90,
      "path" : "src/miner.cpp",
      "position" : 91,
      "pull_request_review_id" : 26276914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-29T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396891",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Is this worth backporting (my vote would be weak yes)?",
      "created_at" : "2017-03-24T21:24:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-289146625",
      "id" : 289146625,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-24T21:25:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/289146625",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@thebluematt I don't feel strongly about whether we backport this change, to be honest (though it's simple enough that I don't think there's any downside).  \r\n\r\nBut it would be nice to merge this into master if there are no further comments, so I can continue work on additional mining changes (to support excluding recently received transactions if the fee difference from doing so is below some threshold).",
      "created_at" : "2017-03-26T17:20:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-289299885",
      "id" : 289299885,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-26T17:20:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/289299885",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r108526783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108526783"
         }
      },
      "body" : "Can you rename to nDescendantsUpdated to make clear that it should not be initialized to `alreadyAdded.size()`",
      "commit_id" : "4d1eb109f0fe2b4d7389b11913e11d429c60f7a3",
      "created_at" : "2017-03-28T20:20:20Z",
      "diff_hunk" : "@@ -282,16 +291,18 @@ void BlockAssembler::AddToBlock(CTxMemPool::txiter iter)\n     }\n }\n \n-void BlockAssembler::UpdatePackagesForAdded(const CTxMemPool::setEntries& alreadyAdded,\n+int BlockAssembler::UpdatePackagesForAdded(const CTxMemPool::setEntries& alreadyAdded,\n         indexed_modified_transaction_set &mapModifiedTx)\n {\n+    int nDescendants = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r108526783",
      "id" : 108526783,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 40,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 29563529,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-29T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108526783",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r108533154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108533154"
         }
      },
      "body" : "This is a really interesting section. I got a bit nerd-sniped so apologies for long writeup.\r\n\r\nDoing the following may be more efficient (I can code this up, but I don't want to step on your toes if you're operating here). \r\n\r\n```c++\r\nstd::vector<txiter> diff(descendants.size());\r\nauto end = std::set_difference(descendants.begin(), descendants.end(),\r\n     alreadyAdded.begin(), alreadyAdded.end(), diff.begin()); // Linear time!\r\nnDescendants += end - diff.begin();\r\nfor (auto it = diff.begin(); it != diff.end(); ++it) {\r\n  // ....\r\n} \r\n```\r\nIt requires an extra copy compared to the naive, but they're iterators so who cares (we can also reuse the vector for the entire call at the top of updatepackages)...\r\n\r\nLet N = alreadyAdded.size()\r\nLet M = descendants.size()\r\nThis does `O(M+N)` work (I *think* that most implementations actually do `O(max(M, N))`, but the standard specified `2*(M+N-1)`), while what's currently happening would appear to be `O(M*log(N))`.\r\n\r\nThere is also a pre-loop-check one could do if it's likely they don't intersect.\r\n```c++\r\n// O(1)\r\nif (descendants.back() < alreadyAdded.front() || descendants.front() > alreadAdded.back())\r\n    // skip set_difference, descendants - alreadyAdded = descendants\r\n```\r\nAnd a pre-loop narrowing one could do to make it O(min(M, N)).\r\n```c++\r\n// O(log(M) + log(N))\r\nauto range1 = descendants.equal_range(alreadyAdded.begin(), alreadyAdded.end())\r\nauto range2 = alreadyAdded.equal_range(descendants.begin(), descendants.end())\r\nstd::vector<txiter> diff(range1.second - range1.first);\r\nauto end = std::set_difference(range1.first, range1.second,\r\n     range2.first, range2.second, diff.begin()); // Linear time!\r\nnDescendants += end - diff.begin();\r\nfor (auto it = diff.begin(); it != diff.end(); ++it) {\r\n  // ....\r\n} \r\n```\r\n\r\n",
      "commit_id" : "4d1eb109f0fe2b4d7389b11913e11d429c60f7a3",
      "created_at" : "2017-03-28T20:48:03Z",
      "diff_hunk" : "@@ -282,16 +291,18 @@ void BlockAssembler::AddToBlock(CTxMemPool::txiter iter)\n     }\n }\n \n-void BlockAssembler::UpdatePackagesForAdded(const CTxMemPool::setEntries& alreadyAdded,\n+int BlockAssembler::UpdatePackagesForAdded(const CTxMemPool::setEntries& alreadyAdded,\n         indexed_modified_transaction_set &mapModifiedTx)\n {\n+    int nDescendants = 0;\n     BOOST_FOREACH(const CTxMemPool::txiter it, alreadyAdded) {\n         CTxMemPool::setEntries descendants;\n         mempool.CalculateDescendants(it, descendants);\n         // Insert all descendants (not yet in block) into the modified set\n         BOOST_FOREACH(CTxMemPool::txiter desc, descendants) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r108533154",
      "id" : 108533154,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 45,
      "path" : "src/miner.cpp",
      "position" : 45,
      "pull_request_review_id" : 29563529,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-29T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108533154",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r108546226"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108546226"
         }
      },
      "body" : "Could you add more of a comment on why resetting is correct behavior here?\r\n\r\nIt seems to me at first glance, that if we fail to add something earlier, we should continue to tally those as failures?\r\nPerhaps:\r\n```\r\nAssuming that below a certain threshold `T` of probability\r\n(i.e.,`T = P(success at M | failure at M-1....0)` where `M = 1000`) \r\nof adding something to the block we want to give up,\r\n we expect that \r\n`1000>D>0. P(success at N+D+1 | failure at N+D,... success at N, failure at N-1, ...) \r\n> P(success at N+D | failure at N, failure at N-1, ...)`?\r\n```\r\n\r\nMaybe not the most accurate, but would be helpful for future reviewers trying to understand what the intention is.",
      "commit_id" : "4d1eb109f0fe2b4d7389b11913e11d429c60f7a3",
      "created_at" : "2017-03-28T21:51:19Z",
      "diff_hunk" : "@@ -439,6 +465,9 @@ void BlockAssembler::addPackageTxs()\n             continue;\n         }\n \n+        // This transaction will make it in; reset the failed counter.\n+        nConsecutiveFailed = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r108546226",
      "id" : 108546226,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 102,
      "path" : "src/miner.cpp",
      "position" : 103,
      "pull_request_review_id" : 29563529,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-29T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108546226",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r108710551"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108710551"
         }
      },
      "body" : "Thanks, will try some of these out in future optimization efforts.",
      "commit_id" : "4d1eb109f0fe2b4d7389b11913e11d429c60f7a3",
      "created_at" : "2017-03-29T15:38:51Z",
      "diff_hunk" : "@@ -282,16 +291,18 @@ void BlockAssembler::AddToBlock(CTxMemPool::txiter iter)\n     }\n }\n \n-void BlockAssembler::UpdatePackagesForAdded(const CTxMemPool::setEntries& alreadyAdded,\n+int BlockAssembler::UpdatePackagesForAdded(const CTxMemPool::setEntries& alreadyAdded,\n         indexed_modified_transaction_set &mapModifiedTx)\n {\n+    int nDescendants = 0;\n     BOOST_FOREACH(const CTxMemPool::txiter it, alreadyAdded) {\n         CTxMemPool::setEntries descendants;\n         mempool.CalculateDescendants(it, descendants);\n         // Insert all descendants (not yet in block) into the modified set\n         BOOST_FOREACH(CTxMemPool::txiter desc, descendants) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r108710551",
      "id" : 108710551,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 45,
      "path" : "src/miner.cpp",
      "position" : 45,
      "pull_request_review_id" : 29759630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-29T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108710551",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r108722176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108722176"
         }
      },
      "body" : "This is incremented whenever we fail (not just for failures after we're above a certain block weight), so it needs to be reset when adding a new tx.",
      "commit_id" : "4d1eb109f0fe2b4d7389b11913e11d429c60f7a3",
      "created_at" : "2017-03-29T16:23:54Z",
      "diff_hunk" : "@@ -439,6 +465,9 @@ void BlockAssembler::addPackageTxs()\n             continue;\n         }\n \n+        // This transaction will make it in; reset the failed counter.\n+        nConsecutiveFailed = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r108722176",
      "id" : 108722176,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 102,
      "path" : "src/miner.cpp",
      "position" : 103,
      "pull_request_review_id" : 29772350,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-29T16:38:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/108722176",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Addressed @JeremyRubin's nits.",
      "created_at" : "2017-03-29T16:40:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-290148594",
      "id" : 290148594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-29T16:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/290148594",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "re-utack 4d1eb10",
      "created_at" : "2017-03-29T16:41:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-290148970",
      "id" : 290148970,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-29T16:41:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/290148970",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "Squashed 4d1eb10 -> 011124a",
      "created_at" : "2017-03-29T17:59:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-290171987",
      "id" : 290171987,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-29T17:59:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/290171987",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "re-utACK 011124a2b278c5a60bad5f1b0b4abbf7ebc95aa0",
      "created_at" : "2017-03-29T19:13:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-290195556",
      "id" : 290195556,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-29T19:13:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/290195556",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Removing 'needs backport' label as a backport exists (#10127)",
      "created_at" : "2017-03-31T09:46:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-290668756",
      "id" : 290668756,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-31T09:46:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/290668756",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
