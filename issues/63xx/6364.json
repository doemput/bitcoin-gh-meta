{
   "assignee" : null,
   "body" : "# Summary\r\n\r\n@gavinandresen reported a Tor-based DoS against one of his nodes a few days ago. He found his node had run out of connection slots and his peers were almost all Tor exits, additionally, his node had stopped following the block chain (likely an inv/getdata exploit but not known for sure).\r\n\r\nThere are other patches tackling the inv/getdata issue. This patch tackles the other problem, of a jammed node using all its resources to accept connections from a DoS attacker. It lays the foundation for a resource scheduling approach to handling DoS attacks, which runs in parallel to the existing blacklist-on-badness approach.\r\n\r\n# Approach\r\n\r\nA notion of IP groups is introduced. An IP group is a logically related set of subnets with a name and a score. The score of an ungrouped IP is zero. When a node reaches nMaxConnections, the IP of a newly accepted connection is checked against the groups and its priority thus calculated. If the priority is higher than an existing connection, that connection is dropped to make room for the new connection. If it is equal or lower then the existing behaviour of rejecting the new connection is used.\r\n\r\nNext, a list of Tor exits is compiled into the binary (a later patch could make the download dynamic, or overridable with a local file). Tor exits get a score of -10 by default, reflecting their tendency to be used for attacks. Thus if a peer is connected to by lots of Tor exits, those connections will be serviced, but clearnet clients will take priority and if need be, kick out one of the Tor connections to make room. \r\n\r\nThis behaviour is much preferable to the more obvious solution of requiring node operators to manually ban all Tor exits during the type of attack Gavin witnessed.\r\n\r\n# Future evolution\r\n\r\nThis patch creates a base that can be evolved in future. For example, the protocol could allow peers to effectively 'buy' priority by proving ownership of coin age. This would allow e.g. an SPV wallet connecting via Tor to take priority over a DoS attack from the clearnet, thus inverting things. However such a protocol is not in this patch.\r\n\r\nSmaller improvements might be:\r\n\r\n1. Allow loading of IP groups from a file, so people witnessing a jamming attack from other netblocks can easily de-prioritise them.\r\n2. Refresh the Tor exits list from https://check.torproject.org/ from time to time.\r\n3. Queue transactions and signature checks according to peer priority, to fix the \"ban every Tor exit by sending bad signatures\" attack.\r\n4. Boost the priority for peers that engage in useful behaviour, like relaying valid blocks and transactions (possibly only with an open port?).\r\n5. Slowly lower the priority for connections that seem to be idle. Thus new connections would kick out long term idle connections. This is more a solution to temporary organic load spikes than DoS attacks because of course this rule would be trivially gamed by an attacker who just disconnects and reconnects every so often.\r\n\r\n",
   "closed_at" : "2015-07-03T13:17:07Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 33,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6364/comments",
   "created_at" : "2015-07-02T11:59:10Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6364/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/6364",
   "id" : 92619784,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6364/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 6364,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/6364.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6364",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/6364.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6364"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Anti DoS: give Tor exits a lower priority than clearnet peers",
   "updated_at" : "2015-08-27T18:12:19Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6364",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
      "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
      "followers_url" : "https://api.github.com/users/mikehearn/followers",
      "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
      "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/mikehearn",
      "id" : 971089,
      "login" : "mikehearn",
      "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
      "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
      "repos_url" : "https://api.github.com/users/mikehearn/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/mikehearn"
   }
}
