[
   {
      "body" : "Concept ACK.  I suppose this timeout could later be made dynamic like has been proposed block transfer timeouts.",
      "created_at" : "2017-05-06T08:16:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#issuecomment-299624029",
      "id" : 299624029,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10345",
      "updated_at" : "2017-05-06T08:16:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/299624029",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115312237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115312237"
         }
      },
      "body" : "```gcc\r\nerror: Ã¢ÂÂconst NodeId CNode::idÃ¢ÂÂ is private within this context",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-05-08T17:59:20Z",
      "diff_hunk" : "@@ -3211,6 +3215,24 @@ bool SendMessages(CNode* pto, CConnman& connman, const std::atomic<bool>& interr\n                 return true;\n             }\n         }\n+        // Check for headers sync timeouts\n+        if (state.fSyncStarted) {\n+            // Detect whether this is a stalling initial-headers-sync peer\n+            if (pindexBestHeader->GetBlockTime() <= GetAdjustedTime() - 24*60*60) {\n+                if (nNow > state.nHeadersSyncTimeout && !pto->fWhitelisted && nSyncStarted == 1 && (nPreferredDownload - state.fPreferredDownload >= 1)) {\n+                    // Disconnect a (non-whitelisted) peer if it is our only sync peer,\n+                    // and we have others we could be using instead.\n+                    LogPrintf(\"Timeout downloading headers from peer=%d, disconnecting\\n\", pto->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115312237",
      "id" : 115312237,
      "original_commit_id" : "1ac0cb8d186ae16a2dfa7bf9e2163c3bc559fa28",
      "original_position" : 45,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 36841101,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115312237",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "body" : "Rebased after #10189.",
      "created_at" : "2017-05-08T18:33:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#issuecomment-299951955",
      "id" : 299951955,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10345",
      "updated_at" : "2017-05-08T18:33:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/299951955",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115325581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115325581"
         }
      },
      "body" : "It should be `pto->GetId()`.",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-05-08T18:56:09Z",
      "diff_hunk" : "@@ -3211,6 +3215,24 @@ bool SendMessages(CNode* pto, CConnman& connman, const std::atomic<bool>& interr\n                 return true;\n             }\n         }\n+        // Check for headers sync timeouts\n+        if (state.fSyncStarted) {\n+            // Detect whether this is a stalling initial-headers-sync peer\n+            if (pindexBestHeader->GetBlockTime() <= GetAdjustedTime() - 24*60*60) {\n+                if (nNow > state.nHeadersSyncTimeout && !pto->fWhitelisted && nSyncStarted == 1 && (nPreferredDownload - state.fPreferredDownload >= 1)) {\n+                    // Disconnect a (non-whitelisted) peer if it is our only sync peer,\n+                    // and we have others we could be using instead.\n+                    LogPrintf(\"Timeout downloading headers from peer=%d, disconnecting\\n\", pto->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115325581",
      "id" : 115325581,
      "original_commit_id" : "1ac0cb8d186ae16a2dfa7bf9e2163c3bc559fa28",
      "original_position" : 45,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 36855377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115325581",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/6848764?v=3",
         "events_url" : "https://api.github.com/users/paveljanik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paveljanik/followers",
         "following_url" : "https://api.github.com/users/paveljanik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paveljanik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paveljanik",
         "id" : 6848764,
         "login" : "paveljanik",
         "organizations_url" : "https://api.github.com/users/paveljanik/orgs",
         "received_events_url" : "https://api.github.com/users/paveljanik/received_events",
         "repos_url" : "https://api.github.com/users/paveljanik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paveljanik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paveljanik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paveljanik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115414242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115414242"
         }
      },
      "body" : "nit: `Once we've caught up once`",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-05-09T06:16:13Z",
      "diff_hunk" : "@@ -3206,6 +3210,24 @@ bool SendMessages(CNode* pto, CConnman& connman, const std::atomic<bool>& interr\n                 return true;\n             }\n         }\n+        // Check for headers sync timeouts\n+        if (state.fSyncStarted) {\n+            // Detect whether this is a stalling initial-headers-sync peer\n+            if (pindexBestHeader->GetBlockTime() <= GetAdjustedTime() - 24*60*60) {\n+                if (nNow > state.nHeadersSyncTimeout && !pto->fWhitelisted && nSyncStarted == 1 && (nPreferredDownload - state.fPreferredDownload >= 1)) {\n+                    // Disconnect a (non-whitelisted) peer if it is our only sync peer,\n+                    // and we have others we could be using instead.\n+                    LogPrintf(\"Timeout downloading headers from peer=%d, disconnecting\\n\", pto->GetId());\n+                    pto->fDisconnect = true;\n+                    return true;\n+                }\n+            } else {\n+                // Once we've caught up once, reset the timeout so we can't trigger",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115414242",
      "id" : 115414242,
      "original_commit_id" : "ca4aebd3c50bc424afd25a5611a6ea1e77429413",
      "original_position" : 41,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 36947436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115414242",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "utACK ca4aebd3c50bc424afd25a5611a6ea1e77429413\r\n\r\nFor the hybrid SPV mode (#9483), a fast headers sync is crucial and also for normal operations, someone could significant delay your initial sync.\r\nIf you connect to a malicious or just a very slow peer (It happened to me a couple of times), couldn't you  Ã¢ÂÂ in theory Ã¢ÂÂ spend a couple of hours syncing headers? Even after this PR, I guess a peer could serve you the 2k headers package every 10minutes (while pong accordingly) leading to a header sync of more then 30h.\r\n\r\nI'm not sure if this is solvable without to much of effort, maybe the only solution would be parallel headers download... or at least a check among a handful of peers which could serve 3x2000 headers the fastest.",
      "created_at" : "2017-05-09T06:25:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#issuecomment-300072776",
      "id" : 300072776,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10345",
      "updated_at" : "2017-05-09T06:25:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/300072776",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "> If you connect to a malicious or just a very slow peer (It happened to me a couple of times), couldn't you Ã¢ÂÂ in theory Ã¢ÂÂ spend a couple of hours syncing headers? Even after this PR, I guess a peer could serve you the 2k headers package every 10minutes (while pong accordingly) leading to a header sync of more then 30h.\r\n\r\n@jonasschnelli After this PR, if you have started syncing headers from your initial sync peer and your pindexBestHeader isn't caught up to within 24 hours of current time, then you'll disconnect them.  So this puts a timeout on the entire headers sync (a bit over 20 minutes, currently -- 15 minutes + 1 ms/[expected number of headers]).\r\n\r\nOnce our headers chain is within 24 hours of current time, we'll request headers from our other peers as well, so after that point as long as one of your peers isn't stalling you, you'll get the headers chain.",
      "created_at" : "2017-05-09T12:28:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#issuecomment-300147692",
      "id" : 300147692,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10345",
      "updated_at" : "2017-05-09T12:28:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/300147692",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Thanks @sdaftuar for the explanation. Make sense.\r\nI thought the timer resets after each headers message. A 20min delay hurts but is probably unavoidable (the fact that we don't know the bandwidth limitations and potentials).",
      "created_at" : "2017-05-09T12:34:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#issuecomment-300149090",
      "id" : 300149090,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10345",
      "updated_at" : "2017-05-09T12:34:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/300149090",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115502373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115502373"
         }
      },
      "body" : "Improved the comment in 898fc2ac689aa77e74362aa27d12120256c1942e.",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-05-09T14:21:58Z",
      "diff_hunk" : "@@ -3206,6 +3210,24 @@ bool SendMessages(CNode* pto, CConnman& connman, const std::atomic<bool>& interr\n                 return true;\n             }\n         }\n+        // Check for headers sync timeouts\n+        if (state.fSyncStarted) {\n+            // Detect whether this is a stalling initial-headers-sync peer\n+            if (pindexBestHeader->GetBlockTime() <= GetAdjustedTime() - 24*60*60) {\n+                if (nNow > state.nHeadersSyncTimeout && !pto->fWhitelisted && nSyncStarted == 1 && (nPreferredDownload - state.fPreferredDownload >= 1)) {\n+                    // Disconnect a (non-whitelisted) peer if it is our only sync peer,\n+                    // and we have others we could be using instead.\n+                    LogPrintf(\"Timeout downloading headers from peer=%d, disconnecting\\n\", pto->GetId());\n+                    pto->fDisconnect = true;\n+                    return true;\n+                }\n+            } else {\n+                // Once we've caught up once, reset the timeout so we can't trigger",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115502373",
      "id" : 115502373,
      "original_commit_id" : "ca4aebd3c50bc424afd25a5611a6ea1e77429413",
      "original_position" : 41,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 37044752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115502373",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115555913"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115555913"
         }
      },
      "body" : "I believe usually its good practice to print if we would otherwise have disconnected a whitelisted peer.",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-05-09T17:50:40Z",
      "diff_hunk" : "@@ -3206,6 +3210,24 @@ bool SendMessages(CNode* pto, CConnman& connman, const std::atomic<bool>& interr\n                 return true;\n             }\n         }\n+        // Check for headers sync timeouts\n+        if (state.fSyncStarted && state.nHeadersSyncTimeout < std::numeric_limits<int64_t>::max()) {\n+            // Detect whether this is a stalling initial-headers-sync peer\n+            if (pindexBestHeader->GetBlockTime() <= GetAdjustedTime() - 24*60*60) {\n+                if (nNow > state.nHeadersSyncTimeout && !pto->fWhitelisted && nSyncStarted == 1 && (nPreferredDownload - state.fPreferredDownload >= 1)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115555913",
      "id" : 115555913,
      "original_commit_id" : "898fc2ac689aa77e74362aa27d12120256c1942e",
      "original_position" : 42,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 37103993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115555913",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115556822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115556822"
         }
      },
      "body" : "If I can take this opportunity to bikeshed your constants - why even bother with a base timeout this high? maybe just a minute (to handle the really-close-to-done-dont-want-a-1ms-timeout case) and then double/tripple the TIMEOUT_PER_HEADER?",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-05-09T17:54:14Z",
      "diff_hunk" : "@@ -17,6 +17,10 @@ static const int64_t ORPHAN_TX_EXPIRE_TIME = 20 * 60;\n static const int64_t ORPHAN_TX_EXPIRE_INTERVAL = 5 * 60;\n /** Default number of orphan+recently-replaced txn to keep around for block reconstruction */\n static const unsigned int DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN = 100;\n+/** Headers download timeout expressed in microseconds\n+ *  Timeout = base + per_header * (expected number of headers) */\n+static constexpr int64_t HEADERS_DOWNLOAD_TIMEOUT_BASE = 15 * 60 * 1000000; // 15 minutes",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115556822",
      "id" : 115556822,
      "original_commit_id" : "898fc2ac689aa77e74362aa27d12120256c1942e",
      "original_position" : 6,
      "path" : "src/net_processing.h",
      "position" : 6,
      "pull_request_review_id" : 37103993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115556822",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115791043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115791043"
         }
      },
      "body" : "I just wanted to do something clearly safe (it's easy to reason about booting your sync peer potentially every 15 minutes, but slightly scarier to think there could be a circumstance you'd boot that peer every 1 minute).\r\n\r\nAnyway I'd like to see what other opinions are, I'm fine adjusting them however people would like...",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-05-10T16:39:12Z",
      "diff_hunk" : "@@ -17,6 +17,10 @@ static const int64_t ORPHAN_TX_EXPIRE_TIME = 20 * 60;\n static const int64_t ORPHAN_TX_EXPIRE_INTERVAL = 5 * 60;\n /** Default number of orphan+recently-replaced txn to keep around for block reconstruction */\n static const unsigned int DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN = 100;\n+/** Headers download timeout expressed in microseconds\n+ *  Timeout = base + per_header * (expected number of headers) */\n+static constexpr int64_t HEADERS_DOWNLOAD_TIMEOUT_BASE = 15 * 60 * 1000000; // 15 minutes",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115791043",
      "id" : 115791043,
      "original_commit_id" : "898fc2ac689aa77e74362aa27d12120256c1942e",
      "original_position" : 6,
      "path" : "src/net_processing.h",
      "position" : 6,
      "pull_request_review_id" : 37360953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115791043",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115796792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115796792"
         }
      },
      "body" : "Fixed in a27ff02f537a3225372e1e1286f0a93fb9037ba9",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-05-10T17:05:04Z",
      "diff_hunk" : "@@ -3206,6 +3210,24 @@ bool SendMessages(CNode* pto, CConnman& connman, const std::atomic<bool>& interr\n                 return true;\n             }\n         }\n+        // Check for headers sync timeouts\n+        if (state.fSyncStarted && state.nHeadersSyncTimeout < std::numeric_limits<int64_t>::max()) {\n+            // Detect whether this is a stalling initial-headers-sync peer\n+            if (pindexBestHeader->GetBlockTime() <= GetAdjustedTime() - 24*60*60) {\n+                if (nNow > state.nHeadersSyncTimeout && !pto->fWhitelisted && nSyncStarted == 1 && (nPreferredDownload - state.fPreferredDownload >= 1)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r115796792",
      "id" : 115796792,
      "original_commit_id" : "898fc2ac689aa77e74362aa27d12120256c1942e",
      "original_position" : 42,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 37367518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115796792",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Addressed @TheBlueMatt's nit in a fixup commit, let me know if I can squash.",
      "created_at" : "2017-05-10T17:06:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#issuecomment-300548572",
      "id" : 300548572,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10345",
      "updated_at" : "2017-05-10T17:06:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/300548572",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r117833095"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/117833095"
         }
      },
      "body" : "`nPreferredDownload - state.fPreferredDownload >= 1` was slightly confusing for me. It's saying we should only timeout a peer if we have another peer which is preferred. This doesn't exactly match the logic in `SendMessages()` where we'll try to start block sync from a non-preferred peer if we don't have any better options.\r\n\r\nI think this is fine. It's not obvious that we should time out a peer if we don't have any other options which are preferred, but perhaps a comment here would make this clearer.",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-05-22T20:03:43Z",
      "diff_hunk" : "@@ -3206,6 +3210,28 @@ bool SendMessages(CNode* pto, CConnman& connman, const std::atomic<bool>& interr\n                 return true;\n             }\n         }\n+        // Check for headers sync timeouts\n+        if (state.fSyncStarted && state.nHeadersSyncTimeout < std::numeric_limits<int64_t>::max()) {\n+            // Detect whether this is a stalling initial-headers-sync peer\n+            if (pindexBestHeader->GetBlockTime() <= GetAdjustedTime() - 24*60*60) {\n+                if (nNow > state.nHeadersSyncTimeout && nSyncStarted == 1 && (nPreferredDownload - state.fPreferredDownload >= 1)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r117833095",
      "id" : 117833095,
      "original_commit_id" : "a27ff02f537a3225372e1e1286f0a93fb9037ba9",
      "original_position" : 42,
      "path" : "src/net_processing.cpp",
      "position" : 42,
      "pull_request_review_id" : 39572619,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/117833095",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r117839792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/117839792"
         }
      },
      "body" : "Added a comment in 595d51c",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-05-22T20:38:16Z",
      "diff_hunk" : "@@ -3206,6 +3210,28 @@ bool SendMessages(CNode* pto, CConnman& connman, const std::atomic<bool>& interr\n                 return true;\n             }\n         }\n+        // Check for headers sync timeouts\n+        if (state.fSyncStarted && state.nHeadersSyncTimeout < std::numeric_limits<int64_t>::max()) {\n+            // Detect whether this is a stalling initial-headers-sync peer\n+            if (pindexBestHeader->GetBlockTime() <= GetAdjustedTime() - 24*60*60) {\n+                if (nNow > state.nHeadersSyncTimeout && nSyncStarted == 1 && (nPreferredDownload - state.fPreferredDownload >= 1)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r117839792",
      "id" : 117839792,
      "original_commit_id" : "a27ff02f537a3225372e1e1286f0a93fb9037ba9",
      "original_position" : 42,
      "path" : "src/net_processing.cpp",
      "position" : 42,
      "pull_request_review_id" : 39579950,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/117839792",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "re-utACK https://github.com/bitcoin/bitcoin/commit/595d51c2b746c4473a02e0417dd42c840b1f589c",
      "created_at" : "2017-05-22T20:46:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#issuecomment-303215506",
      "id" : 303215506,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10345",
      "updated_at" : "2017-05-22T20:47:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/303215506",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r119639235"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/119639235"
         }
      },
      "body" : "\"downleading\"",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-06-01T15:01:30Z",
      "diff_hunk" : "@@ -3206,6 +3210,31 @@ bool SendMessages(CNode* pto, CConnman& connman, const std::atomic<bool>& interr\n                 return true;\n             }\n         }\n+        // Check for headers sync timeouts\n+        if (state.fSyncStarted && state.nHeadersSyncTimeout < std::numeric_limits<int64_t>::max()) {\n+            // Detect whether this is a stalling initial-headers-sync peer\n+            if (pindexBestHeader->GetBlockTime() <= GetAdjustedTime() - 24*60*60) {\n+                if (nNow > state.nHeadersSyncTimeout && nSyncStarted == 1 && (nPreferredDownload - state.fPreferredDownload >= 1)) {\n+                    // Disconnect a (non-whitelisted) peer if it is our only sync peer,\n+                    // and we have others we could be using instead.\n+                    // Note: If all our peers are inbound, then we won't\n+                    // disconnect our sync peer for stalling; we have bigger\n+                    // problems if we can't get any outbound peers.\n+                    if (!pto->fWhitelisted) {\n+                        LogPrintf(\"Timeout downloading headers from peer=%d, disconnecting\\n\", pto->GetId());\n+                        pto->fDisconnect = true;\n+                        return true;\n+                    } else {\n+                        LogPrintf(\"Timeout downleading headers from whitelisted peer=%d, not disconnecting\\n\", pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r119639235",
      "id" : 119639235,
      "original_commit_id" : "595d51c2b746c4473a02e0417dd42c840b1f589c",
      "original_position" : 53,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 41537298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/119639235",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r119658608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/119658608"
         }
      },
      "body" : "Additionally, it would be nice to unset this peer as fSyncStarted so that we pick another peer to donwnload from, in case the whitelisted sync peer is broken.",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-06-01T16:08:59Z",
      "diff_hunk" : "@@ -3206,6 +3210,31 @@ bool SendMessages(CNode* pto, CConnman& connman, const std::atomic<bool>& interr\n                 return true;\n             }\n         }\n+        // Check for headers sync timeouts\n+        if (state.fSyncStarted && state.nHeadersSyncTimeout < std::numeric_limits<int64_t>::max()) {\n+            // Detect whether this is a stalling initial-headers-sync peer\n+            if (pindexBestHeader->GetBlockTime() <= GetAdjustedTime() - 24*60*60) {\n+                if (nNow > state.nHeadersSyncTimeout && nSyncStarted == 1 && (nPreferredDownload - state.fPreferredDownload >= 1)) {\n+                    // Disconnect a (non-whitelisted) peer if it is our only sync peer,\n+                    // and we have others we could be using instead.\n+                    // Note: If all our peers are inbound, then we won't\n+                    // disconnect our sync peer for stalling; we have bigger\n+                    // problems if we can't get any outbound peers.\n+                    if (!pto->fWhitelisted) {\n+                        LogPrintf(\"Timeout downloading headers from peer=%d, disconnecting\\n\", pto->GetId());\n+                        pto->fDisconnect = true;\n+                        return true;\n+                    } else {\n+                        LogPrintf(\"Timeout downleading headers from whitelisted peer=%d, not disconnecting\\n\", pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r119658608",
      "id" : 119658608,
      "original_commit_id" : "595d51c2b746c4473a02e0417dd42c840b1f589c",
      "original_position" : 53,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 41537298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/119658608",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r119683082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/119683082"
         }
      },
      "body" : "Addressed both of these comments in https://github.com/bitcoin/bitcoin/pull/10345/commits/65e300812f7ebc10c80a625d31a2b55a89db4348",
      "commit_id" : "76f74811c44b5119d5c19364b0594d423248ac0e",
      "created_at" : "2017-06-01T17:45:41Z",
      "diff_hunk" : "@@ -3206,6 +3210,31 @@ bool SendMessages(CNode* pto, CConnman& connman, const std::atomic<bool>& interr\n                 return true;\n             }\n         }\n+        // Check for headers sync timeouts\n+        if (state.fSyncStarted && state.nHeadersSyncTimeout < std::numeric_limits<int64_t>::max()) {\n+            // Detect whether this is a stalling initial-headers-sync peer\n+            if (pindexBestHeader->GetBlockTime() <= GetAdjustedTime() - 24*60*60) {\n+                if (nNow > state.nHeadersSyncTimeout && nSyncStarted == 1 && (nPreferredDownload - state.fPreferredDownload >= 1)) {\n+                    // Disconnect a (non-whitelisted) peer if it is our only sync peer,\n+                    // and we have others we could be using instead.\n+                    // Note: If all our peers are inbound, then we won't\n+                    // disconnect our sync peer for stalling; we have bigger\n+                    // problems if we can't get any outbound peers.\n+                    if (!pto->fWhitelisted) {\n+                        LogPrintf(\"Timeout downloading headers from peer=%d, disconnecting\\n\", pto->GetId());\n+                        pto->fDisconnect = true;\n+                        return true;\n+                    } else {\n+                        LogPrintf(\"Timeout downleading headers from whitelisted peer=%d, not disconnecting\\n\", pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#discussion_r119683082",
      "id" : 119683082,
      "original_commit_id" : "595d51c2b746c4473a02e0417dd42c840b1f589c",
      "original_position" : 53,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 41586166,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10345",
      "updated_at" : "2017-06-05T20:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/119683082",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Squashed 65e300812 -> 76f74811c",
      "created_at" : "2017-06-05T20:34:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#issuecomment-306297250",
      "id" : 306297250,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10345",
      "updated_at" : "2017-06-05T20:34:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/306297250",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "utACK 76f7481",
      "created_at" : "2017-06-06T10:23:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10345#issuecomment-306444754",
      "id" : 306444754,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10345",
      "updated_at" : "2017-06-06T10:23:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/306444754",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
