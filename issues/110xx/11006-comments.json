[
   {
      "body" : "With this change the time should be significantly lower than 5 seconds. This was motivated by [@jnewbery comment](https://github.com/bitcoin/bitcoin/pull/11000#pullrequestreview-54752223).",
      "created_at" : "2017-08-08T03:14:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-320838481",
      "id" : 320838481,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-08T03:33:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/320838481",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "For the record, running with version libevent@2.1.8.\r\n\r\nIf there is a minimum version required, can it be defined, like boost?",
      "created_at" : "2017-08-08T03:39:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-320841416",
      "id" : 320841416,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-08T03:39:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/320841416",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "This PR should just have 2195bb0e579336f2b9adfb9a2e23957e794f5621. You can remove the other commits.\r\n\r\nYou could potentially protect this change with a preprocessor:\r\n\r\n```\r\n#if LIBEVENT_VERSION_NUMBER >= 0x02xxxxxx\r\n```\r\n\r\nI don't know what version of libevent the `event_base_loopexit` behaviour was fixed. Perhaps @laanwj can offer some clues (he's the author of #6990).\r\n\r\nDefinitely seems like a good win for test run times.",
      "created_at" : "2017-08-08T09:48:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-320907764",
      "id" : 320907764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-08T09:48:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/320907764",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11006#discussion_r131868878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11006"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131868878"
         }
      },
      "body" : "I don't get it - you don't give any rationale for reverting this and removing the comment.",
      "commit_id" : "2195bb0e579336f2b9adfb9a2e23957e794f5621",
      "created_at" : "2017-08-08T09:51:58Z",
      "diff_hunk" : "@@ -481,16 +479,7 @@ void StopHTTPServer()\n     }\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n-        // Before this was solved with event_base_loopexit, but that didn't work as expected in\n-        // at least libevent 2.0.21 and always introduced a delay. In libevent\n-        // master that appears to be solved, so in the future that solution\n-        // could be used again (if desirable).\n-        // (see discussion in https://github.com/bitcoin/bitcoin/pull/6990)\n-        if (threadResult.valid() && threadResult.wait_for(std::chrono::milliseconds(2000)) == std::future_status::timeout) {\n-            LogPrintf(\"HTTP event loop did not exit within allotted time, sending loopbreak\\n\");\n-            event_base_loopbreak(eventBase);\n-        }\n+        event_base_loopexit(eventBase, nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#discussion_r131868878",
      "id" : 131868878,
      "original_commit_id" : "2195bb0e579336f2b9adfb9a2e23957e794f5621",
      "original_position" : 30,
      "path" : "src/httpserver.cpp",
      "position" : 30,
      "pull_request_review_id" : 54887479,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11006",
      "updated_at" : "2017-08-08T09:52:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131868878",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "> I don't know what version of libevent the event_base_loopexit behaviour was fixed. Perhaps @laanwj can offer some clues (he's the author of #6990).\r\n\r\nNo, I don't know, and we certainly can't assume that everyone is building against a version where this is fixed. Not least because libevent's release schedule is very slow.",
      "created_at" : "2017-08-08T09:53:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-320908901",
      "id" : 320908901,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-08T09:56:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/320908901",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11006#discussion_r131869569"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11006"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131869569"
         }
      },
      "body" : "As I understand it, removing the timeout here (resulting in instant shutdown) means that responses from RPC `stop` might not come back, as the http event handler is killed before that could finish. This resulted in intermittent travis errors.",
      "commit_id" : "2195bb0e579336f2b9adfb9a2e23957e794f5621",
      "created_at" : "2017-08-08T09:55:09Z",
      "diff_hunk" : "@@ -481,16 +479,7 @@ void StopHTTPServer()\n     }\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n-        // Before this was solved with event_base_loopexit, but that didn't work as expected in\n-        // at least libevent 2.0.21 and always introduced a delay. In libevent\n-        // master that appears to be solved, so in the future that solution\n-        // could be used again (if desirable).\n-        // (see discussion in https://github.com/bitcoin/bitcoin/pull/6990)\n-        if (threadResult.valid() && threadResult.wait_for(std::chrono::milliseconds(2000)) == std::future_status::timeout) {\n-            LogPrintf(\"HTTP event loop did not exit within allotted time, sending loopbreak\\n\");\n-            event_base_loopbreak(eventBase);\n-        }\n+        event_base_loopexit(eventBase, nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#discussion_r131869569",
      "id" : 131869569,
      "original_commit_id" : "2195bb0e579336f2b9adfb9a2e23957e794f5621",
      "original_position" : 30,
      "path" : "src/httpserver.cpp",
      "position" : 30,
      "pull_request_review_id" : 54888260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11006",
      "updated_at" : "2017-08-08T09:55:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131869569",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11006#discussion_r131869966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11006"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131869966"
         }
      },
      "body" : "No, that happens when evhttp_free is called.",
      "commit_id" : "2195bb0e579336f2b9adfb9a2e23957e794f5621",
      "created_at" : "2017-08-08T09:57:04Z",
      "diff_hunk" : "@@ -481,16 +479,7 @@ void StopHTTPServer()\n     }\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n-        // Before this was solved with event_base_loopexit, but that didn't work as expected in\n-        // at least libevent 2.0.21 and always introduced a delay. In libevent\n-        // master that appears to be solved, so in the future that solution\n-        // could be used again (if desirable).\n-        // (see discussion in https://github.com/bitcoin/bitcoin/pull/6990)\n-        if (threadResult.valid() && threadResult.wait_for(std::chrono::milliseconds(2000)) == std::future_status::timeout) {\n-            LogPrintf(\"HTTP event loop did not exit within allotted time, sending loopbreak\\n\");\n-            event_base_loopbreak(eventBase);\n-        }\n+        event_base_loopexit(eventBase, nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#discussion_r131869966",
      "id" : 131869966,
      "original_commit_id" : "2195bb0e579336f2b9adfb9a2e23957e794f5621",
      "original_position" : 30,
      "path" : "src/httpserver.cpp",
      "position" : 30,
      "pull_request_review_id" : 54888723,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11006",
      "updated_at" : "2017-08-08T09:57:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131869966",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "@jnewbery yes extra commits were mistakenly pushed when testing with other branch. Will fix.",
      "created_at" : "2017-08-08T09:58:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-320910185",
      "id" : 320910185,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-08T09:58:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/320910185",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11006#discussion_r131870509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11006"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131870509"
         }
      },
      "body" : "I'm sure that at least used to be the case, we had problems here in the past, this is why this particular shutdown sequence was changed so many times.",
      "commit_id" : "2195bb0e579336f2b9adfb9a2e23957e794f5621",
      "created_at" : "2017-08-08T09:59:36Z",
      "diff_hunk" : "@@ -481,16 +479,7 @@ void StopHTTPServer()\n     }\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n-        // Before this was solved with event_base_loopexit, but that didn't work as expected in\n-        // at least libevent 2.0.21 and always introduced a delay. In libevent\n-        // master that appears to be solved, so in the future that solution\n-        // could be used again (if desirable).\n-        // (see discussion in https://github.com/bitcoin/bitcoin/pull/6990)\n-        if (threadResult.valid() && threadResult.wait_for(std::chrono::milliseconds(2000)) == std::future_status::timeout) {\n-            LogPrintf(\"HTTP event loop did not exit within allotted time, sending loopbreak\\n\");\n-            event_base_loopbreak(eventBase);\n-        }\n+        event_base_loopexit(eventBase, nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#discussion_r131870509",
      "id" : 131870509,
      "original_commit_id" : "2195bb0e579336f2b9adfb9a2e23957e794f5621",
      "original_position" : 30,
      "path" : "src/httpserver.cpp",
      "position" : 30,
      "pull_request_review_id" : 54889284,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11006",
      "updated_at" : "2017-08-08T09:59:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131870509",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj what about keeping the older code for older libevents?",
      "created_at" : "2017-08-08T09:59:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-320910436",
      "id" : 320910436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-08T09:59:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/320910436",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "> @laanwjÃÂ what about keeping the older code for older libevents?\r\n\r\nYes, I'd say that is a requirement.\r\n",
      "created_at" : "2017-08-08T10:00:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-320910573",
      "id" : 320910573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-08T10:00:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/320910573",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj @jnewbery will try to dissect which version has bad behaviour.\r\n\r\nWill add a comment before `event_base_loopexit`.",
      "created_at" : "2017-08-08T12:36:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-320942743",
      "id" : 320942743,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-08T12:36:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/320942743",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "With `libevent@2.0.21` (the version that supposedly has issues with `event_base_loopexit` everything seems to work (at least on my system). Maybe the problem was in other place? I'll dig a bit more.",
      "created_at" : "2017-08-09T06:36:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-321166680",
      "id" : 321166680,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-09T06:36:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/321166680",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : ">  everything seems to work (at least on my system)\r\n\r\nAs I remember the intermittent errors on issuing `stop`, might well not happen locally in good-weather conditions. As we all know, travis VMs run on overbooked, extremely busy servers, so it's more likely to happen there. Maybe it can be simulated by adding an artificial delay somewhere, my hunch would be to have the client side read the RPC response to `stop` after a delay.",
      "created_at" : "2017-08-09T09:46:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-321208102",
      "id" : 321208102,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-09T09:46:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/321208102",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj - forgive me, I'm trying to piece together the history of changes to the shutdown procedure:\r\n\r\n- In #6719, you changed from using `event_base_loopbreak()` to `event_base_loopexit()` with a timeout. That was to make sure that the server shut down gracefully and didn't just drop responses to pending requests.\r\n- In #6990, you say that '`event_base_loopexit` was not doing what I expected it to. What I expected was that it sets a timeout, given that no other pending events it would exit in N seconds. However, what it does was delay the event loop exit with N seconds, even if nothing is pending.' I can't understand the difference between those two statements. That PR switches from calling `event_base_loopexit()` to call `event_base_loopbreak()` after a 2 second delay.\r\n- Later in the same PR, you say 'it appears that with libevent master, this issue doesn't exist.\r\n`event_base_loopexit` does actually do what I expect it to in the OP.' Looking at the documentation, if `event_base_loopexit` is called with a time value, then it will always wait for that long before exiting. If it's called without a time value, it'll exit after the next base loop iteration (http://www.wangafu.net/~nickm/libevent-2.1/doxygen/html/event_8h.html#ab89f0c907906f784fc80a3107016c3dc)\r\n\r\nSo I think what we want is to just call `event_base_loopexit()` without a time value. That would allow the current loop to exit, so shutdown should be graceful. I can't tell from the history or your notes whether you tried that before. Is there any reason that wouldn't work? (specifically, I'm just looking for your issue with `event_base_loopexit` was)",
      "created_at" : "2017-08-09T20:35:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-321373993",
      "id" : 321373993,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-09T20:35:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/321373993",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "Oh, and Concept ACK:\r\n\r\nlocally with this PR:\r\n```\r\nTEST                           | STATUS    | DURATION\r\n\r\nabandonconflict.py             | Ã¢ÂÂ Passed  | 4 s \r\n...\r\nzmq_test.py                    | Ã¢ÂÂ Passed  | 2 s \r\n\r\nALL                            | Ã¢ÂÂ Passed  | 630 s (accumulated)\r\nRuntime: 162 s\r\n```\r\nlocally without this PR:\r\n```\r\nTEST                           | STATUS    | DURATION\r\n\r\nabandonconflict.py             | Ã¢ÂÂ Passed  | 14 s\r\n...\r\nzmq_test.py                    | Ã¢ÂÂ Passed  | 7 s \r\n\r\nALL                            | Ã¢ÂÂ Passed  | 985 s (accumulated)\r\nRuntime: 269 s\r\n```\r\n\r\nSeems like a huge win (40% over the BASE_SCRIPTS test suite)",
      "created_at" : "2017-08-09T20:36:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-321374204",
      "id" : 321374204,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-09T20:53:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/321374204",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "Nice @jnewbery. Furthermore, the the docs say\r\n```\r\ntv\tthe amount of time after which the loop should terminate, or NULL to exit after running all currently active events.\r\n```\r\nAnd while the RPC response is being handled, there is an active event.",
      "created_at" : "2017-08-09T20:42:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-321375653",
      "id" : 321375653,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-09T20:42:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/321375653",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "IMO we should just add the loop exit, and keep the break after the timeout.",
      "created_at" : "2017-08-09T20:44:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-321376111",
      "id" : 321376111,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-09T20:44:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/321376111",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "> IMO we should just add the loop exit, and keep the break after the timeout.\r\n\r\nSounds reasonable if you're able to test this against old versions of libevent (and pending any further background info from @laanwj)",
      "created_at" : "2017-08-09T20:55:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-321378695",
      "id" : 321378695,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-09T20:55:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/321378695",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "@laanwj you mean:\r\n```diff\r\ndiff --git a/test/functional/test_framework/authproxy.py b/test/functional/test_framework/authproxy.py\r\nindex b3671cbdc..5a2f9c514 100644\r\n--- a/test/functional/test_framework/authproxy.py\r\n+++ b/test/functional/test_framework/authproxy.py\r\n@@ -166,6 +166,8 @@ class AuthServiceProxy(object):\r\n     def _get_response(self):\r\n         req_start_time = time.time()\r\n         try:\r\n+            if self._service_name == 'stop':\r\n+                time.sleep(3)\r\n             http_response = self.__conn.getresponse()\r\n         except socket.timeout as e:\r\n             raise JSONRPCException({\r\n```\r\nAll looks good, even with `libevent@2.0.21`.",
      "created_at" : "2017-08-12T03:33:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-321954764",
      "id" : 321954764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-08-12T03:33:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/321954764",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "utACK 793667a, my concerns have been addressed.",
      "created_at" : "2017-10-18T14:06:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11006#issuecomment-337602720",
      "id" : 337602720,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11006",
      "updated_at" : "2017-10-18T14:06:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/337602720",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
