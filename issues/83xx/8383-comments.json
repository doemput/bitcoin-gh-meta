[
   {
      "body" : "Thanks @dooglus for reporting.\r\nI just double-checked and right Ã¢ÂÂÃÂ as you have edited Ã¢ÂÂ the keypool gets discarded once you encrypt the wallet.\r\n\r\nBut you are right. The seed key will be kept which can be problematic.\r\nGenerating a new seed once the user encrypt could be a solution, though I think it could be unexpected from the user perspective (it would invalidate his old backup probably done before he encrypted the wallet).\r\n\r\nOther solutions? Add a boolean parameter to encryptwallet to force regeneration of the seed?\r\n\r\nMaybe another solution would be to allow a startup argument -encryptwallet=<password> which would directly encrypt wallets during the phase of creation. It could also encrypt already existing wallets.",
      "created_at" : "2016-07-20T18:38:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-234041298",
      "id" : 234041298,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-20T18:38:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234041298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "> I think it could be unexpected from the user perspective (it would invalidate his old backup probably done before he encrypted the wallet).\r\n\r\nI'm not familiar with the behavior of the new HD wallet code. Isn't each derived private key stored in the wallet as it is derived? If so, changing the seed as we encrypt won't invalidate old backups any more than encrypting already does in v0.12 and earlier. When we encrypt a wallet in v0.12 we invalidate the keypool that was written in the old backup, while maintaining the validity of the backup for private keys which had already been used at the time of the backup. Changing the HD seed should be the same as that, so long as the private keys that were already derived have been written to the wallet file.\r\n\r\nIt appears as if the intention of this BIP32 implementation is to make the change pretty much invisible to the user. But we have accidentally introduced a new security hole: it is now impossible (without disabling the HD feature) to create an encrypted wallet without the unencrypted HD seed being written to wallet.dat.",
      "created_at" : "2016-07-20T20:29:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-234072187",
      "id" : 234072187,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-20T20:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234072187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "I played around with the code to see what would happen if we changed the HD seed when the wallet is encrypted. It behaves how I would expect - the addresses which were used before encryption are still in the wallet after encryption, along with their private keys, so old unencrypted backups aren't invalidated. Here's the change I made:\r\n\r\n    diff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\r\n    index a76085d..cacf102 100644\r\n    --- a/src/wallet/wallet.cpp\r\n    +++ b/src/wallet/wallet.cpp\r\n    @@ -626,6 +626,14 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\r\n     \r\n             Lock();\r\n             Unlock(strWalletPassphrase);\r\n    +\r\n    +        // if we have a master key replace it with a new one\r\n    +        if (!hdChain.masterKeyID.IsNull()) {\r\n    +            CKey newMasterKey;\r\n    +            newMasterKey.MakeNewKey(true);\r\n    +            SetHDMasterKey(newMasterKey);\r\n    +        }\r\n    +\r\n             NewKeyPool();\r\n             Lock();\r\n     \r\n\r\nIt is probably not enough, because I don't know how to handle the case that SetHDMasterKey() throws an exception. But it's enough to demonstrate that changing the HD seed on encryption doesn't break old backups.",
      "created_at" : "2016-07-20T23:50:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-234118399",
      "id" : 234118399,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-20T23:50:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234118399",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "The recent change to HD does allow users to regenerate every possible key as long as they have a first backup (regardless if it was done directly after wallet creation).\r\n\r\nI think you change would makes sense, but, we need to inform the user that once they encrypt the wallet, old backup would no longer be capable of recreating future keys.",
      "created_at" : "2016-07-21T07:50:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-234182043",
      "id" : 234182043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-21T07:50:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234182043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "> The recent change to HD does allow users to regenerate every possible key as long as they have a first backup\r\n\r\nIt does, but it also invalidates encryption, since it likely leaves an unencrypted copy of their HD seed on disk somewhere.\r\n\r\n> we need to inform the user that once they encrypt the wallet, old backup would no longer be capable of recreating future keys\r\n\r\nThat has always been the case (except in the flawed 0.13rc1) and we should always have been warning about it.",
      "created_at" : "2016-07-21T15:49:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-234296622",
      "id" : 234296622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-21T15:49:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234296622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "I agree that encrypting should cause a change of deterministic seed. We\nshould check that sufficient warning is given in the UI about backups being\ninvalidated.\n\nI think the warning requirement is stronger now. Before, users *always* had\nto backup their wallets at least every keypool receive addresses. HD\nsupport is however switching to a model where continuous backups are no\nlonger necessarily required, so it may become less expected that encrypting\ninvalidates them nonetheless.\n",
      "created_at" : "2016-07-21T15:52:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-234297849",
      "id" : 234297849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-21T15:52:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234297849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Seems like an issue that should be solved before 0.13 final - to keep using the master key that is stored in plain breaks with how we've always done things. It is a fatal leak.\r\n\r\n> I think you change would makes sense, but, we need to inform the user that once they encrypt the wallet, old backup would no longer be capable of recreating future keys.\r\n\r\nDon't we warn of this yet when encrypting?",
      "created_at" : "2016-07-21T17:41:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-234328247",
      "id" : 234328247,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-21T17:41:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234328247",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I could imagine some people want their wallet encrypted but keep the HD seed they generated initially. We should not make this impossible.\r\n\r\nI think @jonasschnelli mentioned that the encryptwallet rpc could take a bool parameter to specify if the existing HD seed should be discarded. This needs to be implemented in qt as well, imo.",
      "created_at" : "2016-07-21T17:50:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-234330785",
      "id" : 234330785,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-21T17:50:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234330785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "body" : "Working on a simple fix now which should be ready in a couple of hours.",
      "created_at" : "2016-07-21T18:15:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-234337849",
      "id" : 234337849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-21T18:15:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234337849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "> I could imagine some people want their wallet encrypted but keep the HD seed they generated initially. We should not make this impossible.\r\n\r\nI agree, no need to make it impossible. Advanced users may have their own reasons for opting to keep using the same seed. But for added security, the default should be to generate a new one.\r\n",
      "created_at" : "2016-07-25T12:06:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-234935159",
      "id" : 234935159,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-25T12:06:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234935159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Closed by #8389",
      "created_at" : "2016-07-28T11:14:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-235866820",
      "id" : 235866820,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-28T11:14:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/235866820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "> I agree, no need to make it impossible. Advanced users may have their own reasons for opting to keep using the same seed. But for added security, the default should be to generate a new one.\r\n\r\nRight now it seems, it was made impossible. Should this issue be reopened?",
      "created_at" : "2016-07-31T13:51:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8383#issuecomment-236431155",
      "id" : 236431155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8383",
      "updated_at" : "2016-07-31T13:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/236431155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
