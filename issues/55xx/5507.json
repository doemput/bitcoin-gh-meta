{
   "assignee" : null,
   "body" : "This is a regression in 0.10 that does not appear in 0.9.x.\r\n\r\nvBlocksInFlight, mapBlocksInFlight and friends can be remotely inflated by supplying an excessive number of block inv messages with garbage hashes.  In my local testing, it took about 10 minutes to pump in 1GB of bad inv messages, resulting in 6GB of memory usage and 30GB of outbound getheaders data from bitcoind.  After a malicious client disconnects, the memory may be reused, but does not appear to be released back to the operating system.\r\n\r\nThe 0.9.x code started applying a 10 point ban penalty at 5000 blocks in flight leading to a ban at 5010 , while under headers first we shouldn't see more than 16.  It's probably good to have some headroom to prevent buggy or older software from getting banned, but the numbers here are just reasonable guesstimates.\r\n\r\nI don't like fixed constants, and while MAX_DOWNLOADS_PER_PEER seems to make sense here, I like the idea of leaving some headroom.  This bumps it down to 2000 blocks and uses an existing constant that won't be changing soon.  \r\n\r\nThis will probably be superceded by #4831, or something built upon it, but a patch for 0.10 seems prudent.\r\n\r\nI've tested by sync'ing from genesis, and multiple runs catching up tip-48h to tip.  No problems were observed.\r\n",
   "closed_at" : "2014-12-23T11:32:59Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 10,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507/comments",
   "created_at" : "2014-12-18T23:49:36Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507",
   "id" : 52431636,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : "2015-12-03T11:08:31Z",
      "closed_issues" : 134,
      "created_at" : "2013-12-05T10:34:42Z",
      "creator" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      },
      "description" : "",
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestones/0.10.0",
      "id" : 505738,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/14/labels",
      "number" : 14,
      "open_issues" : 0,
      "state" : "closed",
      "title" : "0.10.0",
      "updated_at" : "2015-12-03T11:08:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/14"
   },
   "number" : 5507,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/5507.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/5507.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5507"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Prevent DOS attacks on in-flight data structures",
   "updated_at" : "2014-12-23T11:32:59Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/430315?v=3",
      "events_url" : "https://api.github.com/users/ajweiss/events{/privacy}",
      "followers_url" : "https://api.github.com/users/ajweiss/followers",
      "following_url" : "https://api.github.com/users/ajweiss/following{/other_user}",
      "gists_url" : "https://api.github.com/users/ajweiss/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/ajweiss",
      "id" : 430315,
      "login" : "ajweiss",
      "organizations_url" : "https://api.github.com/users/ajweiss/orgs",
      "received_events_url" : "https://api.github.com/users/ajweiss/received_events",
      "repos_url" : "https://api.github.com/users/ajweiss/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/ajweiss/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/ajweiss/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/ajweiss"
   }
}
