{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This is a pure refactoring PR that does not change behavior. The main commit is [`c1194635c6` Remove uses of chainActive and mapBlockIndex in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/c1194635c663536a5140beb4b59f634e4ca09110), which is probably the one first worth looking at to understand the change. This and the other commits replace direct calls between node and CWallet code with calls to abstract, remotable interfaces. (A remotable interface is an interface with serializable arguments and return values that doesn't rely on the caller and callee being in same process.)\r\n\r\nThe [interfaces being introduced here](https://github.com/ryanofsky/bitcoin/blob/pr/wipc-sep/src/ipc/interfaces.h) are meant to evolve over time. Right now there is very tight, synchronous binding between wallet and node code. But if, for example, SPV functionality is added to the wallet and it gains ability to keep track of more state by itself, the interfaces can become more minimal.\r\n\r\nAfter this refactoring, no significant changes to bitcoin wallet or node code should be necessary to allow wallets to run in separate processes. There are different ways multiprocess support could be built on top of this change, but tentatively I'm planning the following future PRs:\r\n\r\n* PR adding `-multiprocess` option to `bitcoind` that makes it spawn wallets in separate processes. This should require almost no changes to node or wallet code, and basically just consist of new implentations of the interfaces from this PR that can proxy method calls across a socket. I think I want to follow same approach as #10102 (which added proxying for the interfaces in #10244), but do it in a way that adds less boilerplate.\r\n\r\n* PR adding `-ipcbind` and `-ipcconnect` options to `bitcoind` (analagous to existing `-rpcbind` and `-rpcconnect` options) that let it bind to a port and accept incoming IPC requests, so the user can freely stop & start wallet processes without bringing down the node.\r\n\r\n* PR sorting wallet functions into the right .cpp files (moveonly changes) and adding config/makefile logic to build a separate `bitcoin-walletd` executable so `bitcoind` doesn't have to be a monolithic binary containing both node & wallet code.\r\n\r\n* PR letting the multiprocess options described above work for `bitcoin-qt`. This could work by replacing direct calls from Qt to wallet code with calls through the IPC wallet interface from #10244.\r\n\r\nBeyond these changes, as SPV features are added to wallet (#9483 and beyond), wallet processes could potentially communicate with a trusted node over P2P instead of relying on the IPC interfaces from this PR, or maybe only use the IPC channel for limited features like fee estimation.\r\n\r\n**This is based on #10286.** The non-base commits are:\r\n\r\n- [`40afc26350` Add skeleton chain and client classes](https://github.com/bitcoin/bitcoin/pull/10973/commits/40afc2635004622ccd6be283b0710dbb8a2ffb6c)\r\n- [`5269b56ec4` Pass chain and client variables where needed](https://github.com/bitcoin/bitcoin/pull/10973/commits/5269b56ec4e82d765098ba88ee0e3e79f5de1941)\r\n- [`7bfb409ad9` Remove uses of wallet functions in init.cpp](https://github.com/bitcoin/bitcoin/pull/10973/commits/7bfb409ad9e27df07108c17d63c3efc5f4bfb6a6)\r\n- [`e26e00bd3f` Remove uses of cs_main in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/e26e00bd3f53435ecd580e3f1f56ef4fd45bcfc1)\r\n- [`0a3464bce7` Pass chain locked variables where needed](https://github.com/bitcoin/bitcoin/pull/10973/commits/0a3464bce7aad25d0af5174e723eb6003da55271)\r\n- [`c1194635c6` Remove uses of chainActive and mapBlockIndex in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/c1194635c663536a5140beb4b59f634e4ca09110)\r\n- [`2dd492b580` Remove uses of CheckFinalTx in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/2dd492b5805041468dc73e03d984de46ce56fec7)\r\n- [`ebb23cbe04` Remove use of IsWitnessEnabled in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/ebb23cbe04329c36ac12e59639e71920c9fc742b)\r\n- [`dd180da24b` Remove use of AcceptToMemoryPool in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/dd180da24b66ae5b459a1108f7a92e08c54709e5)\r\n- [`83be2e6552` Remove uses of GetVirtualTransactionSize in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/83be2e6552ee2292e3037708590d5c52cb49e527)\r\n- [`8931629480` Remove use of IsRBFOptIn in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/8931629480c3a63c36b7ca7ebae164cf413e33da)\r\n- [`684e807240` Remove use of GetCountWithDescendants in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/684e807240c4ff9d73c76f1120f4e941c6bdeed0)\r\n- [`f3f36e8b5f` Remove use of g_connman / PushInventory in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/f3f36e8b5f081dabf0ef23fa20b37411b0615bf1)\r\n- [`c9d049c7e4` Remove use of TransactionWithinChainLimit in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/c9d049c7e493551190dbf5744488445c97856f55)\r\n- [`04f6a9ecc1` Remove use of CalculateMemPoolAncestors in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/04f6a9ecc1600ff01034c9d63f6a95c5f5624035)\r\n- [`c510dde004` Remove uses of fee globals in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/c510dde00446a5c020919b38f5002b76682ab753)\r\n- [`9849c4d441` Remove uses of fPruneMode in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/9849c4d4416fc47ceefde0ad952990ce965f39ab)\r\n- [`ab488c8229` Remove uses of g_connman in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/ab488c8229d1007b06c4d1c31f5e3eb1114eb6da)\r\n- [`090411ad7c` Remove uses of GetAdjustedTime in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/090411ad7c87f9f40344673cd83335d55d2c227b)\r\n- [`64ad91dbf5` Remove uses of InitMessage/Warning/Error in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/64ad91dbf5f20236b57c7c522836661bf768ee3d)\r\n- [`3ab3335d38` Remove use CValidationInterface in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/3ab3335d380208c91569513ea0619d3da675fa5e)\r\n- [`8756810d58` Remove use of CRPCTable::appendCommand in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/8756810d58db63ebe71e317d3c2d18a5805775fc)\r\n- [`35bfb7f189` Remove use of generateBlocks in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/35bfb7f18906e3dffe82bf811ddc6bf910944cf7)\r\n- [`8fb011e3fb` Remove uses of ParseConfirmTarget in wallet code](https://github.com/bitcoin/bitcoin/pull/10973/commits/8fb011e3fb93887620fcdad34eaafac63e5b60f9)\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 2,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10973/comments",
   "created_at" : "2017-08-01T22:17:26Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10973/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/10973",
   "id" : 247218529,
   "labels" : [
      {
         "color" : "E6F6D6",
         "default" : false,
         "id" : 135961,
         "name" : "Refactoring",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring"
      },
      {
         "color" : "02d7e1",
         "default" : false,
         "id" : 149424,
         "name" : "Wallet",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10973/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 10973,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/10973.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10973",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/10973.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10973"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Add IPC layer between node and wallet",
   "updated_at" : "2017-09-05T23:27:32Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10973",
   "user" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
      "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
      "followers_url" : "https://api.github.com/users/ryanofsky/followers",
      "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/ryanofsky",
      "id" : 7133040,
      "login" : "ryanofsky",
      "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
      "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
      "repos_url" : "https://api.github.com/users/ryanofsky/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/ryanofsky"
   }
}
