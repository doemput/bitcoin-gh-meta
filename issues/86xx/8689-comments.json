[
   {
      "body" : "For what it is worth,  the standard gap limit is `20` across most implementations.  ",
      "created_at" : "2016-09-09T11:15:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8689#issuecomment-245885926",
      "id" : 245885926,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8689",
      "updated_at" : "2016-09-09T11:15:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245885926",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "> [...] Whenever a key from the keypool is used in a received transaction, we should automatically mark it as used, and if possible replenish.\r\n\r\nI agree, we should do this. We already replenish the keypool after getting a key from the pool, though only in unencrypted wallets.\r\n\r\n**But I see significant issues regarding implementation of a \"gap limit\".**\r\nLets assume we would follow the BIP44 gap limit of 20 keys and someone does a restore of a HD wallet.dat backup created right after the creation of the wallet. We assume the seed in this wallet had received and sent plenty of transactions.\r\n\r\nIf we would reconstruct the transactions with a gap limit of 20, it would require plenty of rescans down to the blockheight where BIP32 was introduced (or down to the merge date of #8035). Performs utterly bad in conjunctions with pruning.\r\n\r\nAnd if a user could wait a couple of days (could easily happen with a 1000tx+ wallet) until this process has completed, there are serious risks that some funds could not be reconstructed.\r\n\r\nI guess we can also assume, if someone recovers from a backup, he or she very likely are going to sweep his funds to a new wallet (security aspect). **Failed reconstruction of keys can result in permanent loss**.\r\n\r\nWhat if she or he had call more the twenty times `getnewaddress` without actually giving away these addresses but afterwards gave away some of the 20+ addresses which then had been used to receive coins (or maybe someone did click 20+ times on \"receive coins\" in the GUI).\r\n\r\nI think we should clearly distinct between \"import/reconstruct\" and \"normal operation\". It doesn't hurt if we check against the keypool when we receive a transaction. But in general, the wallet does well know, when it did generate a seed and when it did use an existing, imported seed in order to generate the keypool.\r\n\r\nImporting should result in a custom process to avoid lost funds. Also, we should and probably must ask the user for some additional information and warn him appropriately.\r\nMost users think restoring a wallet with a seed/xpriv will \"reconstruct everything\". What if they have used the seed in a different wallet using a different derivation scheme (like BIP44). They naively going to assume that these funds will be reconstructed and maybe sweep to a new wallet and throw away the \"old backup\".\r\n\r\nTLTR?\r\n1) I think we should clearly distinct between import/recover and normal operations.\r\n2) We must warn/inform users when reconstructing fund for possible missed keys.\r\n3) We should ask the user for some basic informations about the wallet size (gap limit) in order to reconstruct faster.\r\n4) Reconstruction should result in using very large (1000+) lookup-windows and large gap limits, we should release(remove) the unused keys minus the gap limit at the upper end afterwards",
      "created_at" : "2016-09-09T12:10:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8689#issuecomment-245895601",
      "id" : 245895601,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8689",
      "updated_at" : "2016-09-09T12:10:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245895601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "> > [...] Whenever a key from the keypool is used in a received transaction, we should automatically mark it as used, and if possible replenish.\r\n\r\n> I agree, we should do this. We already replenish the keypool after getting a key from the pool, though only in unencrypted wallets.\r\n\r\nWe replenish the keypool after explicitly requesting a new key from it. This issue is about also doing that when we simply receive a transaction to a key from the keypool. AFAIK we do not mark such keys as used.\r\n\r\n",
      "created_at" : "2016-09-09T12:20:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8689#issuecomment-245897316",
      "id" : 245897316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8689",
      "updated_at" : "2016-09-09T12:20:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245897316",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "> We replenish the keypool after explicitly requesting a new key from it. This issue is about also doing that when we simply receive a transaction to a key from the keypool. AFAIK we do not mark such keys as used.\r\n\r\nOh yes. I missed that point. Yes, we should do this. \r\nThough, as I already stated, I'm not sure if we should naively allow using an imported seed without running a custom reconstruction process in advanced (detecting key in the keypool used in incoming transactions smells after a hack).",
      "created_at" : "2016-09-09T12:26:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8689#issuecomment-245898627",
      "id" : 245898627,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8689",
      "updated_at" : "2016-09-09T12:26:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245898627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "> Though, as I already stated, I'm not sure if we should naively allow using an imported seed without running a custom reconstruction process in advanced (detecting key in the keypool used in incoming transactions smells after a hack).\r\n\r\nThis is not about importing. It's about restoring a wallet.dat file from backup, and despite having a deterministic wallet, not recovering your incoming transactions made after the backup.",
      "created_at" : "2016-09-09T12:28:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8689#issuecomment-245899071",
      "id" : 245899071,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8689",
      "updated_at" : "2016-09-09T12:28:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245899071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : ">  It's about restoring a wallet.dat file from backup, and despite having a deterministic wallet, not recovering your incoming transactions.\r\n\r\nIt is indeed hard to detect if the user is using a backup wallet.dat that was previously used in a newer version.\r\nThough we could recommend reconstruction if the wallet bestblock lacks significant behind the chain tip.\r\n\r\nBut I agree with @sipa, we should implement detecting keypool keys during the incoming transaction process.",
      "created_at" : "2016-09-09T12:32:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8689#issuecomment-245899861",
      "id" : 245899861,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8689",
      "updated_at" : "2016-09-09T12:32:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245899861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "> It is indeed hard to detect if the user is using a backup wallet.dat that was previously used in a newer version.\r\n\r\nWhat are you talking about? This has nothing to do with newer versions. It will very normally occur whenever you recover a backup.",
      "created_at" : "2016-09-09T12:33:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8689#issuecomment-245900110",
      "id" : 245900110,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8689",
      "updated_at" : "2016-09-09T12:33:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245900110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Yes. I agree.\r\nI just meant that If you recover a wallet.dat there is a chance of detecting that you are using an \"older\" wallet.dat by comparing the wallets bestblock against the chaintip (but right, your node could be out-of-sync as well) which could lead to inform the user about doing an import/reconstruct (once we have a such feature).\r\n\r\nAlso agree with @MarcoFalke about marking the keys \"in between\" as used.",
      "created_at" : "2016-09-09T12:40:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8689#issuecomment-245901451",
      "id" : 245901451,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8689",
      "updated_at" : "2016-09-09T12:40:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245901451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Is possible to make a wallet which checks another wallet\r\nIf synchronization coincides before and after that wallet it is determined",
      "created_at" : "2017-02-11T13:25:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8689#issuecomment-279143635",
      "id" : 279143635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8689",
      "updated_at" : "2017-02-11T13:25:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/279143635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23635045?v=3",
         "events_url" : "https://api.github.com/users/DATSEC/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DATSEC/followers",
         "following_url" : "https://api.github.com/users/DATSEC/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DATSEC/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DATSEC",
         "id" : 23635045,
         "login" : "DATSEC",
         "organizations_url" : "https://api.github.com/users/DATSEC/orgs",
         "received_events_url" : "https://api.github.com/users/DATSEC/received_events",
         "repos_url" : "https://api.github.com/users/DATSEC/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DATSEC/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DATSEC/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DATSEC"
      }
   }
]
